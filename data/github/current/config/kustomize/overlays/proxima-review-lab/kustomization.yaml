resources:
- ../../base/review-lab

images:
- name: failbotg
  newName: octofactory.service.private-us-east-1.github.net/moda-artifacts-docker/failbotg
  newTag: master

generatorOptions:
  disableNameSuffixHash: true

configMapGenerator:
- name: spokesd
  behavior: merge
  literals:
    - twirp-url=https://spokesd-mtwesteu01.service.azure-westeurope.github.net/twirp/
- name: elasticsearch
  behavior: merge
  literals:
    - AUDITLOGSEARCH3_URL=placeholder
    - COMMIT_SEARCH_1_URL=placeholder
    - GENERAL_SEARCH_1_URL=placeholder
    - GITHUBSEARCH6_URL=placeholder

patchesJson6902:
  - target:
      kind: Deployment

      name: gpgverify
    patch: |-
      - op: replace
        path: /spec/template/metadata/annotations/generated-from
        value: config/kubernetes/kustomize/proxima-review-lab
  - target:
      kind: Deployment

      name: unicorn
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: VOLTRON_HMAC
          valueFrom:
            secretKeyRef:
              key: VOLTRON_HMAC
              name: vault-secrets
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: EXCEPTION_ENDPOINT
          valueFrom:
            secretKeyRef:
              key: VOLTRON_EXCEPTION_ENDPOINT
              name: vault-secrets
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OTEL_EXPORTER_OTLP_TRACES_HEADERS
          valueFrom:
            secretKeyRef:
              key: OTEL_EXPORTER_OTLP_TRACES_HEADERS
              name: vault-secrets
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: OTEL_SERVICE_NAME
          value: voltron
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: DEFAULT_REQUEST_TIMEOUT
          value: '60'
      - op: replace
        path: /spec/template/metadata/annotations/generated-from
        value: config/kubernetes/kustomize/proxima-review-lab
      - op: test
        path: /spec/template/spec/containers/2/env/36/name
        value: CPS_NETWORK_SERVICE_URL
      - op: replace
        path: /spec/template/spec/containers/2/env/36/value
        value: "https://cps-network-service-production-eu.githubapp.com/api/v1"
      - op: add
        path: /spec/template/spec/containers/2/env/-
        value:
          name: TREELIGHTS_ENDPOINT
          value: "http://treelights.treelights-%stamp%.svc.cluster.local:8002"
  - target:
      kind: Deployment

      name: gitauth
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          fluentbit.io/parser: logfmt_sloppy
          observability.github.com/splunk_index: rails-gitauth
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: DEFAULT_REQUEST_TIMEOUT
          value: '60'
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GH_HOSTNAME
          valueFrom:
            configMapKeyRef:
              key: hostname
              name: general
