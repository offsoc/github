<%# erblint:counter DeprecatedInPrimerCounter 1 %>
<%
  instrument_explore_page_view(
    user: current_user,
    visitor: @current_visitor,
    view_context: :REPOSITORY_CARD,
    record_id: @repository.id,
  )
%>

<article class="border rounded color-shadow-small color-bg-subtle my-4">
  <% if show_open_graph_image? %>
    <%= render(Primer::Beta::Link.new(
      border_color: :muted,
      border: :bottom,
      classes: "overflow-hidden flex-items-center rounded-top-2",
      data: explore_click_tracking_attributes(
        actor: current_user,
        click_target: :REPOSITORY,
        click_visual_representation: :REPOSITORY_IMAGE,
        record_id: @repository.id,
      ),
      "data-turbo": false,
      display: :flex,
      href: repository_path(@repository),
      position: :relative,
      style: "max-height:275px",
    )) do %>
      <img
        loading="lazy"
        src="<%= image_path open_graph_image_url %>"
        alt="<%= @repository.name %>"
        class="d-block width-full"
      >
    <% end %>
  <% end %>

  <% if @label.present? %>
    <h2 class="f6 color-fg-muted px-3 mt-3" <%= test_selector("label") %>>
      <span class="tooltipped tooltipped-ne" aria-label="This recommendation was generated by GitHub computers"><%# erblint:disable GitHub::Accessibility::NoAriaLabelMisuse, Primer::Accessibility::TooltippedMigration %>
        <%= octicon("telescope", height: 14, class: "mr-1", fill: "#24292e") %>
      </span>
      <%= @label %>
    </h2>
  <% end %>

  <div class="px-3">
    <div class="d-flex flex-justify-between flex-items-start flex-wrap gap-2 my-3">
      <div class="d-flex flex-1">
        <span style="margin-top:2px">
          <%= render Primer::Beta::Octicon.new(icon: "repo", color: :muted, mr: 2) %>
        </span>
        <h3 class="f3 color-fg-muted text-normal lh-condensed" <%= test_selector("repo-name") %>>
          <%= render(Primer::Beta::Link.new(
            data: explore_click_tracking_attributes(
              actor: current_user,
              click_target: :OWNER,
              click_visual_representation: :REPOSITORY_OWNER_HEADING,
              record_id: @repository.owner.id,
            ),
            "data-turbo": false,
            href: user_path(@repository.owner),
          )) do %>
            <%= @repository.owner_display_login %>
          <% end %>
          /
          <%= render(Primer::Beta::Link.new(
            data: explore_click_tracking_attributes(
              actor: current_user,
              click_target: :REPOSITORY,
              click_visual_representation: :REPOSITORY_NAME_HEADING,
              record_id: @repository.id,
            ),
            "data-turbo": false,
            font_weight: :bold,
            word_break: :break_word,
            href: repository_path(@repository),
          )) do %>
            <%= @repository.name %>
          <% end %>
        </h3>
      </div>

      <div class="d-flex flex-items-center">
        <% if GitHub.sponsors_enabled? && sponsorable? %>
          <%= render Sponsors::SponsorButtonComponent.new(
            sponsorable: @repository.owner,
            is_sponsoring: sponsoring?,
            location: sponsor_button_location,
            mr: 2,
          ) %>
        <% end %>

        <%= render Stars::ButtonComponent.new(
          entity: @repository,
          show_count: true,
          starred: current_user_has_starred?,
          button_args: current_user_has_starred? ? {} : { bg: :default },
        ) do |c| c.with_list_menu end %>
      </div>
    </div>
  </div>

  <%= render(Primer::Alpha::TabNav.new(label: "Repository menu", px: 3, mb: 0)) do |c| %>
    <% c.with_tab(
      id: "code-tab-#{@repository.id}",
      aria: { current: true },
      font_size: 6,
      px: 2,
      py: 1,
      href: repository_path(@repository),
      data: explore_click_tracking_attributes(
        actor: current_user,
        click_target: :REPOSITORY,
        click_visual_representation: :CODE_TAB,
        record_id: @repository.id,
      ),
      "data-turbo": false
    ) do %>
      <%= render(Primer::Beta::Octicon.new(
        icon: "code",
        color: :default,
      )) %> Code
    <% end %>

    <% c.with_tab(
      id: "issues-tab-#{@repository.id}",
      font_size: 6,
      px: 2,
      py: 1,
      href: "#{repository_path(@repository)}/issues",
      data: explore_click_tracking_attributes(
        actor: current_user,
        click_target: :REPOSITORY_ISSUES,
        click_visual_representation: :ISSUES_TAB,
        record_id: @repository.id,
      ),
      "data-turbo": false
    ) do %>
      <%= render(Primer::Beta::Octicon.new(
        icon: "issue-opened",
        color: :muted,
      )) %> Issues
    <% end %>

    <% c.with_tab(
      id: "pull-requests-tab-#{@repository.id}",
      font_size: 6,
      px: 2,
      py: 1,
      href: "#{repository_path(@repository)}/pulls",
      data: explore_click_tracking_attributes(
        actor: current_user,
        click_target: :REPOSITORY_PULL_REQUESTS,
        click_visual_representation: :PULL_REQUESTS_TAB,
        record_id: @repository.id,
      ),
      "data-turbo": false
    ) do %>
      <%= render Primer::Beta::Octicon.new(icon: "git-pull-request", color: :muted) %> Pull requests
    <% end %>

    <% if @repository.discussions_active? %>
      <% c.with_tab(
        id: "discussions-tab-#{@repository.id}",
        font_size: 6,
        px: 2,
        py: 1,
        href: discussions_path(@repository.owner, @repository),
        data: explore_click_tracking_attributes(
          actor: current_user,
          click_target: :REPOSITORY_DISCUSSIONS,
          click_visual_representation: :DISCUSSIONS_TAB,
          record_id: @repository.id,
        ),
        "data-turbo": false
      ) do %>
        <%= render Primer::Beta::Octicon.new(icon: "comment-discussion", color: :muted) %> Discussions
      <% end %>
    <% end %>
  <% end %>

  <div class="color-bg-default rounded-bottom-2">
    <% if @repository.description.present? %>
      <div class="px-3 pt-3">
        <p class="color-fg-muted mb-0" <%= test_selector("description") %>><%= repository_description_html %></p>
      </div>
    <% end %>

    <% if @repository.topics.any? %>
      <div class="d-flex flex-wrap border-bottom color-border-muted px-3 <%= @repository.description.present? ? 'pt-2' : 'pt-3' %> pb-2">
        <% @repository.topics.each do |topic| %>
          <%= render(Primer::Beta::Link.new(
            classes: "topic-tag topic-tag-link",
            data: explore_click_tracking_attributes(
              actor: current_user,
              click_target: :TOPIC,
              click_visual_representation: :TOPIC_TAG,
              record_id: topic.id,
            ),
            font_size: 6, mb: 2,
            href: topic_show_path(topic),
            title: "Topic: #{topic.name}",
          )) do %>
            <%= topic.name %>
          <% end %>
        <% end %>
      </div>
    <% end %>

    <div class="p-3">
      <ul class="d-flex f6 list-style-none color-fg-muted">
        <% if @repository.pushed_at.present? %>
          <li class="mr-4">
            Updated
            <%= time_ago_in_words_js @repository.pushed_at %>
          </li>
        <% end %>

        <% if @repository.primary_language.present? %>
          <li class="mr-4">
            <%= render(Languages::BadgeComponent.new(
              font_size: 6, my: 1, ml: 0,
              name: @repository.primary_language.name,
            )) %>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
</article>
