#!/bin/bash
#/ Usage: ghe-export-graphs [-h]
#/
#/ Export data written to RRD databases by collectd as a gzip'd tarball of XML files.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
#/ EXAMPLE:
#/
#/  Export the graph data to a file:
#/    $ ghe-export-graphs > dump-file.tar.gz
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

[ "$(whoami)" = "root" ] || {
  exec sudo -u root "$0" "$@"
  echo Run this script as the root user. >&2
  exit 1
}

function message {
  echo " --> ${1}"
}

function clean_up {
  rm -rf $TEMP_DIR
  exit $1
}

trap clean_up SIGHUP SIGINT SIGTERM

TEMP_DIR=$(mktemp -d /tmp/graphs-XXXXX)
mkdir -p $TEMP_DIR

if [ -d /var/lib/collectd/rrd/ ]; then
  message "Converting rrd graphs to XML..."
  for file in $( find /var/lib/collectd/rrd -name \*.rrd ); do
    XML=${file#/var/lib/collectd/rrd/}
    XML=${XML//\//.}
    XML=${XML/.rrd/.xml}
    rrdtool dump --no-header $file $TEMP_DIR/$XML
  done
fi

if [ -d $TEMP_DIR ]; then
  message "Exporting graphs data..."
  tar --acls -czf graphs.tar.gz -C $TEMP_DIR .
else
  echo "No graphs data exists to export."
  exit 1
fi

clean_up
