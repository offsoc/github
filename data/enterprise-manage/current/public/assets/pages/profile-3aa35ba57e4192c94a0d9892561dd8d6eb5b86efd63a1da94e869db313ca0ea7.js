(function(){var s=$("#flashbar"),e=$("#flashbar-msg"),a=function(a,t){s.stop(),e.text(a),s.removeClass("flash-warn flash-error flash-success").addClass(t),s.stop(!0,!1).fadeIn()},t=$("#flashbar-popup"),n=$("#flashbar-msg-popup"),r=function(s,e){t.stop(),n.text(s),t.removeClass("flash-warn flash-error flash-success").addClass(e),t.stop(!0,!1).fadeIn()};$(document).on("click",".js-unblock-user",function(s){if(s.preventDefault(),confirmText=$(this).attr("data-confirm"),confirm(confirmText))return $.ajax({url:"/setup/user-management/unblock",type:"POST",data:{username:$(this).attr("key")},success:function(){m(),a("User unblocked.","flash-success")},error:function(s){var e=JSON.parse(s.responseText).error;e||(e="Internal error"),a(e,"flash-error")}})}),$(document).on("click",".js-remove-user",function(s){if(s.preventDefault(),confirmText=$(this).attr("data-confirm"),confirm(confirmText))return $.ajax({url:"/setup/user",type:"DELETE",data:{username:$(this).attr("key")},success:function(){m(),a("User removed.","flash-success")},error:function(s){var e=JSON.parse(s.responseText).error;e||(e="Internal error"),a(e,"flash-error")}})}),$(document).on("click",".send-invite",function(s){s.preventDefault();var e=this.id;""!=e&&$.ajax({url:"/setup/user-management/resend-invitation",async:!1,type:"PUT",data:{email:e},success:function(s){var e=JSON.parse(s);e.status&&e.status.includes("configure")?a(e.status,"flash-warn"):e.status?a(e.status):a("Invitation sent.","flash-success")},error:function(s){var e=JSON.parse(s.responseText).error;e||(e="Internal error"),a(e,"flash-error")}})}),$(document).on("click",".copy-invite",function(){var s=document.createElement("input");s.setAttribute("type","text"),document.body.appendChild(s),s.value=this.id,s.select(),document.execCommand("copy"),document.body.removeChild(s),a("Copied link: "+this.id+" to the clipboard.","flash-success")});var o,i,l,u,c,p,d,v,f=function(){var s="";return $.ajax({url:"/setup/host",async:!1,type:"GET",data:{},success:function(e){s=JSON.parse(e).host},error:function(){a("Could not retrieve host.","flash-error")}}),s},m=function(){var s=$(".js-user-list"),e="",t=0;host=f(),$.ajax({url:"/setup/users",async:!1,type:"GET",data:{},success:function(n){var r=JSON.parse(n);if(r.length>0){for(let s=0;s<r.length;s++){var o="editor"==r[s].role;o&&t++;var i="invited"!=r[s].state||o?"":`<a class="users-pull-right send-invite" id="${r[s].email}">\n                                <div class="users-tooltip"><span class="octicon octicon-mail users-icon"></span>\n                                <span class="users-tooltiptext">Resend invitation mail</span>\n                                </div>\n                            </a>\n                            <a class="users-pull-right copy-invite" id="https://${host}/setup/user-invite/${r[s].user_hash}">\n                                <div class="users-tooltip"><span class="octicon octicon-link users-icon"></span>\n                                    <span class="users-tooltiptext">Copy invitation link</span>\n                                </div>\n                            </a>`,l="blocked"!=r[s].state||o?"":`<a class="js-unblock-user users-pull-right" data-confirm="Are you sure you want to unblock this user?" key="${r[s].username}">\n                                <div class="users-tooltip"><span class="octicon octicon-law users-icon"></span>\n                                <span class="users-tooltiptext">Unblock user</span>\n                                </div>\n                            </a>`,u=o?`${r[s].role} <i>(deprecated)</i>`:`${r[s].role}`;e+=`  <li class="list-group-item">\n                        <a class="js-remove-user users-pull-right" data-confirm="Are you sure you want to delete this user?" key=${r[s].username}>\n                            <div class="users-tooltip"><span class="octicon octicon-trashcan users-icon"></span>\n                                <span class="users-tooltiptext">Delete</span>\n                            </div>\n                        </a>\n                        <a class="users-pull-right modal-open" id=${r[s].username}>\n                            <div class="users-tooltip"><span class="octicon octicon-pencil users-icon"></span>\n                                <span class="users-tooltiptext">Edit</span>\n                            </div>\n                        </a>\n                        ${i}\n                        ${l}\n                        <div class="users-username">${r[s].name}</div>\n                        <div><span class="users-title">Username: </span>${r[s].username}<span class="users-title">Email: </span>${r[s].email}</div>\n                        <div><span class="users-title">State: </span>${r[s].state}<span class="users-title">Role: </span><span class="js-user-role">${u}</span></div>\n                      </li>`}t>0&&a("The 'editor' role has been deprecated and are no longer able to use the Management Console. Please consider updating users to the 'operator' role, but keep in mind that this allows users to manage all settings including the authorized SSH keys.","flash-warn")}else e='<li class="list-group-item"><div class="users-username">No users created</div></li>';s.html(e)},error:function(s){var e=s.error?s.error:"Could not load users.";a(e,"flash-error")}})};o=$("#input-name"),i=$("#input-username"),l=$("#input-email"),u=$("#select-role"),$("#form-msg"),c=$("#btn-save"),p=$(".modal-close"),d=$("#popup-overlay"),v=$("#popupContent");var h=function(){popoverTitle.innerText="Create user",c.text("Create"),o.val(""),i.val(""),l.val(""),u.val("operator")},y=function(s){var e=JSON.parse(s.responseText).error;e||(e="Internal error"),r(e,"flash-error")},x=function(){c.prop("disabled",!0),d.addClass("active"),v.addClass("active")},g=function(){t.stop(!1,!0).fadeOut(),v.removeClass("active"),d.removeClass("active"),h()},b=function(s){i.removeClass("invalid"),o.removeClass("invalid"),s?(popoverTitle.innerText="Edit user",c.text("Update"),l.prop("disabled",!0),i.prop("disabled",!0),o.val(s.name),i.val(s.username),l.val(s.email),u.val("operator")):(h(),l.prop("disabled",!1),i.prop("disabled",!1))};c.click(function(s){return s.preventDefault(),formUser={name:o.val(),username:i.val(),email:l.val(),role:u.val()},!0===l.prop("disabled")?$.ajax({url:"/setup/user-management/edit",async:!1,type:"PUT",data:formUser,success:function(){g(),h(),m(),a(`User ${formUser.username} edited.`,"flash-success")},error:function(s){y(s)}}):$.ajax({url:"/setup/user-management/save",async:!1,type:"POST",data:formUser,success:function(s){g(),h(),m(),s.status?s.status.includes("smtp")?a(s.status,"flash-warn"):a(s.status,"flash-success"):a(`User ${formUser.username} created.`,"flash-success")},error:function(s){y(s)}})}),$(document).on("click",".modal-open",function(){username=this.id,""!=username?$.ajax({url:"/setup/user",async:!1,type:"GET",data:{username:username},success:function(s){var e=JSON.parse(s);b(e)},error:function(s){y(s)}}):b(),x()}),p.click(function(){g()}),d.click(function(s){s.target==this&&g()}),o.on("input",function(s){C(s.target.value)?o.removeClass("invalid"):o.addClass("invalid")}),i.on("input",function(s){k(s.target.value)?i.removeClass("invalid"):i.addClass("invalid")}),l.on("input",function(s){T(s.target.value)?l.removeClass("invalid"):l.addClass("invalid")});var C=function(s){return/^[a-z ]{2,39}$/i.test(s)},k=function(s){return/^[a-z\d](?:[a-z\d]|-(?=[a-z\d])){0,38}$/i.test(s)},T=function(s){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i.test(s)};$(".js-required").on("input",function(){var s,e,a=!1;C(o.val())&&(s=!0),k(i.val())&&(e=!0),T(l.val())&&(a=!0),s&&e&&a?c.prop("disabled",!1):c.prop("disabled",!0)}),$(document).ready(function(){$(".js-user-list").length&&m()})}).call(this);