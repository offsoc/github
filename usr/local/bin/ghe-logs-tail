#!/bin/bash
#/ Usage: ghe-logs-tail [options]
#/
#/ Tail log all relevant log files from your installation.
#/
#/ By default, all logs are tailed. The following options can be used
#/ to limit the scope down to specific logs.
#/
#/ OPTIONS:
#/   -h | --help        Show this message
#/   -A | --app         Include application logs.
#/   -a | --auth        Include authentication logs.
#/   -w | --web         Include web logs.
#/   -c | --config      Include configuration logs.
#/   -S | --system      Include system logs.
#/   -s | --search      Include search logs.
#/   -d | --database    Include database logs.
#/   -g | --git         Include git logs.
#/   -v | --verbose     Run in verbose mode.
#/
set -e

usage() {
  grep '^#/' < "$0" | cut -c 4-
}

message() {
  echo " --> ${1}"
}

[ "$(whoami)" = "root" ] || {
  exec sudo -u root "$0" "$@"
  echo Run this script as the root user. >&2
  exit 1
}

LOGS=
# Parse args.
ARGS=$(getopt --name "$0" --long verbose,help,app,auth,web,config,system,search,database,git --options vhAawcSsdg -- "$@") || {
  usage
  exit 2
}
eval set -- $ARGS

while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 2
      ;;
    -v|--verbose)
      set -x
      ;;
    -A|--app)
      LOGS="${LOGS} /var/log/github/*.log /var/log/enterprise-manage/*.log\
                    /var/log/alambic/*.log /var/log/codeload/*.log"
      ;;
    -a|--auth)
      LOGS="${LOGS} /var/log/github/auth.log\
                    /var/log/auth.log"
      ;;
    -w|--web)
      LOGS="${LOGS} /var/log/nginx/*.log /var/log/haproxy.log"
      ;;
    -c|--config)
      LOGS="${LOGS} /data/user/common/ghe-config.log"
      ;;
    -S|--system)
      LOGS="${LOGS} /var/log/syslog /var/log/dmesg /var/log/kern.log\
      /var/log/segfaults.log"
      ;;
    -s|--search)
      LOGS="${LOGS} /var/log/elasticsearch/*.log"
      ;;
    -g|--git)
      LOGS="${LOGS} /var/log/git-daemon.log"
      ;;
    -d|--database)
      LOGS="${LOGS} /var/log/mysql/mysql.err"
      ;;
    --)
      break
      ;;
  esac
  shift
done

if [ -z "$LOGS" ]; then
  LOGS="/var/log/github/*.log /var/log/enterprise-manage/*.log\
        /var/log/github/auth.log\
        /var/log/auth.log /var/log/nginx/*.log\
        /data/user/common/ghe-config.log /var/log/syslog /var/log/dmesg\
        /var/log/mysql/mysql.err /var/log/haproxy.log"
fi

echo ${LOGS}

tail -F ${LOGS}
