#!/bin/bash
#/ Usage: ghe-manage-console [-h]
#/
#/ Run the enterprise-manage Sinatra console.
#/
#/ Typically, you will only execute this if you've contacted support and they've asked you to do so.
#/
#/ OPTIONS:
#/   -h | --help     Show this message.
#/
set -e

prompt_less=

usage() {
  grep '^#/' <"$0" |cut -c 4-
  exit 2
}

proceed() {
  if [ -z "$prompt_less" ]; then
    echo "$(basename $0) should only be used when requested by the GitHub Enterprise Support team. Incorrect use could cause damage or data loss."
    read -p "Proceed with ghe-manage-console? [y/N] " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      exit 1
    fi
  fi
}

console() {
  enterprise-manage-env "bundle exec ruby -Ilib -rirb -rirb/completion -e \"require 'manage'; IRB.start\""
}

# show usage if any argument is passed other than -h or -y
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 2
      ;;
    -y|--yes)
      prompt_less=1
      shift
      ;;
    *)
      usage
      exit 1
      ;;
    esac
  done

proceed
console
