#!/bin/bash
#/ Usage: ghe-storage [-h] <subcommand> args...
#/
#/ Query and manage the GitHub Enterprise cluster storage.
#/
#/ OPTIONS:
#/   -h | --help                Show this message.
#/
#/ Valid subcommands are:
#/   repair                          Repair a node
#/   evacuate                        Evacuate a node
#/   evacuation-status               Show evacuation status (remaining objects) for a node
#/   online                          Bring a node online
#/   offline                         Put a node in an offline state
#/   disk-stats                      Disk usage states
#/   route                           Find where where a file is stored given asset type and file name
#/   info                            Find what nodes an object is currently on
#/   replication-status              Display replication status that shows the under/over replicated objects
#/   destroy-host <host> [--force]   Destroy a storage host by deleting storage replicas assigned to it
#/   rebuild-host [host] [directory] Repair missing storage blob data by iterating over on-disk assets
#/   repair-uploadables              Repair missing storage references for ReleaseAsset, UserAsset and Avatar assets
#/
set -e

usage() {
  grep '^#/' <"$0" | cut -c 4-
}

if [ $# -eq 0 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  usage
  exit 2
fi

OP="$1"
shift
case "$OP" in
  repair) # repair a node
    github-env bin/storage-repair "$@" ;;
  evacuate) # evacuate a node
    github-env bin/storage-evacuate "$@" ;;
  evacuation-status) # show evacuation status for a node
    github-env bin/storage-evacuation-status "$@" ;;
  online|enable) # bring a node online
    github-env bin/storage-online "$@" ;;
  offline|disable) # put a node in an offline state
    github-env bin/storage-offline "$@" ;;
  disk-stats|disk-usage) # disk usage states
    github-env bin/storage-disk-usage "$@" ;;
  route|dat) # Find where where a file is stored given asset type and file name
    github-env bin/storage-route "$@" ;;
  info) # Find what nodes an object is currently on
    github-env bin/storage-info "$@" ;;
  replication-status) # Display replication status that shows the under/over replicated objects
    github-env bin/storage-replication-status "$@" ;;
  destroy-host) # Destroy a storage host by deleting storage replicas assigned to it
    github-env bin/storage-host-destroy "$@" ;;
  rebuild-host) # Repair missing storage blob data by iterating over on-disk assets
    github-env bin/storage-rebuild-host "$@" ;;
  repair-uploadables) # Repair missing storage references for ReleaseAsset, UserAsset and Avatar assets
    github-env bin/storage-repair-uploadables "$@" ;;
  delete-orphans) # Delete orphaned objects, i.e., objects that lack replication state
    github-env bin/storage-delete-orphans "$@" ;;
  *) usage ;;
esac
