<%
  filename = alerts.first.filename

  alerts_with_fixes = alerts.select { |a| a.vulnerable_version_range.fixed_in.present? }
  alerts_without_fixes = alerts.reject { |a| a.vulnerable_version_range.fixed_in.present? }

  highest_fixed_in = VersionSorter.rsort(alerts_with_fixes.map { |a| a.vulnerable_version_range.fixed_in }).first.to_s
%>
<details class="details-reset details-overlay dropdown js-dropdown-details">
  <summary data-octo-click="vuln_dep_info">
    <span class="mr-1 f6 flash-warn border-0 col-5 text-right lh-condensed-ultra"><%= primer_octicon(:alert, mr: 1) %>
      Known security vulnerability in
    </span>
    <code class="flash-warn text-bold" style="border-bottom: 1px dotted">
      <%= human_requirements %>
    </code>
    <%= primer_octicon(:"triangle-down", color: :default, vertical_align: :middle) %>
  </summary>
  <div class="dropdown-menu dropdown-menu-sw right-0 mt-2" style="width: 300px;">
    <div class="dropdown-header text-bold color-fg-default pb-0">
      <%= alerts.many? ? alerts.count.to_s + " known vulnerabilities" : "Known vulnerability"  %> found
    </div>
    <% if alerts_with_fixes.any? %>
      <div role="none" class="dropdown-divider mb-2"></div>
      <div class="py-0 px-3<%= alerts_with_fixes.many? ? "" : " pt-0" %>">
        <% alerts_with_fixes.each do |alert| %>
          <div class="d-flex flex-wrap flex-justify-between mt-n1 mb-2 f6">
            <a href="<%= alert.vulnerability.permalink %>" target="_blank" rel="noopener noreferrer" class="text-bold mt-1">
              <%= primer_octicon(:"link-external", mr: 1) %><%= alert.vulnerability.identifier %>
            </a>
            <%= render DependabotAlerts::SeverityLabelComponent.new(severity: alert.vulnerability.severity, vertical_align: :middle, mt: 1) %>
          </div>
          <% if alert.vulnerability.description && !alerts_with_fixes.many? %>
            <p class="color-fg-default mt-1 mb-2 f6"><%= alert.vulnerability.description.truncate(120) %></p>
          <% end %>
        <% end %>
      </div>
      <div class="py-0 px-3">
        <a href="<%= manifest_blob_path %>"
          class="Link--primary" data-octo-click="vuln_dep_manifest_click">
          <%= primer_octicon(:"file-code", mr: 1) %><code class="text-bold"><%= filename %></code>
        </a> <span class="text-small">update suggested:
          </span>
        <code class="d-block color-bg-subtle px-2 py-1 mt-1 mb-2 rounded-2">
          <%= package_name %> ~&gt; <%= highest_fixed_in %>
        </code>
        <% if alerts_without_fixes.empty? %>
          <p class="f6 color-fg-muted">
            <em>Always verify the validity and compatibility of suggestions with your codebase.</em>
          </p>
        <% end %>
      </div>
    <% end %>
    <% if alerts_without_fixes.any? %>
      <div role="none" class="dropdown-divider my-2"></div>
      <div class="py-0 px-3">
        <% alerts_without_fixes.each do |alert| %>
          <div class="d-flex flex-justify-between mb-2 f6">
            <a href="<%= alert.vulnerability.permalink %>" target="_blank" rel="noopener noreferrer" class="text-bold">
              <%= primer_octicon(:"link-external", mr: 1) %><%= alert.vulnerability.identifier %>
            </a>
            <%= render Primer::Beta::Label.new(scheme: :secondary, vertical_align: :middle) do %><%= alert.vulnerability.severity.titleize %> severity<% end %>
          </div>
        <% end %>
        <p class="color-fg-muted f6">No suggested fix available</p>
      </div>
      <div role="none" class="dropdown-divider"></div>
      <div class="py-0 px-3">
        <p class="f6 color-fg-muted">
          <em>Always verify the validity and compatibility of suggestions with your codebase.</em>
        </p>
      </div>
    <% end %>
  </div>
</details>
