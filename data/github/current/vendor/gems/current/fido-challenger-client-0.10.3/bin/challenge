#!/usr/bin/env ruby

require "socket"
require_relative "../lib/cli"

pam_mode = nil
user = nil
resource = nil

if ENV["PAM_USER"]
  user = ENV["PAM_USER"].include?("@") ? ENV["PAM_USER"] : "#{ENV["PAM_USER"]}@github.com"
  resource = Socket.gethostname
  pam_mode = ARGV[0]
else
  user = ARGV[0]
  resource = ARGV[1]
end

if user.nil? || resource.nil?
  puts "Usage:"
  puts "challenge <uid> <resource>"
  puts
  puts "Example:"
  puts "challenge hubot@github.com bastion.githubapp.com"
  exit 1
end

$stdout.sync = true

if pam_mode
  exit_code = CLI.new(user, resource).pam_challenge(pam_mode)
else
  exit_code = CLI.new(user, resource).challenge
end

exit exit_code
