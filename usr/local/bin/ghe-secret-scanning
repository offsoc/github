#!/bin/bash
set -euo pipefail

# ghe-secret-scanning is a CLI interface for interacting with secret-scanning services
#
# Usage:
#  ghe-secret-scanning [flags]
#  ghe-secret-scanning [command]
#
# Flags
#  -h, --help      help for ghe-secret-scanning

#shellcheck source=vm_files/usr/local/share/enterprise/ghe-nomad-lib
source /usr/local/share/enterprise/ghe-nomad-lib

if [[ -z "$*" ]] ; then
  echo "No command given." >&2
  exit 1
fi

command="$*"
exec_script=$(cat <<EOF
#! /bin/bash
set +e
/app/internal/shell $command 2>&1 || true
EOF
)
response="$(echo "$exec_script" | dispatch_job -n "token-scanning-dispatch" - )"
eval_id=$(echo "$response" | jq -r .EvalID)
wait_for_nomad_dispatch_complete "$eval_id" 60

alloc_id="$(ghe-nomad-api "evaluation/$eval_id/allocations" | jq -r .[0].ID)"
get_alloc_logs -a "$alloc_id" -t "token-scanning-dispatch"
