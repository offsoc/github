#!/bin/bash
#/ Usage: ghe-secret-scanning-rotate-encrypted-content-key [-y]
#/
#/ This command is used rotate the keys used for scanning
#/ user-generated content and will restart services.
#/
#/ OPTIONS:
#/   -h | --help        Show this message.
#/   -y | --yes         Do not show the warning prompt.
#/

set -e

message() {
  echo "${1}" | ts
}

confirm() {
  read -p "This will rotate the encryption keys for content scanning. Do you want to continue? [y/N] " -n 1 -r
  echo
  if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
    exit 1
  fi
}

usage () {
  grep '^#/' < "$0" | cut -c4-
}

KEY_LEN_BYTES=32
KEY_SETTING=secrets.secret-scanning.secret-scanning-user-content-delimited-encryption-root-keys

# Parse args
SKIP_CONFIRM=n
while getopts yh flag
do
  case "${flag}" in 
    y) SKIP_CONFIRM=y;;
    h) usage; exit 1;;
    *) echo "${USAGE}" >&2; exit 1;;
  esac
done

if [ "${SKIP_CONFIRM}" == "n" ]; then
  confirm
fi

# Read existing keys
OLD_KEYS=$(ghe-config --get $KEY_SETTING)

# Generate new keys
message "Generating key"
NEW_KEY=$(openssl rand -base64 $KEY_LEN_BYTES)

# Append new keys to decryption lists
message "Appending new keys to decryption lists"
ghe-config "$KEY_SETTING" "$OLD_KEYS;$NEW_KEY"

# Restart everything
message "Restarting GitHub services"
ghe-config-apply

message "Key rotation complete. The new keys will now be used for all future encryptions."
