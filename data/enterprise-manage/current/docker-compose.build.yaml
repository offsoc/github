version: '3.6'

networks:
  internal:

services:
  build:
    build:
      context: .
      dockerfile: Dockerfile.build
      args:
        APT_HOST: "${APT_HOST:-packages.service.github.net}"
        USERNAME: ${USER:-default}
        USER_UID: ${UID:-1000}
        USER_GID: ${GID:-1000}
    platform: linux/amd64
    working_dir: /workspace/enterprise2/enterprise-manage
    image: "${GHE_PREFIX:-ghes}/enterprise-manage/build"
    networks:
      - internal
    volumes:
      - ../:/workspace/enterprise2:delegated
      - enterprise-manage-vendor-gems:/workspace/enterprise2/enterprise-manage/vendor/gems:delegated
    depends_on:
      - ldap-1
      - ldap-2
      - ldap-3
      - ldap-4
      - mysql
      - ghes-manage-gateway
      - ghes-manage-gateway-proxy
      - ghes-manage-agent
    environment:
      ENTERPRISE_DB_HOST: "mysql"
      ENTERPRISE_DB_USER: "mc"
      ENTERPRISE_DB_PASS: "mc"
      MANAGE_API_ENDPOINT: "ghes-manage-gateway-proxy:3100"
      MANAGE_API_USERNAME: "api_key"
      MANAGE_API_PASSWORD: "passworD1"
