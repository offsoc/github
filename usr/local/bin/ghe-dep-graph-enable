#!/bin/bash
#/ Usage: ghe-dep-graph-enable [-h]
#/
#/ Enable the Dependency Graph service
#/
#/ OPTIONS:
#/   -h | --help     Show this message.
#/
set -e

usage() {
    grep '^#/' <"$0" |cut -c 4-
    exit 2
}

[ "$(whoami)" = "admin" ] || {
    exec sudo -u admin "$0" "$@"
    echo Run this script as the admin user. >&2
    exit 1
}

setup_config_vars(){
    ghe-config 'app.dependency-graph.enabled' 'true'
}

# show usage if any argument is passed other than -h
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            usage
            exit 2
            ;;
        *)
            usage
            exit 1
            ;;
    esac
done

echo
echo "The dependency graph will scan repositories on your instance."
echo "No code or information about your repositories will be uploaded to GitHub.com."
echo
read -p "Press enter to proceed."

setup_config_vars
ghe-config-apply
echo "*** Setup is done."
