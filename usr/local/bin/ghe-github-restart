#!/bin/bash
#/ Usage: ghe-github-restart
#/ This script will rerender and schedule the nomad jobs 
#/ located under vm_files/etc/consul-templates/etc/nomad-jobs/github.
#/ Use this script for example after applying a new license, to avoid bigger license file upload disruptions.
#/

set -e 

if [ "$(/usr/local/share/enterprise/ghe-config-in-progress)" != "false" ]; then
  echo "Currently the config-apply process is running. Please wait for it to finish..."
  exit 1
fi

ghe-license check > /dev/null
ghe-license sync > /dev/null

if [ -f /etc/github/cluster ]; then
  ghe-cluster-each -- sudo /usr/local/share/enterprise/ghe-call-configrb nomad_render_jobs github > /dev/null
  ghe-cluster-each -- sudo /usr/local/share/enterprise/ghe-call-configrb nomad_run_github_jobs
else
  sudo /usr/local/share/enterprise/ghe-call-configrb nomad_render_jobs github > /dev/null
  sudo /usr/local/share/enterprise/ghe-call-configrb nomad_run_github_jobs
fi

sleep 20
/usr/local/share/enterprise/ghe-nomad-jobs wait-health-checks
