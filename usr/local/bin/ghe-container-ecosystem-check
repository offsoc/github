#!/bin/bash
#/ Usage: ghe-container-ecosystem-check [-h]
#/
#/ Validates container enabled state.
#/ Needs to be executed after GitHub Enterprise configuration has been changed
#/ This script is normally called by ghe-config-apply
#/
#/ OPTIONS:.
#/   -h | --help     Show this message.
#/
set -e

# usage
#   Display usage information for this script.
usage() {
    grep '^#/' < "$0" | cut -c 4-
    exit 2
}

# Process command line arguments
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            usage
            exit 2
            ;;
        *)
            >&2 echo "Unrecognized argument: $1"
            usage
            exit 1
            ;;
    esac
done

# container registry can only be enabled when subdomain isolation is on
is-valid-container-enabled-state() {
    if ! ghe-config --true "core.subdomain-isolation"  && ! ghe-config --eq "app.packages.container-enabled" "false"; then
      echo "Container registry can not be enabled when subdomain isolation is off."
      exit 1
    fi
}

echo 'Checking container ecosystem state'
is-valid-container-enabled-state

echo 'Container ecosystem state is valid'

