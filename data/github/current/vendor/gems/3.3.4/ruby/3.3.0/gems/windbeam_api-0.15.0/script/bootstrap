#!/bin/bash

set -e

echoerr() {
  printf '\e[31m%s\e[0m\n' "$@"
}

echosuccess() {
  printf '\e[32m%s\e[0m\n' "$@"
}

##########################################################
##########verify relevant commands are installed##########
##########################################################

# Check for `go`. Can't autoinstall this since I don't know if macOS or linux or something else.
if ! command -v go &> /dev/null; then
  echoerr "golang not installed; install go before proceeding!"
  exit 1
fi

# Check for `gh`. Can't autoinstall this since I don't know if macOS or linux or something else.
if ! command -v gh &> /dev/null; then
  echoerr "\`gh\` command not installed; please install before proceeding!"
  exit 1
fi

# Ensure protoc is installed before proceeding
if ! command -v protoc &> /dev/null; then
  system=$(uname)

  if [ "$system" = "Darwin" ]; then
    echo "protoc not found; installing..."
    brew install protobuf
  elif [ "$system" = "Linux" ]; then
    echoerr "\`protoc\` not installed, please install protoc according to the instructions found here: https://grpc.io/docs/protoc-installation/"
    exit 1
  fi
fi

# Install `protoc-gen-twirp_ruby` if not installed
if ! command -v protoc-gen-twirp_ruby &> /dev/null; then
  echo "Ruby protoc plugin not found; installing..."
  go install github.com/arthurnn/twirp-ruby/protoc-gen-twirp_ruby@latest
  if ! [ -x $(which protoc-gen-twirp_ruby) ]; then
    echoerr "\`protoc-gen-twirp_ruby\` helper installed but is not in \`PATH\`; please ensure it's in your \`PATH\` and re-run"
    exit 1
  fi
fi

# Install dependencies to be able to run tests
bundle install --local


