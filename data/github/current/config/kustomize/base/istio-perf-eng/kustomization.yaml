apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
- ./resources/servicemeshconfigs/config.yaml

patches:
- target:
    kind: Namespace
  path: ./patches/istio-io-rev-label.yaml
- target:
    kind: Deployment
    name: unicorn-api
  path: ./patches/exclude-outbound-ports.yaml
- target:
    kind: Deployment
    name: unicorn-api
  path: ./patches/sidecar-resource-annotations.yaml
- target:
    kind: Deployment
    name: unicorn-api-graphql
  path: ./patches/include-outbound-ip-ranges.yaml

# make sure all the Services are in a paused state
# except for unicorn-api-performance, which is specified below.
- target:
    kind: Service
  path: ./patches/service-paused.yaml

# make sure no Deployments get the sidecar injected unless specified explicitly
- target:
    kind: Deployment
  path: ./patches/istio-inject-false.yaml

patchesJson6902:
- target:
    kind: Job
    name: transition-template-job
  patch: |-
    - op: add
      path: /spec/template/metadata/labels
      value: {}
    - op: add
      path: /spec/template/metadata/labels/sidecar.istio.io~1inject
      value: "false"

- target:
    version: v1
    kind: Service
    name: unicorn-api
  patch: |-
    - op: remove
      path: /metadata/annotations/octomesh.github.com~1paused
