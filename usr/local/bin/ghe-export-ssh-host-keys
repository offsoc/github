#!/bin/sh
#/ Usage: ghe-export-ssh-host-keys [-h]
#/
#/ Export the SSH host keys for an installation. These keys will prevent SSH
#/ fingerprint mismatch warnings when moving to a new appliance. The data is
#/ streamed as a tar file to STDOUT.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
#/ EXAMPLE:
#/
#/  Export the SSH host keys to a file:
#/    $ ghe-export-ssh-host-keys > dump-file
#/
#/  Transfer the SSH host keys from the current appliance to another:
#/    $ ghe-export-ssh-host-keys | ssh -p 122 admin@[hostname] -- ghe-import-ssh-host-keys
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

[ "$(whoami)" = "root" ] || {
    exec sudo -u root "$0" "$@"
    echo Run this script as the root user. >&2
    exit 1
}

keys="ssh_host_dsa_key ssh_host_dsa_key.pub ssh_host_rsa_key ssh_host_rsa_key.pub ssh_host_ecdsa_key ssh_host_ecdsa_key.pub ssh_host_ed25519_key ssh_host_ed25519_key.pub"
# Store keys in the archive if and only if they exist.
tar --acls -cf - -C /data/user/common \
  $(printf "%s\n" $keys | xargs -L1 bash -c 'if [ -f "/data/user/common/$0" ]; then echo $0; fi')
