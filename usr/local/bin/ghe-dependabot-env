#!/bin/bash
#/ ghe-dependabot-env [-h]
#/
#/ Load the Dependabot application environment.
#/
#/ Typically, you will only execute this if you've contacted support and they've asked you to do so.
#/
#/ OPTIONS:
#/   -h | --help         Show this message.
#/   -i | --interactive  Force interactive mode
#/                       If ghe-dependabot-env is invoked without arguments
#/                       interactive mode is assumed
#/
#/ NOTE: this runs the given command or console a dedicated Dependabot container.
#/       the container is active on all nodes, and exists only to perform
#/       exec'd
set -e

#shellcheck source=vm_files/usr/local/share/enterprise/ghe-nomad-lib
source /usr/local/share/enterprise/ghe-nomad-lib

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c4-
  exit 2
fi

interactive=
if [ "$1" = "-i" ] || [ "$1" == "--interactive" ]; then
  interactive=1
  shift
fi
# If StdIn is not a TTY then force-disable interactive mode - this will be the case
# where input is piped to ghe-dependabot-env.
if [ ! -t 0 ]; then
  interactive=
fi

hostname=
if [[ -f /etc/github/cluster ]]; then
  hostname=$(cat /etc/github/cluster)
fi

alloc_id=$(find_allocation "dependabot-env" "$hostname")

if [[ -z "$*" ]]; then
  run_in_allocation "$alloc_id" "/bin/bash"
elif [[ -n "$interactive" ]]; then
  run_in_allocation "$alloc_id" "$@"
else
  run_in_allocation "$alloc_id" "$@"
fi
