index index.html index.htm;

# needed to forward user's IP address to rails
proxy_set_header  X-Real-IP       $remote_addr;
# When forwarded thru multiple proxies, X-Forwarded-For can have multiple
# addresses, which the app expects to strip off to get the actual client IP.
# https://github.com/github/production/issues/771
proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header  Host            $http_host;
proxy_set_header  X-Nginx-Request-Start "t=${msec}000";

proxy_redirect    off;

# https://github.com/github/puppet/pull/13753
# proxy_buffer_size does something different than proxy_buffer
proxy_buffers     32 16k;
proxy_buffer_size 16k;

# set Expire header on assets: see http://developer.yahoo.com/performance/rules.html#expires
location ~ ^/(static/|images/|javascripts/|stylesheets/|favicon\.ico|favicon\.png|flash/.*\.swf) {
    expires 10y;
}

# serve any existing file
if (-f $request_filename) {
    break;
}

# serve any standard Rails page cache file with .html extension
if (-f $request_filename.html) {
    rewrite (.*) $1.html break;
}
