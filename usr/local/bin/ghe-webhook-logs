#!/bin/bash
set -e

# Show usage directly from `ghe-webhook-logs`

hookshot_go_sha="$(cat /data/docker-image-tags/hookshot_go_image_tag)"
hookshot_go_image_tag="hookshot-go:${hookshot_go_sha}"
mysql_username=$(/usr/local/share/enterprise/ghe-call-configrb mysql_username)
mysql_password=$(/usr/local/share/enterprise/ghe-call-configrb mysql_password)

docker run \
  --rm \
  --network host \
  --user hookshot \
  -e "APP_ENV=production" \
  -e "ENTERPRISE=1" \
  -e "REPLICA_DB_URL=$mysql_username:$mysql_password@unix(/go/src/app/mysql-replica.sock)/github_enterprise" \
  -e "DB_MAX_OPEN_CONNS=10" \
  -e "DB_MAX_IDLE_CONNS=5" \
  -e "DB_CONN_MAX_LIFETIME=5m" \
  -e "DB_TIMEOUT=5s" \
  --volume "/data/hookshot/shared/sockets/mysql-replica.sock":"/go/src/app/mysql-replica.sock" \
  "$hookshot_go_image_tag" \
  "/script/ghe-webhook-logs" "$@"
