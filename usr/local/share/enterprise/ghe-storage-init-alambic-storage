#!/bin/bash

set -e

[ "$(whoami)" = "root" ] || {
  exec sudo -u root "$0" "$@"
  echo Run this script as the root user. >&2
  exit 1
}

user_dirs="alambic_cdn alambic_assets storage"
mountpoint="/data/alambic-data"

for dir in $user_dirs; do
  user_dir="/data/user/$dir"
  if [ -L "$user_dir" ]; then
    echo "Error: $user_dir is already a symlink" >&2
    exit 1
  fi
done

if ! mountpoint -q "$mountpoint"; then
  echo "Error: $mountpoint is not mounted. Use ghe-storage-init-alambic first." >&2
  exit 1
fi

if ! ghe-maintenance -q; then
  echo "Error: maintenance mode must be enabled before moving alambic storage." >&2
  exit 1
fi

if systemctl is-active alambic; then
  /usr/local/share/enterprise/ghe-nomad-local-alloc-stop alambic
fi

for dir in $user_dirs; do
  user_dir="/data/user/$dir"
  if [ -e "$user_dir" ]; then
    rsync -a --delete "$user_dir" "$mountpoint/"
    mv -f "$user_dir" "$user_dir.old"
  fi
  ln -nsf "$mountpoint/$dir" "$user_dir"
done

if ! service_enabled alambic; then
  /usr/local/share/enterprise/ghe-nomad-local-alloc-stop alambic
  exit 0
fi

/usr/local/share/enterprise/ghe-nomad-jobs queue /etc/nomad-jobs/alambic/alambic.hcl

echo "Success: alambic directories moved to $mountpoint"
