#!/usr/bin/env bash
# Generated by script/bootstrap.

# setup clean rbenv path
unset RBENV_HOOK_PATH

# setup app root envionment variable
export RAILS_ROOT=$(dirname $(dirname $(readlink -f "$0")))

# setup environment
source "$RAILS_ROOT/script/environment.sh"

# setup PATH
: ${NON_GH_PATH:=$PATH}; export NON_GH_PATH
export PATH="/data/gitrpcd/current/bin:$RAILS_ROOT/bin:/usr/share/rbenv/versions/3.3.4/bin:/usr/share/rbenv/libexec:/root/go/bin:/usr/share/rbenv/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/bin/tools"

# make gettimeofday() faster
[ -f /etc/localtime ] && export TZ=:/etc/localtime

# unset any gc tuning params that might be set in the environment
unset RUBY_GC_OLDMALLOC_LIMIT
unset RUBY_GC_OLDMALLOC_LIMIT_MAX
unset RUBY_GC_MALLOC_LIMIT
unset RUBY_GC_MALLOC_LIMIT_MAX
unset RUBY_GC_HEAP_FREE_SLOTS
unset RUBY_GC_HEAP_FREE_SLOTS_MIN_RATIO

[ -z "${GH_YJIT_MEM_SIZE+isset}" ] && export GH_YJIT_MEM_SIZE=48
[ -z "${GH_YJIT_CALL_THRESHOLD+isset}" ] && export GH_YJIT_CALL_THRESHOLD=1000
[ -z "${GH_YJIT_COLD_THRESHOLD+isset}" ] && export GH_YJIT_COLD_THRESHOLD=200000

[ -z "${GH_EXPERIMENTAL_YJIT_MEM_SIZE+isset}" ] && export GH_EXPERIMENTAL_YJIT_MEM_SIZE=48
[ -z "${GH_EXPERIMENTAL_YJIT_CALL_THRESHOLD+isset}" ] && export GH_EXPERIMENTAL_YJIT_CALL_THRESHOLD=1000
[ -z "${GH_EXPERIMENTAL_YJIT_COLD_THRESHOLD+isset}" ] && export GH_EXPERIMENTAL_YJIT_COLD_THRESHOLD=200000

[ "$GH_OTEL_K8S_CLUSTER_NAME" = dotcom-7-ac4-iad ] && export GH_YJIT_MEM_SIZE=$GH_EXPERIMENTAL_YJIT_MEM_SIZE
[ "$GH_OTEL_K8S_CLUSTER_NAME" = dotcom-7-ac4-iad ] && export GH_YJIT_CALL_THRESHOLD=$GH_EXPERIMENTAL_YJIT_CALL_THRESHOLD
[ "$GH_OTEL_K8S_CLUSTER_NAME" = dotcom-7-ac4-iad ] && export GH_YJIT_COLD_THRESHOLD=$GH_EXPERIMENTAL_YJIT_COLD_THRESHOLD

exec ruby --disable-gems "$@"
