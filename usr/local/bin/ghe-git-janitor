#!/bin/bash
set -euo pipefail
# Usage: ghe-git-janitor [OPTS] [--fix] [--stdin] [<repo>...]
#
# Clean up messes and make small repairs within git repositories.
#
# Check, and optionally fix, several types of filesystem-related
# problems that can occur within Git repositories:
#
# * Absence of required files/directories
# * File and directory ownership
# * File and directory permissions
# * Existence of various obsolete files and directories
# * Existence of temporary files that were not cleaned up properly
# * Incorrect or missing "hooks" symlink
#
# <repo> should be the filesystem path of a Git repository.

. /usr/local/share/enterprise/ghe-nomad-lib

if [ -f /etc/github/cluster ]; then
  # want the allocation running on this node
  allocation_id="$(find_allocation gitrpcd "$(hostname)")" || exit 1
else
  allocation_id="$(find_allocation gitrpcd)" || exit 1
fi

if [[ "$*" =~ -h|--help ]]; then
  # Show usage.
  run_in_allocation "$allocation_id" env ENTERPRISE=1 RAILS_ENV=production /usr/local/bin/git-janitor "$@" | sed "s/Usage: git-janitor/Usage: ghe-git-janitor/"
else
  run_in_allocation "$allocation_id" env ENTERPRISE=1 RAILS_ENV=production /usr/local/bin/git-janitor "$@"
fi
