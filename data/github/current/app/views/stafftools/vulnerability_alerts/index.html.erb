<% page_info title: view.page_title %>

<div class="boxed-group">
  <h3>
  Users And Teams Authorized For Dependabot Alerts
  <span class="float-right"><%= view.authorized_limit %></span>
  </h3>
  <div class="boxed-group-inner">
  <% if view.repository.vulnerability_alerts_enabled? %>
    <% if view.repository.in_organization? %>
      <p>
      By default organization and repository admins receive Dependabot alerts for this repo.
      </p>
      <% if view.authorized_count > 0 %>
        <ul class="boxed-group-list">
        <% view.users_and_teams.each do |user_or_team| %>
          <li>
            <% if user_or_team.is_a?(Team) %>
              <span><%= link_to "@#{user_or_team}", gh_stafftools_team_path(user_or_team) %></span>
              <span class="float-right"><%= pluralize user_or_team.members.count, "user" %></span>
            <% elsif user_or_team.is_a?(User) %>
              <span><%= link_to "@#{user_or_team}", stafftools_user_emails_path(user_or_team) %></span>
              <span class="float-right"><%= user_or_team.profile_name %></span>
            <% end %>
          </li>
        <% end %>
        </ul>
      <% end %>
    <% else %>
      <p>
      Only the repository's owner <%= link_to view.repository.owner, stafftools_user_emails_path(view.repository.owner), class: "Link--inTextBlock" %> will receive Dependabot alerts.
      </p>
    <% end %>
  <% else %>
    <p>
    Dependabot alerts are disabled for this repository.
    </p>
  <% end %>
  </div>
</div>

<div class="site-admin-subhead ruleless">
  <h2 class="site-admin-subhead-heading">
    Audit log
  </h2>
</div>

<% if stafftools_action_authorized?(controller: Stafftools::SearchController, action: :audit_log) %>
  <%= render \
    partial: "stafftools/audit_log",
    locals: {
      query: query,
      logs: logs,
      more_results: more_results,
    } %>
<% else %>
  <p><%= stafftools_not_authorized_html %></p>
<% end %>

<div class="site-admin-subhead ruleless">
  <h2 class="site-admin-subhead-heading">
    Repository Vulnerability Alerts
  </h2>
</div>

<% if alerts.any? %>
  <table class="site-admin-table">
    <thead>
      <tr>
        <th scope="col">
          Status
        </th>
        <th scope="col">
          Database Id
        </th>
        <th scope="col">
          Number
        </th>
        <th scope="col">
          Vulnerability
        </th>
        <th scope="col">
          Dismissed At
        </th>
        <th scope="col" class="right-align">
          Created At
        </th>
      </tr>
    </thead>
    <tbody>
      <% alerts.each do |alert| %>
        <tr>
          <td class="tiny">
            <% if alert.dismissed? %>
              <%= primer_octicon(:"bell-slash", classes: "closed") %>
            <% else %>
              <%= primer_octicon(:alert, classes: "open") %>
            <% end %>
          </td>

          <%# As per WCAG 2.1 Experimental, WCAG 2.0 Experimental, Section 508, a per row table header is required %>
          <th scope="row">
            <%= link_to "#{alert.id}", stafftools_repository_vulnerability_alert_path(current_repository.owner, current_repository.name, alert) %>
          </th>

          <%#
            In the UI and APIs the alert number is frequently used instead of the database id, thus listing the
            number in addition to the database id provides provides for a quick way to locate the relevant alert.
          %>
          <td>
            <%= "##{alert.number}" %>
          </td>

          <td>
            <%= link_to(alert.vulnerability.ghsa_id, global_advisory_path(alert.vulnerability.ghsa_id)) %>
          </td>

          <td class="right-align">
            <%= alert.dismissed_at&.utc %>
          </td>

          <td class="right-align">
            <%= alert.created_at.utc %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>


  <div class="paginate-container">
    <%= will_paginate alerts, params: {user_id: params[:user_id], repository: params[:repository]} %>
  </div>
<% else %>
  <p class="site-admin-blankstate">
    No alerts.
  </p>
<% end %>
