#!/bin/bash
#/ Usage: ghe-actions-update-check [-s]
#/
#/ Check that Host and Database upgrade for GitHub Action services has completed
#/
#/ OPTIONS:
#/   -h | --help        Show this message
#/   -s | --service     The name of the service (actions, mps, token, artifactcache). 
#/                      If not specified, will check all services.
#/
set -e
#shellcheck source=vm_files/usr/local/share/enterprise/ghe-actions-lib
. /usr/local/share/enterprise/ghe-actions-lib

# Default options
services="$(action-services)"

usage() {
    grep '^#/' < "$0" | cut -c 4-
    exit 2
}

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            usage
            ;;
        -s|--service)
            services="$(to-lower "$2")"
            shift 2
            ;;
        *)
            >&2 echo "Unrecognized argument: $1"
            usage
            ;;
    esac
done

for service in $services; do
    if check-service-name "$service";then
        echo "Checking Update for $(capitalize "$service")"
        ghe-actions-console -s $service -c Assert-UpdateComplete
    else
        echo "Ignoring update check because $service is not enabled"
    fi
done
