#!/bin/bash
#/ Usage: ghe-cleanup-caches [-h]
#/
#/ Clean up a variety of caches that might potentially take up extra disk space
#/ on the root volume.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

[ "$(whoami)" = "root" ] || {
  exec sudo -u root "$0" "$@"
  echo Run this script as the root user. >&2
  exit 1
}

function message {
  echo " --> ${1}"
}

message "Cleaning up /tmp..."
find /tmp -maxdepth 1 -type f -size +5M -mmin +60 -print0 | xargs -r -0 rm -f
find /tmp -maxdepth 1 -name "d[0-9]*-[0-9]*" -type d -mmin +60 -print0 | xargs -r -0 rm -rf

message "Cleaning up core dumps..."
mkdir -p /cores && {
  find /cores -type f -print0 | xargs -r -0 rm -f
}

message "Cleaning up user tmp..."
/usr/local/share/enterprise/ghe-user-tmp-init

message "Done."
