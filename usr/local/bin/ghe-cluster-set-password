#!/bin/bash
#/ Usage: ghe-cluster-set-password [-h] [--sync | --clear]
#/
#/ Updates the admin/management console password interactively on all cluster nodes.
#/
#/ OPTIONS:
#/    -h | --help    Show this message.
#/    --sync         Copy password files to other servers, and set admin user's
#/                   password to whatever manage has set. Do not set new password.
#/    --clear        Clear password for admin and Manage for all servers.
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

export PATH="$PATH:/usr/local/share/enterprise"

if [ ! -f "/etc/github/cluster" ] || [ -z "$(cat /etc/github/cluster)" ]; then
  echo "Clustering is not configured on this host." >&2
  exit 1
fi

[ "$(whoami)" = "root" ] || {
    exec sudo -u root "$0" "$@"
    echo Run this script as the root user. >&2
    exit 1
}

if [ "$1" = "--sync" ]; then
  ghe-cluster-config-update -p
  ghe-cluster-each -o -- ghe-set-password --sync
  exit 0
fi

if [ "$1" = "--clear" ]; then
  ghe-cluster-each -o -- ghe-set-password --clear
  exit 0
fi

# Set the password locally. Since it uses the API, which is aware of Cluster
# and calls `ghe-cluster-set-password --sync` we don't have to do anything else.
ghe-set-password
