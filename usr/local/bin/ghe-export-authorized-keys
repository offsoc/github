#!/bin/sh
#/ Usage: ghe-export-authorized-keys [-h]
#/
#/ Export all installed SSH authorized keys for the admin SSH user in plain-text format to STDOUT.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
#/ EXAMPLE:
#/
#/  Export the authorized keys to a file:
#/    $ ghe-export-authorized-keys > dump-file
#/
#/  Transfer the SSH authorized keys from the current appliance to another:
#/    $ ghe-export-authorized-keys | ssh -p 122 admin@[hostname] -- ghe-import-authorized-keys
#/
set -e

AUTHORIZED_KEYS_PATH="${AUTHORIZED_KEYS_PATH:-/data/user/common/authorized_keys}"

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

[ "$(whoami)" = "admin" ] || [ -r "$AUTHORIZED_KEYS_PATH" ] || {
  exec sudo -u admin AUTHORIZED_KEYS_PATH="$AUTHORIZED_KEYS_PATH" "$0" "$@"
  echo Run this script as admin. >&2
  exit 1
}

if [ -r "$AUTHORIZED_KEYS_PATH" ]; then
  cat "$AUTHORIZED_KEYS_PATH"
else
  sudo cat "$AUTHORIZED_KEYS_PATH"
fi
