#!/bin/bash
#/
#/ This command is used rotate the keys used for storing and transmitting
#/ encrypted secrets.
#/

set -e

USAGE="usage: ghe-secret-scanning-rotate-encrypted-secrets-key [-y]"

message() {
  echo "${1}" | ts
}

confirm() {
  read -p "This will rotate the keys for encrypted secrets. Do you want to continue? [y/N] " -n 1 -r
  echo
  if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
    exit 1
  fi
}

help() {
  echo "${USAGE}"
  echo
  echo "Arguments:"
  echo "  -h    Print help"
  echo "  -y    Don't prompt for confirmation"
}

KEY_LEN_BYTES=32
DELIMITED_STORAGE_KEYS_SETTING=secrets.secret-scanning.encrypted-secrets-delimited-storage-keys
DELIMITED_TRANSIT_KEYS_SETTING=secrets.secret-scanning.encrypted-secrets-delimited-shared-transit-keys
CURRENT_STORAGE_KEY_SETTING=secrets.secret-scanning.encrypted-secrets-current-storage-key
CURRENT_TRANSIT_KEY_SETTING=secrets.secret-scanning.encrypted-secrets-current-shared-transit-key
export GHE_CMD_RUN_ID="$(basename "$0")-$(echo $RANDOM | md5sum | head -c 16)"

# Parse args
SKIP_CONFIRM=n
while getopts yh flag
do
  case "${flag}" in 
    y) SKIP_CONFIRM=y;;
    h) help; exit 1;;
    *) echo "${USAGE}" >&2; exit 1;;
  esac
done

if [ "${SKIP_CONFIRM}" == "n" ]; then
  confirm
fi

# Read existing keys
OLD_STORAGE_KEYS=$(ghe-config --get $DELIMITED_STORAGE_KEYS_SETTING)
OLD_TRANSIT_KEYS=$(ghe-config --get $DELIMITED_TRANSIT_KEYS_SETTING)

# Generate new keys
message "Generating storage key"
STORAGE_KEY=$(openssl rand -base64 $KEY_LEN_BYTES)
message "Generating transit key"
TRANSIT_KEY=$(openssl rand -base64 $KEY_LEN_BYTES)

# Append new keys to decryption lists
message "Appending new keys to decryption lists"
ghe-config "$DELIMITED_STORAGE_KEYS_SETTING" "$OLD_STORAGE_KEYS;$STORAGE_KEY"
ghe-config "$DELIMITED_TRANSIT_KEYS_SETTING" "$OLD_TRANSIT_KEYS;$TRANSIT_KEY"

# Restart everything
message "Restarting GitHub services"
ghe-config-apply

# Save encryption keys
message "Saving encryption keys"
ghe-config "$CURRENT_STORAGE_KEY_SETTING" "$STORAGE_KEY"
ghe-config "$CURRENT_TRANSIT_KEY_SETTING" "$TRANSIT_KEY"

# Restart everything
message "Restarting GitHub services"
ghe-config-apply

message "Key rotation complete. The new keys will now be used for all future encryptions."
