#!/bin/sh

set -e

cd "$(dirname "$0")/.."

nightly_mode=false
force_clone=false
gem_name="github-scout"
# Parsing command-line options.
#
# -f : Force clone the sample repositories.
# -d : Use Gemfile.nightly-ci with bundler. To be used with daily CI.
while getopts "fd" arg; do
  case $arg in
    f)
      force_clone=true
      ;;
    d)
      nightly_mode=true
      ;;
  esac
done

if [ "$nightly_mode" = true ]; then
  gem_name="github-scout.nightly-ci"
else
  # Install gems in vendor/gems
  bundle config --local path vendor/gems
fi

bundle install

# Generate binstub for testing
bundle binstubs "$gem_name" --path binstub --force --standalone

# Load samples for functional tests
if [ "$force_clone" = true ]; then
  script/load-sample-repositories -f
else
  script/load-sample-repositories
fi
