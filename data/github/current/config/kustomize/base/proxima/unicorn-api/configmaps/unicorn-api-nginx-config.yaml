# https://github.com/github/kube/blob/master/docs/kubernetes/resources/configmap.md
apiVersion: v1
kind: ConfigMap
metadata:
  name: unicorn-api-nginx-conf
data:
  nginx.conf: |
    env KUBE_POD_NAME;
    worker_processes 6;
    pid /nginx-pidfile/nginx.pid;

    events {
      worker_connections 1024;
      use epoll;
      accept_mutex off;
    }

    http {
      include /etc/nginx/mime.types;
      include /etc/nginx/logging.conf;
      include /etc/nginx/gzip.conf;

      default_type application/octet-stream;
      server_tokens off;
      sendfile on;
      tcp_nopush on;
      keepalive_disable msie6;

      # X-Real-IP is set by haproxy so we should be able to trust it
      set_real_ip_from 0.0.0.0/0;
      real_ip_header X-Real-IP;

      upstream unicorn {
        server unix:/sockets/unicorn.sock fail_timeout=0;
      }

      map $uri $gh_error_page_502 {
        default     /502.json;
        /graphql    /502-graphql.json;
      }

      server{
        listen 8081;
        location /stats {
          stub_status;
        }

        location /status {
          return 200;
        }
      }

      server {
        listen 80 default_server;
        include /etc/nginx/large_file_uploads.conf;
        include /etc/nginx/error_pages.conf;
        include /etc/nginx/github_prod.conf;
        include /etc/nginx/fallback.conf;

        root /assets/public;

        location / {
          include /etc/nginx/proxy.conf;
          set_by_lua $KUBE_POD_NAME 'ngx.header["X-GLB-Log-Append"] = (ngx.header["X-GLB-Log-Append"] or "") .. " kube_pod_name=\\"" .. os.getenv("KUBE_POD_NAME") .. "\\""';
          add_header Vary "Accept-Encoding, Accept, X-Requested-With" always;
          add_header X-GitHub-Backend Kubernetes always;

          if (!-f $request_filename) {
            proxy_pass http://unicorn;
          }
        }

        location /robots.txt {
          alias /assets/public/api_robots.txt;
        }

        location /502-graphql.json {
          sub_filter "###REQUEST_ID###" "$http_x_github_request_id";
          sub_filter_types application/json;
          add_header Access-Control-Expose-Headers "ETag, Link, Location, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval, X-GitHub-Media-Type, Deprecation, Sunset" always;
          add_header Access-Control-Allow-Origin "*" always;
          add_header Vary "Accept-Encoding, Accept, X-Requested-With" always;
          add_header X-GitHub-Backend Kubernetes always;
        }
      }
    }

  gzip.conf: |
    gzip              on;
    gzip_http_version 1.0;
    gzip_comp_level   2;
    gzip_proxied      any;
    gzip_buffers      16 8k;
    gzip_types        text/plain text/css application/x-javascript text/xml application/json application/xml application/xml+rss text/javascript application/javascript image/svg+xml image/x-icon image/vnd.microsoft.icon application/manifest+json text/fragment+html;

  mime.types: |
    types {
      text/html                             html htm shtml;
      text/css                              css;
      text/xml                              xml rss;
      image/gif                             gif;
      image/jpeg                            jpeg jpg;
      application/javascript                js;
      application/atom+xml                  atom;
      application/json                      json;

      text/mathml                           mml;
      text/plain                            txt;
      text/vnd.sun.j2me.app-descriptor      jad;
      text/vnd.wap.wml                      wml;
      text/x-component                      htc;
      text/cache-manifest                   manifest appcache;

      image/png                             png;
      image/svg+xml                         svg;
      image/svg+xml                         svgz;
      image/tiff                            tif tiff;
      image/vnd.wap.wbmp                    wbmp;
      image/x-icon                          ico;
      image/x-jng                           jng;
      image/x-ms-bmp                        bmp;

      application/vnd.ms-fontobject         eot;
      application/x-font-ttf                ttf;
      application/x-font-woff               woff;
      font/opentype                         otf;

      application/java-archive              jar ear;
      application/mac-binhex40              hqx;
      application/msword                    doc;
      application/pdf                       pdf;
      application/postscript                ps eps ai;
      application/rtf                       rtf;
      application/vnd.ms-excel              xls;
      application/vnd.ms-powerpoint         ppt;
      application/vnd.wap.wmlc              wmlc;
      application/vnd.wap.xhtml+xml         xhtml;
      application/x-cocoa                   cco;
      application/x-java-archive-diff       jardiff;
      application/x-java-jnlp-file          jnlp;
      application/x-makeself                run;
      application/x-perl                    pl pm;
      application/x-pilot                   prc pdb;
      application/x-rar-compressed          rar;
      application/x-redhat-package-manager  rpm;
      application/x-sea                     sea;
      application/x-shockwave-flash         swf;
      application/x-stuffit                 sit;
      application/x-tcl                     tcl tk;
      application/x-x509-ca-cert            der pem crt;
      application/x-xpinstall               xpi;
      application/x-zip                     war;
      application/zip                       zip;

      application/octet-stream              bin exe dll;
      application/octet-stream              deb;
      application/octet-stream              dmg;
      application/octet-stream              iso img;
      application/octet-stream              msi msp msm;

      audio/midi                            mid midi kar;
      audio/mpeg                            mp3;
      audio/x-realaudio                     ra;

      video/3gpp                            3gpp 3gp;
      video/m4v                             m4v;
      video/mp4                             mp4;
      video/mpeg                            mpeg mpg;
      video/ogg                             ogg;
      video/ogg                             ogv;
      video/quicktime                       mov;
      video/webm                            webm;
      video/x-flv                           flv;
      video/x-mng                           mng;
      video/x-ms-asf                        asx asf;
      video/x-ms-wmv                        wmv;
      video/x-msvideo                       avi;
    }
  proxy.conf: |
    index index.html index.htm;

    # needed to forward user's IP address to rails
    proxy_set_header  X-Real-IP       $remote_addr;
    # When forwarded thru multiple proxies, X-Forwarded-For can have multiple
    # addresses, which the app expects to strip off to get the actual client IP.
    # https://github.com/github/production/issues/771
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header  Host            $http_host;
    proxy_set_header  X-Nginx-Request-Start "t=${msec}000";

    proxy_redirect    off;

    # https://github.com/github/puppet/pull/13753
    # proxy_buffer_size does something different than proxy_buffer
    proxy_buffers     32 16k;
    proxy_buffer_size 16k;

    # set Expire header on assets: see http://developer.yahoo.com/performance/rules.html#expires
    location ~ ^/(static/|images/|javascripts/|stylesheets/|favicon\.ico|favicon\.png|flash/.*\.swf) {
      expires 10y;
    }

    # serve any existing file
    if (-f $request_filename) {
      break;
    }

    # serve any standard Rails page cache file with .html extension
    if (-f $request_filename.html) {
      rewrite (.*) $1.html break;
    }

  logging.conf: |
    access_log /dev/null;

  error_pages.conf: |
    #
    # This config is used by multiple vhosts, system roles and etc.
    # Please be aware that changes may ripple to unexpected places.
    #
    error_page   404 406 /404.html;
    error_page   400 500 503 504  /500.html;
    error_page   502 $gh_error_page_502;

    # Let error handlers work on erroneous requests that come back from
    # backends, too, rather than just passing them straight through.
    proxy_intercept_errors off;

    # Don't pass error pages through proxies or whatever, just serve them
    # locally
    location ~ ^/(404|500).html$ {
      break;
    }

  large_file_uploads.conf: |
    # Set the max size for file uploads to 400Mb. This is also the maximum amount of data that can be pushed via githttp.
    client_max_body_size 400M;

  github_prod.conf: |
    ##
    ## haproxy cant return 410s
    ##
    # 410 API v2 to save on Rails hits
    location /api/v2/ {
        keepalive_timeout 0;
        return 410;
    }
    # 410 API v1 to save on Rails hits
    location /api/v1/ {
        keepalive_timeout 0;
        return 410;
    }

  fallback.conf: |
    set $fallback_retry "-";

    location = /fallback {
      internal;
      set $fallback_retry "fallback";
      root html;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X_FORWARDED_PROTO https;
      proxy_pass http://unicorn;
      break;
    }
    error_page 404 = /fallback;
