#!/bin/bash
#/ Usage: ghe-snmpv3-remove-user [-h] <username>
#/
#/ Remove a user from the SNMPv3 configuration.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
set -e

usage () {
  grep '^#/' < "$0" | cut -c4-
}

if [ -z "$1" ]; then
  usage
  exit 1
fi

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  usage
  exit 2
fi

username="$1"
users="$(ghe-config --get snmp.users)"
new_users=
found=

for user in ${users//;/ }; do
  if [ -n "$(echo $user | grep -o ^$username:)" ]; then
    found=1
  else
    [ -n "$new_users" ] && new_users+=";"
    new_users+="$user"
  fi
done

if [ -z "$found" ]; then
  echo "$username not found."
  exit 1
else
  if [ -n "$new_users" ]; then
    ghe-config snmp.users "$new_users"
  else
    if [ "$(ghe-config --get snmp.version)" = "3" ]; then
      echo 'Please disable SNMP or SNMPv3 before removing the last user.'
      exit 1
    else
      ghe-config snmp.users "$new_users"
    fi
  fi
  echo "$username successfully removed. Run \`ghe-config-apply\` for it to take effect."
fi
