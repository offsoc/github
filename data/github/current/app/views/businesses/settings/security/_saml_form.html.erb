<%# erblint:counter ButtonComponentMigrationCounter 1 %>
<%= f.text_group "Sign on URL", :sso_url,
  required: true,
  value: view.saml_sso_url,
  placeholder: "https://yourapp.example.com/apps/appId",
  hint: "Members will be forwarded here when signing in to your enterprise",
  type: :url,
  autocomplete: :off,
  readonly: view.saml_sso_configuration_changes_readonly?,
  error: view.saml_sso_url_error %>

<%= f.text_group "Issuer", :issuer,
  value: view.issuer,
  placeholder: "https://example.com",
  hint: "Typically a unique URL generated by your SAML identity provider",
  type: :url,
  autocomplete: :off,
  readonly: view.saml_sso_configuration_changes_readonly?,
  error: view.issuer_error %>

<%= f.text_area_group "Public certificate", :idp_certificate,
  for: "saml_idp_certificate",
  required: true,
  value: view.idp_certificate,
  placeholder: "Paste your x509 certificate here",
  rows: 20,
  cols: 40,
  class: "saml-certificate-field",
  readonly: view.saml_sso_configuration_readonly?,
  error: view.idp_certificate_error %>

<% if bootstrap_flow %>
  <%= hidden_field_tag "saml[signature_method]", view.signature_method %>
  <%= hidden_field_tag "saml[digest_method]", view.digest_method %>

  <% if GitHub.flipper[:saml_encrypted_assertions].enabled?(view.business) %>
    <%= hidden_field_tag "saml[encrypted_assertions]", view.encrypted_assertions_enabled? %>
    <%= hidden_field_tag "saml[encryption_method]", view.encryption_method %>
    <%= hidden_field_tag "saml[key_transport_method]", view.key_transport_method %>
  <% end %>

<% else %>
  <p class="note pb-2 mb-2 border-bottom">
    Your SAML provider is using the
    <% if view.saml_sso_configuration_readonly? %>
      <strong><%= view.saml_signature_method %></strong> Signature Method and the <strong><%= view.saml_digest_method %></strong> Digest Method.
    <% else %>
      <%= select_tag "saml[signature_method]",
        options_for_select(view.saml_signature_method_options,
        view.signature_method), class: "form-select select-sm method-field" %>
      <label for="saml_signature_method" class="method-label">Signature Method</label>
      and the
      <%= select_tag "saml[digest_method]",
        options_for_select(view.saml_digest_method_options, view.digest_method),
        class: "form-select select-sm method-field", readonly: view.saml_sso_configuration_readonly? %>
    <% end %>
    <label for="saml_digest_method" class="method-label">Digest Method</label>.
  </p>

  <% if GitHub.flipper[:saml_encrypted_assertions].enabled?(view.business) %>
    <div class="form-checkbox">
      <label>
        <%= check_box "saml", "encrypted_assertions", { checked: view.encrypted_assertions_enabled? } %>
        Encrypted Assertions
      </label>
    </div>

    <p class="note pb-2 mb-2 border-bottom">
      If encrypted assertions are enabled, then your SAML provider is required to use the
      <%= select_tag "saml[encryption_method]", options_for_select(view.saml_encryption_method_options, view.encryption_method), :class => "form-select select-sm method-field" %>
      <label for="saml_encryption_method" class="method-label">Encryption Method</label>
      and the
      <%= select_tag "saml[key_transport_method]", options_for_select(view.saml_key_transport_method_options, view.key_transport_method), :class => "form-select select-sm method-field" %>
      <label for="saml_key_transport_method" class="method-label">Key Transport Method</label>.
    </p>
  <% end %>

  <p class="note" <%= test_selector("saml-consume-link") %>>
    The assertion consumer service URL is
    <%= link_to view.saml_consume_url, view.saml_consume_path, class: "Link--inTextBlock" %>
  </p>
 <% end %>

<% unless view.saml_sso_configuration_readonly? %>
  <div class="d-flex flex-items-baseline my-5">
    <button id="test-saml-settings" name="test_settings" value="1" class="btn js-business-saml-submit" type="submit">Test SAML configuration</button>
    <div class="d-inline-block ml-3">
      <% if view.saml_test_failure? %>
        <%= render Primer::Beta::Octicon.new(icon: "x-circle", color: :danger) %>
        <strong>Failed</strong>:
        <%= view.saml_test_errors %>
      <% elsif view.saml_test_success? %>
        <%= render Primer::Beta::Octicon.new(icon: "check-circle", color: :success) %>
        <strong>Passed</strong>:
        Successfully authenticated your SAML SSO identity.
      <% else %>
        <%= render Primer::Beta::Octicon.new(icon: "alert") %>
        You need to test your SAML configuration before saving.
      <% end %>
    </div>
  </div>
<% end %>

<hr class="my-4">
