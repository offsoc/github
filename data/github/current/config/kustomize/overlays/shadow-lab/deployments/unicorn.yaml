apiVersion: apps/v1
kind: Deployment
metadata:
  name: unicorn
  annotations:
    moda.github.net/allow-missing-ready-pods: null
    moda.github.net/canary-label: null
    moda.github.net/canary-maxunavailable: null
    moda.github.net/canary-replicas: null
    moda.github.net/canary-v2: null
    heaven.githubapp.com/cluster-preferences: |
      {
        "dotcom-1-ash1-iad":  {
          "spec": {
            "template": {
              "spec": {
                "affinity": {
                  "nodeAffinity": {
                    "preferredDuringSchedulingIgnoredDuringExecution": [
                      { "weight": 1,
                        "preference": {
                          "matchExpressions": [
                            { "key": "kubernetes.github.com/pool",
                              "operator": "In",
                              "values": ["performance-testing"]
                            }
                          ]
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
spec:
  replicas: 3
  strategy:
    rollingUpdate:
      maxUnavailable: 1
  template:
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            preference:
              matchExpressions:
              - key: gpanel.githubapp.com/machine_type
                operator: In
                values:
                - general5.m.large
      containers:
        - name: unicorn
          env:
            - name: SMTP_HOST
              value: smtp.service.github.net
            - name: GH_HOSTNAME
              value: github.com
            - name: GITHUB_CONFIG_ROLE
              value: api
          resources:
            requests:
                cpu: 10.5
