#!/bin/bash

set -e

mkdir -p tmp

if [ "$(uname -s)" = "Darwin" ]; then
  if [ ! $(which docker) ]; then
    echo "docker not found, installing..."
    log=$(mktemp)
    brew cask install "docker" &> $log || (
    echo "Failed to brew bundle:"
    cat $log
    exit 1
    )
  fi

  if ! docker info > /dev/null 2>&1; then
    echo -n "docker doesn't appear to be running, trying to start it..."
    open -a Docker

    attempts=0
    while true; do
      if [ $attempts -ge 30 ]; then
        echo
        echo "docker didn't start after $attempts seconds :("
        exit 1
      fi
      if docker info > /dev/null 2>&1; then
        echo "started!"
        break
      fi
      sleep 1
      echo -n "."
      attempts=$((attempts+1))
    done
  fi
elif [ ! $(which docker) ]; then
  echo "docker not found, please install it before continuing."
  exit 1
fi

echo "building docker container..."
appdir=$(cd "$(dirname "$0")"/.. && pwd)
tag=$(git hash-object Dockerfile | cut -c1-9)
cd "$appdir" && docker build --rm -t hydro-client-ruby:${tag} .
