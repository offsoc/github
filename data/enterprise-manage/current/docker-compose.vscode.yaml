version: '3.6'

services:
  # In order to use the provided VSCode container environment, you need to have either the
  # [Remote Container extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) or the complete
  # [Remote Development pack](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack) installed in your VSCode instance.
  vscode:
    build:
      context: .
      dockerfile: Dockerfile.build
      args:
        APT_CREDS: "${APT_CREDS:-}"
        APT_HOST: "${APT_HOST:-packages.service.github.net}"
        USERNAME: ${USER:-default}
        USER_UID: ${UID:-1000}
        USER_GID: ${GID:-1000}
    image: ghes/enterprise-manage/vscode
    platform: linux/amd64
    environment:
      - SHELL=/bin/bash
      - USER=${USER:-default}
      # SSH Agent socket mapping only works on Linux.
      - SSH_AUTH_SOCK=/ssh-agent
    working_dir: /workspace/enterprise2/enterprise-manage
    volumes:
      # Attempt to map in Git configuration and SSH based credentials.
      #- ~/.gitconfig:/home/${USER:-default}/.gitconfig:ro
      - ~/.ssh:/home/${USER:-default}/.ssh:ro
      # SSH Agent socket mapping only works on Linux.
      - ${SSH_AUTH_SOCK:-/dev/null}:/ssh-agent
      - /var/run/docker.sock:/var/run/docker.sock
      - ..:/workspace/enterprise2
      - enterprise-manage-vendor-gems:/workspace/enterprise2/enterprise-manage/vendor/gems
    networks:
      - internal
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    command: sleep infinity
