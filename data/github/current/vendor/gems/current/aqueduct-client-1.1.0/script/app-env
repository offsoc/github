#!/bin/bash
#
# Run a command in the app's development docker environment.
#

set -e

# Run the command if we're inside the container already:
[ -f /etc/inside-container ] && exec "$@"

appdir=$(cd "$(dirname "$0")/.." && pwd)
tag=$($appdir/script/image-tag)

# Auto-bootstrap if the aqueduct-client-ruby image isn't available:
if [ ! $(which docker) ] || [ -z "$(docker images -q aqueduct-client-ruby:${tag})" ]; then
  echo "aqueduct-client-ruby:${tag} docker image not found, bootstrapping..."
  $appdir/script/bootstrap
fi

aqueduct=
if [[ -d "$appdir/../hydro-schemas" ]]; then
  aqueduct="-v $appdir/../aqueduct:/aqueduct"
else
  echo "no aqueduct installation found at ../aqueduct, not mounting it"
fi

appdir=$(cd "$(dirname "$0")/.." && pwd)
exec docker run -t -i --rm -v "$appdir:/aqueduct-client-ruby" $aqueduct aqueduct-client-ruby:${tag} "$@"
