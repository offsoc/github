#!/usr/bin/env ruby

require "optparse"

def usage
  $stderr.puts "Usage:"
  $stderr.puts " #{$0} <class_name> [comma separated IDs] [--dry-run]"
  exit 1
end

options = {}
ARGV.options do |opts|
  opts.on("-h", "--help") { usage }
  opts.on("--dry-run") { options[:dry_run] = true }
  begin
    opts.parse!
  rescue OptionParser::ParseError => e
    puts e
    usage
  end
end

ids = Array(ARGV[1..-1]).inject([]) do |ids, arg|
  ids.push(*arg.to_s.split(",").each(&:strip!))
end

require "./config/environment"
Failbot.disable    # suppress failbot reporting of unhandled exceptions
GitHub.load_activerecord

GitHub::Storage::RepairUploadablesCommand.new(
  class_name: ARGV[0],
  ids: ids,
  dry_run: options[:dry_run],
).perform
