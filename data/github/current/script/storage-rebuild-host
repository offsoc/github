#!/usr/bin/env ruby

require "optparse"

def usage
  $stderr.puts "Usage:"
  $stderr.puts " #{$0} [host] [storage_directory] [--dry-run]"
  exit 1
end

options = {}
ARGV.options do |opts|
  opts.on("-h", "--help") { usage }
  opts.on("--dry-run") { options[:dry_run] = true }
  begin
    opts.parse!
  rescue OptionParser::ParseError => e
    puts e
    usage
  end
end

usage if ARGV.any? { |arg| %w(-h --help).include?(arg) }

require "./config/environment"
Failbot.disable    # suppress failbot reporting of unhandled exceptions
GitHub.load_activerecord

GitHub::Storage::RebuildHostCommand.new(
  host: ARGV[0],
  dir: ARGV[1],
  dry_run: options[:dry_run],
).perform
