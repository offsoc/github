#!/bin/bash
#/ Usage: ghe-import-mysql [-h]
#/
#/ Import a backup taken with ghe-export-mysql.
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
#/ EXAMPLE:
#/
#/  Import the MySQL data from a dump file:
#/    $ ghe-import-mysql < sql-dump-file
#/
#/  Transfer the MySQL data from another appliance to this appliance:
#/    $ ssh -p 122 admin@[hostname] -- ghe-export-mysql | ghe-import-mysql
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ] ; then
  grep '^#/' <"$0" |cut -c 4-
  exit 2
fi

fail() {
  (>&2 echo "${1}")
  exit 1
}

import_type="logical"

if ghe-config --true 'mysql.backup.binary'; then
  import_type="binary"
fi

while getopts "b" flag; do
  case $flag in
    b)
      import_type="binary"
      ;;
    *) # unknown
      fail "unknown flag $flag"
      ;;
  esac
done

if [ "${import_type}" = "binary" ] ; then
  ghe-import-mysql-xtrabackup "$@"
else
  ghe-import-mysql-mysqldump "$@"
fi
