#!/bin/bash
#/ Usage: ghe-dbconsole [-h]
#/
#/ Open a MySQL database session on your GitHub Enterprise appliance. Do not use it
#/ to modify your database unless you are asked to do so by our Enterprise support
#/ team.
#/
#/ OPTIONS:
#/   -h | --help        Show this message.
#/
set -e

prompt_less=

usage() {
  grep '^#/' <"$0" |cut -c 4-
  exit 2
}

proceed() {
  if [ -z "$prompt_less" ]; then
    echo "$(basename $0) should only be used when requested by the GitHub Enterprise Support team. Incorrect use could cause damage or data loss."
    read -p "Proceed with ghe-dbconsole? [y/N] " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      exit 1
    fi
  fi
}

console() {
  github-env -i bin/safe-ruby script/dbconsole -p
}

message() {
  echo " --> ${1}"
}

# show usage if any argument is passed other than -h or -y
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 2
      ;;
    -y|--yes)
      prompt_less=1
      shift
      ;;
    *)
      usage
      exit 1
      ;;
    esac
done

proceed
console
