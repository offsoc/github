apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
    - ../../../base/proxima/unicorn-api/

nameSuffix: -graphql
patches:
    - target:
        kind: Deployment
        name: unicorn-api
      patch: |-
        - op: replace
          path: /spec/template/spec/containers/1/env/0
          value:
            name: KUBE_DEPLOYMENT_NAME
            value: unicorn-api-graphql
        - op: replace
          path: /spec/strategy/rollingUpdate/maxUnavailable
          value: 1
        - op: replace
          path: /spec/selector/matchLabels/service
          value: unicorn-api-graphql
        - op: replace
          path: /spec/template/metadata/labels/service
          value: unicorn-api-graphql
        - op: add
          path: /spec/template/spec/containers/1/env/-
          value:
            name: TREELIGHTS_ENDPOINT
            value: "http://treelights.treelights-%stamp%.svc.cluster.local:8002"
    - target:
        kind: Service
        name: unicorn-api
      patch: |-
        - op: replace
          path: /metadata/annotations/kubernetes.io~1ingress.class
          value: "haproxytech-unicorn-api-graphql"
        - op: replace
          path: /metadata/labels/service
          value: unicorn-api-graphql
        - op: replace
          path: /spec/selector/service
          value: unicorn-api-graphql
        - op: replace
          path: /metadata/annotations/opaque.github.net~1checks
          value:  |
            - http:
                url: "https://api.{{.Env.TEST_TENANT}}.ghe.com/graphql"
                method: POST
                header:
                    authorization: "Bearer {{ .Env.GITHUB_API_TOKEN }}"
              tags:
                  - "api-type:unicorn-api-graphql"
                  - "dotcom-api:true"
