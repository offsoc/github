#!/bin/sh
#/ Usage: ghe-export-redis [-h]
#/
#/ Export all Redis data, which includes a variety of cached data counts and
#/ other settings required by the application. The data is streamed as a
#/ standard redis dump file (.rdb).
#/
#/ OPTIONS:
#/   -h | --help      Show this message.
#/
#/ EXAMPLE:
#/
#/  Export the Redis data to a file:
#/    $ ghe-export-redis > dump-file
#/
#/  Transfer the Redis data from the current appliance to another:
#/    $ ghe-export-redis | ssh -p 122 admin@[hostname] -- ghe-import-redis
#/
set -e

# Show usage.
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  grep '^#/' < "$0" | cut -c 4-
  exit 2
fi

[ "$(whoami)" = "root" ] || {
  exec sudo -u root "$0" "$@"
  echo Run this script as the root user. >&2
  exit 1
}

GHE_REDIS_HOST="$(ghe-config cluster.redis-master || true)"
[ -z "$GHE_REDIS_HOST" ] && GHE_REDIS_HOST="localhost"

ghe-redis-cli --remote -h "$GHE_REDIS_HOST" --rdb - 2>/dev/null
