version: '3.6'

volumes:
  enterprise-manage-vendor-gems:

networks:
  internal:

# These services aren't intended to be run all at once.
services:

  single:
    image: ghes/enterprise-manage/vscode
    working_dir: /workspace/enterprise2/enterprise-manage
    volumes:
      - ..:/workspace/enterprise2
      - enterprise-manage-vendor-gems:/workspace/enterprise2/enterprise-manage/vendor/gems
      - ../vm_files/usr/local:/usr/local:ro
      - ./config/dev-image/ruby:/usr/bin/ruby:ro
      - ./config/dev-image/single/etc/github:/etc/github:ro
      - ./config/dev-image/single/var/lib/ghe-health-monitor:/var/lib/ghe-health-monitor:ro
    command: ["bin/rerun", "--background", "--pattern", "**/*.rb", "foreman", "start"]
    environment:
      RACK_ENV: "development"
      EM_DEV_ADDR: "0.0.0.0:3654"
      ENTERPRISE_STATUS_PREVIEW: "true"
      ENTERPRISE_DB_HOST: "mysql"
      ENTERPRISE_DB_USER: "mc"
      ENTERPRISE_DB_PASS: "mc"
      MANAGE_API_ENDPOINT: "ghes-manage-gateway-proxy:3100"
      MANAGE_API_USERNAME: "api_key"
      MANAGE_API_PASSWORD: "passworD1"
    ports:
      - "127.0.0.1:3654:3654"
    depends_on:
     mysql:
          condition: service_healthy
     ghes-manage-gateway:
          condition: service_healthy
     ghes-manage-gateway-proxy:
          condition: service_healthy
     ghes-manage-agent:
          condition: service_healthy
    networks:
      - internal


  ha:
    image: ghes/enterprise-manage/vscode
    working_dir: /workspace/enterprise2/enterprise-manage
    volumes:
      - ..:/workspace/enterprise2
      - enterprise-manage-vendor-gems:/workspace/enterprise2/enterprise-manage/vendor/gems
      - ../vm_files/usr/local:/usr/local:ro
      - ./config/dev-image/ruby:/usr/bin/ruby:ro
      - ./config/dev-image/ha/etc/github:/etc/github:ro
      - ./config/dev-image/ha/data:/data:ro
      - ./config/dev-image/ha/var/lib/ghe-health-monitor:/var/lib/ghe-health-monitor:ro
    command: ["bin/rerun", "--background", "--pattern", "**/*.rb", "foreman", "start"]
    environment:
      RACK_ENV: "development"
      EM_DEV_ADDR: "0.0.0.0:3654"
      ENTERPRISE_STATUS_PREVIEW: "true"
    ports:
      - "127.0.0.1:3654:3654"
    networks:
      - internal

  cluster:
    image: ghes/enterprise-manage/vscode
    working_dir: /workspace/enterprise2/enterprise-manage
    volumes:
      - ..:/workspace/enterprise2
      - enterprise-manage-vendor-gems:/workspace/enterprise2/enterprise-manage/vendor/gems
      - ../vm_files/usr/local:/usr/local:ro
      - ./config/dev-image/ruby:/usr/bin/ruby:ro
      - ./config/dev-image/cluster/etc/github:/etc/github:ro
      - ./config/dev-image/cluster/data:/data:ro
      - ./config/dev-image/cluster/var/lib/ghe-health-monitor:/var/lib/ghe-health-monitor:ro
    command: ["bin/rerun", "--background", "--pattern", "**/*.rb", "foreman", "start"]
    environment:
      RACK_ENV: "development"
      EM_DEV_ADDR: "0.0.0.0:3654"
      ENTERPRISE_STATUS_PREVIEW: "true"
    ports:
      - "127.0.0.1:3654:3654"
    networks:
      - internal
