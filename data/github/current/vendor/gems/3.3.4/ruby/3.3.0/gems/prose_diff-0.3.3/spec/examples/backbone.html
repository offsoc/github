<html>
<head>
    <title>backbone.html</title>
    <link href="./example.css" rel="stylesheet" type="text/css">
</head>
<body>

  <div class="example prose-diff">
    <h2>should not take more than ten seconds</h2>

    <div class="options"><div data-key="timeout">10.0</div></div>

    <div class="before">
      <article class="markdown-body entry-content" itemprop="mainContentOfPage"><h2>
      <a name="user-content-prelude" class="anchor" href="#prelude"><span class="octicon octicon-link"></span></a>Prelude</h2>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/logo.jpg" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/logo.jpg" alt="" style="max-width:100%;"></a></p>

      <p>Welcome to my (in-progress) book about the <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> framework for structuring JavaScript applications. It's released under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">license</a> meaning you can both grab a copy of the book for free or help to further <a href="https://github.com/addyosmani/backbone-fundamentals/">improve</a> it.</p>

      <p>I'm very pleased to announce that this book will be out in physical form later in the year via <a href="http://oreilly.com">O'Reilly Media</a>. Readers will have the option of purchasing the latest version in either print or a number of digital formats then or can grab a recent version from this repository.</p>

      <p>Corrections to existing material are always welcome and I hope that together we can provide the community with an up-to-date resource that is of help.
      My extended thanks go out to <a href="https://github.com/jashkenas">Jeremy Ashkenas</a> for creating Backbone.js and <a href="https://github.com/addyosmani/backbone-fundamentals/contributors">these</a> members of the community for their assistance tweaking this project.</p>

      <p>I hope you find this book helpful!</p>

      <p><strong>Notes:</strong></p>

      <ul>
      <li>Items added or updated in the last month are marked with a * in the outline.</li>
      <li>Once you're familiar with Backbone.js, you might be interested in checking out <a href="https://github.com/addyosmani/aura">Aura</a>.</li>
      </ul><h1>
      <a name="user-content-introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>

      <p>When writing a Web application from scratch, it’s easy to feel like we can get by simply by relying on a DOM manipulation library (like jQuery) and a handful of utility plugins. The problem with this is that it doesn’t take long to get lost in a nested pile of jQuery callbacks and DOM elements without any real structure in place for our applications.</p>

      <p>In short, we’re stuck with spaghetti code. Fortunately there are modern JavaScript frameworks that can assist with bringing structure and organization to our projects, improving how easily maintainable they are in the long-run.</p>

      <h3>
      <a name="user-content-what-is-mvc-or-rather-mv" class="anchor" href="#what-is-mvc-or-rather-mv"><span class="octicon octicon-link"></span></a>What Is MVC, Or Rather MV*?</h3>

      <p>These modern frameworks provide developers an easy path to organizing their code using variations of a pattern known as MVC (Model-View-Controller). MVC separates the concerns in an application down into three parts:</p>

      <ul>
      <li>Models represent the domain-specific knowledge and data in an application. Think of this as being a ‘type’ of data you can model — like a User, Photo or Todo note. Models should notify anyone observing them about their current state (e.g Views).</li>
      <li>Views are typically considered the User-interface in an application (e.g your markup and templates), but don’t have to be. They should know about the existence of Models in order to observe them, but don’t directly communicate with them.</li>
      <li>Controllers handle the input (e.g clicks, user actions) in an application and Views can be considered as handling the output. When a Controller updates the state of a model (such as editing Todo note content), it doesn’t directly tell the View. This is what the observing nature of the View and Model relationship is for.</li>
      </ul><p>JavaScript ‘MVC’ frameworks that can help us structure our code don’t always strictly follow the above pattern. Some frameworks will include the responsibility of the Controller in the View (e.g Backbone.js) whilst others add their own opinionated components into the mix as they feel this is more effective.</p>

      <p>For this reason we refer to such frameworks as following the MV* pattern, that is, you’re likely to have a View and a Model, but more likely to have something else also included.</p>

      <h3>
      <a name="user-content-what-exactly-is-backbonejs" class="anchor" href="#what-exactly-is-backbonejs"><span class="octicon octicon-link"></span></a>What exactly is Backbone.js?</h3>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/backbonejsorg.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/backbonejsorg.png" alt="" style="max-width:100%;"></a></p>

      <p>Backbone.js is a lightweight JavaScript framework for adding structure to your client-side code. It makes it easy to manage and decouple concerns in your application, leaving you with code that is more maintainable in the long term.</p>

      <p>Developers commonly use frameworks like Backbone.js to create single-page applications or SPAs. To put it simply, these apps enable the browser to react to changes in data on the client-side without the need to completely load up all your markup from the server, meaning no complete page-refreshes are necessary.</p>

      <p>Backbone.js is a mature, popular framework at the time of writing and has both a large development community online as well as a wealth of plugins and extensions available to build upon it. It has been used to create non-trivial applications by companies such as
      Disqus, Walmart, SoundCloud and Foursquare.</p>

      <h3>
      <a name="user-content-when-do-you-need-a-javascript-mv-framework" class="anchor" href="#when-do-you-need-a-javascript-mv-framework"><span class="octicon octicon-link"></span></a>When Do You Need A JavaScript MV* Framework?</h3>

      <p>When building a single-page application using JavaScript, whether it involves a complex user interface or is simply trying to reduce the number of HTTP requests required for new Views, you will likely find yourself inventing many of the pieces that make up an MV* framework like Backbone or Ember.</p>

      <p>At the outset, it isn’t terribly difficult to write an application framework that offers some opinionated way to avoid spaghetti code, however to say that it is equally as trivial to write something of the standard of Backbone would be a grossly incorrect assumption.</p>

      <p>There’s a lot more that goes into structuring an application than tying together a DOM manipulation library, templating and routing. Mature MV* frameworks typically not only include many of the pieces you would find yourself writing, but also include solutions to problems you’ll find yourself running into later on down the road. This is a time-saver that you shouldn’t underestimate the value of.</p>

      <p>So, where will you likely need an MV* framework and where won’t you?</p>

      <p>If you’re writing an application that will likely only be communicating with an API or back-end data service, where much of the heavy lifting for viewing or manipulating that data will be occurring in the browser, you may find a JavaScript MV* framework useful.
      Good examples of applications that fall into this category are GMail and Google Docs.</p>

      <p>These applications typically download a single payload containing all the scripts, stylesheets and markup users need for common tasks and then perform a lot of additional behavior in the background. It’s trivial to switch between reading an email or document to writing one and you don’t need to ask the application to render the whole page again at all.</p>

      <p>If, however, you’re building an application that still relies on the server for most of the heavy-lifting of Views/pages and you’re just using a little JavaScript or jQuery to make things a little more interactive, an MV framework may be overkill. There certainly are complex Web applications where the partial rendering of views can* be coupled with a single-page application effectively, but for everything else, you may find yourself better sticking to a simpler setup.</p>

      <p>Maturity in software (framework) development isn't simply about how long a framework has been around. It's about how solid the framework is and more importantly how well it's evolved to fill its role. Has it become more effective at solving common problems? Does it continue to improve as developers build larger and more complex applications with it?</p>

      <h3>
      <a name="user-content-why-should-you-consider-using-backbonejs" class="anchor" href="#why-should-you-consider-using-backbonejs"><span class="octicon octicon-link"></span></a>Why should you consider using Backbone.js?</h3>

      <p>Does the following describe you?:</p>

      <p>"I want something flexible which offers a minimalist solution to separating concerns in my application. It should support a persistence layer and RESTful sync, models, views (with controllers), event-driven communication, templating and routing. It should be imperative, allowing one to update the View when a model changes. I’d like some decisions about the architecture left up to me. Ideally, many large companies have used the solution to build non-trivial applications.</p>

      <p>As I may be building something complex, I’d like there to be an active extension community around the framework that have already tried addressing larger problems (Marionette, Chaplin, Aura, Thorax). Ideally, there are also scaffolding tools (grunt-bbb, brunch) available for the solution."</p>

      <p>If so, continue reading.</p>

      <p>Backbone's main benefits, regardless of your target platform or device, include helping:</p>

      <ul>
      <li>Organize the structure to your application</li>
      <li>Simplify server-side persistence</li>
      <li>Decouple the DOM from your page's data</li>
      <li>Model data, views and routers in a succinct manner</li>
      <li>Provide DOM, model and collection synchronization</li>
      </ul><h3>
      <a name="user-content-what-should-you-expect-to-see-in-this-book" class="anchor" href="#what-should-you-expect-to-see-in-this-book"><span class="octicon octicon-link"></span></a>What should you expect to see in this book?</h3>

      <p>The goal of this book is to create an authoritative and centralized repository of information that can help those developing real-world apps with Backbone. If you come across a section or topic which you think could be improved or expanded on, please feel free to submit a pull-request. It won't take long and you'll be helping other developers avoid problems you've run into before.</p>

      <p>Topics will include MVC theory and how to build applications using Backbone's models, views, collections and routers. I'll also be taking you through advanced topics like modular development with Backbone.js and AMD (via RequireJS), how to build applications using modern software stacks (like Node and Express), how to solve the routing problems with Backbone and jQuery Mobile, tips about scaffolding tools, and a lot more.</p>

      <h1>
      <a name="user-content-fundamentals" class="anchor" href="#fundamentals"><span class="octicon octicon-link"></span></a>Fundamentals</h1>

      <p>In this section, we're going to explore how frameworks like Backbone.js fit in the world of JavaScript application architecture. Classically, developers creating desktop and server-class applications have had a wealth of design patterns available for them to lean on, but it's only been in the past few years that such patterns have come to client-side development.</p>

      <p>Before exploring any JavaScript frameworks that assist in structuring applications, it can be useful to gain a basic understanding of architectural design patterns.</p>

      <h3>
      <a name="user-content-mvc-mvp--backbonejs" class="anchor" href="#mvc-mvp--backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP &amp; Backbone.js</h3>

      <p>Design patterns are proven solutions to common development problems and can suggest structural approaches to help guide developers in adding some organization to their applications.</p>

      <p>Patterns are useful because they're a set of practices that build upon the collective experience of skilled developers who have repeatedly solved similar problems. Although developers 10 or 20 years ago may not have been using the same programming languages when implementing patterns in their projects, there are many lessons we can learn from their efforts.</p>

      <p>In this section, we're going to review two popular patterns - MVC and MVP. We'll be exploring in greater detail how Backbone.js implements these patterns shortly to better appreciate where it fits in.</p>

      <h2>
      <a name="user-content-mvc" class="anchor" href="#mvc"><span class="octicon octicon-link"></span></a>MVC</h2>

      <p>MVC (Model-View-Controller) is an architectural design pattern that encourages improved application organization through a separation of concerns. It enforces the isolation of business data (Models) from user interfaces (Views), with a third component (Controllers) traditionally present to manage logic, user-input and the coordination of models and views. The pattern was originally designed by <a href="http://en.wikipedia.org/wiki/Trygve_Reenskaug">Trygve Reenskaug</a> while working on Smalltalk-80 (1979), where it was initially called Model-View-Controller-Editor. MVC was described in depth in <a href="http://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612">“Design Patterns: Elements of Reusable Object-Oriented Software”</a> (The "GoF" or “Gang of Four” book) in 1994, which played a role in popularizing its use.</p>

      <h3>
      <a name="user-content-smalltalk-80-mvc" class="anchor" href="#smalltalk-80-mvc"><span class="octicon octicon-link"></span></a>Smalltalk-80 MVC</h3>

      <p>It's important to understand what the original MVC pattern was aiming to solve as it has changed quite heavily since the days of its origin. Back in the 70's, graphical user-interfaces were few and far between. An approach known as <a href="http://martinfowler.com/eaaDev/uiArchs.html">Separated Presentation</a> began to be used as a means to make a clear division between domain objects which modeled concepts in the real world (e.g a photo, a person) and the presentation objects which were rendered to the user's screen.</p>

      <p>The Smalltalk-80 implementation of MVC took this concept further and had an objective of separating out the application logic from the user interface. The idea was that decoupling these parts of the application would also allow the reuse of models for other interfaces in the application. There are some interesting points worth noting about Smalltalk-80's MVC architecture:</p>

      <ul>
      <li>A Domain element was known as a Model and were ignorant of the user-interface (Views and Controllers)</li>
      <li>Presentation was taken care of by the View and the Controller, but there wasn't just a single view and controller. A View-Controller pair was required for each element being displayed on the screen and so there was no true separation between them</li>
      <li>The Controller's role in this pair was handling user input (such as key-presses and click events), doing something sensible with them.</li>
      <li>The Observer pattern was relied upon for updating the View whenever the Model changed</li>
      </ul><p>Developers are sometimes surprised when they learn that the Observer pattern (nowadays commonly implemented as a Publish/Subscribe system) was included as a part of MVC's architecture decades ago. In Smalltalk-80's MVC, the View and Controller both observe the Model: anytime the Model changes, the Views react. A simple example of this is an application backed by stock market data - for the application to show real-time information, any change to the data in its Models should result in the View being refreshed instantly.</p>

      <p>Martin Fowler has done an excellent job of writing about the <a href="http://martinfowler.com/eaaDev/uiArchs.html">origins</a> of MVC over the years and if you are interested in further historical information about Smalltalk-80's MVC, I recommend reading his work.</p>

      <h2>
      <a name="user-content-mvc-as-we-know-it" class="anchor" href="#mvc-as-we-know-it"><span class="octicon octicon-link"></span></a>MVC As We Know It</h2>

      <p>We've reviewed the 70's, but let us now return to the here and now. The MVC pattern has been applied to a diverse range of programming languages. For example, the popular Ruby on Rails is an implementation of a web application framework based on MVC for the Ruby language. JavaScript now has a number of MVC frameworks, including Ember.js, JavaScriptMVC, and of course Backbone.js. Given the importance of avoiding "spaghetti" code, a term which describes code that is very difficult to read or maintain due to its lack of structure, let's look at what the MVC pattern enables the Javascript developer to do.</p>

      <p>MVC is composed of three core components:</p>

      <h3>
      <a name="user-content-models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h3>

      <p>Models manage the data for an application. They are concerned with neither the user-interface nor presentation layers, but instead represent structured data that an application may require. When a model changes (e.g when it is updated), it will typically notify its observers (e.g views, a concept we will cover shortly) that a change has occurred so that they may react accordingly.</p>

      <p>To understand models better, let us imagine we have a JavaScript todo application. In a todo app, a todo item would merit its own model, as it represents a unique kind of domain-specific data. The Todo model may represent attributes such as a title and completed. A specific todo would be stored in an instance of a model. Here's an example of a simple Todo model implemented with Backbone.js:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// todo instantiated with default attributes </span>
        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default title: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// ""</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default status: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

        <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Enjoy reading the book'</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title changed: '</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

        <span class="c1">// new todo instantiated with todo specific data</span>
        <span class="kd">var</span> <span class="nx">secondTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Try this code in chrome console'</span><span class="p">});</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo title: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo status: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <p>The built-in capabilities of models vary across frameworks, however it's common for them to support validation of attributes, where attributes represent the properties of the model, such as a model identifier. When using models in real-world applications we generally also need a way of persisting models. Persistence allows us to edit and update models with the knowledge that their most recent states will be saved somewhere, for example in a web browser's localStorage data-store or synchronized with a database.</p>

      <p>A model may also have multiple views observing it. Imagine our Todo model contained meta-data such as the scheduled date, notes, days on which to repeat (if it's something we do on regular basis). A developer could create a single view that displayed all these attributes, or might create three separate views to display each attribute. The important detail is that the Todo model doesn't care how these views are organized, it simply announces updates to its data as necessary. We'll come back to Views in more detail later.</p>

      <p>It is not uncommon for modern MVC/MV* frameworks to provide a means to group models together. In Backbone, these groups are called "Collections". Managing models in groups allows us to write application logic based on notifications from the group, should any model it contains change. This avoids the need to manually observe individual model instances.</p>

      <p>Here's how we might group Todo models into a Backbone Collection:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Todos</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// For simplicity we'll use localStorage throughout the first part of book.</span>
          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>

          <span class="c1">// When working with REST API on back-end here would be</span>
          <span class="c1">// appropriate to use:</span>
          <span class="c1">// url: "/todos"</span>

        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read whole book'</span><span class="p">});</span>

        <span class="c1">// pass array of models on collection instantiation</span>
        <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todos</span><span class="p">([</span><span class="nx">firstTodo</span><span class="p">]);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection's convenience method used to create </span>
        <span class="c1">// new model instance within collection itself.</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">thirdTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Make something cool'</span><span class="p">});</span>

        <span class="c1">// Adds model to collection</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">thirdTodo</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection keeps models in models </span>
        <span class="c1">// property which is an array.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">models</span><span class="p">);</span>
      </pre></div>

      <p>If you read older texts on MVC, you may come across a description of models as also managing application "state". In JavaScript applications state has a specific meaning, typically referring to the current state of a view or sub-view on a user's screen at a fixed time. State is a topic which is regularly discussed when looking at Single-page applications, where the concept of state needs to be simulated.</p>

      <h3>
      <a name="user-content-views" class="anchor" href="#views"><span class="octicon octicon-link"></span></a>Views</h3>

      <p>Views are a visual representation of models that present a filtered view of their current state. A view typically observes a model and is notified when the model changes, allowing the view to update itself accordingly. Design pattern literature commonly refers to views as 'dumb', given that their knowledge of models and controllers in an application is limited.</p>

      <p>Users interact with views, which usually means reading and editing model data. For example, in our todo application example, todo model viewing might happen in a user interface in the list of all todo items. Within it each todo is rendered with their title and completed checkbox. Model editing could be done through an "edit" view where a user who has selected a specific todo could edit its title in a form.</p>

      <p>In MVC, the actual task of updating the Model falls to Controllers, which we'll be covering shortly.</p>

      <p>Let's explore Views a little further using a simple JavaScript example. Below we can see a function that creates a single Todo view, consuming both a model instance and a controller instance.</p>

      <p>We define a <code>render()</code> utility within our view which is responsible for rendering the contents of the <code>todoModel</code> using a JavaScript templating engine (<a href="http://underscorejs.org" title="Underscore.js">Underscore</a> templating) and updating the contents of our view, referenced by <code>todoEl</code>.</p>

      <p>The <code>todoModel</code> then adds our <code>render()</code> callback as one of its subscribers, so that through the Observer pattern it can trigger the view to update when the model changes.</p>

      <p>You may wonder where user interaction comes into play here. When users click on any elements within the view, it's not the view's responsibility to know what to do next. A Controller makes this decision. In our sample implementation, this is achieved by adding an event listener to <code>todoEl</code> which will delegate handling the click behavior back to the controller, passing the model information along with it in case it's needed.</p>

      <p>The benefit of this architecture is that each component plays its own separate role in making the application function as needed.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">buildTodoView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">todoModel</span><span class="p">,</span> <span class="nx">todoController</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">base</span>       <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">),</span>
            <span class="nx">todoEl</span>     <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>

        <span class="nx">base</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">todoEl</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">render</span><span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// We use a templating library such as Underscore</span>
          <span class="c1">// templating which generates the HTML for our</span>
          <span class="c1">// todo entry</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">'todoTemplate'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="nx">todoModel</span><span class="p">.</span><span class="nx">getSrc</span><span class="p">()</span> <span class="p">});</span>
         <span class="p">}</span>

        <span class="nx">todoModel</span><span class="p">.</span><span class="nx">addSubscriber</span><span class="p">(</span> <span class="nx">render</span> <span class="p">);</span>

        <span class="nx">todoEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoController</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">todoModel</span> <span class="p">);</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">showView</span><span class="o">:</span> <span class="nx">show</span><span class="p">,</span>
          <span class="nx">hideView</span><span class="o">:</span> <span class="nx">hide</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong>Templating</strong></p>

      <p>In the context of JavaScript frameworks that support MVC/MV*, it is worth looking more closely at JavaScript templating and its relationship to Views.</p>

      <p>It has long been considered bad practice (and computationally expensive) to manually create large blocks of HTML markup in-memory through string concatenation. Developers using this technique often find themselves iterating through their data, wrapping it in nested divs and using outdated techniques such as <code>document.write</code> to inject the 'template' into the DOM. This approach often means keeping scripted markup inline with standard markup, which can quickly become difficult to read and maintain, especially when building large applications.</p>

      <p>JavaScript templating libraries (such as Handlebars.js or Mustache) are often used to define templates for views as HTML markup containing template variables. These template blocks can be either stored externally or within script tags with a custom type (e.g 'text/template'). Variables are delimited using a variable syntax (e.g {{title}}). Javascript template libraries typically accept data in JSON, and the grunt work of populating templates with data is taken care of by the framework itself. This has a several benefits, particularly when opting to store templates externally as this can let applications load templates dynamically on an as-needed basis.</p>

      <p>Let's compare two examples of HTML templates. One is implemented using the popular Handlebars.js library, and the other uses Underscore's 'microtemplates'.</p>

      <p><strong>Handlebars.js:</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">{{#</span><span class="na">if</span> <span class="na">completed</span><span class="err">}}</span> <span class="err">"</span><span class="na">checked</span><span class="err">"</span> <span class="err">{{/</span><span class="na">if</span><span class="err">}}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label&gt;</span>{{title}}<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"{{title}}"</span><span class="nt">&gt;</span>
      </pre></div>

      <p><strong>Underscore.js Microtemplates:</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">completed</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span>&gt;
        <span class="nt">&lt;label&gt;</span><span class="err">&lt;</span>%= title %&gt;<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"&lt;%= title %&gt;"</span><span class="nt">&gt;</span>
      </pre></div>

      <p>You may also use double curly brackets (i.e <code>{{}}</code>) (or any other tag you feel comfortable with) in Microtemplates. In the case of curly brackets, this can be done by setting the Underscore <code>templateSettings</code> attribute as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">interpolate</span> <span class="o">:</span> <span class="sr">/\{\{(.+?)\}\}/g</span> <span class="p">};</span>
      </pre></div>

      <p><strong>A note on navigation and state</strong></p>

      <p>It is also worth noting that in classical web development, navigating between independent views required the use of a page refresh. In single-page JavaScript applications, however, once data is fetched from a server via Ajax, it can be dynamically rendered in a new view within the same page. Since this doesn't automatically update the URL, the role of navigation thus falls to a "router", which assists in managing application state (e.g allowing users to bookmark a particular view they have navigated to). As routers are however neither a part of MVC nor present in every MVC-like framework, I will not be going into them in greater detail in this section.</p>

      <h3>
      <a name="user-content-controllers" class="anchor" href="#controllers"><span class="octicon octicon-link"></span></a>Controllers</h3>

      <p>Controllers are an intermediary between models and views which are classically responsible for two tasks: they both update the view when the model changes and update the model when the user manipulates the view.</p>

      <p>In our Todo application, a controller would be responsible for handling changes the user made in the edit view for a particular todo, updating a specific todo model when a user has finished editing.</p>

      <p>It's with controllers that most JavaScript MVC frameworks depart from this interpretation of the MVC pattern. The reasons for this vary, but in my opinion, Javascript framework authors likely initially looked at server-side interpretations of MVC (such as Ruby on Rails), realized that that approach didn't translate 1:1 on the client-side, and so re-interpreted the C in MVC to solve their state management problem. This was a clever approach, but it can make it hard for developers coming to MVC for the first time to understand both the classical MVC pattern and the "proper" role of controllers in other non-Javascript frameworks.</p>

      <p>So does Backbone.js have Controllers? Not really. Backbone's Views typically contain "controller" logic, and Routers (discussed below) are used to help manage application state, but neither are true Controllers according to classical MVC.</p>

      <p>In this respect, contrary to what might be mentioned in the official documentation or in blog posts, Backbone is neither a truly MVC/MVP nor MVVM framework. It's in fact better to see it a member of the MV* family which approaches architecture in its own way. There is of course nothing wrong with this, but it is important to distinguish between classical MVC and MV* should you be relying on discussions of MVC to help with your Backbone projects.</p>

      <h3>
      <a name="user-content-controllers-in-spinejs-vs-backbonejs" class="anchor" href="#controllers-in-spinejs-vs-backbonejs"><span class="octicon octicon-link"></span></a>Controllers in Spine.js vs Backbone.js</h3>

      <p><strong>Spine.js</strong></p>

      <p>We now know that controllers are traditionally responsible for updating the view when the model changes (and similarly the model when the user updates the view). Since Backbone doesn't have its <strong>own</strong> explicit controllers, it's useful to review the controller from another MVC framework to appreciate the difference in implementations. Let's take a look at <a href="http://spinejs.com/">Spine.js</a>:</p>

      <p>In this example, we're going to have a controller called <code>TodoController</code> which would be in charge of individual todos in the application. It will ensure that when the view updates (e.g a user edited the todo) the corresponding model does too.</p>

      <p>(Note: We won't be delving heavily into Spine.js beyond this example, but it's worth looking at it to learn more about Javascript frameworks in general.)</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Controllers in Spine are created by inheriting from Spine.Controller</span>

      <span class="kd">var</span> <span class="nx">TodoController</span> <span class="o">=</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">sub</span><span class="p">({</span>
        <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">));</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// Handle templating</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-template'</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>In Spine, controllers are considered the glue for an application, adding and responding to DOM events, rendering templates and ensuring that views and models are kept in sync (which makes sense in the context of what we know to be a controller).</p>

      <p>What we're doing in the above example is setting up listeners in the <code>update</code> and <code>destroy</code> events using <code>render()</code> and <code>remove()</code>. When a todo entry gets updated, we re-render the view to reflect the changes to the todo title. Similarly, if the todo gets deleted from todo list, we remove it from the view. In case you were wondering about the <code>tmpl()</code> function in the code snippet: in the <code>render()</code> function, we're using this to render a JavaScript template called #todoTemplate which simply returns an HTML string used to replace the controller's current element.</p>

      <p>What this provides us with is a very lightweight, simple way to manage changes between the model and the view.</p>

      <p><strong>Backbone.js</strong></p>

      <p>Later on in this section we're going to revisit the differences between Backbone and traditional MVC, but for now let's focus on controllers.</p>

      <p>In Backbone, controller logic is shared between Backbone.View and Backbone.Router. Earlier releases of Backbone contained something called Backbone.Controller, but it was renamed to Router to clarify its role.</p>

      <p>A Router's main purpose is to translate URL requests into application states. It does that by mapping URLs to functions. When a user browses to the URL <a href="http://www.example.com/filter/completed">www.example.com/filter/completed</a>, a Router could be used to show just todos which are completed, and to define what application behavior should be run in response to that request. Routers <em>can</em> contain traditional controller responsibilities, such as binding the events between models and views, or rendering parts of the page. However, Backbone contributor Tim Branyen has pointed out that it's possible to get away without needing Backbone.Router at all for this, so a way to think about it using the Router paradigm is probably:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span> <span class="s2">"/filter/:name"</span><span class="o">:</span> <span class="s2">"setFilter"</span> <span class="p">},</span>
        <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"set filter: "</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-what-does-mvc-give-us" class="anchor" href="#what-does-mvc-give-us"><span class="octicon octicon-link"></span></a>What does MVC give us?</h2>

      <p>To summarize, the separation of concerns in MVC facilitates modularization of an application's functionality and enables:</p>

      <ul>
      <li>Easier overall maintenance. When updates need to be made to the application it is clear whether the changes are data-centric, meaning changes to models and possibly controllers, or merely visual, meaning changes to views.</li>
      <li>Decoupling models and views means that it's straight-forward to write unit tests for business logic</li>
      <li>Duplication of low-level model and controller code is eliminated across the application</li>
      <li>Depending on the size of the application and separation of roles, this modularity allows developers responsible for core logic and developers working on the user-interfaces to work simultaneously</li>
      </ul><h3>
      <a name="user-content-delving-deeper" class="anchor" href="#delving-deeper"><span class="octicon octicon-link"></span></a>Delving deeper</h3>

      <p>Right now, you likely have a basic understanding of what the MVC pattern provides, but for the curious, we'll explore it a little further.</p>

      <p>The GoF (Gang of Four) do not refer to MVC as a design pattern, but rather consider it a "set of classes to build a user interface". In their view, it's actually a variation of three other classical design patterns: the Observer (Pub/Sub), Strategy and Composite patterns. Depending on how MVC has been implemented in a framework, it may also use the Factory and Decorator patterns. I've covered some of these patterns in my other free book, JavaScript Design Patterns For Beginners if you would like to read into them further.</p>

      <p>As we've discussed, models represent application data, while views handle what the user is presented on screen. As such, MVC relies on Pub/Sub for some of its core communication (something that surprisingly isn't covered in many articles about the MVC pattern). When a model is changed it "publishes" to the rest of the application that it has been updated. The "subscriber"--generally a Controller--then updates the view accordingly. The observer-viewer nature of this relationship is what facilitates multiple views being attached to the same model.</p>

      <p>For developers interested in knowing more about the decoupled nature of MVC (once again, depending on the implementation), one of the goals of the pattern is to help define one-to-many relationships between a topic and its observers. When a topic changes, its observers are updated. Views and controllers have a slightly different relationship. Controllers facilitate views to respond to different user input and are an example of the Strategy pattern.</p>

      <h3>
      <a name="user-content-summary" class="anchor" href="#summary"><span class="octicon octicon-link"></span></a>Summary</h3>

      <p>Having reviewed the classical MVC pattern, you should now understand how it allows developers to cleanly separate concerns in an application. You should also now appreciate how JavaScript MVC frameworks may differ in their interpretation of MVC, and how they share some of the fundamental concepts of the original pattern.</p>

      <p>When reviewing a new JavaScript MVC/MV* framework, remember - it can be useful to step back and consider how it's opted to approach Models, Views, Controllers or other alternatives, as this can better help you grok how the framework expects to be used.</p>

      <h2>
      <a name="user-content-mvp" class="anchor" href="#mvp"><span class="octicon octicon-link"></span></a>MVP</h2>

      <p>Model-view-presenter (MVP) is a derivative of the MVC design pattern which focuses on improving presentation logic. It originated at a company named <a href="http://en.wikipedia.org/wiki/Taligent">Taligent</a> in the early 1990s while they were working on a model for a C++ CommonPoint environment. Whilst both MVC and MVP target the separation of concerns across multiple components, there are some fundamental differences between them.</p>

      <p>For the purposes of this summary we will focus on the version of MVP most suitable for web-based architectures.</p>

      <h3>
      <a name="user-content-models-views--presenters" class="anchor" href="#models-views--presenters"><span class="octicon octicon-link"></span></a>Models, Views &amp; Presenters</h3>

      <p>The P in MVP stands for presenter. It's a component which contains the user-interface business logic for the view. Unlike MVC, invocations from the view are delegated to the presenter, which are decoupled from the view and instead talk to it through an interface. This allows for all kinds of useful things such as being able to mock views in unit tests.</p>

      <p>The most common implementation of MVP is one which uses a Passive View (a view which is for all intents and purposes "dumb"), containing little to no logic. MVP models are almost identical to MVC models and handle application data. The presenter acts as a mediator which talks to both the view and model, however both of these are isolated from each other. They effectively bind models to views, a responsibility held by Controllers in MVC. Presenters are at the heart of the MVP pattern and as you can guess, incorporate the presentation logic behind views.</p>

      <p>Solicited by a view, presenters perform any work to do with user requests and pass data back to them. In this respect, they retrieve data, manipulate it and determine how the data should be displayed in the view. In some implementations, the presenter also interacts with a service layer to persist data (models). Models may trigger events but it's the presenter's role to subscribe to them so that it can update the view. In this passive architecture, we have no concept of direct data binding. Views expose setters which presenters can use to set data.</p>

      <p>The benefit of this change from MVC is that it increases the testability of your application and provides a more clean separation between the view and the model. This isn't however without its costs as the lack of data binding support in the pattern can often mean having to take care of this task separately.</p>

      <p>Although a common implementation of a <a href="http://martinfowler.com/eaaDev/PassiveScreen.html">Passive View</a> is for the view to implement an interface, there are variations on it, including the use of events which can decouple the View from the Presenter a little more. As we don't have the interface construct in JavaScript, we're using it more and more a protocol than an explicit interface here. It's technically still an API and it's probably fair for us to refer to it as an interface from that perspective.</p>

      <p>There is also a <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html">Supervising Controller</a> variation of MVP, which is closer to the MVC and <a href="http://en.wikipedia.org/wiki/Model_View_ViewModel">MVVM</a> patterns as it provides data-binding from the Model directly from the View. Key-value observing (KVO) plugins (such as Derick Bailey's Backbone.ModelBinding plugin) introduce this idea of a Supervising Controller to Backbone.</p>

      <h2>
      <a name="user-content-mvp-or-mvc" class="anchor" href="#mvp-or-mvc"><span class="octicon octicon-link"></span></a>MVP or MVC?</h2>

      <p>MVP is generally used most often in enterprise-level applications where it's necessary to reuse as much presentation logic as possible. Applications with very complex views and a great deal of user interaction may find that MVC doesn't quite fit the bill here as solving this problem may mean heavily relying on multiple controllers. In MVP, all of this complex logic can be encapsulated in a presenter, which can simplify maintenance greatly.</p>

      <p>As MVP views are defined through an interface and the interface is technically the only point of contact between the system and the view (other than a presenter), this pattern also allows developers to write presentation logic without needing to wait for designers to produce layouts and graphics for the application.</p>

      <p>Depending on the implementation, MVP may be more easy to automatically unit test than MVC. The reason often cited for this is that the presenter can be used as a complete mock of the user-interface and so it can be unit tested independent of other components. In my experience this really depends on the languages you are implementing MVP in (there's quite a difference between opting for MVP for a JavaScript project over one for say, ASP.NET).</p>

      <p>At the end of the day, the underlying concerns you may have with MVC will likely hold true for MVP given that the differences between them are mainly semantic. As long as you are cleanly separating concerns into models, views and controllers (or presenters) you should be achieving most of the same benefits regardless of the pattern you opt for.</p>

      <h2>
      <a name="user-content-mvc-mvp-and-backbonejs" class="anchor" href="#mvc-mvp-and-backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP and Backbone.js</h2>

      <p>There are very few, if any architectural JavaScript frameworks that claim to implement the MVC or MVP patterns in their classical form as many JavaScript developers don't view MVC and MVP as being mutually exclusive (we are actually more likely to see MVP strictly implemented when looking at web frameworks such as ASP.NET or GWT). This is because it's possible to have additional presenter/view logic in your application and yet still consider it a flavor of MVC.</p>

      <p>Backbone contributor <a href="http://ireneros.com/">Irene Ros</a> subscribes to this way of thinking as when she separates Backbone views out into their own distinct components, she needs something to actually assemble them for her. This could either be a controller route (such as a <code>Backbone.Router</code>, covered later in the book) or a callback in response to data being fetched.</p>

      <p>That said, some developers do however feel that Backbone.js better fits the description of MVP than it does MVC
      . Their view is that:</p>

      <ul>
      <li>The presenter in MVP better describes the <code>Backbone.View</code> (the layer between View templates and the data bound to it) than a controller does</li>
      <li>The model fits <code>Backbone.Model</code> (it isn't that different from the classical MVC "Model")</li>
      <li>The views best represent templates (e.g Handlebars/Mustache markup templates)</li>
      </ul><p>A response to this could be that the view can also just be a View (as per MVC) because Backbone is flexible enough to let it be used for multiple purposes. The V in MVC and the P in MVP can both be accomplished by <code>Backbone.View</code> because they're able to achieve two purposes: both rendering atomic components and assembling those components rendered by other views.</p>

      <p>We've also seen that in Backbone the responsibility of a controller is shared with both the Backbone.View and Backbone.Router and in the following example we can actually see that aspects of that are certainly true.</p>

      <p>Here, our Backbone <code>TodoView</code> uses the Observer pattern to 'subscribe' to changes to a View's model in the line <code>this.model.on('change',...)</code>. It also handles templating in the <code>render()</code> method, but unlike some other implementations, user interaction is also handled in the View (see <code>events</code>).</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// The DOM element for a todo item...</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="c1">//... is a list tag.</span>
        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Pass the contents of the todo template through a templating</span>
        <span class="c1">// function, cache it for a single todo</span>
        <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="c1">// The DOM events specific to an item.</span>
        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span>
        <span class="p">},</span>

        <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
        <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
        <span class="c1">// app, we set a direct reference on the model for convenience.</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// Toggle the `"completed"` state of the model.</span>
        <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
        <span class="p">},</span>
      <span class="p">});</span>
      </pre></div>

      <p>Another (quite different) opinion is that Backbone more closely resembles <a href="http://martinfowler.com/eaaDev/uiArchs.html#ModelViewController">Smalltalk-80 MVC</a>, which we went through earlier.</p>

      <p>As regular Backbone user Derick Bailey has <a href="http://lostechies.com/derickbailey/2011/12/23/backbone-js-is-not-an-mvc-framework/">written</a>, it's ultimately best not to force Backbone to fit any specific design patterns. Design patterns should be considered flexible guides to how applications may be structured and in this respect, Backbone doesn't fit either MVC nor MVP perfectly. Instead, it borrows some of the best concepts from multiple architectural patterns and creates a flexible framework that just works well. Call it <strong>the Backbone way</strong>, MV* or whatever helps reference its flavor of application architecture.</p>

      <p>It <em>is</em> however worth understanding where and why these concepts originated, so I hope that my explanations of MVC and MVP have been of help. Most structural JavaScript frameworks will adopt their own take on classical patterns, either intentionally or by accident, but the important thing is that they help us develop applications which are organized, clean and can be easily maintained.</p>

      <h2>
      <a name="user-content-fast-facts" class="anchor" href="#fast-facts"><span class="octicon octicon-link"></span></a>Fast facts</h2>

      <h3>
      <a name="user-content-backbonejs" class="anchor" href="#backbonejs"><span class="octicon octicon-link"></span></a>Backbone.js</h3>

      <ul>
      <li>Core components: Model, View, Collection, Router. Enforces its own flavor of MV*</li>
      <li>Good documentation, with more improvements on the way</li>
      <li>Used by large companies such as SoundCloud and Foursquare to build non-trivial applications</li>
      <li>Event-driven communication between views and models. As we'll see, it's relatively straight-forward to add event listeners to any attribute in a model, giving developers fine-grained control over what changes in the view</li>
      <li>Supports data bindings through manual events or a separate Key-value observing (KVO) library</li>
      <li>Great support for RESTful interfaces out of the box, so models can be easily tied to a backend</li>
      <li>Extensive eventing system. It's <a href="http://lostechies.com/derickbailey/2011/07/19/references-routing-and-the-event-aggregator-coordinating-views-in-backbone-js/">trivial</a> to add support for pub/sub in Backbone</li>
      <li>Prototypes are instantiated with the <code>new</code> keyword, which some developers prefer</li>
      <li>Agnostic about templating frameworks, however Underscore's micro-templating is available by default. Backbone works well with libraries like Handlebars</li>
      <li>Doesn't support deeply nested models, though there are Backbone plugins such as <a href="https://github.com/PaulUithol/Backbone-relational">this</a> which can help</li>
      <li>Clear and flexible conventions for structuring applications. Backbone doesn't force usage of all of its components and can work with only those needed.</li>
      </ul><h1>
      <a name="user-content-the-internals" class="anchor" href="#the-internals"><span class="octicon octicon-link"></span></a>The Internals</h1>

      <p>In this section, you'll learn the essentials of Backbone's models, views, collections and routers, as well as about using namespacing to organize your code. This isn't meant as a replacement for the official documentation, but it will help you understand many of the core concepts behind Backbone before you start building applications with it.</p>

      <ul>
      <li>Models</li>
      <li>Collections</li>
      <li>Routers</li>
      <li>Views</li>
      <li>Namespacing</li>
      </ul><h2>
      <a name="user-content-models-1" class="anchor" href="#models-1"><span class="octicon octicon-link"></span></a>Models</h2>

      <p>Backbone models contain interactive data for an application as well as the logic around this data. For example, we can use a model to represent the concept of a todo item including its attributes like title (todo content) and completed (current state of the todo).</p>

      <p>Models can be created by extending <code>Backbone.Model</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// We can then create our own concrete instance of a (Todo) model</span>
      <span class="c1">// with no values at all:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// or with some arbitrary data:</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the both model instances in the console.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-initialization" class="anchor" href="#initialization"><span class="octicon octicon-link"></span></a>Initialization</h4>

      <p>The <code>initialize()</code> method is called when a new instance of a model is created. Its use is optional, however you'll see why it's good practice to use it below.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      </pre></div>

      <p><strong>Default values</strong></p>

      <p>There are times when you want your model to have a set of default values (e.g. in a scenario where a complete set of data isn't provided by the user). This can be set using a property called <code>defaults</code> in your model.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Now we can create our concrete instance of the model </span>
      <span class="c1">// with default values as follows:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// Or we could instantiate it with some of the attributes (e.g with custom title):</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the logged models in the console.'</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>

      <span class="c1">// Or with all of the (default) attributes:</span>
      <span class="kd">var</span> <span class="nx">todo3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'This todo is done, so take no action on this one.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo3</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-getters--setters" class="anchor" href="#getters--setters"><span class="octicon octicon-link"></span></a>Getters &amp; Setters</h4>

      <p><strong>Model.get()</strong></p>

      <p><code>Model.get()</code> provides easy access to a model's attributes. All attributes, regardless if default ones or one passed through to the model on instantiation, are available for retrieval.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// empty string</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Retrieved with models get() method."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// Retrieved with models get() method.</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// true</span>
      </pre></div>

      <p>If you need to read or clone all of a model's data attributes use its <code>toJSON</code> method. Despite the name it doesn't return a JSON string but a copy of the attributes as an object. ("toJSON" is part of the JSON.stringify specification. Passing an object with a toJSON method makes it stringify the return value of that method instead of the object itself.)</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">todo1Attributes</span> <span class="o">=</span> <span class="nx">todo1</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="c1">// Following logs: {"title":"","completed":false} </span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1Attributes</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Try these examples and check results in console."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="c1">// logs: {"title":"Try examples and check results in console.","completed":true}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
      </pre></div>

      <p><strong>Model.set()</strong></p>

      <p><code>Model.set()</code> allows us to pass attributes into an instance of our model. Attributes can either be set during initialization or at any time afterwards. Backbone uses Model.set() to know when to broadcast that a model's data has changed.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Setting the value of attributes via instantiation</span>
      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Set through instantiation."</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set single attribute value at the time through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Title attribute set through Model.set()."</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set map of attributes through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Both attributes set through Model.set()."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <p><strong>Direct access</strong></p>

      <p>If you really need to access the attributes in a model's instance directly, there is <code>Model.attributes</code>. But remember it is best practice to use Model.get(), Model.set() or direct instantiation as explained above.</p>

      <h4>
      <a name="user-content-listening-for-changes-to-your-model" class="anchor" href="#listening-for-changes-to-your-model"><span class="octicon octicon-link"></span></a>Listening for changes to your model</h4>

      <p>Any and all of the attributes in a Backbone model can have listeners bound to them which detect when their values change. Listeners can be added to the <code>initialize()</code> function:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'- Values for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'On each change of attribute values listener is triggered.'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Listener is triggered for each change, not for change of the each attribute.'</span><span class="p">,</span>
        <span class="s1">'complete'</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      </pre></div>

      <p>In the following example, we log a message whenever a specific attribute (the title of our Todo model) is altered.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:title'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title value for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">},</span>
        <span class="nx">setTitle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="c1">// Following changes trigger the listener:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Check what\'s logged.'</span><span class="p">);</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="s1">'Go fishing on Sunday.'</span><span class="p">);</span>

      <span class="c1">// But, this change type is not observed, so no listener is triggered:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo set as completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <h4>
      <a name="user-content-validation" class="anchor" href="#validation"><span class="octicon octicon-link"></span></a>Validation</h4>

      <p>Backbone supports model validation through <code>Model.validate()</code>, which allows checking the attribute values for a model prior to them being set.</p>

      <p>Validation functions can be as simple or complex as necessary. If the attributes provided are valid, nothing should be returned from <code>.validate()</code>. If they are invalid, a custom error can be returned instead.</p>

      <p>A basic example for validation can be seen below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attribs</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">attribs</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
              <span class="k">return</span> <span class="s2">"Remember to set a title for your todo."</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="c1">// logs: Remember to set a title for your todo.</span>
      </pre></div>

      <p><strong>Note</strong>: Backbone passes the <code>attributes</code> object (attribs param in above example) by shallow copy to the <code>validate</code> function using the Underscore <code>_.extend</code> method. This means that it is not possible to change any Number, String or Boolean attribute but it <em>is</em> possible to change attributes of objects because they are passed by reference. As shallow copy doesn't copy objects by implicitly copying them, but rather, by reference, one can change the attributes on those objects.</p>

      <p>An example of this (by @fivetanley) is available <a href="http://jsfiddle.net/2NdDY/7/">here</a>.</p>

      <h2>
      <a name="user-content-views-1" class="anchor" href="#views-1"><span class="octicon octicon-link"></span></a>Views</h2>

      <p>Views in Backbone don't contain the markup for your application, but rather they are there to support models by defining the logic for how they should be represented to the user. This is usually achieved using JavaScript templating (e.g. Mustache, jQuery-tmpl, etc.). A view's <code>render()</code> function can be bound to a model's <code>change()</code> event, allowing the view to always be up to date without requiring a full page refresh.</p>

      <h4>
      <a name="user-content-creating-new-views" class="anchor" href="#creating-new-views"><span class="octicon octicon-link"></span></a>Creating new views</h4>

      <p>Similar to the previous sections, creating a new view is relatively straight-forward. To create a new View, simply extend <code>Backbone.View</code>. I'll explain this code in detail below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Cache the template function for a single item.</span>
        <span class="nx">todoTpl</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
          <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
          <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoTpl</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo label is double clicked</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo loses focus</span>
        <span class="p">},</span>

        <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// executed on each keypress when in todo edit mode, </span>
          <span class="c1">// but we'll wait for enter to get in action</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">();</span>

      <span class="c1">// logs reference to a DOM element that cooresponds to the view instance</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-what-is-el" class="anchor" href="#what-is-el"><span class="octicon octicon-link"></span></a>What is <code>el</code>?</h4>

      <p><code>el</code> is basically a reference to a DOM element and all views must have one. It allows for all of the contents of a view to be inserted into the DOM at once, which makes for faster rendering because the browser performs the minimum required reflows and repaints.</p>

      <p>There are two ways to attach a DOM element to a view: a new element is created for the view and added manually by the developer or the element already exists in the page.</p>

      <p>If you want to create a new element for your view, set any combination of the following view's properties: <code>tagName</code>, <code>id</code> and <code>className</code>. A new element will be created for you by the framework and a reference to it will be available at the <code>el</code> property. If nothing is specified <code>el</code> defaults to <code>div</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'ul'</span><span class="p">,</span> <span class="c1">// required, but defaults to 'div' if not set</span>
        <span class="nx">className</span><span class="o">:</span> <span class="s1">'container'</span><span class="p">,</span> <span class="c1">// optional, you can assign multiple classes to this property like so 'container homepage'</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">'todos'</span><span class="p">,</span> <span class="c1">// optional</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todosView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosView</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todosView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre></div>

      <p>The above code creates the <code>DOMElement</code> below but doesn't append it to the DOM.</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todos"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;&lt;/ul&gt;</span>
      </pre></div>

      <p>If the element already exists in the page, you can set <code>el</code> as a CSS selector that matches the element.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">el</span><span class="o">:</span> <span class="s1">'#footer'</span>
      </pre></div>

      <p><strong>Understanding <code>render()</code></strong></p>

      <p><code>render()</code> is an optional function that defines the logic for rendering a template. We'll use Underscore's micro-templating in these examples, but remember you can use other templating frameworks if you prefer.</p>

      <p>The <code>_.template</code> method in Underscore compiles JavaScript templates into functions which can be evaluated for rendering. In the above view, I'm passing the markup from a template with id <code>item-template</code> to <code>_.template()</code> to be compiled. Next, I set the html of the <code>el</code> DOM element to the output of processing a JSON version of the model associated with the view through the compiled template.</p>

      <p>Presto! This populates the template, giving you a data-complete set of markup in just a few short lines of code.</p>

      <p><strong>The <code>events</code> attribute</strong></p>

      <p>The Backbone <code>events</code> attribute allows us to attach event listeners to either custom selectors, or directly to <code>el</code> if no selector is provided. An event takes the form <code>{'eventName selector': 'callbackFunction'}</code> and a number of DOM event-types are supported, including <code>click</code>, <code>submit</code>, <code>mouseover</code>, <code>dblclick</code> and more.</p>

      <p>What isn't instantly obvious is that under the bonnet, Backbone uses jQuery's <code>.delegate()</code> to provide instant support for event delegation but goes a little further, extending it so that <code>this</code> always refers to the current view object. The only thing to really keep in mind is that any string callback supplied to the events attribute must have a corresponding function with the same name within the scope of your view.</p>

      <h2>
      <a name="user-content-collections" class="anchor" href="#collections"><span class="octicon octicon-link"></span></a>Collections</h2>

      <p>Collections are sets of Models and are created by extending <code>Backbone.Collection</code>.</p>

      <p>Normally, when creating a collection you'll also want to pass through a property specifying the model that your collection will contain, as well as any instance properties required.</p>

      <p>In the following example, we create a TodoCollection that will contain our Todo models:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read the whole book'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>

      <span class="c1">// pass array of models on collection instantiation</span>
      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">myTodo</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="c1">// Collection's convenience method used to create </span>
      <span class="c1">// new model instance within collection itself.</span>
      <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">48</span><span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p><strong>Getters and Setters</strong></p>

      <p>There are a few different ways to retrieve a model from a collection. The most straight-forward is to use <code>Collection.get()</code> which accepts a single id as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// extends on previous example</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

      <span class="c1">// Models, as objects, are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre></div>

      <p>Internally <code>Backbone.Collection</code> sets an array of models enumerated by their <code>id</code> property, if model instances happen to have one. Once <code>collection.get(id)</code> is called this array is checked for existence of the model instance with the corresponding <code>id</code>.</p>

      <p>Sometimes you may also want to get a model based on its client id. The client id is a property that Backbone automatically assigns models that have not yet been saved. You can get a model's client id from its <code>.cid</code> property.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// extends on previous examples</span>

      <span class="kd">var</span> <span class="nx">todoCid</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">cid</span><span class="p">);</span>

      <span class="c1">// As mentioned in previous example, </span>
      <span class="c1">// models are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre></div>

      <p>Backbone Collections don't have setters as such, but do support adding new models via <code>.add()</code> and removing models via <code>.remove()</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Jamaica.'</span><span class="p">}),</span>
          <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to China.'</span><span class="p">}),</span>
          <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Disneyland.'</span><span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p><strong>Listening for events</strong></p>

      <p>As collections represent a group of items, we're also able to listen for <code>add</code> and <code>remove</code> events for when new models are added or removed from the collection. Here's an example:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I should "</span> <span class="o">+</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">". Have I done it before? "</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"completed"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'Yeah!'</span><span class="o">:</span> <span class="s1">'Not.'</span> <span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>
      </pre></div>

      <p>In addition, we're able to bind a <code>change</code> event to listen for changes to models in the collection.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"change:title"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Changed my mind where I should go, "</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'go fishing'</span><span class="p">);</span>
      </pre></div>

      <p><strong>Fetching models from the server</strong></p>

      <p><code>Collections.fetch()</code> retrieves a default set of models from the server in the form of a JSON array. When this data returns, the current collection's contents will be replaced with the contents of the array.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'/todos'</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
      </pre></div>

      <p>During configuration, Backbone sets a variable to denote if extended HTTP methods are supported by the server. Another setting controls if the server understands the correct MIME type for JSON:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre></div>

      <p>The Backbone.sync method that uses these values is actually an integral part of Backbone.js. A jQuery-like ajax method is assumed, so HTTP parameters are organised based on jQuery’s API. Searching through the code for calls to the sync method show it’s used whenever a model is saved, fetched, or deleted (destroyed).</p>

      <p>Under the covers, <code>Backbone.sync</code> is the function called every time Backbone tries to read or save models to the server. It uses jQuery or Zepto's ajax implementations to make these RESTful requests, however this can be overridden as per your needs.</p>

      <p>The sync function may be overriden globally as Backbone.sync, or at a finer-grained level, by adding a sync function to a Backbone collection or to an individual model.</p>

      <p>There’s no fancy plugin API for adding a persistence layer – simply override Backbone.sync with the same function signature:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">};</span>
      </pre></div>

      <p>The default methodMap is useful for working out what the method argument does:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">methodMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'create'</span><span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'update'</span><span class="o">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'delete'</span><span class="o">:</span> <span class="s1">'DELETE'</span><span class="p">,</span>
        <span class="s1">'read'</span><span class="o">:</span>   <span class="s1">'GET'</span>
      <span class="p">};</span>
      </pre></div>

      <p>In the above example if we wanted to log an event when <code>.sync()</code> was called, we could do this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">id_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I've been passed "</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s2">" with "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">'create'</span><span class="p">){</span> <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">id_counter</span><span class="o">++</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">};</span>
      </pre></div>

      <p><strong>Resetting/Refreshing Collections</strong></p>

      <p>Rather than adding or removing models individually, you might occasionally wish to update an entire collection at once. <code>Collection.reset()</code> allows us to replace an entire collection with new models as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">reset</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Cuba.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
      <span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p>Note that using <code>Collection.reset()</code> doesn't fire any <code>add</code> or <code>remove</code> events. A <code>reset</code> event is fired instead as shown in example.</p>

      <h3>
      <a name="user-content-underscore-utility-functions" class="anchor" href="#underscore-utility-functions"><span class="octicon octicon-link"></span></a>Underscore utility functions</h3>

      <p>As Backbone requires Underscore as a hard dependency, we're able to use many of the utilities it has to offer to aid with our application development. Here's an example of how Underscore's <code>forEach</code> method that can be used for iterating over collection and <code>sortBy()</code> method that can be used to sort a collection of todos based on a particular attribute.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Belgium.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Austria.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">sortedByAlphabet</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">sortBy</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"- Now sorted: "</span><span class="p">);</span>

      <span class="nx">sortedByAlphabet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>
      </pre></div>

      <p>The complete list of what Underscore can do is beyond the scope of this guide, but can be found in its official <a href="http://documentcloud.github.com/underscore/">docs</a>.</p>

      <h3>
      <a name="user-content-chainable-api" class="anchor" href="#chainable-api"><span class="octicon octicon-link"></span></a>Chainable API</h3>

      <p>Speaking of utility methods, another bit of sugar in Backbone is the support for Underscore’s chain method. This works by calling the original method with the current array of models and returning the result. In case you haven’t seen it before, the chainable API looks like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Tim'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Ida'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">26</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Rob'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">55</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">filteredNames</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">chain</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">value</span><span class="p">();</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filteredNames</span><span class="p">);</span> <span class="c1">// logs: ['Ida', 'Rob']</span>
      </pre></div>

      <p>Some of the Backbone-specific methods will return this, which means they can be chained as well:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">collection</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">23</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Harry'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">33</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">41</span> <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">names</span><span class="p">);</span> <span class="c1">// logs: ['John', 'Harry', 'Steve']</span>
      </pre></div>

      <h2>
      <a name="user-content-events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h2>

      <p>As we've covered, <code>Backbone.Events</code> is mixed into the other Backbone "classes", including:</p>

      <ul>
      <li>Backbone.Model</li>
      <li>Backbone.Collection</li>
      <li>Backbone.Router</li>
      <li>Backbone.History</li>
      <li>Backbone.View</li>
      </ul><p>Events are the standard way to deal with user interface actions, through the declarative event bindings on views, and also model and collection changes. Mastering events is one of the quickest ways to become more productive with Backbone.</p>

      <p><code>Backbone.Events</code> also has the ability to give any object a way to bind and trigger custom events. We can mix this module into any object easily and there isn't a requirement for events to be declared prior to them being bound.</p>

      <p>Example:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="c1">// Add a custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'We triggered '</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// Trigger the custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="s1">'our event'</span><span class="p">);</span>
      </pre></div>

      <p>If you're familiar with jQuery custom events or the concept of Publish/Subscribe, <code>Backbone.Events</code> provides a system that is very similar with <code>on</code> being analogous to <code>subscribe</code> and <code>trigger</code> being similar to <code>publish</code>.</p>

      <p><code>on</code> basically allows us to bind a callback function to any object, as we've done with <code>dance</code> in the above example. Whenever the event is fired, our callback is invoked.</p>

      <p>The official Backbone.js documentation recommends namespacing event names using colons if you end up using quite a few of these on your page. e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// This one triggers nothing as no listener listens for it</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p>A special <code>all</code> event is made available in case you would like an event to be triggered when any event occurs (e.g if you would like to screen events in a single location). The <code>all</code> event can be used as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"all"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"The name of the event passed was "</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// This time each event will be catched with catch 'all' event listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p><code>off</code> allows us to remove a callback function that has previously been bound from an object. Going back to our Publish/Subscribe comparison, think of it as an <code>unsubscribe</code> for custom events.</p>

      <p>To remove the <code>dance</code> event we previously bound to <code>ourObject</code>, we would simply do:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We  "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events. Each will be catched and acted upon.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"started tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"started break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes event bound to the object</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events again, but one is logged.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"stopped tap dancing."</span><span class="p">);</span> <span class="c1">// won't be logged as its not listened for</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p>To remove all callbacks for the event we should just pass event name (e.g <code>move</code>) to <code>off()</code> function of the object event is bound to. If we wish to remove just a callback by a specific name, we can pass callback name as second parameter:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are dancing. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">jumping</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are jumping. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add two listeners to the same event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">jumping</span><span class="p">);</span>

      <span class="c1">// Trigger the events. Both listeners are called.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes specified listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the events again. One listener left.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah, jump, jump!"</span><span class="p">);</span>
      </pre></div>

      <p>Finally, <code>trigger</code> triggers a callback for a specified event (or a space-separated list of events). e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s1">'just dancing.'</span><span class="p">);</span>

      <span class="c1">// Multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="s1">'very tired from so much action.'</span><span class="p">);</span>
      </pre></div>

      <p>It is also possible to pass along additional arguments to each (or all) of these events via a second argument supported by <code>trigger</code>. e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">actionObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">action</span> <span class="o">+</span> <span class="s1">' for '</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">duration</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Passing multiple arguments to single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"5 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'dancing'</span><span class="p">});</span>

      <span class="c1">// Passing multiple arguments to multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"15 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'on fire'</span><span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-routers" class="anchor" href="#routers"><span class="octicon octicon-link"></span></a>Routers</h2>

      <p>In Backbone, routers are used to help manage application state and for connecting URLs to application events. This is achieved using hash-tags with URL fragments, or using the browser's pushState and History API. Some examples of routes may be seen below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#about</span>
      <span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#search/seasonal-horns/page2</span>
      </pre></div>

      <p>Note: An application will usually have at least one route mapping a URL route to a function that determines what happens when a  user reaches that particular route. This relationship is defined as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="s1">'route'</span> <span class="o">:</span> <span class="s1">'mappedFunction'</span>
      </pre></div>

      <p>Let us now define our first controller by extending <code>Backbone.Router</code>. For the purposes of this guide, we're going to continue pretending we're creating a complex todo application (something like personal organize/planner) that requires a complex TodoRouter.</p>

      <p>Note the inline comments in the code example below as they continue the rest of the lesson on routers.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="cm">/* define the route and function maps for this router */</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
              <span class="cm">/* Sample usage: http://example.com/#about */</span>

              <span class="s2">"todo/:id"</span> <span class="o">:</span> <span class="s2">"getTodo"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a ":param" variable which allows us to match</span>
      <span class="cm">        any of the components between two URL slashes */</span>
              <span class="cm">/* Sample usage: http://example.com/#todo/5 */</span>

              <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* We can also define multiple routes that are bound to the same map function,</span>
      <span class="cm">        in this case searchTodos(). Note below how we're optionally passing in a</span>
      <span class="cm">        reference to a page number if one is supplied */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job */</span>

              <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* As we can see, URLs may contain as many ":param"s as we wish */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job/p1 */</span>

              <span class="s2">"todos/:id/download/*documentPath"</span> <span class="o">:</span> <span class="s2">"downloadDocument"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a *splat. splats are able to match any number of</span>
      <span class="cm">        URL components and can be combined with ":param"s*/</span>
              <span class="cm">/* Sample usage: http://example.com/#todos/5/download/files/Meeting_schedule.doc */</span>

              <span class="cm">/* If you wish to use splats for anything beyond default routing, it's probably a good</span>
      <span class="cm">        idea to leave them at the end of a URL otherwise you may need to apply regular</span>
      <span class="cm">        expression parsing on your fragment */</span>

              <span class="s2">"*other"</span>    <span class="o">:</span> <span class="s2">"defaultRoute"</span>
              <span class="cm">/* This is a default route that also uses a *splat. Consider the</span>
      <span class="cm">        default route a wildcard for URLs that are either not matched or where</span>
      <span class="cm">        the user has incorrectly typed in a route path manually */</span>
              <span class="cm">/* Sample usage: http://example.com/# &lt;anything */</span>
          <span class="p">},</span>

          <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="p">},</span>

          <span class="nx">getTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
              <span class="cm">/*</span>
      <span class="cm">        Note that the id matched in the above route will be passed to this function</span>
      <span class="cm">        */</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"You are trying to reach todo "</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">downloadDocument</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">path</span><span class="p">){</span>
          <span class="p">},</span>

          <span class="nx">defaultRoute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Invalid. You attempted to reach:'</span> <span class="o">+</span> <span class="nx">other</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="cm">/* Now that we have a router setup, remember to instantiate it */</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
      </pre></div>

      <p>As of Backbone 0.5+, it's possible to opt-in for HTML5 pushState support via <code>window.history.pushState</code>. This permits you to define routes such as <a href="http://www.scriptjunkie.com/just/an/example">http://www.scriptjunkie.com/just/an/example</a>. This will be supported with automatic degradation when a user's browser doesn't support pushState. For the purposes of this tutorial, we'll use the hashtag method.</p>

      <h4>
      <a name="user-content-is-there-a-limit-to-the-number-of-routers-i-should-be-using" class="anchor" href="#is-there-a-limit-to-the-number-of-routers-i-should-be-using"><span class="octicon octicon-link"></span></a>Is there a limit to the number of routers I should be using?</h4>

      <p>Andrew de Andrade has pointed out that DocumentCloud themselves usually only use a single router in most of their applications. You're very likely to not require more than one or two routers in your own projects as the majority of your application routing can be kept organized in a single controller without it getting unwieldy.</p>

      <h4>
      <a name="user-content-backbonehistory" class="anchor" href="#backbonehistory"><span class="octicon octicon-link"></span></a>Backbone.history</h4>

      <p>Next, we need to initialize <code>Backbone.history</code> as it handles <code>hashchange</code> events in our application. This will automatically handle routes that have been defined and trigger callbacks when they've been accessed.</p>

      <p>The <code>Backbone.history.start()</code> method will simply tell Backbone that it's OK to begin monitoring all <code>hashchange</code> events as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="cm">/* define the route and function maps for this router */</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
          <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
          <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span>
        <span class="p">},</span>

        <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>

        <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to and check console:</span>
      <span class="c1">// http://localhost/#search/job/p3 logs: Page number: 3 of the results for todos containing the word: job</span>
      <span class="c1">// http://localhost/#search/job logs: Page number: 1 of the results for todos containing the word: job </span>
      <span class="c1">// etc.</span>
      </pre></div>

      <p>Note: To test last example you should set site for testing in local development environment which is out of scope of this book.</p>

      <p>As an aside, if you would like to save application state to the URL at a particular point you can use the <code>.navigate()</code> method to achieve this. It simply updates your URL fragment without the need to trigger the <code>hashchange</code> event:</p>

      <div class="highlight highlight-javascript"><pre><span class="cm">/* Lets imagine we would like a specific fragment (edit) once a user opens single todo */</span>
      <span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">);</span> <span class="c1">// updates the fragment for us, but doesn't trigger the route</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but editTodo() function is not invoked even though location we end up is mapped to it.</span>
      <span class="c1">//</span>
      <span class="c1">// logs: View todo requested.</span>
      </pre></div>

      <p>It is also possible for <code>Router.navigate()</code> to trigger the route as well as update the URL fragment.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// updates the fragment and triggers the route as well</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but this time editTodo() function is invoked.</span>
      <span class="c1">// </span>
      <span class="c1">// logs: </span>
      <span class="c1">// View todo requested.</span>
      <span class="c1">// Edit todo openned. </span>
      </pre></div>

      <h3>
      <a name="user-content-backbones-sync-api" class="anchor" href="#backbones-sync-api"><span class="octicon octicon-link"></span></a>Backbone’s Sync API</h3>

      <p>The Backbone.sync method is intended to be overridden to support other backends. The built-in method is tailored to a certain breed of RESTful JSON APIs – Backbone was originally extracted from a Ruby on Rails application, which uses HTTP methods like PUT the same way.</p>

      <p>The way this works is the model and collection classes have a sync method that calls Backbone.sync. Both will call this.sync internally when fetching, saving, or deleting items.</p>

      <p>The sync method is called with three parameters:</p>

      <ul>
      <li>method: One of create, update, delete, read</li>
      <li>model: The Backbone model object</li>
      <li>options: May include success and error methods</li>
      </ul><p>Implementing a new sync method can use the following pattern:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">requestContent</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">'create'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'read'</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
      </pre></div>

      <p>This pattern delegates API calls to a new object, which could be a Backbone-style class that supports events. This can be safely tested separately, and potentially used with libraries other than Backbone.</p>

      <p>There are quite a few sync implementations out there:</p>

      <ul>
      <li>Backbone localStorage</li>
      <li>Backbone offline</li>
      <li>Backbone Redis</li>
      <li>backbone-parse</li>
      <li>backbone-websql</li>
      <li>Backbone Caching Sync</li>
      </ul><h3>
      <a name="user-content-conflict-management" class="anchor" href="#conflict-management"><span class="octicon octicon-link"></span></a>Conflict Management</h3>

      <p>Like most client-side projects, Backbone.js wraps everything in an immediately-invoked function expression:</p>

      <div class="highlight highlight-javascript"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// Backbone.js</span>
      <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      </pre></div>

      <p>Several things happen during this configuration stage. A Backbone “namespace” is created, and multiple versions of Backbone on the same page are supported through the noConflict mode:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">previousBackbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">;</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">previousBackbone</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">};</span>
      </pre></div>

      <p>Multiple versions of Backbone can be used on the same page by calling noConflict like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Backbone19</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="c1">// Backbone19 refers to the most recently loaded version,</span>
      <span class="c1">// and `window.Backbone` will be restored to the previously</span>
      <span class="c1">// loaded version</span>
      </pre></div>

      <p>This initial configuration code also supports CommonJS modules so Backbone can be used in Node projects:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Backbone</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      </pre></div>

      <h2>
      <a name="user-content-inheritance--mixins" class="anchor" href="#inheritance--mixins"><span class="octicon octicon-link"></span></a>Inheritance &amp; Mixins</h2>

      <p>For its inheritance, Backbone internally uses an <code>inherits</code> function inspired by <code>goog.inherits</code>, Google’s implementation from the Closure Library. It's basically a function to correctly setup the prototype chain.</p>

      <div class="highlight highlight-javascript"><pre> <span class="kd">var</span> <span class="nx">inherits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
      </pre></div>

      <p>The only major difference here is that Backbone’s API accepts two objects containing “instance” and “static” methods.</p>

      <p>Following on from this, for inheritance purposes all of Backbone's objects contain an <code>extend</code> method as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">View</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">;</span>
      </pre></div>

      <p>Most development with Backbone is based around inheriting from these objects, and they’re designed to mimic a classical object-oriented implementation.</p>

      <p>If this sounds familiar, it's because <code>extend</code> is an Underscore.js utility, although Backbone itself does a lot more with this. See below for Underscore's <code>extend</code>:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
      </pre></div>

      <p>The above isn’t quite the same as ES5’s <code>Object.create</code>, as it’s actually copying properties (methods and values) from one object to another. As this isn’t enough to support Backbone’s inheritance and class model, the following steps are performed:</p>

      <ul>
      <li>The instance methods are checked to see if there’s a constructor property. If so, the class’s constructor is used, otherwise the parent’s constructor is used (i.e., Backbone.Model)</li>
      <li>Underscore’s extend method is called to add the parent class’s methods to the new child class</li>
      <li>The <code>prototype</code> property of a blank constructor function is assigned with the parent’s prototype, and a new instance of this is set to the child’s <code>prototype</code> property
      Underscore’s extend method is called twice to add the static and instance methods to the child class</li>
      <li>The child’s prototype’s constructor and a <code>__super__</code> property are assigned</li>
      <li>This pattern is also used for classes in CoffeeScript, so Backbone classes are compatible with CoffeeScript classes.</li>
      </ul><p><code>extend</code> can be used for a great deal more and developers who are fans of mixins will like that it can be used for this too. You can define functionality on any custom object, and then quite literally copy &amp; paste all of the methods and attributes from that object to a Backbone one:</p>

      <p>For example:</p>

      <div class="highlight highlight-javascript"><pre> <span class="kd">var</span> <span class="nx">MyMixin</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">,</span>
        <span class="nx">sayFoo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
       <span class="c1">// ...</span>
      <span class="p">});</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">MyView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">MyMixin</span><span class="p">);</span>

      <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">();</span>
      <span class="nx">myView</span><span class="p">.</span><span class="nx">sayFoo</span><span class="p">();</span> <span class="c1">//=&gt; 'bar'</span>
      </pre></div>

      <p>We can take this further and also apply it to View inheritance. The following is an example of how to extend one View using another:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>
      </pre></div>

      <p>However, if you have an <code>initialize()</code> method in Panel, then it won't be called if you also have an <code>initialize()</code> method in PanelAdvanced, so you would have to call Panel's initialize method explicitly:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span> <span class="c1">// Log: bar</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="k">new</span> <span class="nx">Panel</span><span class="p">();</span>
      <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span>
      </pre></div>

      <p>This isn't the most elegant of solutions because if you have a lot of Views that inherit from Panel, then you'll have to remember to call Panel's initialize from all of them.</p>

      <p>It's worth noting that if Panel doesn't have an initialize method now but you choose to add it in the future, then you'll need to go to all of the inherited classes in the future and make sure they call Panel's initialize.</p>

      <p>So here's an alternative way to define Panel so that your inherited views don't need to call Panel's initialize method:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's initialization code here</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Panel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's methods here. For example:</span>
        <span class="nx">sayHi</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello from Panel'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>

      <span class="c1">// other classes then inherit from Panel like this:</span>
      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span> <span class="c1">//Logs: Panel initialized, PanelAdvanced initialized, bar</span>
      <span class="nx">PanelAdvanced</span><span class="p">.</span><span class="nx">sayHi</span><span class="p">();</span> <span class="c1">// Logs: hello from Panel</span>
      </pre></div>

      <p>When used appropriately, Backbone's <code>extend</code> method can save a great deal of time and effort writing redundant code.</p>

      <p>(Thanks to <a href="http://dailyjs.com">Alex Young</a>, <a href="http://stackoverflow.com/users/93448/derick-bailey">Derick Bailey</a> and <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for the heads up about these tips).</p>

      <h4>
      <a name="user-content-backbone-super" class="anchor" href="#backbone-super"><span class="octicon octicon-link"></span></a>Backbone-Super</h4>

      <p><a href="https://github.com/lukasolson/Backbone-Super">Backbone-Super</a> by Lukas Olson adds a <em>_super</em> method to <em>Backbone.Model</em> using <a href="http://ejohn.org/blog/simple-javascript-inheritance/">John Resig’s Inheritance script</a>.
      Rather than using Backbone.Model.prototype.set.call as per the Backbone.js documentation, _super can be called instead:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// This is how we normally do it</span>
      <span class="kd">var</span> <span class="nx">OldFashionedNote</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>After including this plugin, you can do the same thing with the following syntax:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// This is how we can do it after using the Backbone-super plugin</span>
      <span class="kd">var</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-namespacing" class="anchor" href="#namespacing"><span class="octicon octicon-link"></span></a>Namespacing</h2>

      <p>When learning how to use Backbone, an important and commonly overlooked area by tutorials is namespacing. If you already have experience with namespacing in JavaScript, the following section will provide some advice on how to specifically apply concepts you know to Backbone, however I will also be covering explanations for beginners to ensure everyone is on the same page.</p>

      <h4>
      <a name="user-content-what-is-namespacing" class="anchor" href="#what-is-namespacing"><span class="octicon octicon-link"></span></a>What is namespacing?</h4>

      <p>The basic idea around namespacing is to avoid collisions with other objects or variables in the global namespace. They're important as it's best to safeguard your code from breaking in the event of another script on the page using the same variable names as you are. As a good 'citizen' of the global namespace, it's also imperative that you do your best to similarly not prevent other developer's scripts executing due to the same issues.</p>

      <p>JavaScript doesn't really have built-in support for namespaces like other languages, however it does have closures which can be used to achieve a similar effect.</p>

      <p>In this section we'll be taking a look shortly at some examples of how you can namespace your models, views, routers and other components specifically. The patterns we'll be examining are:</p>

      <ul>
      <li>Single global variables</li>
      <li>Object Literals</li>
      <li>Nested namespacing</li>
      </ul><p><strong>Single global variables</strong></p>

      <p>One popular pattern for namespacing in JavaScript is opting for a single global variable as your primary object of reference. A skeleton implementation of this where we return an object with functions and properties can be found below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="kd">function</span><span class="p">(){</span>
            <span class="c1">// ...</span>
          <span class="p">},</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="c1">// ...</span>
          <span class="p">}</span>
      <span class="p">})();</span>
      </pre></div>

      <p>You've probably seen this technique before. A Backbone-specific example might look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myViews</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">TodoView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">TodosView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">AboutView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">});</span>
              <span class="c1">//etc.</span>
          <span class="p">};</span>
      <span class="p">})();</span>
      </pre></div>

      <p>Here we can return a set of views, but the same technique could return an entire collection of models, views and routers depending on how you decide to structure your application. Although this works for certain situations, the biggest challenge with the single global variable pattern is ensuring that no one else has used the same global variable name as you have in the page.</p>

      <p>One solution to this problem, as mentioned by Peter Michaux, is to use prefix namespacing. It's a simple concept at heart, but the idea is you select a common prefix name (in this example, <code>myApplication_</code>) and then define any methods, variables or other objects after the prefix.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myApplication_todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({}),</span>
          <span class="nx">myApplication_todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>This is effective from the perspective of trying to lower the chances of a particular variable existing in the global scope, but remember that a uniquely named object can have the same effect. This aside, the biggest issue with the pattern is that it can result in a large number of global objects once your application starts to grow.</p>

      <p>For more on Peter's views about the single global variable pattern, read his <a href="http://michaux.ca/articles/javascript-namespacing">excellent post on them</a>.</p>

      <p>Note: There are several other variations on the single global variable pattern out in the wild, however having reviewed quite a few, I felt the prefixing approach applied best to Backbone.</p>

      <p><strong>Object Literals</strong></p>

      <p>Object Literals have the advantage of not polluting the global namespace but assist in organizing code and parameters logically. They're beneficial if you wish to create easily readable structures that can be expanded to support deep nesting. Unlike simple global variables, Object Literals often also take into account tests for the existence of a variable by the same name, which helps reduce the chances of collision.</p>

      <p>This example demonstrates two ways you can check to see if a namespace already exists before defining it. I commonly use Option 2.</p>

      <div class="highlight highlight-javascript"><pre><span class="cm">/* Doesn't check for existence of myApplication */</span>
      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="cm">/*</span>
      <span class="cm">Does check for existence. If already defined, we use that instance.</span>
      <span class="cm">Option 1:   if(!myApplication) myApplication = {};</span>
      <span class="cm">Option 2:   var myApplication = myApplication || {};</span>
      <span class="cm">We can then populate our object literal to support models, views and collections (or any data, really):</span>
      <span class="cm">*/</span>

      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">models</span> <span class="o">:</span> <span class="p">{},</span>
          <span class="nx">views</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">pages</span> <span class="o">:</span> <span class="p">{}</span>
          <span class="p">},</span>
          <span class="nx">collections</span> <span class="o">:</span> <span class="p">{}</span>
      <span class="p">};</span>
      </pre></div>

      <p>One can also opt for adding properties directly to the namespace (such as your views, in the following example):</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myTodosViews</span> <span class="o">=</span> <span class="nx">myTodosViews</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>The benefit of this pattern is that you're able to easily encapsulate all of your models, views, routers etc. in a way that clearly separates them and provides a solid foundation for extending your code.</p>

      <p>This pattern has a number of benefits. It's often a good idea to decouple the default configuration for your application into a single area that can be easily modified without the need to search through your entire codebase just to alter it. Here's an example of a hypothetical object literal that stores application configuration settings:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">language</span><span class="o">:</span> <span class="s1">'english'</span><span class="p">,</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">enableDelegation</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">maxTodos</span><span class="o">:</span> <span class="mi">40</span>
        <span class="p">},</span>
        <span class="nx">theme</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">skin</span><span class="o">:</span> <span class="s1">'a'</span><span class="p">,</span>
          <span class="nx">toolbars</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">index</span><span class="o">:</span> <span class="s1">'ui-navigation-toolbar'</span><span class="p">,</span>
            <span class="nx">pages</span><span class="o">:</span> <span class="s1">'ui-custom-toolbar'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>Note that there are really only minor syntactical differences between the Object Literal pattern and a standard JSON data set. If for any reason you wish to use JSON for storing your configurations instead (e.g. for simpler storage when sending to the back-end), feel free to.</p>

      <p>For more on the Object Literal pattern, I recommend reading Rebecca Murphey's <a href="http://rmurphey.com/blog/2009/10/15/using-objects-to-organize-your-code">excellent article on the topic</a>.</p>

      <p><strong>Nested namespacing</strong></p>

      <p>An extension of the Object Literal pattern is nested namespacing. It's another common pattern used that offers a lower risk of collision due to the fact that even if a top-level namespace already exists, it's unlikely the same nested children do. For example, Yahoo's YUI uses the nested object namespacing pattern extensively:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">YAHOO</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Dom</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
      </pre></div>

      <p>Yahoo's YUI uses the nested object namespacing pattern regularly and even DocumentCloud (the creators of Backbone) use the nested namespacing pattern in their main applications. A sample implementation of nested namespacing with Backbone may look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">todoApp</span> <span class="o">=</span>  <span class="nx">todoApp</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// perform similar check for nested children</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// routers</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">Workspace</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">TodoSearch</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Todo</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Notes</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// special models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span><span class="p">.</span><span class="nx">Admin</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>This is readable, clearly organized, and is a relatively safe way of namespacing your Backbone application. The only real caveat however is that it requires your browser's JavaScript engine to first locate the galleryApp object, then dig down until it gets to the function you're calling. However, developers such as Juriy Zaytsev (kangax) have tested and found the performance differences between single object namespacing vs the 'nested' approach to be quite negligible.</p>

      <p><strong>Recommendation</strong></p>

      <p>Reviewing the namespace patterns above, the option that I prefer when writing Backbone applications is nested object namespacing with the object literal pattern.</p>

      <p>Single global variables may work fine for applications that are relatively trivial. However, larger codebases requiring both namespaces and deep sub-namespaces require a succinct solution that's both readable and scalable. I feel this pattern achieves both of these objectives and is a good choice for most Backbone development.</p>

      <h1>
      <a name="user-content-practical-todos---your-first-backbonejs-app" class="anchor" href="#practical-todos---your-first-backbonejs-app"><span class="octicon octicon-link"></span></a>Practical: Todos - Your First Backbone.js App</h1>

      <p>Now that we've journeyed through the fundamentals, let's move on to writing our first Backbone.js app - a Todo List application. Building a Todo List is a great way to learn about Backbone’s conventions. It's a simple enough app, but contains enough interesting problems to be useful, such as binding, persisting model data, routing and template rendering.</p>

      <p>For this chapter, we’re going to learn how to create the Backbone.js Todo app listed on <a href="http://todomvc.com">TodoMVC.com</a>.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoapp.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoapp.png" alt="" style="max-width:100%;"></a></p>

      <p>Let's think about what we need from a high level architectural standpoint.</p>

      <ul>
      <li>A <code>Todo</code> model to describe individual todo items</li>
      <li>A <code>TodoList</code> collection to store and persist todos</li>
      <li>A way of creating todos</li>
      <li>Listing todos</li>
      <li>Editing existing todos</li>
      <li>Completing todos</li>
      <li>Deleting todos</li>
      <li>A way to bookmark the items that have been completed or are remaining</li>
      </ul><p>Basically your classic <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> methods. Let's get started!</p>

      <h2>
      <a name="user-content-index" class="anchor" href="#index"><span class="octicon octicon-link"></span></a>Index</h2>

      <p>The first step is to setup the basic application dependencies, which in this case will be: <a href="http://jquery.com">jQuery</a>, <a href="http://underscorejs.org">Underscore</a>, Backbone.js and the <a href="https://github.com/jeromegn/Backbone.localStorage">Backbone LocalStorage adapter</a>. These will be loaded in our main (and only) HTML file, index.html:</p>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Backbone.js • TodoMVC<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"assets/base.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/underscore-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-localstorage.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/models/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/collections/todos.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/routers/router.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>

      </pre></div>

      <p>To help demonstrate how the various parts of our application can be split up, individual concerns are cleanly organized into folders representing our models, views, collections and routers. An app.js file is used to kick everything off.</p>

      <p>Note: If you want to follow along, create directory structure as shown in index.html. Also, you will need <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/base.css">base.css</a> and <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/bg.png">bg.png</a>, both in assets dir. As mentioned previously you can check out whole application at <a href="http://todomvc.com">TodoMVC.com</a>.</p>

      <h2>
      <a name="user-content-application-html" class="anchor" href="#application-html"><span class="octicon octicon-link"></span></a>Application HTML</h2>

      <p>Now let's take a look at our application's static HTML. We're going to need an <code>&lt;input&gt;</code> for creating new todos, a <code>&lt;ul id="todo-list" /&gt;</code> for listing the actual todos, and a section containing some operations, such as clearing completed todos.</p>

      <div class="highlight highlight-html"><pre>  <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;header</span> <span class="na">id=</span><span class="s">"header"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h1&gt;</span>todos<span class="nt">&lt;/h1&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">autofocus</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/header&gt;</span>
          <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"toggle-all"</span> <span class="na">type=</span><span class="s">"checkbox"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"toggle-all"</span><span class="nt">&gt;</span>Mark all as complete<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
          <span class="nt">&lt;/section&gt;</span>
          <span class="nt">&lt;footer</span> <span class="na">id=</span><span class="s">"footer"</span><span class="nt">&gt;&lt;/footer&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"info"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;p&gt;</span>Double-click to edit a todo<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Written by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/addyosmani"</span><span class="nt">&gt;</span>Addy Osmani<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Part of <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://todomvc.com"</span><span class="nt">&gt;</span>TodoMVC<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

      </pre></div>

      <p>We’ll be populating our todo-list and adding a statistics section with details about what items are left to be completed later on.</p>

      <p>So far so good. Now in order to tie this into our Backbone Todo app, we're going to have to go back to the fundamentals - a Todo model.</p>

      <h2>
      <a name="user-content-todo-model" class="anchor" href="#todo-model"><span class="octicon octicon-link"></span></a>Todo model</h2>

      <p>The <code>Todo</code> model is remarkably straightforward. Firstly a todo has two attributes, a <code>title</code> and a <code>completed</code> status that indicates whether it's been completed. These attributes are passed as defaults, as you can see in the example below:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/models/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>
        <span class="c1">// Our basic **Todo** model has `title` and `completed` attributes.</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo</span>
          <span class="c1">// and ensure that each todo created has `title` and `completed` keys.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `completed` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span>
            <span class="p">});</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre></div>

      <p>We also have a <code>toggle()</code> function which allows to set whether a Todo item has been completed.</p>

      <h2>
      <a name="user-content-todo-collection" class="anchor" href="#todo-collection"><span class="octicon octicon-link"></span></a>Todo collection</h2>

      <p>Next we have our <code>TodoList</code> collection used to group our models. The collection is being extended by localStorage which automatically persists Todo records to HTML5 Local Storage via the Backbone LocalStorage adapter, so they're saved between page requests.</p>

      <p>We've then got some static methods, <code>completed()</code> and <code>remaining()</code>, which return an array of unfinished and finished todos respectively.</p>

      <p>Finally we have a <code>nextOrder()</code> function, that keeps our Todo items in sequential order as well as a <code>comparator()</code> used to sort items by their insertion order.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/collections/todos.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// The collection of todos is backed by *localStorage* instead of a remote</span>
        <span class="c1">// server.</span>
        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">completed</span><span class="p">()</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Create our global collection of **Todos**.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

      </pre></div>

      <h2>
      <a name="user-content-application-view" class="anchor" href="#application-view"><span class="octicon octicon-link"></span></a>Application View</h2>

      <p>So let's look at the core of the application's logic, the views. Since each todo has a fair bit of logic associated with it, such as edit in place, we're going to use the element controller pattern - a pattern which consists of two views, one that controls a collection of items, and the other deals with each individual item.</p>

      <p>In other words, we're going to have one view <code>AppView</code>, which will be in charge creating new todos, and rendering the initial todo list. Then we'll have another view called TodoView instances of which will be associated with an individual Todo record. Todo instances will be in charge of editing, updating and destroying their associated todo.</p>

      <p>To keep thing simple, we'll keep things 'read-only' at the moment, and won't provide any functionality for creating, editing or deleting todos:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre></div>

      <p>You can see we've got a couple of things going on, an el (element), a <code>statsTemplate</code>, a constructor function and several view specific methods. To the right of the <code>el:</code> key is a DOM element selector for the element with ID <code>todoapp</code>. The value of this is just a string and Backbone will create a reference pointing to the element matching the selector #todoapp, where here it will be the <code>&lt;section id="todoapp" /&gt;</code> element, which we previously defined in our HTML.</p>

      <p>In a nutshell this means we can now refer to this.el in our controller, which points to the <code>&lt;section id="todoapp" /&gt;</code> element. As you can see, we're referring to el in the <code>addOne()</code> function, appending an element to the list.</p>

      <p>Now let's take a look at the constructor function. It's binding to several events on the Todo model, such as add, reset and all. Since we're delegating handling of updates and deletes to the <code>TodoView</code> view, we don't need to to worry about that here. The two pieces of logic are:</p>

      <ul>
      <li><p>When a new todo is created, the <code>add</code> event will be fired, calling <code>addAll()</code>. This iterates over all of the Todos currently in our collection and fires <code>addOne()</code> for each item.</p></li>
      <li><p><code>addOne()</code> instantiates the TodoView view, rendering it and appending the resultant element to our Todo list.</p></li>
      <li><p>When a <code>reset</code> event is called (i.e. we wish to update the collection in bulk such as when the Todos have been loaded from Local Storage), <code>addAll()</code> is similarly called again.</p></li>
      </ul><p>We can then add in the logic for creating new todos, editing them and filtering them based on whether they are complete.</p>

      <ul>
      <li>events: We define an events hash containing declarative callbacks for our DOM events.

      <ul>
      <li>
      <code>createOnEnter()</code>: When a user hits return inside the <code>&lt;input/&gt;</code> field, this creates a  new Todo item and resets the main <code>&lt;input/&gt;</code> field value to prepare it for the next   entry.</li>
      <li>
      <code>clearCompleted()</code>: Removes the items in the todo list that have been marked as   completed</li>
      <li>
      <code>toggleAllComplete()</code>: Allows a user to set all of the items in the todo list to  completed.</li>
      <li>
      <code>initialize()</code>:
      We bind a callback for a change:completed event, letting us know a change has     been made as well to an existing todo item
      We also bind a callback for a filter event, which works a little similar to     addOne() and addAll(). It’s responsibility is to toggle what todo items are     visible based on the filter currently selected in the UI (all, completed or     remaining) through filterOne() and filterAll().</li>
      <li>
      <code>render()</code>:
      We add some conditional CSS styling based on the filter currently selected so     that the route that has been selected is highlighted</li>
      <li>
      <code>createOnEnter()</code>:
      Creates a new Todo model which persists in localStorage when a user hits    return. This creates the model via newAttributes(), which is an object    literal composed of the title, order and completed state of the new item    being added.</li>
      <li>
      <code>clearCompleted()</code>:
      Clears all the todo items that have been marked as complete</li>
      </ul>
      </li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span> <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'click #clear-completed'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span><span class="p">,</span>
            <span class="s1">'click #toggle-all'</span><span class="o">:</span> <span class="s1">'toggleAllComplete'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#filters li a'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#/'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">||</span> <span class="s1">''</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterOne</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">todo</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'visible'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterAll</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Generate the attributes for a new Todo item.</span>
          <span class="nx">newAttributes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">(),</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">(),</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// If you hit return in the main input field, create new **Todo** model,</span>
          <span class="c1">// persisting it to *localStorage*.</span>
          <span class="nx">createOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">!==</span> <span class="nx">ENTER_KEY</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">()</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Clear all completed todo items, destroying their models.</span>
          <span class="nx">clearCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleAllComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                <span class="s1">'completed'</span><span class="o">:</span> <span class="nx">completed</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-individual-todo-view" class="anchor" href="#individual-todo-view"><span class="octicon octicon-link"></span></a>Individual Todo View</h2>

      <p>Let’s look at the <code>TodoView</code> view, now. This will be in charge of individual Todo records, making sure the view updates when the todo does. To enable enable this interactive behavior we should add some event listeners to the view, that will listen to the events on individual todo represented in html.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-renders the todo item to the current state of the model and</span>
          <span class="c1">// updates the reference to the todo's edit input within the view.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <p>In the <code>initialize()</code> constructor, we're setting up a listener to the todo model’s change event. In other words, when the todo updates, we want to re-render the view to reflect its changes.</p>

      <p>In the <code>render()</code> method, we're rendering an Underscore.js JavaScript template, called <code>#item-template</code>, which we’ve previously compiled into this.template using Underscore’s <code>_.template()</code> method.  This returns a piece of HTML that we're using to replace the view’s current element. In other words, the rendered template is now present under <code>this.el</code>, and can be appended to the todo list.</p>

      <p>Our events hash includes three callbacks:</p>

      <ul>
      <li>
      <code>edit()</code>: Changes the current view into editing mode when a user double-clicks on an existing item in the todo list. This allows them to change the existing value of the item’s title attribute</li>
      <li>
      <code>updateOnEnter()</code>: checks that the user has hit the return/enter key and executes the close() function.</li>
      <li>
      <code>close()</code>: This trims the value of the current text in our <code>&lt;input/&gt;</code> field, ensuring that we don’t process it further if it contains no text (e.g ‘’). If a valid value has been provided, we save the changes to the current todo model and close editing mode, by removing the corresponding CSS class.</li>
      </ul><h2>
      <a name="user-content-setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h2>

      <p>So now we have two views: <code>AppView</code> and <code>TodoView</code>. The former needs to get instantiated when the page loads, so some code actually gets run. You can do this simply enough, by using jQuery's <code>ready()</code> utility, which will execute a function when the DOM's loaded.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Kick things off by creating the **App**.</span>
          <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span><span class="p">();</span>

        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-in-action" class="anchor" href="#in-action"><span class="octicon octicon-link"></span></a>In action</h2>

      <p>Now we've gone far enough without checking that things work as they should. </p>

      <p>If you are following along open up index.html and, if everything's going to plan, you shouldn't see any errors in the console. The todo list will be blank (we haven't created any todos yet), and the todo-list won't work through our slick interface, as we haven't yet hooked it up fully. However, we can create a Todo from the console.</p>

      <p>Type in: <code>window.app.Todos.create({ title: 'My first Todo item'});</code> and hit return.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoconsole.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoconsole.png" alt="" style="max-width:100%;"></a></p>

      <p>Once you've run the above in the console, we should be looking at a brand new todo (logged in console) we've just added in the todos collection. Created todo is saved into Local Storage as well and will be available on page refresh.</p>

      <p><code>window.app.Todos.create()</code> used above is collection method (<code>collection.create(attributes, [options])</code>) which instantiate new model item of the type passed into the collection definition, in our case <code>app.Todo</code>:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="c1">// the model type used by collection.create() to instantiate new model in the collection</span>
            <span class="p">...</span>
        <span class="p">)};</span>

      </pre></div>

      <p>Run this into console to check it out:</p>

      <p><code>var secondTodo = window.app.Todos.create({ title: 'My second Todo item'});</code></p>

      <p><code>secondTodo instanceof app.Todo</code></p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoconsole2.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todoconsole2.png" alt="" style="max-width:100%;"></a></p>

      <h2>
      <a name="user-content-templates" class="anchor" href="#templates"><span class="octicon octicon-link"></span></a>Templates</h2>

      <p>The <code>#item-template</code> used in the <code>TodoView</code> view needs defining, so let's do that. One way of including templates in the page is by using custom script tags. These don't get evaluated by the browser, which just interprets them as plain text. Underscore micro-templating can then access the templates, rendering pieces of HTML.</p>

      <div class="highlight highlight-html"><pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"item-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"view"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"toggle"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">?</span> <span class="s1">'checked'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;&lt;%=</span> <span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"destroy"</span><span class="o">&gt;&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;</span><span class="err">/div&gt;</span>
          <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"edit"</span> <span class="nx">value</span><span class="o">=</span><span class="s2">"&lt;%= title %&gt;"</span><span class="o">&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre></div>

      <p>The template tags demonstrated above, such as <code>&lt;%=</code> , are specific to Underscore.js, and documented on the Underscore site. In your own applications, you have a choice of template libraries, such as Mustache or Handlebars. Use whichever you prefer, Backbone doesn't mind.</p>

      <p>Now when <code>_.template( $('#item-template').html() )</code> is called in the <code>TodoView</code> view our template will render correctly.</p>

      <p>We also need to define #stats-template template we use to display how many items have been completed, as well as allowing the user to clear these items.</p>

      <div class="highlight highlight-html"><pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"stats-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">strong</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;&lt;</span><span class="err">/strong&gt; &lt;%= remaining === 1 ? 'item' : 'items' %&gt; left&lt;/span&gt;</span>
          <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"filters"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"selected"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/"</span><span class="o">&gt;</span><span class="nx">All</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/active"</span><span class="o">&gt;</span><span class="nx">Active</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/completed"</span><span class="o">&gt;</span><span class="nx">Completed</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
          <span class="o">&lt;</span><span class="err">/ul&gt;</span>
          <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">completed</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
          <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"clear-completed"</span><span class="o">&gt;</span><span class="nx">Clear</span> <span class="nx">completed</span> <span class="p">(</span><span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">%&gt;</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre></div>

      <h2>
      <a name="user-content-in-action-1" class="anchor" href="#in-action-1"><span class="octicon octicon-link"></span></a>In action</h2>

      <p>Now refresh index.html and we should be able to see the fruits of our labour. </p>

      <p>The todos added through console earlier should appear in the list populated from the Local Storage. Also, we should be able to type a todo name, and press return to submit the form, creating a new todo.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todocompleted.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todocompleted.png" alt="" style="max-width:100%;"></a></p>

      <p>Excellent, we're making great progress, but how about completing and deleting todos?</p>

      <h2>
      <a name="user-content-completing--deleting-todos" class="anchor" href="#completing--deleting-todos"><span class="octicon octicon-link"></span></a>Completing &amp; deleting todos</h2>

      <p>So the next part of our tutorial is going to cover completing and deleting todos. These two actions are specific to each Todo item, so we need to add this functionality to the TodoView view.</p>

      <p>The key part of this is the two event handlers we've added, a togglecompleted event on the todo's checkbox, and a click event on the todo's <code>&lt;button class="destroy" /&gt;</code> button.</p>

      <p>The checkbox's togglecompleted event invokes the toggle() function, which toggles the todos's completed status, then resaving the todo - very straightforward!
      The button's click event invokes <code>clear()</code>, which will simply destroy the todo.</p>

      <p>That's all there is to it. Since we're binding to the change event, whenever the todo changes the view will automatically be re-rendered, checking or un-checking the checkbox as appropriate. Similarly, when the todo is destroyed, the model's <code>destroy()</code> function will be called, removing the todo from the view as we’re binding to the destroy event too.</p>

      <p>One more piece to mention is that we’ve also binded to a visible event to handle the visibility state of the todo item. This is used in conjunction with the filtering in our routes and collections so that we only display an item if its completed state falls in line with the current filter.</p>

      <p>This tutorial is long enough as is, so we won't go into in-place editing or updating. If you want an example of that, see the <a href="https://github.com/addyosmani/todomvc/tree/master/architecture-examples/backbone/">complete source</a>.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/view/todos.js</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span><span class="p">,</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click .destroy'</span><span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'visible'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the titles of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span> <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleVisible</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'hidden'</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="nx">isHidden</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isHidden</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">isCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="k">return</span> <span class="p">(</span> <span class="c1">// hidden cases only</span>
              <span class="p">(</span><span class="o">!</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'completed'</span><span class="p">)</span>
              <span class="o">||</span> <span class="p">(</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'active'</span><span class="p">)</span>
            <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `"completed"` state of the model.</span>
          <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="c1">// Remove the item, destroy the model from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-todo-routing" class="anchor" href="#todo-routing"><span class="octicon octicon-link"></span></a>Todo routing</h2>

      <p>Finally, we move on to routing, which will allow us to easily bookmark the list of items that are active as well as those which have been completed. We’ll be supporting the following routes:</p>

      <div class="highlight highlight-javascript"><pre><span class="err">#</span><span class="o">/</span> <span class="p">(</span><span class="nx">all</span> <span class="o">-</span> <span class="k">default</span><span class="p">)</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">active</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">completed</span>
      </pre></div>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todorouting.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/todorouting.png" alt="" style="max-width:100%;"></a></p>

      <p>When the route changes the todo list will be filtered on a model level and the selected class on the filter links will be toggled. When an item is updated while in a filtered state, it will be updated accordingly.
      E.g. if the filter is active and the item is checked, it will be hidden. The active filter is persisted on reload.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/routers/router.js</span>

        <span class="c1">// Todo Router</span>
        <span class="c1">// ----------</span>

        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
          <span class="p">},</span>

          <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Set the current filter to be used</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

            <span class="c1">// Trigger a collection filter event, causing hiding/unhiding</span>
            <span class="c1">// of Todo view items</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Workspace</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      </pre></div>

      <p>As we can see in the line <code>window.app.Todos.trigger('filter')</code>, once a string filter has been set, we simply trigger our filter at a collection level to toggle which items are displayed and which of those are hidden.</p>

      <p>Finally, we call <code>Backbone.history.start()</code> to route the initial URL during page load.</p>

      <h2>
      <a name="user-content-conclusions" class="anchor" href="#conclusions"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>We’ve now learned how to build our first complete Backbone.js application. The full app can be viewed online at any time and the sources are readily available via <a href="http://www.todomvc.com">TodoMVC</a>.</p>

      <p>Later on in the book, we’ll learn how to further modularize this application using RequireJS, swap out our persistence layer to a database back-end and finally unit test the application with a few different testing frameworks.</p>

      <h1>
      <a name="user-content-backbone-boilerplate-and-grunt-bbb" class="anchor" href="#backbone-boilerplate-and-grunt-bbb"><span class="octicon octicon-link"></span></a>Backbone Boilerplate And Grunt-BBB</h1>

      <p><a href="https://github.com/tbranyen/backbone-boilerplate/">Backbone Boilerplate</a> is an excellent set of best practices and utilities for building Backbone.js applications, created by Backbone contributor <a href="https://github.com/tbranyen">Tim Branyen</a>. He organized this boilerplate out of the gotchas, pitfalls and common tasks he ran into over a year of heavily using Backbone to build apps at Bocoup. This includes apps such <a href="http://startupdatatrends.com">StartupDataTrends.com</a>.</p>

      <p>With scaffolding and built in build tasks that take care of minification, concatentation, server, template compilation and more, Backbone Boilerplate (and sister project <a href="https://github.com/backbone-boilerplate/grunt-bbb">Grunt-BBB</a>) are an excellent choice for developers of all levels. I heavily recommend using them as they will give you an enormous start when it comes to getting setup for development. They also have some great inline documentation which is also another excellent time-saver.</p>

      <p>By default, Backbone Boilerplate provides you with:</p>

      <ul>
      <li>Backbone, <a href="https://github.com/bestiejs/lodash">Lodash</a> (an <a href="http://underscorejs.org/">Underscore.js</a> alternative) and <a href="http://jquery.com">jQuery</a> with an <a href="http://html5boilerplate.com">HTML5 Boilerplate</a> foundation</li>
      <li>Boilerplate module code</li>
      <li>A Windows/Mac/Linux build tool for template precompilation and, concatenation &amp; minification of all your libraries, application code and CSS</li>
      <li>Scaffolding support (via grunt-bbb - [B]ackbone [B]oilerplate [B]uild) so you have to spend minimal time writing boilerplate for modules, collections and so on.</li>
      <li>A Lightweight node.js webserver</li>
      <li>Numerous other Backbone.js snippets for making your life easier</li>
      </ul><h2>
      <a name="user-content-getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2>

      <h3>
      <a name="user-content-backbone-boilerplate" class="anchor" href="#backbone-boilerplate"><span class="octicon octicon-link"></span></a>Backbone Boilerplate</h3>

      <p>We can use Boilerplate to easily begin creating an application, but first, we'll need to install it. This can be done by grabbing the latest version of it by cloning the Boilerplate repo directly:</p>

      <pre lang="shell"><code>$ git clone git://github.com/tbranyen/backbone-boilerplate.git
      </code></pre>

      <p>or alternatively, just fetching the latest tarball as follows:</p>

      <pre lang="shell"><code>$ curl -C - -O https://github.com/tbranyen/backbone-boilerplate/zipball/master
      </code></pre>

      <h3>
      <a name="user-content-grunt-bbb" class="anchor" href="#grunt-bbb"><span class="octicon octicon-link"></span></a>Grunt-BBB</h3>

      <p>As Tim covers in the Boilerplate docs, we have to install <a href="http://gruntjs.com">Grunt</a> if we want to use the build tools and grunt-bbb helpers he recommends.</p>

      <p>Grunt is an excellent Node-based JavaScript build tool by another <a href="http://bocoup.com">Bocoup</a> developer (<a href="http://benalman.com">Ben Alman</a>). Think of it as similar to <a href="http://ant.apache.org/">Ant</a> or <a href="https://github.com/jimweirich/rake">Rake</a>. The grunt-bbb helper is also useful to have as it provides several Backbone-specific utilities for scaffolding out your project, without the need to write boilerplate yourself.</p>

      <p>To install grunt and grunt-bbb via NPM:</p>

      <pre lang="shell"><code># first run
      $ npm install -g grunt

      # followed by
      $ npm install -g bbb

      # finally create a new project
      $ bbb init
      </code></pre>

      <p>That's it. We should now be good to go.</p>

      <p>A typical workflow for using grunt-bbb, which we can use later on is:</p>

      <ul>
      <li>Initialize a new project (<code>bbb init</code>)</li>
      <li>Add new modules and templates (<code>bbb init:module</code>)</li>
      <li>Develop using the built in server (<code>bbb server</code>)</li>
      <li>Run the build tool (<code>bbb build</code>)</li>
      <li>Deploy and map to production assets (using <code>bbb release</code>)</li>
      </ul><h2>
      <a name="user-content-creating-a-new-project" class="anchor" href="#creating-a-new-project"><span class="octicon octicon-link"></span></a>Creating a new project</h2>

      <p>Let's create a new folder for our project and run <code>bbb init</code> to kick things off. If everything has been correctly installed, this will sub out some project directories and files for us. Let's review what is generated.</p>

      <h3>
      <a name="user-content-indexhtml" class="anchor" href="#indexhtml"><span class="octicon octicon-link"></span></a>index.html</h3>

      <p>This is a fairly standard stripped-down HTML5 Boilerplate foundation with the notable exception of including <a href="http://requirejs.org">RequireJS</a> at the bottom of the page.</p>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;title&gt;</span>Backbone Boilerplate<span class="nt">&lt;/title&gt;</span>

        <span class="c">&lt;!-- Application styles. --&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/assets/css/index.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>

      <span class="nt">&lt;body&gt;</span>
        <span class="c">&lt;!-- Main container. --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;&lt;/div&gt;</span>

        <span class="c">&lt;!-- Application source. --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">data-main=</span><span class="s">"/app/config"</span> <span class="na">src=</span><span class="s">"/assets/js/libs/require.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>RequireJS is an <a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD</a> (Asynchronous Module Definition) module and script loader, which will assist us with managing the modules in our application. We'll be covering it in a lot more detail later on in the book, but for now, let's cover at a high-level what this particular block does:</p>

      <pre><code>&lt;script data-main="app/config" src="/assets/js/libs/require.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>The <code>data-main</code> attribute is used to inform RequireJS to load <code>app/config.js</code> (a configuration object) after it has finished loading itself. You'll notice that we've omitted the <code>.js</code> extension here as RequireJS can automatically add this for us, however it will respect your paths if we do choose to include it regardless. Let's now look at the config file being referenced.</p>

      <h3>
      <a name="user-content-configjs" class="anchor" href="#configjs"><span class="octicon octicon-link"></span></a>config.js</h3>

      <p>A RequireJS configuration object allows us to specify aliases and paths for dependencies we're likely to reference often (e.g jQuery), bootstrap properties like our base application URL and <code>shim</code> libraries that don't support AMD natively.</p>

      <p>This is what the config file in Backbone Boilerplate looks like:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Set the RequireJS configuration for your application.</span>
      <span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>

        <span class="c1">// Initialize the application with the main application file.</span>
        <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'main'</span><span class="p">],</span>

        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>

        <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <p>The first option defined in the above config is <code>deps: ['main']</code>. This informs RequireJS to load up our main.js file, which is considered the entry point for our application. You may notice that we haven't specified any other path information for <code>main</code>.</p>

      <p>This is because as we haven't overridden the path to our scripts using the <code>baseUrl</code> option, Require will infer this using the path from our <code>data-main</code> attribute in index.html. In other words, our <code>baseUrl</code> is <code>app/</code> and any scripts we require will be loaded relative to this location.</p>

      <p>The next block is <code>paths</code>, which we can use to specify paths relative to the <code>baseUrl</code> as well as the paths/aliases to dependencies we're likely to regularly reference.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>
      </pre></div>

      <p>Next we have the <code>shim</code> config:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>
      </pre></div>

      <p><code>shim</code> is an important part of our RequireJS configuration which allows us to load libraries which are not AMD compliant. The basic idea here is that rather than requiring all libraries to implement support for AMD, the <code>shim</code> takes care of the hard work for us.</p>

      <p>For example, in the block below, we state that Backbone.js is dependent on Lodash (a fork of Underscore.js) and jQuery being loaded before it. Once they've been loaded, we then use the global export <code>Backbone</code> as the module value.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">}</span>
      </pre></div>

      <p>Finally, we inform RequireJS that the Backbone <a href="https://github.com/tbranyen/backbone.layoutmanager">LayoutManager</a> plugin (a template and layout manager, also included) requires that Backbone be loaded before it should be.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
      </pre></div>

      <p>This entire setup ensures that our scripts correctly get loaded in the order in which we expect.</p>

      <h3>
      <a name="user-content-mainjs" class="anchor" href="#mainjs"><span class="octicon octicon-link"></span></a>main.js</h3>

      <p>Next, we have <code>main.js</code>, which defines the entry point for our application. We use a global <code>require()</code> method to load an array any other scripts needed, such as our application <code>app.js</code> and our main router <code>router.js</code>. Note that most of the time, we will only use <code>require()</code> for bootstrapping an application and a similar method called <code>define()</code> for all other purposes.</p>

      <p>The function defined after our array of dependencies is a callback which doesn't fire until these scripts have loaded. Notice how we're able to locally alias references to "app" and "router" as <code>app</code> and <code>Router</code> for convenience.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Main Router.</span>
        <span class="s1">'router'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Define your master router on the application namespace and trigger all</span>
        <span class="c1">// navigation from this instance.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>

        <span class="c1">// Trigger the initial route and enable HTML5 History API support, set the</span>
        <span class="c1">// root folder to '/' by default.  Change in app.js.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span> <span class="nx">pushState</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">root</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="p">});</span>

        <span class="c1">// All navigation that is relative should be passed through the navigate</span>
        <span class="c1">// method, to be processed by the router. If the link has a `data-bypass`</span>
        <span class="c1">// attribute, bypass the delegation completely.</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'a:not([data-bypass])'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Get the absolute anchor href.</span>
          <span class="kd">var</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">);</span>

          <span class="c1">// If the href exists and is a hash route, run it through Backbone.</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">href</span> <span class="o">&amp;&amp;</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Stop the default event to ensure the link will not cause a page</span>
            <span class="c1">// refresh.</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

            <span class="c1">// `Backbone.history.navigate` is sufficient for all Routers and will</span>
            <span class="c1">// trigger the correct events. The Router's internal `navigate` method</span>
            <span class="c1">// calls this anyways.  The fragment is sliced from the root.</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>Inline, Backbone Boilerplate includes boilerplate code for initializing our router with HTML5 History API support and handling other navigation scenarios, so we don't have to.</p>

      <h3>
      <a name="user-content-appjs" class="anchor" href="#appjs"><span class="octicon octicon-link"></span></a>app.js</h3>

      <p>Let us now look at our <code>app.js</code> module. Typically, in non-Backbone Boilerplate applications, an <code>app.js</code> file may contain the core logic or module references needed to kick start an app.</p>

      <p>In this case however, this file is used to define templating and layout configuration options as well as utilities for consuming layouts. To a beginner, this might look like a lot of code to comprehend, but the good news is that for basic apps, you're unlikely to need to heavily modify this. Instead, you'll be more concerned with modules for your app, which we'll look at next.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>

        <span class="c1">// Libraries.</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'lodash'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins.</span>
        <span class="s1">'plugins/backbone.layoutmanager'</span>

      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Provide a global location to place configuration settings and module</span>
        <span class="c1">// creation.</span>
        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
          <span class="c1">// The root path to run the application.</span>
          <span class="nx">root</span><span class="o">:</span> <span class="s1">'/'</span>
        <span class="p">};</span>

        <span class="c1">// Localize or create a new JavaScript Template object.</span>
        <span class="kd">var</span> <span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Configure LayoutManager with Backbone Boilerplate defaults.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutManager</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">layout</span><span class="o">:</span> <span class="s1">'app/templates/layouts/'</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="s1">'app/templates/'</span>
          <span class="p">},</span>

          <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">'.html'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Mix Backbone.Events, modules, and layout management into the app object.</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">{</span>
          <span class="c1">// Create a custom object with a nested Views object.</span>
          <span class="nx">module</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">additionalProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">Views</span><span class="o">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="nx">additionalProps</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Helper for using layouts.</span>
          <span class="nx">useLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If already using this Layout, then don't re-inject into the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">===</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// If a layout already exists, remove it from the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">// Create a new Layout.</span>
            <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Layout</span><span class="p">({</span>
              <span class="nx">template</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">className</span><span class="o">:</span> <span class="s1">'layout '</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="s1">'layout'</span>
            <span class="p">});</span>

            <span class="c1">// Insert into the DOM.</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">).</span><span class="nx">empty</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">layout</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>

            <span class="c1">// Render the layout.</span>
            <span class="nx">layout</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">// Cache the reference.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="nx">layout</span><span class="p">;</span>

            <span class="c1">// Return the reference, for chainability.</span>
            <span class="k">return</span> <span class="nx">layout</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-creating-backbone-boilerplate-modules" class="anchor" href="#creating-backbone-boilerplate-modules"><span class="octicon octicon-link"></span></a>Creating Backbone Boilerplate Modules</h3>

      <p>Not to be confused with simply being just an AMD module, a Backbone Boilerplate <code>module</code> is a script composed of a:</p>

      <ul>
      <li>Model</li>
      <li>Collection</li>
      <li>Views (optional)</li>
      </ul><p>We can easily create a new Boilerplate module using <code>grunt-bbb</code> once again using <code>init</code>:</p>

      <pre lang="shell"><code># Create a new module
      $ bbb init:module

      # Grunt prompt
      Please answer the following:
      [?] Module Name foo
      [?] Do you need to make any changes to the above before continuing? (y/N) n

      Writing app/modules/foo.js...OK

      Initialized from template "module".
      </code></pre>

      <p>This will generate a module <code>foo.js</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>

      </pre></div>

      <p>Notice how boilerplate code for our model and collection has already been written for us, as well as code for consuming the layout utilities defined in <code>app.js</code>.</p>

      <p>Now, you may be wondering where or how Views fit into this setup. Although Backbone Boilerplate doesn't include Views in its generated modules by default, we can easily add them ourselves as needed.</p>

      <p>e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Views</span>
        <span class="s1">'modules/foo/views'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>Optionally, we may also wish to include references to plugins such as the Backbone LocalStorage or Offline adapters. One clean way of including a plugin in the above boilerplate could be:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins</span>
        <span class="s1">'plugins/backbone-localstorage'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span>

          <span class="c1">// Save all of the items under the `"foo"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'foo-backbone'</span><span class="p">),</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>You may have spotted that in our module sample we're using the plural, "Views", rather than just View. This is because a View module can contain references to as many Views as needed. In the above, our <code>/modules/foo/views.js</code> file may look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">Views</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/bar'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Baz</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/baz'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

         <span class="k">return</span> <span class="nx">Views</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>Where the <code>template</code> references in our Views, correspond to files in the <code>app/templates</code> directory. e.g <code>foo/bar</code> is located at <code>app/templates/foo/bar.html</code> and is a HTML template that can contain Lodash/Underscore.js Micro-templating logic.</p>

      <h3>
      <a name="user-content-routerjs" class="anchor" href="#routerjs"><span class="octicon octicon-link"></span></a>router.js</h3>

      <p>Finally, let's look at our application router, used for handling navigation. The default router Backbone Boilerplate generates for us inclues sane defaults for no routes being specified.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="p">}</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>If however we would like to execute some module-specific logic, when the page loads (i.e when a user hits the default route), we can pull in a module as a dependency and optionally use the Backbone LayoutManager to attach Views to our layout as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Modules</span>
        <span class="s1">'modules/foo'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Foo</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="c1">// Create a new Collection</span>
                  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

                  <span class="c1">// Use and configure a 'main' layout</span>
                  <span class="nx">app</span><span class="p">.</span><span class="nx">useLayout</span><span class="p">(</span><span class="s1">'main'</span><span class="p">).</span><span class="nx">setViews</span><span class="p">({</span>
                          <span class="c1">// Attach the bar View into the content View</span>
                          <span class="s1">'.bar'</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span><span class="p">({</span>
                                  <span class="nx">collection</span><span class="o">:</span> <span class="nx">collection</span>
                          <span class="p">})</span>
                   <span class="p">}).</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Fetch data (e.g from localStorage)</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-conclusions-1" class="anchor" href="#conclusions-1"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>In this section we reviewed Backbone Boilerplate and learned how to use the BBB tool to help us scaffold out our application.</p>

      <p>If you would like to learn more about how this project helps structure your app, BBB includes some built-in boilerplate sample apps that can be easily generated for review.</p>

      <p>These include a boilerplate tutorial project (<code>bbb init:tutorial</code>) and an implementation of my <a href="http://todomvc">TodoMVC</a> project (<code>bbb init:todomvc</code>). I recommend checking these out as they'll provide you with a more complete picture of how Backbone Boilerplate, its templates and so on fit into the overall setup for a web app.</p>

      <p>For more about Grunt-BBB, remember to take a look at the official project <a href="https://github.com/backbone-boilerplate/grunt-bbb">repository</a>. There is also a related <a href="https://dl.dropbox.com/u/79007/talks/Modern_Web_Applications/slides/index.html">slide-deck</a> available for those interested in reading more.</p>

      <h2>
      <a name="user-content-related-tools--projects" class="anchor" href="#related-tools--projects"><span class="octicon octicon-link"></span></a>Related Tools &amp; Projects</h2>

      <p>As we've seen, scaffolding tools can assist in expediting how quickly you can begin a new application by creating the basic files required for a project automatically. If you appreciate such tools, I'm happy to also recommend checking out <a href="http://yeoman.io">Yeoman</a> (one of my upcoming projects) and <a href="https://github.com/brunch/brunch">Brunch</a>.</p>

      <p>Brunch works very well with Backbone, Underscore, jQuery and CoffeeScript and is even used by companies such as Red Bull and Jim Beam. You may have to update any third party dependencies (e.g. latest jQuery or Zepto) when using it, but other than that it should be fairly stable to use right out of the box.</p>

      <p>Brunch can be installed via the nodejs package manager and is easy to get started with. If you happen to use Vim or Textmate as your editor of choice, you'll be happy to know that there are Brunch bundles available for both.</p>

      <h1>
      <a name="user-content-common-problems--solutions" class="anchor" href="#common-problems--solutions"><span class="octicon octicon-link"></span></a>Common Problems &amp; Solutions</h1>

      <p>In this section, we will review a number of common problems developers often experience once they've started to work on relatively non-trivial projects using Backbone.js, as well as present potential solutions.</p>

      <p>Perhaps the most frequent of these questions surround how to do more with Views. If you are interested in discovering how to work with nested Views, learn about view disposal and inheritance, this section will hopefully have you covered.</p>

      <h4>
      <a name="user-content-nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs" class="anchor" href="#nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs"><span class="octicon octicon-link"></span></a>Nesting: What is the best approach for rendering and appending Sub-Views in Backbone.js?</h4>

      <p>Nesting is generally considered a good way to maintain hierarchal views for writing maintainable code. As a beginner, one might try writing a very simple setup with sub-views (e.g inner views) as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Where we have previously defined a View, SubView</span>
      <span class="c1">// in a parent View we could do:</span>

      <span class="p">...</span>
      <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">());</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre></div>

      <p>This works in that one doesn't need to worry about maintaining the order of your DOM elements when appending. Views are initialized early and the render() method doesn't need to take on too many responsibilities at once. Unfortunately, a downside is that you don't have the ability to set the <code>tagName</code> of elements and events need to be re-delegated.</p>

      <p>An alternative approach which doesn't suffer from the re-delegation problem could be written as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>


          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
      <span class="p">}</span>

      </pre></div>

      <p>In this version, we also don't require a template containing empty placeholders and the issue with <code>tagName</code>s is solved as they are defined by the view once again.</p>

      <p>Yet another variation which moves logic into an <code>onRender</code> event, could be written with only a few subtle changes:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'render'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRender</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// more logic</span>

          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'render'</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you find yourself nesting views in your application, there are more optimal approaches possible for initializing, rendering and appending your sub-views. One such solution could be written:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">delegateEvents</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      </pre></div>

      <p>This tackles a few specific design decisions:</p>

      <ul>
      <li>The order in which you append the sub-elements matters</li>
      <li>The OuterView doesn't contain the HTML elements to be set in the InnerView(s), meaning that we can still specify tagName in the InnerView</li>
      <li>render() is called after the InnerView element has been placed into the DOM. This is useful if your InnerView's render() method is sizing itself on the page based on the dimensions of another element. This is a common use case.</li>
      </ul><p>A second potential solution is this, which may appear cleaner but in reality has a tendency to affect performance:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Generally speaking, more developers opt for the first solution as:</p>

      <ul>
      <li>The majority of their views may already rely on being in the DOM in their render() method</li>
      <li>When the OuterView is re-rendered, views don't have to be re-initialized where re-initialization has the potential to cause memory leaks and issues with existing bindings</li>
      </ul><p>(Thanks to <a href="http://stackoverflow.com/users/299189/lukas">Lukas</a>  and <a href="http://stackoverflow.com/users/154765/ian-storm-taylor">Ian Taylor</a> for these tips).</p>

      <h4>
      <a name="user-content-what-is-the-best-way-to-manage-models-in-nested-views" class="anchor" href="#what-is-the-best-way-to-manage-models-in-nested-views"><span class="octicon octicon-link"></span></a>What is the best way to manage models in nested Views?</h4>

      <p>In order to reach attributes on related models in a nested setup, the models involved need to have some prior knowledge about which models this refers to. Backbone.js doesn't implicitly handle relations or nesting, meaning it's up to us to ensure models have a knowledge of each other.</p>

      <p>One approach is to make sure each child model has a 'parent' attribute. This way you can traverse the nesting first up to the parent and then down to any siblings that you know of. So, assuming we have models modelA, modelB and modelC:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// When initializing modelA, I would suggest setting a link to the parent</span>
      <span class="c1">// model when doing this, like this:</span>

      <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelB</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelC</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>This allows you to reach the parent model in any child model function by calling this.parent.</p>

      <p>When you have a need to nest Backbone.js views, you might find it easier to let each view represent a single HTML tag using the tagName option of the View. This may be written as:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">ViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'div'</span><span class="p">,</span>
          <span class="nx">id</span><span class="o">:</span> <span class="s1">'new'</span><span class="p">,</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewB</span><span class="p">();</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">parentView</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
             <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">ViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'h1'</span><span class="p">,</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'Header text'</span><span class="p">);</span> <span class="c1">// or use this.options.headerText or equivalent</span>
          <span class="p">},</span>

          <span class="nx">funcB1</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">doSomethingOnParent</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">doSomethingOnSibling</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parentView</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">shakeViolently</span><span class="p">();</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <p>Then in your application initialization code , you would initiate ViewA and place its element inside the body element.</p>

      <p>An alternative approach is to use an extension called <a href="https://github.com/powmedia/backbone-forms">Backbone-Forms</a>. Using a similar schema to what we wrote earlier, nesting could be achieved as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ModelB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeB1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeB2</span><span class="o">:</span> <span class="s1">'Text'</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelC</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeC</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeA1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeA2</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">refToModelB</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelB</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateB'</span> <span class="p">},</span>
              <span class="nx">refToModelC</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelC</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateC'</span> <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>There is more information about this technique available on <a href="https://github.com/powmedia/backbone-forms#customising-templates">GitHub</a>.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/100952/jens-alm">Jens Alm</a> and <a href="http://stackoverflow.com/users/801466/artem-oboturov">Artem Oboturov</a> for these tips)</p>

      <h4>
      <a name="user-content-is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views" class="anchor" href="#is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views"><span class="octicon octicon-link"></span></a>Is it possible to have one Backbone.js View trigger updates in other Views?</h4>

      <p>The Mediator pattern is an excellent option for implementing a solution to this problem.</p>

      <p>Without going into too much detail about the pattern, it can effectively be used an event manager that lets you to subscribe to and publish events. So an ApplicationViewA could subscribe to an event, i.e. 'selected' and then the ApplicationViewB would publish the 'selected' event.</p>

      <p>The reason I like this is it allows you to send events between views, without the views being directly bound together.</p>

      <p>For Example:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// See http://addyosmani.com/largescalejavascript/#mediatorpattern</span>
      <span class="c1">// for an implementation or alternatively for a more thorough one</span>
      <span class="c1">// http://thejacklawson.com/Mediator.js/</span>

      <span class="kd">var</span> <span class="nx">mediator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mediator</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">toggle_select</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="p">...</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">);</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">delete_selected</span><span class="p">)</span>
          <span class="p">},</span>

          <span class="nx">delete_selected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">)</span> <span class="p">{</span>
              <span class="p">...</span> <span class="k">do</span> <span class="nx">something</span> <span class="p">...</span>
          <span class="p">},</span>
      <span class="p">});</span>
      </pre></div>

      <p>This way your ApplicationViewA doesn't care if it is an ApplicationViewB or FooView that publishes the 'selected' event, only that the event occurred. As a result, you may find it a maintainable way to manage events between parts of your application, not just views.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/937577/john-mckim">John McKim</a> for this tip and for referencing my Large Scale JavaScript Patterns article).</p>

      <h4>
      <a name="user-content-how-would-one-render-a-parent-view-from-one-of-its-children" class="anchor" href="#how-would-one-render-a-parent-view-from-one-of-its-children"><span class="octicon octicon-link"></span></a>How would one render a Parent View from one of its Children?</h4>

      <p>If you say, have a view which contains another view (e.g a main view containing a modal view) and  would like to render or re-render the parent view from the child, this is extremely straight-forward.</p>

      <p>In such a scenario, you would most likely want to execute the rendering when a particular event has occurred. For the sake of example, let us call this event 'somethingHappened'. The parent view can bind notifications on the child view to know when the event has occurred. It can then render itself.</p>

      <p>On the parent view:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Parent initialize</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

      <span class="c1">// Parent removal</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      </pre></div>

      <p>On the child view:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// After the event has occurred</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">);</span>

      </pre></div>

      <p>The child will trigger a "somethingHappened" event and the parent's render function will be called.</p>

      <p>(Thanks to Tal <a href="http://stackoverflow.com/users/269666/tal-bereznitskey">Bereznitskey</a> for this tip)</p>

      <h4>
      <a name="user-content-how-do-you-cleanly-dispose-views-to-avoid-memory-leaks" class="anchor" href="#how-do-you-cleanly-dispose-views-to-avoid-memory-leaks"><span class="octicon octicon-link"></span></a>How do you cleanly dispose Views to avoid memory leaks?</h4>

      <p>As your application grows, keeping live views around which aren't being used can quickly become difficult to maintain. Instead, you may find it more optimal to destroy views that are no longer required and simply create new ones as the necessity arises.</p>

      <p>A solution to help with this is to create a BaseView from which the rest of your views inherit from. The idea here is that your view will maintain a reference to all of the events to which its subscribed to so that when it is time to dispose of a view, all of those bindings will be automatically unbound.</p>

      <p>Here is a sample implementation of this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">BaseView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">BaseView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="nx">bindTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

              <span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="o">:</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">unbindFromAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">binding</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>

          <span class="nx">dispose</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbindFromAll</span><span class="p">();</span> <span class="c1">// this will unbind all events that this view has bound to</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span> <span class="c1">// this will unbind all listeners to events from this view. This is probably not necessary because this view will be garbage collected.</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// uses the default Backbone.View.remove() method which removes this.el from the DOM and removes DOM events.</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <div class="highlight highlight-javascript"><pre><span class="nx">BaseView</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>
      </pre></div>

      <p>Then, whenever a view has the need to bind to an event on a model or a collection, you would use the bindTo method. e.g:</p>

      <pre><code>var SampleView = BaseView.extend({

          initialize: function(){
              this.bindTo(this.model, 'change', this.render);
              this.bindTo(this.collection, 'reset', this.doSomething);
          }
      });
      </code></pre>

      <p>When you remove a view, simply call the dispose() method which will clean everything up for you automatically:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">sampleView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SampleView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">some_model</span><span class="p">,</span> <span class="nx">collection</span><span class="o">:</span> <span class="nx">some_collection</span><span class="p">});</span>
      <span class="nx">sampleView</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
      </pre></div>

      <p>(Thanks to <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for this tip).</p>

      <h4>
      <a name="user-content-how-does-one-handle-view-disposal-on-a-parent-or-child-view" class="anchor" href="#how-does-one-handle-view-disposal-on-a-parent-or-child-view"><span class="octicon octicon-link"></span></a>How does one handle View disposal on a Parent or Child View?</h4>

      <p>In the last question, we looked at how to effectively dispose views to decreases memory usage (analogous to a type of garbage collection).</p>

      <p>Where your application is setup with multiple Parent and Child Views, it is also common to desire removing any DOM elements associated with such views as well as unbinding any event handlers tied to child elements when you no longer require them.</p>

      <p>The solution in the last question should be enough to handle this use-case, but if you require a more-explicit example that handles children, we can see one below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">NewView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>
          <span class="nx">renderChildren</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">itemView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewChildView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">item</span> <span class="p">});</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">itemView</span><span class="p">.</span><span class="nx">render</span><span class="p">());</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">itemView</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">onClose</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">view</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">NewChildView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Here, a close() method for views is implemented which disposes of a view when it is no longer needed or needs to be reset. In most cases the view removal should be done at a view layer so that it won't affect any of our models.</p>

      <p>For example, if you are working on a blogging application and you remove a view with comments, perhaps another view in your app shows a selection of comments and resetting the collection would affect those views too.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/906136/dira">dira</a> for this tip)</p>

      <h4>
      <a name="user-content-whats-the-best-way-to-combine-or-append-views-to-each-other" class="anchor" href="#whats-the-best-way-to-combine-or-append-views-to-each-other"><span class="octicon octicon-link"></span></a>What's the best way to combine or append Views to each other?</h4>

      <p>Let us say you have a Collection, where each item in the Collection could itself be a Collection. You can render each item in the Collection, and indeed can render any items which themselves are Collections. The problem you might have is how to render this structure where the HTML reflects the hierarchical nature of the data structure.</p>

      <p>The most straight-forward way to approach this problem is to use a framework like Derick Baileys <a href="https://github.com/marionettejs/backbone.marionette">Backbone.Marionette</a>. In this framework is a type of view called a CompositeView.</p>

      <p>The basic idea of a CompositeView is that it can render a model and a collection within the same view.</p>

      <p>It can render a single model with a template. It can also take a collection from that model and for each model in that collection, render a view. By default it uses the same composite view type that you've defined, to render each of the models in the collection. All you have to do is tell the view instance where the collection is, via the initialize method, and you'll get a recursive hierarchy rendered.</p>

      <p>There is a working demo of this in action available <a href="http://jsfiddle.net/derickbailey/AdWjU/">online</a>.</p>

      <p>And you can get the source code and documentation for <a href="https://github.com/marionettejs/backbone.marionette">Marionette</a> too.</p>

      <h4>
      <a name="user-content-better-model-property-validation" class="anchor" href="#better-model-property-validation"><span class="octicon octicon-link"></span></a>Better Model Property Validation</h4>

      <p>As we learned earlier in the book, the <code>validate</code> method on a Model is called before <code>set</code> and <code>save</code>, and is passed the model attributes updated with the values from these methods.</p>

      <p>By default, where we define a custom <code>validate</code> method, Backbone passes all of a Model's attributes through this validation each time, regardless of which model attributes are being set.</p>

      <p>This means that it can be a challenge to determine which specific fields are being set or validated without being concerned about the others that aren't being set at the same time.</p>

      <p>To illustrate this problem better, let us look at a typical registration form use case that:</p>

      <ul>
      <li>Validates form fields using the blur event</li>
      <li>Validates each field regardless of whether other model attributes (aka other form data) are valid or not.</li>
      </ul><p>Here is one example of a desired use case:</p>

      <p>We have a form where a user focuses and blurs first name, last name, and email HTML input boxes without entering any data. A "this field is required" message should be presented next to each form field.</p>

      <p>HTML:</p>

      <pre><code>&lt;!doctype html&gt;
      &lt;html&gt;
      &lt;head&gt;
        &lt;meta charset=utf-8&gt;
        &lt;title&gt;Form Validation - Model#validate&lt;/title&gt;
        &lt;script src='http://code.jquery.com/jquery.js'&gt;&lt;/script&gt;
        &lt;script src='http://underscorejs.org/underscore.js'&gt;&lt;/script&gt;
        &lt;script src='http://backbonejs.org/backbone.js'&gt;&lt;/script&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;form&gt;
          &lt;label&gt;First Name&lt;/label&gt;
          &lt;input name='firstname'&gt;
          &lt;span data-msg='firstname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Last Name&lt;/label&gt;
          &lt;input name='lastname'&gt;
          &lt;span data-msg='lastname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Email&lt;/label&gt;
          &lt;input name='email'&gt;
          &lt;span data-msg='email'&gt;&lt;/span&gt;
        &lt;/form&gt;
      &lt;/body&gt;
      &lt;/html&gt;
      </code></pre>

      <p>Some simple validation that could be written using the current Backbone <code>validate</code> method to work with this form could be implemented using something like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'email is empty'</span><span class="p">;</span>

      <span class="p">}</span>
      </pre></div>

      <p>Unfortunately, this method would trigger a first name error each time any of the fields were blurred and only an error message next to the first name field would be presented.</p>

      <p>One potential solution to the problem could be to validate all fields and return all of the errors:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is empty'</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>

      <p>This can be adapted into a complete solution that defines a Field model for each input in our form and works within the parameters of our use-case as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is required'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Field</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span><span class="nx">blur</span><span class="o">:</span> <span class="s1">'validate'</span><span class="p">},</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'[data-msg='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">val</span><span class="p">());</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">new</span> <span class="nx">Field</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">user</span><span class="p">});</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>This works great as the solution checks the validation for each attribute individually and sets the message for the correct blurred field. A <a href="http://jsbin.com/afetez/2/edit">demo</a> of the above by <a href="http://github.com/braddunbar">@braddunbar</a> is also available.</p>

      <p>It unfortunately however forces us to validate all of your form fields every time.
      If we have multiple client-side validation methods with our particular use case, we may not want to have to call each validation method on every attribute every time, so this solution might not be ideal for everyone.</p>

      <p>A potentially better alternative to the above is to use <a href="http://github.com/@franko">@gfranko</a>'s <a href="https://github.com/gfranko/Backbone.validateAll">Backbone.validateAll</a> plugin, specifically created to validate specific Model properties (or form fields) without worrying about the validation of any other Model properties (or form fields).</p>

      <p>Here is how we would setup a partial User Model and validate method using this plugin, that caters to our use-case:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Create a new User Model</span>
      <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="c1">// RegEx Patterns</span>
            <span class="nx">patterns</span><span class="o">:</span> <span class="p">{</span>

                <span class="nx">specialCharacters</span><span class="o">:</span> <span class="s1">'[^a-zA-Z 0-9]+'</span><span class="p">,</span>

                <span class="nx">digits</span><span class="o">:</span> <span class="s1">'[0-9]'</span><span class="p">,</span>

                <span class="nx">email</span><span class="o">:</span> <span class="s1">'^[a-zA-Z0-9._-]+@[a-zA-Z0-9][a-zA-Z0-9.-]*[.]{1}[a-zA-Z]{2,6}$'</span>
            <span class="p">},</span>

          <span class="c1">// Validators</span>
            <span class="nx">validators</span><span class="o">:</span> <span class="p">{</span>

            <span class="nx">minLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">minLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">minLength</span><span class="p">;</span>

                <span class="p">},</span>

                <span class="nx">maxLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">maxLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">maxLength</span><span class="p">;</span>

                <span class="p">},</span>

                 <span class="nx">isEmail</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>

                <span class="p">},</span>

                <span class="nx">hasSpecialCharacter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">specialCharacters</span><span class="p">);</span>

                <span class="p">},</span>
               <span class="p">...</span>

          <span class="c1">// We can determine which properties are getting validated by</span>
          <span class="c1">// checking to see if properties are equal to null</span>

              <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname cannot contain special characters'</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'last name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname cannot contain special characters'</span><span class="p">;</span>

                <span class="p">}</span>
      </pre></div>

      <p>This allows the logic inside of our validate methods to determine which form fields are currently being set/validated, and does not care about the other model properties that are not trying to be set.</p>

      <p>It's fairly straight-forward to use as well. We can simply define a new Model instance and then set the data on our model using the <code>validateAll</code> option to use the behavior defined by the plugin:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="s1">'firstname'</span><span class="o">:</span> <span class="s1">'Greg'</span> <span class="p">},</span> <span class="p">{</span><span class="nx">validateAll</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

      </pre></div>

      <p>That's it!.</p>

      <p>The Backbone.validateAll logic doesn't override the default Backbone logic by default and so it's perfectly capable of being used for scenarios where you might care more about field-validation <a href="http://jsperf.com/backbone-validateall">performance</a> as well as those where you don't. Both solutions presented in this section should work fine however.</p>

      <h1>
      <a name="user-content-restful-applications" class="anchor" href="#restful-applications"><span class="octicon octicon-link"></span></a>RESTful Applications</h1>

      <h2>
      <a name="user-content-building-restful-applications-with-backbone" class="anchor" href="#building-restful-applications-with-backbone"><span class="octicon octicon-link"></span></a>Building RESTful applications with Backbone</h2>

      <p>In this section of the book, we're going to take a look at developing RESTful applications using Backbone.js and modern technology stacks. When the data for your back-end is exposed through a purely RESTful API, tasks such as retrieving (GET), creating (POST), updating (PUT) and deleting (DELETE) models are made easy through Backbone's Model API. This API is so intuitive in fact that switching from storing records in a local data-store (e.g localStorage) to a database/noSQL data-store is a lot simpler than you may think.</p>

      <h2>
      <a name="user-content-stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb" class="anchor" href="#stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb"><span class="octicon octicon-link"></span></a>Stack 1: Building A Backbone App With Node.js, Express, Mongoose and MongoDB</h2>

      <p>The first stack we'll be looking at is:</p>

      <ul>
      <li><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/nodejs.org">Node.js</a></li>
      <li><a href="http://expressjs.com/">Express</a></li>
      <li><a href="http://mongoosejs.com/">Mongoose</a></li>
      <li>and <a href="http://www.mongodb.org/">MongoDB</a>
      </li>
      </ul><p>with <a href="http://jade-lang.com/">Jade</a> used optionally as a view/templating engine.</p>

      <h3>
      <a name="user-content-reviewing-the-stack" class="anchor" href="#reviewing-the-stack"><span class="octicon octicon-link"></span></a>Reviewing the stack</h3>

      <p>As you may know, node.js is an event-driven platform (built on the <a href="http://code.google.com/apis/v8/design.html">V8</a> runtime), designed for writing fast, scalable network applications. It's reasonably lightweight, efficient and great for real-time applications that are data-intensive.</p>

      <p>Express is a small web-development framework written with node.js, based on <a href="http://www.sinatrarb.com/">Sinatra</a>. It supports a number of useful features such as intuitive views, robust routing and a focus on high performance.</p>

      <p>Next on the list are MongoDB and Mongoose. MongoDB is an open-source, document-oriented database store designed with scalability and agility in mind. As a <a href="http://en.wikipedia.org/wiki/NoSQL">noSQL</a> database, rather than storing data in tables and rows (something we're very used to doing with relational databases), with MongoDB we instead store JSON-like documents using dynamic schemas. One of the goals of Mongo is to try bridging the gap between key-value stores (speed, scalability) and <a href="http://en.wikipedia.org/wiki/Relational_database">relational</a> databases (rich functionality).</p>

      <p>Mongoose is a JavaScript library that simplifies how we interact with Mongo. Like Express, it's designed to work within the node.js environment and tries to solve some of the complexities with asynchronous data storage by offering a more user-friendly API. It also adds chaining features into the mix, allowing for a slightly more expressive way of dealing with our data.</p>

      <p>Jade is a template engine influenced by Haml (which we'll be looking at later). It's implemented with JavaScript (and also runs under node). In addition to supporting Express out of the box, it boasts a number of useful features including support for mixins, includes, caching, template inheritance and much more. Whilst abstractions like Jade certainly aren't for everyone, our practical will cover working both with and without it.</p>

      <h3>
      <a name="user-content-practical" class="anchor" href="#practical"><span class="octicon octicon-link"></span></a>Practical</h3>

      <p>For this practical, we're going to once again look at extending the popular Backbone Todo application. Rather than relying on localStorage for data persistence, we're going to switch to storing Todos in a MongoDB document-store instead. The code for this practical can be found in <code>practicals\stacks\option2</code></p>

      <p><strong>app.js</strong></p>

      <p>(See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/app.js">here</a> for the source)</p>

      <p>We must first include the node dependencies required by our application. These are Express, Mongoose and Path (a module containing utilities for dealing with file paths).</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">application_root</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">,</span>
        <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">),</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">),</span>
        <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
      </pre></div>

      <p>Next, create a new Express server. <code>express()</code> is a simple way of creating an instance of express.HTTPServer, which we'll be using to pass in our routes.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
      </pre></div>

      <p>After this, connect Mongoose up to a database (in our case, localhost should suffice). Should you require the ability to pass in authentication information, here's a sample containing all of the supported URL parameters: <code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</code></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://localhost/my_database'</span><span class="p">);</span>
      </pre></div>

      <p>A Mongoose model for any Todo item can now be easily defined by passing a schema instance to <code>mongoose.model</code>. In our case the schema covers a Todo item's <code>text</code> content, its <code>done</code> state and <code>order</code> position in the overall Todo list.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Todo'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
        <span class="nx">text</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="nx">done</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span>
        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
      <span class="p">}));</span>
      </pre></div>

      <p>The <code>configure()</code> methods allows us to setup what we need for the current environment with our Express server. Note that lower down in the configuration are two view/view related lines. The last one explicitly sets the viewing/templating engine to be used as Jade <code>app.set('view engine', 'jade')</code>. We can avoid these if we wish to use plain HTML/JS for our templates instead.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// the bodyParser middleware parses JSON request bodies</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">)</span>
      <span class="p">});</span>

      </pre></div>

      <p>Should you prefer to switch out Jade for an alternative view engine, this can be done fairly trivially. See the section under 'Templating' here:
      <a href="https://github.com/joyent/node/wiki/modules">https://github.com/joyent/node/wiki/modules</a>. For example, to switch to EJS, you would simply write <code>app.set('view engine', 'ejs')</code></p>

      <p>Express makes use of common HTTP verbs (get, put, post etc.) to provide easy to use, expressive routing API based on CRUD (Create, Read, Update and Delete). Below for example, we can define what happens when the browser requests the root '/'. As a trivial route in this application, it doesn't do anything particularly exciting, however getters typically read or retrieve data.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Onto something a little more useful and in our next route, navigating to '/todo' will actually render our Jade view 'todo.jade', as seen in the callback. Additional configuration values can be passed as the second parameter, such as the custom title specified below.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'todo'</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">'Our sample application'</span><span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Next, we can see the first of our '/api/' routes.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todos</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>The callback to our next route supports querying for todos based on a specific ID. The route string itself (once compiled) will be converted from '/api/todos/:id' to a regular expression. As you might have guessed, this is a hint that routes can also be regular expression literals if we wished to do something more complex.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Similarly, we want to support updating todos based on a specific ID as well. The following allows us to query a todo by ID and then update the values of its three attributes (text, done, order) easily.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updated'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>We've so far covered requesting todos and updating them, but a core part of the application requires us to insert (or add) new todos to our data-store. Below we can create new <code>Todo</code> models and simply save them.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">todo</span><span class="p">;</span>
        <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
          <span class="nx">text</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
          <span class="nx">done</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span>
          <span class="nx">order</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span>
        <span class="p">});</span>
        <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>We of course also want to support deleting todos (e.g if a todo has been 'cleared', it should be deleted). This also works based on a specific todo ID.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Finally, this last line is to ensure we're only listening on the port app.js is running.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
      </pre></div>

      <p><strong>script.js - updating our Backbone.js app</strong></p>

      <p>In the <code>/public/js</code> folder of options 1 (HTML templates) and 2 (Jade) for the practical, you'll find a version of the Backbone Todo app originally by Jerome Gravel-Niquet. Let's pay attention to <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/public/js/script.js">script.js</a>. In order to change the application to work with our new back-end, we'll need to make some very minor changes to this.</p>

      <p>Reviewing <code>window.TodoList</code> (a Backbone Collection), you'll notice that it has a property called <code>localStorage</code>, which uses the Backbone <a href="https://github.com/jeromegn/Backbone.localStorage">localStorage</a> adapter in order to facilitate storing data using the browser's localStorage features.</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// Typically, this should be a unique name within your application</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>
      </pre></div>

      <p>In order to switch it over to our RESTful backend, we're going to make use of the <code>url</code> property or function on a collection to reference its location on the server. Models inside of a collection then use <code>url</code> to construct URLs of their own. As all of the CRUD for our RESTful API works on the base route '/api/todos', this is the value we set <code>url</code> to.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>
      </pre></div>

      <p>This is the only change necessary to our existing Backbone application in order to get things working. Pretty easy, right?</p>

      <p><strong>todo.jade</strong></p>

      <p>The Jade templates for our application cover declarative markup for both the index (layout.jade) of the application and the main Todo container (todo.jade). It also covers the script-tag templates used for rendering each new Todo item that's added.</p>

      <div class="highlight highlight-html"><pre>// Todo App Interface

      #todoapp
        .title
          h1 Todos
        .content
          #create-todo
            input#new-todo(placeholder="What needs to be done?", type="text")
            span.ui-tooltip-top(style="display:none;") Press Enter to save this task
          #todos
            ul#todo-list
          #todo-stats


      // Templates
      script#item-template(type="text/template")
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        .display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          .todo-text
          span#todo-destroy
        .edit
          input.todo-input(type="text", "value"="")
        <span class="nt">&lt;/div&gt;</span>

      script#stats-template(type="text/template")
        <span class="err">&lt;</span>% if (total) { %&gt;
        span.todo-count
          span.number <span class="err">&lt;</span>%= remaining %&gt;
          span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          |  left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        span.todo-clear
          a(href="#")
            |  Clear
            span.number-done <span class="err">&lt;</span>%= done %&gt;
            |  completed
            span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre></div>

      <p><strong>layout.jade</strong></p>

      <div class="highlight highlight-html"><pre>head
        meta(charset="utf-8")
        meta(http-equiv="X-UA-Compatible", content="IE=edge,chrome=1")

        title=title
        meta(name="description", content="")
        meta(name="author", content="")
        meta(name="viewport", content="width=device-width,initial-scale=1")

        // CSS concatenated and minified via ant build script
        link(rel="stylesheet", href="css/style.css")
        // end CSS

        script(src="js/libs/modernizr-2.0.6.min.js")
      body

        #container
          header
          #main(role="main")!=body
          footer
        //! end of #container

        script(src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js")
        script
          window.jQuery || document.write('<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/libs/jquery-1.6.2.min.js"</span><span class="nt">&gt;</span><span class="err">&lt;\\/script&gt;')</span>

        // scripts concatenated and minified via ant build script
        script(src="js/mylibs/underscore.js")
        script(src="js/mylibs/backbone.js")
        script(defer, src="js/plugins.js")
        script(defer, src="js/script.js")
        // end scripts

        // Change UA-XXXXX-X to be your site's ID
        script
          window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
          Modernizr.load({load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'});

        //if lt IE 7
          script(src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js")
          script
            window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})
      <span class="nt">&lt;/html&gt;</span>

      </pre></div>

      <p><strong>static.html</strong></p>

      <p>Alternatively, a static version of our index which doesn't rely on Jade can be put together as follows. See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option1/public/static.html">here</a> for the complete file or below for a sample.</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"container"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>

            <span class="c">&lt;!-- Todo App Interface--&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h1&gt;</span>Todos<span class="nt">&lt;/h1&gt;</span>
              <span class="nt">&lt;/div&gt;</span>

              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"create-todo"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">type=</span>
                  "text" /&gt;<span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">class=</span><span class="s">"ui-tooltip-top"</span><span class="nt">&gt;</span>Press Enter to
                  save this task<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todos"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todo-stats"</span><span class="nt">&gt;&lt;/div&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>


          <span class="c">&lt;!-- Templates--&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"item-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"display"</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"check"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">done</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;</span> <span class="err">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-text"</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;span id="todo-destroy"&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class="edit"&gt;&lt;input type="text" value="" class="todo-input"/&gt;&lt;/div&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"stats-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number"</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;</span> <span class="o">&lt;</span><span class="err">/span&gt;&lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.</span>
            <span class="o">&lt;</span><span class="err">/span&gt;&lt;% } %&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-clear"</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span> <span class="nx">Clear</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt; completed</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"word-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">'item'</span> <span class="o">:</span> <span class="s1">'items'</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;% } %&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="c">&lt;!--! end of #container--&gt;</span>
      </pre></div>

      <h3>
      <a name="user-content-practical-setup" class="anchor" href="#practical-setup"><span class="octicon octicon-link"></span></a>Practical Setup</h3>

      <p>We've now gone through the major points of developing a RESTful backend using Node.js, Express and Mongoose. Next, let's make sure you can get your environment setup to run the updated Todo app.</p>

      <h4>
      <a name="user-content-mongodb" class="anchor" href="#mongodb"><span class="octicon octicon-link"></span></a>MongoDB</h4>

      <p>Once you've downloaded <a href="http://www.mongodb.org/downloads">MongoDB</a>, you'll need to complete two steps to get it up and running.</p>

      <p><strong>Data directories</strong></p>

      <p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted MongoDB and run the following from terminal:</p>

      <div class="highlight highlight-html"><pre>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </pre></div>

      <p><strong>Running and connecting to your server</strong></p>

      <p>Once this is done, open up two terminal windows.</p>

      <p>In the first, <code>cd</code> to your MongoDB bin directory or type in the complete path to it. You'll need to start <code>mongod</code>.</p>

      <div class="highlight highlight-html"><pre>$ ./bin/mongod
      </pre></div>

      <p>Next, in the second terminal, start the <code>mongo</code> shell which will connect up to localhost by default.</p>

      <div class="highlight highlight-html"><pre>$ ./bin/mongo
      </pre></div>

      <p>That's it!.</p>

      <h4>
      <a name="user-content-express-and-mongoose" class="anchor" href="#express-and-mongoose"><span class="octicon octicon-link"></span></a>Express and Mongoose</h4>

      <p>Option 1 (HTML) and Option 2 (Jade) of the practical download both come with an install.sh bash script. This allows you to easily install Express, Mongoose, Jade (and optionally MongoDB if you prefer to) through npm (the node package manager).</p>

      <ul>
      <li>Make sure you have Node.js installed. If not, you can grab it <a href="http://nodejs.org/#download">here</a>
      </li>
      <li>Next run <code>$ ./install.sh</code> at the terminal to install the rest of our dependencies. To see the exact contents of the install.sh file, see below:</li>
      </ul><p><strong>install.sh</strong></p>

      <div class="highlight highlight-html"><pre>#!/bin/bash
      npm install express
      npm install mongodb --mongodb:native
      npm install mongoose
      npm install jade
      </pre></div>

      <ul>
      <li>After you've installed all of the dependencies for the stack, we can get to cloning the repo containing our practicals and running them. Start by running the below lines:</li>
      </ul><div class="highlight highlight-html"><pre>git clone git://github.com/addyosmani/backbone-boilerplates.git
      cd option2
      node app.js
      </pre></div>

      <p>For option1 (without Jade), simply cd into option1 and run <code>node app.js</code> from there.</p>

      <p>Finally, either of the example apps can now be accessed by navigating to:</p>

      <ul>
      <li>Option 1: <code>http://localhost:3000/static.html</code>
      </li>
      <li>Option 2: <code>http://localhost:3000/todo</code>
      </li>
      </ul><p>That's it! Whilst there's a lot more than can be done to expand on the concepts covered so far, the base we're reviewed should be enough to get you up and running with this stack if you wish to use it with Backbone.</p>

      <h1>
      <a name="user-content-building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml" class="anchor" href="#building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml"><span class="octicon octicon-link"></span></a>Building Backbone.js Apps With Ruby, Sinatra, MongoDB and Haml</h1>

      <h2>
      <a name="user-content-introduction-1" class="anchor" href="#introduction-1"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>In this chapter we're going to explore writing Backbone.js applications with a Ruby back-end. To assist with this, we're going to use <a href="http://www.sinatrarb.com/">Sinatra</a> - a DSL (domain specific language) for rapidly creating web applications in Ruby. Similar to the <a href="https://github.com/addyosmani/backbone-fundamentals/#stack1">section</a> on writing an application with Node.js, our server-side language (Ruby) will be used to power an API whilst Backbone.js will be the client consuming it.</p>

      <h2>
      <a name="user-content-what-is-sinatra" class="anchor" href="#what-is-sinatra"><span class="octicon octicon-link"></span></a>What Is Sinatra?</h2>

      <p>In the past, you've likely come across or used <a href="http://rubyonrails.org">Ruby on Rails</a> (RoR) - a popular web application framework for the Ruby programming language that helps organize applications using the MVC pattern. Sinatra is a much smaller, more light-weight alternative to it.</p>

      <p>Whilst a very basic Rails application may require a more strict project structure (such as requiring the use of controllers, views and routing etc.), Sinatra doesn't require as many of these dependencies, sacrificing the helpers needed to connect to databases, tools to create forms or any of the other utilities Rails comes with out of the box.</p>

      <p>What Sinatra does have is a <strong>minimal</strong> set of features most useful for tying specific URLs and RESTful HTTP actions to blocks of Ruby code and returning this code's output as a response. Sinatra is particularly useful for getting projects up and running quickly where we don't have a need for the extra pieces RoR provides.</p>

      <p>For those who are familiar with more Rails, you probably know that it requires a separate routes file to define how an application should be responding to requests. These are then piped into the relevant models and controllers as needed.</p>

      <p>Sinatra takes a more straight-forward approach, providing us with the most simple path to handling routing. By declaring <code>get</code>,<code>post</code>, <code>put</code> or <code>delete</code> actions, we can inform Sinatra to add a new route, which we can then have respond to requests.</p>

      <p>The framework is particularly useful for writing APIs, widgets and small-scale applications that can power the backend of a client-heavy application. As mentioned, we will be using it to power our API.</p>

      <h2>
      <a name="user-content-getting-started-with-sinatra" class="anchor" href="#getting-started-with-sinatra"><span class="octicon octicon-link"></span></a>Getting Started With Sinatra</h2>

      <p>Let's review how to write and run a very basic Sinatra application. As most programming languages and frameworks typically start with some variation of "Hello World", we'll start with a similar example.</p>

      <p>Note: Before beginning this section, I recommend installing Sinatra on your system. A guide to doing this can be found in the <a href="#preq">prerequisites</a> section lower down in the article.</p>

      <h3>
      <a name="user-content-routes" class="anchor" href="#routes"><span class="octicon octicon-link"></span></a>Routes</h3>

      <p>As mentioned, Sinatra allows us to define new routes using HTTP actions. Semantically, a route follows quite a simple structure:</p>

      <div class="highlight highlight-ruby"><pre><span class="o">&lt;</span><span class="n">a</span> <span class="no">HTTP</span> <span class="n">action</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">desired</span> <span class="n">route</span><span class="o">&gt;</span> <span class="k">do</span>
         <span class="c1"># some behaviour</span>
      <span class="k">end</span>
      </pre></div>

      <p>A tiny route that outputs a "Hello World"-like message when we attempt to "get" the root could thus be written as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'sinatra'</span>

      <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
         <span class="s2">"Hello World! Is it me you're looking for?"</span>
      <span class="k">end</span>
      </pre></div>

      <p>To run this snippet, we can can simply save it to a local '.rb' file and execute it as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">ruby</span> <span class="o">-</span><span class="n">rubygems</span> <span class="n">example</span><span class="o">.</span><span class="n">rb</span>
      </pre></div>

      <p>If we now navigated to http://localhost:4567 in our browser we could now see the application running successfully.</p>

      <p>The HTTP verbs we commonly work with when writing RESTful web services are: <code>get</code>, <code>post</code>, <code>delete</code> and <code>put</code>. As we now know, all Sinatra routes are basically HTTP actions (<code>get</code> etc.) that are paired with a URL-matching pattern. We associate a pair of an action and route with code we would like sent back to the browser (executed)if the route is reached. Sinatra doesn't enforce much in the way of architectural structure, instead relying on simplicity to supporting writing powerful APIs.</p>

      <p>Here's an example of a skeleton service we could put together supporting four common HTTP actions:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="c1"># list all items available</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># get a single item</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/item'</span> <span class="k">do</span>
        <span class="c1"># create a new item</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># update an existing item</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># delete an item</span>
      <span class="k">end</span>
      </pre></div>

      <p>Sinatra's routing is both easy for beginners to get started with but is also flexible enough for those wishing to define more complex routes. As you probably noticed in the above example, routes can include named parameters (e.g <code>/item/:id</code>). We can actually access the content of these routes using the <code>params</code> hash as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># this matches "GET /item/10" and "GET /item/11"</span>
        <span class="c1"># params[:id] is "10" or "11"</span>
        <span class="s2">"You reached </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
      </pre></div>

      <p>Sinatra also supports route matching via splats, wildcards and regular expressions. For more information on this I recommend reading the official <a href="http://www.sinatrarb.com/documentation">docs</a>. Let's now take a look at handlers.</p>

      <p>Sinatra includes convenient handler methods for tasks such as redirection, halting and passing.</p>

      <h4>
      <a name="user-content-redirection" class="anchor" href="#redirection"><span class="octicon octicon-link"></span></a>Redirection</h4>

      <p>A simple route supporting redirection which returns a 302 response can be written as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
            <span class="n">redirect</span> <span class="s1">'/items/welcome'</span>
      <span class="k">end</span>
      </pre></div>

      <p>And if we wish to pass additional parameters such as arguments we can do so like this:
      redirect '<a href="http://site.com/">http://site.com/</a>', 'Oops! I think we have a problem!'</p>

      <h4>
      <a name="user-content-halting" class="anchor" href="#halting"><span class="octicon octicon-link"></span></a>Halting</h4>

      <p>To immediately stop a request (halting) we can use 'halt'. Heres an example of halting a request where we specify the message body:</p>

      <p><code>halt "who goes there!?"</code></p>

      <h4>
      <a name="user-content-passing" class="anchor" href="#passing"><span class="octicon octicon-link"></span></a>Passing</h4>

      <p>'Passing' is the concept of deferring processing of a block to the next matching route. We do this using <code>pass</code>. In the following example if a parameter isnt the username we expect (rick-astley) we simply pass it on:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/members/:username'</span> <span class="k">do</span>
       <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'rick-astley'</span>
       <span class="s1">'Never gonna give you up, never gonna let you down'</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/members/*'</span> <span class="k">do</span>
       <span class="s1">'Welcome!'</span>
      <span class="k">end</span>
      </pre></div>

      <p>There are also handler methods that can assist with sessions (specifically, cookie-based session handling). To use Sinatra's session handling, first enable it in your application with:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">enable</span> <span class="ss">:sessions</span>
      </pre></div>

      <p>You can then use the session handling capabilities as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="s2">"This page has been accessed </span><span class="si">#{</span><span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span><span class="si">}</span><span class="s2"> times"</span>
      <span class="k">end</span>
      </pre></div>

      <p>Note: By default enable:sessions will store all data in cookies. If this is not desired, you can not call this and instead use some Rack middleware instead. For more on this see <a href="http://www.sinatrarb.com/intro#Using%20Sessions">here</a>.</p>

      <p>This only touches the surface of what can be done using routes and handlers, but is sufficient for us to write the Sinatra-powered API service we require in the practical section of this chapter.</p>

      <h2>
      <a name="user-content-templating-and-haml" class="anchor" href="#templating-and-haml"><span class="octicon octicon-link"></span></a>Templating And HAML</h2>

      <p>Let's now discuss templating.Out of the box, we can begin using templates in our Sinatra applications with ERB. ERB is included with Ruby and allows Ruby code to be added to any plain text document for the purpose of generating information or flow control. In the following example using an ERB template, note that views are by default located in the <code>views</code> directory of our application.</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">erb</span> <span class="ss">:default</span>
        <span class="c1"># renders views/default.erb</span>
      <span class="k">end</span>
      </pre></div>

      <p>A useful Sinatra convention worth noting is how layouts are handled. Layouts automatically search for a views/layout template which is rendered before any other views are loaded. With ERB, our views/layout.erb file could look as follows:</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;html&gt;</span>
        <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
        <span class="nt">&lt;body&gt;</span>
          <span class="err">&lt;</span>%= data %&gt;
        <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>Haml is a popular alternative to ERB which offers an abstract syntax for writing application templates. It has been said to be:</p>

      <ul>
      <li>Straight-forward to learn</li>
      <li>Very easy to read and use for visually expressing a hierarchy of DOM elements</li>
      <li>Popular with web designers as it builds on top of CSS syntax</li>
      <li>Well documented with a large community backing it</li>
      <li>Almost as fast as ERB</li>
      </ul><p>For the purpose of comparison, below we can see an ERB template compared to its Haml equivalent.</p>

      <h4>
      <a name="user-content-erb" class="anchor" href="#erb"><span class="octicon octicon-link"></span></a>ERB</h4>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo"</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"entry_title"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= h @todo.title %&gt;<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"entry_link"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= link_to('link', @todo.link) %&gt;<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre></div>

      <h4>
      <a name="user-content-haml" class="anchor" href="#haml"><span class="octicon octicon-link"></span></a>Haml</h4>

      <div class="highlight highlight-html"><pre>.todo#content
        %h2.entry_title= @todo.title
        .entry_link= link_to('link', @todo.link)
      </pre></div>

      <p>One of the first things we notice is that the Haml snippet looks significantly more like CSS than it does traditional markup. It's much easier to read and we no longer need to be concerned with divs, spans, closing tags or other semantic rules that usually mean more keystrokes. The approach taken to making whitespace a part of the syntax also means it can be much easier to compare changes between multiple documents (especially if you're doing a diff).</p>

      <p>In the list of Haml features, we briefly mentioned web designers. As developers, we regularly need to communicate and work with designers, but we always have to remember that at the end of the day, they are not programmers. They're usually more concerned with the look and the feel of an application, but if we want them to write mark-up as a part of the templates or skins they create, Haml is a simpler option that has worked well for teams at a number of companies.</p>

      <div class="highlight highlight-ruby"><pre><span class="o">%</span><span class="n">h1</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h1</span> <span class="n">text</span>
      <span class="o">%</span><span class="n">h2</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h2</span> <span class="n">text</span><span class="o">.</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="n">line</span> <span class="n">containing</span> <span class="n">a</span> <span class="n">single</span> <span class="n">instance</span> <span class="ss">variable</span><span class="p">:</span> <span class="vi">@content</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="vi">@content</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Embedding</span> <span class="no">Ruby</span> <span class="n">code</span> <span class="k">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">line</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">using</span> <span class="o">==.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">==</span> <span class="no">Here</span> <span class="n">is</span> <span class="n">an</span> <span class="ss">example</span><span class="p">:</span> <span class="c1">#{@foobar}</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">We</span> <span class="n">can</span> <span class="n">also</span> <span class="n">add</span> <span class="n">attributes</span> <span class="n">using</span> <span class="p">{}</span>
      <span class="o">%</span><span class="nb">p</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">"color:green"</span><span class="p">}</span> <span class="no">We</span> <span class="n">just</span> <span class="n">made</span> <span class="n">this</span> <span class="n">paragraph</span> <span class="n">green!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">You</span><span class="err">'</span><span class="n">ll</span> <span class="n">want</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">ids</span> <span class="n">to</span> <span class="n">your</span> <span class="no">DOM</span><span class="p">,</span> <span class="n">too</span><span class="o">.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">foo</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">bar</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">bar</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="c1">#foobar This has the foobar id</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span><span class="c1">#foobar Or you can combine them!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Nesting</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">like</span> <span class="n">this</span>
      <span class="o">%</span><span class="nb">p</span>
        <span class="no">Or</span> <span class="n">even</span> <span class="n">like</span> <span class="n">this</span>

      </pre></div>

      <p>Note: Haml is whitespace sensitive and will not correctly work if it isn't indented by an even number of spaces. This is due to whitespace being used for nesting in place of the classic HTML markup approach of closing tags.</p>

      <h1>
      <a name="user-content-mongodb-ruby-driver" class="anchor" href="#mongodb-ruby-driver"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h1>

      <h2>
      <a name="user-content-getting-started-1" class="anchor" href="#getting-started-1"><span class="octicon octicon-link"></span></a>Getting started</h2>

      <p>Once the MongoDB Ruby driver is installed, we can begin to use it to connect to a Mongo database. To create a  connection using localhost, we simply specify the driver as a dependency. Assuming we're using the default port we can then connect as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'mongo'</span>

      <span class="c1"># where 'learning-mongo' is the name of our database:</span>
      <span class="n">db</span> <span class="o">=</span> <span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'learning-mongo'</span><span class="p">);</span>
      </pre></div>

      <p>We probably also want to place some data into 'learning-mongo'. It could be as simple as a note, so why don't we go ahead and begin a notes collection?:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">notes</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">)</span>
      </pre></div>

      <p>Something interesting worth noting is that at this point, we haven't actually created the database nor the collection we're referencing above.</p>

      <p>Neither of these items exist in Mongo (just yet) but as we're working with a new database but they will once we insert some real data.</p>

      <p>A new note could be defined using key/value pairs as follows and then inserted into 'learning-mongo' using <code>collection.insert()</code>:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">our_note</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">'Remember the milk'</span><span class="p">,</span> <span class="ss">:remindInterval</span> <span class="o">=&gt;</span> <span class="s1">'weekly'</span><span class="p">}</span>
      <span class="n">note_id</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">our_note</span><span class="p">)</span>
      </pre></div>

      <p>What is returned from inserting a note into the notes collection is an <code>ObjectId</code> reference for the note from Mongo. This is useful as we can re-use it to locate the same document in our database.</p>

      <div class="highlight highlight-ruby"><pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      </pre></div>

      <p>This can also be used in conjunction with Mongo's <code>collection.update()</code> method and <a href="http://www.mongodb.org/display/DOCS/Updating">query</a> operators (i.e <code>$set</code>) to replace fields in an existing document.</p>

      <p>We might update an entire document as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="n">note</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Remember the bread'</span>
      <span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="n">note</span><span class="p">)</span>
      </pre></div>

      <p>or using <code>$set</code>, update an existing document without overwriting the entire object as like this:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=</span> <span class="o">&gt;</span> <span class="s1">'Remember the bread'</span> <span class="p">})</span>
      </pre></div>

      <p>Useful to know: Almost each MongoDB document has an _id field as its first attribute. This can normally
      be of any type, however a special BSON datatype is provided for object ids. It's a
      12-byte binary value that has a high probability of being unique when allocated.</p>

      <p>Note: Whilst we opted for the MongoDB Ruby Driver for this stack, you may also be interested in <strong>DataMapper</strong> - a solution which allows us to use the same API to talk to a number of different datastores. This works well for both relational and non-relational databases and more information is available on the official <a href="http://datamapper.org/why.html">project page</a>. <a href="http://sinatra-book.gittr.com/#datamapper">Sinatra: The Book</a> also contains a brief tutorial on DataMapper for anyone interested in exploring it further.</p>

      <h1>
      <a name="user-content-practical-1" class="anchor" href="#practical-1"><span class="octicon octicon-link"></span></a>Practical</h1>

      <p>We're going to use Sinatra in a similar manner to how we used Express in the last chapter. It will power a RESTful API supporting CRUD operations. Together with a MongoDB data store, this will allow us to easily persist data (todo items) whilst ensuring they are stored in a database. If you've read the previous chapter or have gone through any of the Todo examples covered so far, you will find this surprisingly straight-forward.</p>

      <p>Remember that the default Todo example included with Backbone.js already persists data, although it does this via a localStorage adapter. Luckily there aren't a great deal of changes needed to switch over to using our Sinatra-based API.  Let's briefly review the code that will be powering the CRUD operations for this sections practical, as we won't be starting off with a near-complete base for most of our real world applications.</p>

      <h3>
      <a name="user-content-installing-the-prerequisites" class="anchor" href="#installing-the-prerequisites"><span class="octicon octicon-link"></span></a>Installing The Prerequisites</h3>

      <h4>
      <a name="user-content-ruby" class="anchor" href="#ruby"><span class="octicon octicon-link"></span></a>Ruby</h4>

      <p>If using OSX or Linux, Ruby may be one of a number of open-source packages that come pre-installed and you can skip over to the next paragraph. In case you would like to check if check if you have Ruby installed, open up the terminal prompt and type:</p>

      <p><code>$ ruby -v</code></p>

      <p>The output of this will either be the version of Ruby installed or an error complaining that Ruby wasn't found.</p>

      <p>Should you need to install Ruby manually (e.g for an operating system such as Windows), you can do so by downloading the latest version from <a href="http://www.ruby-lang.org/en/downloads/">http://www.ruby-lang.org/en/downloads/</a>. Alternatively, <a href="http://beginrescueend.com/rvm/install/">RVM</a> (Ruby Version Manager) is a command-line tool that allows you to easily install and manage multiple ruby environments with ease.</p>

      <h4>
      <a name="user-content-ruby-gems" class="anchor" href="#ruby-gems"><span class="octicon octicon-link"></span></a>Ruby Gems</h4>

      <p>Next, we will need to install Ruby Gems. Gems are a standard way to package programs or libraries written in Ruby and with Ruby Gems it's possible to install additional dependencies for Ruby applications very easily.</p>

      <p>On OSX, Linux or Windows go to <a href="http://rubyforge.org/projects/rubygems">http://rubyforge.org/projects/rubygems</a> and download the latest version of Ruby Gems. Once downloaded, open up a terminal, navigate to the folder where this resides and enter:</p>

      <pre><code>$&gt; tar xzvf rubygems.tgz
      $&gt; cd rubygems
      $&gt; sudo ruby setup.rb
      </code></pre>

      <p>There will likely be a version number included in your download and you should make sure to include this when tying the above. Finally, a symlink (symbolic link) to tie everything togther should be run as follows:</p>

      <p><code>$ sudo ln -s /usr/bin/gem1.8.17 /usr/bin/gem</code></p>

      <p>To check that Ruby Gems has been correctly installed, type the following into your terminal:</p>

      <pre><code>$ gem -v
      </code></pre>

      <h4>
      <a name="user-content-sinatra" class="anchor" href="#sinatra"><span class="octicon octicon-link"></span></a>Sinatra</h4>

      <p>With Ruby Gems setup, we can now easily install Sinatra. For Linux or OSX type this in your terminal:</p>

      <p><code>$ sudo gem install sinatra</code></p>

      <p>and if you're on Windows, enter the following at a command prompt:</p>

      <p><code>c:\&gt; gem install sinatra</code></p>

      <h4>
      <a name="user-content-haml-1" class="anchor" href="#haml-1"><span class="octicon octicon-link"></span></a>Haml</h4>

      <p>As with other DSLs and frameworks, Sinatra supports a wide range of different templating engines. <a href="http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html">ERB</a> is the one most often recommended by the Sinatra camp, however
      as a part of this chapter, we're going to explore the use of <a href="http://haml.hamptoncatlin.com/">Haml</a> to define our application templates.</p>

      <p>Haml stands for HTML Abstractional Markup Language and is a lightweight markup language abstraction that can be used to describe HTML without the need to use traditional markup language semantics (such as opening and closing tags).</p>

      <p>Installing Haml can be done in just a line using Ruby Gems as follows:</p>

      <p><code>$ gem install haml</code></p>

      <h4>
      <a name="user-content-mongodb-1" class="anchor" href="#mongodb-1"><span class="octicon octicon-link"></span></a>MongoDB</h4>

      <p>If you haven't already downloaded and installed MongoDB from an earlier chapter, please <a href="http://www.mongodb.org/downloads">do so</a> now. With Ruby Gems, Mongo can be installed in just one line:</p>

      <p><code>$ gem install mongodb</code></p>

      <p>We now require two further steps to get everything up and running.</p>

      <h5>
      <a name="user-content-1data-directories" class="anchor" href="#1data-directories"><span class="octicon octicon-link"></span></a>1.Data directories</h5>

      <p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted Mongo and run the following from terminal:</p>

      <pre><code>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </code></pre>

      <h5>
      <a name="user-content-2running-and-connecting-to-your-server" class="anchor" href="#2running-and-connecting-to-your-server"><span class="octicon octicon-link"></span></a>2.Running and connecting to your server</h5>

      <p>Once this is done, open up two terminal windows.</p>

      <p>In the first, cd to your MongoDB bin directory or type in the complete path to it. You'll need to start mongod.</p>

      <pre><code>$ ./bin/mongod
      </code></pre>

      <p>Finally, in the second terminal, start the mongo shell which will connect up to localhost by default.</p>

      <pre><code>$ ./bin/mongo
      </code></pre>

      <h4>
      <a name="user-content-mongodb-ruby-driver-1" class="anchor" href="#mongodb-ruby-driver-1"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h4>

      <p>As we'll be using the <a href="https://github.com/mongodb/mongo-ruby-driver">MongoDB Ruby Driver</a>, we'll also require the following gems:</p>

      <p>The gem for the driver itself:</p>

      <pre><code>$ gem install mongo
      </code></pre>

      <p>and the driver's other prerequisite, bson:</p>

      <pre><code>$ gem install bson_ext
      </code></pre>

      <p>This is basically a collection of extensions used to increase serialization speed.</p>

      <p>That's it for our prerequisites!.</p>

      <h2>
      <a name="user-content-tutorial" class="anchor" href="#tutorial"><span class="octicon octicon-link"></span></a>Tutorial</h2>

      <p>To get started, let's get a local copy of the practical application working on our system.</p>

      <h3>
      <a name="user-content-application-files" class="anchor" href="#application-files"><span class="octicon octicon-link"></span></a>Application Files</h3>

      <p>Clone <a href="http://github.com/addyosmani/backbone-fundamentals">this</a> repository and navigate to <code>/practicals/stacks/option3</code>. Now run the following lines at the terminal:</p>

      <pre><code>ruby app.rb
      </code></pre>

      <p>Finally, navigate to <code>http://localhost:4567/todo</code> to see the application running successfully.</p>

      <p><strong>Note:</strong> The Haml layout files for Option 3 can be found in the /views folder.</p>

      <p>The directory structure for our practical application is as follows:</p>

      <pre><code>--public
      ----css
      ----img
      ----js
      -----script.js
      ----test
      --views
      app.rb

      </code></pre>

      <p>The <code>public</code> directory contains the scripts and stylesheets for our application and uses HTML5 Boilerplate as a base. You can find the Models, Views and Collections for this section within <code>public/js/scripts.js</code> (however, this can of course be expanded into sub-directories for each component if desired).</p>

      <p><code>scripts.js</code> contains the following Backbone component definitions:</p>

      <pre><code>--Models
      ----Todo

      --Collections
      ----TodoList

      --Views
      ---TodoView
      ---AppView
      </code></pre>

      <p><code>app.rb</code> is the small Sinatra application that powers our backend API.</p>

      <p>Lastly, the <code>views</code> directory hosts the Haml source files for our application's index and templates, both of which are compiled to standard HTML markup at runtime.</p>

      <p>These can be viewed along with other note-worthy snippets of code from the application below.</p>

      <h3>
      <a name="user-content-backbone" class="anchor" href="#backbone"><span class="octicon octicon-link"></span></a>Backbone</h3>

      <h4>
      <a name="user-content-views-2" class="anchor" href="#views-2"><span class="octicon octicon-link"></span></a>Views</h4>

      <p>In our main application view (AppView), we want to load any previously stored Todo items in our Mongo database when the view initializes. This is done below with the line <code>Todos.fetch()</code> in the <code>initialize()</code> method where we also bind to the relevant events on the <code>Todos</code> collection for when items are added or changed.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
      <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>  <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'keyup #new-todo'</span><span class="o">:</span>     <span class="s1">'showTooltip'</span><span class="p">,</span>
            <span class="s1">'click .todo-clear a'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'all'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>
       <span class="err">…</span><span class="p">.</span>
      </pre></div>

      <h3>
      <a name="user-content-collections-1" class="anchor" href="#collections-1"><span class="octicon octicon-link"></span></a>Collections</h3>

      <p>In the TodoList collection below, we've set the <code>url</code> property to point to <code>/api/todos</code> to reference the collection's location on the server. When we attempt to access this from our Sinatra-backed API, it should return a list of all the Todo items that have been previously stored in Mongo.</p>

      <p>For the sake of thoroughness, our API will also support returning the data for a specific Todo item via <code>/api/todos/itemID</code>. We'll take a look at this again when writing the Ruby code powering our backend.</p>

      <div class="highlight highlight-javascript"><pre> <span class="c1">// Todo Collection</span>

        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-model" class="anchor" href="#model"><span class="octicon octicon-link"></span></a>Model</h3>

      <p>The model for our Todo application remains largely unchanged from the versions previously covered in this book. It is however worth noting that calling the function <code>model.url()</code> within the below would return the relative URL where a specific Todo item could be located on the server.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// Our basic **Todo** model has `text`, `order`, and `done` attributes.</span>
        <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">'_id'</span><span class="p">,</span>

          <span class="c1">// Default attributes for a todo item.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">()</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>
        <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-rubysinatra" class="anchor" href="#rubysinatra"><span class="octicon octicon-link"></span></a>Ruby/Sinatra</h3>

      <p>Now that we've defined our main models, views and collections let's get the CRUD operations required by our Backbone application supported in our Sinatra API.</p>

      <p>We want to make sure that for any operations changing underlying data (create, update, delete) that our Mongo data store correctly reflects these.</p>

      <h3>
      <a name="user-content-apprb" class="anchor" href="#apprb"><span class="octicon octicon-link"></span></a>app.rb</h3>

      <p>For <code>app.rb</code>, we first define the dependencies required by our application. These include Sinatra, Ruby Gems, the MongoDB Ruby driver and the JSON gem.</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'rubygems'</span>
      <span class="nb">require</span> <span class="s1">'sinatra'</span>
      <span class="nb">require</span> <span class="s1">'mongo'</span>
      <span class="nb">require</span> <span class="s1">'json'</span>
      </pre></div>

      <p>Next, we create a new connection to Mongo, specifying any custom configuration desired. If running a multi-threaded application, setting the 'pool_size' allows us to specify a maximum pool size and 'timeout' a maximum timeout for waiting for old connections to be released to the pool.</p>

      <div class="highlight highlight-ruby"><pre><span class="no">DB</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'mydb'</span><span class="p">,</span> <span class="ss">:pool_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span>
      </pre></div>

      <p>Finally we define the routes to be supported by our API. Note that in the first two blocks - one for our
      application root (<code>/</code>) and the other for our todo items route <code>/todo</code> - we're using Haml for template rendering.</p>

      <div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">TodoApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>

          <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'hello'</span><span class="p">}</span>
          <span class="k">end</span>

          <span class="n">get</span> <span class="s1">'/todo'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:todo</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'Our Sinatra Todo app'</span><span class="p">}</span>
          <span class="k">end</span>
      </pre></div>

      <p><code>haml :index</code> instructs Sinatra to use the <code>views/index.haml</code> for the application index, whilst <code>attr_wrapper</code> is simply defining the values to be used for any local variables defined inside the template.
      This similarly applies Todo items with the template `views/todo.haml'.</p>

      <p>The rest of our routes make use of the <code>params</code> hash and a number of useful helper methods included with the MongoDB Ruby driver. For more details on these, please
      read the comments I've made inline below:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># query a collection :thing, convert the output to an array, map the _id</span>
        <span class="c1"># to a string representation of the object's _id and finally output to JSON</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">from_bson_id</span><span class="p">(</span><span class="n">t</span><span class="p">)}</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># get the first document with the id :id in the collection :thing as a single document (rather</span>
        <span class="c1"># than a Cursor, the standard output) using find_one(). Our bson utilities assist with</span>
        <span class="c1"># ID conversion and the final output returned is also JSON</span>
        <span class="n">from_bson_id</span><span class="p">(</span><span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)))</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># parse the post body of the content being posted, convert to a string, insert into</span>
        <span class="c1"># the collection #thing and return the ObjectId as a string for reference</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">))</span>
        <span class="s2">"{</span><span class="se">\"</span><span class="s2">_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="si">#{</span><span class="n">oid</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="se">\"</span><span class="s2">}"</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># remove the item with id :id from the collection :thing, based on the bson</span>
        <span class="c1"># representation of the object id</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># collection.update() when used with $set (as covered earlier) allows us to set single values</span>
        <span class="c1"># in this case, the put request body is converted to a string, rejecting keys with the name '_id' for security purposes</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)},</span> <span class="p">{</span><span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">'_id'</span><span class="p">}})</span>
      <span class="k">end</span>

      <span class="c1"># utilities for generating/converting MongoDB ObjectIds</span>
      <span class="k">def</span> <span class="nf">to_bson_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">end</span>
      <span class="k">def</span> <span class="nf">from_bson_id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="n">obj</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">obj</span><span class="o">[</span><span class="s1">'_id'</span><span class="o">].</span><span class="n">to_s</span><span class="p">})</span> <span class="k">end</span>

      <span class="k">end</span>
      </pre></div>

      <p>That's it. The above is extremely lean for an entire API, but does allow us to read and write data to support the functionality required by our client-side application.</p>

      <p>For more on what MongoDB and the MongoDB Ruby driver are capable of, please do feel free to read their documentation for more information.</p>

      <p>If you're a developer wishing to take this example further, why not try to add some additional capabilities to the service:</p>

      <ul>
      <li>Validation: improved validation of data in the API. What more could be done to ensure data sanitization?</li>
      <li>Search: search or filter down Todo items based on a set of keywords or within a certain date range</li>
      <li>Pagination: only return the Nth number of Todo items or items from a start and end-point</li>
      </ul><h3>
      <a name="user-content-hamltemplates" class="anchor" href="#hamltemplates"><span class="octicon octicon-link"></span></a>Haml/Templates</h3>

      <p>Finally, we move on to the Haml files that define our application index (layout.haml) and the template for a specific Todo item (todo.haml). Both of these are largely self-explanatory, but it's useful to see the differences between the Jade approach we reviewed in the last chapter vs. using Haml for this implementation.</p>

      <p>Note: In our Haml snippets below, the forward slash character is used to indicate a comment. When this character is placed at the beginning of a line, it wraps all of the text after it into a HTML comment. e.g</p>

      <p><code>/ These are templates</code></p>

      <p>compiles to:</p>

      <p><code>&lt;!-- These are templates --&gt;</code></p>

      <h3>
      <a name="user-content-indexhaml" class="anchor" href="#indexhaml"><span class="octicon octicon-link"></span></a>index.haml</h3>

      <div class="highlight highlight-html"><pre>%head
        %meta{'charset' =&gt; 'utf-8'}/
        %title=title
        %meta{'name' =&gt; 'description', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'author', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'viewport', 'content' =&gt; 'width=device-width,initial-scale=1'}/

        / CSS concatenated and minified via ant build script
        %link{'rel' =&gt; 'stylesheet', 'href' =&gt; 'css/style.css'}/
        / end CSS

        %script{'src' =&gt; 'js/libs/modernizr.min.js'}
      %body
        %div#container
          %header
          %div#main
            = yield
          %footer
        /! end of #container

        %script{'src' =&gt; 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'}

        / scripts concatenated and minified via ant build script
        %script{'src' =&gt; 'js/mylibs/underscore.js'}
        %script{'src' =&gt; 'js/mylibs/backbone.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/plugins.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/script.js'}
        / end scripts
      </pre></div>

      <h3>
      <a name="user-content-todohaml" class="anchor" href="#todohaml"><span class="octicon octicon-link"></span></a>todo.haml</h3>

      <div class="highlight highlight-html"><pre>%div#todoapp
        %div.title
          %h1
            Todos
            %div.content
              %div#create-todo
                %input#new-todo{"placeholder" =&gt; "What needs to be done?", "type" =&gt; "text"}/
                %span.ui-tooltip-top{"style" =&gt; "display:none;"} Press Enter to save this task
              %div#todos
                %ul#todo-list
              %div#todo-stats

      / Templates

      %script#item-template{"type" =&gt; "text/template"}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        %div.display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          %div.todo-text
          %span#todo-destroy
        %div.edit
          %input.todo-input{"type" =&gt; "text", "value" =&gt;""}/
        <span class="nt">&lt;/div&gt;</span>

      %script#stats-template{"type" =&gt; "text/template"}
        <span class="err">&lt;</span>% if (total) { %&gt;
        %span.todo-count
          %span.number <span class="err">&lt;</span>%= remaining %&gt;
          %span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        %span.todo-clear
          %a{"href" =&gt; "#"}
            Clear
            %span.number-done <span class="err">&lt;</span>%= done %&gt;
            completed
            %span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre></div>

      <h2>
      <a name="user-content-conclusions-2" class="anchor" href="#conclusions-2"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>In this chapter, we looked at creating a Backbone application backed by an API powered by Ruby, Sinatra, Haml, MongoDB and the MongoDB driver. I personally found developing APIs with Sinatra a relatively painless experience and one which I felt was
      on-par with the effort required for the Node/Express implementation of the same application.</p>

      <p>This section is by no means the most comprehensive guide on building complex apps using all of the items in this particular stack. I do however hope it was an introduction sufficient enough to help you decide on what stack to try out for your next project.</p>

      <h1>
      <a name="user-content-modular-development" class="anchor" href="#modular-development"><span class="octicon octicon-link"></span></a>Modular Development</h1>

      <h2>
      <a name="user-content-introduction-2" class="anchor" href="#introduction-2"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>When we say an application is modular, we generally mean it's composed of a set of highly decoupled, distinct pieces of functionality stored in modules. As you probably know, loose coupling facilitates easier maintainability of apps by removing dependencies where possible. When this is implemented efficiently, its quite easy to see how changes to one part of a system may affect another.</p>

      <p>Unlike some more traditional programming languages however, the current iteration of JavaScript (ECMA-262) doesn't provide developers with the means to import such modules of code in a clean, organized manner. It's one of the concerns with specifications that haven't required great thought until more recent years where the need for more organized JavaScript applications became apparent.</p>

      <p>Instead, developers at present are left to fall back on variations of the module or object literal patterns. With many of these, module scripts are strung together in the DOM with namespaces being described by a single global object where it's still possible to incur naming collisions in your architecture. There's also no clean way to handle dependency management without some manual effort or third party tools.</p>

      <p>Whilst native solutions to these problems will be arriving in ES Harmony, the good news is that writing modular JavaScript has never been easier and you can start doing it today.</p>

      <p>In this next part of the book, we're going to look at how to use AMD modules and RequireJS for cleanly wrapping units of code in your application into manageable modules.</p>

      <h2>
      <a name="user-content-organizing-modules-with-requirejs-and-amd" class="anchor" href="#organizing-modules-with-requirejs-and-amd"><span class="octicon octicon-link"></span></a>Organizing modules with RequireJS and AMD</h2>

      <p>In case you haven't used it before, <a href="http://requirejs.org">RequireJS</a> is a popular script loader written by James Burke - a developer who has been quite instrumental in helping shape the AMD module format, which we'll discuss more shortly. Some of RequireJS's capabilities include helping to load multiple script files, helping define modules with or without dependencies and loading in non-script dependencies such as text files.</p>

      <p>So, why use RequireJS with Backbone? Although Backbone is excellent when it comes to providing a sanitary structure to your applications, there are a few key areas where some additional help could be used:</p>

      <p>1) Backbone doesn't endorse a particular approach to modular-development. Although this means it's quite open-ended for developers to opt for classical patterns like the module-pattern or Object Literals for structuring their apps (which both work fine), it also means developers aren't sure of what works best when other concerns come into play, such as dependency management.</p>

      <p>RequireJS is compatible with the AMD (Asynchronous Module Definition) format, a format which was born from a desire to write something better than the 'write lots of script tags with implicit dependencies and manage them manually' approach to development. In addition to allowing you to clearly declare dependencies, AMD works well in the browser, supports string IDs for dependencies, declaring multiple modules in the same file and gives you easy-to-use tools to avoid polluting the global namespace.</p>

      <p>2) Let's discuss dependency management a little more as it can actually be quite challenging to get right if you're doing it by hand. When we write modules in JavaScript, we ideally want to be able to handle the reuse of code units intelligently and sometimes this will mean pulling in other modules at run-time whilst at other times you may want to do this dynamically to avoid a large pay-load when the user first hits your application.</p>

      <p>Think about the GMail web-client for a moment. When users initially load up the page on their first visit, Google can simply hide widgets such as the chat module until a user has indicated (by clicking 'expand') that they wish to use it. Through dynamic dependency loading, Google could load up the chat module only then, rather than forcing all users to load it when the page first initializes. This can improve performance and load times and can definitely prove useful when building larger applications.</p>

      <p>I've previously written <a href="http://addyosmani.com/writing-modular-js">a detailed article</a> covering both AMD and other module formats and script loaders in case you'd like to explore this topic further. The takeaway is that although it's perfectly fine to develop applications without a script loader or clean module format in place, it can be of significant benefit to consider using these tools in your application development.</p>

      <h3>
      <a name="user-content-writing-amd-modules-with-requirejs" class="anchor" href="#writing-amd-modules-with-requirejs"><span class="octicon octicon-link"></span></a>Writing AMD modules with RequireJS</h3>

      <p>As discussed above, the overall goal for the AMD format is to provide a solution for modular JavaScript that developers can use today. The two key concepts you need to be aware of when using it with a script-loader are a <code>define()</code> method for facilitating module definition and a <code>require()</code> method for handling dependency loading. <code>define()</code> is used to define named or unnamed modules based on the proposal using the following signature:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">(</span>
          <span class="nx">module_id</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="nx">definition</span> <span class="kd">function</span> <span class="cm">/*function for instantiating the module or object*/</span>
      <span class="p">);</span>
      </pre></div>

      <p>As you can tell by the inline comments, the <code>module_id</code> is an optional argument which is typically only required when non-AMD concatenation tools are being used (there may be some other edge cases where it's useful too). When this argument is left out, we call the module 'anonymous'. When working with anonymous modules, the idea of a module's identity is DRY, making it trivial to avoid duplication of filenames and code.</p>

      <p>Back to the define signature, the dependencies argument represents an array of dependencies which are required by the module you are defining and the third argument ('definition function') is a function that's executed to instantiate your module. A barebone module (compatible with RequireJS) could be defined using <code>define()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span>
          <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are mapped to function parameters</span>
          <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-alternate-syntax" class="anchor" href="#alternate-syntax"><span class="octicon octicon-link"></span></a>Alternate syntax</h4>

      <p>There is also a <a href="http://requirejs.org/docs/whyamd.html#sugar">sugared version</a> of <code>define()</code> available that allows you to declare your dependencies as local variables using <code>require()</code>. This will feel familiar to anyone who's used node, and can be easier to add or remove dependencies.
      Here is the previous snippet using the alternate syntax:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">){</span>
              <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are defined as local vars</span>
          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">),</span>
              <span class="nx">bar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>

              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>The <code>require()</code> method is typically used to load code in a top-level JavaScript file or within a module should you wish to dynamically fetch dependencies. An example of its usage is:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Consider 'foo' and 'bar' are two external modules</span>
      <span class="c1">// In this example, the 'exports' from the two modules loaded are passed as</span>
      <span class="c1">// function arguments to the callback (foo and bar)</span>
      <span class="c1">// so that they can similarly be accessed</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// rest of your code here</span>
              <span class="nx">foo</span><span class="p">.</span><span class="nx">doSomething</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p><strong>Wrapping modules, views and other components with AMD</strong></p>

      <p>Now that we've taken a look at how to define AMD modules, let's review how to go about wrapping components like views and collections so that they can also be easily loaded as dependencies for any parts of your application that require them. At it's simplest, a Backbone model may just require Backbone and Underscore.js. These are considered its dependencies and so, to write an AMD model module, we would simply do this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'hello world'</span><span class="p">,</span>
          <span class="p">},</span>

          <span class="c1">// A dummy initialization method</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">myModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>Note how we alias Underscore.js's instance to <code>_</code> and Backbone to just <code>Backbone</code>, making it very trivial to convert non-AMD code over to using this module format. For a view which might require other dependencies such as jQuery, this can similarly be done as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/mycollection'</span><span class="p">,</span>
        <span class="s1">'views/myview'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">myCollection</span><span class="p">,</span> <span class="nx">myView</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="p">...</span>
      </pre></div>

      <p>Aliasing to the dollar-sign (<code>$</code>), once again makes it very easy to encapsulate any part of an application you wish using AMD.</p>

      <h2>
      <a name="user-content-keeping-your-templates-external-using-requirejs-and-the-text-plugin" class="anchor" href="#keeping-your-templates-external-using-requirejs-and-the-text-plugin"><span class="octicon octicon-link"></span></a>Keeping Your Templates External Using RequireJS And The Text Plugin</h2>

      <p>Moving your [Underscore/Mustache/Handlebars] templates to external files is actually quite straight-forward. As this application makes use of RequireJS, I'll discuss how to implement external templates using this specific script loader.</p>

      <p>RequireJS has a special plugin called text.js which is used to load in text file dependencies. To use the text plugin, simply follow these simple steps:</p>

      <ol>
      <li><p>Download the plugin from <a href="http://requirejs.org/docs/download.html#text">http://requirejs.org/docs/download.html#text</a> and place it in either the same directory as your application's main JS file or a suitable sub-directory.</p></li>
      <li><p>Next, include the text.js plugin in your initial RequireJS configuration options. In the code snippet below, we assume that RequireJS is being included in our page prior to this code snippet being executed. Any of the other scripts being loaded are just there for the sake of example.</p></li>
      </ol><div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span> <span class="p">{</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="s1">'backbone'</span><span class="o">:</span>         <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'text'</span><span class="o">:</span>             <span class="s1">'libs/require/text'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'app'</span>
      <span class="p">}</span> <span class="p">);</span>
      </pre></div>

      <ol>
      <li>When the <code>text!</code> prefix is used for a dependency, RequireJS will automatically load the text plugin and treat the dependency as a text resource. A typical example of this in action may look like..</li>
      </ol><div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>
              <span class="c1">// the contents of the mainView file will be</span>
              <span class="c1">// loaded into mainView for usage.</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre></div>

      <ol>
      <li>Finally we can use the text resource that's been loaded for templating purposes. You're probably used to storing your HTML templates inline using a script with a specific identifier.</li>
      </ol><p>With Underscore.js's micro-templating (and jQuery) this would typically be:</p>

      <p>HTML:</p>

      <pre><code>&lt;script type="text/template" id="mainViewTemplate"&gt;
          &lt;% _.each( person, function( person_item ){ %&gt;
              &lt;li&gt;&lt;%= person_item.get('name') %&gt;&lt;/li&gt;
          &lt;% }); %&gt;
      &lt;/script&gt;
      </code></pre>

      <p>JS:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#mainViewTemplate'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">);</span>
      </pre></div>

      <p>With RequireJS and the text plugin however, it's as simple as saving your template into an external text file (say, <code>mainView.html</code>) and doing the following:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>

              <span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">mainView</span> <span class="p">);</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre></div>

      <p>That's it! Now you can apply your template to a view in Backbone with something like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">collection</span><span class="p">.</span><span class="nx">someview</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="nx">compiled_template</span><span class="p">(</span> <span class="p">{</span> <span class="nx">results</span><span class="o">:</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">models</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      </pre></div>

      <p>All templating solutions will have their own custom methods for handling template compilation, but if you understand the above, substituting Underscore's micro-templating for any other solution should be fairly trivial.</p>

      <p><strong>Note:</strong> You may also be interested in looking at <a href="https://github.com/ZeeAgency/requirejs-tpl">RequireJS tpl</a>. It's an AMD-compatible version of the Underscore templating system that also includes support for optimization (pre-compiled templates) which can lead to better performance and no evals. I have yet to use it myself, but it comes as a recommended resource.</p>

      <h2>
      <a name="user-content-optimizing-backbone-apps-for-production-with-the-requirejs-optimizer" class="anchor" href="#optimizing-backbone-apps-for-production-with-the-requirejs-optimizer"><span class="octicon octicon-link"></span></a>Optimizing Backbone apps for production with the RequireJS Optimizer</h2>

      <p>As experienced developers may know, an essential final step when writing both small and large JavaScript web applications is the build process.  The majority of non-trivial apps are likely to consist of more than one or two scripts and so optimizing, minimizing and concatenating your scripts prior to pushing them to production will require your users to download a reduced number (if not just one) script file.</p>

      <p>Note: If you haven't looked at build processes before and this is your first time hearing about them, you might find <a href="http://addyosmani.com/blog/client-side-build-process/">my post and screencast on this topic</a> useful.</p>

      <p>With some other structural JavaScript frameworks, my recommendation would normally be to implicitly use YUI Compressor or Google's closure compiler tools, but we have a slightly more elegant method available, when it comes to Backbone if you're using RequireJS. RequireJS has a command line optimization tool called r.js which has a number of capabilities, including:</p>

      <ul>
      <li>Concatenating specific scripts and minifying them using external tools such as UglifyJS (which is used by default) or Google's Closure Compiler for optimal browser delivery, whilst preserving the ability to dynamically load modules</li>
      <li>Optimizing CSS and stylesheets by inlining CSS files imported using @import, stripping out comments etc.</li>
      <li>The ability to run AMD projects in both Node and Rhino (more on this later)</li>
      </ul><p>You'll notice that I mentioned the word 'specific' in the first bullet point. The RequireJS optimizer only concatenates module scripts that have been specified in arrays of string literals passed to top-level (i.e non-local) require and define calls. As clarified by the <a href="http://requirejs.org/docs/optimization.html">optimizer docs</a> this means that Backbone modules defined like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span><span class="s1">'backbone'</span><span class="p">,</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'collections/sample'</span><span class="p">,</span><span class="s1">'views/test'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span><span class="nx">Backbone</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Sample</span><span class="p">,</span> <span class="nx">Test</span><span class="p">){</span>
              <span class="c1">//...</span>
          <span class="p">});</span>
      </pre></div>

      <p>will combine fine, however inline dependencies such as:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">someCondition</span> <span class="o">?</span> <span class="p">[</span><span class="s1">'models/ab'</span><span class="p">,</span><span class="s1">'models/ac'</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="s1">'models/ba'</span><span class="p">,</span><span class="s1">'models/bc'</span><span class="p">];</span>
      </pre></div>

      <p>will be ignored. This is by design as it ensures that dynamic dependency/module loading can still take place even after optimization.</p>

      <p>Although the RequireJS optimizer works fine in both Node and Java environments, it's strongly recommended to run it under Node as it executes significantly faster there. In my experience, it's a piece of cake to get setup with either environment, so go for whichever you feel most comfortable with.</p>

      <p>To get started with r.js, grab it from the <a href="http://requirejs.org/docs/download.html#rjs">RequireJS download page</a> or <a href="http://requirejs.org/docs/optimization.html#download">through NPM</a>. Now, the RequireJS optimizer works absolutely fine for single script and CSS files, but for most cases you'll want to actually optimize an entire Backbone project. You <em>could</em> do this completely from the command-line, but a cleaner option is using build profiles.</p>

      <p>Below is an example of a build file taken from the modular jQuery Mobile app referenced later in this book. A <strong>build profile</strong> (commonly named <code>app.build.js</code>) informs RequireJS to copy all of the content of <code>appDir</code> to a directory defined by <code>dir</code> (in this case <code>../release</code>). This will apply all of the necessary optimizations inside the release folder. The <code>baseUrl</code> is used to resolve the paths for your modules. It should ideally be relative to <code>appDir</code>.</p>

      <p>Near the bottom of this sample file, you'll see an array called <code>modules</code>. This is where you specify the module names you wish to have optimized. In this case we're optimizing the main application called 'app', which maps to <code>appDir/app.js</code>. If we had set the <code>baseUrl</code> to 'scripts', it would be mapped to <code>appDir/scripts/app.js</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'../release'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
             <span class="s1">'backbone'</span><span class="o">:</span>          <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'app'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span>
                      <span class="c1">// If you prefer not to include certain libs exclude them here</span>
                  <span class="p">]</span>
              <span class="p">}</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre></div>

      <p>The way the build system in r.js works is that it traverses app.js (whatever modules you've passed) and resolved dependencies, concatenating them into the final <code>release</code>(dir) folder. CSS is treated the same way.</p>

      <p>The build profile is usually placed inside the 'scripts' or 'js' directory of your project. As per the docs, this file can however exist anywhere you wish, but you'll need to edit the contents of your build profile accordingly.</p>

      <p>Finally, to run the build, execute the following command once inside your <code>appDir</code> or <code>appDir/scripts</code> directory:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">node</span> <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">r</span><span class="p">.</span><span class="nx">js</span> <span class="o">-</span><span class="nx">o</span> <span class="nx">app</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">js</span>
      </pre></div>

      <p>That's it. As long as you have UglifyJS/Closure tools setup correctly, r.js should be able to easily optimize your entire Backbone project in just a few key-strokes. If you would like to learn more about build profiles, James Burke has a <a href="https://github.com/jrburke/r.js/blob/master/build/example.build.js">heavily commented sample file</a> with all the possible options available.</p>

      <h2>
      <a name="user-content-optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages" class="anchor" href="#optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages"><span class="octicon octicon-link"></span></a>Optimize and Build a Backbone.js JavaScript application with RequireJS using Packages</h2>

      <p><em>Contributed by <a href="https://github.com/pixelhandler">Bill Heaton</a></em></p>

      <p>When a JavaScript application is too complex or large to build in a single file, grouping the application’s components into packages allows for script dependencies to download in parallel, and facilitates only loading <strong>packaged</strong> and other modular code as the site experience requires the specific set of dependencies.</p>

      <p>RequireJS, the (JavaScript) module loading library, has an <a href="http://requirejs.org/docs/optimization.html" title="RequireJS optimizer">optimizer</a> to build a JavaScript-based application and provides various options. A build profile is the recipe for your build, much like a build.xml file is used to build a project with ANT. The benefit of building with <strong>r.js</strong> not only results in speedy script loading with minified code, but also provides a way to package components of your application.</p>

      <ul>
      <li><a href="http://requirejs.org/docs/optimization.html#onejs" title="Optimizing one JavaScript file">Optimizing one JavaScript file</a></li>
      <li><a href="http://requirejs.org/docs/optimization.html#wholeproject" title="Optimizing a whole project">Optimizing a whole project</a></li>
      <li><a href="http://requirejs.org/docs/faq-optimization.html#priority" title="Optimizing a project in layers or packages">Optimizing a project in layers or packages</a></li>
      </ul><p>In a complex application, organizing code into <em>packages</em> is an attractive build strategy. The build profile in this article is based on an test application currently under development (files list below). The application framework is built with open source libraries. The main objective in this build profile is to optimize an application developed with <a href="http://documentcloud.github.com/backbone/" title="Backbone.js">Backbone.js</a> using modular code, following the <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" title="Asynchronous Module Definition (AMD) wiki page">Asynchronous Module Definition (AMD)</a> format. AMD and RequireJS provide the structure for writing modular code with dependencies. Backbone.js provides the code organization for developing models, views and collections and also interactions with a RESTful API.</p>

      <p>Below is an outline of the applications file organization, followed by the build profile to build modular (or packaged) layers a JavaScript driven application.</p>

      <h4>
      <a name="user-content-file-organization" class="anchor" href="#file-organization"><span class="octicon octicon-link"></span></a>File organization</h4>

      <p>Assume the following directories and file organization, with app.build.js as the build profile (a sibling to both source and release directories). Note that the files in the list below named <em>section</em> can be any component of the application, e.g. <em>header</em>, <em>login</em>)</p>

      <div class="highlight highlight-text"><pre>.-- app.build.js
      |-- app-release
      `-- app-src
          |-- collections
          |   |-- base.js
          |   |-- sections-segments.js
          |   `-- sections.js
          |-- docs
          |   `--docco.css
          |-- models
          |   |-- base.js
          |   |-- branding.js
          |   `-- section.js
          |-- packages
          |   |-- header
          |   |   |-- models
          |   |   |   |-- nav.js
          |   |   |   `-- link.js
          |   |   |-- templates
          |   |   |   |-- branding.js
          |   |   |   |-- nav.js
          |   |   |   `-- links.js
          |   |   `-- views
          |   |       |-- nav.js
          |   |       |-- branding.js
          |   |       `-- link.js
          |   |-- header.js
          |   `-- ... more packages here e.g. cart, checkout ...
          |-- syncs
          |   |-- rest
          |   |   `-- sections.js
          |   |-- factory.js
          |   `-- localstorage.js
          |-- test
          |   |-- fixtures
          |   |   `-- sections.json
          |   |-- header
          |   |   |-- index.html
          |   |   `-- spec.js
          |   |-- lib
          |   |   `-- Jasmine
          |   |-- models
          |   |-- utils
          |   |-- global-spec.js
          |-- utils
          |   |-- ajax.js
          |   |-- baselib.js
          |   |-- debug.js
          |   |-- localstorage.js
          |   `-- shims.js
          |-- vendor
          |-- |-- backbone-min.js
          |   |-- jquery.min.js
          |   |-- jquery.mobile-1.0.min.js
          |   |-- json2.js
          |   |-- modernizr.min.js
          |   |-- mustache.js
          |   |-- require.js
          |   |-- text.js
          |   `-- underscore.js
          |-- views
          |   |-- base.js
          |   `-- collection.js
          |-- application.js
          |-- collections.js
          |-- index.html
          |-- main.js
          |-- models.js
          |-- syncs.js
          |-- utils.js
          |-- vendor.js
          `-- views.js
      </pre></div>

      <h4>
      <a name="user-content-build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages" class="anchor" href="#build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages"><span class="octicon octicon-link"></span></a>Build profile to optimize modular dependencies with code organized in packages</h4>

      <p>The build profile can be organized to <a href="http://requirejs.org/docs/faq-optimization.html#priority" title="optimize modular dependencies in packages">divide parallel downloads for various sections of the application</a>.</p>

      <p>This strategy demonstrated builds common or site-wide groups of (core) <em>models</em>, <em>views</em>, collections which are extended from a base.js constructor which extends the appropriate backbone method, e.g. Backbone.Model. The <em>packages</em> directory organizes code by section / responsibility, e.g. cart, checkout, etc. Notice that within the example <em>header</em> package the directory structure is similar to the app root directory file structure. A <em>package</em> (of modularized code) has dependencies from the common libraries in your application and also has specific code for the packages execution alone; other packages should not require another packages dependencies. A <em>utils</em> directory has shims, helpers, and common library code to support the application. A <em>syncs</em> directory to define persistence with your RESTful api and/or localStorage. The <em>vendor</em> libraries folder will not be built, there is no need to do so, you may decide to use a CDN (then set these paths to : <em><a href="http://requirejs.org/docs/optimization.html#empty" title="empty:">empty:</a></em>). And finally a <em>test</em> directory for <a href="http://pivotal.github.com/jasmine/" title="Jasmine is a behavior-driven development framework for testing your JavaScript code">Jasmine</a> unit test specs, which may be ignored in the build as well if you choose.</p>

      <p>Also notice the there are .js files named the same as the directories, these are the files listed in the paths. these are strategic to group sets of files to build, examples follow the build profile below.</p>

      <div class="highlight highlight-javascript"><pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./app-src'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'./app-build'</span><span class="p">,</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="c1">// will not build 3rd party code, it's already built</span>
              <span class="s1">'text'</span>         <span class="o">:</span> <span class="s1">'vendor/text'</span><span class="p">,</span>
              <span class="s1">'json2'</span>        <span class="o">:</span> <span class="s1">'vendor/json2.min'</span><span class="p">,</span>
              <span class="s1">'modernizr'</span>    <span class="o">:</span> <span class="s1">'vendor/modernizr.min'</span><span class="p">,</span>
              <span class="s1">'jquery'</span>       <span class="o">:</span> <span class="s1">'vendor/jquery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span> <span class="o">:</span> <span class="s1">'vendor/jquery.mobile.min.js'</span><span class="p">,</span>
              <span class="s1">'underscore'</span>   <span class="o">:</span> <span class="s1">'vendor/underscore'</span><span class="p">,</span>
              <span class="s1">'mustache'</span>     <span class="o">:</span> <span class="s1">'vendor/mustache'</span><span class="p">,</span>
              <span class="s1">'backbone'</span>     <span class="o">:</span> <span class="s1">'vendor/backbone'</span><span class="p">,</span>
              <span class="c1">// files that define dependencies...</span>
              <span class="c1">// ignore vendor libraries, but need a group to do so</span>
              <span class="s1">'vendor'</span>       <span class="o">:</span> <span class="s1">'vendor'</span><span class="p">,</span>
              <span class="c1">// application modules/packages these files define dependencies</span>
              <span class="c1">// and may also group modules into objects if needed to require</span>
              <span class="c1">// by groups rather than individual files</span>
              <span class="s1">'utils'</span>        <span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
              <span class="s1">'models'</span>       <span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
              <span class="s1">'views'</span>        <span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
              <span class="s1">'collections'</span>  <span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
              <span class="c1">// packages to build</span>
              <span class="s1">'header'</span>       <span class="o">:</span> <span class="s1">'packages/header'</span>
              <span class="c1">//... more packages</span>
          <span class="p">},</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="c1">// Common libraries, Utilities, Syncs, Models, Views, Collections</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'syncs'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="c1">// Packages</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'header'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">,</span> <span class="s1">'collections'</span><span class="p">]</span>
              <span class="p">}</span>
              <span class="c1">// ... and so much more ...</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre></div>

      <p>The above build profile is designed for balancing scalability and performance.</p>

      <p><strong>Examples of the grouped sets of code dependencies</strong></p>

      <p>The contents of the vendor.js which is not built into a package may use some <em>no conflict</em> calls as well.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of vendor libraries, e.g. jQuery, Underscore, Backbone, etc.</span>
      <span class="c1">// this module is used with the r.js optimizer tool during build</span>
      <span class="c1">// @see &lt;http://requirejs.org/docs/faq-optimization.html&gt;</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">,</span> <span class="s1">'modernizr'</span><span class="p">,</span> <span class="s1">'mustache'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span>        <span class="nx">_</span><span class="p">,</span>            <span class="nx">Backbone</span><span class="p">,</span>   <span class="nx">Modernizr</span><span class="p">,</span>   <span class="nx">Mustache</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// call no conflicts so if needed you can use multiple versions of $</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>For your application common library code.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of utility libraries,</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'utils/ajax'</span><span class="p">,</span> <span class="s1">'utils/baselib'</span><span class="p">,</span> <span class="s1">'utils/localstorage'</span><span class="p">,</span> <span class="s1">'utils/debug'</span><span class="p">,</span> <span class="s1">'utils/shims'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">ajax</span><span class="p">,</span>         <span class="nx">baselib</span><span class="p">,</span>         <span class="nx">localstorage</span><span class="p">,</span>         <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'ajax'</span> <span class="o">:</span> <span class="nx">ajax</span><span class="p">,</span>
              <span class="s1">'baselib'</span> <span class="o">:</span> <span class="nx">baselib</span><span class="p">,</span>
              <span class="s1">'localstorage'</span> <span class="o">:</span> <span class="nx">localstorage</span><span class="p">,</span>
              <span class="s1">'debug'</span> <span class="o">:</span> <span class="nx">debug</span>
          <span class="p">};</span>
          <span class="c1">// the shim only extend JavaScript when needed, e.g. Object.create</span>
      <span class="p">});</span>
      </pre></div>

      <p>An example where you intend to use require the common models in another package file.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of models</span>
      <span class="c1">// models in this directory are intended for site-wide usage</span>
      <span class="c1">// grouping site-wide models in this module (object)</span>
      <span class="c1">// optimizes the performance and keeps dependencies organized</span>
      <span class="c1">// when the (build) optimizer is run.</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'models/branding'</span><span class="p">,</span> <span class="s1">'models/section'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">Branding</span><span class="p">,</span>          <span class="nx">Section</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'Branding'</span> <span class="o">:</span> <span class="nx">Branding</span><span class="p">,</span>
              <span class="s1">'Section'</span>  <span class="o">:</span> <span class="nx">Section</span>
          <span class="p">};</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-a-quick-note-on-code-standards" class="anchor" href="#a-quick-note-on-code-standards"><span class="octicon octicon-link"></span></a>A quick note on code standards</h4>

      <p>Notice that in the above examples the parameters may begin with lower or upper case characters. The variable names uses in the parameters that begin with <em>Uppercase</em> are <em>Constructors</em> and the <em>lowercase</em> variable names are not, they may be instances created by a constructor, or perhaps an object or function that is not meant to used with <em>new</em>.</p>

      <p>The convention recommended is to use Upper CamelCase for constructors and lower camelCase for others.</p>

      <h4>
      <a name="user-content-common-pitfall-when-organizing-code-in-modules" class="anchor" href="#common-pitfall-when-organizing-code-in-modules"><span class="octicon octicon-link"></span></a>Common Pitfall when organizing code in modules</h4>

      <p>Be careful not define circular dependencies. For example, in a common <em>models</em> package (models.js) dependencies are listed for the files in your models directory</p>

      <pre><code>define([ 'models/branding', 'models/section' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section }
      </code></pre>

      <p>Then when another packages requires a common model you can access the models objects returned from your common models.js file like so...</p>

      <pre><code>define([ 'models', 'utils' ], function (models, utils) {
      var branding = models.branding, debug = utils.debug;
      </code></pre>

      <p>Perhaps after using the model a few times you get into the habit of requiring "model". Later you need add another common model with extends a model you already defined. So the pitfall begins, you add a new model inside your models directory and add a reference this same model in the model.js:</p>

      <pre><code>define([ 'models/branding', 'models/section', 'models/section-b' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section, 'section-b' : section-b }
      </code></pre>

      <p>However in your <em>models/section-b.js</em> file you define a dependency using the model.js which returns the models in an object like so...</p>

      <pre><code>define([ 'models' ], function (models, utils) {
      var section = models.section;
      </code></pre>

      <p>Above is the mistake in models.js a dependency was added for models/section-b and in section-b a dependency is defined for model. The new models/section-b.js requires <em>model</em> and model.js requires <em>models/section-b.js</em> - a circular dependency. This should result in a load timeout error from RequireJS, but not tell you about the circular dependency.</p>

      <p>For other common mistakes see the <a href="http://requirejs.org/docs/errors.html" title="RequireJS common errors page">COMMON ERRORS</a> page on the RequireJS site.</p>

      <h4>
      <a name="user-content-executing-the-build-with-rjs" class="anchor" href="#executing-the-build-with-rjs"><span class="octicon octicon-link"></span></a>Executing the Build with r.js</h4>

      <p>If you intalled r.js with Node's npm (package manager) like so...</p>

      <pre><code>&gt; npm install requirejs
      </code></pre>

      <p>...you can execute the build on the command line:</p>

      <pre><code>&gt; r.js -o app.build.js
      </code></pre>

      <h2>
      <a name="user-content-practical-building-a-modular-backbone-app-with-amd--requirejs" class="anchor" href="#practical-building-a-modular-backbone-app-with-amd--requirejs"><span class="octicon octicon-link"></span></a>Practical: Building a modular Backbone app with AMD &amp; RequireJS</h2>

      <p>In this chapter, we'll look at our first practical Backbone &amp; RequireJS project - how to build a modular Todo application. The application will allow us to add new todos, edit new todos and clear todo items that have been marked as completed. For a more advanced practical, see the section on mobile Backbone development.</p>

      <p>The complete code for the application can can be found in the <code>practicals/modular-todo-app</code> folder of this repo (thanks to Thomas Davis and Jérôme Gravel-Niquet). Alternatively grab a copy of my side-project <a href="https://github.com/addyosmani/todomvc">TodoMVC</a> which contains the sources to both AMD and non-AMD versions.</p>

      <p><strong>Note:</strong> Thomas may be covering a practical on this exercise in more detail on <a href="http://backbonetutorials.com">backbonetutorials.com</a> at some point soon, but for this section I'll be covering what I consider the core concepts.</p>

      <h3>
      <a name="user-content-overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h3>

      <p>Writing a 'modular' Backbone application can be a straight-forward process. There are however, some key conceptual differences to be aware of if opting to use AMD as your module format of choice:</p>

      <ul>
      <li>As AMD isn't a standard native to JavaScript or the browser, it's necessary to use a script loader (such as RequireJS or curl.js) in order to support defining components and modules using this module format. As we've already reviewed, there are a number of advantages to using the AMD as well as RequireJS to assist here.</li>
      <li>Models, views, controllers and routers need to be encapsulated <em>using</em> the AMD-format. This allows each component of our Backbone application to cleanly manage dependencies (e.g collections required by a view) in the same way that AMD allows non-Backbone modules to.</li>
      <li>Non-Backbone components/modules (such as utilities or application helpers) can also be encapsulated using AMD. I encourage you to try developing these modules in such a way that they can both be used and tested independent of your Backbone code as this will increase their ability to be re-used elsewhere.</li>
      </ul><p>Now that we've reviewed the basics, let's take a look at developing our application. For reference, the structure of our app is as follows:</p>

      <pre><code>index.html
      ...js/
          main.js
          .../models
                  todo.js
          .../views
                  app.js
                  todos.js
          .../collections
                  todos.js
          .../templates
                  stats.html
                  todos.html
          ../libs
              .../backbone
              .../jquery
              .../underscore
              .../require
                      require.js
                      text.js
      ...css/
      </code></pre>

      <h3>
      <a name="user-content-markup" class="anchor" href="#markup"><span class="octicon octicon-link"></span></a>Markup</h3>

      <p>The markup for the application is relatively simple and consists of three primary parts: an input section for entering new todo items (<code>create-todo</code>), a list section to display existing items (which can also be edited in-place) (<code>todo-list</code>) and finally a section summarizing how many items are left to be completed (<code>todo-stats</code>).</p>

      <pre><code>&lt;div id="todoapp"&gt;

            &lt;div class="content"&gt;

              &lt;div id="create-todo"&gt;
                &lt;input id="new-todo" placeholder="What needs to be done?" type="text" /&gt;
                &lt;span class="ui-tooltip-top"&gt;Press Enter to save this task&lt;/span&gt;
              &lt;/div&gt;

              &lt;div id="todos"&gt;
                &lt;ul id="todo-list"&gt;&lt;/ul&gt;
              &lt;/div&gt;

              &lt;div id="todo-stats"&gt;&lt;/div&gt;

            &lt;/div&gt;

      &lt;/div&gt;
      </code></pre>

      <p>The rest of the tutorial will now focus on the JavaScript side of the practical.</p>

      <h3>
      <a name="user-content-configuration-options" class="anchor" href="#configuration-options"><span class="octicon octicon-link"></span></a>Configuration options</h3>

      <p>If you've read the earlier chapter on AMD, you may have noticed that explicitly needing to define each dependency a Backbone module (view, collection or other module) may require with it can get a little tedious. This can however be improved.</p>

      <p>In order to simplify referencing common paths the modules in our application may use, we use a RequireJS <a href="http://requirejs.org/docs/api.html#config">configuration object</a>, which is typically defined as a top-level script file. Configuration objects have a number of useful capabilities, the most useful being mode name-mapping. Name-maps are basically a key:value pair, where the key defines the alias you wish to use for a path and the value represents the true location of the path.</p>

      <p>In the code-sample below, you can see some typical examples of common name-maps which include: <code>backbone</code>, <code>underscore</code>, <code>jquery</code> and depending on your choice, the RequireJS <code>text</code> plugin, which assists with loading text assets like templates.</p>

      <p><strong>main.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
        <span class="nx">baseUrl</span><span class="o">:</span><span class="s1">'../'</span><span class="p">,</span>
        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'libs/jquery/jquery-min'</span><span class="p">,</span>
          <span class="nx">underscore</span><span class="o">:</span> <span class="s1">'libs/underscore/underscore-min'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'libs/backbone/backbone-optamd3-min'</span><span class="p">,</span>
          <span class="nx">text</span><span class="o">:</span> <span class="s1">'libs/require/text'</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'views/app'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AppView</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">app_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>The <code>require()</code> at the end of our main.js file is simply there so we can load and instantiate the primary view for our application (<code>views/app.js</code>). You'll commonly see both this and the configuration object included in most top-level script files for a project.</p>

      <p>In addition to offering name-mapping, the configuration object can be used to define additional properties such as <code>waitSeconds</code> - the number of seconds to wait before script loading times out and <code>locale</code>, should you wish to load up i18n bundles for custom languages. The <code>baseUrl</code> is simply the path to use for module lookups.</p>

      <p>For more information on configuration objects, please feel free to check out the excellent guide to them in the <a href="http://requirejs.org/docs/api.html#config">RequireJS docs</a>.</p>

      <h3>
      <a name="user-content-modularizing-our-models-views-and-collections" class="anchor" href="#modularizing-our-models-views-and-collections"><span class="octicon octicon-link"></span></a>Modularizing our models, views and collections</h3>

      <p>Before we dive into AMD-wrapped versions of our Backbone components, let's review a sample of a non-AMD view. The following view listens for changes to its model (a Todo item) and re-renders if a user edits the value of the item.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>Note how for templating the common practice of referencing a script by an ID (or other selector) and obtaining its value is used. This of course requires that the template being accessed is implicitly defined in our markup. The following is the 'embedded' version of our template being referenced above:</p>

      <pre><code>&lt;script type="text/template" id="item-template"&gt;
            &lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;div class="todo-content"&gt;&lt;/div&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="" /&gt;
              &lt;/div&gt;
            &lt;/div&gt;
      &lt;/script&gt;
      </code></pre>

      <p>Whilst there is nothing wrong with the template itself, once we begin to develop larger applications requiring multiple templates, including them all in our markup on page-load can quickly become both unmanageable and come with performance costs. We'll look at solving this problem in a minute.</p>

      <p>Let's now take a look at the AMD-version of our view. As discussed earlier, the 'module' is wrapped using AMD's <code>define()</code> which allows us to specify the dependencies our view requires. Using the mapped paths to 'jquery' etc. simplifies referencing common dependencies and instances of dependencies are themselves mapped to local variables that we can access (e.g 'jquery' is mapped to <code>$</code>).</p>

      <p><strong>views/todo.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'text!templates/todos.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">todosTemplate</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">todosTemplate</span><span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the contents of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setContent</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Use `jQuery.text` to set the contents of the todo item.</span>
          <span class="nx">setContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>From a maintenance perspective, there's nothing logically different in this version of our view, except for how we approach templating.</p>

      <p>Using the RequireJS text plugin (the dependency marked <code>text</code>), we can actually store all of the contents for the template we looked at earlier in an external file (todos.html).</p>

      <p><strong>templates/todos.html</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"display"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo-content"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"todo-destroy"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"edit"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"todo-input"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre></div>

      <p>There's no longer a need to be concerned with IDs for the template as we can map its contents to a local variable (in this case <code>todosTemplate</code>). We then simply pass this to the Underscore.js templating function <code>_.template()</code> the same way we normally would have the value of our template script.</p>

      <p>Next, let's look at how to define models as dependencies which can be pulled into collections. Here's an AMD-compatible model module, which has two default values: a <code>content</code> attribute for the content of a Todo item and a boolean <code>done</code> state, allowing us to trigger whether the item has been completed or not.</p>

      <p><strong>models/todo.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">TodoModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// Ensure that each todo created has `content`.</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'empty todo...'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">},</span>

          <span class="c1">// Remove this Todo from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">TodoModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>As per other types of dependencies, we can easily map our model module to a local variable (in this case <code>Todo</code>) so it can be referenced as the model to use for our <code>TodosCollection</code>. This collection also supports a simple <code>done()</code> filter for narrowing down Todo items that have been completed and a <code>remaining()</code> filter for those that are still outstanding.</p>

      <p><strong>collections/todos.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'libs/backbone/localstorage'</span><span class="p">,</span>
        <span class="s1">'models/todo'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Store</span><span class="p">,</span> <span class="nx">Todo</span><span class="p">){</span>

          <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>In addition to allowing users to add new Todo items from views (which we then insert as models in a collection), we ideally also want to be able to display how many items have been completed and how many are remaining. We've already defined filters that can provide us this information in the above collection, so let's use them in our main application view.</p>

      <p><strong>views/app.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/todos'</span><span class="p">,</span>
        <span class="s1">'views/todo'</span><span class="p">,</span>
        <span class="s1">'text!templates/stats.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">,</span> <span class="nx">TodoView</span><span class="p">,</span> <span class="nx">statsTemplate</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">statsTemplate</span><span class="p">),</span>

          <span class="c1">// ...events, initialize() etc. can be seen in the complete file</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>       <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">remaining</span><span class="o">:</span>  <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
            <span class="p">}));</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>Above, we map the second template for this project, <code>templates/stats.html</code> to <code>statsTemplate</code> which is used for rendering the overall <code>done</code> and <code>remaining</code> states. This works by simply passing our template the length of our overall Todos collection (<code>Todos.length</code> - the number of Todo items created so far) and similarly the length (counts) for items that have been completed (<code>Todos.done().length</code>) or are remaining (<code>Todos.remaining().length</code>).</p>

      <p>The contents of our <code>statsTemplate</code> can be seen below. It's nothing too complicated, but does use ternary conditions to evaluate whether we should state there's "1 item" or "2 item<i>s</i>" in a particular state.</p>

      <pre><code>&lt;% if (total) { %&gt;
              &lt;span class="todo-count"&gt;
                &lt;span class="number"&gt;&lt;%= remaining %&gt;&lt;/span&gt;
                &lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.
              &lt;/span&gt;
            &lt;% } %&gt;
            &lt;% if (done) { %&gt;
              &lt;span class="todo-clear"&gt;
                &lt;a href="#"&gt;
                  Clear &lt;span class="number-done"&gt;&lt;%= done %&gt;&lt;/span&gt;
                  completed &lt;span class="word-done"&gt;&lt;%= done == 1 ? 'item' : 'items' %&gt;&lt;/span&gt;
                &lt;/a&gt;
              &lt;/span&gt;
            &lt;% } %&gt;
      </code></pre>

      <p>The rest of the source for the Todo app mainly consists of code for handling user and application events, but that rounds up most of the core concepts for this practical.</p>

      <p>To see how everything ties together, feel free to grab the source by cloning this repo or browse it <a href="https://github.com/addyosmani/backbone-fundamentals/tree/master/practicals/modular-todo-app">online</a> to learn more. I hope you find it helpful!.</p>

      <p><strong>Note:</strong> While this first practical doesn't use a build profile as outlined in the chapter on using the RequireJS optimizer, we will be using one in the section on building mobile Backbone applications.</p>

      <h2>
      <a name="user-content-decoupling-backbone-with-the-mediator-and-facade-patterns" class="anchor" href="#decoupling-backbone-with-the-mediator-and-facade-patterns"><span class="octicon octicon-link"></span></a>Decoupling Backbone with the Mediator and Facade Patterns</h2>

      <p>In this section we'll discuss applying some of the concepts I cover in my article on <a href="http://addyosmani.com/largescalejavascript">Large-scale JavaScript Application development</a> to Backbone.</p>

      <p><em>After, you may be interested in taking a look At <a href="http://github.com/addyosmani/aura">Aura</a> - my popular widget-based Backbone.js extension framework based on many of the concepts we will be covering in this section.</em></p>

      <h3>
      <a name="user-content-summary-1" class="anchor" href="#summary-1"><span class="octicon octicon-link"></span></a>Summary</h3>

      <p>At a high-level, one architecture that works for such applications is something which is:</p>

      <ul>
      <li>
      <strong>Highly decoupled</strong>: encouraging modules to only publish and subscribe to events of interest rather than directly communicating with each other. This helps us to build applications who's units of code aren't highly tied (coupled) together and can thus be reused more easily.</li>
      <li>
      <strong>Supports module-level security</strong>: whereby modules are only able to execute behavior they've been permitted to. Application security is an area which is often overlooked in JavaScript applications, but can be quite easily implemented in a flexible manner.</li>
      <li>
      <strong>Supports failover</strong>: allowing an application continuing to function even if particular modules fail. The typical example I give of this is the GMail chat widget. Imagine being able to build applications in a way that if one widget on the page fails (e.g chat), the rest of your application (mail) can continue to function without being affected.</li>
      </ul><p>This is an architecture which has been implemented by a number of different companies in the past, including Yahoo! (for their modularized homepage - which Nicholas Zakas has <a href="http://www.youtube.com/watch?v=vXjVFPosQHw">spoken</a> about) and AOL for some of our upcoming projects.</p>

      <p>The three design patterns that make this architecture possible are the:</p>

      <ul>
      <li>
      <strong>Module pattern</strong>: used for encapsulating unique blocks of code, where functions and variables can be kept either public or private. ('private' in the simulation of privacy sense, as of course don't have true privacy in JavaScript)</li>
      <li>
      <strong>Mediator pattern</strong>: used when the communication between modules may be complex, but is still well defined. If it appears a system may have too many relationships between modules in your code, it may be time to have a central point of control, which is where the pattern fits in.</li>
      <li>
      <strong>Facade pattern</strong>: used for providing a convenient higher-level interface to a larger body of code, hiding its true underlying complexity</li>
      </ul><p>Their specific roles in this architecture can be found below.</p>

      <ul>
      <li>
      <strong>Modules</strong>: There are almost two concepts of what defines a module. As AMD is being used as a module wrapper, technically each model, view and collection can be considered a module. We then have the concept of modules being distinct blocks of code outside of just MVC/MV*. For the latter, these types of 'modules' are primarily concerned with broadcasting and subscribing to events of interest rather than directly communicating with each other.They are made possible through the Mediator pattern.</li>
      <li>
      <strong>Mediator</strong>: The mediator has a varying role depending on just how you wish to implement it. In my article, I mention using it as a module manager with the ability to start and stop modules at will, however when it comes to Backbone, I feel that simplifying it down to the role of a central 'controller' that provides pub/sub capabilities should suffice. One can of course go all out in terms of building a module system that supports module starting, stopping, pausing etc, however the scope of this is outside of this chapter.</li>
      <li>
      <strong>Facade</strong>: This acts as a secure middle-layer that both abstracts an application core (Mediator) and relays messages from the modules back to the Mediator so they don't touch it directly. The Facade also performs the duty of application security guard; it checks event notifications from modules against a configuration (permissions.js, which we will look at later) to ensure requests from modules are only processed if they are permitted to execute the behavior passed.</li>
      </ul><h3>
      <a name="user-content-practical-2" class="anchor" href="#practical-2"><span class="octicon octicon-link"></span></a>Practical</h3>

      <p>For the practical section of this chapter, we'll be extending the well-known Backbone Todo application using the three patterns mentioned above.</p>

      <p>The application is broken down into AMD modules that cover everything from Backbone models through to application-level modules. The views publish events of interest to the rest of the application and modules can then subscribe to these event notifications.</p>

      <p>All subscriptions from modules go through a facade (or sandbox). What this does is check against the subscriber name and the 'channel/notification' it's attempting to subscribe to. If a channel <em>doesn't</em> have permissions to be subscribed to (something established through permissions.js), the subscription isn't permitted.</p>

      <p><strong>Mediator</strong></p>

      <p>Found in <code>aura/mediator.js</code></p>

      <p>Below is a very simple AMD-wrapped implementation of the mediator pattern, based on prior work by Ryan Florence. It accepts as its input an object, to which it attaches <code>publish()</code> and <code>subscribe()</code> methods. In a larger application, the mediator can contain additional utilities, such as handlers for initializing, starting and stopping modules, but for demonstration purposes, these two methods should work fine for our needs.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">channels</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">subscription</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">subscription</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Facade</strong></p>

      <p>Found in <code>aura/facade.js</code></p>

      <p>Next, we have an implementation of the facade pattern. Now the classical facade pattern applied to JavaScript would probably look a little like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">_private</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">i</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span>
              <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'current value:'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
              <span class="p">},</span>
              <span class="nx">run</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'running'</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">jump</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jumping'</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">facade</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="nx">args</span><span class="p">.</span><span class="nx">run</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="nx">_private</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}());</span>

      <span class="nx">module</span><span class="p">.</span><span class="nx">facade</span><span class="p">({</span><span class="nx">run</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">val</span><span class="o">:</span><span class="mi">10</span><span class="p">});</span>
      <span class="c1">//outputs current value: 10, running</span>
      </pre></div>

      <p>It's effectively a variation of the module pattern, where instead of simply returning an interface of supported methods, your API can completely hide the true implementation powering it, returning something simpler. This allows the logic being performed in the background to be as complex as necessary, whilst all the end-user experiences is a simplified API they pass options to (note how in our case, a single method abstraction is exposed). This is a beautiful way of providing APIs that can be easily consumed.</p>

      <p>That said, to keep things simple, our implementation of an AMD-compatible facade will act a little more like a proxy. Modules will communicate directly through the facade to access the mediator's <code>publish()</code> and <code>subscribe()</code> methods, however, they won't as such touch the mediator directly.This enables the facade to provide application-level validation of any subscriptions and publications made.</p>

      <p>It also allows us to implement a simple, but flexible, permissions checker (as seen below) which will validate subscriptions made against a permissions configuration to see whether it's permitted or not.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span> <span class="s1">'../aura/mediator'</span> <span class="p">,</span> <span class="s1">'../aura/permissions'</span> <span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mediator</span><span class="p">,</span> <span class="nx">permissions</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">facade</span> <span class="o">=</span> <span class="nx">facade</span> <span class="o">||</span> <span class="p">{};</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>

              <span class="c1">// Note: Handling permissions/security is optional here</span>
              <span class="c1">// The permissions check can be removed</span>
              <span class="c1">// to just use the mediator directly.</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)){</span>
                  <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span> <span class="nx">channel</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">facade</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Permissions</strong></p>

      <p>Found in <code>aura/permissions.js</code></p>

      <p>In our simple permissions configuration, we support checking against subscription requests to establish whether they are allowed to clear. This enforces a flexible security layer for the application.</p>

      <p>To visually see how this works, consider changing say, permissions -&gt; renderDone -&gt; todoCounter to be false. This will completely disable the application from from rendering or displaying the counts component for Todo items left (because they aren't allowed to subscribe to that event notification). The rest of the Todo app can still however be used without issue.</p>

      <p>It's a very dumbed down example of the potential for application security, but imagine how powerful this might be in a large app with a significant number of visual widgets.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Permissions</span>

          <span class="c1">// A permissions structure can support checking</span>
          <span class="c1">// against subscriptions prior to allowing them</span>
          <span class="c1">// to clear. This enforces a flexible security</span>
          <span class="c1">// layer for your application.</span>

          <span class="kd">var</span> <span class="nx">permissions</span> <span class="o">=</span> <span class="p">{</span>

              <span class="nx">newContentAvailable</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">contentUpdater</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">endContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoSaver</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">beginContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">editFocus</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">addingNewTodo</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoTooltip</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">clearContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">garbageCollector</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">renderDone</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoCounter</span><span class="o">:</span><span class="kc">true</span> <span class="c1">//switch to false to see what happens :)</span>
              <span class="p">},</span>

              <span class="nx">destroyContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoRemover</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">createWhenEntered</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">keyboardManager</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">}</span>

          <span class="p">};</span>

          <span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">permissions</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">subscriber</span><span class="p">];</span>
              <span class="k">return</span> <span class="nx">test</span><span class="o">===</span><span class="kc">undefined</span><span class="o">?</span> <span class="kc">false</span><span class="o">:</span> <span class="nx">test</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="k">return</span> <span class="nx">permissions</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Subscribers</strong></p>

      <p>Found in <code>subscribers.js</code></p>

      <p>Subscriber 'modules' communicate through the facade back to the mediator and perform actions when a notification event of a particular name is published.</p>

      <p>For example, when a user enters in a new piece of text for a Todo item and hits 'enter' the application publishes a notification saying two things: a) a new Todo item is available and b) the text content of the new item is X. It's then left up to the rest of the application to do with this information whatever it wishes.</p>

      <p>In order to update your Backbone application to primarily use pub/sub, a lot of the work you may end up doing will be moving logic coupled inside of specific views to modules outside of it which are reactionary.</p>

      <p>Take the <code>todoSaver</code> for example - its responsibility is saving new Todo items to models once the a <code>notificationName</code> called 'newContentAvailable' has fired. If you take a look at the permissions structure in the last code sample, you'll notice that 'newContentAvailable' is present there. If I wanted to prevent subscribers from being able to subscribe to this notification, I simply set it to a boolean value of <code>false</code>.</p>

      <p>Again, this is a massive oversimplification of how advanced your permissions structures could get, but it's certainly one way of controlling what parts of your application can or can't be accessed by specific modules at any time.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'aura/facade'</span><span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">facade</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Subscription 'modules' for our views. These take the</span>
          <span class="c1">// the form facade.subscribe( subscriberName, notificationName , callBack )</span>

          <span class="c1">// Update view with latest todo content</span>
          <span class="c1">// Subscribes to: newContentAvailable</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'contentUpdater'</span><span class="p">,</span> <span class="s1">'newContentAvailable'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Save models when a user has finishes editing</span>
          <span class="c1">// Subscribes to: endContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoSaver'</span><span class="p">,</span><span class="s1">'endContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                      <span class="nx">content</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
                  <span class="p">});</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// Delete a todo when the user no longer needs it</span>
          <span class="c1">// Subscribes to: destroyContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoRemover'</span><span class="p">,</span><span class="s1">'destroyContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// When a user is adding a new entry, display a tooltip</span>
          <span class="c1">// Subscribes to: addingNewTodo</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoTooltip'</span><span class="p">,</span><span class="s1">'addingNewTodo'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">tooltip</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.ui-tooltip-top'</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span>
              <span class="nx">tooltip</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">();</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">)</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">||</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'placeholder'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                      <span class="nx">tooltip</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">fadeIn</span><span class="p">();</span>
                  <span class="p">};</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">show</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Update editing UI on switching mode to editing content</span>
          <span class="c1">// Subscribes to: beginContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'editFocus'</span><span class="p">,</span><span class="s1">'beginContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">});</span>


          <span class="c1">// Create a new todo entry</span>
          <span class="c1">// Subscribes to: createWhenEntered</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'keyboardManager'</span><span class="p">,</span><span class="s1">'createWhenEntered'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
              <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">());</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">});</span>



          <span class="c1">// A Todo and remaining entry counter</span>
          <span class="c1">// Subscribes to: renderDone</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoCounter'</span><span class="p">,</span><span class="s1">'renderDone'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                  <span class="nx">total</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">done</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">remaining</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
              <span class="p">}));</span>
          <span class="p">});</span>


          <span class="c1">// Clear all completed todos when clearContent is dispatched</span>
          <span class="c1">// Subscribes to: clearContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'garbageCollector'</span><span class="p">,</span><span class="s1">'clearContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">todo</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">});</span>
          <span class="p">});</span>


      <span class="p">});</span>
      </pre></div>

      <p>That's it for this section. If you've been intrigued by some of the concepts covered, I encourage you to consider taking a look at my <a href="http://addyosmani.com/blog/large-scale-javascript-application-architecture/">slides</a> on Large-scale JS from the jQuery Summit or my longer post on the topic <a href="http://addyosmani.com/largescalejavascript">here</a> for more information.</p>

      <h2>
      <a name="user-content-backbonemarionette" class="anchor" href="#backbonemarionette"><span class="octicon octicon-link"></span></a>Backbone.Marionette</h2>

      <p><em>By Derick Bailey &amp; Addy Osmani</em></p>

      <p>As we've seen, Backbone provides a great set of building blocks for our JavaScript applications. It gives us the core constructs that are needed to build small to mid-sized apps, organize jQuery DOM events, or create single page apps that support mobile devices and large scale enterprise needs. But Backbone is not a complete framework. It's a set of building blocks that leaves much of the application design, architecture and scalability to the developer, including memory management, view management and more.</p>

      <p><a href="http://marionettejs.com">Backbone.Marionette</a> (or just "Marionette") provides many of the features that the non-trivial application developer needs, above what Backbone itself provides. It is a composite application library that aims to simplify the construction of large scale applications. It does this by providing a collection of common design and implementation patterns found in the applications that the creator, <a href="http://lostechies.com/derickbailey/">Derick Bailey</a>, and many other <a href="https://github.com/marionettejs/backbone.marionette/graphs/contributors">contributors</a> have been using to build Backbone apps. </p>

      <p>Marionette's key benefits include:</p>

      <ul>
      <li>Scaling applications out with modular, event driven architecture</li>
      <li>Sensible defaults, such as using Underscore templates for view rendering</li>
      <li>Easy to modify to make it work with your application's specific needs</li>
      <li>Reducing boilerplate for views, with specialized view types</li>
      <li>Build on a modular architecture with an Application and modules that attach to it</li>
      <li>Compose your application's visuals at runtime, with Region and Layout</li>
      <li>Nested views and layouts within visual regions</li>
      <li>Built-in memory management and zombie killing in views, regions and layouts</li>
      <li>Built-in event clean up with the EventBinder</li>
      <li>Event-driven architecture with the EventAggregator</li>
      <li>Flexible, "as-needed" architecture allowing you to pick and choose what you need</li>
      <li>And much, much more</li>
      </ul><p>Marionette follows a similar philosophy to Backbone in that it provides a suite of components that can be used independently of each other, or used together to create a significant advantages for us as developers. But it steps above the structural components of Backbone and provides an application layer, with more than a dozen components and building blocks. </p>

      <p>Marionette's components range greatly in the features they provide, but they all work together to create a composite application layer that can both reduce boilerplate code and provide a much needed application structure. Its core components include:</p>

      <ul>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.md"><strong>Backbone.Marionette.Application</strong></a>: An application object that starts your app via initializers, and more</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.module.md"><strong>Backbone.Marionette.Application.module</strong></a>: Create modules and sub-modules within the application</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.approuter.md"><strong>Backbone.Marionette.AppRouter</strong></a>: Reduce your routers to nothing more than configuration</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.view.md"><strong>Backbone.Marionette.View</strong></a>: The base View type that other Marionette views extend from (not intended to be used directly)</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.itemview.md"><strong>Backbone.Marionette.ItemView</strong></a>: A view that renders a single item</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.collectionview.md"><strong>Backbone.Marionette.CollectionView</strong></a>: A view that iterates over a collection, and renders individual <code>ItemView</code> instances for each model</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.compositeview.md"><strong>Backbone.Marionette.CompositeView</strong></a>: A collection view and item view, for rendering leaf-branch/composite model hierarchies</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.region.md"><strong>Backbone.Marionette.Region</strong></a>: Manage visual regions of your application, including display and removal of content</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.layout.md"><strong>Backbone.Marionette.Layout</strong></a>: A view that renders a layout and creates region managers to manage areas within it</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventaggregator.md"><strong>Backbone.Marionette.EventAggregator</strong></a>: An extension of Backbone.Events, to be used as an event-driven or pub-sub tool</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventbinder.md"><strong>Backbone.Marionette.EventBinder</strong></a>: An event binding manager, to facilitate binding and unbinding of events</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.renderer.md"><strong>Backbone.Marionette.Renderer</strong></a>: Render templates with or without data, in a consistent and common manner</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.templatecache.md"><strong>Backbone.Marionette.TemplateCache</strong></a>: Cache templates that are stored in <code>&lt;script&gt;</code> blocks, for faster subsequent access</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.callbacks.md"><strong>Backbone.Marionette.Callbacks</strong></a>: Manage a collection of callback methods, and execute them as needed</li>
      </ul><p>But like Backbone itself, you're not required to use all of Marionette's components just because you want to use some of them. You can pick and choose which features you want to use, when. This allows you to work with other Backbone frameworks and plugins very easily. It also means that you are not required to engage in an all-or-nothing migration to begin using Marionette.</p>

      <h3>
      <a name="user-content-boilerplate-rendering-code" class="anchor" href="#boilerplate-rendering-code"><span class="octicon octicon-link"></span></a>Boilerplate Rendering Code</h3>

      <p>Consider the code that it typically requires to render a view with Backbone and Underscore template. We need a template to render, which can be placed in the DOM directly, and we need the JavaScript that defines a view to use the template, and populate that template with data from a model.</p>

      <pre><code>&lt;script type="text/html" id="my-view-template"&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;First Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= firstName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Last Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= lastName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Email:&lt;/label&gt;
          &lt;span&gt;&lt;%= email %&gt;&lt;/span&gt;
        &lt;div&gt;
      &lt;/script&gt;
      &lt;/pre&gt;
      </code></pre>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// compile the Underscore.js template</span>
          <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#my-view-template'</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">compiledTemplate</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// render the template with the model data</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">compiledTemplate</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

          <span class="c1">// populate the view with the rendered html</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Once this is in place, you need to create an instance of your view and pass your model in to it. Then you can take the view's <code>el</code> and append it to the DOM in order to display the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Derick'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Bailey'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'derickbailey@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre></div>

      <p>This is a standard set up for defining, building, rendering, and displaying a view with Backbone. This is also what we call "boilerplate code" - code that is repeated over and over and over again, across every project and every implementation of the same functionality. It gets to be very tedious and repetitious very quickly.</p>

      <p>Enter Marionette's <code>ItemView</code> - a simple way to reduce the boilerplate of defining a view.</p>

      <h3>
      <a name="user-content-reducing-boilerplate-with-marionetteitemview" class="anchor" href="#reducing-boilerplate-with-marionetteitemview"><span class="octicon octicon-link"></span></a>Reducing Boilerplate With Marionette.ItemView</h3>

      <p>All of Marionette's view types - with the exception of <code>Marionette.View</code> - include a built-in <code>render</code> method that handles the core rendering logic for you. By changing the <code>MyView</code> instance from <code>Backbone.View</code> then, we can take advantage of this. Instead of having to provide our own <code>render</code> method for the view, we can let Marionette render it for us. We'll still use the same Underscore.js template and rendering mechanism, but the implementation of this is hidden behind the scenes for us. Thus, we can reduce the amount of code needed for this view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span>
      <span class="p">});</span>
      </pre></div>

      <p>And that's it - that's all you need to get the exact same behaviour as the previous view implementation. Just replace <code>Backbone.View.extend</code> with <code>Backbone.Marionette.ItemView.extend</code>, then get rid of the <code>render</code> method. You can still create the view instance with a <code>model</code>, call the <code>render</code> method on the view instance, and display the view in the DOM the same way that we did before. But the view definition has been reduced to a single line of configuration for the template.</p>

      <h3>
      <a name="user-content-memory-management" class="anchor" href="#memory-management"><span class="octicon octicon-link"></span></a>Memory Management</h3>

      <p>In addition to the reduction of code needed to define a view, Marionette includes some advanced memory management in all of it's views, making the job of cleaning up a view instance and it's event handlers, easy.</p>

      <p>Consider the following view implementation:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>If we create two instances of this view using the same variable name for both instances, and then change a value in the model, how many times will we see the alert box? </p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre></div>

      <p>Since we're re-using the save <code>zombieView</code> variable for both instances, the first instance of the view will fall out of scope immediately after the second is created. This allows the JavaScript garbage collector to come along and clean it up, which should mean the first view instance is no longer active and no longer going to respond to the model's "change" event.</p>

      <p>But when we run this code, we end up with the alert box showing up twice!</p>

      <p>The problem is caused by the model event binding in the view's <code>initialize</code> method. Whenever we pass <code>this.render</code> as the callback method to the model's <code>on</code> event binding, the model itself is being given a direct reference to the view instance. Since the model is now holding a reference to the view instance, replacing the <code>zombieView</code> variable with a new view instance is not going to let the original view fall out of scope. The model still has a reference, therefore the view is still in scope. </p>

      <p>Since the original view is still in scope, and the second view instance is also in scope, changing data on the model will cause both view instances to respond.</p>

      <p>Fixing this is easy, though. You just need to call <code>off</code> when the view is done with it's work and ready to be closed. To do this, add a <code>close</code> method to the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Then call <code>close</code> on the first instance when it is no longer needed, and only one view instance will remain alive.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>
      <span class="nx">zombieView</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="c1">// double-tap the zombie</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre></div>

      <p>Now we only see once alert box when this code runs. </p>

      <p>Rather than having to manually remove these event handlers, though, we can let Marionette do it for us.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Notice in this case we are using a method called <code>bindTo</code>. This method comes from Marionette's <code>EventBinder</code> object, and is added on to all of Marionette's view types. The <code>bindTo</code> method signature is similar to that of the <code>on</code> method, with the exception of passing the object that triggers the event as the first parameter. </p>

      <p>Marionette's views also provide a <code>close</code> event, in which the event bindings that are set up with the <code>bindTo</code> are automatically removed. This means we no longer need to define a <code>close</code> method directly, and when we use the <code>bindTo</code> method, we know that our events will be removed and our views will not turn in to zombies.</p>

      <p>But how do we automate the call to <code>close</code> on a view, in the real application? When and where do we call that? Enter the <code>Marionette.Region</code> - an object that manages the lifecycle of an individual view.</p>

      <h3>
      <a name="user-content-region-management" class="anchor" href="#region-management"><span class="octicon octicon-link"></span></a>Region Management</h3>

      <p>After a view is created, it typically needs to be placed in the DOM so that it becomes visible. This is usually done with a jQuery selector and setting the <code>html()</code> of the resulting object:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="c1">// show the view in the DOM</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre></div>

      <p>This, again, is boilerplate code. We shouldn't have to manually call <code>render</code> and manually select the DOM elements to show the view. Furthermore, this code doesn't lend itself to closing any previous view instance that might be attached to the DOM element we want to populate. And we've seen the danger of zombie views already.</p>

      <p>To solve these problems, Marionette provides a <code>Region</code> object - an object that manages the lifecycle of individual views, displayed in a particular DOM element.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// create a region instance, telling it which DOM element to manage</span>
      <span class="kd">var</span> <span class="nx">myRegion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Region</span><span class="p">({</span>
        <span class="nx">el</span><span class="o">:</span> <span class="s1">'#content'</span>
      <span class="p">});</span>

      <span class="c1">// show a view in the region</span>
      <span class="kd">var</span> <span class="nx">view1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view1</span><span class="p">);</span>

      <span class="c1">// somewhere else in the code,</span>
      <span class="c1">// show a different view</span>
      <span class="kd">var</span> <span class="nx">view2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view2</span><span class="p">);</span>
      </pre></div>

      <p>There are several things to note, here. First, we're telling the region what DOM element to manage by specifying an <code>el</code> in the region instance. Second, we're no longer calling the <code>render</code> method on our views. And lastly, we're not calling <code>close</code> on our view, either, though this is getting called for us. </p>

      <p>When we use a region to manage the lifecycle of our views, and display the views in the DOM, the region itself handles these concerns. By passing a view instance in to the <code>show</code> method of the region, it will call the render method on the view for us. It will then take the resulting <code>el</code> of the view and populate the DOM element. </p>

      <p>The next time we call the <code>show</code> method of the region, the region remembers that it is currently displaying a view. The region calls the <code>close</code> method on the view, removes it from the DOM, and then proceeds to run the render &amp; display code for the new view that was passed in.</p>

      <p>Since the region handles calling <code>close</code> for us, and we're using the <code>bindTo</code> event binder in our view instance, we no longer have to worry about zombie views in our application.</p>

      <h3>
      <a name="user-content-marionette-todo-app" class="anchor" href="#marionette-todo-app"><span class="octicon octicon-link"></span></a>Marionette Todo app</h3>

      <p>Having learned about Marionette's high-level concepts, let's explore refactoring the Todo application we created in our first practical to use it. The complete code for this application can be found in Derick's TodoMVC <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">fork</a>.</p>

      <p>Our final implementation will be visually and functionally equivalent to the original app, as seen below.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/marionette_todo0.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/marionette_todo0.png" alt="" style="max-width:100%;"></a></p>

      <p>First, we define an application object representing our base TodoMVC app. This will contain initialisation code and define the default layout regions for our app. </p>

      <p><strong>TodoMVC.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoMVC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Application</span><span class="p">();</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">addRegions</span><span class="p">({</span>
        <span class="nx">header</span> <span class="o">:</span> <span class="s1">'#header'</span><span class="p">,</span>
        <span class="nx">main</span>   <span class="o">:</span> <span class="s1">'#main'</span><span class="p">,</span>
        <span class="nx">footer</span> <span class="o">:</span> <span class="s1">'#footer'</span>
      <span class="p">});</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'initialize:after'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>Regions are used to manage the content that's displayed within specific elements, and the <code>addRegions</code> method on the <code>TodoMVC</code> object is just a shortcut for creating <code>Region</code> objects. We supply a jQuery selector for each region to manage (e.g <code>#header</code>, <code>#main</code> and <code>#footer</code>) and then tell the region to show various Backbone views within that region.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/marionette_todo1.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/marionette_todo1.png" alt="" style="max-width:100%;"></a></p>

      <p>Once the application object has been initialised, we call <code>Backbone.history.start()</code> to route the initial URL.</p>

      <p>Next, we define our Layouts. A layout is a specialised type of view that extends from <code>Marionette.ItemView</code> directly. This means its intended to render a single template and may or may not have a model (or <code>item</code>) associated with the template.</p>

      <p>One of the main differences between a Layout and an <code>ItemView</code> is that the layout contains regions. When defining a Layout, we supply it with a <code>template</code> but also the regions that the template contains. After rendering the layout, we can display other views within the layout using the regions that were defined.</p>

      <p>In our TodoMVC Layout module below, we define Layouts for:</p>

      <ul>
      <li>Header: where we can create new Todos</li>
      <li>Footer: where we summarise how many Todos are remaining/have been completed</li>
      </ul><p>This captures some of the view logic that was previously in our <code>AppView</code> and <code>TodoView</code>.</p>

      <p>Note that Marionette modules (such as the below) offer a simple module system which are used to create privacy and encapsulation in Marionette apps. These certainly don't have to be used however, and later on in this section we'll provide links to alternative implementations using RequireJS + AMD instead.</p>

      <p><strong>TodoMVC.Layout.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Layout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Layout</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Layout Header View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-header'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">input</span> <span class="o">:</span> <span class="s1">'#new-todo'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>   <span class="s1">'onInputKeypress'</span>
          <span class="p">},</span>

          <span class="nx">onInputKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">title</span> <span class="o">:</span> <span class="nx">todoText</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Layout Footer View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-footer'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">count</span>   <span class="o">:</span> <span class="s1">'#todo-count strong'</span><span class="p">,</span>
            <span class="nx">filters</span> <span class="o">:</span> <span class="s1">'#filters a'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click #clear-completed'</span> <span class="o">:</span> <span class="s1">'onClearClick'</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">,</span> <span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateFilterSelection</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">updateCount</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">updateFilterSelection</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">filters</span>
              <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#'</span> <span class="o">+</span> <span class="nx">filter</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onClearClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getCompleted</span><span class="p">();</span>
            <span class="nx">completed</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">destroy</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>Next, we tackle application routing and workflow, such as controlling Layouts in the page which can be shown or hidden. </p>

      <p>Marionette uses the concept of an AppRouter to simplify routing. This reduces the boilerplate for handling route events and allows routers to be configured to call methods on an object directly. We configure our AppRouter using <code>appRoutes</code>.  </p>

      <p>This replaces the <code>'*filter': 'setFilter'</code> route defined in our original Workspace router, seen below:</p>

      <div class="highlight highlight-javascript"><pre>        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
                      <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
                              <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
                      <span class="p">},</span>

                      <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
                              <span class="c1">// Set the current filter to be used</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

                              <span class="c1">// Trigger a collection reset/addAll</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">);</span>
                      <span class="p">}</span>
              <span class="p">});</span>
      </pre></div>

      <p>The TodoList Controller, also found in this next code block, handles some of the remaining visibility logic originally found in <code>AppView</code> and <code>TodoView</code>, albeit using very readable Layouts.</p>

      <p><strong>TodoMVC.TodoList.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// TodoList Router</span>
        <span class="c1">// ---------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handle routes to show the active vs complete todo items</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">AppRouter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">appRoutes</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'filterItems'</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Controller (Mediator)</span>
        <span class="c1">// ------------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Control the workflow and logic that exists at the application</span>
        <span class="c1">// level, above the implementation detail of views and models</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="c1">// Start the app by showing the appropriate views</span>
          <span class="c1">// and fetching the list of todo items, if there are any</span>
          <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showHeader</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showFooter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showTodoList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">showHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showFooter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">footer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">footer</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">footer</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showTodoList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span><span class="p">({</span>
              <span class="nx">collection</span> <span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">}));</span>
          <span class="p">},</span>

          <span class="c1">// Set the filter to show complete or all items</span>
          <span class="nx">filterItems</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Initializer</span>
        <span class="c1">// --------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Get the TodoList up and running by initializing the mediator</span>
        <span class="c1">// when the the application is started, pulling in all of the</span>
        <span class="c1">// existing Todo items and displaying them.</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">addInitializer</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

          <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">();</span>
          <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span><span class="p">({</span>
            <span class="nx">controller</span><span class="o">:</span> <span class="nx">controller</span>
          <span class="p">});</span>

          <span class="nx">controller</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <h4>
      <a name="user-content-controllers-1" class="anchor" href="#controllers-1"><span class="octicon octicon-link"></span></a>Controllers</h4>

      <p>In this particular app, note that Controllers don't add a great deal to the overall workflow. In general however, Marionette's philosophy on routers is that they should be an after-thought in the implementation of applications. Quite often, we'll see many bad examples of developers abusing Backbone's routing system by making it the sole controller of the entire application workflow and logic. </p>

      <p>This inevitably leads to mashing every possible combination of code in to the router methods - view creation, model loading, coordinating different parts of the app, etc. Developers such as Derick views this as a violation of the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single-responsibility principle</a> (SRP) and separation of concerns. </p>

      <p>Backbone's router and history exists to deal with a specific aspect of browsers - managing the forward and back buttons. Marionette feels it should be limited to that, with the code that gets executed by the navigation being somewhere else. This allows the application to be used with or without a router. We can call a controller's "show" method from a button click, from an application event handler, or from a router, and we will end up with the same application state no matter how we called that method.</p>

      <p>Derick has written extensively about his thoughts on this topic, which you can read more about on his blog:</p>

      <ul>
      <li><a href="http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/">http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/">http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/">http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/</a></li>
      </ul><h4>
      <a name="user-content-compositeview" class="anchor" href="#compositeview"><span class="octicon octicon-link"></span></a>CompositeView</h4>

      <p>We then get to defining the actual views for individual Todo items and lists of items in our TodoMVC application. For this, we make use of Marionette's <code>CompositeView</code>s. The idea behind a CompositeView is that it represents a visualisation of a composite or hierarchical structure of leaves (or nodes) and branches. </p>

      <p>Think of these views as being a hierarchy of parent-child models, and recursive by default. For each item in a collection that the composite view is handling the same CompositeView type will be used to render the item. For non-recursive hierarchies, though, we are able to override the item view by defining an <code>itemView</code> attribute.</p>

      <p>For our Todo List Item View, we define it as an ItemView, then our Todo List View is a CompositeView where we override the <code>itemView</code> setting and tell it to use the Todo List item View for each item in the collection. </p>

      <p>TodoMVC.TodoList.Views.js</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList.Views'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Views</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo List Item View</span>
        <span class="c1">// -------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Display an individual todo item, and respond to changes</span>
        <span class="c1">// that are made to the item, including marking completed.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span> <span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
            <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoItemView'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">edit</span> <span class="o">:</span> <span class="s1">'.edit'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click .destroy'</span> <span class="o">:</span> <span class="s1">'destroy'</span><span class="p">,</span>
              <span class="s1">'dblclick label'</span> <span class="o">:</span> <span class="s1">'onEditClick'</span><span class="p">,</span>
              <span class="s1">'keypress .edit'</span> <span class="o">:</span> <span class="s1">'onEditKeypress'</span><span class="p">,</span>
              <span class="s1">'click .toggle'</span>  <span class="o">:</span> <span class="s1">'toggle'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'active completed'</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
              <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">destroy</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">().</span><span class="nx">save</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

              <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nx">todoText</span><span class="p">).</span><span class="nx">save</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Item List View</span>
        <span class="c1">// --------------</span>
        <span class="c1">//</span>
        <span class="c1">// Controls the rendering of the list of items, including the</span>
        <span class="c1">// filtering of active vs completed items for display.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoListCompositeView'</span><span class="p">,</span>
            <span class="nx">itemView</span> <span class="o">:</span> <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">,</span>
            <span class="nx">itemViewContainer</span> <span class="o">:</span> <span class="s1">'#todo-list'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">toggle</span> <span class="o">:</span> <span class="s1">'#toggle-all'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click #toggle-all'</span> <span class="o">:</span> <span class="s1">'onToggleAllClick'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">update</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">function</span> <span class="nx">reduceCompleted</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span> <span class="p">}</span>
              <span class="kd">var</span> <span class="nx">allCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">reduceCompleted</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">'checked'</span><span class="p">,</span> <span class="nx">allCompleted</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">onToggleAllClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">isChecked</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
                <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="s1">'completed'</span><span class="o">:</span> <span class="nx">isChecked</span><span class="p">});</span>
              <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Application Event Handlers</span>
        <span class="c1">// --------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handler for filtering the list of items by showing and</span>
        <span class="c1">// hiding through the use of various CSS classes</span>

        <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">filter</span> <span class="o">=</span> <span class="nx">filter</span> <span class="o">||</span> <span class="s1">'all'</span><span class="p">;</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'class'</span><span class="p">,</span> <span class="s1">'filter-'</span> <span class="o">+</span> <span class="nx">filter</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>At the end of the last code block, you will also notice an event handler using <code>vent</code>. This is an event aggregator that allows us to handle <code>filterItem</code> triggers from our TodoList controller.</p>

      <p>Finally, we define the model and collection for representing our Todo items. These are semantically not very different from the original versions we used in our first practical and have been re-written to better fit in with Derick's preferred style of coding.</p>

      <p><strong>Todos.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Todos</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span>     <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">created</span>   <span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNew</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">getCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">getActive</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">_isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>We finally kick-start everything off in our application index file, by calling <code>start</code> on our main application object:</p>

      <p>Initialisation:</p>

      <div class="highlight highlight-javascript"><pre>      <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// Start the TodoMVC app (defined in js/TodoMVC.js)</span>
              <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="p">});</span>
      </pre></div>

      <p>And that's it!</p>

      <h3>
      <a name="user-content-is-the-marionette-implementation-of-the-todo-app-more-maintainable" class="anchor" href="#is-the-marionette-implementation-of-the-todo-app-more-maintainable"><span class="octicon octicon-link"></span></a>Is the Marionette implementation of the Todo app more maintainable?</h3>

      <p>Derick feels that maintainability largely comes down to modularity, separating responsibilities (SRP and SoC) and other related patterns for keeping concerns from being mixed together. It can however be difficult to simply extract things in to separate modules for the sake of extraction, abstraction, or dividing the concept down in to it's most finite parts. </p>

      <p>The Single Responsibility Principle (SRP) tells us quite the opposite - that we need to understand the context in which things change. What parts always change together, in <em>this</em> system? What parts can change independently? Without knowing this, we won't know what pieces should be broken out in to separate components and modules, vs put together in to the same module or object. </p>

      <p>The way Derick organizes his apps into modules is by creating a breakdown of concepts at each level. A higher level module is a higher level of concern - an aggregation of responsibilities. Each responsibility is broken down in to an expressive API set that is implemented by lower level modules (Dependency Inversion Principle). These are coordinated through a mediator - which he typically refers to as the Controller in a module. </p>

      <p>The way that Derick organizes his files also plays directly into maintainability and he has also written up posts about the importance of keeping a sane application folder structure that I recommend reading:</p>

      <ul>
      <li><a href="http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/">http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/</a></li>
      <li><a href="http://hilojs.codeplex.com/discussions/362875#post869640">http://hilojs.codeplex.com/discussions/362875#post869640</a></li>
      </ul><h3>
      <a name="user-content-marionette-and-flexibility" class="anchor" href="#marionette-and-flexibility"><span class="octicon octicon-link"></span></a>Marionette And Flexibility</h3>

      <p>Marionette is a flexible framework, much like Backbone itself. It offers a wide variety of tools to help create and organize an application architecture on top of Backbone, but like Backbone itself, it doesn't dictate that you have to use all of it's pieces in order to use any of them. </p>

      <p>The flexibility and versatility in Marionette is easiest to understand by examining three variations of TodoMVC that have been created for comparison purposes:</p>

      <ul>
      <li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/architecture-examples/backbone_marionette">Simple</a> - by Jarrod Oversion</li>
      <li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/dependency-examples/backbone_marionette_require">RequireJS</a> - also by Jarrod</li>
      <li>
      <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">Marionette modules</a> - by Derick Bailey</li>
      </ul><p><strong>The simple version</strong>: This version of TodoMVC shows some raw use of Marionette's various view types, an application object, and the event aggregator. The objects that are created are added directly to the global namespace and are fairly straightforward. This is a great example of how Marionette can be used to augment existing code without having to re-write everything around Marionette.</p>

      <p><strong>The RequireJS version</strong>: Using Marionette with RequireJS helps to create a modularized application architecture - a tremendously important concept in scaling JavaScript applications. RequireJS provides a powerful set of tools that can be leveraged to great advantage, making Marionette even more flexible than it already is.</p>

      <p><strong>The Marionette module version</strong>: RequireJS isn't the only way to create a modularized application architecture, though. For those that wish to build applications in modules and namespaces, Marionette provides a built-in module and namespacing structure. This example application takes the simple version of the application and re-writes it in to a namespaced application architecture, with an application controller (mediator / workflow object) that brings all of the pieces together.</p>

      <p>Marionette certainly provides its share of opinions in how a Backbone application should be architected. The combination of modules, view types, event aggregator, application objects, and more, can be used to create a very powerful and flexible architecture based on these opinions. </p>

      <p>But as you can see, Marionette isn't a completely rigid, "my way or the highway" framework. It provides many elements of an application foundation that can be mixed and matched with other architectural styles, such as AMD or namespacing, or provide simple augmentation to existing projects by reducing boilerplate code for rendering views. </p>

      <p>This flexibility creates a much greater opportunity for Marionette to provide value to you and your projects, as it allows you to scale the use of Marionette with your application's needs.</p>

      <h3>
      <a name="user-content-and-so-much-more" class="anchor" href="#and-so-much-more"><span class="octicon octicon-link"></span></a>And So Much More</h3>

      <p>This is just the tip of the proverbial ice-berg for Marionette, even for the <code>ItemView</code> and <code>Region</code> objects that we've explored. There is far more functionality, more features, and more flexibility and customizability that can be put to use in both of these objects. Then we have the other dozen or so components that Marionette provides, each with their own set of behaviors built in, customization and extension points, and more. </p>

      <p>To learn more about Marionette, it's components, the features they provide and how to use them, check out the Marionette documentation, links to the wiki, to the source code, the project core contributors, and much more at <a href="http://marionettejs.com">http://marionettejs.com</a>. </p>

      <p>&nbsp;</p>

      <p>&nbsp;</p>

      <h2>
      <a name="user-content-paginating-backbonejs-requests--collections" class="anchor" href="#paginating-backbonejs-requests--collections"><span class="octicon octicon-link"></span></a>Paginating Backbone.js Requests &amp; Collections</h2>

      <p>Pagination is a ubiquitous problem we often find ourselves needing to solve on the web. Perhaps most predominantly when working with back-end APIs and JavaScript-heavy clients which consume them.</p>

      <p>On this topic, we're going to go through a set of <strong>pagination components</strong> I wrote for Backbone.js, which should hopefully come in useful if you're working on applications which need to tackle this problem. They're part of an extension called <a href="http://github.com/addyosmani/backbone-paginator">Backbone.Paginator</a>.</p>

      <p>When working with a structural framework like Backbone.js, the three types of pagination we are most likely to run into are:</p>

      <p><strong>Requests to a service layer (API)</strong>- e.g query for results containing the term 'Brendan' - if 5,000 results are available only display 20 results per page (leaving us with 250 possible result pages that can be navigated to).</p>

      <p>This problem actually has quite a great deal more to it, such as maintaining persistence of other URL parameters (e.g sort, query, order) which can change based on a user's search configuration in a UI. One also had to think of a clean way of hooking views up to this pagination so you can easily navigate between pages (e.g First, Last, Next, Previous, 1,2,3), manage the number of results displayed per page and so on.</p>

      <p><strong>Further client-side pagination of data returned -</strong> e.g we've been returned a JSON response containing 100 results. Rather than displaying all 100 to the user, we only display 20 of these results within a navigatable UI in the browser.</p>

      <p>Similar to the request problem, client-pagination has its own challenges like navigation once again (Next, Previous, 1,2,3), sorting, order, switching the number of results to display per page and so on.</p>

      <p><strong>Infinite results</strong> - with services such as Facebook, the concept of numeric pagination is instead replaced with a 'Load More' or 'View More' button. Triggering this normally fetches the next 'page' of N results but rather than replacing the previous set of results loaded entirely, we simply append to them instead.</p>

      <p>A request pager which simply appends results in a view rather than replacing on each new fetch is effectively an 'infinite' pager.</p>

      <p><strong>Let's now take a look at exactly what we're getting out of the box:</strong></p>

      <p><em>Paginator is a set of opinionated components for paginating collections of data using Backbone.js. It aims to provide both solutions for assisting with pagination of requests to a server (e.g an API) as well as pagination of single-loads of data, where we may wish to further paginate a collection of N results into M pages within a view.</em></p>

      <h2>
      <a name="user-content-paginators-pieces" class="anchor" href="#paginators-pieces"><span class="octicon octicon-link"></span></a>Paginator's pieces</h2>

      <p>Backbone.Paginator supports two main pagination components:</p>

      <ul>
      <li>
      <strong>Backbone.Paginator.requestPager</strong>: For pagination of requests between a client and a server-side API</li>
      <li>
      <strong>Backbone.Paginator.clientPager</strong>: For pagination of data returned from a server which you would like to further paginate within the UI (e.g 60 results are returned, paginate into 3 pages of 20)</li>
      </ul><h2>
      <a name="user-content-live-examples" class="anchor" href="#live-examples"><span class="octicon octicon-link"></span></a>Live Examples</h2>

      <p>Live previews of both pagination components using the Netflix API can be found below. Fork the repository to experiment with these examples further.</p>

      <ul>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-request-paging/index.html">Backbone.Paginator.requestPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-client-paging/index.html">Backbone.Paginator.clientPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-infinite-paging/index.html">Infinite Pagination (Backbone.Paginator.requestPager())</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/google-diacritic/index.html">Diacritic Plugin</a></li>
      </ul><h2>
      <a name="user-content-paginatorrequestpager" class="anchor" href="#paginatorrequestpager"><span class="octicon octicon-link"></span></a>Paginator.requestPager</h2>

      <p>In this section we're going to walkthrough actually using the requestPager.</p>

      <h4>
      <a name="user-content-1-create-a-new-paginated-collection" class="anchor" href="#1-create-a-new-paginated-collection"><span class="octicon octicon-link"></span></a>1. Create a new Paginated collection</h4>

      <p>First, we define a new Paginated collection using <code>Backbone.Paginator.requestPager()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">requestPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      </pre></div>

      <h4>
      <a name="user-content-2-set-the-model-for-the-collection-as-normal" class="anchor" href="#2-set-the-model-for-the-collection-as-normal"><span class="octicon octicon-link"></span></a>2: Set the model for the collection as normal</h4>

      <p>Within our collection, we then (as normal) specify the model to be used with this collection followed by the URL (or base URL) for the service providing our data (e.g the Netflix API).</p>

      <div class="highlight highlight-javascript"><pre>        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre></div>

      <h4>
      <a name="user-content-3-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#3-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>3. Configure the base URL and the type of the request</h4>

      <p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/Catalog/People(49446)/TitlesActedIn?'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-4-configure-how-the-library-will-show-the-results" class="anchor" href="#4-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>4. Configure how the library will show the results</h4>

      <p>We need to tell the library how many items per page would we like to see, etc...</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-5-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#5-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>5. Configure the parameters we want to send to the server</h4>

      <p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-6-finally-configure-collectionparse-and-were-done" class="anchor" href="#6-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>6. Finally, configure Collection.parse() and we're done</h4>

      <p>The last thing we need to do is configure our collection's <code>parse()</code> method. We want to ensure we're returning the correct part of our JSON response containing the data our collection will be populated with, which below is <code>response.d.results</code> (for the Netflix API).</p>

      <p>You might also notice that we're setting <code>this.totalPages</code> to the total page count returned by the API. This allows us to define the maximum number of (result) pages available for the current/last request so that we can clearly display this in the UI. It also allows us to infuence whether clicking say, a 'next' button should proceed with a request or not.</p>

      <div class="highlight highlight-javascript"><pre>        <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// Be sure to change this based on how your results</span>
                  <span class="c1">// are structured (e.g d.results is Netflix specific)</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="c1">//Normally this.totalPages would equal response.d.__count</span>
                  <span class="c1">//but as this particular NetFlix request only returns a</span>
                  <span class="c1">//total count of items for the search, we divide.</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">totalPages</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">__count</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span><span class="p">);</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-convenience-methods" class="anchor" href="#convenience-methods"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>

      <p>For your convenience, the following methods are made available for use in your views to interact with the <code>requestPager</code>:</p>

      <ul>
      <li>
      <strong>Collection.goTo( n, options )</strong> - go to a specific page</li>
      <li>
      <strong>Collection.requestNextPage( options )</strong> - go to the next page</li>
      <li>
      <strong>Collection.requestPreviousPage( options )</strong> - go to the previous page</li>
      <li>
      <strong>Collection.howManyPer( n )</strong> - set the number of items to display per page</li>
      </ul><p><strong>requestPager</strong> collection's methods <code>.goTo()</code>, <code>.requestNextPage()</code> and <code>.requestPreviousPage()</code> are all extension of the original <a href="http://documentcloud.github.com/backbone/#Collection-fetch">Backbone Collection.fetch() method</a>. As so, they all can take the same option object as parameter.</p>

      <p>This option object can use <code>success</code> and <code>error</code> parameters to pass a function to be executed after server answer.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>To manage callback, you could also use the <a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHR</a> returned by these methods to manage callback.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span>
        <span class="p">.</span><span class="nx">requestNextPage</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// do something after server request is complete</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>If you'd like to add the incoming models to the current collection, instead of replacing the collection's contents, pass <code>{add: true}</code> as an option to these methods.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">requestPreviousPage</span><span class="p">({</span> <span class="nx">add</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-paginatorclientpager" class="anchor" href="#paginatorclientpager"><span class="octicon octicon-link"></span></a>Paginator.clientPager</h2>

      <p>The <code>clientPager</code> works similar to the <code>requestPager</code>, except that our configuration values influence the pagination of data already returned at a UI-level. Whilst not shown (yet) there is also a lot more UI logic that ties in with the <code>clientPager</code>. An example of this can be seen in 'views/clientPagination.js'.</p>

      <h4>
      <a name="user-content-1-create-a-new-paginated-collection-with-a-model-and-url" class="anchor" href="#1-create-a-new-paginated-collection-with-a-model-and-url"><span class="octicon octicon-link"></span></a>1. Create a new paginated collection with a model and URL</h4>

      <p>As with <code>requestPager</code>, let's first create a new Paginated <code>Backbone.Paginator.clientPager</code> collection, with a model:</p>

      <div class="highlight highlight-javascript"><pre>    <span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre></div>

      <h4>
      <a name="user-content-2-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#2-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>2. Configure the base URL and the type of the request</h4>

      <p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/v2/Catalog/Titles?&amp;'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-3-configure-how-the-library-will-show-the-results" class="anchor" href="#3-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>3. Configure how the library will show the results</h4>

      <p>We need to tell the library how many items per page would we like to see, etc...</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-4-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#4-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>4. Configure the parameters we want to send to the server</h4>

      <p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">'substringof(\'america\',Name)'</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-5-finally-configure-collectionparse-and-were-done" class="anchor" href="#5-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>5. Finally, configure Collection.parse() and we're done</h4>

      <p>And finally we have our <code>parse()</code> method, which in this case isn't concerned with the total number of result pages available on the server as we have our own total count of pages for the paginated data in the UI.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-convenience-methods-1" class="anchor" href="#convenience-methods-1"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>

      <p>As mentioned, your views can hook into a number of convenience methods to navigate around UI-paginated data. For <code>clientPager</code> these include:</p>

      <ul>
      <li>
      <strong>Collection.goTo(n)</strong> - go to a specific page</li>
      <li>
      <strong>Collection.previousPage()</strong> - go to the previous page</li>
      <li>
      <strong>Collection.nextPage()</strong> - go to the next page</li>
      <li>
      <strong>Collection.howManyPer(n)</strong> - set how many items to display per page</li>
      <li>
      <strong>Collection.setSort(sortBy, sortDirection)</strong> - update sort on the current view. Sorting will automatically detect if you're trying to sort numbers (even if they're strored as strings) and will do the right thing.</li>
      <li>
      <strong>Collection.setFilter(filterFields, filterWords)</strong> - filter the current view. Filtering supports multiple words without any specific order, so you'll basically get a full-text search ability. Also, you can pass it only one field from the model, or you can pass an array with fields and all of them will get filtered. Last option is to pass it an object containing a comparison method and rules. Currently, only <code>levenshtein</code> method is available.</li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">setFilter</span><span class="p">(</span>
          <span class="p">{</span><span class="s1">'Name'</span><span class="o">:</span> <span class="p">{</span><span class="nx">cmp_method</span><span class="o">:</span> <span class="s1">'levenshtein'</span><span class="p">,</span> <span class="nx">max_distance</span><span class="o">:</span> <span class="mi">7</span><span class="p">}}</span>
          <span class="p">,</span> <span class="s1">'Amreican P'</span> <span class="c1">// Note the switched 'r' and 'e', and the 'P' from 'Pie'</span>
        <span class="p">);</span>
      </pre></div>

      <p>Also note that the levenshtein plugin should be loaded and enabled using the <code>useLevenshteinPlugin</code> variable.</p>

      <p>Last but not less important: Performing Levenshtein comparison returns the <code>distance</code> between to strings. It won't let you <em>search</em> lenghty text.</p>

      <p>The distance between two strings means the number of characters that should be added, removed or moved to the left or to the right so the strings get equal.</p>

      <p>That means that comparing "Something" in "This is a test that could show something" will return 32, which is bigger than comparing "Something" and "ABCDEFG" (9).</p>

      <p>Use levenshtein only for short texts (titles, names, etc).</p>

      <ul>
      <li><p><strong>Collection.doFakeFilter(filterFields, filterWords)</strong> - returns the models count after fake-applying a call to <code>Collection.setFilter</code>.</p></li>
      <li><p><strong>Collection.setFieldFilter(rules)</strong> - filter each value of each model according to <code>rules</code> that you pass as argument. Example: You have a collection of books with 'release year' and 'author'. You can filter only the books that were released between 1999 and 2003. And then you can add another <code>rule</code> that will filter those books only to authors who's name start with 'A'. Possible rules: function, required, min, max, range, minLength, maxLength, rangeLength, oneOf, equalTo, pattern.</p></li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="nx">my_collection</span><span class="p">.</span><span class="nx">setFieldFilter</span><span class="p">([</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'release_year'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'range'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="s1">'1999'</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="s1">'2003'</span><span class="p">}},</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'author'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'pattern'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'A*'</span><span class="p">,</span> <span class="s1">'igm'</span><span class="p">)}</span>
        <span class="p">]);</span>

        <span class="c1">//Rules:</span>
        <span class="c1">//</span>
        <span class="c1">//var my_var = 'green';</span>
        <span class="c1">//</span>
        <span class="c1">//{field: 'color', type: 'equalTo', value: my_var}</span>
        <span class="c1">//{field: 'color', type: 'function', value: function(field_value){ return field_value == my_var; } }</span>
        <span class="c1">//{field: 'color', type: 'required'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'min', value: '2'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'max', value: '4'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'range', value: {min: '2', max: '4'} }</span>
        <span class="c1">//{field: 'color_name', type: 'minLength', value: '4'}</span>
        <span class="c1">//{field: 'color_name', type: 'maxLength', value: '6'}</span>
        <span class="c1">//{field: 'color_name', type: 'rangeLength', value: {min: '4', max: '6'}}</span>
        <span class="c1">//{field: 'color_name', type: 'oneOf', value: ['green', 'yellow']}</span>
        <span class="c1">//{field: 'color_name', type: 'pattern', value: new RegExp('gre*', 'ig')}</span>

      </pre></div>

      <ul>
      <li>
      <strong>Collection.doFakeFieldFilter(rules)</strong> - returns the models count after fake-applying a call to <code>Collection.setFieldFilter</code>.</li>
      </ul><h4>
      <a name="user-content-implementation-notes" class="anchor" href="#implementation-notes"><span class="octicon octicon-link"></span></a>Implementation notes:</h4>

      <p>You can use some variables in your <code>View</code> to represent the actual state of the paginator.</p>

      <p><code>totalUnfilteredRecords</code> - Contains the number of records, including all records filtered in any way. (Only available in <code>clientPager</code>)</p>

      <p><code>totalRecords</code> - Contains the number of records</p>

      <p><code>currentPage</code> - The actual page were the paginator is at.</p>

      <p><code>perPage</code> - The number of records the paginator will show per page.</p>

      <p><code>totalPages</code> - The number of total pages.</p>

      <p><code>startRecord</code> - The posicion of the first record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>

      <p><code>endRecord</code> - The posicion of the last record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>

      <h2>
      <a name="user-content-plugins" class="anchor" href="#plugins"><span class="octicon octicon-link"></span></a>Plugins</h2>

      <p><strong>Diacritic.js</strong></p>

      <p>A plugin for Backbone.Paginator that replaces diacritic characters (ă,ş,ţ etc) with characters that match them most closely. This is particularly useful for filtering.</p>

      <p>To enable the plugin, set <code>this.useDiacriticsPlugin</code> to true, as can be seen in the example below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default values used when sorting and/or filtering.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">useDiacriticsPlugin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// use diacritics plugin if available</span>
          <span class="p">...</span>
      </pre></div>

      <h1>
      <a name="user-content-mobile-applications" class="anchor" href="#mobile-applications"><span class="octicon octicon-link"></span></a>Mobile Applications</h1>

      <h2>
      <a name="user-content-backbone--jquery-mobile" class="anchor" href="#backbone--jquery-mobile"><span class="octicon octicon-link"></span></a>Backbone &amp; jQuery Mobile</h2>

      <h3>
      <a name="user-content-resolving-the-routing-conflicts" class="anchor" href="#resolving-the-routing-conflicts"><span class="octicon octicon-link"></span></a>Resolving the routing conflicts</h3>

      <p>The first major hurdle developers typically run into when building Backbone applications with jQuery Mobile is that both frameworks have their own opinions about how to handle application navigation.</p>

      <p>Backbone's routers offer an explicit way to define custom navigation routes through <code>Backbone.Router</code>, whilst jQuery Mobile encourages the use of URL hash fragments to reference separate 'pages' or views in the same document. jQuery Mobile also supports automatically pulling in external content for links through XHR calls meaning that there can be quite a lot of inter-framework confusion about what a link pointing at '#photo/id' should actually be doing.</p>

      <p>Some of the solutions that have been previously proposed to work-around this problem included manually patching Backbone or jQuery Mobile. I discourage opting for these techniques as it becomes necessary to manually patch your framework builds when new releases get made upstream.</p>

      <p>There's also <a href="https://github.com/azicchetti/jquerymobile-router">jQueryMobile router</a>, which tries to solve this problem differently, however I think my proposed solution is both simpler and allows both frameworks to cohabit quite peacefully without the need to extend either. What we're after is a way to prevent one framework from listening to hash changes so that we can fully rely on the other (e.g. <code>Backbone.Router</code>) to handle this for us exclusively.</p>

      <p>Using jQuery Mobile this can be done by setting:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">hashListeningEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre></div>

      <p>prior to initializing any of your other code.</p>

      <p>I discovered this method looking through some jQuery Mobile commits that didn't make their way into the official docs, but am happy to see that they are now covered here <a href="http://jquerymobile.com/test/docs/api/globalconfig.html">http://jquerymobile.com/test/docs/api/globalconfig.html</a> in more detail.</p>

      <p>The next question that arises is, if we're preventing jQuery Mobile from listening to URL hash changes, how can we still get the benefit of being able to navigate to other sections in a document using the built-in transitions and effects supported? Good question. This can now be solve by simply calling <code>$.mobile.changePage()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'#about'</span><span class="p">,</span>
          <span class="nx">effect</span> <span class="o">=</span> <span class="s1">'slideup'</span><span class="p">,</span>
          <span class="nx">reverse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">changeHash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">changePage</span><span class="p">(</span> <span class="nx">url</span> <span class="p">,</span> <span class="p">{</span> <span class="nx">transition</span><span class="o">:</span> <span class="nx">effect</span><span class="p">},</span> <span class="nx">reverse</span><span class="p">,</span> <span class="nx">changeHash</span> <span class="p">);</span>
      </pre></div>

      <p>In the above sample, <code>url</code> can refer to a URL or a hash identifier to navigate to, <code>effect</code> is simply the transition effect to animate the page in with and the final two parameters decide the direction for the transition (<code>reverse</code>) and whether or not the hash in the address bar should be updated (<code>changeHash</code>). With respect to the latter, I typically set this to false to avoid managing two sources for hash updates, but feel free to set this to true if you're comfortable doing so.</p>

      <p><strong>Note:</strong> For some parallel work being done to explore how well the jQuery Mobile Router plugin works with Backbone, you may be interested in checking out <a href="https://github.com/Filirom1/jquery-mobile-backbone-requirejs">https://github.com/Filirom1/jquery-mobile-backbone-requirejs</a>.</p>

      <h3>
      <a name="user-content-practical-a-backbone-requirejsamd-app-with-jquery-mobile" class="anchor" href="#practical-a-backbone-requirejsamd-app-with-jquery-mobile"><span class="octicon octicon-link"></span></a>Practical: A Backbone, Require.js/AMD app with jQuery Mobile</h3>

      <p><strong>Note:</strong> The code for this practical can be found in <code>practicals/modular-mobile-app</code>.</p>

      <h3>
      <a name="user-content-getting-started-2" class="anchor" href="#getting-started-2"><span class="octicon octicon-link"></span></a>Getting started</h3>

      <p>Once you feel comfortable with the <a href="http://msdn.microsoft.com/en-us/scriptjunkie/hh377172.aspx">Backbone fundamentals</a> and you've put together a rough wireframe of the app you may wish to build, start to think about your application architecture. Ideally, you'll want to logically separate concerns so that it's as easy as possible to maintain the app in the future.</p>

      <p><strong>Namespacing</strong></p>

      <p>For this application, I opted for the nested namespacing pattern. Implemented correctly, this enables you to clearly identify if items being referenced in your app are views, other modules and so on. This initial structure is a sane place to also include application defaults (unless you prefer maintaining those in a separate file).</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">||</span> <span class="p">{</span>
          <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">appview</span><span class="o">:</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">routers</span><span class="o">:</span><span class="p">{</span>
              <span class="nx">workspace</span><span class="o">:</span><span class="k">new</span> <span class="nx">Workspace</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">utils</span><span class="o">:</span> <span class="nx">utils</span><span class="p">,</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">resultsPerPage</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
              <span class="nx">safeSearch</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nx">maxDate</span><span class="o">:</span><span class="s1">''</span><span class="p">,</span>
              <span class="nx">minDate</span><span class="o">:</span><span class="s1">'01/01/1970'</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong>Models</strong></p>

      <p>In the Flickly application, there are at least two unique types of data that need to be modeled - search results and individual photos, both of which contain additional meta-data like photo titles. If you simplify this down, search results are actually groups of photos in their own right, so the application only requires:</p>

      <ul>
      <li>A single model (a photo or 'result' entry)</li>
      <li>A result collection (containing a group of result entries) for search results</li>
      <li>A photo collection (containing one or more result entries) for individual photos or photos with more than one image</li>
      </ul><p><strong>Views</strong></p>

      <p>The views we'll need include an application view, a search results view and a photo view. Static views or pages of the single-page application which do not require a dynamic element to them (e.g an 'about' page) can be easily coded up in your document's markup, independent of Backbone.</p>

      <p><strong>Routers</strong></p>

      <p>A number of possible routes need to be taken into consideration:</p>

      <ul>
      <li>Basic search queries <code>#search/kiwis</code>
      </li>
      <li>Search queries with additional parameters (e.g sort, pagination) <code>#search/kiwis/srelevance/p7</code>
      </li>
      <li>Queries for specific photos <code>#photo/93839</code>
      </li>
      <li>A default route (no parameters passed)</li>
      </ul><p>This tutorial will be expanded shortly to fully cover the demo application. In the mean time, please see the practicals folder for the completed application that demonstrates the router resolution discussed earlier between Backbone and jQuery Mobile.</p>

      <h3>
      <a name="user-content-jquery-mobile-going-beyond-mobile-application-development" class="anchor" href="#jquery-mobile-going-beyond-mobile-application-development"><span class="octicon octicon-link"></span></a>jQuery Mobile: Going beyond mobile application development</h3>

      <p>The majority of jQM apps I've seen in production have been developed for the purpose of providing an optimal experience to users on mobile devices. Given that the framework was developed for this purpose, there's nothing fundamentally wrong with this, but many developers forget that jQM is a UI framework not dissimilar to jQuery UI. It's using the widget factory and is capable of being used for a lot more than we give it credit for.</p>

      <p>If you open up Flickly in a desktop browser, you'll get an image search UI that's modeled on Google.com, however, review the components (buttons, text inputs, tabs) on the page for a moment. The desktop UI doesn't look anything like a mobile application yet I'm still using jQM for theming mobile components; the tabs, date-picker, sliders - everything in the desktop UI is re-using what jQM would be providing users on mobile devices. Thanks to some media queries, the desktop UI can make optimal use of whitespace, expanding component blocks out and providing alternative layouts whilst still making use of jQM as a component framework.</p>

      <p>The benefit of this is that I don't need to go pulling in jQuery UI separately to be able to take advantage of these features. Thanks to the recent ThemeRoller my components can look pretty much exactly how I would like them to and users of the app can get a jQM UI for lower-resolutions and a jQM-ish UI for everything else.</p>

      <p>The takeaway here is just to remember that if you're not (already) going through the hassle of conditional script/style loading based on screen-resolution (using matchMedia.js etc), there are simpler approaches that can be taken to cross-device component theming.</p>

      <h1>
      <a name="user-content-unit-testing" class="anchor" href="#unit-testing"><span class="octicon octicon-link"></span></a>Unit Testing</h1>

      <h2>
      <a name="user-content-unit-testing-backbone-applications-with-jasmine" class="anchor" href="#unit-testing-backbone-applications-with-jasmine"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With Jasmine</h2>

      <h2>
      <a name="user-content-introduction-3" class="anchor" href="#introduction-3"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>One definition of unit testing is the process of taking the smallest piece of testable code in an application, isolating it from the remainder of your codebase and determining if it behaves exactly as expected. In this section, we'll be taking a look at how to unit test Backbone applications using a popular JavaScript testing framework called <a href="http://pivotal.github.com/jasmine/">Jasmine</a> from Pivotal Labs.</p>

      <p>For an application to be considered 'well'-tested, distinct functionality should ideally have its own separate unit tests where it's tested against the different conditions you expect it to work under. All tests must pass before functionality is considered 'complete'. This allows developers to both modify a unit of code and its dependencies with a level of confidence about whether these changes have caused any breakage.</p>

      <p>As a basic example of unit testing is where a developer may wish to assert whether passing specific values through to a sum function results in the correct output being returned. For an example more relevant to this book, we may wish to assert whether a user adding a new Todo item to a list correctly adds a Model of a specific type to a Todos Collection.</p>

      <p>When building modern web-applications, it's typically considered best-practice to include automated unit testing as a part of your development process. Whilst we'll be focusing on Jasmine as a solution for this, there are a number of other alternatives worth considering, including QUnit.</p>

      <h2>
      <a name="user-content-jasmine" class="anchor" href="#jasmine"><span class="octicon octicon-link"></span></a>Jasmine</h2>

      <p>Jasmine describes itself as a behavior-driven development (BDD) framework for testing JavaScript code. Before we jump into how the framework works, it's useful to understand exactly what <a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">BDD</a> is.</p>

      <p>BDD is a second-generation testing approach first described by <a href="http://dannorth.net/introducing-bdd/">Dan North</a> (the authority on BDD) which attempts to test the behavior of software. It's considered second-generation as it came out of merging ideas from Domain driven design (DDD) and lean software development, helping teams to deliver high quality software by answering many of the more confusing questions early on in the agile process. Such questions commonly include those concerning documentation and testing.</p>

      <p>If you were to read a book on BDD, it's likely to also be described as being 'outside-in and pull-based'. The reason for this is that it borrows the idea of pulling features from Lean manufacturing which effectively ensures that the right software solutions are being written by a) focusing on expected outputs of the system and b) ensuring these outputs are achieved.</p>

      <p>BDD recognizes that there are usually multiple stakeholders in a project and not a single amorphous user of the system. These different groups will be affected by the software being written in differing ways and will have a varying opinion of what quality in the system means to them. It's for this reason that it's important to understand who the software will be bringing value you and exactly what in it will be valuable to them.</p>

      <p>Finally, BDD relies on automation. Once you've defined the quality expected, your team will likely want to check on the functionality of the solution being built regularly and compare it to the results they expect. In order to facilitate this efficiently, the process has to be automated. BDD relies heavily on the automation of specification-testing and Jasmine is a tool which can assist with this.</p>

      <p>BDD helps both developers and non-technical stakeholders:</p>

      <ul>
      <li>Better understand and represent the models of the problems being solved</li>
      <li>Explain supported tests cases in a language that non-developers can read</li>
      <li>Focus on minimizing translation of the technical code being written and the domain language spoken by the business</li>
      </ul><p>What this means is that developers should be able to show Jasmine unit tests to a project stakeholder and (at a high level, thanks to a common vocabulary being used) they'll ideally be able to understand what the code supports.</p>

      <p>Developers often implement BDD in unison with another testing paradigm known as <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> (test-driven development). The main idea behind TDD is:</p>

      <ul>
      <li>Write unit tests which describe the functionality you would like your code to support</li>
      <li>Watch these tests fail (as the code to support them hasn't yet been written)</li>
      <li>Write code to make the tests pass</li>
      <li>Rinse, repeat and refactor</li>
      </ul><p>In this chapter we're going to use both BDD (with TDD) to write unit tests for a Backbone application.</p>

      <p><strong><em>Note:</em></strong> I've seen a lot of developers also opt for writing tests to validate behavior of their code after having written it. While this is fine, note that it can come with pitfalls such as only testing for behavior your code currently supports, rather than behavior the problem needs to be supported.</p>

      <h2>
      <a name="user-content-suites-specs--spies" class="anchor" href="#suites-specs--spies"><span class="octicon octicon-link"></span></a>Suites, Specs &amp; Spies</h2>

      <p>When using Jasmine, you'll be writing suites and specifications (specs). Suites basically describe scenarios whilst specs describe what can be done in these scenarios.</p>

      <p>Each spec is a JavaScript function, described with a call to <code>it()</code> using a description string and a function. The description should describe the behaviour the particular unit of code should exhibit and keeping in mind BDD, it should ideally be meaningful. Here's an example of a basic spec:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>On its own, a spec isn't particularly useful until expectations are set about the behavior of the code. Expectations in specs are defined using the <code>expect()</code> function and an <a href="https://github.com/pivotal/jasmine/wiki/Matchers">expectation matcher</a> (e.g <code>toEqual()</code>, <code>toBeTruthy()</code>, <code>toContain()</code>). A revised example using an expectation matcher would look like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>The above code passes our behavioral expectation as <code>counter</code> equals 1. Notice how easy this was to read the expectation on the last line (you probably grokked it without any explanation).</p>

      <p>Specs are grouped into suites which we describe using Jasmine's <code>describe()</code> function, again passing a string as a description and a function. The name/description for your suite is typically that of the component or module you're testing.</p>

      <p>Jasmine will use it as the group name when it reports the results of the specs you've asked it to run. A simple suite containing our sample spec could look like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Suites also share a functional scope and so it's possible to declare variables and functions inside a describe block which are accessible within specs:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 1</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 2</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p><strong><em>Note:</em></strong> Suites are executed in the order in which they are described, which can be useful to know if you would prefer to see test results for specific parts of your application reported first.</p>

      <p>Jasmine also supports <strong>spies</strong> - a way to mock, spy and fake behavior in our unit tests. Spies replace the function they're spying on, allowing us to simulate behavior we would like to mock (i.e test free of the actual implementation).</p>

      <p>In the below example, we're spying on the <code>setComplete</code> method of a dummy Todo function to test that arguments can be passed to it as expected.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="p">};</span>

      <span class="nx">Todo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">describe</span><span class="p">(</span><span class="s1">'a simple spy'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'should spy on an instance method of a Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>
              <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="kd">var</span> <span class="nx">myTodo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>

          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>What you're more likely to use spies for is testing <a href="http://en.wikipedia.org/wiki/Asynchronous_communication">asynchronous</a> behavior in your application such as AJAX requests. Jasmine supports:</p>

      <ul>
      <li>Writing tests which can mock AJAX requests using spies. This allows us to test code which runs before an AJAX request and right after. It's also possible to mock/fake responses the server can return and the benefit of this type of testing is that it's faster as no real calls are being made to a server</li>
      <li>Asynchronous tests which don't rely on spies</li>
      </ul><p>For the first kind of test, it's possible to both fake an AJAX request and verify that the request was both calling the correct URL and executed a callback where one was provided.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'the callback should be executed on success'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s1">'ajax'</span><span class="p">).</span><span class="nx">andCallFake</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
          <span class="p">});</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'url'</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'/todos/15'</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'' + id,</span>
      <span class="s1">        dataType: '</span><span class="nx">json</span><span class="err">'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you feel lost having seen matchers like <code>andCallFake()</code> and <code>toHaveBeenCalled()</code>, don't worry. All of these are Spy-specific matchers and are documented on the Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Spies">wiki</a>.</p>

      <p>For the second type of test (asynchronous tests), we can take the above further by taking advantage of three other methods Jasmine supports:</p>

      <ul>
      <li>runs(function) - a block which runs as if it was directly called</li>
      <li>waits(timeout) - a native timeout before the next block is run</li>
      <li>waitsFor(function, optional message, optional timeout) - a way to pause specs until some other work has completed. Jasmine waits until the supplied function returns true here before it moves on to the next block.</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should make an actual AJAX request to a server'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">waitsFor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="nx">runs</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
          <span class="p">});</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'todos.json'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong><em>Note:</em></strong> It's useful to remember that when making real requests to a web server in your unit tests, this has the potential to massively slow down the speed at which tests run (due to many factors including server latency). As this also introduces an external dependency that can (and should) be minimized in your unit testing, it is strongly recommended that you opt for spies to remove the need for a web server to be used here.</p>

      <h2>
      <a name="user-content-beforeeach-and-aftereach" class="anchor" href="#beforeeach-and-aftereach"><span class="octicon octicon-link"></span></a>beforeEach and afterEach()</h2>

      <p>Jasmine also supports specifying code that can be run before each (<code>beforeEach()</code>) and after each (<code>afterEach</code>) test. This is useful for enforcing consistent conditions (such as resetting variables that may be required by specs). In the following example, <code>beforeEach()</code> is used to create a new sample Todo model specs can use for testing attributes.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'Buy some more groceries'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
         <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">'should contain a text value if not the default value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'Buy some more groceries'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Each nested <code>describe()</code> in your tests can have their own <code>beforeEach()</code> and <code>afterEach()</code> methods which support including setup and teardown methods relevant to a particular suite. We'll be using <code>beforeEach()</code> in practice a little later.</p>

      <h2>
      <a name="user-content-shared-scope" class="anchor" href="#shared-scope"><span class="octicon octicon-link"></span></a>Shared scope</h2>

      <p>In the previous section you may have noticed that we initially declared a variable <code>this.todo</code> in our <code>beforeEach()</code> call and were then able to continue using this in <code>afterEach()</code>. This is thanks to a powerful feature of Jasmine known as shared  functional scope. Shared scope allows <code>this</code> properties to be common to all blocks (including <code>runs()</code>), but not declared variables (i.e <code>var</code>s).</p>

      <h2>
      <a name="user-content-getting-setup" class="anchor" href="#getting-setup"><span class="octicon octicon-link"></span></a>Getting setup</h2>

      <p>Now that we've reviewed some fundamentals, let's go through downloading Jasmine and getting everything setup to write tests.</p>

      <p>A standalone release of Jasmine can be <a href="http://pivotal.github.com/jasmine/download.html">downloaded</a> from the official release page.</p>

      <p>You'll need a file called SpecRunner.html in addition to the release. It can be downloaded from <a href="https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example">https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example</a> or as part of a download of the complete Jasmine <a href="https://github.com/pivotal/jasmine/zipball/master">repo</a>.Alternatively, you can <code>git clone</code> the main Jasmine repository from <a href="https://github.com/pivotal/jasmine.git">https://github.com/pivotal/jasmine.git</a>.</p>

      <p>Let's review <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/SpecRunner.html">SpecRunner.html</a>:</p>

      <p>It first includes both Jasmine and the necessary CSS required for reporting:</p>

      <pre><code>&lt;link rel="stylesheet" type="text/css" href="lib/jasmine-1.1.0.rc1/jasmine.css"/&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine-html.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>Next, some sample tests are included:</p>

      <pre><code>&lt;script type="text/javascript" src="spec/SpecHelper.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="spec/PlayerSpec.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>And finally the sources being tested:</p>

      <pre><code>&lt;script type="text/javascript" src="src/Player.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="src/Song.js"&gt;&lt;/script&gt;
      </code></pre>

      <p><strong><em>Note:</em></strong> Below this section of SpecRunner is code responsible for running the actual tests. Given that we won't be covering modifying this code, I'm going to skip reviewing it. I do however encourage you to take a look through <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/PlayerSpec.js">PlayerSpec.js</a> and <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/SpecHelper.js">SpecHelper.js</a>. They're a useful basic example to go through how a minimal set of tests might work.</p>

      <h2>
      <a name="user-content-tdd-with-backbone" class="anchor" href="#tdd-with-backbone"><span class="octicon octicon-link"></span></a>TDD With Backbone</h2>

      <p>When developing applications with Backbone, it can be necessary to test both individual modules of code as well as modules, views, collections and routers. Taking a TDD approach to testing, let's review some specs for testing these Backbone components using the popular Backbone <a href="https://github.com/addyosmani/todomvc/tree/master/todo-example/backbone">Todo</a> application. For this section we will be using a modified version of Larry Myers Backbone Koans project, which can be found in the <code>practicals\jasmine-koans</code> folder.</p>

      <h2>
      <a name="user-content-models-2" class="anchor" href="#models-2"><span class="octicon octicon-link"></span></a>Models</h2>

      <p>The complexity of Backbone models can vary greatly depending on what your application is trying to achieve. In the following example, we're going to test default values, attributes, state changes and validation rules.</p>

      <p>First, we begin our suite for model testing using <code>describe()</code>:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      </pre></div>

      <p>Models should ideally have default values for attributes. This helps ensure that when creating instances without a value set for any specific attribute, a default one (e.g '') is used instead. The idea here is to allow your application to interact with models without any unexpected behavior.</p>

      <p>In the following spec, we create a new Todo without any attributes passed then check to find out what the value of the <code>text</code> attribute is. As no value has been set, we expect a default value of <code>''</code> to be returned.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>If testing this spec before your models have been written, you'll incur a failing test, as expected. What's required for the spec to pass is a default value for the attribute <code>text</code>. We can implement this default value with some other useful defaults (which we'll be using shortly) in our Todo model as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">}</span>

      </pre></div>

      <p>Next, we want to test that our model will pass attributes that are set such that retrieving the value of these attributes after initialization will be what we expect. Notice that here, in addition to testing for an expected value for <code>text</code>, we're also testing the other default values are what we expect them to be.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Will set passed attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="c1">// what are the values expected here for each of the</span>
          <span class="c1">// attributes in our Todo?</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Get oil change for car.'');</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">done</span><span class="s1">')).toBe(false);</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">order</span><span class="err">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Backbone models support a model.change() event which is triggered when the state of a model changes. In the following example, by 'state' I'm referring to the value of a Todo model's attributes. The reason changes of state are important to test are that there may be state-dependent events in your application e.g you may wish to display a confirmation view once a Todo model has been updated.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-change event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="c1">// how do we monitor changes of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span><span class="p">);</span>

          <span class="c1">// what would you need to do to force a change of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">spy</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>It's common to include validation logic in your models to ensure both the input passed from users (and other modules) in the application are 'valid'. A Todo app may wish to validate the text input supplied in case it contains rude words. Similarly if we're storing the <code>done</code> state of a Todo item using booleans, we need to validate that truthy/falsy values are passed and not just any arbitrary string.</p>

      <p>In the following spec, we take advantage of the fact that validations which fail model.validate() trigger an "error" event. This allows us to test if validations are correctly failing when invalid input is supplied.</p>

      <p>We create an errorCallback spy using Jasmine's built in <code>createSpy()</code> method which allows us to spy on the error event as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-error event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>

          <span class="c1">// What would you need to set on the todo properties to</span>
          <span class="c1">// cause validation to fail?</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span><span class="s1">'a non-integer value'</span><span class="p">});</span>

          <span class="kd">var</span> <span class="nx">errorArgs</span> <span class="o">=</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Todo.done must be a boolean value.'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>The code to make the above failing test support validation is relatively simple. In our model, we override the validate() method (as recommended in the Backbone docs), checking to make sure a model both has a 'done' property and is a valid boolean before allowing it to pass.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you would like to review the final code for our Todo model, you can find it below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">NAUGHTY_WORDS</span> <span class="o">=</span> <span class="sr">/crap|poop|hell|frogs/gi</span><span class="p">;</span>

      <span class="kd">function</span> <span class="nx">sanitize</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">NAUGHTY_WORDS</span><span class="p">,</span> <span class="s1">'rainbows'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="nx">sanitize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">))},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-collections-2" class="anchor" href="#collections-2"><span class="octicon octicon-link"></span></a>Collections</h2>

      <p>We now need to define specs to tests a Backbone collection of Todo models (a TodoList). Collections are responsible for a number of list tasks including managing order and filtering.</p>

      <p>A few specific specs that come to mind when working with collections are:</p>

      <ul>
      <li>Making sure we can add new Todo models as both objects and arrays</li>
      <li>Attribute testing to make sure attributes such as the base URL of the collection are values we expect</li>
      <li>Purposefully adding items with a status of <code>done:true</code> and checking against how many items the collection thinks have been completed vs. those that are remaining</li>
      </ul><p>In this section we're going to cover the first two of these with the third left as an extended exercise I recommend trying out.</p>

      <p>Testing Todo models can be added to a collection as objects or arrays is relatively trivial. First, we initialize a new TodoList collection and check to make sure its length (i.e the number of Todo models it contains) is 0. Next, we add new Todos, both as objects and arrays, checking the length property of the collection at each stage to ensure the overall count is what we expect:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">});</span>

              <span class="c1">// how many todos have been added so far?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span><span class="p">}</span>
              <span class="p">]);</span>

              <span class="c1">// how many are there in total now?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">...</span>
      </pre></div>

      <p>Similar to model attributes, it's also quite straight-forward to test attributes in collections. Here we have a spec that ensures the collection.url (i.e the url reference to the collection's location on the server) is what we expect it to be:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="c1">// what has been specified as the url base in our model?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'/todos/'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>For the third spec, it's useful to remember that the implementation for our collection will have methods for filtering how many Todo items are done and how many are remaining - we can call these <code>done()</code> and <code>remaining()</code>. Consider writing a spec which creates a new collection and adds one new model that has a preset <code>done</code> state of <code>true</code> and two others that have the default <code>done</code> state of <code>false</code>. Testing the length of what's returned using <code>done()</code> and <code>remaining()</code> should allow us to know whether the state management in our application is working or needs a little tweaking.</p>

      <p>The final implementation for our TodoList collection can be found below:</p>

      <div class="highlight highlight-javascript"><pre> <span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'</span><span class="p">,</span>

              <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
              <span class="p">},</span>

              <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
              <span class="p">},</span>

              <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>

                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="p">},</span>

              <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-views-3" class="anchor" href="#views-3"><span class="octicon octicon-link"></span></a>Views</h2>

      <p>Before we take a look at testing Backbone views, let's briefly review a jQuery plugin that can assist with writing Jasmine specs for them.</p>

      <p><strong>The Jasmine jQuery Plugin</strong></p>

      <p>As we know our Todo application will be using jQuery for DOM manipulation, there's a useful jQuery plugin called <a href="https://github.com/velesin/jasmine-jquery">jasmine-jquery</a> we can use to help simplify BDD testing rendered elements that our views may produce.</p>

      <p>The plugin provides a number of additional Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Matchers">matchers</a> to help test jQuery wrapped sets such as:</p>

      <ul>
      <li>
      <code>toBe(jQuerySelector)</code> e.g <code>expect($('&lt;div id="some-id"&gt;&lt;/div&gt;')).toBe('div#some-id')</code>
      </li>
      <li>
      <code>toBeChecked()</code> e.g <code>expect($('&lt;input type="checkbox" checked="checked"/&gt;')).toBeChecked()</code>
      </li>
      <li>
      <code>toBeSelected()</code> e.g <code>expect($('&lt;option selected="selected"&gt;&lt;/option&gt;')).toBeSelected()</code>
      </li>
      </ul><p>and <a href="https://github.com/velesin/jasmine-jquery">many others</a>. The complete list of matchers supported can be found on the project homepage. It's useful to know that similar to the standard Jasmine matchers, the custom matchers above can be inverted using the .not prefix (i.e <code>expect(x).not.toBe(y)</code>):</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;div&gt;I am an example&lt;/div&gt;'</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="sr">/other/</span><span class="p">)</span>
      </pre></div>

      <p>jasmine-jquery also includes a fixtures model, allowing us to load in arbitrary HTML content we may wish to use in our tests. Fixtures can be used as follows:</p>

      <p>Include some HTML in an external fixtures file:</p>

      <p>some.fixture.html:
      <code>&lt;div id="sample-fixture"&gt;some HTML content&lt;/div&gt;</code></p>

      <p>Next, inside our actual test we would load it as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">loadFixtures</span><span class="p">(</span><span class="s1">'some.fixture.html'</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'some-fixture'</span><span class="p">).</span><span class="nx">myTestedPlugin</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#some-fixture'</span><span class="p">)).</span><span class="nx">to</span><span class="o">&lt;</span><span class="nx">the</span> <span class="nx">rest</span> <span class="nx">of</span> <span class="nx">your</span> <span class="nx">matcher</span> <span class="nx">would</span> <span class="nx">go</span> <span class="nx">here</span><span class="o">&gt;</span>
      </pre></div>

      <p>The jasmine-jquery plugin is by default setup to load fixtures from a specific directory: spec/javascripts/fixtures. If you wish to configure this path you can do so by initially setting <code>jasmine.getFixtures().fixturesPath = 'your custom path'</code>.</p>

      <p>Finally, jasmine-jquery includes support for spying on jQuery events without the need for any extra plumbing work. This can be done using the <code>spyOnEvent()</code> and <code>assert(eventName).toHaveBeenTriggered(selector)</code> functions. An example of usage may look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">spyOnEvent</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">),</span> <span class="s1">'click'</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="s1">'click'</span><span class="p">).</span><span class="nx">toHaveBeenTriggeredOn</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">));</span>
      </pre></div>

      <p><strong>View testing</strong></p>

      <p>In this section we will review three dimensions to writing specs for Backbone Views: initial setup, view rendering and finally templating. The latter two of these are the most commonly tested, however we'll review shortly why writing specs for the initialization of your views can also be of benefit.</p>

      <h2>
      <a name="user-content-initial-setup" class="anchor" href="#initial-setup"><span class="octicon octicon-link"></span></a>Initial setup</h2>

      <p>At their most basic, specs for Backbone views should validate that they are being correctly tied to specific DOM elements and are backed by valid data models. The reason to consider doing this is that failures to such specs can trip up more complex tests later on and they're fairly simple to write, given the overall value offered.</p>

      <p>To help ensure a consistent testing setup for our specs, we use <code>beforeEach()</code> to append both an empty <code>UL</code> (#todoList) to the DOM and initialize a new instance of a TodoView using an empty Todo model. <code>afterEach()</code> is used to remove the previous #todoList  <code>UL</code> as well as the previous instance of the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">});</span>


          <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">});</span>

      <span class="p">...</span>
      </pre></div>

      <p>The first spec useful to write is a check that the TodoView we've created is using the correct <code>tagName</code> (element or className). The purpose of this test is to make sure it's been correctly tied to a DOM element when it was created.</p>

      <p>Backbone views typically create empty DOM elements once initialized, however these elements are not attached to the visible DOM in order to allow them to be constructed without an impact on the performance of rendering.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">//what html element tag name represents this view?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'li'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Once again, if the TodoView has not already been written, we will experience failing specs. Thankfully, solving this is as simple as creating a new Backbone.View with a specific <code>tagName</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span>
      <span class="p">});</span>
      </pre></div>

      <p>If instead of testing against the <code>tagName</code> you would prefer to use a className instead, we can take advantage of jasmine-jquery's <code>toHaveClass()</code> matcher to cater for this.</p>

      <pre><code>it('Should have a class of "todos"'), function(){
         expect(this.view.$el).toHaveClass('todos');
      });
      </code></pre>

      <p>The <code>toHaveClass()</code> matcher operates on jQuery objects and if the plugin hadn't been used, an exception would have been incurred (it is of course also possible to test for the className by accessing el.className if not opting to use jasmine-jquery).</p>

      <p>You may have noticed that in <code>beforeEach()</code>, we passed our view an initial (albeit unfilled) Todo model. Views should be backed by a model instance which provides data. As this is quite important to our view's ability to function, we can write a spec to ensure a model is both defined (using the <code>toBeDefined()</code> matcher) and then test attributes of the model to ensure defaults both exist and are the value we expect them to be.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>

          <span class="c1">// what's the value for Todo.get('done') here?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span> <span class="c1">//or toBeFalsy()</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-view-rendering" class="anchor" href="#view-rendering"><span class="octicon octicon-link"></span></a>View rendering</h2>

      <p>Next we're going to take a look at writing specs for view rendering. Specifically, we want to test that our TodoView elements are actually rendering as expected.</p>

      <p>In smaller applications, those new to BDD might argue that visual confirmation of view rendering could replace unit testing of views. The reality is that when dealing with applications that might grow to multiple-views, it often makes sense to automate this process as much as possible from the get-go. There are also aspects of rendering that require verification beyond what is visually presented on-screen (which we'll see very shortly).</p>

      <p>We're going to begin testing views by writing two specs. The first spec will check that the view's <code>render()</code> method is correctly returning the view instance, which is necessary for chaining. Our second spec will check that the HTML produced is exactly what we expect based on the properties of the model instance that's been associated with our TodoView.</p>

      <p>Unlike some of the previous specs we've covered, this section will make greater use of <code>beforeEach()</code> to both demonstrate how to use nested suites and also ensure a consistent set of conditions for our specs. In our first view spec for TodoView, we're simply going to create a sample model (based on Todo) and instantiate a TodoView which associates it with the model.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'My Todo'</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Rendering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'returns the view object'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'produces the correct HTML'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">//let's use jasmine-jquery's toContain() to avoid</span>
            <span class="c1">//testing for the complete content of a todo's markup</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>Once these specs are run, only the second one ('produces the correct HTML') fails. Our first spec ('returns the view object'), which is testing that the TodoView instance is returned from <code>render()</code>, only passed as this is Backbone's default behavior. We haven't yet overwritten the <code>render()</code> method with our own version.</p>

      <p><strong>Note:</strong> For the purposes of maintaining readability, all template examples in this section will use a minimal version of the following Todo view template. As it's relatively trivial to expand this, please feel free to refer to this sample if needed:</p>

      <pre><code>&lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="&lt;%= content %&gt;" /&gt;
              &lt;/div&gt;
      &lt;/div&gt;
      </code></pre>

      <p>The second spec fails with the following message:</p>

      <p><code>Expected '' to contain '&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'.</code></p>

      <p>The reason for this is the default behavior for render() doesn't create any markup. Let's write a replacement for render() which fixes this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="s1">'&lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">template</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'&lt;%= text %&gt;'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>

      <p>The above specifies an inline string template and replaces fields found in the template within the "&lt;% %&gt;" blocks with their corresponding values from the associated model. As we're now also returning the TodoView instance from the method, the first spec will also pass. It's worth noting that there are serious drawbacks to using HTML strings in your specs to test against like this. Even minor changes to your template (a simple tab or whitespace) would cause your spec to fail, despite the rendered output being the same. It's also more time consuming to maintain as most templates in real-world applications are significantly more complex. A better option for testing rendered output is using jQuery to both select and inspect values.</p>

      <p>With this in mind, let's re-write the specs, this time using some of the custom matchers offered by jasmine-jquery:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>It would be impossible to discuss unit testing without mentioning fixtures. Fixtures typically contain test data (e.g HTML) that is loaded in when needed (either locally or from an external file) for unit testing. So far we've been establishing jQuery expectations based on the view's el property. This works for a number of cases, however, there are instances where it may be necessary to render markup into the document. The most optimal way to handle this within specs is through using fixtures (another feature brought to us by the jasmine-jquery plugin).</p>

      <p>Re-writing the last spec to use fixtures would look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="nx">setFixtures</span><span class="p">(</span><span class="s1">'&lt;ul class="todos"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="p">...</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>What we're now doing in the above spec is appending the rendered todo item into the fixture. We then set expectations against the fixture, which may be something desirable when a view is setup against an element which already exists in the DOM. It would be necessary to provide both the fixture and test the <code>el</code> property correctly picking up the element expected when the view is instantiated.</p>

      <h2>
      <a name="user-content-rendering-with-a-templating-system" class="anchor" href="#rendering-with-a-templating-system"><span class="octicon octicon-link"></span></a>Rendering with a templating system</h2>

      <p>JavaScript templating systems (such as Handlebars, Mustache and even Underscore's own Micro-templating) support conditional logic in template strings. What this effectively means is that we can add if/else/ternery expressions inline which can then be evaluated as needed, allowing us to build even more powerful templates.</p>

      <p>In our case, when a user sets a Todo item to be complete (done), we may wish to provide them with visual feedback (such as a striked line through the text) to differentiate the item from those that are remaining. This can be done by attaching a new class to the item. Let's begin by writing a test we would ideally like to work:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'When a todo is done'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has a done class'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos .todo-content:first-child'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveClass</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>This will fail with the following message:</p>

      <p>```Expected 'My Todo'
      to have class 'done'.</p>

      <pre><code>
      which can be fixed in the existing render() method as follows:


      ```javascript
      render: function() {
        var template = '&lt;label class="todo-content"&gt;' +
          '&lt;%= text %&gt;&lt;/label&gt;';
        var output = template
          .replace('&lt;%= text %&gt;', this.model.get('text'));
        this.$el.html(output);
        if (this.model.get('done')) {
          this.$('.todo-content').addClass('done');
        }
        return this;
      }
      </code></pre>

      <p>This can however get unwieldily fairly quickly. As the logic in our templates increases, so does the complexity involved. This is where templates libraries can help. As mentioned earlier, there are a number of popular options available, but for the purposes of this chapter we're going to stick to using Underscore's built-in Microtemplating. Whilst there are more advanced options you're free to explore, the benefit of this is that no additional files are required and we can easily change the existing Jasmine specs without too much adjustment.</p>

      <p>The TodoView object modified to use Underscore templating would look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre></div>

      <p>Above, the initialize() method compiles a supplied Underscore template (using the _.template() function) in the instantiation. A more common way of referencing templates is placing them in a script tag using a custom script type (e.g type="text/template"). As this isn't a script type any browser understands, it's simply ignored, however referencing the script by an id attribute allows the template to be kept separate to other parts of the page which wish to use it. In real world applications, it's preferable to either do this or load in templates stored in external files for testing.</p>

      <p>For testing purposes, we're going to continue using the string injection approach to keep things simple. There is however a useful trick that can be applied to automatically create or extend templates in the Jasmine scope for each test. By creating a new directory (say, 'templates') in the 'spec' folder and adding a new script file with the following contents, to jasmine.yml or SpecRunner.html, we can add a todo property which contains the Underscore template we wish to use:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content"&gt;'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>To finish this off, we simply update our existing spec to reference the template when instantiating the TodoView object:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">todo</span>
          <span class="p">});</span>
        <span class="p">});</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre></div>

      <p>The existing specs we've looked at would continue to pass using this approach, leaving us free to adjust the template with some additional conditional logic for Todos with a status of 'done':</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content &lt;%= done ? '</span><span class="nx">done</span><span class="s1">' : '' %&gt;"'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>This will now also pass without any issues. Remember that jasmine-jquery also supports loading external fixtures into your specs easily using its build in <code>loadFixtures()</code> and <code>readFixtures()</code> methods. For more information, consider reading the official jasmine-jquery <a href="https://github.com/velesin/jasmine-jquery">docs</a>.</p>

      <h2>
      <a name="user-content-conclusions-3" class="anchor" href="#conclusions-3"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>We have now covered how to write Jasmine tests for models, views and collections with Backbone.js. Whilst testing routing can at times be desirable, some developers feel it can be more optimal to leave this to third-party tools such as Selenium, so do keep this in mind.</p>

      <p>James Newbery was kind enough to help me with writing the Views section above and his articles on <a href="http://tinnedfruit.com/2011/04/26/testing-backbone-apps-with-jasmine-sinon-3.html">Testing Backbone Apps With SinonJS</a> were of great inspiration (you'll actually find some Handlebars examples of the view specs in part 3 of his article). If you would like to learn more about writing spies and mocks for Backbone using <a href="http://sinonjs.org">SinonJS</a> as well as how to test Backbone routers, do consider reading his series.</p>

      <h2>
      <a name="user-content-exercise" class="anchor" href="#exercise"><span class="octicon octicon-link"></span></a>Exercise</h2>

      <p>As an exercise, I recommend now trying the Jasmine Koans in <code>practicals\jasmine-joans</code> and trying to fix some of the purposefully failing tests it has to offer. This is an excellent way of not just learning how Jasmine specs and suites work, but working through the examples (without peeking back) will also put your Backbone skills to test too.</p>

      <h2>
      <a name="user-content-further-reading" class="anchor" href="#further-reading"><span class="octicon octicon-link"></span></a>Further reading</h2>

      <ul>
      <li><a href="http://japhr.blogspot.com/2011/11/jasmine-backbonejs-revisited.html">Jasmine + Backbone Revisited</a></li>
      <li><a href="http://japhr.blogspot.com/2011/12/phantomjs-and-backbonejs-and-requirejs.html">Backbone, PhantomJS and Jasmine</a></li>
      </ul><h2>
      <a name="user-content-unit-testing-backbone-applications-with-qunit-and-sinonjs" class="anchor" href="#unit-testing-backbone-applications-with-qunit-and-sinonjs"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With QUnit And SinonJS</h2>

      <h2>
      <a name="user-content-introduction-4" class="anchor" href="#introduction-4"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>QUnit is a powerful JavaScript test suite written by jQuery team member <a href="http://bassistance.de/">Jörn Zaefferer</a> and used by many large open-source projects (such as jQuery and Backbone.js) to test their code. It's both capable of testing standard JavaScript code in the browser as well as code on the server-side (where environments supported include Rhino, V8 and SpiderMonkey). This makes it a robust solution for a large number of use-cases.</p>

      <p>Quite a few Backbone.js contributors feel that QUnit is a better introductory framework for testing if you don't wish to start off with Jasmine and BDD right away. As we'll see later on in this chapter, QUnit can also be combined with third-party solutions such as SinonJS to produce an even more powerful testing solution supporting spies and mocks, which some say is preferable over Jasmine.</p>

      <p>My personal recommendation is that it's worth comparing both frameworks and opting for the solution that you feel the most comfortable with.</p>

      <h1>
      <a name="user-content-qunit" class="anchor" href="#qunit"><span class="octicon octicon-link"></span></a>QUnit</h1>

      <h2>
      <a name="user-content-getting-setup-1" class="anchor" href="#getting-setup-1"><span class="octicon octicon-link"></span></a>Getting Setup</h2>

      <p>Luckily, getting QUnit setup is a fairly straight-forward process that will take less than 5 minutes.</p>

      <p>We first setup a testing environment composed of three files:</p>

      <ul>
      <li>A HTML <strong>structure</strong> for displaying test results,</li>
      <li>The <strong>qunit.js</strong> file composing the testing framework and,</li>
      <li>The <strong>qunit.css</strong> file for styling test results.</li>
      </ul><p>The latter two of these can be downloaded from the <a href="http://qunitjs.com">QUnit website</a>.</p>

      <p>If you would prefer, you can use a hosted version of the QUnit source files for testing purposes. The hosted URLs can be found at [<a href="http://github.com/jquery/qunit/raw/master/qunit/">http://github.com/jquery/qunit/raw/master/qunit/</a>].</p>

      <h4>
      <a name="user-content-sample-html-with-qunit-compatible-markup" class="anchor" href="#sample-html-with-qunit-compatible-markup"><span class="octicon octicon-link"></span></a>Sample HTML with QUnit-compatible markup:</h4>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test Suite<span class="nt">&lt;/title&gt;</span>

           <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your application --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your tests --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test Suite<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;</span>test markup, hidden.<span class="nt">&lt;/ol&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>Let's go through the elements above with qunit mentioned in their ID. When QUnit is running:</p>

      <ul>
      <li>
      <strong>qunit-header</strong> shows the name of the test suite</li>
      <li>
      <strong>qunit-banner</strong> shows up as red if a test fails and green if all tests pass</li>
      <li>
      <strong>qunit-testrunner-toolbar</strong> contains additional options for configuring the display of tests</li>
      <li>
      <strong>qunit-userAgent</strong> displays the navigator.userAgent property</li>
      <li>
      <strong>qunit-tests</strong> is a container for our test results</li>
      </ul><p>When running correctly, the above test runner looks as follows:</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/7d4de12.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/7d4de12.png" alt="screenshot 1" style="max-width:100%;"></a></p>

      <p>The numbers of the form (a, b, c) after each test name correspond to a) failed asserts, b) passed asserts and c) total asserts. Clicking on a test name expands it to display all of the assertions for that test case. Assertions in green have successfully passed.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/9df4.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/9df4.png" alt="screenshot 2" style="max-width:100%;"></a></p>

      <p>If however any tests fail, the test gets highlighted (and the qunit-banner at the top switches to red):</p>

      <p><a href="/madflo/backbone-fundamentals/blob/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/3e5545.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/eb0984d29f631f462a73a6932fad7f1bc6baf49f/img/3e5545.png" alt="screenshot 3" style="max-width:100%;"></a></p>

      <h2>
      <a name="user-content-assertions" class="anchor" href="#assertions"><span class="octicon octicon-link"></span></a>Assertions</h2>

      <p>QUnit supports a number of basic <strong>assertions</strong>, which are used in testing to verify that the result being returned by our code is what we expect. If an assertion fails, we know that a bug exists.Similar to Jasmine, QUnit can be used to easily test for regressions. Specifically, when a bug is found one can write an assertion to test the existence of the bug, write a patch and then commit both. If subsequent changes to the code break the test you'll know what was responsible and be able to address it more easily.</p>

      <p>Some of the supported QUnit assertions we're going to look at first are:</p>

      <ul>
      <li>  <code>ok ( state, message )</code> - passes if the first argument is truthy</li>
      <li>  <code>equal ( actual, expected, message )</code> - a simple comparison assertion with type coercion</li>
      <li>  <code>notEqual ( actual, expected, message )</code> - the opposite of the above</li>
      <li>  <code>expect( amount )</code> - the number of assertions expected to run within each test</li>
      <li>  <code>strictEqual( actual, expected, message)</code> - offers a much stricter comparison than <code>equal()</code> and is considered the preferred method of checking equality as it avoids stumbling on subtle coercion bugs</li>
      <li>  <code>deepEqual( actual, expected, message )</code> - similar to <code>strictEqual</code>, comparing the contents (with <code>===</code>) of the given objects, arrays and primitives.</li>
      </ul><p>Creating new test cases with QUnit is relatively straight-forward and can be done using <code>test()</code>, which constructs a test where the first argument is the <code>name</code> of the test to be displayed in our results and the second is a <code>callback</code> function containing all of our assertions. This is called as soon as QUnit is running.</p>

      <h4>
      <a name="user-content-basic-test-case-using-test-name-callback-" class="anchor" href="#basic-test-case-using-test-name-callback-"><span class="octicon octicon-link"></span></a>Basic test case using test( name, callback ):</h4>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myString</span> <span class="o">=</span> <span class="s1">'Hello Backbone.js'</span><span class="p">;</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Our first QUnit test - asserting results'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// ok( boolean, message )</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">'the test succeeds'</span><span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'the test fails'</span><span class="p">);</span>

          <span class="c1">// equal( actualValue, expectedValue, message )</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">myString</span><span class="p">,</span> <span class="s1">'Hello Backbone.js'</span><span class="p">,</span> <span class="s1">'The value expected is Hello Backbone.js!'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>What we're doing in the above is defining a variable with a specific value and then testing to ensure the value was what we expected it to be. This was done using the comparison assertion, <code>equal()</code>, which expects its first argument to be a value being tested and the second argument to be the expected value. We also used <code>ok()</code>, which allows us to easily test against functions or variables that evaluate to booleans.</p>

      <p>Note: Optionally in our test case, we could have passed an 'expected' value to <code>test()</code> defining the number of assertions we expect to run. This takes the form: <code>test( name, [expected], test );</code> or by manually settings the expectation at the top of the test function, like so: <code>expect( 1 )</code>. I recommend you to make it a habit and always define how many assertions you expect. More on this later.</p>

      <p>As testing a simple static variable is fairly trivial, we can take this further to test actual functions. In the following example we test the output of a function that reverses a string to ensure that the output is correct using <code>equal()</code> and <code>notEqual()</code>:</p>

      <h4>
      <a name="user-content-comparing-the-actual-output-of-a-function-against-the-expected-output" class="anchor" href="#comparing-the-actual-output-of-a-function-against-the-expected-output"><span class="octicon octicon-link"></span></a>Comparing the actual output of a function against the expected output:</h4>

      <div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">reverseString</span><span class="p">(</span> <span class="nx">str</span> <span class="p">){</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'reverseString()'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">),</span> <span class="s1">'olleh'</span><span class="p">,</span> <span class="s1">'The value expected was olleh'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'foobar'</span><span class="p">),</span> <span class="s1">'raboof'</span><span class="p">,</span> <span class="s1">'The value expected was raboof'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlrow'</span><span class="p">,</span> <span class="s1">'The value expected was dlrow'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlroo'</span><span class="p">,</span> <span class="s1">'The value was expected to not be dlroo'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'bubble'</span><span class="p">),</span> <span class="s1">'double'</span><span class="p">,</span> <span class="s1">'The value expected was elbbub'</span> <span class="p">);</span>
      <span class="p">})</span>
      </pre></div>

      <p>Running these tests in the QUnit test runner (which you would see when your HTML test page was loaded) we would find that four of the assertions pass whilst the last one does not. The reason the test against <code>'double'</code> fails is because it was purposefully written incorrectly. In your own projects if a test fails to pass and your assertions are correct, you've probably just found a bug!</p>

      <h2>
      <a name="user-content-adding-structure-to-assertions" class="anchor" href="#adding-structure-to-assertions"><span class="octicon octicon-link"></span></a>Adding structure to assertions</h2>

      <p>Housing all of our assertions in one test case can quickly become difficult to maintain, but luckily QUnit supports structuring blocks of assertions more cleanly. This can be done using <code>module()</code> - a method that allows us to easily group tests together. A typical approach to grouping might be keeping multiple tests testing a specific method as part of the same group (module).</p>

      <h4>
      <a name="user-content-basic-qunit-modules" class="anchor" href="#basic-qunit-modules"><span class="octicon octicon-link"></span></a>Basic QUnit Modules:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Two'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'second test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Three'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'third test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      </pre></div>

      <p>We can take this further by introducing <code>setup()</code> and <code>teardown()</code> callbacks to our modules, where <code>setup()</code> is run before each test whilst <code>teardown()</code> is run after each test.</p>

      <h4>
      <a name="user-content-using-setup-and-teardown-" class="anchor" href="#using-setup-and-teardown-"><span class="octicon octicon-link"></span></a>Using setup() and teardown() :</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run before</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run after</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// run the first test</span>
      <span class="p">});</span>
      </pre></div>

      <p>These callbacks can be used to define (or clear) any components we wish to instantiate for use in one or more of our tests. As we'll see shortly, this is ideal for defining new instances of views, collections, models or routers from a project that we can then reference across multiple tests.</p>

      <h4>
      <a name="user-content-using-setup-and-teardown-for-instantiation-and-clean-up" class="anchor" href="#using-setup-and-teardown-for-instantiation-and-clean-up"><span class="octicon octicon-link"></span></a>Using setup() and teardown() for instantiation and clean-up:</h4>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Define a simple model and collection modeling a store and</span>
      <span class="c1">// list of stores</span>

      <span class="kd">var</span> <span class="nx">Store</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="kd">var</span> <span class="nx">StoreList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">store</span><span class="p">,</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">store</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Define a group for our tests</span>
      <span class="nx">module</span><span class="p">(</span> <span class="s1">'StoreList sanity check'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StoreList</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Costcutter'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Target'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Walmart'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Barnes &amp; Noble'</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nb">window</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Test the order of items added</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'test ordering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Barnes &amp; Noble'</span><span class="p">,</span> <span class="s1">'Costcutter'</span><span class="p">,</span> <span class="s1">'Target'</span><span class="p">,</span> <span class="s1">'Walmart'</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'is maintained by comparator'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>Here, a list of stores is created and stored on <code>setup()</code>. A <code>teardown()</code> callback is used to simply clear our a list of errors we might be storing within the window scope, but is otherwise not needed.</p>

      <h2>
      <a name="user-content-assertion-examples" class="anchor" href="#assertion-examples"><span class="octicon octicon-link"></span></a>Assertion examples</h2>

      <p>Before we continue any further, let's review some more examples of how QUnits various assertions can be correctly used when writing tests:</p>

      <h3>
      <a name="user-content-equal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#equal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>equal - a comparison assertion. It passes if actual == expected</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'equal'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 == true'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 == 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notEqual - a comparison assertion. It passes if actual != expected</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'notEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'passes as 1 != false'</span> <span class="p">);</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">'passes as 1 != 0'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-strictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#strictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>strictEqual - a comparison assertion. It passes if actual === expected.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'strictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'fails as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notstrictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notstrictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notStrictEqual - a comparison assertion. It passes if actual !== expected.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notStrictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'fails as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives" class="anchor" href="#deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives"><span class="octicon octicon-link"></span></a>deepEqual - a recursive comparison assertion. Unlike strictEqual(), it works on objects, arrays and primitives.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'deepEqual'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>

        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are not equal using equal()'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are equal'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - jQuery objects are not the same'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - objects not equivalent'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal" class="anchor" href="#notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal"><span class="octicon octicon-link"></span></a>notDeepEqual - a comparison assertion. This returns the opposite of deepEqual</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notDeepEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are not equal'</span> <span class="p">);</span>
        <span class="nx">notDeepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are equivalent'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions" class="anchor" href="#raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions"><span class="octicon octicon-link"></span></a>raises - an assertion which tests if a callback throws any exceptions</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'raises'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">raises</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">'Oh no! It`s an error!'</span> <span class="p">);</span>
        <span class="p">},</span> <span class="s1">'passes - an error was thrown inside our callback'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-fixtures" class="anchor" href="#fixtures"><span class="octicon octicon-link"></span></a>Fixtures</h2>

      <p>From time to time we may need to write tests that modify the DOM. Managing the clean-up of such operations between tests can be a genuine pain, but thankfully QUnit has a solution to this problem in the form of the <code>#qunit-fixture</code> element, seen below.</p>

      <h4>
      <a name="user-content-fixture-markup" class="anchor" href="#fixture-markup"><span class="octicon octicon-link"></span></a>Fixture markup:</h4>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test<span class="nt">&lt;/title&gt;</span>
          <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;&lt;/ol&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-fixture"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>We can either opt to place static markup in the fixture or just insert/append any DOM elements we may need to it. QUnit will automatically reset the <code>innerHTML</code> of the fixture after each test to its original value. In case you're using jQuery, it's useful to know that QUnit checks for its availability and will opt to use <code>$(el).html()</code> instead, which will cleanup any jQuery event handlers too.</p>

      <h3>
      <a name="user-content-fixtures-example" class="anchor" href="#fixtures-example"><span class="octicon octicon-link"></span></a>Fixtures example:</h3>

      <p>Let us now go through a more complete example of using fixtures. One thing that most of us are used to doing in jQuery is working with lists - they're often used to define the markup for menus, grids and a number of other components. You may have used jQuery plugins before that manipulated a given list in a particular way and it can be useful to test that the final (manipulated) output of the plugin is what was expected.</p>

      <p>For the purposes of our next example, we're going to use Ben Alman's <code>$.enumerate()</code> plugin, which can prepend each item in a list by its index, optionally allowing us to set what the first number in the list is. The code snippet for the plugin can be found below, followed by an example of the output is generates:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">enumerate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">start</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">start</span> <span class="o">!==</span> <span class="s1">'undefined'</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// Since `start` value was provided, enumerate and return</span>
              <span class="c1">// the initial jQuery object to allow chaining.</span>

              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
                <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span> <span class="s1">'&lt;b&gt;'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">start</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'&lt;/b&gt; '</span> <span class="p">);</span>
              <span class="p">});</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Since no `start` value was provided, function as a</span>
              <span class="c1">// getter, returing the appropriate value from the first</span>
              <span class="c1">// selected element.</span>

              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">children</span><span class="p">(</span> <span class="s1">'b'</span> <span class="p">).</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">text</span><span class="p">();</span>
              <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">val</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">};</span>

      <span class="cm">/*</span>
      <span class="cm">    &lt;ul&gt;</span>
      <span class="cm">      &lt;li&gt;1. hello&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;2. world&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;3. i&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;4. am&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;5. foo&lt;/li&gt;</span>
      <span class="cm">    &lt;/ul&gt;</span>
      <span class="cm">*/</span>
      </pre></div>

      <p>Let's now write some specs for the plugin. First, we define the markup for a list containing some sample items inside our <code>qunit-fixture</code> element:</p>

      <div class="highlight highlight-html"><pre><span class="ni">&amp;lt;</span>div id=<span class="ni">&amp;quot;</span>qunit-fixture<span class="ni">&amp;quot;&amp;gt;</span>
          <span class="ni">&amp;lt;</span>ul<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>hello<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>world<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>i<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>am<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>foo<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
          <span class="ni">&amp;lt;</span>/ul<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
      </pre></div>

      <p>Next, we need to think about what should be tested. <code>$.enumerate()</code> supports a few different use cases, including:</p>

      <ul>
      <li>
      <strong>No arguments passed</strong> - i.e <code>$(el).enumerate()</code>
      </li>
      <li>
      <strong>0 passed as an argument</strong> - i.e <code>$(el).enumerate(0)</code>
      </li>
      <li>
      <strong>1 passed as an argument</strong> - i.e <code>$(el).enumerate(1)</code>
      </li>
      </ul><p>As the text value for each list item is of the form "n. item-text" and we only require this to test against the expected output, we can simply access the content using <code>$(el).eq(index).text()</code> (for more information on .eq() see <a href="http://api.jquery.com/eq/">here</a>).</p>

      <p>and finally, here are our test cases:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span><span class="s1">'jQuery#enumerate'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'No arguments passed'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">();</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'0 passed as an argument'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'0. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 0'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. world'</span><span class="p">,</span> <span class="s1">'second item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. i'</span><span class="p">,</span> <span class="s1">'third item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 4'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'1 passed as an argument'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-asynchronous-code" class="anchor" href="#asynchronous-code"><span class="octicon octicon-link"></span></a>Asynchronous code</h2>

      <p>As with Jasmine, the effort required to run synchronous tests with QUnit is fairly straight-forward. That said, what about tests that require asynchronous callbacks (such as expensive processes, Ajax requests and so on)? When we're dealing with asynchronous code, rather than letting QUnit control when the next test runs, we can inform that we need it to stop running and wait until it's okay to continue once again.</p>

      <p>Remember: running asynchronous code without any special considerations can cause incorrect assertions to appear in other tests, so we want to make sure we get it right.</p>

      <p>Writing QUnit tests for asynchronous code is made possible using the <code>start()</code> and <code>stop()</code> methods, which programmatically set the start and stop points during such tests. Here's a simple example:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'An async test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">stop</span><span class="p">();</span>
         <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
         <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/test'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">data</span> <span class="p">){</span>
                  <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
                     <span class="nx">topic</span><span class="o">:</span> <span class="s1">'hello'</span><span class="p">,</span>
                     <span class="nx">message</span><span class="o">:</span> <span class="s1">'hi there!'</span><span class="err">'</span>
                  <span class="p">});</span>
                  <span class="nx">start</span><span class="p">();</span>
              <span class="p">}</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>A jQuery <code>$.ajax()</code> request is used to connect to a test resource and assert that the data returned is correct. <code>deepEqual()</code> is used here as it allows us to compare different data types (e.g objects, arrays) and ensures that what is returned is exactly what we're expecting. We know that our Ajax request is asynchronous and so we first call <code>stop()</code>, run the code making the request and finally at the very end of our callback, inform QUnit that it is okay to continue running other tests.</p>

      <p>Note: rather than including <code>stop()</code>, we can simply exclude it and substitute <code>test()</code> with <code>asyncTest()</code> if we prefer. This improves readability when dealing with a mixture of asynchronous and synchronous tests in your suite. Whilst this setup should work fine for many use-cases, there is no guarantee that the callback in our <code>$.ajax()</code> request will actually get called. To factor this into our tests, we can use <code>expect()</code> once again to define how many assertions we expect to see within our test. This is a healthy safety blanket as it ensures that if a test completes with an insufficient number of assertions, we know something went wrong and fix it.</p>

      <h1>
      <a name="user-content-sinonjs" class="anchor" href="#sinonjs"><span class="octicon octicon-link"></span></a>SinonJS</h1>

      <p>Similar to the section on testing Backbone.js apps using the Jasmine BDD framework, we're nearly ready to take what we've learned and write a number of QUnit tests for our Todo application.</p>

      <p>Before we start though, you may have noticed that QUnit doesn't support test spies. Test spies are functions which record arguments, exceptions and return values for any of their calls. They're typically used to test callbacks and how functions may be used in the application being tested. In testing frameworks, spies can usually be either anonymous functions or wrap functions which already exist.</p>

      <h2>
      <a name="user-content-what-is-sinonjs" class="anchor" href="#what-is-sinonjs"><span class="octicon octicon-link"></span></a>What is SinonJS?</h2>

      <p>In order for us to substitute support for spies in QUnit, we will be taking advantage of a mocking framework called <a href="http://sinonjs.org/">SinonJS</a> by Christian Johansen. We will also be using the <a href="http://sinonjs.org/qunit/">SinonJS-QUnit adapter</a> which provides seamless integration with QUnit (meaning setup is minimal). Sinon.JS is completely test-framework agnostic and should be easy to use with any testing framework, so it's ideal for our needs.</p>

      <p>The framework supports three features we'll be taking advantage of for unit testing our application:</p>

      <ul>
      <li><strong>Anonymous spies</strong></li>
      <li><strong>Spying on existing methods</strong></li>
      <li><strong>A rich inspection interface</strong></li>
      </ul><p>Using <code>this.spy()</code> without any arguments creates an anonymous spy. This is comparable to <code>jasmine.createSpy()</code> and we can observe basic usage of a SinonJS spy in the following example:</p>

      <h4>
      <a name="user-content-basic-spies" class="anchor" href="#basic-spies"><span class="octicon octicon-link"></span></a>Basic Spies:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers for a message exactly once'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'Hello World'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'the subscriber was called once'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>We can also use <code>this.spy()</code> to spy on existing functions (like jQuery's <code>$.ajax</code>) in the example below. When spying on a function which already exists, the function behaves normally but we get access to data about its calls which can be very useful for testing purposes.</p>

      <h4>
      <a name="user-content-spying-on-existing-functions" class="anchor" href="#spying-on-existing-functions"><span class="octicon octicon-link"></span></a>Spying On Existing Functions:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'should inspect jQuery.getJSON'</span><span class="nx">s</span> <span class="nx">usage</span> <span class="nx">of</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="s1">', function () {</span>
      <span class="s1">    this.spy( jQuery, '</span><span class="nx">ajax</span><span class="s1">' );</span>

      <span class="s1">    jQuery.getJSON( '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>

      <span class="s1">    ok( jQuery.ajax.calledOnce );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].url, '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].dataType, '</span><span class="nx">json</span><span class="err">'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>SinonJS comes with a rich spy interface which allows us to test whether a spy was called with a specific argument, if it was called a specific number of times and test against the values of arguments. A complete list of features supported in the interface can be found here (<a href="http://sinonjs.org/docs/">http://sinonjs.org/docs/</a>), but let's take a look at some examples demonstrating some of the most commonly used ones:</p>

      <h4>
      <a name="user-content-matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments" class="anchor" href="#matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments"><span class="octicon octicon-link"></span></a>Matching arguments: test a spy was called with a specific set of arguments:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with standard matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others" class="anchor" href="#stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others"><span class="octicon octicon-link"></span></a>Stricter argument matching: test a spy was called at least once with specific arguments and no others:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with strict matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="s1">'many'</span><span class="p">,</span> <span class="s1">'arguments'</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">34</span> <span class="p">);</span>

          <span class="c1">// This passes</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="s1">'many'</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// This however, fails</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWithExactly</span><span class="p">(</span> <span class="s1">'many'</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy" class="anchor" href="#testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy"><span class="octicon octicon-link"></span></a>Testing call order: testing if a spy was called before or after another spy:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and maintain call order'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">a</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="nx">b</span> <span class="p">);</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">a</span><span class="p">.</span><span class="nx">calledBefore</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">);</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">b</span><span class="p">.</span><span class="nx">calledAfter</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-match-execution-counts-test-a-spy-was-called-a-specific-number-of-times" class="anchor" href="#match-execution-counts-test-a-spy-was-called-a-specific-number-of-times"><span class="octicon octicon-link"></span></a>Match execution counts: test a spy was called a specific number of times:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and check call counts'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'some payload'</span> <span class="p">);</span>


          <span class="c1">// Passes if spy was called once and only once.</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span> <span class="c1">// calledTwice and calledThrice are also supported</span>

          <span class="c1">// The number of recorded calls.</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="c1">// Directly checking the arguments of the call</span>
          <span class="nx">equals</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">message</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-stubs-and-mocks" class="anchor" href="#stubs-and-mocks"><span class="octicon octicon-link"></span></a>Stubs and mocks</h2>

      <p>SinonJS also supports two other powerful features which are useful to be aware of: stubs and mocks. Both stubs and mocks implement all of the features of the spy API, but have some added functionality.</p>

      <h3>
      <a name="user-content-stubs" class="anchor" href="#stubs"><span class="octicon octicon-link"></span></a>Stubs</h3>

      <p>A stub allows us to replace any existing behaviour for a specific method with something else. They can be very useful for simulating exceptions and are most often used to write test cases when certain dependencies of your code-base may not yet be written.</p>

      <p>Let us briefly re-explore our Backbone Todo application, which contained a Todo model and a TodoList collection. For the purpose of this walkthrough, we want to isolate our TodoList collection and fake the Todo model to test how adding new models might behave.</p>

      <p>We can pretend that the models have yet to be written just to demonstrate how stubbing might be carried out. A shell collection just containing a reference to the model to be used might look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span>
      <span class="p">});</span>

      <span class="c1">// Let's assume our instance of this collection is</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">;</span>
      </pre></div>

      <p>Assuming our collection is instantiating new models itself, it's necessary for us to stub the models constructor function for the the test. This can be done by creating a simple stub as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span> <span class="p">);</span>
      </pre></div>

      <p>The above creates a stub of the Todo method on the window object. When stubbing a persistent object, it's necessary to restore it to its original state. This can be done in a <code>teardown()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
      </pre></div>

      <p>After this, we need to alter what the constructor returns, which can be efficiently done using a plain <code>Backbone.Model</code> constructor. Whilst this isn't a Todo model, it does still provide us an actual Backbone model.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>The expectation here might be that this snippet would ensure our TodoList collection always instantiates a stubbed Todo model, but because a reference to the model in the collection is already present, we need to reset the model property of our collection as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
      </pre></div>

      <p>The result of this is that when our TodoList collection instantiates new Todo models, it will return our plain Backbone model instance as desired. This allows us to write a spec for testing the addition of new model literals as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Should function when instantiated with model literals'</span><span class="p">,</span> <span class="p">{</span>

        <span class="nx">setup</span><span class="o">:</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

          <span class="c1">// Let's reset the relationship to use a stub</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
        <span class="p">}</span>

      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should add a model'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should find a model by id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-mocks" class="anchor" href="#mocks"><span class="octicon octicon-link"></span></a>Mocks</h3>

      <p>Mocks are effectively the same as stubs, however they mock a complete API out and have some built-in expectations for how they should be used. The difference between a mock and a spy is that as the expectations for their use are pre-defined, it will fail if any of these are not met.</p>

      <p>Here's a snippet with sample usage of a mock based on PubSubJS. Here, we have a <code>clearTodo()</code> method as a callback and use mocks to verify its behavior.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers when exceptions'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">myAPI</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">clearTodo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span> <span class="p">};</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">mock</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span> <span class="nx">myAPI</span> <span class="p">);</span>
          <span class="nx">mock</span><span class="p">.</span><span class="nx">expects</span><span class="p">(</span> <span class="s1">'clearTodo'</span> <span class="p">).</span><span class="nx">once</span><span class="p">().</span><span class="kr">throws</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">myAPI</span><span class="p">.</span><span class="nx">clearTodo</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>

          <span class="nx">mock</span><span class="p">.</span><span class="nx">verify</span><span class="p">();</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-practical-3" class="anchor" href="#practical-3"><span class="octicon octicon-link"></span></a>Practical</h2>

      <p>We can now begin writing test specs for our Todo application, which are listed and separated by component (e.g Models, Collections etc.). It's useful to pay attention to the name of the test, the logic being tested and most importantly the assertions being made as this will give you some insight into how what we've learned can be applied to a complete application.</p>

      <p>To get the most out of this section, I recommend looking at the QUnit Koans included in the <code>practicals\qunit-koans</code> folder - this is a port of the Backbone.js Jasmine Koans over to QUnit that I converted for this post.</p>

      <p><em>In case you haven't had a chance to try out one of the Koans kits as yet, they are a set of unit tests using a specific testing framework that both demonstrate how a set of specs for an application may be written, but also leave some tests unfilled so that you can complete them as an exercise.</em></p>

      <h3>
      <a name="user-content-models-3" class="anchor" href="#models-3"><span class="octicon octicon-link"></span></a>Models</h3>

      <p>For our models we want to at minimum test that:</p>

      <ul>
      <li>New instances can be created with the expected default values</li>
      <li>Attributes can be set and retrieved correctly</li>
      <li>Changes to state correctly fire off custom events where needed</li>
      <li>Validation rules are correctly enforced</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Model'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">''</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will set attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Get oil change for car.'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will call a custom initialize function on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">toot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Stop monkeys from throwing their own crap!'</span> <span class="p">});</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">toot</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Stop monkeys from throwing their own rainbows!'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="c1">// How would you update a property on the todo here?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Model-set</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'new text'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'A change event callback was correctly triggered'</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>
          <span class="c1">// What would you need to set on the todo properties to cause validation to fail?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="s1">'not a boolean'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">called</span><span class="p">,</span> <span class="s1">'A failed validation correctly triggered an error'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'Todo.done must be a boolean value.'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-collections-3" class="anchor" href="#collections-3"><span class="octicon octicon-link"></span></a>Collections</h3>

      <p>For our collection we'll want to test that:</p>

      <ul>
      <li>New model instances can be added as both objects and arrays</li>
      <li>Changes to models result in any necessary custom events being fired</li>
      <li>A <code>url</code> property for defining the URL structure for models is correctly defined</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Collection'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span> <span class="p">}</span>
          <span class="p">]);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="s1">'/todos/'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires custom named events when the models change.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">addModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">removeModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="nx">addModelCallback</span> <span class="p">);</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'remove'</span><span class="p">,</span> <span class="nx">removeModelCallback</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'add' event to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span><span class="s1">'New todo'</span><span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">addModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'remove' callback to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">last</span><span class="p">()</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">removeModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-views-4" class="anchor" href="#views-4"><span class="octicon octicon-link"></span></a>Views</h3>

      <p>For our views we want to ensure:</p>

      <ul>
      <li>They are being correctly tied to a DOM element when created</li>
      <li>They can render, after which the DOM representation of the view should be visible</li>
      <li>They support wiring up view methods to DOM elements</li>
      </ul><p>One could also take this further and test that user interactions with the view correctly result in any models that need to be changed being updated correctly.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.View'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="s1">'li'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can render, after which the DOM representation of the view will be visible.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

          <span class="c1">// Hint: render() just builds the DOM representation of the view, but doesn't insert it into the DOM.</span>
          <span class="c1">//       How would you append it to the ul#todoList?</span>
          <span class="c1">//       How do you access the view's DOM representation?</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#View-el</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'ul#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'li'</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">asyncTest</span><span class="p">(</span><span class="s1">'Can wire up view methods to DOM elements.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">viewElt</span><span class="p">;</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>

          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">viewElt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="s1">':first'</span><span class="p">);</span>

              <span class="nx">equal</span><span class="p">(</span><span class="nx">viewElt</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

              <span class="c1">// Make sure that QUnit knows we can continue</span>
              <span class="nx">start</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'Expected DOM Elt to exist'</span><span class="p">);</span>


          <span class="c1">// Hint: How would you trigger the view, via a DOM Event, to toggle the 'done' status.</span>
          <span class="c1">//       (See todos.js line 70, where the events hash is defined.)</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://api.jquery.com/click</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">true</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-event" class="anchor" href="#event"><span class="octicon octicon-link"></span></a>Event</h3>

      <p>For events, we may want to test a few different use cases:</p>

      <ul>
      <li>Extending plain objects to support custom events</li>
      <li>Binding and triggering custom events on objects</li>
      <li>Passing along arguments to callbacks when events are triggered</li>
      <li>Binding a passed context to an event callback</li>
      <li>Removing custom events</li>
      </ul><p>and a few others that will be detailed in our module below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Events'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">();</span> <span class="c1">// remove all custom events before each spec is run.</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can extend JavaScript objects to support custom events.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">basicObject</span> <span class="o">=</span> <span class="p">{};</span>

          <span class="c1">// How would you give basicObject these functions?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Events</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">basicObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">on</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">off</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Allows us to bind and trigger custom named events on an object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'basic event'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'basic event'</span> <span class="p">);</span>

          <span class="c1">// How would you cause the callback for this custom event to be called?</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also passes along any arguments to the callback when an event is triggered.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">passedArgs</span> <span class="o">=</span> <span class="p">[];</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'some event'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">passedArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'some event'</span><span class="p">,</span> <span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span> <span class="p">);</span>

          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">passedArgs</span><span class="p">,</span> <span class="p">[</span><span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span><span class="p">]</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can also bind the passed context to the event callback.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">'blue'</span> <span class="p">};</span>
          <span class="kd">var</span> <span class="nx">changeColor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">'red'</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="c1">// How would you get 'this.color' to refer to 'foo' in the changeColor function?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'an event'</span><span class="p">,</span> <span class="nx">changeColor</span><span class="p">,</span> <span class="nx">foo</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'an event'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">'red'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Uses `all` as a special event name to capture all events bound to the object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 2'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also can remove custom events from objects.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy2</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy3</span> <span class="p">);</span>

          <span class="c1">// How do you unbind just a single callback for the event?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks tied to the event with a single method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 2 called once'</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy3</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 3 called once'</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks and events tied to the object with a single method?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-app" class="anchor" href="#app"><span class="octicon octicon-link"></span></a>App</h3>

      <p>It can also be useful to write specs for any application bootstrap you may have in place. For the following module, our setup initiates and appends a TodoApp view and we can test anything from local instances of views being correctly defined to application interactions correctly resulting in changes to instances of local collections.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone Applications'</span> <span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">Backbone</span><span class="p">.</span><span class="nx">localStorageDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'testTodos'</span><span class="p">);</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;div id="app"&gt;&lt;/div&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoApp</span><span class="p">({</span> <span class="nx">appendTo</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">)</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should bootstrap the application by initializing the Collection.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Should bind Collection events to View creation.'</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span> <span class="s1">'Foo'</span> <span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span> <span class="s1">'keypress'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">keyCode</span><span class="o">:</span> <span class="mi">13</span> <span class="p">}</span> <span class="p">));</span>

            <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
       <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-further-reading--resources" class="anchor" href="#further-reading--resources"><span class="octicon octicon-link"></span></a>Further Reading &amp; Resources</h2>

      <p>That's it for this section on testing applications with QUnit and SinonJS. I encourage you to try out the <a href="https://github.com/addyosmani/backbone-koans-qunit">QUnit Backbone.js Koans</a> and see if you can extend some of the examples. For further reading consider looking at some of the additional resources below:</p>

      <ul>
      <li><strong><a href="http://tddjs.com/">Test-driven JavaScript Development (book)</a></strong></li>
      <li><strong><a href="http://sinonjs.org/qunit/">SinonJS/QUnit Adapter</a></strong></li>
      <li><strong><a href="http://cjohansen.no/en/javascript/using_sinon_js_with_qunit">SinonJS and QUnit</a></strong></li>
      <li><strong><a href="http://msdn.microsoft.com/en-us/scriptjunkie/gg749824">Automating JavaScript Testing With QUnit</a></strong></li>
      <li><strong><a href="http://benalman.com/talks/unit-testing-qunit.html">Ben Alman's Unit Testing With QUnit</a></strong></li>
      <li><strong><a href="https://github.com/jc00ke/qunit-backbone">Another QUnit/Backbone.js demo project</a></strong></li>
      <li><strong><a href="http://devblog.supportbee.com/2012/02/10/helpers-for-testing-backbone-js-apps-using-jasmine-and-sinon-js/">SinonJS helpers for Backbone</a></strong></li>
      </ul><h1>
      <a name="user-content-resources" class="anchor" href="#resources"><span class="octicon octicon-link"></span></a>Resources</h1>

      <p>Whilst what we get with Backbone out of the box can be terribly useful, there are some equally beneficial add-ons that can help simplify our development process. These include:</p>

      <ul>
      <li><a href="https://github.com/derickbailey/backbone.marionette">Backbone Marionette</a></li>
      <li><a href="https://github.com/tbranyen/backbone.layoutmanager">Backbone Layout Manager</a></li>
      <li><a href="https://github.com/backbone-boilerplate/backbone-boilerplate">Backbone Boilerplate</a></li>
      <li><a href="https://github.com/derickbailey/backbone.modelbinding">Backbone Model Binding</a></li>
      <li><a href="https://github.com/PaulUithol/Backbone-relational">Backbone Relational - for model relationships</a></li>
      <li><a href="https://github.com/janmonschke/backbone-couchdb">Backbone CouchDB</a></li>
      <li><a href="https://github.com/n-time/backbone.validations">Backbone Validations - HTML5 inspired validations</a></li>
      </ul><p>In time, there will be tutorials in the book covering some of these resources but until then, please feel free to check them out.</p>

      <h1>
      <a name="user-content-conclusions-4" class="anchor" href="#conclusions-4"><span class="octicon octicon-link"></span></a>Conclusions</h1>

      <p>That's it for 'Developing Backbone.js Applications'. I hope you found this book both useful, enlightening and a good start for your journey into exploring Backbone.js.</p>

      <p>If there are other topics or areas of this book you feel could be expanded further, please feel free to let me know, or better yet, send a pull request upstream. I'm always interested in making this title as comprehensive as possible.</p>

      <p>Until next time, the very best of luck with the rest of your journey!</p>

      <h2>
      <a name="user-content-notes" class="anchor" href="#notes"><span class="octicon octicon-link"></span></a>Notes</h2>

      <p>I would like to thank the Backbone.js, Stack Overflow, DailyJS (Alex Young) and JavaScript communities for their help, references and contributions to this book. This project would not be possible without you so thank you! :)</p>

      <hr><p>Where relevant, copyright Addy Osmani, 2012.</p></article>
    </div>

    <div class="after">
      <article class="markdown-body entry-content" itemprop="mainContentOfPage"><h2>
      <a name="user-content-prelude" class="anchor" href="#prelude"><span class="octicon octicon-link"></span></a>Prelude</h2>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/logo.jpg" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/logo.jpg" alt="" style="max-width:100%;"></a></p>

      <p>Welcome to my (in-progress) book about the <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> framework for structuring JavaScript applications. It's released under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">license</a> meaning you can both grab a copy of the book for free or help to further <a href="https://github.com/addyosmani/backbone-fundamentals/">improve</a> it.</p>

      <p>I'm very pleased to announce that this book will be out in physical form later in the year via <a href="http://oreilly.com">O'Reilly Media</a>. Readers will have the option of purchasing the latest version in either print or a number of digital formats then or can grab a recent version from this repository.</p>

      <p>Corrections to existing material are always welcome and I hope that together we can provide the community with an up-to-date resource that is of help.
      My extended thanks go out to <a href="https://github.com/jashkenas">Jeremy Ashkenas</a> for creating Backbone.js and <a href="https://github.com/addyosmani/backbone-fundamentals/contributors">these</a> members of the community for their assistance tweaking this project.</p>

      <p>I hope you find this book helpful!</p>

      <p><strong>Notes:</strong></p>

      <ul>
      <li>Items added or updated in the last month are marked with a * in the outline.</li>
      <li>Once you're familiar with Backbone.js, you might be interested in checking out <a href="https://github.com/addyosmani/aura">Aura</a>.</li>
      </ul><h1>
      <a name="user-content-introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>

      <p>When writing a Web application from scratch, it’s easy to feel like we can get by simply by relying on a DOM manipulation library (like jQuery) and a handful of utility plugins. The problem with this is that it doesn’t take long to get lost in a nested pile of jQuery callbacks and DOM elements without any real structure in place for our applications.</p>

      <p>In short, we’re stuck with spaghetti code. Fortunately there are modern JavaScript frameworks that can assist with bringing structure and organization to our projects, improving how easily maintainable they are in the long-run.</p>

      <h3>
      <a name="user-content-what-is-mvc-or-rather-mv" class="anchor" href="#what-is-mvc-or-rather-mv"><span class="octicon octicon-link"></span></a>What Is MVC, Or Rather MV*?</h3>

      <p>These modern frameworks provide developers an easy path to organizing their code using variations of a pattern known as MVC (Model-View-Controller). MVC separates the concerns in an application down into three parts:</p>

      <ul>
      <li>Models represent the domain-specific knowledge and data in an application. Think of this as being a ‘type’ of data you can model — like a User, Photo or Todo note. Models should notify anyone observing them about their current state (e.g Views).</li>
      <li>Views are typically considered the User-interface in an application (e.g your markup and templates), but don’t have to be. They should know about the existence of Models in order to observe them, but don’t directly communicate with them.</li>
      <li>Controllers handle the input (e.g clicks, user actions) in an application and Views can be considered as handling the output. When a Controller updates the state of a model (such as editing Todo note content), it doesn’t directly tell the View. This is what the observing nature of the View and Model relationship is for.</li>
      </ul><p>JavaScript ‘MVC’ frameworks that can help us structure our code don’t always strictly follow the above pattern. Some frameworks will include the responsibility of the Controller in the View (e.g Backbone.js) whilst others add their own opinionated components into the mix as they feel this is more effective.</p>

      <p>For this reason we refer to such frameworks as following the MV* pattern, that is, you’re likely to have a View and a Model, but more likely to have something else also included.</p>

      <h3>
      <a name="user-content-what-exactly-is-backbonejs" class="anchor" href="#what-exactly-is-backbonejs"><span class="octicon octicon-link"></span></a>What exactly is Backbone.js?</h3>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/backbonejsorg.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/backbonejsorg.png" alt="" style="max-width:100%;"></a></p>

      <p>Backbone.js is a lightweight JavaScript framework for adding structure to your client-side code. It makes it easy to manage and decouple concerns in your application, leaving you with code that is more maintainable in the long term.</p>

      <p>Developers commonly use frameworks like Backbone.js to create single-page applications or SPAs. To put it simply, these apps enable the browser to react to changes in data on the client-side without the need to completely load up all your markup from the server, meaning no complete page-refreshes are necessary.</p>

      <p>Backbone.js is a mature, popular framework at the time of writing and has both a large development community online as well as a wealth of plugins and extensions available to build upon it. It has been used to create non-trivial applications by companies such as
      Disqus, Walmart, SoundCloud and Foursquare.</p>

      <h3>
      <a name="user-content-when-do-you-need-a-javascript-mv-framework" class="anchor" href="#when-do-you-need-a-javascript-mv-framework"><span class="octicon octicon-link"></span></a>When Do You Need A JavaScript MV* Framework?</h3>

      <p>When building a single-page application using JavaScript, whether it involves a complex user interface or is simply trying to reduce the number of HTTP requests required for new Views, you will likely find yourself inventing many of the pieces that make up an MV* framework like Backbone or Ember.</p>

      <p>At the outset, it isn’t terribly difficult to write an application framework that offers some opinionated way to avoid spaghetti code, however to say that it is equally as trivial to write something of the standard of Backbone would be a grossly incorrect assumption.</p>

      <p>There’s a lot more that goes into structuring an application than tying together a DOM manipulation library, templating and routing. Mature MV* frameworks typically not only include many of the pieces you would find yourself writing, but also include solutions to problems you’ll find yourself running into later on down the road. This is a time-saver that you shouldn’t underestimate the value of.</p>

      <p>So, where will you likely need an MV* framework and where won’t you?</p>

      <p>If you’re writing an application that will likely only be communicating with an API or back-end data service, where much of the heavy lifting for viewing or manipulating that data will be occurring in the browser, you may find a JavaScript MV* framework useful.
      Good examples of applications that fall into this category are GMail and Google Docs.</p>

      <p>These applications typically download a single payload containing all the scripts, stylesheets and markup users need for common tasks and then perform a lot of additional behavior in the background. It’s trivial to switch between reading an email or document to writing one and you don’t need to ask the application to render the whole page again at all.</p>

      <p>If, however, you’re building an application that still relies on the server for most of the heavy-lifting of Views/pages and you’re just using a little JavaScript or jQuery to make things a little more interactive, an MV framework may be overkill. There certainly are complex Web applications where the partial rendering of views can* be coupled with a single-page application effectively, but for everything else, you may find yourself better sticking to a simpler setup.</p>

      <p>Maturity in software (framework) development isn't simply about how long a framework has been around. It's about how solid the framework is and more importantly how well it's evolved to fill its role. Has it become more effective at solving common problems? Does it continue to improve as developers build larger and more complex applications with it?</p>

      <h3>
      <a name="user-content-why-should-you-consider-using-backbonejs" class="anchor" href="#why-should-you-consider-using-backbonejs"><span class="octicon octicon-link"></span></a>Why should you consider using Backbone.js?</h3>

      <p>Does the following describe you?:</p>

      <p>"I want something flexible which offers a minimalist solution to separating concerns in my application. It should support a persistence layer and RESTful sync, models, views (with controllers), event-driven communication, templating and routing. It should be imperative, allowing one to update the View when a model changes. I’d like some decisions about the architecture left up to me. Ideally, many large companies have used the solution to build non-trivial applications.</p>

      <p>As I may be building something complex, I’d like there to be an active extension community around the framework that have already tried addressing larger problems (Marionette, Chaplin, Aura, Thorax). Ideally, there are also scaffolding tools (grunt-bbb, brunch) available for the solution."</p>

      <p>If so, continue reading.</p>

      <p>Backbone's main benefits, regardless of your target platform or device, include helping:</p>

      <ul>
      <li>Organize the structure to your application</li>
      <li>Simplify server-side persistence</li>
      <li>Decouple the DOM from your page's data</li>
      <li>Model data, views and routers in a succinct manner</li>
      <li>Provide DOM, model and collection synchronization</li>
      </ul><h3>
      <a name="user-content-what-should-you-expect-to-see-in-this-book" class="anchor" href="#what-should-you-expect-to-see-in-this-book"><span class="octicon octicon-link"></span></a>What should you expect to see in this book?</h3>

      <p>The goal of this book is to create an authoritative and centralized repository of information that can help those developing real-world apps with Backbone. If you come across a section or topic which you think could be improved or expanded on, please feel free to submit a pull-request. It won't take long and you'll be helping other developers avoid problems you've run into before.</p>

      <p>Topics will include MVC theory and how to build applications using Backbone's models, views, collections and routers. I'll also be taking you through advanced topics like modular development with Backbone.js and AMD (via RequireJS), how to build applications using modern software stacks (like Node and Express), how to solve the routing problems with Backbone and jQuery Mobile, tips about scaffolding tools, and a lot more.</p>

      <h1>
      <a name="user-content-fundamentals" class="anchor" href="#fundamentals"><span class="octicon octicon-link"></span></a>Fundamentals</h1>

      <p>In this section, we're going to explore how frameworks like Backbone.js fit in the world of JavaScript application architecture. Classically, developers creating desktop and server-class applications have had a wealth of design patterns available for them to lean on, but it's only been in the past few years that such patterns have come to client-side development.</p>

      <p>Before exploring any JavaScript frameworks that assist in structuring applications, it can be useful to gain a basic understanding of architectural design patterns.</p>

      <h3>
      <a name="user-content-mvc-mvp--backbonejs" class="anchor" href="#mvc-mvp--backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP &amp; Backbone.js</h3>

      <p>Design patterns are proven solutions to common development problems and can suggest structural approaches to help guide developers in adding some organization to their applications.</p>

      <p>Patterns are useful because they're a set of practices that build upon the collective experience of skilled developers who have repeatedly solved similar problems. Although developers 10 or 20 years ago may not have been using the same programming languages when implementing patterns in their projects, there are many lessons we can learn from their efforts.</p>

      <p>In this section, we're going to review two popular patterns - MVC and MVP. We'll be exploring in greater detail how Backbone.js implements these patterns shortly to better appreciate where it fits in.</p>

      <h2>
      <a name="user-content-mvc" class="anchor" href="#mvc"><span class="octicon octicon-link"></span></a>MVC</h2>

      <p>MVC (Model-View-Controller) is an architectural design pattern that encourages improved application organization through a separation of concerns. It enforces the isolation of business data (Models) from user interfaces (Views), with a third component (Controllers) traditionally present to manage logic, user-input and the coordination of models and views. The pattern was originally designed by <a href="http://en.wikipedia.org/wiki/Trygve_Reenskaug">Trygve Reenskaug</a> while working on Smalltalk-80 (1979), where it was initially called Model-View-Controller-Editor. MVC was described in depth in <a href="http://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612">“Design Patterns: Elements of Reusable Object-Oriented Software”</a> (The "GoF" or “Gang of Four” book) in 1994, which played a role in popularizing its use.</p>

      <h3>
      <a name="user-content-smalltalk-80-mvc" class="anchor" href="#smalltalk-80-mvc"><span class="octicon octicon-link"></span></a>Smalltalk-80 MVC</h3>

      <p>It's important to understand what the original MVC pattern was aiming to solve as it has changed quite heavily since the days of its origin. Back in the 70's, graphical user-interfaces were few and far between. An approach known as <a href="http://martinfowler.com/eaaDev/uiArchs.html">Separated Presentation</a> began to be used as a means to make a clear division between domain objects which modeled concepts in the real world (e.g a photo, a person) and the presentation objects which were rendered to the user's screen.</p>

      <p>The Smalltalk-80 implementation of MVC took this concept further and had an objective of separating out the application logic from the user interface. The idea was that decoupling these parts of the application would also allow the reuse of models for other interfaces in the application. There are some interesting points worth noting about Smalltalk-80's MVC architecture:</p>

      <ul>
      <li>A Domain element was known as a Model and were ignorant of the user-interface (Views and Controllers)</li>
      <li>Presentation was taken care of by the View and the Controller, but there wasn't just a single view and controller. A View-Controller pair was required for each element being displayed on the screen and so there was no true separation between them</li>
      <li>The Controller's role in this pair was handling user input (such as key-presses and click events), doing something sensible with them.</li>
      <li>The Observer pattern was relied upon for updating the View whenever the Model changed</li>
      </ul><p>Developers are sometimes surprised when they learn that the Observer pattern (nowadays commonly implemented as a Publish/Subscribe system) was included as a part of MVC's architecture decades ago. In Smalltalk-80's MVC, the View and Controller both observe the Model: anytime the Model changes, the Views react. A simple example of this is an application backed by stock market data - for the application to show real-time information, any change to the data in its Models should result in the View being refreshed instantly.</p>

      <p>Martin Fowler has done an excellent job of writing about the <a href="http://martinfowler.com/eaaDev/uiArchs.html">origins</a> of MVC over the years and if you are interested in further historical information about Smalltalk-80's MVC, I recommend reading his work.</p>

      <h2>
      <a name="user-content-mvc-as-we-know-it" class="anchor" href="#mvc-as-we-know-it"><span class="octicon octicon-link"></span></a>MVC As We Know It</h2>

      <p>We've reviewed the 70's, but let us now return to the here and now. The MVC pattern has been applied to a diverse range of programming languages. For example, the popular Ruby on Rails is an implementation of a web application framework based on MVC for the Ruby language. JavaScript now has a number of MVC frameworks, including Ember.js, JavaScriptMVC, and of course Backbone.js. Given the importance of avoiding "spaghetti" code, a term which describes code that is very difficult to read or maintain due to its lack of structure, let's look at what the MVC pattern enables the Javascript developer to do.</p>

      <p>MVC is composed of three core components:</p>

      <h3>
      <a name="user-content-models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h3>

      <p>Models manage the data for an application. They are concerned with neither the user-interface nor presentation layers, but instead represent structured data that an application may require. When a model changes (e.g when it is updated), it will typically notify its observers (e.g views, a concept we will cover shortly) that a change has occurred so that they may react accordingly.</p>

      <p>To understand models better, let us imagine we have a JavaScript todo application. In a todo app, a todo item would merit its own model, as it represents a unique kind of domain-specific data. The Todo model may represent attributes such as a title and completed. A specific todo would be stored in an instance of a model. Here's an example of a simple Todo model implemented with Backbone.js:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// todo instantiated with default attributes </span>
        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default title: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// ""</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default status: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

        <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Enjoy reading the book'</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title changed: '</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

        <span class="c1">// new todo instantiated with todo specific data</span>
        <span class="kd">var</span> <span class="nx">secondTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Try this code in chrome console'</span><span class="p">});</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo title: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo status: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <p>The built-in capabilities of models vary across frameworks, however it's common for them to support validation of attributes, where attributes represent the properties of the model, such as a model identifier. When using models in real-world applications we generally also need a way of persisting models. Persistence allows us to edit and update models with the knowledge that their most recent states will be saved somewhere, for example in a web browser's localStorage data-store or synchronized with a database.</p>

      <p>A model may also have multiple views observing it. Imagine our Todo model contained meta-data such as the scheduled date, notes, days on which to repeat (if it's something we do on regular basis). A developer could create a single view that displayed all these attributes, or might create three separate views to display each attribute. The important detail is that the Todo model doesn't care how these views are organized, it simply announces updates to its data as necessary. We'll come back to Views in more detail later.</p>

      <p>It is not uncommon for modern MVC/MV* frameworks to provide a means to group models together. In Backbone, these groups are called "Collections". Managing models in groups allows us to write application logic based on notifications from the group, should any model it contains change. This avoids the need to manually observe individual model instances.</p>

      <p>Here's how we might group Todo models into a Backbone Collection:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Todos</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// For simplicity we'll use localStorage throughout the first part of book.</span>
          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>

          <span class="c1">// When working with REST API on back-end here would be</span>
          <span class="c1">// appropriate to use:</span>
          <span class="c1">// url: "/todos"</span>

        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read whole book'</span><span class="p">});</span>

        <span class="c1">// pass array of models on collection instantiation</span>
        <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todos</span><span class="p">([</span><span class="nx">firstTodo</span><span class="p">]);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection's convenience method used to create </span>
        <span class="c1">// new model instance within collection itself.</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">thirdTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Make something cool'</span><span class="p">});</span>

        <span class="c1">// Adds model to collection</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">thirdTodo</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection keeps models in models </span>
        <span class="c1">// property which is an array.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">models</span><span class="p">);</span>
      </pre></div>

      <p>If you read older texts on MVC, you may come across a description of models as also managing application "state". In JavaScript applications state has a specific meaning, typically referring to the current state of a view or sub-view on a user's screen at a fixed time. State is a topic which is regularly discussed when looking at Single-page applications, where the concept of state needs to be simulated.</p>

      <h3>
      <a name="user-content-views" class="anchor" href="#views"><span class="octicon octicon-link"></span></a>Views</h3>

      <p>Views are a visual representation of models that present a filtered view of their current state. A view typically observes a model and is notified when the model changes, allowing the view to update itself accordingly. Design pattern literature commonly refers to views as 'dumb', given that their knowledge of models and controllers in an application is limited.</p>

      <p>Users interact with views, which usually means reading and editing model data. For example, in our todo application example, todo model viewing might happen in a user interface in the list of all todo items. Within it each todo is rendered with their title and completed checkbox. Model editing could be done through an "edit" view where a user who has selected a specific todo could edit its title in a form.</p>

      <p>In MVC, the actual task of updating the Model falls to Controllers, which we'll be covering shortly.</p>

      <p>Let's explore Views a little further using a simple JavaScript example. Below we can see a function that creates a single Todo view, consuming both a model instance and a controller instance.</p>

      <p>We define a <code>render()</code> utility within our view which is responsible for rendering the contents of the <code>todoModel</code> using a JavaScript templating engine (<a href="http://underscorejs.org" title="Underscore.js">Underscore</a> templating) and updating the contents of our view, referenced by <code>todoEl</code>.</p>

      <p>The <code>todoModel</code> then adds our <code>render()</code> callback as one of its subscribers, so that through the Observer pattern it can trigger the view to update when the model changes.</p>

      <p>You may wonder where user interaction comes into play here. When users click on any elements within the view, it's not the view's responsibility to know what to do next. A Controller makes this decision. In our sample implementation, this is achieved by adding an event listener to <code>todoEl</code> which will delegate handling the click behavior back to the controller, passing the model information along with it in case it's needed.</p>

      <p>The benefit of this architecture is that each component plays its own separate role in making the application function as needed.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">buildTodoView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">todoModel</span><span class="p">,</span> <span class="nx">todoController</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">base</span>       <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">),</span>
            <span class="nx">todoEl</span>     <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>

        <span class="nx">base</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">todoEl</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">render</span><span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// We use a templating library such as Underscore</span>
          <span class="c1">// templating which generates the HTML for our</span>
          <span class="c1">// todo entry</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">'todoTemplate'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="nx">todoModel</span><span class="p">.</span><span class="nx">getSrc</span><span class="p">()</span> <span class="p">});</span>
         <span class="p">}</span>

        <span class="nx">todoModel</span><span class="p">.</span><span class="nx">addSubscriber</span><span class="p">(</span> <span class="nx">render</span> <span class="p">);</span>

        <span class="nx">todoEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoController</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">todoModel</span> <span class="p">);</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">showView</span><span class="o">:</span> <span class="nx">show</span><span class="p">,</span>
          <span class="nx">hideView</span><span class="o">:</span> <span class="nx">hide</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong>Templating</strong></p>

      <p>In the context of JavaScript frameworks that support MVC/MV*, it is worth looking more closely at JavaScript templating and its relationship to Views.</p>

      <p>It has long been considered bad practice (and computationally expensive) to manually create large blocks of HTML markup in-memory through string concatenation. Developers using this technique often find themselves iterating through their data, wrapping it in nested divs and using outdated techniques such as <code>document.write</code> to inject the 'template' into the DOM. This approach often means keeping scripted markup inline with standard markup, which can quickly become difficult to read and maintain, especially when building large applications.</p>

      <p>JavaScript templating libraries (such as Handlebars.js or Mustache) are often used to define templates for views as HTML markup containing template variables. These template blocks can be either stored externally or within script tags with a custom type (e.g 'text/template'). Variables are delimited using a variable syntax (e.g {{title}}). Javascript template libraries typically accept data in JSON, and the grunt work of populating templates with data is taken care of by the framework itself. This has a several benefits, particularly when opting to store templates externally as this can let applications load templates dynamically on an as-needed basis.</p>

      <p>Let's compare two examples of HTML templates. One is implemented using the popular Handlebars.js library, and the other uses Underscore's 'microtemplates'.</p>

      <p><strong>Handlebars.js:</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">{{#</span><span class="na">if</span> <span class="na">completed</span><span class="err">}}</span> <span class="err">"</span><span class="na">checked</span><span class="err">"</span> <span class="err">{{/</span><span class="na">if</span><span class="err">}}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label&gt;</span>{{title}}<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"{{title}}"</span><span class="nt">&gt;</span>
      </pre></div>

      <p><strong>Underscore.js Microtemplates:</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">completed</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span>&gt;
        <span class="nt">&lt;label&gt;</span><span class="err">&lt;</span>%= title %&gt;<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"&lt;%= title %&gt;"</span><span class="nt">&gt;</span>
      </pre></div>

      <p>You may also use double curly brackets (i.e <code>{{}}</code>) (or any other tag you feel comfortable with) in Microtemplates. In the case of curly brackets, this can be done by setting the Underscore <code>templateSettings</code> attribute as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">interpolate</span> <span class="o">:</span> <span class="sr">/\{\{(.+?)\}\}/g</span> <span class="p">};</span>
      </pre></div>

      <p><strong>A note on navigation and state</strong></p>

      <p>It is also worth noting that in classical web development, navigating between independent views required the use of a page refresh. In single-page JavaScript applications, however, once data is fetched from a server via Ajax, it can be dynamically rendered in a new view within the same page. Since this doesn't automatically update the URL, the role of navigation thus falls to a "router", which assists in managing application state (e.g allowing users to bookmark a particular view they have navigated to). As routers are however neither a part of MVC nor present in every MVC-like framework, I will not be going into them in greater detail in this section.</p>

      <h3>
      <a name="user-content-controllers" class="anchor" href="#controllers"><span class="octicon octicon-link"></span></a>Controllers</h3>

      <p>Controllers are an intermediary between models and views which are classically responsible for two tasks: they both update the view when the model changes and update the model when the user manipulates the view.</p>

      <p>In our Todo application, a controller would be responsible for handling changes the user made in the edit view for a particular todo, updating a specific todo model when a user has finished editing.</p>

      <p>It's with controllers that most JavaScript MVC frameworks depart from this interpretation of the MVC pattern. The reasons for this vary, but in my opinion, Javascript framework authors likely initially looked at server-side interpretations of MVC (such as Ruby on Rails), realized that that approach didn't translate 1:1 on the client-side, and so re-interpreted the C in MVC to solve their state management problem. This was a clever approach, but it can make it hard for developers coming to MVC for the first time to understand both the classical MVC pattern and the "proper" role of controllers in other non-Javascript frameworks.</p>

      <p>So does Backbone.js have Controllers? Not really. Backbone's Views typically contain "controller" logic, and Routers (discussed below) are used to help manage application state, but neither are true Controllers according to classical MVC.</p>

      <p>In this respect, contrary to what might be mentioned in the official documentation or in blog posts, Backbone is neither a truly MVC/MVP nor MVVM framework. It's in fact better to see it a member of the MV* family which approaches architecture in its own way. There is of course nothing wrong with this, but it is important to distinguish between classical MVC and MV* should you be relying on discussions of MVC to help with your Backbone projects.</p>

      <h3>
      <a name="user-content-controllers-in-spinejs-vs-backbonejs" class="anchor" href="#controllers-in-spinejs-vs-backbonejs"><span class="octicon octicon-link"></span></a>Controllers in Spine.js vs Backbone.js</h3>

      <p><strong>Spine.js</strong></p>

      <p>We now know that controllers are traditionally responsible for updating the view when the model changes (and similarly the model when the user updates the view). Since Backbone doesn't have its <strong>own</strong> explicit controllers, it's useful to review the controller from another MVC framework to appreciate the difference in implementations. Let's take a look at <a href="http://spinejs.com/">Spine.js</a>:</p>

      <p>In this example, we're going to have a controller called <code>TodoController</code> which would be in charge of individual todos in the application. It will ensure that when the view updates (e.g a user edited the todo) the corresponding model does too.</p>

      <p>(Note: We won't be delving heavily into Spine.js beyond this example, but it's worth looking at it to learn more about Javascript frameworks in general.)</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Controllers in Spine are created by inheriting from Spine.Controller</span>

      <span class="kd">var</span> <span class="nx">TodoController</span> <span class="o">=</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">sub</span><span class="p">({</span>
        <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">));</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// Handle templating</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-template'</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>In Spine, controllers are considered the glue for an application, adding and responding to DOM events, rendering templates and ensuring that views and models are kept in sync (which makes sense in the context of what we know to be a controller).</p>

      <p>What we're doing in the above example is setting up listeners in the <code>update</code> and <code>destroy</code> events using <code>render()</code> and <code>remove()</code>. When a todo entry gets updated, we re-render the view to reflect the changes to the todo title. Similarly, if the todo gets deleted from todo list, we remove it from the view. In case you were wondering about the <code>tmpl()</code> function in the code snippet: in the <code>render()</code> function, we're using this to render a JavaScript template called #todoTemplate which simply returns an HTML string used to replace the controller's current element.</p>

      <p>What this provides us with is a very lightweight, simple way to manage changes between the model and the view.</p>

      <p><strong>Backbone.js</strong></p>

      <p>Later on in this section we're going to revisit the differences between Backbone and traditional MVC, but for now let's focus on controllers.</p>

      <p>In Backbone, controller logic is shared between Backbone.View and Backbone.Router. Earlier releases of Backbone contained something called Backbone.Controller, but it was renamed to Router to clarify its role.</p>

      <p>A Router's main purpose is to translate URL requests into application states. It does that by mapping URLs to functions. When a user browses to the URL <a href="http://www.example.com/filter/completed">www.example.com/filter/completed</a>, a Router could be used to show just todos which are completed, and to define what application behavior should be run in response to that request. Routers <em>can</em> contain traditional controller responsibilities, such as binding the events between models and views, or rendering parts of the page. However, Backbone contributor Tim Branyen has pointed out that it's possible to get away without needing Backbone.Router at all for this, so a way to think about it using the Router paradigm is probably:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span> <span class="s2">"/filter/:name"</span><span class="o">:</span> <span class="s2">"setFilter"</span> <span class="p">},</span>
        <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"set filter: "</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-what-does-mvc-give-us" class="anchor" href="#what-does-mvc-give-us"><span class="octicon octicon-link"></span></a>What does MVC give us?</h2>

      <p>To summarize, the separation of concerns in MVC facilitates modularization of an application's functionality and enables:</p>

      <ul>
      <li>Easier overall maintenance. When updates need to be made to the application it is clear whether the changes are data-centric, meaning changes to models and possibly controllers, or merely visual, meaning changes to views.</li>
      <li>Decoupling models and views means that it's straight-forward to write unit tests for business logic</li>
      <li>Duplication of low-level model and controller code is eliminated across the application</li>
      <li>Depending on the size of the application and separation of roles, this modularity allows developers responsible for core logic and developers working on the user-interfaces to work simultaneously</li>
      </ul><h3>
      <a name="user-content-delving-deeper" class="anchor" href="#delving-deeper"><span class="octicon octicon-link"></span></a>Delving deeper</h3>

      <p>Right now, you likely have a basic understanding of what the MVC pattern provides, but for the curious, we'll explore it a little further.</p>

      <p>The GoF (Gang of Four) do not refer to MVC as a design pattern, but rather consider it a "set of classes to build a user interface". In their view, it's actually a variation of three other classical design patterns: the Observer (Pub/Sub), Strategy and Composite patterns. Depending on how MVC has been implemented in a framework, it may also use the Factory and Decorator patterns. I've covered some of these patterns in my other free book, JavaScript Design Patterns For Beginners if you would like to read into them further.</p>

      <p>As we've discussed, models represent application data, while views handle what the user is presented on screen. As such, MVC relies on Pub/Sub for some of its core communication (something that surprisingly isn't covered in many articles about the MVC pattern). When a model is changed it "publishes" to the rest of the application that it has been updated. The "subscriber"--generally a Controller--then updates the view accordingly. The observer-viewer nature of this relationship is what facilitates multiple views being attached to the same model.</p>

      <p>For developers interested in knowing more about the decoupled nature of MVC (once again, depending on the implementation), one of the goals of the pattern is to help define one-to-many relationships between a topic and its observers. When a topic changes, its observers are updated. Views and controllers have a slightly different relationship. Controllers facilitate views to respond to different user input and are an example of the Strategy pattern.</p>

      <h3>
      <a name="user-content-summary" class="anchor" href="#summary"><span class="octicon octicon-link"></span></a>Summary</h3>

      <p>Having reviewed the classical MVC pattern, you should now understand how it allows developers to cleanly separate concerns in an application. You should also now appreciate how JavaScript MVC frameworks may differ in their interpretation of MVC, and how they share some of the fundamental concepts of the original pattern.</p>

      <p>When reviewing a new JavaScript MVC/MV* framework, remember - it can be useful to step back and consider how it's opted to approach Models, Views, Controllers or other alternatives, as this can better help you grok how the framework expects to be used.</p>

      <h2>
      <a name="user-content-mvp" class="anchor" href="#mvp"><span class="octicon octicon-link"></span></a>MVP</h2>

      <p>Model-view-presenter (MVP) is a derivative of the MVC design pattern which focuses on improving presentation logic. It originated at a company named <a href="http://en.wikipedia.org/wiki/Taligent">Taligent</a> in the early 1990s while they were working on a model for a C++ CommonPoint environment. Whilst both MVC and MVP target the separation of concerns across multiple components, there are some fundamental differences between them.</p>

      <p>For the purposes of this summary we will focus on the version of MVP most suitable for web-based architectures.</p>

      <h3>
      <a name="user-content-models-views--presenters" class="anchor" href="#models-views--presenters"><span class="octicon octicon-link"></span></a>Models, Views &amp; Presenters</h3>

      <p>The P in MVP stands for presenter. It's a component which contains the user-interface business logic for the view. Unlike MVC, invocations from the view are delegated to the presenter, which are decoupled from the view and instead talk to it through an interface. This allows for all kinds of useful things such as being able to mock views in unit tests.</p>

      <p>The most common implementation of MVP is one which uses a Passive View (a view which is for all intents and purposes "dumb"), containing little to no logic. MVP models are almost identical to MVC models and handle application data. The presenter acts as a mediator which talks to both the view and model, however both of these are isolated from each other. They effectively bind models to views, a responsibility held by Controllers in MVC. Presenters are at the heart of the MVP pattern and as you can guess, incorporate the presentation logic behind views.</p>

      <p>Solicited by a view, presenters perform any work to do with user requests and pass data back to them. In this respect, they retrieve data, manipulate it and determine how the data should be displayed in the view. In some implementations, the presenter also interacts with a service layer to persist data (models). Models may trigger events but it's the presenter's role to subscribe to them so that it can update the view. In this passive architecture, we have no concept of direct data binding. Views expose setters which presenters can use to set data.</p>

      <p>The benefit of this change from MVC is that it increases the testability of your application and provides a more clean separation between the view and the model. This isn't however without its costs as the lack of data binding support in the pattern can often mean having to take care of this task separately.</p>

      <p>Although a common implementation of a <a href="http://martinfowler.com/eaaDev/PassiveScreen.html">Passive View</a> is for the view to implement an interface, there are variations on it, including the use of events which can decouple the View from the Presenter a little more. As we don't have the interface construct in JavaScript, we're using it more and more a protocol than an explicit interface here. It's technically still an API and it's probably fair for us to refer to it as an interface from that perspective.</p>

      <p>There is also a <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html">Supervising Controller</a> variation of MVP, which is closer to the MVC and <a href="http://en.wikipedia.org/wiki/Model_View_ViewModel">MVVM</a> patterns as it provides data-binding from the Model directly from the View. Key-value observing (KVO) plugins (such as Derick Bailey's Backbone.ModelBinding plugin) introduce this idea of a Supervising Controller to Backbone.</p>

      <h2>
      <a name="user-content-mvp-or-mvc" class="anchor" href="#mvp-or-mvc"><span class="octicon octicon-link"></span></a>MVP or MVC?</h2>

      <p>MVP is generally used most often in enterprise-level applications where it's necessary to reuse as much presentation logic as possible. Applications with very complex views and a great deal of user interaction may find that MVC doesn't quite fit the bill here as solving this problem may mean heavily relying on multiple controllers. In MVP, all of this complex logic can be encapsulated in a presenter, which can simplify maintenance greatly.</p>

      <p>As MVP views are defined through an interface and the interface is technically the only point of contact between the system and the view (other than a presenter), this pattern also allows developers to write presentation logic without needing to wait for designers to produce layouts and graphics for the application.</p>

      <p>Depending on the implementation, MVP may be more easy to automatically unit test than MVC. The reason often cited for this is that the presenter can be used as a complete mock of the user-interface and so it can be unit tested independent of other components. In my experience this really depends on the languages you are implementing MVP in (there's quite a difference between opting for MVP for a JavaScript project over one for say, ASP.NET).</p>

      <p>At the end of the day, the underlying concerns you may have with MVC will likely hold true for MVP given that the differences between them are mainly semantic. As long as you are cleanly separating concerns into models, views and controllers (or presenters) you should be achieving most of the same benefits regardless of the pattern you opt for.</p>

      <h2>
      <a name="user-content-mvc-mvp-and-backbonejs" class="anchor" href="#mvc-mvp-and-backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP and Backbone.js</h2>

      <p>There are very few, if any architectural JavaScript frameworks that claim to implement the MVC or MVP patterns in their classical form as many JavaScript developers don't view MVC and MVP as being mutually exclusive (we are actually more likely to see MVP strictly implemented when looking at web frameworks such as ASP.NET or GWT). This is because it's possible to have additional presenter/view logic in your application and yet still consider it a flavor of MVC.</p>

      <p>Backbone contributor <a href="http://ireneros.com/">Irene Ros</a> subscribes to this way of thinking as when she separates Backbone views out into their own distinct components, she needs something to actually assemble them for her. This could either be a controller route (such as a <code>Backbone.Router</code>, covered later in the book) or a callback in response to data being fetched.</p>

      <p>That said, some developers do however feel that Backbone.js better fits the description of MVP than it does MVC
      . Their view is that:</p>

      <ul>
      <li>The presenter in MVP better describes the <code>Backbone.View</code> (the layer between View templates and the data bound to it) than a controller does</li>
      <li>The model fits <code>Backbone.Model</code> (it isn't that different from the classical MVC "Model")</li>
      <li>The views best represent templates (e.g Handlebars/Mustache markup templates)</li>
      </ul><p>A response to this could be that the view can also just be a View (as per MVC) because Backbone is flexible enough to let it be used for multiple purposes. The V in MVC and the P in MVP can both be accomplished by <code>Backbone.View</code> because they're able to achieve two purposes: both rendering atomic components and assembling those components rendered by other views.</p>

      <p>We've also seen that in Backbone the responsibility of a controller is shared with both the Backbone.View and Backbone.Router and in the following example we can actually see that aspects of that are certainly true.</p>

      <p>Here, our Backbone <code>TodoView</code> uses the Observer pattern to 'subscribe' to changes to a View's model in the line <code>this.model.on('change',...)</code>. It also handles templating in the <code>render()</code> method, but unlike some other implementations, user interaction is also handled in the View (see <code>events</code>).</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// The DOM element for a todo item...</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="c1">//... is a list tag.</span>
        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Pass the contents of the todo template through a templating</span>
        <span class="c1">// function, cache it for a single todo</span>
        <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="c1">// The DOM events specific to an item.</span>
        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span>
        <span class="p">},</span>

        <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
        <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
        <span class="c1">// app, we set a direct reference on the model for convenience.</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// Toggle the `"completed"` state of the model.</span>
        <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
        <span class="p">},</span>
      <span class="p">});</span>
      </pre></div>

      <p>Another (quite different) opinion is that Backbone more closely resembles <a href="http://martinfowler.com/eaaDev/uiArchs.html#ModelViewController">Smalltalk-80 MVC</a>, which we went through earlier.</p>

      <p>As regular Backbone user Derick Bailey has <a href="http://lostechies.com/derickbailey/2011/12/23/backbone-js-is-not-an-mvc-framework/">written</a>, it's ultimately best not to force Backbone to fit any specific design patterns. Design patterns should be considered flexible guides to how applications may be structured and in this respect, Backbone doesn't fit either MVC nor MVP perfectly. Instead, it borrows some of the best concepts from multiple architectural patterns and creates a flexible framework that just works well. Call it <strong>the Backbone way</strong>, MV* or whatever helps reference its flavor of application architecture.</p>

      <p>It <em>is</em> however worth understanding where and why these concepts originated, so I hope that my explanations of MVC and MVP have been of help. Most structural JavaScript frameworks will adopt their own take on classical patterns, either intentionally or by accident, but the important thing is that they help us develop applications which are organized, clean and can be easily maintained.</p>

      <h2>
      <a name="user-content-fast-facts" class="anchor" href="#fast-facts"><span class="octicon octicon-link"></span></a>Fast facts</h2>

      <h3>
      <a name="user-content-backbonejs" class="anchor" href="#backbonejs"><span class="octicon octicon-link"></span></a>Backbone.js</h3>

      <ul>
      <li>Core components: Model, View, Collection, Router. Enforces its own flavor of MV*</li>
      <li>Good documentation, with more improvements on the way</li>
      <li>Used by large companies such as SoundCloud and Foursquare to build non-trivial applications</li>
      <li>Event-driven communication between views and models. As we'll see, it's relatively straight-forward to add event listeners to any attribute in a model, giving developers fine-grained control over what changes in the view</li>
      <li>Supports data bindings through manual events or a separate Key-value observing (KVO) library</li>
      <li>Great support for RESTful interfaces out of the box, so models can be easily tied to a backend</li>
      <li>Extensive eventing system. It's <a href="http://lostechies.com/derickbailey/2011/07/19/references-routing-and-the-event-aggregator-coordinating-views-in-backbone-js/">trivial</a> to add support for pub/sub in Backbone</li>
      <li>Prototypes are instantiated with the <code>new</code> keyword, which some developers prefer</li>
      <li>Agnostic about templating frameworks, however Underscore's micro-templating is available by default. Backbone works well with libraries like Handlebars</li>
      <li>Doesn't support deeply nested models, though there are Backbone plugins such as <a href="https://github.com/PaulUithol/Backbone-relational">this</a> which can help</li>
      <li>Clear and flexible conventions for structuring applications. Backbone doesn't force usage of all of its components and can work with only those needed.</li>
      </ul><h1>
      <a name="user-content-the-internals" class="anchor" href="#the-internals"><span class="octicon octicon-link"></span></a>The Internals</h1>

      <p>In this section, you'll learn the essentials of Backbone's models, views, collections and routers, as well as about using namespacing to organize your code. This isn't meant as a replacement for the official documentation, but it will help you understand many of the core concepts behind Backbone before you start building applications with it.</p>

      <ul>
      <li>Models</li>
      <li>Collections</li>
      <li>Routers</li>
      <li>Views</li>
      <li>Namespacing</li>
      </ul><h2>
      <a name="user-content-models-1" class="anchor" href="#models-1"><span class="octicon octicon-link"></span></a>Models</h2>

      <p>Backbone models contain interactive data for an application as well as the logic around this data. For example, we can use a model to represent the concept of a todo item including its attributes like title (todo content) and completed (current state of the todo).</p>

      <p>Models can be created by extending <code>Backbone.Model</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// We can then create our own concrete instance of a (Todo) model</span>
      <span class="c1">// with no values at all:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// or with some arbitrary data:</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the both model instances in the console.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-initialization" class="anchor" href="#initialization"><span class="octicon octicon-link"></span></a>Initialization</h4>

      <p>The <code>initialize()</code> method is called when a new instance of a model is created. Its use is optional, however you'll see why it's good practice to use it below.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      </pre></div>

      <p><strong>Default values</strong></p>

      <p>There are times when you want your model to have a set of default values (e.g. in a scenario where a complete set of data isn't provided by the user). This can be set using a property called <code>defaults</code> in your model.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Now we can create our concrete instance of the model </span>
      <span class="c1">// with default values as follows:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// Or we could instantiate it with some of the attributes (e.g with custom title):</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the logged models in the console.'</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>

      <span class="c1">// Or with all of the (default) attributes:</span>
      <span class="kd">var</span> <span class="nx">todo3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'This todo is done, so take no action on this one.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo3</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-getters--setters" class="anchor" href="#getters--setters"><span class="octicon octicon-link"></span></a>Getters &amp; Setters</h4>

      <p><strong>Model.get()</strong></p>

      <p><code>Model.get()</code> provides easy access to a model's attributes. All attributes, regardless if default ones or one passed through to the model on instantiation, are available for retrieval.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// empty string</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Retrieved with models get() method."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// Retrieved with models get() method.</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// true</span>
      </pre></div>

      <p>If you need to read or clone all of a model's data attributes use its <code>toJSON</code> method. Despite the name it doesn't return a JSON string but a copy of the attributes as an object. ("toJSON" is part of the JSON.stringify specification. Passing an object with a toJSON method makes it stringify the return value of that method instead of the object itself.)</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">todo1Attributes</span> <span class="o">=</span> <span class="nx">todo1</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="c1">// Following logs: {"title":"","completed":false} </span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1Attributes</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Try these examples and check results in console."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="c1">// logs: {"title":"Try examples and check results in console.","completed":true}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
      </pre></div>

      <p><strong>Model.set()</strong></p>

      <p><code>Model.set()</code> allows us to pass attributes into an instance of our model. Attributes can either be set during initialization or at any time afterwards. Backbone uses Model.set() to know when to broadcast that a model's data has changed.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Setting the value of attributes via instantiation</span>
      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Set through instantiation."</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set single attribute value at the time through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Title attribute set through Model.set()."</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set map of attributes through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Both attributes set through Model.set()."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <p><strong>Direct access</strong></p>

      <p>If you really need to access the attributes in a model's instance directly, there is <code>Model.attributes</code>. But remember it is best practice to use Model.get(), Model.set() or direct instantiation as explained above.</p>

      <h4>
      <a name="user-content-listening-for-changes-to-your-model" class="anchor" href="#listening-for-changes-to-your-model"><span class="octicon octicon-link"></span></a>Listening for changes to your model</h4>

      <p>Any and all of the attributes in a Backbone model can have listeners bound to them which detect when their values change. Listeners can be added to the <code>initialize()</code> function:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'- Values for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'On each change of attribute values listener is triggered.'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Listener is triggered for each change, not for change of the each attribute.'</span><span class="p">,</span>
        <span class="s1">'complete'</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      </pre></div>

      <p>In the following example, we log a message whenever a specific attribute (the title of our Todo model) is altered.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:title'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title value for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">},</span>
        <span class="nx">setTitle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="c1">// Following changes trigger the listener:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Check what\'s logged.'</span><span class="p">);</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="s1">'Go fishing on Sunday.'</span><span class="p">);</span>

      <span class="c1">// But, this change type is not observed, so no listener is triggered:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo set as completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre></div>

      <h4>
      <a name="user-content-validation" class="anchor" href="#validation"><span class="octicon octicon-link"></span></a>Validation</h4>

      <p>Backbone supports model validation through <code>Model.validate()</code>, which allows checking the attribute values for a model prior to them being set.</p>

      <p>Validation functions can be as simple or complex as necessary. If the attributes provided are valid, nothing should be returned from <code>.validate()</code>. If they are invalid, a custom error can be returned instead.</p>

      <p>A basic example for validation can be seen below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attribs</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">attribs</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
              <span class="k">return</span> <span class="s2">"Remember to set a title for your todo."</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="c1">// logs: Remember to set a title for your todo.</span>
      </pre></div>

      <p><strong>Note</strong>: Backbone passes the <code>attributes</code> object (attribs param in above example) by shallow copy to the <code>validate</code> function using the Underscore <code>_.extend</code> method. This means that it is not possible to change any Number, String or Boolean attribute but it <em>is</em> possible to change attributes of objects because they are passed by reference. As shallow copy doesn't copy objects by implicitly copying them, but rather, by reference, one can change the attributes on those objects.</p>

      <p>An example of this (by @fivetanley) is available <a href="http://jsfiddle.net/2NdDY/7/">here</a>.</p>

      <h2>
      <a name="user-content-views-1" class="anchor" href="#views-1"><span class="octicon octicon-link"></span></a>Views</h2>

      <p>Views in Backbone don't contain the markup for your application, but rather they are there to support models by defining the logic for how they should be represented to the user. This is usually achieved using JavaScript templating (e.g. Mustache, jQuery-tmpl, etc.). A view's <code>render()</code> function can be bound to a model's <code>change()</code> event, allowing the view to always be up to date without requiring a full page refresh.</p>

      <h4>
      <a name="user-content-creating-new-views" class="anchor" href="#creating-new-views"><span class="octicon octicon-link"></span></a>Creating new views</h4>

      <p>Similar to the previous sections, creating a new view is relatively straight-forward. To create a new View, simply extend <code>Backbone.View</code>. I'll explain this code in detail below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Cache the template function for a single item.</span>
        <span class="nx">todoTpl</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
          <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
          <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoTpl</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo label is double clicked</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo loses focus</span>
        <span class="p">},</span>

        <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// executed on each keypress when in todo edit mode, </span>
          <span class="c1">// but we'll wait for enter to get in action</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">();</span>

      <span class="c1">// logs reference to a DOM element that cooresponds to the view instance</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre></div>

      <h4>
      <a name="user-content-what-is-el" class="anchor" href="#what-is-el"><span class="octicon octicon-link"></span></a>What is <code>el</code>?</h4>

      <p><code>el</code> is basically a reference to a DOM element and all views must have one. It allows for all of the contents of a view to be inserted into the DOM at once, which makes for faster rendering because the browser performs the minimum required reflows and repaints.</p>

      <p>There are two ways to attach a DOM element to a view: a new element is created for the view and added manually by the developer or the element already exists in the page.</p>

      <p>If you want to create a new element for your view, set any combination of the following view's properties: <code>tagName</code>, <code>id</code> and <code>className</code>. A new element will be created for you by the framework and a reference to it will be available at the <code>el</code> property. If nothing is specified <code>el</code> defaults to <code>div</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'ul'</span><span class="p">,</span> <span class="c1">// required, but defaults to 'div' if not set</span>
        <span class="nx">className</span><span class="o">:</span> <span class="s1">'container'</span><span class="p">,</span> <span class="c1">// optional, you can assign multiple classes to this property like so 'container homepage'</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">'todos'</span><span class="p">,</span> <span class="c1">// optional</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todosView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosView</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todosView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre></div>

      <p>The above code creates the <code>DOMElement</code> below but doesn't append it to the DOM.</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todos"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;&lt;/ul&gt;</span>
      </pre></div>

      <p>If the element already exists in the page, you can set <code>el</code> as a CSS selector that matches the element.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">el</span><span class="o">:</span> <span class="s1">'#footer'</span>
      </pre></div>

      <p><strong>Understanding <code>render()</code></strong></p>

      <p><code>render()</code> is an optional function that defines the logic for rendering a template. We'll use Underscore's micro-templating in these examples, but remember you can use other templating frameworks if you prefer.</p>

      <p>The <code>_.template</code> method in Underscore compiles JavaScript templates into functions which can be evaluated for rendering. In the above view, I'm passing the markup from a template with id <code>item-template</code> to <code>_.template()</code> to be compiled. Next, I set the html of the <code>el</code> DOM element to the output of processing a JSON version of the model associated with the view through the compiled template.</p>

      <p>Presto! This populates the template, giving you a data-complete set of markup in just a few short lines of code.</p>

      <p><strong>The <code>events</code> attribute</strong></p>

      <p>The Backbone <code>events</code> attribute allows us to attach event listeners to either custom selectors, or directly to <code>el</code> if no selector is provided. An event takes the form <code>{'eventName selector': 'callbackFunction'}</code> and a number of DOM event-types are supported, including <code>click</code>, <code>submit</code>, <code>mouseover</code>, <code>dblclick</code> and more.</p>

      <p>What isn't instantly obvious is that under the bonnet, Backbone uses jQuery's <code>.delegate()</code> to provide instant support for event delegation but goes a little further, extending it so that <code>this</code> always refers to the current view object. The only thing to really keep in mind is that any string callback supplied to the events attribute must have a corresponding function with the same name within the scope of your view.</p>

      <h2>
      <a name="user-content-collections" class="anchor" href="#collections"><span class="octicon octicon-link"></span></a>Collections</h2>

      <p>Collections are sets of Models and are created by extending <code>Backbone.Collection</code>.</p>

      <p>Normally, when creating a collection you'll also want to pass through a property specifying the model that your collection will contain, as well as any instance properties required.</p>

      <p>In the following example, we create a TodoCollection that will contain our Todo models:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read the whole book'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>

      <span class="c1">// pass array of models on collection instantiation</span>
      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">myTodo</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="c1">// Collection's convenience method used to create </span>
      <span class="c1">// new model instance within collection itself.</span>
      <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">48</span><span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p><strong>Getters and Setters</strong></p>

      <p>There are a few different ways to retrieve a model from a collection. The most straight-forward is to use <code>Collection.get()</code> which accepts a single id as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// extends on previous example</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

      <span class="c1">// Models, as objects, are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre></div>

      <p>Internally <code>Backbone.Collection</code> sets an array of models enumerated by their <code>id</code> property, if model instances happen to have one. Once <code>collection.get(id)</code> is called this array is checked for existence of the model instance with the corresponding <code>id</code>.</p>

      <p>Sometimes you may also want to get a model based on its client id. The client id is a property that Backbone automatically assigns models that have not yet been saved. You can get a model's client id from its <code>.cid</code> property.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// extends on previous examples</span>

      <span class="kd">var</span> <span class="nx">todoCid</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">cid</span><span class="p">);</span>

      <span class="c1">// As mentioned in previous example, </span>
      <span class="c1">// models are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre></div>

      <p>Backbone Collections don't have setters as such, but do support adding new models via <code>.add()</code> and removing models via <code>.remove()</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Jamaica.'</span><span class="p">}),</span>
          <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to China.'</span><span class="p">}),</span>
          <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Disneyland.'</span><span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p><strong>Listening for events</strong></p>

      <p>As collections represent a group of items, we're also able to listen for <code>add</code> and <code>remove</code> events for when new models are added or removed from the collection. Here's an example:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I should "</span> <span class="o">+</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">". Have I done it before? "</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"completed"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'Yeah!'</span><span class="o">:</span> <span class="s1">'Not.'</span> <span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>
      </pre></div>

      <p>In addition, we're able to bind a <code>change</code> event to listen for changes to models in the collection.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"change:title"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Changed my mind where I should go, "</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'go fishing'</span><span class="p">);</span>
      </pre></div>

      <p><strong>Fetching models from the server</strong></p>

      <p><code>Collections.fetch()</code> retrieves a default set of models from the server in the form of a JSON array. When this data returns, the current collection's contents will be replaced with the contents of the array.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'/todos'</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
      </pre></div>

      <p>During configuration, Backbone sets a variable to denote if extended HTTP methods are supported by the server. Another setting controls if the server understands the correct MIME type for JSON:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre></div>

      <p>The Backbone.sync method that uses these values is actually an integral part of Backbone.js. A jQuery-like ajax method is assumed, so HTTP parameters are organised based on jQuery’s API. Searching through the code for calls to the sync method show it’s used whenever a model is saved, fetched, or deleted (destroyed).</p>

      <p>Under the covers, <code>Backbone.sync</code> is the function called every time Backbone tries to read or save models to the server. It uses jQuery or Zepto's ajax implementations to make these RESTful requests, however this can be overridden as per your needs.</p>

      <p>The sync function may be overriden globally as Backbone.sync, or at a finer-grained level, by adding a sync function to a Backbone collection or to an individual model.</p>

      <p>There’s no fancy plugin API for adding a persistence layer – simply override Backbone.sync with the same function signature:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">};</span>
      </pre></div>

      <p>The default methodMap is useful for working out what the method argument does:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">methodMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'create'</span><span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'update'</span><span class="o">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'delete'</span><span class="o">:</span> <span class="s1">'DELETE'</span><span class="p">,</span>
        <span class="s1">'read'</span><span class="o">:</span>   <span class="s1">'GET'</span>
      <span class="p">};</span>
      </pre></div>

      <p>In the above example if we wanted to log an event when <code>.sync()</code> was called, we could do this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">id_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I've been passed "</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s2">" with "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">'create'</span><span class="p">){</span> <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">id_counter</span><span class="o">++</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">};</span>
      </pre></div>

      <p><strong>Resetting/Refreshing Collections</strong></p>

      <p>Rather than adding or removing models individually, you might occasionally wish to update an entire collection at once. <code>Collection.reset()</code> allows us to replace an entire collection with new models as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">reset</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Cuba.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
      <span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre></div>

      <p>Note that using <code>Collection.reset()</code> doesn't fire any <code>add</code> or <code>remove</code> events. A <code>reset</code> event is fired instead as shown in example.</p>

      <h3>
      <a name="user-content-underscore-utility-functions" class="anchor" href="#underscore-utility-functions"><span class="octicon octicon-link"></span></a>Underscore utility functions</h3>

      <p>As Backbone requires Underscore as a hard dependency, we're able to use many of the utilities it has to offer to aid with our application development. Here's an example of how Underscore's <code>forEach</code> method that can be used for iterating over collection and <code>sortBy()</code> method that can be used to sort a collection of todos based on a particular attribute.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Belgium.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Austria.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">sortedByAlphabet</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">sortBy</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"- Now sorted: "</span><span class="p">);</span>

      <span class="nx">sortedByAlphabet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>
      </pre></div>

      <p>The complete list of what Underscore can do is beyond the scope of this guide, but can be found in its official <a href="http://documentcloud.github.com/underscore/">docs</a>.</p>

      <h3>
      <a name="user-content-chainable-api" class="anchor" href="#chainable-api"><span class="octicon octicon-link"></span></a>Chainable API</h3>

      <p>Speaking of utility methods, another bit of sugar in Backbone is the support for Underscore’s chain method. This works by calling the original method with the current array of models and returning the result. In case you haven’t seen it before, the chainable API looks like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Tim'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Ida'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">26</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Rob'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">55</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">filteredNames</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">chain</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">value</span><span class="p">();</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filteredNames</span><span class="p">);</span> <span class="c1">// logs: ['Ida', 'Rob']</span>
      </pre></div>

      <p>Some of the Backbone-specific methods will return this, which means they can be chained as well:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">collection</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">23</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Harry'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">33</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">41</span> <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">names</span><span class="p">);</span> <span class="c1">// logs: ['John', 'Harry', 'Steve']</span>
      </pre></div>

      <h2>
      <a name="user-content-events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h2>

      <p>As we've covered, <code>Backbone.Events</code> is mixed into the other Backbone "classes", including:</p>

      <ul>
      <li>Backbone.Model</li>
      <li>Backbone.Collection</li>
      <li>Backbone.Router</li>
      <li>Backbone.History</li>
      <li>Backbone.View</li>
      </ul><p>Events are the standard way to deal with user interface actions, through the declarative event bindings on views, and also model and collection changes. Mastering events is one of the quickest ways to become more productive with Backbone.</p>

      <p><code>Backbone.Events</code> also has the ability to give any object a way to bind and trigger custom events. We can mix this module into any object easily and there isn't a requirement for events to be declared prior to them being bound.</p>

      <p>Example:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="c1">// Add a custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'We triggered '</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// Trigger the custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="s1">'our event'</span><span class="p">);</span>
      </pre></div>

      <p>If you're familiar with jQuery custom events or the concept of Publish/Subscribe, <code>Backbone.Events</code> provides a system that is very similar with <code>on</code> being analogous to <code>subscribe</code> and <code>trigger</code> being similar to <code>publish</code>.</p>

      <p><code>on</code> basically allows us to bind a callback function to any object, as we've done with <code>dance</code> in the above example. Whenever the event is fired, our callback is invoked.</p>

      <p>The official Backbone.js documentation recommends namespacing event names using colons if you end up using quite a few of these on your page. e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// This one triggers nothing as no listener listens for it</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p>A special <code>all</code> event is made available in case you would like an event to be triggered when any event occurs (e.g if you would like to screen events in a single location). The <code>all</code> event can be used as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"all"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"The name of the event passed was "</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// This time each event will be catched with catch 'all' event listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p><code>off</code> allows us to remove a callback function that has previously been bound from an object. Going back to our Publish/Subscribe comparison, think of it as an <code>unsubscribe</code> for custom events.</p>

      <p>To remove the <code>dance</code> event we previously bound to <code>ourObject</code>, we would simply do:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We  "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events. Each will be catched and acted upon.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"started tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"started break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes event bound to the object</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events again, but one is logged.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"stopped tap dancing."</span><span class="p">);</span> <span class="c1">// won't be logged as its not listened for</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre></div>

      <p>To remove all callbacks for the event we should just pass event name (e.g <code>move</code>) to <code>off()</code> function of the object event is bound to. If we wish to remove just a callback by a specific name, we can pass callback name as second parameter:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are dancing. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">jumping</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are jumping. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add two listeners to the same event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">jumping</span><span class="p">);</span>

      <span class="c1">// Trigger the events. Both listeners are called.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes specified listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the events again. One listener left.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah, jump, jump!"</span><span class="p">);</span>
      </pre></div>

      <p>Finally, <code>trigger</code> triggers a callback for a specified event (or a space-separated list of events). e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s1">'just dancing.'</span><span class="p">);</span>

      <span class="c1">// Multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="s1">'very tired from so much action.'</span><span class="p">);</span>
      </pre></div>

      <p>It is also possible to pass along additional arguments to each (or all) of these events via a second argument supported by <code>trigger</code>. e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">actionObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">action</span> <span class="o">+</span> <span class="s1">' for '</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">duration</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Passing multiple arguments to single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"5 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'dancing'</span><span class="p">});</span>

      <span class="c1">// Passing multiple arguments to multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"15 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'on fire'</span><span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-routers" class="anchor" href="#routers"><span class="octicon octicon-link"></span></a>Routers</h2>

      <p>In Backbone, routers are used to help manage application state and for connecting URLs to application events. This is achieved using hash-tags with URL fragments, or using the browser's pushState and History API. Some examples of routes may be seen below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#about</span>
      <span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#search/seasonal-horns/page2</span>
      </pre></div>

      <p>Note: An application will usually have at least one route mapping a URL route to a function that determines what happens when a  user reaches that particular route. This relationship is defined as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="s1">'route'</span> <span class="o">:</span> <span class="s1">'mappedFunction'</span>
      </pre></div>

      <p>Let us now define our first controller by extending <code>Backbone.Router</code>. For the purposes of this guide, we're going to continue pretending we're creating a complex todo application (something like personal organize/planner) that requires a complex TodoRouter.</p>

      <p>Note the inline comments in the code example below as they continue the rest of the lesson on routers.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="cm">/* define the route and function maps for this router */</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
              <span class="cm">/* Sample usage: http://example.com/#about */</span>

              <span class="s2">"todo/:id"</span> <span class="o">:</span> <span class="s2">"getTodo"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a ":param" variable which allows us to match</span>
      <span class="cm">        any of the components between two URL slashes */</span>
              <span class="cm">/* Sample usage: http://example.com/#todo/5 */</span>

              <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* We can also define multiple routes that are bound to the same map function,</span>
      <span class="cm">        in this case searchTodos(). Note below how we're optionally passing in a</span>
      <span class="cm">        reference to a page number if one is supplied */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job */</span>

              <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* As we can see, URLs may contain as many ":param"s as we wish */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job/p1 */</span>

              <span class="s2">"todos/:id/download/*documentPath"</span> <span class="o">:</span> <span class="s2">"downloadDocument"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a *splat. splats are able to match any number of</span>
      <span class="cm">        URL components and can be combined with ":param"s*/</span>
              <span class="cm">/* Sample usage: http://example.com/#todos/5/download/files/Meeting_schedule.doc */</span>

              <span class="cm">/* If you wish to use splats for anything beyond default routing, it's probably a good</span>
      <span class="cm">        idea to leave them at the end of a URL otherwise you may need to apply regular</span>
      <span class="cm">        expression parsing on your fragment */</span>

              <span class="s2">"*other"</span>    <span class="o">:</span> <span class="s2">"defaultRoute"</span>
              <span class="cm">/* This is a default route that also uses a *splat. Consider the</span>
      <span class="cm">        default route a wildcard for URLs that are either not matched or where</span>
      <span class="cm">        the user has incorrectly typed in a route path manually */</span>
              <span class="cm">/* Sample usage: http://example.com/# &lt;anything */</span>
          <span class="p">},</span>

          <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="p">},</span>

          <span class="nx">getTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
              <span class="cm">/*</span>
      <span class="cm">        Note that the id matched in the above route will be passed to this function</span>
      <span class="cm">        */</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"You are trying to reach todo "</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">downloadDocument</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">path</span><span class="p">){</span>
          <span class="p">},</span>

          <span class="nx">defaultRoute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Invalid. You attempted to reach:'</span> <span class="o">+</span> <span class="nx">other</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="cm">/* Now that we have a router setup, remember to instantiate it */</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
      </pre></div>

      <p>As of Backbone 0.5+, it's possible to opt-in for HTML5 pushState support via <code>window.history.pushState</code>. This permits you to define routes such as <a href="http://www.scriptjunkie.com/just/an/example">http://www.scriptjunkie.com/just/an/example</a>. This will be supported with automatic degradation when a user's browser doesn't support pushState. For the purposes of this tutorial, we'll use the hashtag method.</p>

      <h4>
      <a name="user-content-is-there-a-limit-to-the-number-of-routers-i-should-be-using" class="anchor" href="#is-there-a-limit-to-the-number-of-routers-i-should-be-using"><span class="octicon octicon-link"></span></a>Is there a limit to the number of routers I should be using?</h4>

      <p>Andrew de Andrade has pointed out that DocumentCloud themselves usually only use a single router in most of their applications. You're very likely to not require more than one or two routers in your own projects as the majority of your application routing can be kept organized in a single controller without it getting unwieldy.</p>

      <h4>
      <a name="user-content-backbonehistory" class="anchor" href="#backbonehistory"><span class="octicon octicon-link"></span></a>Backbone.history</h4>

      <p>Next, we need to initialize <code>Backbone.history</code> as it handles <code>hashchange</code> events in our application. This will automatically handle routes that have been defined and trigger callbacks when they've been accessed.</p>

      <p>The <code>Backbone.history.start()</code> method will simply tell Backbone that it's OK to begin monitoring all <code>hashchange</code> events as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="cm">/* define the route and function maps for this router */</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
          <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
          <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span>
        <span class="p">},</span>

        <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>

        <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to and check console:</span>
      <span class="c1">// http://localhost/#search/job/p3 logs: Page number: 3 of the results for todos containing the word: job</span>
      <span class="c1">// http://localhost/#search/job logs: Page number: 1 of the results for todos containing the word: job </span>
      <span class="c1">// etc.</span>
      </pre></div>

      <p>Note: To test last example you should set site for testing in local development environment which is out of scope of this book.</p>

      <p>As an aside, if you would like to save application state to the URL at a particular point you can use the <code>.navigate()</code> method to achieve this. It simply updates your URL fragment without the need to trigger the <code>hashchange</code> event:</p>

      <div class="highlight highlight-javascript"><pre><span class="cm">/* Lets imagine we would like a specific fragment (edit) once a user opens single todo */</span>
      <span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">);</span> <span class="c1">// updates the fragment for us, but doesn't trigger the route</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but editTodo() function is not invoked even though location we end up is mapped to it.</span>
      <span class="c1">//</span>
      <span class="c1">// logs: View todo requested.</span>
      </pre></div>

      <p>It is also possible for <code>Router.navigate()</code> to trigger the route as well as update the URL fragment.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// updates the fragment and triggers the route as well</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but this time editTodo() function is invoked.</span>
      <span class="c1">// </span>
      <span class="c1">// logs: </span>
      <span class="c1">// View todo requested.</span>
      <span class="c1">// Edit todo openned. </span>
      </pre></div>

      <h3>
      <a name="user-content-backbones-sync-api" class="anchor" href="#backbones-sync-api"><span class="octicon octicon-link"></span></a>Backbone’s Sync API</h3>

      <p>The Backbone.sync method is intended to be overridden to support other backends. The built-in method is tailored to a certain breed of RESTful JSON APIs – Backbone was originally extracted from a Ruby on Rails application, which uses HTTP methods like PUT the same way.</p>

      <p>The way this works is the model and collection classes have a sync method that calls Backbone.sync. Both will call this.sync internally when fetching, saving, or deleting items.</p>

      <p>The sync method is called with three parameters:</p>

      <ul>
      <li>method: One of create, update, delete, read</li>
      <li>model: The Backbone model object</li>
      <li>options: May include success and error methods</li>
      </ul><p>Implementing a new sync method can use the following pattern:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">requestContent</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">'create'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'read'</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
      </pre></div>

      <p>This pattern delegates API calls to a new object, which could be a Backbone-style class that supports events. This can be safely tested separately, and potentially used with libraries other than Backbone.</p>

      <p>There are quite a few sync implementations out there:</p>

      <ul>
      <li>Backbone localStorage</li>
      <li>Backbone offline</li>
      <li>Backbone Redis</li>
      <li>backbone-parse</li>
      <li>backbone-websql</li>
      <li>Backbone Caching Sync</li>
      </ul><h3>
      <a name="user-content-conflict-management" class="anchor" href="#conflict-management"><span class="octicon octicon-link"></span></a>Conflict Management</h3>

      <p>Like most client-side projects, Backbone.js wraps everything in an immediately-invoked function expression:</p>

      <div class="highlight highlight-javascript"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// Backbone.js</span>
      <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      </pre></div>

      <p>Several things happen during this configuration stage. A Backbone “namespace” is created, and multiple versions of Backbone on the same page are supported through the noConflict mode:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">previousBackbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">;</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">previousBackbone</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">};</span>
      </pre></div>

      <p>Multiple versions of Backbone can be used on the same page by calling noConflict like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Backbone19</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="c1">// Backbone19 refers to the most recently loaded version,</span>
      <span class="c1">// and `window.Backbone` will be restored to the previously</span>
      <span class="c1">// loaded version</span>
      </pre></div>

      <p>This initial configuration code also supports CommonJS modules so Backbone can be used in Node projects:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Backbone</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      </pre></div>

      <h2>
      <a name="user-content-inheritance--mixins" class="anchor" href="#inheritance--mixins"><span class="octicon octicon-link"></span></a>Inheritance &amp; Mixins</h2>

      <p>For its inheritance, Backbone internally uses an <code>inherits</code> function inspired by <code>goog.inherits</code>, Google’s implementation from the Closure Library. It's basically a function to correctly setup the prototype chain.</p>

      <div class="highlight highlight-javascript"><pre> <span class="kd">var</span> <span class="nx">inherits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
      </pre></div>

      <p>The only major difference here is that Backbone’s API accepts two objects containing “instance” and “static” methods.</p>

      <p>Following on from this, for inheritance purposes all of Backbone's objects contain an <code>extend</code> method as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">View</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">;</span>
      </pre></div>

      <p>Most development with Backbone is based around inheriting from these objects, and they’re designed to mimic a classical object-oriented implementation.</p>

      <p>If this sounds familiar, it's because <code>extend</code> is an Underscore.js utility, although Backbone itself does a lot more with this. See below for Underscore's <code>extend</code>:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
      </pre></div>

      <p>The above isn’t quite the same as ES5’s <code>Object.create</code>, as it’s actually copying properties (methods and values) from one object to another. As this isn’t enough to support Backbone’s inheritance and class model, the following steps are performed:</p>

      <ul>
      <li>The instance methods are checked to see if there’s a constructor property. If so, the class’s constructor is used, otherwise the parent’s constructor is used (i.e., Backbone.Model)</li>
      <li>Underscore’s extend method is called to add the parent class’s methods to the new child class</li>
      <li>The <code>prototype</code> property of a blank constructor function is assigned with the parent’s prototype, and a new instance of this is set to the child’s <code>prototype</code> property
      Underscore’s extend method is called twice to add the static and instance methods to the child class</li>
      <li>The child’s prototype’s constructor and a <code>__super__</code> property are assigned</li>
      <li>This pattern is also used for classes in CoffeeScript, so Backbone classes are compatible with CoffeeScript classes.</li>
      </ul><p><code>extend</code> can be used for a great deal more and developers who are fans of mixins will like that it can be used for this too. You can define functionality on any custom object, and then quite literally copy &amp; paste all of the methods and attributes from that object to a Backbone one:</p>

      <p>For example:</p>

      <div class="highlight highlight-javascript"><pre> <span class="kd">var</span> <span class="nx">MyMixin</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">,</span>
        <span class="nx">sayFoo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
       <span class="c1">// ...</span>
      <span class="p">});</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">MyView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">MyMixin</span><span class="p">);</span>

      <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">();</span>
      <span class="nx">myView</span><span class="p">.</span><span class="nx">sayFoo</span><span class="p">();</span> <span class="c1">//=&gt; 'bar'</span>
      </pre></div>

      <p>We can take this further and also apply it to View inheritance. The following is an example of how to extend one View using another:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>
      </pre></div>

      <p>However, if you have an <code>initialize()</code> method in Panel, then it won't be called if you also have an <code>initialize()</code> method in PanelAdvanced, so you would have to call Panel's initialize method explicitly:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span> <span class="c1">// Log: bar</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="k">new</span> <span class="nx">Panel</span><span class="p">();</span>
      <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span>
      </pre></div>

      <p>This isn't the most elegant of solutions because if you have a lot of Views that inherit from Panel, then you'll have to remember to call Panel's initialize from all of them.</p>

      <p>It's worth noting that if Panel doesn't have an initialize method now but you choose to add it in the future, then you'll need to go to all of the inherited classes in the future and make sure they call Panel's initialize.</p>

      <p>So here's an alternative way to define Panel so that your inherited views don't need to call Panel's initialize method:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's initialization code here</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Panel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's methods here. For example:</span>
        <span class="nx">sayHi</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello from Panel'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>

      <span class="c1">// other classes then inherit from Panel like this:</span>
      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span> <span class="c1">//Logs: Panel initialized, PanelAdvanced initialized, bar</span>
      <span class="nx">PanelAdvanced</span><span class="p">.</span><span class="nx">sayHi</span><span class="p">();</span> <span class="c1">// Logs: hello from Panel</span>
      </pre></div>

      <p>When used appropriately, Backbone's <code>extend</code> method can save a great deal of time and effort writing redundant code.</p>

      <p>(Thanks to <a href="http://dailyjs.com">Alex Young</a>, <a href="http://stackoverflow.com/users/93448/derick-bailey">Derick Bailey</a> and <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for the heads up about these tips).</p>

      <h4>
      <a name="user-content-backbone-super" class="anchor" href="#backbone-super"><span class="octicon octicon-link"></span></a>Backbone-Super</h4>

      <p><a href="https://github.com/lukasolson/Backbone-Super">Backbone-Super</a> by Lukas Olson adds a <em>_super</em> method to <em>Backbone.Model</em> using <a href="http://ejohn.org/blog/simple-javascript-inheritance/">John Resig’s Inheritance script</a>.
      Rather than using Backbone.Model.prototype.set.call as per the Backbone.js documentation, _super can be called instead:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// This is how we normally do it</span>
      <span class="kd">var</span> <span class="nx">OldFashionedNote</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>After including this plugin, you can do the same thing with the following syntax:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// This is how we can do it after using the Backbone-super plugin</span>
      <span class="kd">var</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-namespacing" class="anchor" href="#namespacing"><span class="octicon octicon-link"></span></a>Namespacing</h2>

      <p>When learning how to use Backbone, an important and commonly overlooked area by tutorials is namespacing. If you already have experience with namespacing in JavaScript, the following section will provide some advice on how to specifically apply concepts you know to Backbone, however I will also be covering explanations for beginners to ensure everyone is on the same page.</p>

      <h4>
      <a name="user-content-what-is-namespacing" class="anchor" href="#what-is-namespacing"><span class="octicon octicon-link"></span></a>What is namespacing?</h4>

      <p>The basic idea around namespacing is to avoid collisions with other objects or variables in the global namespace. They're important as it's best to safeguard your code from breaking in the event of another script on the page using the same variable names as you are. As a good 'citizen' of the global namespace, it's also imperative that you do your best to similarly not prevent other developer's scripts executing due to the same issues.</p>

      <p>JavaScript doesn't really have built-in support for namespaces like other languages, however it does have closures which can be used to achieve a similar effect.</p>

      <p>In this section we'll be taking a look shortly at some examples of how you can namespace your models, views, routers and other components specifically. The patterns we'll be examining are:</p>

      <ul>
      <li>Single global variables</li>
      <li>Object Literals</li>
      <li>Nested namespacing</li>
      </ul><p><strong>Single global variables</strong></p>

      <p>One popular pattern for namespacing in JavaScript is opting for a single global variable as your primary object of reference. A skeleton implementation of this where we return an object with functions and properties can be found below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="kd">function</span><span class="p">(){</span>
            <span class="c1">// ...</span>
          <span class="p">},</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="c1">// ...</span>
          <span class="p">}</span>
      <span class="p">})();</span>
      </pre></div>

      <p>You've probably seen this technique before. A Backbone-specific example might look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myViews</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">TodoView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">TodosView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">AboutView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">});</span>
              <span class="c1">//etc.</span>
          <span class="p">};</span>
      <span class="p">})();</span>
      </pre></div>

      <p>Here we can return a set of views, but the same technique could return an entire collection of models, views and routers depending on how you decide to structure your application. Although this works for certain situations, the biggest challenge with the single global variable pattern is ensuring that no one else has used the same global variable name as you have in the page.</p>

      <p>One solution to this problem, as mentioned by Peter Michaux, is to use prefix namespacing. It's a simple concept at heart, but the idea is you select a common prefix name (in this example, <code>myApplication_</code>) and then define any methods, variables or other objects after the prefix.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myApplication_todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({}),</span>
          <span class="nx">myApplication_todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>This is effective from the perspective of trying to lower the chances of a particular variable existing in the global scope, but remember that a uniquely named object can have the same effect. This aside, the biggest issue with the pattern is that it can result in a large number of global objects once your application starts to grow.</p>

      <p>For more on Peter's views about the single global variable pattern, read his <a href="http://michaux.ca/articles/javascript-namespacing">excellent post on them</a>.</p>

      <p>Note: There are several other variations on the single global variable pattern out in the wild, however having reviewed quite a few, I felt the prefixing approach applied best to Backbone.</p>

      <p><strong>Object Literals</strong></p>

      <p>Object Literals have the advantage of not polluting the global namespace but assist in organizing code and parameters logically. They're beneficial if you wish to create easily readable structures that can be expanded to support deep nesting. Unlike simple global variables, Object Literals often also take into account tests for the existence of a variable by the same name, which helps reduce the chances of collision.</p>

      <p>This example demonstrates two ways you can check to see if a namespace already exists before defining it. I commonly use Option 2.</p>

      <div class="highlight highlight-javascript"><pre><span class="cm">/* Doesn't check for existence of myApplication */</span>
      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="cm">/*</span>
      <span class="cm">Does check for existence. If already defined, we use that instance.</span>
      <span class="cm">Option 1:   if(!myApplication) myApplication = {};</span>
      <span class="cm">Option 2:   var myApplication = myApplication || {};</span>
      <span class="cm">We can then populate our object literal to support models, views and collections (or any data, really):</span>
      <span class="cm">*/</span>

      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">models</span> <span class="o">:</span> <span class="p">{},</span>
          <span class="nx">views</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">pages</span> <span class="o">:</span> <span class="p">{}</span>
          <span class="p">},</span>
          <span class="nx">collections</span> <span class="o">:</span> <span class="p">{}</span>
      <span class="p">};</span>
      </pre></div>

      <p>One can also opt for adding properties directly to the namespace (such as your views, in the following example):</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myTodosViews</span> <span class="o">=</span> <span class="nx">myTodosViews</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>The benefit of this pattern is that you're able to easily encapsulate all of your models, views, routers etc. in a way that clearly separates them and provides a solid foundation for extending your code.</p>

      <p>This pattern has a number of benefits. It's often a good idea to decouple the default configuration for your application into a single area that can be easily modified without the need to search through your entire codebase just to alter it. Here's an example of a hypothetical object literal that stores application configuration settings:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">language</span><span class="o">:</span> <span class="s1">'english'</span><span class="p">,</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">enableDelegation</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">maxTodos</span><span class="o">:</span> <span class="mi">40</span>
        <span class="p">},</span>
        <span class="nx">theme</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">skin</span><span class="o">:</span> <span class="s1">'a'</span><span class="p">,</span>
          <span class="nx">toolbars</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">index</span><span class="o">:</span> <span class="s1">'ui-navigation-toolbar'</span><span class="p">,</span>
            <span class="nx">pages</span><span class="o">:</span> <span class="s1">'ui-custom-toolbar'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>Note that there are really only minor syntactical differences between the Object Literal pattern and a standard JSON data set. If for any reason you wish to use JSON for storing your configurations instead (e.g. for simpler storage when sending to the back-end), feel free to.</p>

      <p>For more on the Object Literal pattern, I recommend reading Rebecca Murphey's <a href="http://rmurphey.com/blog/2009/10/15/using-objects-to-organize-your-code">excellent article on the topic</a>.</p>

      <p><strong>Nested namespacing</strong></p>

      <p>An extension of the Object Literal pattern is nested namespacing. It's another common pattern used that offers a lower risk of collision due to the fact that even if a top-level namespace already exists, it's unlikely the same nested children do. For example, Yahoo's YUI uses the nested object namespacing pattern extensively:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">YAHOO</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Dom</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
      </pre></div>

      <p>Yahoo's YUI uses the nested object namespacing pattern regularly and even DocumentCloud (the creators of Backbone) use the nested namespacing pattern in their main applications. A sample implementation of nested namespacing with Backbone may look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">todoApp</span> <span class="o">=</span>  <span class="nx">todoApp</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// perform similar check for nested children</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// routers</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">Workspace</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">TodoSearch</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Todo</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Notes</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// special models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span><span class="p">.</span><span class="nx">Admin</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre></div>

      <p>This is readable, clearly organized, and is a relatively safe way of namespacing your Backbone application. The only real caveat however is that it requires your browser's JavaScript engine to first locate the galleryApp object, then dig down until it gets to the function you're calling. However, developers such as Juriy Zaytsev (kangax) have tested and found the performance differences between single object namespacing vs the 'nested' approach to be quite negligible.</p>

      <p><strong>Recommendation</strong></p>

      <p>Reviewing the namespace patterns above, the option that I prefer when writing Backbone applications is nested object namespacing with the object literal pattern.</p>

      <p>Single global variables may work fine for applications that are relatively trivial. However, larger codebases requiring both namespaces and deep sub-namespaces require a succinct solution that's both readable and scalable. I feel this pattern achieves both of these objectives and is a good choice for most Backbone development.</p>

      <h1>
      <a name="user-content-practical-todos---your-first-backbonejs-app" class="anchor" href="#practical-todos---your-first-backbonejs-app"><span class="octicon octicon-link"></span></a>Practical: Todos - Your First Backbone.js App</h1>

      <p>Now that we've journeyed through the fundamentals, let's move on to writing our first Backbone.js app - a Todo List application. Building a Todo List is a great way to learn about Backbone’s conventions. It's a simple enough app, but contains enough interesting problems to be useful, such as binding, persisting model data, routing and template rendering.</p>

      <p>For this chapter, we’re going to learn how to create the Backbone.js Todo app listed on <a href="http://todomvc.com">TodoMVC.com</a>.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoapp.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoapp.png" alt="" style="max-width:100%;"></a></p>

      <p>Let's think about what we need from a high level architectural standpoint.</p>

      <ul>
      <li>A <code>Todo</code> model to describe individual todo items</li>
      <li>A <code>TodoList</code> collection to store and persist todos</li>
      <li>A way of creating todos</li>
      <li>Listing todos</li>
      <li>Editing existing todos</li>
      <li>Completing todos</li>
      <li>Deleting todos</li>
      <li>A way to bookmark the items that have been completed or are remaining</li>
      </ul><p>Basically your classic <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> methods. Let's get started!</p>

      <h2>
      <a name="user-content-index" class="anchor" href="#index"><span class="octicon octicon-link"></span></a>Index</h2>

      <p>The first step is to setup the basic application dependencies, which in this case will be: <a href="http://jquery.com">jQuery</a>, <a href="http://underscorejs.org">Underscore</a>, Backbone.js and the <a href="https://github.com/jeromegn/Backbone.localStorage">Backbone LocalStorage adapter</a>. These will be loaded in our main (and only) HTML file, index.html:</p>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Backbone.js • TodoMVC<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"assets/base.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/underscore-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-localstorage.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/models/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/collections/todos.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/routers/router.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>

      </pre></div>

      <p>To help demonstrate how the various parts of our application can be split up, individual concerns are cleanly organized into folders representing our models, views, collections and routers. An app.js file is used to kick everything off.</p>

      <p>Note: If you want to follow along, create directory structure as shown in index.html. Also, you will need <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/base.css">base.css</a> and <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/bg.png">bg.png</a>, both in assets dir. As mentioned previously you can check out whole application at <a href="http://todomvc.com">TodoMVC.com</a>.</p>

      <h2>
      <a name="user-content-application-html" class="anchor" href="#application-html"><span class="octicon octicon-link"></span></a>Application HTML</h2>

      <p>Now let's take a look at our application's static HTML. We're going to need an <code>&lt;input&gt;</code> for creating new todos, a <code>&lt;ul id="todo-list" /&gt;</code> for listing the actual todos, and a section containing some operations, such as clearing completed todos.</p>

      <div class="highlight highlight-html"><pre>  <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;header</span> <span class="na">id=</span><span class="s">"header"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h1&gt;</span>todos<span class="nt">&lt;/h1&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">autofocus</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/header&gt;</span>
          <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"toggle-all"</span> <span class="na">type=</span><span class="s">"checkbox"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"toggle-all"</span><span class="nt">&gt;</span>Mark all as complete<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
          <span class="nt">&lt;/section&gt;</span>
          <span class="nt">&lt;footer</span> <span class="na">id=</span><span class="s">"footer"</span><span class="nt">&gt;&lt;/footer&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"info"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;p&gt;</span>Double-click to edit a todo<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Written by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/addyosmani"</span><span class="nt">&gt;</span>Addy Osmani<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Part of <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://todomvc.com"</span><span class="nt">&gt;</span>TodoMVC<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

      </pre></div>

      <p>We’ll be populating our todo-list and adding a statistics section with details about what items are left to be completed later on.</p>

      <p>So far so good. Now in order to tie this into our Backbone Todo app, we're going to have to go back to the fundamentals - a Todo model.</p>

      <h2>
      <a name="user-content-todo-model" class="anchor" href="#todo-model"><span class="octicon octicon-link"></span></a>Todo model</h2>

      <p>The <code>Todo</code> model is remarkably straightforward. Firstly a todo has two attributes, a <code>title</code> and a <code>completed</code> status that indicates whether it's been completed. These attributes are passed as defaults, as you can see in the example below:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/models/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>
        <span class="c1">// Our basic **Todo** model has `title` and `completed` attributes.</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo</span>
          <span class="c1">// and ensure that each todo created has `title` and `completed` keys.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `completed` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span>
            <span class="p">});</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre></div>

      <p>We also have a <code>toggle()</code> function which allows to set whether a Todo item has been completed.</p>

      <h2>
      <a name="user-content-todo-collection" class="anchor" href="#todo-collection"><span class="octicon octicon-link"></span></a>Todo collection</h2>

      <p>Next we have our <code>TodoList</code> collection used to group our models. The collection is being extended by localStorage which automatically persists Todo records to HTML5 Local Storage via the Backbone LocalStorage adapter, so they're saved between page requests.</p>

      <p>We've then got some static methods, <code>completed()</code> and <code>remaining()</code>, which return an array of unfinished and finished todos respectively.</p>

      <p>Finally we have a <code>nextOrder()</code> function, that keeps our Todo items in sequential order as well as a <code>comparator()</code> used to sort items by their insertion order.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/collections/todos.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// The collection of todos is backed by *localStorage* instead of a remote</span>
        <span class="c1">// server.</span>
        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">completed</span><span class="p">()</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Create our global collection of **Todos**.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

      </pre></div>

      <h2>
      <a name="user-content-application-view" class="anchor" href="#application-view"><span class="octicon octicon-link"></span></a>Application View</h2>

      <p>So let's look at the core of the application's logic, the views. Since each todo has a fair bit of logic associated with it, such as edit in place, we're going to use the element controller pattern - a pattern which consists of two views, one that controls a collection of items, and the other deals with each individual item.</p>

      <p>In other words, we're going to have one view <code>AppView</code>, which will be in charge creating new todos, and rendering the initial todo list. Then we'll have another view called TodoView instances of which will be associated with an individual Todo record. Todo instances will be in charge of editing, updating and destroying their associated todo.</p>

      <p>To keep thing simple, we'll keep things 'read-only' at the moment, and won't provide any functionality for creating, editing or deleting todos:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre></div>

      <p>You can see we've got a couple of things going on, an el (element), a <code>statsTemplate</code>, a constructor function and several view specific methods. To the right of the <code>el:</code> key is a DOM element selector for the element with ID <code>todoapp</code>. The value of this is just a string and Backbone will create a reference pointing to the element matching the selector #todoapp, where here it will be the <code>&lt;section id="todoapp" /&gt;</code> element, which we previously defined in our HTML.</p>

      <p>In a nutshell this means we can now refer to this.el in our controller, which points to the <code>&lt;section id="todoapp" /&gt;</code> element. As you can see, we're referring to el in the <code>addOne()</code> function, appending an element to the list.</p>

      <p>Now let's take a look at the constructor function. It's binding to several events on the Todo model, such as add, reset and all. Since we're delegating handling of updates and deletes to the <code>TodoView</code> view, we don't need to to worry about that here. The two pieces of logic are:</p>

      <ul>
      <li><p>When a new todo is created, the <code>add</code> event will be fired, calling <code>addAll()</code>. This iterates over all of the Todos currently in our collection and fires <code>addOne()</code> for each item.</p></li>
      <li><p><code>addOne()</code> instantiates the TodoView view, rendering it and appending the resultant element to our Todo list.</p></li>
      <li><p>When a <code>reset</code> event is called (i.e. we wish to update the collection in bulk such as when the Todos have been loaded from Local Storage), <code>addAll()</code> is similarly called again.</p></li>
      </ul><p>We can then add in the logic for creating new todos, editing them and filtering them based on whether they are complete.</p>

      <ul>
      <li>events: We define an events hash containing declarative callbacks for our DOM events.

      <ul>
      <li>
      <code>createOnEnter()</code>: When a user hits return inside the <code>&lt;input/&gt;</code> field, this creates a  new Todo item and resets the main <code>&lt;input/&gt;</code> field value to prepare it for the next   entry.</li>
      <li>
      <code>clearCompleted()</code>: Removes the items in the todo list that have been marked as   completed</li>
      <li>
      <code>toggleAllComplete()</code>: Allows a user to set all of the items in the todo list to  completed.</li>
      <li>
      <code>initialize()</code>:
      We bind a callback for a change:completed event, letting us know a change has     been made as well to an existing todo item
      We also bind a callback for a filter event, which works a little similar to     addOne() and addAll(). It’s responsibility is to toggle what todo items are     visible based on the filter currently selected in the UI (all, completed or     remaining) through filterOne() and filterAll().</li>
      <li>
      <code>render()</code>:
      We add some conditional CSS styling based on the filter currently selected so     that the route that has been selected is highlighted</li>
      <li>
      <code>createOnEnter()</code>:
      Creates a new Todo model which persists in localStorage when a user hits    return. This creates the model via newAttributes(), which is an object    literal composed of the title, order and completed state of the new item    being added.</li>
      <li>
      <code>clearCompleted()</code>:
      Clears all the todo items that have been marked as complete</li>
      </ul>
      </li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span> <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'click #clear-completed'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span><span class="p">,</span>
            <span class="s1">'click #toggle-all'</span><span class="o">:</span> <span class="s1">'toggleAllComplete'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#filters li a'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#/'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">||</span> <span class="s1">''</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterOne</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">todo</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'visible'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterAll</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Generate the attributes for a new Todo item.</span>
          <span class="nx">newAttributes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">(),</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">(),</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// If you hit return in the main input field, create new **Todo** model,</span>
          <span class="c1">// persisting it to *localStorage*.</span>
          <span class="nx">createOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">!==</span> <span class="nx">ENTER_KEY</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">()</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Clear all completed todo items, destroying their models.</span>
          <span class="nx">clearCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleAllComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                <span class="s1">'completed'</span><span class="o">:</span> <span class="nx">completed</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-individual-todo-view" class="anchor" href="#individual-todo-view"><span class="octicon octicon-link"></span></a>Individual Todo View</h2>

      <p>Let’s look at the <code>TodoView</code> view, now. This will be in charge of individual Todo records, making sure the view updates when the todo does. To enable enable this interactive behavior we should add some event listeners to the view, that will listen to the events on individual todo represented in html.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/views/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-renders the todo item to the current state of the model and</span>
          <span class="c1">// updates the reference to the todo's edit input within the view.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <p>In the <code>initialize()</code> constructor, we're setting up a listener to the todo model’s change event. In other words, when the todo updates, we want to re-render the view to reflect its changes.</p>

      <p>In the <code>render()</code> method, we're rendering an Underscore.js JavaScript template, called <code>#item-template</code>, which we’ve previously compiled into this.template using Underscore’s <code>_.template()</code> method.  This returns a piece of HTML that we're using to replace the view’s current element. In other words, the rendered template is now present under <code>this.el</code>, and can be appended to the todo list.</p>

      <p>Our events hash includes three callbacks:</p>

      <ul>
      <li>
      <code>edit()</code>: Changes the current view into editing mode when a user double-clicks on an existing item in the todo list. This allows them to change the existing value of the item’s title attribute</li>
      <li>
      <code>updateOnEnter()</code>: checks that the user has hit the return/enter key and executes the close() function.</li>
      <li>
      <code>close()</code>: This trims the value of the current text in our <code>&lt;input/&gt;</code> field, ensuring that we don’t process it further if it contains no text (e.g ‘’). If a valid value has been provided, we save the changes to the current todo model and close editing mode, by removing the corresponding CSS class.</li>
      </ul><h2>
      <a name="user-content-setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h2>

      <p>So now we have two views: <code>AppView</code> and <code>TodoView</code>. The former needs to get instantiated when the page loads, so some code actually gets run. You can do this simply enough, by using jQuery's <code>ready()</code> utility, which will execute a function when the DOM's loaded.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Kick things off by creating the **App**.</span>
          <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span><span class="p">();</span>

        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-in-action" class="anchor" href="#in-action"><span class="octicon octicon-link"></span></a>In action</h2>

      <p>Now we've gone far enough without checking that things work as they should. </p>

      <p>If you are following along open up index.html and, if everything's going to plan, you shouldn't see any errors in the console. The todo list will be blank (we haven't created any todos yet), and the todo-list won't work through our slick interface, as we haven't yet hooked it up fully. However, we can create a Todo from the console.</p>

      <p>Type in: <code>window.app.Todos.create({ title: 'My first Todo item'});</code> and hit return.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole.png" alt="" style="max-width:100%;"></a></p>

      <p>Once you've run the above in the console, we should be looking at a brand new todo (logged in console) we've just added in the todos collection. Created todo is saved into Local Storage as well and will be available on page refresh.</p>

      <p><code>window.app.Todos.create()</code> used above is collection method (<code>collection.create(attributes, [options])</code>) which instantiate new model item of the type passed into the collection definition, in our case <code>app.Todo</code>:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="c1">// the model type used by collection.create() to instantiate new model in the collection</span>
            <span class="p">...</span>
        <span class="p">)};</span>

      </pre></div>

      <p>Run this into console to check it out:</p>

      <p><code>var secondTodo = window.app.Todos.create({ title: 'My second Todo item'});</code></p>

      <p><code>secondTodo instanceof app.Todo</code></p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole2.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole2.png" alt="" style="max-width:100%;"></a></p>

      <h2>
      <a name="user-content-templates" class="anchor" href="#templates"><span class="octicon octicon-link"></span></a>Templates</h2>

      <p>The <code>#item-template</code> used in the <code>TodoView</code> view needs defining, so let's do that. One way of including templates in the page is by using custom script tags. These don't get evaluated by the browser, which just interprets them as plain text. Underscore micro-templating can then access the templates, rendering pieces of HTML.</p>

      <div class="highlight highlight-html"><pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"item-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"view"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"toggle"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">?</span> <span class="s1">'checked'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;&lt;%=</span> <span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"destroy"</span><span class="o">&gt;&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;</span><span class="err">/div&gt;</span>
          <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"edit"</span> <span class="nx">value</span><span class="o">=</span><span class="s2">"&lt;%= title %&gt;"</span><span class="o">&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre></div>

      <p>The template tags demonstrated above, such as <code>&lt;%=</code> , are specific to Underscore.js, and documented on the Underscore site. In your own applications, you have a choice of template libraries, such as Mustache or Handlebars. Use whichever you prefer, Backbone doesn't mind.</p>

      <p>Now when <code>_.template( $('#item-template').html() )</code> is called in the <code>TodoView</code> view our template will render correctly.</p>

      <p>We also need to define #stats-template template we use to display how many items have been completed, as well as allowing the user to clear these items.</p>

      <div class="highlight highlight-html"><pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"stats-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">strong</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;&lt;</span><span class="err">/strong&gt; &lt;%= remaining === 1 ? 'item' : 'items' %&gt; left&lt;/span&gt;</span>
          <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"filters"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"selected"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/"</span><span class="o">&gt;</span><span class="nx">All</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/active"</span><span class="o">&gt;</span><span class="nx">Active</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/completed"</span><span class="o">&gt;</span><span class="nx">Completed</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
          <span class="o">&lt;</span><span class="err">/ul&gt;</span>
          <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">completed</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
          <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"clear-completed"</span><span class="o">&gt;</span><span class="nx">Clear</span> <span class="nx">completed</span> <span class="p">(</span><span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">%&gt;</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre></div>

      <h2>
      <a name="user-content-in-action-1" class="anchor" href="#in-action-1"><span class="octicon octicon-link"></span></a>In action</h2>

      <p>Now refresh index.html and we should be able to see the fruits of our labour. </p>

      <p>The todos added through console earlier should appear in the list populated from the Local Storage. Also, we should be able to type a todo name, and press return to submit the form, creating a new todo.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todocompleted.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todocompleted.png" alt="" style="max-width:100%;"></a></p>

      <p>Excellent, we're making great progress, but how about completing and deleting todos?</p>

      <h2>
      <a name="user-content-completing--deleting-todos" class="anchor" href="#completing--deleting-todos"><span class="octicon octicon-link"></span></a>Completing &amp; deleting todos</h2>

      <p>So the next part of our tutorial is going to cover completing and deleting todos. These two actions are specific to each Todo item, so we need to add this functionality to the TodoView view.</p>

      <p>The key part of this is the two event handlers we've added, a togglecompleted event on the todo's checkbox, and a click event on the todo's <code>&lt;button class="destroy" /&gt;</code> button.</p>

      <p>The checkbox's togglecompleted event invokes the toggle() function, which toggles the todos's completed status, then resaving the todo - very straightforward!
      The button's click event invokes <code>clear()</code>, which will simply destroy the todo.</p>

      <p>That's all there is to it. Since we're binding to the change event, whenever the todo changes the view will automatically be re-rendered, checking or un-checking the checkbox as appropriate. Similarly, when the todo is destroyed, the model's <code>destroy()</code> function will be called, removing the todo from the view as we’re binding to the destroy event too.</p>

      <p>One more piece to mention is that we’ve also binded to a visible event to handle the visibility state of the todo item. This is used in conjunction with the filtering in our routes and collections so that we only display an item if its completed state falls in line with the current filter.</p>

      <p>This tutorial is long enough as is, so we won't go into in-place editing or updating. If you want an example of that, see the <a href="https://github.com/addyosmani/todomvc/tree/master/architecture-examples/backbone/">complete source</a>.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/view/todos.js</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span><span class="p">,</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click .destroy'</span><span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'visible'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the titles of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span> <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleVisible</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'hidden'</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="nx">isHidden</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isHidden</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">isCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="k">return</span> <span class="p">(</span> <span class="c1">// hidden cases only</span>
              <span class="p">(</span><span class="o">!</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'completed'</span><span class="p">)</span>
              <span class="o">||</span> <span class="p">(</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'active'</span><span class="p">)</span>
            <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `"completed"` state of the model.</span>
          <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="c1">// Remove the item, destroy the model from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-todo-routing" class="anchor" href="#todo-routing"><span class="octicon octicon-link"></span></a>Todo routing</h2>

      <p>Finally, we move on to routing, which will allow us to easily bookmark the list of items that are active as well as those which have been completed. We’ll be supporting the following routes:</p>

      <div class="highlight highlight-javascript"><pre><span class="err">#</span><span class="o">/</span> <span class="p">(</span><span class="nx">all</span> <span class="o">-</span> <span class="k">default</span><span class="p">)</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">active</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">completed</span>
      </pre></div>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todorouting.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todorouting.png" alt="" style="max-width:100%;"></a></p>

      <p>When the route changes the todo list will be filtered on a model level and the selected class on the filter links will be toggled. When an item is updated while in a filtered state, it will be updated accordingly.
      E.g. if the filter is active and the item is checked, it will be hidden. The active filter is persisted on reload.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// js/routers/router.js</span>

        <span class="c1">// Todo Router</span>
        <span class="c1">// ----------</span>

        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
          <span class="p">},</span>

          <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Set the current filter to be used</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

            <span class="c1">// Trigger a collection filter event, causing hiding/unhiding</span>
            <span class="c1">// of Todo view items</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Workspace</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      </pre></div>

      <p>As we can see in the line <code>window.app.Todos.trigger('filter')</code>, once a string filter has been set, we simply trigger our filter at a collection level to toggle which items are displayed and which of those are hidden.</p>

      <p>Finally, we call <code>Backbone.history.start()</code> to route the initial URL during page load.</p>

      <h2>
      <a name="user-content-conclusions" class="anchor" href="#conclusions"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>We’ve now learned how to build our first complete Backbone.js application. The full app can be viewed online at any time and the sources are readily available via <a href="http://www.todomvc.com">TodoMVC</a>.</p>

      <p>Later on in the book, we’ll learn how to further modularize this application using RequireJS, swap out our persistence layer to a database back-end and finally unit test the application with a few different testing frameworks.</p>

      <h1>
      <a name="user-content-backbone-boilerplate-and-grunt-bbb" class="anchor" href="#backbone-boilerplate-and-grunt-bbb"><span class="octicon octicon-link"></span></a>Backbone Boilerplate And Grunt-BBB</h1>

      <p><a href="https://github.com/tbranyen/backbone-boilerplate/">Backbone Boilerplate</a> is an excellent set of best practices and utilities for building Backbone.js applications, created by Backbone contributor <a href="https://github.com/tbranyen">Tim Branyen</a>. He organized this boilerplate out of the gotchas, pitfalls and common tasks he ran into over a year of heavily using Backbone to build apps at Bocoup. This includes apps such <a href="http://startupdatatrends.com">StartupDataTrends.com</a>.</p>

      <p>With scaffolding and built in build tasks that take care of minification, concatentation, server, template compilation and more, Backbone Boilerplate (and sister project <a href="https://github.com/backbone-boilerplate/grunt-bbb">Grunt-BBB</a>) are an excellent choice for developers of all levels. I heavily recommend using them as they will give you an enormous start when it comes to getting setup for development. They also have some great inline documentation which is also another excellent time-saver.</p>

      <p>By default, Backbone Boilerplate provides you with:</p>

      <ul>
      <li>Backbone, <a href="https://github.com/bestiejs/lodash">Lodash</a> (an <a href="http://underscorejs.org/">Underscore.js</a> alternative) and <a href="http://jquery.com">jQuery</a> with an <a href="http://html5boilerplate.com">HTML5 Boilerplate</a> foundation</li>
      <li>Boilerplate module code</li>
      <li>A Windows/Mac/Linux build tool for template precompilation and, concatenation &amp; minification of all your libraries, application code and CSS</li>
      <li>Scaffolding support (via grunt-bbb - [B]ackbone [B]oilerplate [B]uild) so you have to spend minimal time writing boilerplate for modules, collections and so on.</li>
      <li>A Lightweight node.js webserver</li>
      <li>Numerous other Backbone.js snippets for making your life easier</li>
      </ul><h2>
      <a name="user-content-getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2>

      <h3>
      <a name="user-content-backbone-boilerplate" class="anchor" href="#backbone-boilerplate"><span class="octicon octicon-link"></span></a>Backbone Boilerplate</h3>

      <p>We can use Boilerplate to easily begin creating an application, but first, we'll need to install it. This can be done by grabbing the latest version of it by cloning the Boilerplate repo directly:</p>

      <pre lang="shell"><code>$ git clone git://github.com/tbranyen/backbone-boilerplate.git
      </code></pre>

      <p>or alternatively, just fetching the latest tarball as follows:</p>

      <pre lang="shell"><code>$ curl -C - -O https://github.com/tbranyen/backbone-boilerplate/zipball/master
      </code></pre>

      <h3>
      <a name="user-content-grunt-bbb" class="anchor" href="#grunt-bbb"><span class="octicon octicon-link"></span></a>Grunt-BBB</h3>

      <p>As Tim covers in the Boilerplate docs, we have to install <a href="http://gruntjs.com">Grunt</a> if we want to use the build tools and grunt-bbb helpers he recommends.</p>

      <p>Grunt is an excellent Node-based JavaScript build tool by another <a href="http://bocoup.com">Bocoup</a> developer (<a href="http://benalman.com">Ben Alman</a>). Think of it as similar to <a href="http://ant.apache.org/">Ant</a> or <a href="https://github.com/jimweirich/rake">Rake</a>. The grunt-bbb helper is also useful to have as it provides several Backbone-specific utilities for scaffolding out your project, without the need to write boilerplate yourself.</p>

      <p>To install grunt and grunt-bbb via NPM:</p>

      <pre lang="shell"><code># first run
      $ npm install -g grunt

      # followed by
      $ npm install -g bbb

      # finally create a new project
      $ bbb init
      </code></pre>

      <p>That's it. We should now be good to go.</p>

      <p>A typical workflow for using grunt-bbb, which we can use later on is:</p>

      <ul>
      <li>Initialize a new project (<code>bbb init</code>)</li>
      <li>Add new modules and templates (<code>bbb init:module</code>)</li>
      <li>Develop using the built in server (<code>bbb server</code>)</li>
      <li>Run the build tool (<code>bbb build</code>)</li>
      <li>Deploy and map to production assets (using <code>bbb release</code>)</li>
      </ul><h2>
      <a name="user-content-creating-a-new-project" class="anchor" href="#creating-a-new-project"><span class="octicon octicon-link"></span></a>Creating a new project</h2>

      <p>Let's create a new folder for our project and run <code>bbb init</code> to kick things off. If everything has been correctly installed, this will sub out some project directories and files for us. Let's review what is generated.</p>

      <h3>
      <a name="user-content-indexhtml" class="anchor" href="#indexhtml"><span class="octicon octicon-link"></span></a>index.html</h3>

      <p>This is a fairly standard stripped-down HTML5 Boilerplate foundation with the notable exception of including <a href="http://requirejs.org">RequireJS</a> at the bottom of the page.</p>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;title&gt;</span>Backbone Boilerplate<span class="nt">&lt;/title&gt;</span>

        <span class="c">&lt;!-- Application styles. --&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/assets/css/index.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>

      <span class="nt">&lt;body&gt;</span>
        <span class="c">&lt;!-- Main container. --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;&lt;/div&gt;</span>

        <span class="c">&lt;!-- Application source. --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">data-main=</span><span class="s">"/app/config"</span> <span class="na">src=</span><span class="s">"/assets/js/libs/require.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>RequireJS is an <a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD</a> (Asynchronous Module Definition) module and script loader, which will assist us with managing the modules in our application. We'll be covering it in a lot more detail later on in the book, but for now, let's cover at a high-level what this particular block does:</p>

      <pre><code>&lt;script data-main="app/config" src="/assets/js/libs/require.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>The <code>data-main</code> attribute is used to inform RequireJS to load <code>app/config.js</code> (a configuration object) after it has finished loading itself. You'll notice that we've omitted the <code>.js</code> extension here as RequireJS can automatically add this for us, however it will respect your paths if we do choose to include it regardless. Let's now look at the config file being referenced.</p>

      <h3>
      <a name="user-content-configjs" class="anchor" href="#configjs"><span class="octicon octicon-link"></span></a>config.js</h3>

      <p>A RequireJS configuration object allows us to specify aliases and paths for dependencies we're likely to reference often (e.g jQuery), bootstrap properties like our base application URL and <code>shim</code> libraries that don't support AMD natively.</p>

      <p>This is what the config file in Backbone Boilerplate looks like:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Set the RequireJS configuration for your application.</span>
      <span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>

        <span class="c1">// Initialize the application with the main application file.</span>
        <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'main'</span><span class="p">],</span>

        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>

        <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <p>The first option defined in the above config is <code>deps: ['main']</code>. This informs RequireJS to load up our main.js file, which is considered the entry point for our application. You may notice that we haven't specified any other path information for <code>main</code>.</p>

      <p>This is because as we haven't overridden the path to our scripts using the <code>baseUrl</code> option, Require will infer this using the path from our <code>data-main</code> attribute in index.html. In other words, our <code>baseUrl</code> is <code>app/</code> and any scripts we require will be loaded relative to this location.</p>

      <p>The next block is <code>paths</code>, which we can use to specify paths relative to the <code>baseUrl</code> as well as the paths/aliases to dependencies we're likely to regularly reference.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>
      </pre></div>

      <p>Next we have the <code>shim</code> config:</p>

      <div class="highlight highlight-javascript"><pre>  <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>
      </pre></div>

      <p><code>shim</code> is an important part of our RequireJS configuration which allows us to load libraries which are not AMD compliant. The basic idea here is that rather than requiring all libraries to implement support for AMD, the <code>shim</code> takes care of the hard work for us.</p>

      <p>For example, in the block below, we state that Backbone.js is dependent on Lodash (a fork of Underscore.js) and jQuery being loaded before it. Once they've been loaded, we then use the global export <code>Backbone</code> as the module value.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">}</span>
      </pre></div>

      <p>Finally, we inform RequireJS that the Backbone <a href="https://github.com/tbranyen/backbone.layoutmanager">LayoutManager</a> plugin (a template and layout manager, also included) requires that Backbone be loaded before it should be.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
      </pre></div>

      <p>This entire setup ensures that our scripts correctly get loaded in the order in which we expect.</p>

      <h3>
      <a name="user-content-mainjs" class="anchor" href="#mainjs"><span class="octicon octicon-link"></span></a>main.js</h3>

      <p>Next, we have <code>main.js</code>, which defines the entry point for our application. We use a global <code>require()</code> method to load an array any other scripts needed, such as our application <code>app.js</code> and our main router <code>router.js</code>. Note that most of the time, we will only use <code>require()</code> for bootstrapping an application and a similar method called <code>define()</code> for all other purposes.</p>

      <p>The function defined after our array of dependencies is a callback which doesn't fire until these scripts have loaded. Notice how we're able to locally alias references to "app" and "router" as <code>app</code> and <code>Router</code> for convenience.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Main Router.</span>
        <span class="s1">'router'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Define your master router on the application namespace and trigger all</span>
        <span class="c1">// navigation from this instance.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>

        <span class="c1">// Trigger the initial route and enable HTML5 History API support, set the</span>
        <span class="c1">// root folder to '/' by default.  Change in app.js.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span> <span class="nx">pushState</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">root</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="p">});</span>

        <span class="c1">// All navigation that is relative should be passed through the navigate</span>
        <span class="c1">// method, to be processed by the router. If the link has a `data-bypass`</span>
        <span class="c1">// attribute, bypass the delegation completely.</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'a:not([data-bypass])'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Get the absolute anchor href.</span>
          <span class="kd">var</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">);</span>

          <span class="c1">// If the href exists and is a hash route, run it through Backbone.</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">href</span> <span class="o">&amp;&amp;</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Stop the default event to ensure the link will not cause a page</span>
            <span class="c1">// refresh.</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

            <span class="c1">// `Backbone.history.navigate` is sufficient for all Routers and will</span>
            <span class="c1">// trigger the correct events. The Router's internal `navigate` method</span>
            <span class="c1">// calls this anyways.  The fragment is sliced from the root.</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>Inline, Backbone Boilerplate includes boilerplate code for initializing our router with HTML5 History API support and handling other navigation scenarios, so we don't have to.</p>

      <h3>
      <a name="user-content-appjs" class="anchor" href="#appjs"><span class="octicon octicon-link"></span></a>app.js</h3>

      <p>Let us now look at our <code>app.js</code> module. Typically, in non-Backbone Boilerplate applications, an <code>app.js</code> file may contain the core logic or module references needed to kick start an app.</p>

      <p>In this case however, this file is used to define templating and layout configuration options as well as utilities for consuming layouts. To a beginner, this might look like a lot of code to comprehend, but the good news is that for basic apps, you're unlikely to need to heavily modify this. Instead, you'll be more concerned with modules for your app, which we'll look at next.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>

        <span class="c1">// Libraries.</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'lodash'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins.</span>
        <span class="s1">'plugins/backbone.layoutmanager'</span>

      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Provide a global location to place configuration settings and module</span>
        <span class="c1">// creation.</span>
        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
          <span class="c1">// The root path to run the application.</span>
          <span class="nx">root</span><span class="o">:</span> <span class="s1">'/'</span>
        <span class="p">};</span>

        <span class="c1">// Localize or create a new JavaScript Template object.</span>
        <span class="kd">var</span> <span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Configure LayoutManager with Backbone Boilerplate defaults.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutManager</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">layout</span><span class="o">:</span> <span class="s1">'app/templates/layouts/'</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="s1">'app/templates/'</span>
          <span class="p">},</span>

          <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">'.html'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Mix Backbone.Events, modules, and layout management into the app object.</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">{</span>
          <span class="c1">// Create a custom object with a nested Views object.</span>
          <span class="nx">module</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">additionalProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">Views</span><span class="o">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="nx">additionalProps</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Helper for using layouts.</span>
          <span class="nx">useLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If already using this Layout, then don't re-inject into the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">===</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// If a layout already exists, remove it from the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">// Create a new Layout.</span>
            <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Layout</span><span class="p">({</span>
              <span class="nx">template</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">className</span><span class="o">:</span> <span class="s1">'layout '</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="s1">'layout'</span>
            <span class="p">});</span>

            <span class="c1">// Insert into the DOM.</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">).</span><span class="nx">empty</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">layout</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>

            <span class="c1">// Render the layout.</span>
            <span class="nx">layout</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">// Cache the reference.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="nx">layout</span><span class="p">;</span>

            <span class="c1">// Return the reference, for chainability.</span>
            <span class="k">return</span> <span class="nx">layout</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-creating-backbone-boilerplate-modules" class="anchor" href="#creating-backbone-boilerplate-modules"><span class="octicon octicon-link"></span></a>Creating Backbone Boilerplate Modules</h3>

      <p>Not to be confused with simply being just an AMD module, a Backbone Boilerplate <code>module</code> is a script composed of a:</p>

      <ul>
      <li>Model</li>
      <li>Collection</li>
      <li>Views (optional)</li>
      </ul><p>We can easily create a new Boilerplate module using <code>grunt-bbb</code> once again using <code>init</code>:</p>

      <pre lang="shell"><code># Create a new module
      $ bbb init:module

      # Grunt prompt
      Please answer the following:
      [?] Module Name foo
      [?] Do you need to make any changes to the above before continuing? (y/N) n

      Writing app/modules/foo.js...OK

      Initialized from template "module".
      </code></pre>

      <p>This will generate a module <code>foo.js</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>

      </pre></div>

      <p>Notice how boilerplate code for our model and collection has already been written for us, as well as code for consuming the layout utilities defined in <code>app.js</code>.</p>

      <p>Now, you may be wondering where or how Views fit into this setup. Although Backbone Boilerplate doesn't include Views in its generated modules by default, we can easily add them ourselves as needed.</p>

      <p>e.g:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Views</span>
        <span class="s1">'modules/foo/views'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>Optionally, we may also wish to include references to plugins such as the Backbone LocalStorage or Offline adapters. One clean way of including a plugin in the above boilerplate could be:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins</span>
        <span class="s1">'plugins/backbone-localstorage'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span>

          <span class="c1">// Save all of the items under the `"foo"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'foo-backbone'</span><span class="p">),</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>You may have spotted that in our module sample we're using the plural, "Views", rather than just View. This is because a View module can contain references to as many Views as needed. In the above, our <code>/modules/foo/views.js</code> file may look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">Views</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/bar'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Baz</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/baz'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

         <span class="k">return</span> <span class="nx">Views</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>Where the <code>template</code> references in our Views, correspond to files in the <code>app/templates</code> directory. e.g <code>foo/bar</code> is located at <code>app/templates/foo/bar.html</code> and is a HTML template that can contain Lodash/Underscore.js Micro-templating logic.</p>

      <h3>
      <a name="user-content-routerjs" class="anchor" href="#routerjs"><span class="octicon octicon-link"></span></a>router.js</h3>

      <p>Finally, let's look at our application router, used for handling navigation. The default router Backbone Boilerplate generates for us inclues sane defaults for no routes being specified.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="p">}</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p>If however we would like to execute some module-specific logic, when the page loads (i.e when a user hits the default route), we can pull in a module as a dependency and optionally use the Backbone LayoutManager to attach Views to our layout as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Modules</span>
        <span class="s1">'modules/foo'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Foo</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="c1">// Create a new Collection</span>
                  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

                  <span class="c1">// Use and configure a 'main' layout</span>
                  <span class="nx">app</span><span class="p">.</span><span class="nx">useLayout</span><span class="p">(</span><span class="s1">'main'</span><span class="p">).</span><span class="nx">setViews</span><span class="p">({</span>
                          <span class="c1">// Attach the bar View into the content View</span>
                          <span class="s1">'.bar'</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span><span class="p">({</span>
                                  <span class="nx">collection</span><span class="o">:</span> <span class="nx">collection</span>
                          <span class="p">})</span>
                   <span class="p">}).</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Fetch data (e.g from localStorage)</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-conclusions-1" class="anchor" href="#conclusions-1"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>In this section we reviewed Backbone Boilerplate and learned how to use the BBB tool to help us scaffold out our application.</p>

      <p>If you would like to learn more about how this project helps structure your app, BBB includes some built-in boilerplate sample apps that can be easily generated for review.</p>

      <p>These include a boilerplate tutorial project (<code>bbb init:tutorial</code>) and an implementation of my <a href="http://todomvc">TodoMVC</a> project (<code>bbb init:todomvc</code>). I recommend checking these out as they'll provide you with a more complete picture of how Backbone Boilerplate, its templates and so on fit into the overall setup for a web app.</p>

      <p>For more about Grunt-BBB, remember to take a look at the official project <a href="https://github.com/backbone-boilerplate/grunt-bbb">repository</a>. There is also a related <a href="https://dl.dropbox.com/u/79007/talks/Modern_Web_Applications/slides/index.html">slide-deck</a> available for those interested in reading more.</p>

      <h2>
      <a name="user-content-related-tools--projects" class="anchor" href="#related-tools--projects"><span class="octicon octicon-link"></span></a>Related Tools &amp; Projects</h2>

      <p>As we've seen, scaffolding tools can assist in expediting how quickly you can begin a new application by creating the basic files required for a project automatically. If you appreciate such tools, I'm happy to also recommend checking out <a href="http://yeoman.io">Yeoman</a> (one of my upcoming projects) and <a href="https://github.com/brunch/brunch">Brunch</a>.</p>

      <p>Brunch works very well with Backbone, Underscore, jQuery and CoffeeScript and is even used by companies such as Red Bull and Jim Beam. You may have to update any third party dependencies (e.g. latest jQuery or Zepto) when using it, but other than that it should be fairly stable to use right out of the box.</p>

      <p>Brunch can be installed via the nodejs package manager and is easy to get started with. If you happen to use Vim or Textmate as your editor of choice, you'll be happy to know that there are Brunch bundles available for both.</p>

      <h1>
      <a name="user-content-common-problems--solutions" class="anchor" href="#common-problems--solutions"><span class="octicon octicon-link"></span></a>Common Problems &amp; Solutions</h1>

      <p>In this section, we will review a number of common problems developers often experience once they've started to work on relatively non-trivial projects using Backbone.js, as well as present potential solutions.</p>

      <p>Perhaps the most frequent of these questions surround how to do more with Views. If you are interested in discovering how to work with nested Views, learn about view disposal and inheritance, this section will hopefully have you covered.</p>

      <h4>
      <a name="user-content-nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs" class="anchor" href="#nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs"><span class="octicon octicon-link"></span></a>Nesting: What is the best approach for rendering and appending Sub-Views in Backbone.js?</h4>

      <p>Nesting is generally considered a good way to maintain hierarchal views for writing maintainable code. As a beginner, one might try writing a very simple setup with sub-views (e.g inner views) as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Where we have previously defined a View, SubView</span>
      <span class="c1">// in a parent View we could do:</span>

      <span class="p">...</span>
      <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">());</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre></div>

      <p>This works in that one doesn't need to worry about maintaining the order of your DOM elements when appending. Views are initialized early and the render() method doesn't need to take on too many responsibilities at once. Unfortunately, a downside is that you don't have the ability to set the <code>tagName</code> of elements and events need to be re-delegated.</p>

      <p>An alternative approach which doesn't suffer from the re-delegation problem could be written as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>


          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
      <span class="p">}</span>

      </pre></div>

      <p>In this version, we also don't require a template containing empty placeholders and the issue with <code>tagName</code>s is solved as they are defined by the view once again.</p>

      <p>Yet another variation which moves logic into an <code>onRender</code> event, could be written with only a few subtle changes:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'render'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRender</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// more logic</span>

          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'render'</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you find yourself nesting views in your application, there are more optimal approaches possible for initializing, rendering and appending your sub-views. One such solution could be written:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">delegateEvents</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      </pre></div>

      <p>This tackles a few specific design decisions:</p>

      <ul>
      <li>The order in which you append the sub-elements matters</li>
      <li>The OuterView doesn't contain the HTML elements to be set in the InnerView(s), meaning that we can still specify tagName in the InnerView</li>
      <li>render() is called after the InnerView element has been placed into the DOM. This is useful if your InnerView's render() method is sizing itself on the page based on the dimensions of another element. This is a common use case.</li>
      </ul><p>A second potential solution is this, which may appear cleaner but in reality has a tendency to affect performance:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Generally speaking, more developers opt for the first solution as:</p>

      <ul>
      <li>The majority of their views may already rely on being in the DOM in their render() method</li>
      <li>When the OuterView is re-rendered, views don't have to be re-initialized where re-initialization has the potential to cause memory leaks and issues with existing bindings</li>
      </ul><p>(Thanks to <a href="http://stackoverflow.com/users/299189/lukas">Lukas</a>  and <a href="http://stackoverflow.com/users/154765/ian-storm-taylor">Ian Taylor</a> for these tips).</p>

      <h4>
      <a name="user-content-what-is-the-best-way-to-manage-models-in-nested-views" class="anchor" href="#what-is-the-best-way-to-manage-models-in-nested-views"><span class="octicon octicon-link"></span></a>What is the best way to manage models in nested Views?</h4>

      <p>In order to reach attributes on related models in a nested setup, the models involved need to have some prior knowledge about which models this refers to. Backbone.js doesn't implicitly handle relations or nesting, meaning it's up to us to ensure models have a knowledge of each other.</p>

      <p>One approach is to make sure each child model has a 'parent' attribute. This way you can traverse the nesting first up to the parent and then down to any siblings that you know of. So, assuming we have models modelA, modelB and modelC:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// When initializing modelA, I would suggest setting a link to the parent</span>
      <span class="c1">// model when doing this, like this:</span>

      <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelB</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelC</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>This allows you to reach the parent model in any child model function by calling this.parent.</p>

      <p>When you have a need to nest Backbone.js views, you might find it easier to let each view represent a single HTML tag using the tagName option of the View. This may be written as:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">ViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'div'</span><span class="p">,</span>
          <span class="nx">id</span><span class="o">:</span> <span class="s1">'new'</span><span class="p">,</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewB</span><span class="p">();</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">parentView</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
             <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">ViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'h1'</span><span class="p">,</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'Header text'</span><span class="p">);</span> <span class="c1">// or use this.options.headerText or equivalent</span>
          <span class="p">},</span>

          <span class="nx">funcB1</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">doSomethingOnParent</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">doSomethingOnSibling</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parentView</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">shakeViolently</span><span class="p">();</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <p>Then in your application initialization code , you would initiate ViewA and place its element inside the body element.</p>

      <p>An alternative approach is to use an extension called <a href="https://github.com/powmedia/backbone-forms">Backbone-Forms</a>. Using a similar schema to what we wrote earlier, nesting could be achieved as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ModelB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeB1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeB2</span><span class="o">:</span> <span class="s1">'Text'</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelC</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeC</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeA1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeA2</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">refToModelB</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelB</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateB'</span> <span class="p">},</span>
              <span class="nx">refToModelC</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelC</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateC'</span> <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>There is more information about this technique available on <a href="https://github.com/powmedia/backbone-forms#customising-templates">GitHub</a>.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/100952/jens-alm">Jens Alm</a> and <a href="http://stackoverflow.com/users/801466/artem-oboturov">Artem Oboturov</a> for these tips)</p>

      <h4>
      <a name="user-content-is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views" class="anchor" href="#is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views"><span class="octicon octicon-link"></span></a>Is it possible to have one Backbone.js View trigger updates in other Views?</h4>

      <p>The Mediator pattern is an excellent option for implementing a solution to this problem.</p>

      <p>Without going into too much detail about the pattern, it can effectively be used an event manager that lets you to subscribe to and publish events. So an ApplicationViewA could subscribe to an event, i.e. 'selected' and then the ApplicationViewB would publish the 'selected' event.</p>

      <p>The reason I like this is it allows you to send events between views, without the views being directly bound together.</p>

      <p>For Example:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// See http://addyosmani.com/largescalejavascript/#mediatorpattern</span>
      <span class="c1">// for an implementation or alternatively for a more thorough one</span>
      <span class="c1">// http://thejacklawson.com/Mediator.js/</span>

      <span class="kd">var</span> <span class="nx">mediator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mediator</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">toggle_select</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="p">...</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">);</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">delete_selected</span><span class="p">)</span>
          <span class="p">},</span>

          <span class="nx">delete_selected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">)</span> <span class="p">{</span>
              <span class="p">...</span> <span class="k">do</span> <span class="nx">something</span> <span class="p">...</span>
          <span class="p">},</span>
      <span class="p">});</span>
      </pre></div>

      <p>This way your ApplicationViewA doesn't care if it is an ApplicationViewB or FooView that publishes the 'selected' event, only that the event occurred. As a result, you may find it a maintainable way to manage events between parts of your application, not just views.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/937577/john-mckim">John McKim</a> for this tip and for referencing my Large Scale JavaScript Patterns article).</p>

      <h4>
      <a name="user-content-how-would-one-render-a-parent-view-from-one-of-its-children" class="anchor" href="#how-would-one-render-a-parent-view-from-one-of-its-children"><span class="octicon octicon-link"></span></a>How would one render a Parent View from one of its Children?</h4>

      <p>If you say, have a view which contains another view (e.g a main view containing a modal view) and  would like to render or re-render the parent view from the child, this is extremely straight-forward.</p>

      <p>In such a scenario, you would most likely want to execute the rendering when a particular event has occurred. For the sake of example, let us call this event 'somethingHappened'. The parent view can bind notifications on the child view to know when the event has occurred. It can then render itself.</p>

      <p>On the parent view:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Parent initialize</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

      <span class="c1">// Parent removal</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      </pre></div>

      <p>On the child view:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// After the event has occurred</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">);</span>

      </pre></div>

      <p>The child will trigger a "somethingHappened" event and the parent's render function will be called.</p>

      <p>(Thanks to Tal <a href="http://stackoverflow.com/users/269666/tal-bereznitskey">Bereznitskey</a> for this tip)</p>

      <h4>
      <a name="user-content-how-do-you-cleanly-dispose-views-to-avoid-memory-leaks" class="anchor" href="#how-do-you-cleanly-dispose-views-to-avoid-memory-leaks"><span class="octicon octicon-link"></span></a>How do you cleanly dispose Views to avoid memory leaks?</h4>

      <p>As your application grows, keeping live views around which aren't being used can quickly become difficult to maintain. Instead, you may find it more optimal to destroy views that are no longer required and simply create new ones as the necessity arises.</p>

      <p>A solution to help with this is to create a BaseView from which the rest of your views inherit from. The idea here is that your view will maintain a reference to all of the events to which its subscribed to so that when it is time to dispose of a view, all of those bindings will be automatically unbound.</p>

      <p>Here is a sample implementation of this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">BaseView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">BaseView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="nx">bindTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

              <span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="o">:</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">unbindFromAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">binding</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>

          <span class="nx">dispose</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbindFromAll</span><span class="p">();</span> <span class="c1">// this will unbind all events that this view has bound to</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span> <span class="c1">// this will unbind all listeners to events from this view. This is probably not necessary because this view will be garbage collected.</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// uses the default Backbone.View.remove() method which removes this.el from the DOM and removes DOM events.</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <div class="highlight highlight-javascript"><pre><span class="nx">BaseView</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>
      </pre></div>

      <p>Then, whenever a view has the need to bind to an event on a model or a collection, you would use the bindTo method. e.g:</p>

      <pre><code>var SampleView = BaseView.extend({

          initialize: function(){
              this.bindTo(this.model, 'change', this.render);
              this.bindTo(this.collection, 'reset', this.doSomething);
          }
      });
      </code></pre>

      <p>When you remove a view, simply call the dispose() method which will clean everything up for you automatically:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">sampleView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SampleView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">some_model</span><span class="p">,</span> <span class="nx">collection</span><span class="o">:</span> <span class="nx">some_collection</span><span class="p">});</span>
      <span class="nx">sampleView</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
      </pre></div>

      <p>(Thanks to <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for this tip).</p>

      <h4>
      <a name="user-content-how-does-one-handle-view-disposal-on-a-parent-or-child-view" class="anchor" href="#how-does-one-handle-view-disposal-on-a-parent-or-child-view"><span class="octicon octicon-link"></span></a>How does one handle View disposal on a Parent or Child View?</h4>

      <p>In the last question, we looked at how to effectively dispose views to decreases memory usage (analogous to a type of garbage collection).</p>

      <p>Where your application is setup with multiple Parent and Child Views, it is also common to desire removing any DOM elements associated with such views as well as unbinding any event handlers tied to child elements when you no longer require them.</p>

      <p>The solution in the last question should be enough to handle this use-case, but if you require a more-explicit example that handles children, we can see one below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">NewView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>
          <span class="nx">renderChildren</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">itemView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewChildView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">item</span> <span class="p">});</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">itemView</span><span class="p">.</span><span class="nx">render</span><span class="p">());</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">itemView</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">onClose</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">view</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">NewChildView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Here, a close() method for views is implemented which disposes of a view when it is no longer needed or needs to be reset. In most cases the view removal should be done at a view layer so that it won't affect any of our models.</p>

      <p>For example, if you are working on a blogging application and you remove a view with comments, perhaps another view in your app shows a selection of comments and resetting the collection would affect those views too.</p>

      <p>(Thanks to <a href="http://stackoverflow.com/users/906136/dira">dira</a> for this tip)</p>

      <h4>
      <a name="user-content-whats-the-best-way-to-combine-or-append-views-to-each-other" class="anchor" href="#whats-the-best-way-to-combine-or-append-views-to-each-other"><span class="octicon octicon-link"></span></a>What's the best way to combine or append Views to each other?</h4>

      <p>Let us say you have a Collection, where each item in the Collection could itself be a Collection. You can render each item in the Collection, and indeed can render any items which themselves are Collections. The problem you might have is how to render this structure where the HTML reflects the hierarchical nature of the data structure.</p>

      <p>The most straight-forward way to approach this problem is to use a framework like Derick Baileys <a href="https://github.com/marionettejs/backbone.marionette">Backbone.Marionette</a>. In this framework is a type of view called a CompositeView.</p>

      <p>The basic idea of a CompositeView is that it can render a model and a collection within the same view.</p>

      <p>It can render a single model with a template. It can also take a collection from that model and for each model in that collection, render a view. By default it uses the same composite view type that you've defined, to render each of the models in the collection. All you have to do is tell the view instance where the collection is, via the initialize method, and you'll get a recursive hierarchy rendered.</p>

      <p>There is a working demo of this in action available <a href="http://jsfiddle.net/derickbailey/AdWjU/">online</a>.</p>

      <p>And you can get the source code and documentation for <a href="https://github.com/marionettejs/backbone.marionette">Marionette</a> too.</p>

      <h4>
      <a name="user-content-better-model-property-validation" class="anchor" href="#better-model-property-validation"><span class="octicon octicon-link"></span></a>Better Model Property Validation</h4>

      <p>As we learned earlier in the book, the <code>validate</code> method on a Model is called before <code>set</code> and <code>save</code>, and is passed the model attributes updated with the values from these methods.</p>

      <p>By default, where we define a custom <code>validate</code> method, Backbone passes all of a Model's attributes through this validation each time, regardless of which model attributes are being set.</p>

      <p>This means that it can be a challenge to determine which specific fields are being set or validated without being concerned about the others that aren't being set at the same time.</p>

      <p>To illustrate this problem better, let us look at a typical registration form use case that:</p>

      <ul>
      <li>Validates form fields using the blur event</li>
      <li>Validates each field regardless of whether other model attributes (aka other form data) are valid or not.</li>
      </ul><p>Here is one example of a desired use case:</p>

      <p>We have a form where a user focuses and blurs first name, last name, and email HTML input boxes without entering any data. A "this field is required" message should be presented next to each form field.</p>

      <p>HTML:</p>

      <pre><code>&lt;!doctype html&gt;
      &lt;html&gt;
      &lt;head&gt;
        &lt;meta charset=utf-8&gt;
        &lt;title&gt;Form Validation - Model#validate&lt;/title&gt;
        &lt;script src='http://code.jquery.com/jquery.js'&gt;&lt;/script&gt;
        &lt;script src='http://underscorejs.org/underscore.js'&gt;&lt;/script&gt;
        &lt;script src='http://backbonejs.org/backbone.js'&gt;&lt;/script&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;form&gt;
          &lt;label&gt;First Name&lt;/label&gt;
          &lt;input name='firstname'&gt;
          &lt;span data-msg='firstname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Last Name&lt;/label&gt;
          &lt;input name='lastname'&gt;
          &lt;span data-msg='lastname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Email&lt;/label&gt;
          &lt;input name='email'&gt;
          &lt;span data-msg='email'&gt;&lt;/span&gt;
        &lt;/form&gt;
      &lt;/body&gt;
      &lt;/html&gt;
      </code></pre>

      <p>Some simple validation that could be written using the current Backbone <code>validate</code> method to work with this form could be implemented using something like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'email is empty'</span><span class="p">;</span>

      <span class="p">}</span>
      </pre></div>

      <p>Unfortunately, this method would trigger a first name error each time any of the fields were blurred and only an error message next to the first name field would be presented.</p>

      <p>One potential solution to the problem could be to validate all fields and return all of the errors:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is empty'</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>

      <p>This can be adapted into a complete solution that defines a Field model for each input in our form and works within the parameters of our use-case as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is required'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Field</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span><span class="nx">blur</span><span class="o">:</span> <span class="s1">'validate'</span><span class="p">},</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'[data-msg='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">val</span><span class="p">());</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">new</span> <span class="nx">Field</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">user</span><span class="p">});</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>This works great as the solution checks the validation for each attribute individually and sets the message for the correct blurred field. A <a href="http://jsbin.com/afetez/2/edit">demo</a> of the above by <a href="http://github.com/braddunbar">@braddunbar</a> is also available.</p>

      <p>It unfortunately however forces us to validate all of your form fields every time.
      If we have multiple client-side validation methods with our particular use case, we may not want to have to call each validation method on every attribute every time, so this solution might not be ideal for everyone.</p>

      <p>A potentially better alternative to the above is to use <a href="http://github.com/@franko">@gfranko</a>'s <a href="https://github.com/gfranko/Backbone.validateAll">Backbone.validateAll</a> plugin, specifically created to validate specific Model properties (or form fields) without worrying about the validation of any other Model properties (or form fields).</p>

      <p>Here is how we would setup a partial User Model and validate method using this plugin, that caters to our use-case:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Create a new User Model</span>
      <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="c1">// RegEx Patterns</span>
            <span class="nx">patterns</span><span class="o">:</span> <span class="p">{</span>

                <span class="nx">specialCharacters</span><span class="o">:</span> <span class="s1">'[^a-zA-Z 0-9]+'</span><span class="p">,</span>

                <span class="nx">digits</span><span class="o">:</span> <span class="s1">'[0-9]'</span><span class="p">,</span>

                <span class="nx">email</span><span class="o">:</span> <span class="s1">'^[a-zA-Z0-9._-]+@[a-zA-Z0-9][a-zA-Z0-9.-]*[.]{1}[a-zA-Z]{2,6}$'</span>
            <span class="p">},</span>

          <span class="c1">// Validators</span>
            <span class="nx">validators</span><span class="o">:</span> <span class="p">{</span>

            <span class="nx">minLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">minLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">minLength</span><span class="p">;</span>

                <span class="p">},</span>

                <span class="nx">maxLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">maxLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">maxLength</span><span class="p">;</span>

                <span class="p">},</span>

                 <span class="nx">isEmail</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>

                <span class="p">},</span>

                <span class="nx">hasSpecialCharacter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">specialCharacters</span><span class="p">);</span>

                <span class="p">},</span>
               <span class="p">...</span>

          <span class="c1">// We can determine which properties are getting validated by</span>
          <span class="c1">// checking to see if properties are equal to null</span>

              <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname cannot contain special characters'</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'last name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname cannot contain special characters'</span><span class="p">;</span>

                <span class="p">}</span>
      </pre></div>

      <p>This allows the logic inside of our validate methods to determine which form fields are currently being set/validated, and does not care about the other model properties that are not trying to be set.</p>

      <p>It's fairly straight-forward to use as well. We can simply define a new Model instance and then set the data on our model using the <code>validateAll</code> option to use the behavior defined by the plugin:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="s1">'firstname'</span><span class="o">:</span> <span class="s1">'Greg'</span> <span class="p">},</span> <span class="p">{</span><span class="nx">validateAll</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

      </pre></div>

      <p>That's it!.</p>

      <p>The Backbone.validateAll logic doesn't override the default Backbone logic by default and so it's perfectly capable of being used for scenarios where you might care more about field-validation <a href="http://jsperf.com/backbone-validateall">performance</a> as well as those where you don't. Both solutions presented in this section should work fine however.</p>

      <h1>
      <a name="user-content-restful-applications" class="anchor" href="#restful-applications"><span class="octicon octicon-link"></span></a>RESTful Applications</h1>

      <h2>
      <a name="user-content-building-restful-applications-with-backbone" class="anchor" href="#building-restful-applications-with-backbone"><span class="octicon octicon-link"></span></a>Building RESTful applications with Backbone</h2>

      <p>In this section of the book, we're going to take a look at developing RESTful applications using Backbone.js and modern technology stacks. When the data for your back-end is exposed through a purely RESTful API, tasks such as retrieving (GET), creating (POST), updating (PUT) and deleting (DELETE) models are made easy through Backbone's Model API. This API is so intuitive in fact that switching from storing records in a local data-store (e.g localStorage) to a database/noSQL data-store is a lot simpler than you may think.</p>

      <h2>
      <a name="user-content-stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb" class="anchor" href="#stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb"><span class="octicon octicon-link"></span></a>Stack 1: Building A Backbone App With Node.js, Express, Mongoose and MongoDB</h2>

      <p>The first stack we'll be looking at is:</p>

      <ul>
      <li><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/nodejs.org">Node.js</a></li>
      <li><a href="http://expressjs.com/">Express</a></li>
      <li><a href="http://mongoosejs.com/">Mongoose</a></li>
      <li>and <a href="http://www.mongodb.org/">MongoDB</a>
      </li>
      </ul><p>with <a href="http://jade-lang.com/">Jade</a> used optionally as a view/templating engine.</p>

      <h3>
      <a name="user-content-reviewing-the-stack" class="anchor" href="#reviewing-the-stack"><span class="octicon octicon-link"></span></a>Reviewing the stack</h3>

      <p>As you may know, node.js is an event-driven platform (built on the <a href="http://code.google.com/apis/v8/design.html">V8</a> runtime), designed for writing fast, scalable network applications. It's reasonably lightweight, efficient and great for real-time applications that are data-intensive.</p>

      <p>Express is a small web-development framework written with node.js, based on <a href="http://www.sinatrarb.com/">Sinatra</a>. It supports a number of useful features such as intuitive views, robust routing and a focus on high performance.</p>

      <p>Next on the list are MongoDB and Mongoose. MongoDB is an open-source, document-oriented database store designed with scalability and agility in mind. As a <a href="http://en.wikipedia.org/wiki/NoSQL">noSQL</a> database, rather than storing data in tables and rows (something we're very used to doing with relational databases), with MongoDB we instead store JSON-like documents using dynamic schemas. One of the goals of Mongo is to try bridging the gap between key-value stores (speed, scalability) and <a href="http://en.wikipedia.org/wiki/Relational_database">relational</a> databases (rich functionality).</p>

      <p>Mongoose is a JavaScript library that simplifies how we interact with Mongo. Like Express, it's designed to work within the node.js environment and tries to solve some of the complexities with asynchronous data storage by offering a more user-friendly API. It also adds chaining features into the mix, allowing for a slightly more expressive way of dealing with our data.</p>

      <p>Jade is a template engine influenced by Haml (which we'll be looking at later). It's implemented with JavaScript (and also runs under node). In addition to supporting Express out of the box, it boasts a number of useful features including support for mixins, includes, caching, template inheritance and much more. Whilst abstractions like Jade certainly aren't for everyone, our practical will cover working both with and without it.</p>

      <h3>
      <a name="user-content-practical" class="anchor" href="#practical"><span class="octicon octicon-link"></span></a>Practical</h3>

      <p>For this practical, we're going to once again look at extending the popular Backbone Todo application. Rather than relying on localStorage for data persistence, we're going to switch to storing Todos in a MongoDB document-store instead. The code for this practical can be found in <code>practicals\stacks\option2</code></p>

      <p><strong>app.js</strong></p>

      <p>(See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/app.js">here</a> for the source)</p>

      <p>We must first include the node dependencies required by our application. These are Express, Mongoose and Path (a module containing utilities for dealing with file paths).</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">application_root</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">,</span>
        <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">),</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">),</span>
        <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
      </pre></div>

      <p>Next, create a new Express server. <code>express()</code> is a simple way of creating an instance of express.HTTPServer, which we'll be using to pass in our routes.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
      </pre></div>

      <p>After this, connect Mongoose up to a database (in our case, localhost should suffice). Should you require the ability to pass in authentication information, here's a sample containing all of the supported URL parameters: <code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</code></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://localhost/my_database'</span><span class="p">);</span>
      </pre></div>

      <p>A Mongoose model for any Todo item can now be easily defined by passing a schema instance to <code>mongoose.model</code>. In our case the schema covers a Todo item's <code>text</code> content, its <code>done</code> state and <code>order</code> position in the overall Todo list.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Todo'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
        <span class="nx">text</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="nx">done</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span>
        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
      <span class="p">}));</span>
      </pre></div>

      <p>The <code>configure()</code> methods allows us to setup what we need for the current environment with our Express server. Note that lower down in the configuration are two view/view related lines. The last one explicitly sets the viewing/templating engine to be used as Jade <code>app.set('view engine', 'jade')</code>. We can avoid these if we wish to use plain HTML/JS for our templates instead.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// the bodyParser middleware parses JSON request bodies</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">)</span>
      <span class="p">});</span>

      </pre></div>

      <p>Should you prefer to switch out Jade for an alternative view engine, this can be done fairly trivially. See the section under 'Templating' here:
      <a href="https://github.com/joyent/node/wiki/modules">https://github.com/joyent/node/wiki/modules</a>. For example, to switch to EJS, you would simply write <code>app.set('view engine', 'ejs')</code></p>

      <p>Express makes use of common HTTP verbs (get, put, post etc.) to provide easy to use, expressive routing API based on CRUD (Create, Read, Update and Delete). Below for example, we can define what happens when the browser requests the root '/'. As a trivial route in this application, it doesn't do anything particularly exciting, however getters typically read or retrieve data.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Onto something a little more useful and in our next route, navigating to '/todo' will actually render our Jade view 'todo.jade', as seen in the callback. Additional configuration values can be passed as the second parameter, such as the custom title specified below.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'todo'</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">'Our sample application'</span><span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Next, we can see the first of our '/api/' routes.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todos</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>The callback to our next route supports querying for todos based on a specific ID. The route string itself (once compiled) will be converted from '/api/todos/:id' to a regular expression. As you might have guessed, this is a hint that routes can also be regular expression literals if we wished to do something more complex.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Similarly, we want to support updating todos based on a specific ID as well. The following allows us to query a todo by ID and then update the values of its three attributes (text, done, order) easily.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updated'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>We've so far covered requesting todos and updating them, but a core part of the application requires us to insert (or add) new todos to our data-store. Below we can create new <code>Todo</code> models and simply save them.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">todo</span><span class="p">;</span>
        <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
          <span class="nx">text</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
          <span class="nx">done</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span>
          <span class="nx">order</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span>
        <span class="p">});</span>
        <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>We of course also want to support deleting todos (e.g if a todo has been 'cleared', it should be deleted). This also works based on a specific todo ID.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Finally, this last line is to ensure we're only listening on the port app.js is running.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
      </pre></div>

      <p><strong>script.js - updating our Backbone.js app</strong></p>

      <p>In the <code>/public/js</code> folder of options 1 (HTML templates) and 2 (Jade) for the practical, you'll find a version of the Backbone Todo app originally by Jerome Gravel-Niquet. Let's pay attention to <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/public/js/script.js">script.js</a>. In order to change the application to work with our new back-end, we'll need to make some very minor changes to this.</p>

      <p>Reviewing <code>window.TodoList</code> (a Backbone Collection), you'll notice that it has a property called <code>localStorage</code>, which uses the Backbone <a href="https://github.com/jeromegn/Backbone.localStorage">localStorage</a> adapter in order to facilitate storing data using the browser's localStorage features.</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// Typically, this should be a unique name within your application</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>
      </pre></div>

      <p>In order to switch it over to our RESTful backend, we're going to make use of the <code>url</code> property or function on a collection to reference its location on the server. Models inside of a collection then use <code>url</code> to construct URLs of their own. As all of the CRUD for our RESTful API works on the base route '/api/todos', this is the value we set <code>url</code> to.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>
      </pre></div>

      <p>This is the only change necessary to our existing Backbone application in order to get things working. Pretty easy, right?</p>

      <p><strong>todo.jade</strong></p>

      <p>The Jade templates for our application cover declarative markup for both the index (layout.jade) of the application and the main Todo container (todo.jade). It also covers the script-tag templates used for rendering each new Todo item that's added.</p>

      <div class="highlight highlight-html"><pre>// Todo App Interface

      #todoapp
        .title
          h1 Todos
        .content
          #create-todo
            input#new-todo(placeholder="What needs to be done?", type="text")
            span.ui-tooltip-top(style="display:none;") Press Enter to save this task
          #todos
            ul#todo-list
          #todo-stats


      // Templates
      script#item-template(type="text/template")
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        .display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          .todo-text
          span#todo-destroy
        .edit
          input.todo-input(type="text", "value"="")
        <span class="nt">&lt;/div&gt;</span>

      script#stats-template(type="text/template")
        <span class="err">&lt;</span>% if (total) { %&gt;
        span.todo-count
          span.number <span class="err">&lt;</span>%= remaining %&gt;
          span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          |  left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        span.todo-clear
          a(href="#")
            |  Clear
            span.number-done <span class="err">&lt;</span>%= done %&gt;
            |  completed
            span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre></div>

      <p><strong>layout.jade</strong></p>

      <div class="highlight highlight-html"><pre>head
        meta(charset="utf-8")
        meta(http-equiv="X-UA-Compatible", content="IE=edge,chrome=1")

        title=title
        meta(name="description", content="")
        meta(name="author", content="")
        meta(name="viewport", content="width=device-width,initial-scale=1")

        // CSS concatenated and minified via ant build script
        link(rel="stylesheet", href="css/style.css")
        // end CSS

        script(src="js/libs/modernizr-2.0.6.min.js")
      body

        #container
          header
          #main(role="main")!=body
          footer
        //! end of #container

        script(src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js")
        script
          window.jQuery || document.write('<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/libs/jquery-1.6.2.min.js"</span><span class="nt">&gt;</span><span class="err">&lt;\\/script&gt;')</span>

        // scripts concatenated and minified via ant build script
        script(src="js/mylibs/underscore.js")
        script(src="js/mylibs/backbone.js")
        script(defer, src="js/plugins.js")
        script(defer, src="js/script.js")
        // end scripts

        // Change UA-XXXXX-X to be your site's ID
        script
          window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
          Modernizr.load({load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'});

        //if lt IE 7
          script(src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js")
          script
            window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})
      <span class="nt">&lt;/html&gt;</span>

      </pre></div>

      <p><strong>static.html</strong></p>

      <p>Alternatively, a static version of our index which doesn't rely on Jade can be put together as follows. See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option1/public/static.html">here</a> for the complete file or below for a sample.</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"container"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>

            <span class="c">&lt;!-- Todo App Interface--&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h1&gt;</span>Todos<span class="nt">&lt;/h1&gt;</span>
              <span class="nt">&lt;/div&gt;</span>

              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"create-todo"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">type=</span>
                  "text" /&gt;<span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">class=</span><span class="s">"ui-tooltip-top"</span><span class="nt">&gt;</span>Press Enter to
                  save this task<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todos"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todo-stats"</span><span class="nt">&gt;&lt;/div&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>


          <span class="c">&lt;!-- Templates--&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"item-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"display"</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"check"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">done</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;</span> <span class="err">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-text"</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;span id="todo-destroy"&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class="edit"&gt;&lt;input type="text" value="" class="todo-input"/&gt;&lt;/div&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"stats-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number"</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;</span> <span class="o">&lt;</span><span class="err">/span&gt;&lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.</span>
            <span class="o">&lt;</span><span class="err">/span&gt;&lt;% } %&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-clear"</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span> <span class="nx">Clear</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt; completed</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"word-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">'item'</span> <span class="o">:</span> <span class="s1">'items'</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;% } %&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="c">&lt;!--! end of #container--&gt;</span>
      </pre></div>

      <h3>
      <a name="user-content-practical-setup" class="anchor" href="#practical-setup"><span class="octicon octicon-link"></span></a>Practical Setup</h3>

      <p>We've now gone through the major points of developing a RESTful backend using Node.js, Express and Mongoose. Next, let's make sure you can get your environment setup to run the updated Todo app.</p>

      <h4>
      <a name="user-content-mongodb" class="anchor" href="#mongodb"><span class="octicon octicon-link"></span></a>MongoDB</h4>

      <p>Once you've downloaded <a href="http://www.mongodb.org/downloads">MongoDB</a>, you'll need to complete two steps to get it up and running.</p>

      <p><strong>Data directories</strong></p>

      <p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted MongoDB and run the following from terminal:</p>

      <div class="highlight highlight-html"><pre>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </pre></div>

      <p><strong>Running and connecting to your server</strong></p>

      <p>Once this is done, open up two terminal windows.</p>

      <p>In the first, <code>cd</code> to your MongoDB bin directory or type in the complete path to it. You'll need to start <code>mongod</code>.</p>

      <div class="highlight highlight-html"><pre>$ ./bin/mongod
      </pre></div>

      <p>Next, in the second terminal, start the <code>mongo</code> shell which will connect up to localhost by default.</p>

      <div class="highlight highlight-html"><pre>$ ./bin/mongo
      </pre></div>

      <p>That's it!.</p>

      <h4>
      <a name="user-content-express-and-mongoose" class="anchor" href="#express-and-mongoose"><span class="octicon octicon-link"></span></a>Express and Mongoose</h4>

      <p>Option 1 (HTML) and Option 2 (Jade) of the practical download both come with an install.sh bash script. This allows you to easily install Express, Mongoose, Jade (and optionally MongoDB if you prefer to) through npm (the node package manager).</p>

      <ul>
      <li>Make sure you have Node.js installed. If not, you can grab it <a href="http://nodejs.org/#download">here</a>
      </li>
      <li>Next run <code>$ ./install.sh</code> at the terminal to install the rest of our dependencies. To see the exact contents of the install.sh file, see below:</li>
      </ul><p><strong>install.sh</strong></p>

      <div class="highlight highlight-html"><pre>#!/bin/bash
      npm install express
      npm install mongodb --mongodb:native
      npm install mongoose
      npm install jade
      </pre></div>

      <ul>
      <li>After you've installed all of the dependencies for the stack, we can get to cloning the repo containing our practicals and running them. Start by running the below lines:</li>
      </ul><div class="highlight highlight-html"><pre>git clone git://github.com/addyosmani/backbone-boilerplates.git
      cd option2
      node app.js
      </pre></div>

      <p>For option1 (without Jade), simply cd into option1 and run <code>node app.js</code> from there.</p>

      <p>Finally, either of the example apps can now be accessed by navigating to:</p>

      <ul>
      <li>Option 1: <code>http://localhost:3000/static.html</code>
      </li>
      <li>Option 2: <code>http://localhost:3000/todo</code>
      </li>
      </ul><p>That's it! Whilst there's a lot more than can be done to expand on the concepts covered so far, the base we're reviewed should be enough to get you up and running with this stack if you wish to use it with Backbone.</p>

      <h1>
      <a name="user-content-building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml" class="anchor" href="#building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml"><span class="octicon octicon-link"></span></a>Building Backbone.js Apps With Ruby, Sinatra, MongoDB and Haml</h1>

      <h2>
      <a name="user-content-introduction-1" class="anchor" href="#introduction-1"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>In this chapter we're going to explore writing Backbone.js applications with a Ruby back-end. To assist with this, we're going to use <a href="http://www.sinatrarb.com/">Sinatra</a> - a DSL (domain specific language) for rapidly creating web applications in Ruby. Similar to the <a href="https://github.com/addyosmani/backbone-fundamentals/#stack1">section</a> on writing an application with Node.js, our server-side language (Ruby) will be used to power an API whilst Backbone.js will be the client consuming it.</p>

      <h2>
      <a name="user-content-what-is-sinatra" class="anchor" href="#what-is-sinatra"><span class="octicon octicon-link"></span></a>What Is Sinatra?</h2>

      <p>In the past, you've likely come across or used <a href="http://rubyonrails.org">Ruby on Rails</a> (RoR) - a popular web application framework for the Ruby programming language that helps organize applications using the MVC pattern. Sinatra is a much smaller, more light-weight alternative to it.</p>

      <p>Whilst a very basic Rails application may require a more strict project structure (such as requiring the use of controllers, views and routing etc.), Sinatra doesn't require as many of these dependencies, sacrificing the helpers needed to connect to databases, tools to create forms or any of the other utilities Rails comes with out of the box.</p>

      <p>What Sinatra does have is a <strong>minimal</strong> set of features most useful for tying specific URLs and RESTful HTTP actions to blocks of Ruby code and returning this code's output as a response. Sinatra is particularly useful for getting projects up and running quickly where we don't have a need for the extra pieces RoR provides.</p>

      <p>For those who are familiar with more Rails, you probably know that it requires a separate routes file to define how an application should be responding to requests. These are then piped into the relevant models and controllers as needed.</p>

      <p>Sinatra takes a more straight-forward approach, providing us with the most simple path to handling routing. By declaring <code>get</code>,<code>post</code>, <code>put</code> or <code>delete</code> actions, we can inform Sinatra to add a new route, which we can then have respond to requests.</p>

      <p>The framework is particularly useful for writing APIs, widgets and small-scale applications that can power the backend of a client-heavy application. As mentioned, we will be using it to power our API.</p>

      <h2>
      <a name="user-content-getting-started-with-sinatra" class="anchor" href="#getting-started-with-sinatra"><span class="octicon octicon-link"></span></a>Getting Started With Sinatra</h2>

      <p>Let's review how to write and run a very basic Sinatra application. As most programming languages and frameworks typically start with some variation of "Hello World", we'll start with a similar example.</p>

      <p>Note: Before beginning this section, I recommend installing Sinatra on your system. A guide to doing this can be found in the <a href="#preq">prerequisites</a> section lower down in the article.</p>

      <h3>
      <a name="user-content-routes" class="anchor" href="#routes"><span class="octicon octicon-link"></span></a>Routes</h3>

      <p>As mentioned, Sinatra allows us to define new routes using HTTP actions. Semantically, a route follows quite a simple structure:</p>

      <div class="highlight highlight-ruby"><pre><span class="o">&lt;</span><span class="n">a</span> <span class="no">HTTP</span> <span class="n">action</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">desired</span> <span class="n">route</span><span class="o">&gt;</span> <span class="k">do</span>
         <span class="c1"># some behaviour</span>
      <span class="k">end</span>
      </pre></div>

      <p>A tiny route that outputs a "Hello World"-like message when we attempt to "get" the root could thus be written as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'sinatra'</span>

      <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
         <span class="s2">"Hello World! Is it me you're looking for?"</span>
      <span class="k">end</span>
      </pre></div>

      <p>To run this snippet, we can can simply save it to a local '.rb' file and execute it as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">ruby</span> <span class="o">-</span><span class="n">rubygems</span> <span class="n">example</span><span class="o">.</span><span class="n">rb</span>
      </pre></div>

      <p>If we now navigated to http://localhost:4567 in our browser we could now see the application running successfully.</p>

      <p>The HTTP verbs we commonly work with when writing RESTful web services are: <code>get</code>, <code>post</code>, <code>delete</code> and <code>put</code>. As we now know, all Sinatra routes are basically HTTP actions (<code>get</code> etc.) that are paired with a URL-matching pattern. We associate a pair of an action and route with code we would like sent back to the browser (executed)if the route is reached. Sinatra doesn't enforce much in the way of architectural structure, instead relying on simplicity to supporting writing powerful APIs.</p>

      <p>Here's an example of a skeleton service we could put together supporting four common HTTP actions:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="c1"># list all items available</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># get a single item</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/item'</span> <span class="k">do</span>
        <span class="c1"># create a new item</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># update an existing item</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># delete an item</span>
      <span class="k">end</span>
      </pre></div>

      <p>Sinatra's routing is both easy for beginners to get started with but is also flexible enough for those wishing to define more complex routes. As you probably noticed in the above example, routes can include named parameters (e.g <code>/item/:id</code>). We can actually access the content of these routes using the <code>params</code> hash as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># this matches "GET /item/10" and "GET /item/11"</span>
        <span class="c1"># params[:id] is "10" or "11"</span>
        <span class="s2">"You reached </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
      </pre></div>

      <p>Sinatra also supports route matching via splats, wildcards and regular expressions. For more information on this I recommend reading the official <a href="http://www.sinatrarb.com/documentation">docs</a>. Let's now take a look at handlers.</p>

      <p>Sinatra includes convenient handler methods for tasks such as redirection, halting and passing.</p>

      <h4>
      <a name="user-content-redirection" class="anchor" href="#redirection"><span class="octicon octicon-link"></span></a>Redirection</h4>

      <p>A simple route supporting redirection which returns a 302 response can be written as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
            <span class="n">redirect</span> <span class="s1">'/items/welcome'</span>
      <span class="k">end</span>
      </pre></div>

      <p>And if we wish to pass additional parameters such as arguments we can do so like this:
      redirect '<a href="http://site.com/">http://site.com/</a>', 'Oops! I think we have a problem!'</p>

      <h4>
      <a name="user-content-halting" class="anchor" href="#halting"><span class="octicon octicon-link"></span></a>Halting</h4>

      <p>To immediately stop a request (halting) we can use 'halt'. Heres an example of halting a request where we specify the message body:</p>

      <p><code>halt "who goes there!?"</code></p>

      <h4>
      <a name="user-content-passing" class="anchor" href="#passing"><span class="octicon octicon-link"></span></a>Passing</h4>

      <p>'Passing' is the concept of deferring processing of a block to the next matching route. We do this using <code>pass</code>. In the following example if a parameter isnt the username we expect (rick-astley) we simply pass it on:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/members/:username'</span> <span class="k">do</span>
       <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'rick-astley'</span>
       <span class="s1">'Never gonna give you up, never gonna let you down'</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/members/*'</span> <span class="k">do</span>
       <span class="s1">'Welcome!'</span>
      <span class="k">end</span>
      </pre></div>

      <p>There are also handler methods that can assist with sessions (specifically, cookie-based session handling). To use Sinatra's session handling, first enable it in your application with:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">enable</span> <span class="ss">:sessions</span>
      </pre></div>

      <p>You can then use the session handling capabilities as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="s2">"This page has been accessed </span><span class="si">#{</span><span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span><span class="si">}</span><span class="s2"> times"</span>
      <span class="k">end</span>
      </pre></div>

      <p>Note: By default enable:sessions will store all data in cookies. If this is not desired, you can not call this and instead use some Rack middleware instead. For more on this see <a href="http://www.sinatrarb.com/intro#Using%20Sessions">here</a>.</p>

      <p>This only touches the surface of what can be done using routes and handlers, but is sufficient for us to write the Sinatra-powered API service we require in the practical section of this chapter.</p>

      <h2>
      <a name="user-content-templating-and-haml" class="anchor" href="#templating-and-haml"><span class="octicon octicon-link"></span></a>Templating And HAML</h2>

      <p>Let's now discuss templating.Out of the box, we can begin using templates in our Sinatra applications with ERB. ERB is included with Ruby and allows Ruby code to be added to any plain text document for the purpose of generating information or flow control. In the following example using an ERB template, note that views are by default located in the <code>views</code> directory of our application.</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">erb</span> <span class="ss">:default</span>
        <span class="c1"># renders views/default.erb</span>
      <span class="k">end</span>
      </pre></div>

      <p>A useful Sinatra convention worth noting is how layouts are handled. Layouts automatically search for a views/layout template which is rendered before any other views are loaded. With ERB, our views/layout.erb file could look as follows:</p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;html&gt;</span>
        <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
        <span class="nt">&lt;body&gt;</span>
          <span class="err">&lt;</span>%= data %&gt;
        <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>Haml is a popular alternative to ERB which offers an abstract syntax for writing application templates. It has been said to be:</p>

      <ul>
      <li>Straight-forward to learn</li>
      <li>Very easy to read and use for visually expressing a hierarchy of DOM elements</li>
      <li>Popular with web designers as it builds on top of CSS syntax</li>
      <li>Well documented with a large community backing it</li>
      <li>Almost as fast as ERB</li>
      </ul><p>For the purpose of comparison, below we can see an ERB template compared to its Haml equivalent.</p>

      <h4>
      <a name="user-content-erb" class="anchor" href="#erb"><span class="octicon octicon-link"></span></a>ERB</h4>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo"</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"entry_title"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= h @todo.title %&gt;<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"entry_link"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= link_to('link', @todo.link) %&gt;<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre></div>

      <h4>
      <a name="user-content-haml" class="anchor" href="#haml"><span class="octicon octicon-link"></span></a>Haml</h4>

      <div class="highlight highlight-html"><pre>.todo#content
        %h2.entry_title= @todo.title
        .entry_link= link_to('link', @todo.link)
      </pre></div>

      <p>One of the first things we notice is that the Haml snippet looks significantly more like CSS than it does traditional markup. It's much easier to read and we no longer need to be concerned with divs, spans, closing tags or other semantic rules that usually mean more keystrokes. The approach taken to making whitespace a part of the syntax also means it can be much easier to compare changes between multiple documents (especially if you're doing a diff).</p>

      <p>In the list of Haml features, we briefly mentioned web designers. As developers, we regularly need to communicate and work with designers, but we always have to remember that at the end of the day, they are not programmers. They're usually more concerned with the look and the feel of an application, but if we want them to write mark-up as a part of the templates or skins they create, Haml is a simpler option that has worked well for teams at a number of companies.</p>

      <div class="highlight highlight-ruby"><pre><span class="o">%</span><span class="n">h1</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h1</span> <span class="n">text</span>
      <span class="o">%</span><span class="n">h2</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h2</span> <span class="n">text</span><span class="o">.</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="n">line</span> <span class="n">containing</span> <span class="n">a</span> <span class="n">single</span> <span class="n">instance</span> <span class="ss">variable</span><span class="p">:</span> <span class="vi">@content</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="vi">@content</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Embedding</span> <span class="no">Ruby</span> <span class="n">code</span> <span class="k">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">line</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">using</span> <span class="o">==.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">==</span> <span class="no">Here</span> <span class="n">is</span> <span class="n">an</span> <span class="ss">example</span><span class="p">:</span> <span class="c1">#{@foobar}</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">We</span> <span class="n">can</span> <span class="n">also</span> <span class="n">add</span> <span class="n">attributes</span> <span class="n">using</span> <span class="p">{}</span>
      <span class="o">%</span><span class="nb">p</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">"color:green"</span><span class="p">}</span> <span class="no">We</span> <span class="n">just</span> <span class="n">made</span> <span class="n">this</span> <span class="n">paragraph</span> <span class="n">green!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">You</span><span class="err">'</span><span class="n">ll</span> <span class="n">want</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">ids</span> <span class="n">to</span> <span class="n">your</span> <span class="no">DOM</span><span class="p">,</span> <span class="n">too</span><span class="o">.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">foo</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">bar</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">bar</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="c1">#foobar This has the foobar id</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span><span class="c1">#foobar Or you can combine them!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Nesting</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">like</span> <span class="n">this</span>
      <span class="o">%</span><span class="nb">p</span>
        <span class="no">Or</span> <span class="n">even</span> <span class="n">like</span> <span class="n">this</span>

      </pre></div>

      <p>Note: Haml is whitespace sensitive and will not correctly work if it isn't indented by an even number of spaces. This is due to whitespace being used for nesting in place of the classic HTML markup approach of closing tags.</p>

      <h1>
      <a name="user-content-mongodb-ruby-driver" class="anchor" href="#mongodb-ruby-driver"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h1>

      <h2>
      <a name="user-content-getting-started-1" class="anchor" href="#getting-started-1"><span class="octicon octicon-link"></span></a>Getting started</h2>

      <p>Once the MongoDB Ruby driver is installed, we can begin to use it to connect to a Mongo database. To create a  connection using localhost, we simply specify the driver as a dependency. Assuming we're using the default port we can then connect as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'mongo'</span>

      <span class="c1"># where 'learning-mongo' is the name of our database:</span>
      <span class="n">db</span> <span class="o">=</span> <span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'learning-mongo'</span><span class="p">);</span>
      </pre></div>

      <p>We probably also want to place some data into 'learning-mongo'. It could be as simple as a note, so why don't we go ahead and begin a notes collection?:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">notes</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">)</span>
      </pre></div>

      <p>Something interesting worth noting is that at this point, we haven't actually created the database nor the collection we're referencing above.</p>

      <p>Neither of these items exist in Mongo (just yet) but as we're working with a new database but they will once we insert some real data.</p>

      <p>A new note could be defined using key/value pairs as follows and then inserted into 'learning-mongo' using <code>collection.insert()</code>:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">our_note</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">'Remember the milk'</span><span class="p">,</span> <span class="ss">:remindInterval</span> <span class="o">=&gt;</span> <span class="s1">'weekly'</span><span class="p">}</span>
      <span class="n">note_id</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">our_note</span><span class="p">)</span>
      </pre></div>

      <p>What is returned from inserting a note into the notes collection is an <code>ObjectId</code> reference for the note from Mongo. This is useful as we can re-use it to locate the same document in our database.</p>

      <div class="highlight highlight-ruby"><pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      </pre></div>

      <p>This can also be used in conjunction with Mongo's <code>collection.update()</code> method and <a href="http://www.mongodb.org/display/DOCS/Updating">query</a> operators (i.e <code>$set</code>) to replace fields in an existing document.</p>

      <p>We might update an entire document as follows:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="n">note</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Remember the bread'</span>
      <span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="n">note</span><span class="p">)</span>
      </pre></div>

      <p>or using <code>$set</code>, update an existing document without overwriting the entire object as like this:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=</span> <span class="o">&gt;</span> <span class="s1">'Remember the bread'</span> <span class="p">})</span>
      </pre></div>

      <p>Useful to know: Almost each MongoDB document has an _id field as its first attribute. This can normally
      be of any type, however a special BSON datatype is provided for object ids. It's a
      12-byte binary value that has a high probability of being unique when allocated.</p>

      <p>Note: Whilst we opted for the MongoDB Ruby Driver for this stack, you may also be interested in <strong>DataMapper</strong> - a solution which allows us to use the same API to talk to a number of different datastores. This works well for both relational and non-relational databases and more information is available on the official <a href="http://datamapper.org/why.html">project page</a>. <a href="http://sinatra-book.gittr.com/#datamapper">Sinatra: The Book</a> also contains a brief tutorial on DataMapper for anyone interested in exploring it further.</p>

      <h1>
      <a name="user-content-practical-1" class="anchor" href="#practical-1"><span class="octicon octicon-link"></span></a>Practical</h1>

      <p>We're going to use Sinatra in a similar manner to how we used Express in the last chapter. It will power a RESTful API supporting CRUD operations. Together with a MongoDB data store, this will allow us to easily persist data (todo items) whilst ensuring they are stored in a database. If you've read the previous chapter or have gone through any of the Todo examples covered so far, you will find this surprisingly straight-forward.</p>

      <p>Remember that the default Todo example included with Backbone.js already persists data, although it does this via a localStorage adapter. Luckily there aren't a great deal of changes needed to switch over to using our Sinatra-based API.  Let's briefly review the code that will be powering the CRUD operations for this sections practical, as we won't be starting off with a near-complete base for most of our real world applications.</p>

      <h3>
      <a name="user-content-installing-the-prerequisites" class="anchor" href="#installing-the-prerequisites"><span class="octicon octicon-link"></span></a>Installing The Prerequisites</h3>

      <h4>
      <a name="user-content-ruby" class="anchor" href="#ruby"><span class="octicon octicon-link"></span></a>Ruby</h4>

      <p>If using OSX or Linux, Ruby may be one of a number of open-source packages that come pre-installed and you can skip over to the next paragraph. In case you would like to check if check if you have Ruby installed, open up the terminal prompt and type:</p>

      <p><code>$ ruby -v</code></p>

      <p>The output of this will either be the version of Ruby installed or an error complaining that Ruby wasn't found.</p>

      <p>Should you need to install Ruby manually (e.g for an operating system such as Windows), you can do so by downloading the latest version from <a href="http://www.ruby-lang.org/en/downloads/">http://www.ruby-lang.org/en/downloads/</a>. Alternatively, <a href="http://beginrescueend.com/rvm/install/">RVM</a> (Ruby Version Manager) is a command-line tool that allows you to easily install and manage multiple ruby environments with ease.</p>

      <h4>
      <a name="user-content-ruby-gems" class="anchor" href="#ruby-gems"><span class="octicon octicon-link"></span></a>Ruby Gems</h4>

      <p>Next, we will need to install Ruby Gems. Gems are a standard way to package programs or libraries written in Ruby and with Ruby Gems it's possible to install additional dependencies for Ruby applications very easily.</p>

      <p>On OSX, Linux or Windows go to <a href="http://rubyforge.org/projects/rubygems">http://rubyforge.org/projects/rubygems</a> and download the latest version of Ruby Gems. Once downloaded, open up a terminal, navigate to the folder where this resides and enter:</p>

      <pre><code>$&gt; tar xzvf rubygems.tgz
      $&gt; cd rubygems
      $&gt; sudo ruby setup.rb
      </code></pre>

      <p>There will likely be a version number included in your download and you should make sure to include this when tying the above. Finally, a symlink (symbolic link) to tie everything togther should be run as follows:</p>

      <p><code>$ sudo ln -s /usr/bin/gem1.8.17 /usr/bin/gem</code></p>

      <p>To check that Ruby Gems has been correctly installed, type the following into your terminal:</p>

      <pre><code>$ gem -v
      </code></pre>

      <h4>
      <a name="user-content-sinatra" class="anchor" href="#sinatra"><span class="octicon octicon-link"></span></a>Sinatra</h4>

      <p>With Ruby Gems setup, we can now easily install Sinatra. For Linux or OSX type this in your terminal:</p>

      <p><code>$ sudo gem install sinatra</code></p>

      <p>and if you're on Windows, enter the following at a command prompt:</p>

      <p><code>c:\&gt; gem install sinatra</code></p>

      <h4>
      <a name="user-content-haml-1" class="anchor" href="#haml-1"><span class="octicon octicon-link"></span></a>Haml</h4>

      <p>As with other DSLs and frameworks, Sinatra supports a wide range of different templating engines. <a href="http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html">ERB</a> is the one most often recommended by the Sinatra camp, however
      as a part of this chapter, we're going to explore the use of <a href="http://haml.hamptoncatlin.com/">Haml</a> to define our application templates.</p>

      <p>Haml stands for HTML Abstractional Markup Language and is a lightweight markup language abstraction that can be used to describe HTML without the need to use traditional markup language semantics (such as opening and closing tags).</p>

      <p>Installing Haml can be done in just a line using Ruby Gems as follows:</p>

      <p><code>$ gem install haml</code></p>

      <h4>
      <a name="user-content-mongodb-1" class="anchor" href="#mongodb-1"><span class="octicon octicon-link"></span></a>MongoDB</h4>

      <p>If you haven't already downloaded and installed MongoDB from an earlier chapter, please <a href="http://www.mongodb.org/downloads">do so</a> now. With Ruby Gems, Mongo can be installed in just one line:</p>

      <p><code>$ gem install mongodb</code></p>

      <p>We now require two further steps to get everything up and running.</p>

      <h5>
      <a name="user-content-1data-directories" class="anchor" href="#1data-directories"><span class="octicon octicon-link"></span></a>1.Data directories</h5>

      <p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted Mongo and run the following from terminal:</p>

      <pre><code>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </code></pre>

      <h5>
      <a name="user-content-2running-and-connecting-to-your-server" class="anchor" href="#2running-and-connecting-to-your-server"><span class="octicon octicon-link"></span></a>2.Running and connecting to your server</h5>

      <p>Once this is done, open up two terminal windows.</p>

      <p>In the first, cd to your MongoDB bin directory or type in the complete path to it. You'll need to start mongod.</p>

      <pre><code>$ ./bin/mongod
      </code></pre>

      <p>Finally, in the second terminal, start the mongo shell which will connect up to localhost by default.</p>

      <pre><code>$ ./bin/mongo
      </code></pre>

      <h4>
      <a name="user-content-mongodb-ruby-driver-1" class="anchor" href="#mongodb-ruby-driver-1"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h4>

      <p>As we'll be using the <a href="https://github.com/mongodb/mongo-ruby-driver">MongoDB Ruby Driver</a>, we'll also require the following gems:</p>

      <p>The gem for the driver itself:</p>

      <pre><code>$ gem install mongo
      </code></pre>

      <p>and the driver's other prerequisite, bson:</p>

      <pre><code>$ gem install bson_ext
      </code></pre>

      <p>This is basically a collection of extensions used to increase serialization speed.</p>

      <p>That's it for our prerequisites!.</p>

      <h2>
      <a name="user-content-tutorial" class="anchor" href="#tutorial"><span class="octicon octicon-link"></span></a>Tutorial</h2>

      <p>To get started, let's get a local copy of the practical application working on our system.</p>

      <h3>
      <a name="user-content-application-files" class="anchor" href="#application-files"><span class="octicon octicon-link"></span></a>Application Files</h3>

      <p>Clone <a href="http://github.com/addyosmani/backbone-fundamentals">this</a> repository and navigate to <code>/practicals/stacks/option3</code>. Now run the following lines at the terminal:</p>

      <pre><code>ruby app.rb
      </code></pre>

      <p>Finally, navigate to <code>http://localhost:4567/todo</code> to see the application running successfully.</p>

      <p><strong>Note:</strong> The Haml layout files for Option 3 can be found in the /views folder.</p>

      <p>The directory structure for our practical application is as follows:</p>

      <pre><code>--public
      ----css
      ----img
      ----js
      -----script.js
      ----test
      --views
      app.rb

      </code></pre>

      <p>The <code>public</code> directory contains the scripts and stylesheets for our application and uses HTML5 Boilerplate as a base. You can find the Models, Views and Collections for this section within <code>public/js/scripts.js</code> (however, this can of course be expanded into sub-directories for each component if desired).</p>

      <p><code>scripts.js</code> contains the following Backbone component definitions:</p>

      <pre><code>--Models
      ----Todo

      --Collections
      ----TodoList

      --Views
      ---TodoView
      ---AppView
      </code></pre>

      <p><code>app.rb</code> is the small Sinatra application that powers our backend API.</p>

      <p>Lastly, the <code>views</code> directory hosts the Haml source files for our application's index and templates, both of which are compiled to standard HTML markup at runtime.</p>

      <p>These can be viewed along with other note-worthy snippets of code from the application below.</p>

      <h3>
      <a name="user-content-backbone" class="anchor" href="#backbone"><span class="octicon octicon-link"></span></a>Backbone</h3>

      <h4>
      <a name="user-content-views-2" class="anchor" href="#views-2"><span class="octicon octicon-link"></span></a>Views</h4>

      <p>In our main application view (AppView), we want to load any previously stored Todo items in our Mongo database when the view initializes. This is done below with the line <code>Todos.fetch()</code> in the <code>initialize()</code> method where we also bind to the relevant events on the <code>Todos</code> collection for when items are added or changed.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
      <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>  <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'keyup #new-todo'</span><span class="o">:</span>     <span class="s1">'showTooltip'</span><span class="p">,</span>
            <span class="s1">'click .todo-clear a'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'all'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>
       <span class="err">…</span><span class="p">.</span>
      </pre></div>

      <h3>
      <a name="user-content-collections-1" class="anchor" href="#collections-1"><span class="octicon octicon-link"></span></a>Collections</h3>

      <p>In the TodoList collection below, we've set the <code>url</code> property to point to <code>/api/todos</code> to reference the collection's location on the server. When we attempt to access this from our Sinatra-backed API, it should return a list of all the Todo items that have been previously stored in Mongo.</p>

      <p>For the sake of thoroughness, our API will also support returning the data for a specific Todo item via <code>/api/todos/itemID</code>. We'll take a look at this again when writing the Ruby code powering our backend.</p>

      <div class="highlight highlight-javascript"><pre> <span class="c1">// Todo Collection</span>

        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-model" class="anchor" href="#model"><span class="octicon octicon-link"></span></a>Model</h3>

      <p>The model for our Todo application remains largely unchanged from the versions previously covered in this book. It is however worth noting that calling the function <code>model.url()</code> within the below would return the relative URL where a specific Todo item could be located on the server.</p>

      <div class="highlight highlight-javascript"><pre>  <span class="c1">// Our basic **Todo** model has `text`, `order`, and `done` attributes.</span>
        <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">'_id'</span><span class="p">,</span>

          <span class="c1">// Default attributes for a todo item.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">()</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>
        <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-rubysinatra" class="anchor" href="#rubysinatra"><span class="octicon octicon-link"></span></a>Ruby/Sinatra</h3>

      <p>Now that we've defined our main models, views and collections let's get the CRUD operations required by our Backbone application supported in our Sinatra API.</p>

      <p>We want to make sure that for any operations changing underlying data (create, update, delete) that our Mongo data store correctly reflects these.</p>

      <h3>
      <a name="user-content-apprb" class="anchor" href="#apprb"><span class="octicon octicon-link"></span></a>app.rb</h3>

      <p>For <code>app.rb</code>, we first define the dependencies required by our application. These include Sinatra, Ruby Gems, the MongoDB Ruby driver and the JSON gem.</p>

      <div class="highlight highlight-ruby"><pre><span class="nb">require</span> <span class="s1">'rubygems'</span>
      <span class="nb">require</span> <span class="s1">'sinatra'</span>
      <span class="nb">require</span> <span class="s1">'mongo'</span>
      <span class="nb">require</span> <span class="s1">'json'</span>
      </pre></div>

      <p>Next, we create a new connection to Mongo, specifying any custom configuration desired. If running a multi-threaded application, setting the 'pool_size' allows us to specify a maximum pool size and 'timeout' a maximum timeout for waiting for old connections to be released to the pool.</p>

      <div class="highlight highlight-ruby"><pre><span class="no">DB</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'mydb'</span><span class="p">,</span> <span class="ss">:pool_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span>
      </pre></div>

      <p>Finally we define the routes to be supported by our API. Note that in the first two blocks - one for our
      application root (<code>/</code>) and the other for our todo items route <code>/todo</code> - we're using Haml for template rendering.</p>

      <div class="highlight highlight-ruby"><pre><span class="k">class</span> <span class="nc">TodoApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>

          <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'hello'</span><span class="p">}</span>
          <span class="k">end</span>

          <span class="n">get</span> <span class="s1">'/todo'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:todo</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'Our Sinatra Todo app'</span><span class="p">}</span>
          <span class="k">end</span>
      </pre></div>

      <p><code>haml :index</code> instructs Sinatra to use the <code>views/index.haml</code> for the application index, whilst <code>attr_wrapper</code> is simply defining the values to be used for any local variables defined inside the template.
      This similarly applies Todo items with the template `views/todo.haml'.</p>

      <p>The rest of our routes make use of the <code>params</code> hash and a number of useful helper methods included with the MongoDB Ruby driver. For more details on these, please
      read the comments I've made inline below:</p>

      <div class="highlight highlight-ruby"><pre><span class="n">get</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># query a collection :thing, convert the output to an array, map the _id</span>
        <span class="c1"># to a string representation of the object's _id and finally output to JSON</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">from_bson_id</span><span class="p">(</span><span class="n">t</span><span class="p">)}</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># get the first document with the id :id in the collection :thing as a single document (rather</span>
        <span class="c1"># than a Cursor, the standard output) using find_one(). Our bson utilities assist with</span>
        <span class="c1"># ID conversion and the final output returned is also JSON</span>
        <span class="n">from_bson_id</span><span class="p">(</span><span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)))</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># parse the post body of the content being posted, convert to a string, insert into</span>
        <span class="c1"># the collection #thing and return the ObjectId as a string for reference</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">))</span>
        <span class="s2">"{</span><span class="se">\"</span><span class="s2">_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="si">#{</span><span class="n">oid</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="se">\"</span><span class="s2">}"</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># remove the item with id :id from the collection :thing, based on the bson</span>
        <span class="c1"># representation of the object id</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># collection.update() when used with $set (as covered earlier) allows us to set single values</span>
        <span class="c1"># in this case, the put request body is converted to a string, rejecting keys with the name '_id' for security purposes</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)},</span> <span class="p">{</span><span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">'_id'</span><span class="p">}})</span>
      <span class="k">end</span>

      <span class="c1"># utilities for generating/converting MongoDB ObjectIds</span>
      <span class="k">def</span> <span class="nf">to_bson_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">end</span>
      <span class="k">def</span> <span class="nf">from_bson_id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="n">obj</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">obj</span><span class="o">[</span><span class="s1">'_id'</span><span class="o">].</span><span class="n">to_s</span><span class="p">})</span> <span class="k">end</span>

      <span class="k">end</span>
      </pre></div>

      <p>That's it. The above is extremely lean for an entire API, but does allow us to read and write data to support the functionality required by our client-side application.</p>

      <p>For more on what MongoDB and the MongoDB Ruby driver are capable of, please do feel free to read their documentation for more information.</p>

      <p>If you're a developer wishing to take this example further, why not try to add some additional capabilities to the service:</p>

      <ul>
      <li>Validation: improved validation of data in the API. What more could be done to ensure data sanitization?</li>
      <li>Search: search or filter down Todo items based on a set of keywords or within a certain date range</li>
      <li>Pagination: only return the Nth number of Todo items or items from a start and end-point</li>
      </ul><h3>
      <a name="user-content-hamltemplates" class="anchor" href="#hamltemplates"><span class="octicon octicon-link"></span></a>Haml/Templates</h3>

      <p>Finally, we move on to the Haml files that define our application index (layout.haml) and the template for a specific Todo item (todo.haml). Both of these are largely self-explanatory, but it's useful to see the differences between the Jade approach we reviewed in the last chapter vs. using Haml for this implementation.</p>

      <p>Note: In our Haml snippets below, the forward slash character is used to indicate a comment. When this character is placed at the beginning of a line, it wraps all of the text after it into a HTML comment. e.g</p>

      <p><code>/ These are templates</code></p>

      <p>compiles to:</p>

      <p><code>&lt;!-- These are templates --&gt;</code></p>

      <h3>
      <a name="user-content-indexhaml" class="anchor" href="#indexhaml"><span class="octicon octicon-link"></span></a>index.haml</h3>

      <div class="highlight highlight-html"><pre>%head
        %meta{'charset' =&gt; 'utf-8'}/
        %title=title
        %meta{'name' =&gt; 'description', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'author', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'viewport', 'content' =&gt; 'width=device-width,initial-scale=1'}/

        / CSS concatenated and minified via ant build script
        %link{'rel' =&gt; 'stylesheet', 'href' =&gt; 'css/style.css'}/
        / end CSS

        %script{'src' =&gt; 'js/libs/modernizr.min.js'}
      %body
        %div#container
          %header
          %div#main
            = yield
          %footer
        /! end of #container

        %script{'src' =&gt; 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'}

        / scripts concatenated and minified via ant build script
        %script{'src' =&gt; 'js/mylibs/underscore.js'}
        %script{'src' =&gt; 'js/mylibs/backbone.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/plugins.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/script.js'}
        / end scripts
      </pre></div>

      <h3>
      <a name="user-content-todohaml" class="anchor" href="#todohaml"><span class="octicon octicon-link"></span></a>todo.haml</h3>

      <div class="highlight highlight-html"><pre>%div#todoapp
        %div.title
          %h1
            Todos
            %div.content
              %div#create-todo
                %input#new-todo{"placeholder" =&gt; "What needs to be done?", "type" =&gt; "text"}/
                %span.ui-tooltip-top{"style" =&gt; "display:none;"} Press Enter to save this task
              %div#todos
                %ul#todo-list
              %div#todo-stats

      / Templates

      %script#item-template{"type" =&gt; "text/template"}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        %div.display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          %div.todo-text
          %span#todo-destroy
        %div.edit
          %input.todo-input{"type" =&gt; "text", "value" =&gt;""}/
        <span class="nt">&lt;/div&gt;</span>

      %script#stats-template{"type" =&gt; "text/template"}
        <span class="err">&lt;</span>% if (total) { %&gt;
        %span.todo-count
          %span.number <span class="err">&lt;</span>%= remaining %&gt;
          %span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        %span.todo-clear
          %a{"href" =&gt; "#"}
            Clear
            %span.number-done <span class="err">&lt;</span>%= done %&gt;
            completed
            %span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre></div>

      <h2>
      <a name="user-content-conclusions-2" class="anchor" href="#conclusions-2"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>In this chapter, we looked at creating a Backbone application backed by an API powered by Ruby, Sinatra, Haml, MongoDB and the MongoDB driver. I personally found developing APIs with Sinatra a relatively painless experience and one which I felt was
      on-par with the effort required for the Node/Express implementation of the same application.</p>

      <p>This section is by no means the most comprehensive guide on building complex apps using all of the items in this particular stack. I do however hope it was an introduction sufficient enough to help you decide on what stack to try out for your next project.</p>

      <h1>
      <a name="user-content-modular-development" class="anchor" href="#modular-development"><span class="octicon octicon-link"></span></a>Modular Development</h1>

      <h2>
      <a name="user-content-introduction-2" class="anchor" href="#introduction-2"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>When we say an application is modular, we generally mean it's composed of a set of highly decoupled, distinct pieces of functionality stored in modules. As you probably know, loose coupling facilitates easier maintainability of apps by removing dependencies where possible. When this is implemented efficiently, its quite easy to see how changes to one part of a system may affect another.</p>

      <p>Unlike some more traditional programming languages however, the current iteration of JavaScript (ECMA-262) doesn't provide developers with the means to import such modules of code in a clean, organized manner. It's one of the concerns with specifications that haven't required great thought until more recent years where the need for more organized JavaScript applications became apparent.</p>

      <p>Instead, developers at present are left to fall back on variations of the module or object literal patterns. With many of these, module scripts are strung together in the DOM with namespaces being described by a single global object where it's still possible to incur naming collisions in your architecture. There's also no clean way to handle dependency management without some manual effort or third party tools.</p>

      <p>Whilst native solutions to these problems will be arriving in ES Harmony, the good news is that writing modular JavaScript has never been easier and you can start doing it today.</p>

      <p>In this next part of the book, we're going to look at how to use AMD modules and RequireJS for cleanly wrapping units of code in your application into manageable modules.</p>

      <h2>
      <a name="user-content-organizing-modules-with-requirejs-and-amd" class="anchor" href="#organizing-modules-with-requirejs-and-amd"><span class="octicon octicon-link"></span></a>Organizing modules with RequireJS and AMD</h2>

      <p>In case you haven't used it before, <a href="http://requirejs.org">RequireJS</a> is a popular script loader written by James Burke - a developer who has been quite instrumental in helping shape the AMD module format, which we'll discuss more shortly. Some of RequireJS's capabilities include helping to load multiple script files, helping define modules with or without dependencies and loading in non-script dependencies such as text files.</p>

      <p>So, why use RequireJS with Backbone? Although Backbone is excellent when it comes to providing a sanitary structure to your applications, there are a few key areas where some additional help could be used:</p>

      <p>1) Backbone doesn't endorse a particular approach to modular-development. Although this means it's quite open-ended for developers to opt for classical patterns like the module-pattern or Object Literals for structuring their apps (which both work fine), it also means developers aren't sure of what works best when other concerns come into play, such as dependency management.</p>

      <p>RequireJS is compatible with the AMD (Asynchronous Module Definition) format, a format which was born from a desire to write something better than the 'write lots of script tags with implicit dependencies and manage them manually' approach to development. In addition to allowing you to clearly declare dependencies, AMD works well in the browser, supports string IDs for dependencies, declaring multiple modules in the same file and gives you easy-to-use tools to avoid polluting the global namespace.</p>

      <p>2) Let's discuss dependency management a little more as it can actually be quite challenging to get right if you're doing it by hand. When we write modules in JavaScript, we ideally want to be able to handle the reuse of code units intelligently and sometimes this will mean pulling in other modules at run-time whilst at other times you may want to do this dynamically to avoid a large pay-load when the user first hits your application.</p>

      <p>Think about the GMail web-client for a moment. When users initially load up the page on their first visit, Google can simply hide widgets such as the chat module until a user has indicated (by clicking 'expand') that they wish to use it. Through dynamic dependency loading, Google could load up the chat module only then, rather than forcing all users to load it when the page first initializes. This can improve performance and load times and can definitely prove useful when building larger applications.</p>

      <p>I've previously written <a href="http://addyosmani.com/writing-modular-js">a detailed article</a> covering both AMD and other module formats and script loaders in case you'd like to explore this topic further. The takeaway is that although it's perfectly fine to develop applications without a script loader or clean module format in place, it can be of significant benefit to consider using these tools in your application development.</p>

      <h3>
      <a name="user-content-writing-amd-modules-with-requirejs" class="anchor" href="#writing-amd-modules-with-requirejs"><span class="octicon octicon-link"></span></a>Writing AMD modules with RequireJS</h3>

      <p>As discussed above, the overall goal for the AMD format is to provide a solution for modular JavaScript that developers can use today. The two key concepts you need to be aware of when using it with a script-loader are a <code>define()</code> method for facilitating module definition and a <code>require()</code> method for handling dependency loading. <code>define()</code> is used to define named or unnamed modules based on the proposal using the following signature:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">(</span>
          <span class="nx">module_id</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="nx">definition</span> <span class="kd">function</span> <span class="cm">/*function for instantiating the module or object*/</span>
      <span class="p">);</span>
      </pre></div>

      <p>As you can tell by the inline comments, the <code>module_id</code> is an optional argument which is typically only required when non-AMD concatenation tools are being used (there may be some other edge cases where it's useful too). When this argument is left out, we call the module 'anonymous'. When working with anonymous modules, the idea of a module's identity is DRY, making it trivial to avoid duplication of filenames and code.</p>

      <p>Back to the define signature, the dependencies argument represents an array of dependencies which are required by the module you are defining and the third argument ('definition function') is a function that's executed to instantiate your module. A barebone module (compatible with RequireJS) could be defined using <code>define()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span>
          <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are mapped to function parameters</span>
          <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-alternate-syntax" class="anchor" href="#alternate-syntax"><span class="octicon octicon-link"></span></a>Alternate syntax</h4>

      <p>There is also a <a href="http://requirejs.org/docs/whyamd.html#sugar">sugared version</a> of <code>define()</code> available that allows you to declare your dependencies as local variables using <code>require()</code>. This will feel familiar to anyone who's used node, and can be easier to add or remove dependencies.
      Here is the previous snippet using the alternate syntax:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">){</span>
              <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are defined as local vars</span>
          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">),</span>
              <span class="nx">bar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>

              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>The <code>require()</code> method is typically used to load code in a top-level JavaScript file or within a module should you wish to dynamically fetch dependencies. An example of its usage is:</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Consider 'foo' and 'bar' are two external modules</span>
      <span class="c1">// In this example, the 'exports' from the two modules loaded are passed as</span>
      <span class="c1">// function arguments to the callback (foo and bar)</span>
      <span class="c1">// so that they can similarly be accessed</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// rest of your code here</span>
              <span class="nx">foo</span><span class="p">.</span><span class="nx">doSomething</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p><strong>Wrapping modules, views and other components with AMD</strong></p>

      <p>Now that we've taken a look at how to define AMD modules, let's review how to go about wrapping components like views and collections so that they can also be easily loaded as dependencies for any parts of your application that require them. At it's simplest, a Backbone model may just require Backbone and Underscore.js. These are considered its dependencies and so, to write an AMD model module, we would simply do this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'hello world'</span><span class="p">,</span>
          <span class="p">},</span>

          <span class="c1">// A dummy initialization method</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">myModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>Note how we alias Underscore.js's instance to <code>_</code> and Backbone to just <code>Backbone</code>, making it very trivial to convert non-AMD code over to using this module format. For a view which might require other dependencies such as jQuery, this can similarly be done as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/mycollection'</span><span class="p">,</span>
        <span class="s1">'views/myview'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">myCollection</span><span class="p">,</span> <span class="nx">myView</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="p">...</span>
      </pre></div>

      <p>Aliasing to the dollar-sign (<code>$</code>), once again makes it very easy to encapsulate any part of an application you wish using AMD.</p>

      <h2>
      <a name="user-content-keeping-your-templates-external-using-requirejs-and-the-text-plugin" class="anchor" href="#keeping-your-templates-external-using-requirejs-and-the-text-plugin"><span class="octicon octicon-link"></span></a>Keeping Your Templates External Using RequireJS And The Text Plugin</h2>

      <p>Moving your [Underscore/Mustache/Handlebars] templates to external files is actually quite straight-forward. As this application makes use of RequireJS, I'll discuss how to implement external templates using this specific script loader.</p>

      <p>RequireJS has a special plugin called text.js which is used to load in text file dependencies. To use the text plugin, simply follow these simple steps:</p>

      <ol>
      <li><p>Download the plugin from <a href="http://requirejs.org/docs/download.html#text">http://requirejs.org/docs/download.html#text</a> and place it in either the same directory as your application's main JS file or a suitable sub-directory.</p></li>
      <li><p>Next, include the text.js plugin in your initial RequireJS configuration options. In the code snippet below, we assume that RequireJS is being included in our page prior to this code snippet being executed. Any of the other scripts being loaded are just there for the sake of example.</p></li>
      </ol><div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span> <span class="p">{</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="s1">'backbone'</span><span class="o">:</span>         <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'text'</span><span class="o">:</span>             <span class="s1">'libs/require/text'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'app'</span>
      <span class="p">}</span> <span class="p">);</span>
      </pre></div>

      <ol>
      <li>When the <code>text!</code> prefix is used for a dependency, RequireJS will automatically load the text plugin and treat the dependency as a text resource. A typical example of this in action may look like..</li>
      </ol><div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>
              <span class="c1">// the contents of the mainView file will be</span>
              <span class="c1">// loaded into mainView for usage.</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre></div>

      <ol>
      <li>Finally we can use the text resource that's been loaded for templating purposes. You're probably used to storing your HTML templates inline using a script with a specific identifier.</li>
      </ol><p>With Underscore.js's micro-templating (and jQuery) this would typically be:</p>

      <p>HTML:</p>

      <pre><code>&lt;script type="text/template" id="mainViewTemplate"&gt;
          &lt;% _.each( person, function( person_item ){ %&gt;
              &lt;li&gt;&lt;%= person_item.get('name') %&gt;&lt;/li&gt;
          &lt;% }); %&gt;
      &lt;/script&gt;
      </code></pre>

      <p>JS:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#mainViewTemplate'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">);</span>
      </pre></div>

      <p>With RequireJS and the text plugin however, it's as simple as saving your template into an external text file (say, <code>mainView.html</code>) and doing the following:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>

              <span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">mainView</span> <span class="p">);</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre></div>

      <p>That's it! Now you can apply your template to a view in Backbone with something like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">collection</span><span class="p">.</span><span class="nx">someview</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="nx">compiled_template</span><span class="p">(</span> <span class="p">{</span> <span class="nx">results</span><span class="o">:</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">models</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      </pre></div>

      <p>All templating solutions will have their own custom methods for handling template compilation, but if you understand the above, substituting Underscore's micro-templating for any other solution should be fairly trivial.</p>

      <p><strong>Note:</strong> You may also be interested in looking at <a href="https://github.com/ZeeAgency/requirejs-tpl">RequireJS tpl</a>. It's an AMD-compatible version of the Underscore templating system that also includes support for optimization (pre-compiled templates) which can lead to better performance and no evals. I have yet to use it myself, but it comes as a recommended resource.</p>

      <h2>
      <a name="user-content-optimizing-backbone-apps-for-production-with-the-requirejs-optimizer" class="anchor" href="#optimizing-backbone-apps-for-production-with-the-requirejs-optimizer"><span class="octicon octicon-link"></span></a>Optimizing Backbone apps for production with the RequireJS Optimizer</h2>

      <p>As experienced developers may know, an essential final step when writing both small and large JavaScript web applications is the build process.  The majority of non-trivial apps are likely to consist of more than one or two scripts and so optimizing, minimizing and concatenating your scripts prior to pushing them to production will require your users to download a reduced number (if not just one) script file.</p>

      <p>Note: If you haven't looked at build processes before and this is your first time hearing about them, you might find <a href="http://addyosmani.com/blog/client-side-build-process/">my post and screencast on this topic</a> useful.</p>

      <p>With some other structural JavaScript frameworks, my recommendation would normally be to implicitly use YUI Compressor or Google's closure compiler tools, but we have a slightly more elegant method available, when it comes to Backbone if you're using RequireJS. RequireJS has a command line optimization tool called r.js which has a number of capabilities, including:</p>

      <ul>
      <li>Concatenating specific scripts and minifying them using external tools such as UglifyJS (which is used by default) or Google's Closure Compiler for optimal browser delivery, whilst preserving the ability to dynamically load modules</li>
      <li>Optimizing CSS and stylesheets by inlining CSS files imported using @import, stripping out comments etc.</li>
      <li>The ability to run AMD projects in both Node and Rhino (more on this later)</li>
      </ul><p>You'll notice that I mentioned the word 'specific' in the first bullet point. The RequireJS optimizer only concatenates module scripts that have been specified in arrays of string literals passed to top-level (i.e non-local) require and define calls. As clarified by the <a href="http://requirejs.org/docs/optimization.html">optimizer docs</a> this means that Backbone modules defined like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span><span class="s1">'backbone'</span><span class="p">,</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'collections/sample'</span><span class="p">,</span><span class="s1">'views/test'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span><span class="nx">Backbone</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Sample</span><span class="p">,</span> <span class="nx">Test</span><span class="p">){</span>
              <span class="c1">//...</span>
          <span class="p">});</span>
      </pre></div>

      <p>will combine fine, however inline dependencies such as:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">someCondition</span> <span class="o">?</span> <span class="p">[</span><span class="s1">'models/ab'</span><span class="p">,</span><span class="s1">'models/ac'</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="s1">'models/ba'</span><span class="p">,</span><span class="s1">'models/bc'</span><span class="p">];</span>
      </pre></div>

      <p>will be ignored. This is by design as it ensures that dynamic dependency/module loading can still take place even after optimization.</p>

      <p>Although the RequireJS optimizer works fine in both Node and Java environments, it's strongly recommended to run it under Node as it executes significantly faster there. In my experience, it's a piece of cake to get setup with either environment, so go for whichever you feel most comfortable with.</p>

      <p>To get started with r.js, grab it from the <a href="http://requirejs.org/docs/download.html#rjs">RequireJS download page</a> or <a href="http://requirejs.org/docs/optimization.html#download">through NPM</a>. Now, the RequireJS optimizer works absolutely fine for single script and CSS files, but for most cases you'll want to actually optimize an entire Backbone project. You <em>could</em> do this completely from the command-line, but a cleaner option is using build profiles.</p>

      <p>Below is an example of a build file taken from the modular jQuery Mobile app referenced later in this book. A <strong>build profile</strong> (commonly named <code>app.build.js</code>) informs RequireJS to copy all of the content of <code>appDir</code> to a directory defined by <code>dir</code> (in this case <code>../release</code>). This will apply all of the necessary optimizations inside the release folder. The <code>baseUrl</code> is used to resolve the paths for your modules. It should ideally be relative to <code>appDir</code>.</p>

      <p>Near the bottom of this sample file, you'll see an array called <code>modules</code>. This is where you specify the module names you wish to have optimized. In this case we're optimizing the main application called 'app', which maps to <code>appDir/app.js</code>. If we had set the <code>baseUrl</code> to 'scripts', it would be mapped to <code>appDir/scripts/app.js</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'../release'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
             <span class="s1">'backbone'</span><span class="o">:</span>          <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'app'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span>
                      <span class="c1">// If you prefer not to include certain libs exclude them here</span>
                  <span class="p">]</span>
              <span class="p">}</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre></div>

      <p>The way the build system in r.js works is that it traverses app.js (whatever modules you've passed) and resolved dependencies, concatenating them into the final <code>release</code>(dir) folder. CSS is treated the same way.</p>

      <p>The build profile is usually placed inside the 'scripts' or 'js' directory of your project. As per the docs, this file can however exist anywhere you wish, but you'll need to edit the contents of your build profile accordingly.</p>

      <p>Finally, to run the build, execute the following command once inside your <code>appDir</code> or <code>appDir/scripts</code> directory:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">node</span> <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">r</span><span class="p">.</span><span class="nx">js</span> <span class="o">-</span><span class="nx">o</span> <span class="nx">app</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">js</span>
      </pre></div>

      <p>That's it. As long as you have UglifyJS/Closure tools setup correctly, r.js should be able to easily optimize your entire Backbone project in just a few key-strokes. If you would like to learn more about build profiles, James Burke has a <a href="https://github.com/jrburke/r.js/blob/master/build/example.build.js">heavily commented sample file</a> with all the possible options available.</p>

      <h2>
      <a name="user-content-optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages" class="anchor" href="#optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages"><span class="octicon octicon-link"></span></a>Optimize and Build a Backbone.js JavaScript application with RequireJS using Packages</h2>

      <p><em>Contributed by <a href="https://github.com/pixelhandler">Bill Heaton</a></em></p>

      <p>When a JavaScript application is too complex or large to build in a single file, grouping the application’s components into packages allows for script dependencies to download in parallel, and facilitates only loading <strong>packaged</strong> and other modular code as the site experience requires the specific set of dependencies.</p>

      <p>RequireJS, the (JavaScript) module loading library, has an <a href="http://requirejs.org/docs/optimization.html" title="RequireJS optimizer">optimizer</a> to build a JavaScript-based application and provides various options. A build profile is the recipe for your build, much like a build.xml file is used to build a project with ANT. The benefit of building with <strong>r.js</strong> not only results in speedy script loading with minified code, but also provides a way to package components of your application.</p>

      <ul>
      <li><a href="http://requirejs.org/docs/optimization.html#onejs" title="Optimizing one JavaScript file">Optimizing one JavaScript file</a></li>
      <li><a href="http://requirejs.org/docs/optimization.html#wholeproject" title="Optimizing a whole project">Optimizing a whole project</a></li>
      <li><a href="http://requirejs.org/docs/faq-optimization.html#priority" title="Optimizing a project in layers or packages">Optimizing a project in layers or packages</a></li>
      </ul><p>In a complex application, organizing code into <em>packages</em> is an attractive build strategy. The build profile in this article is based on an test application currently under development (files list below). The application framework is built with open source libraries. The main objective in this build profile is to optimize an application developed with <a href="http://documentcloud.github.com/backbone/" title="Backbone.js">Backbone.js</a> using modular code, following the <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" title="Asynchronous Module Definition (AMD) wiki page">Asynchronous Module Definition (AMD)</a> format. AMD and RequireJS provide the structure for writing modular code with dependencies. Backbone.js provides the code organization for developing models, views and collections and also interactions with a RESTful API.</p>

      <p>Below is an outline of the applications file organization, followed by the build profile to build modular (or packaged) layers a JavaScript driven application.</p>

      <h4>
      <a name="user-content-file-organization" class="anchor" href="#file-organization"><span class="octicon octicon-link"></span></a>File organization</h4>

      <p>Assume the following directories and file organization, with app.build.js as the build profile (a sibling to both source and release directories). Note that the files in the list below named <em>section</em> can be any component of the application, e.g. <em>header</em>, <em>login</em>)</p>

      <div class="highlight highlight-text"><pre>.-- app.build.js
      |-- app-release
      `-- app-src
          |-- collections
          |   |-- base.js
          |   |-- sections-segments.js
          |   `-- sections.js
          |-- docs
          |   `--docco.css
          |-- models
          |   |-- base.js
          |   |-- branding.js
          |   `-- section.js
          |-- packages
          |   |-- header
          |   |   |-- models
          |   |   |   |-- nav.js
          |   |   |   `-- link.js
          |   |   |-- templates
          |   |   |   |-- branding.js
          |   |   |   |-- nav.js
          |   |   |   `-- links.js
          |   |   `-- views
          |   |       |-- nav.js
          |   |       |-- branding.js
          |   |       `-- link.js
          |   |-- header.js
          |   `-- ... more packages here e.g. cart, checkout ...
          |-- syncs
          |   |-- rest
          |   |   `-- sections.js
          |   |-- factory.js
          |   `-- localstorage.js
          |-- test
          |   |-- fixtures
          |   |   `-- sections.json
          |   |-- header
          |   |   |-- index.html
          |   |   `-- spec.js
          |   |-- lib
          |   |   `-- Jasmine
          |   |-- models
          |   |-- utils
          |   |-- global-spec.js
          |-- utils
          |   |-- ajax.js
          |   |-- baselib.js
          |   |-- debug.js
          |   |-- localstorage.js
          |   `-- shims.js
          |-- vendor
          |-- |-- backbone-min.js
          |   |-- jquery.min.js
          |   |-- jquery.mobile-1.0.min.js
          |   |-- json2.js
          |   |-- modernizr.min.js
          |   |-- mustache.js
          |   |-- require.js
          |   |-- text.js
          |   `-- underscore.js
          |-- views
          |   |-- base.js
          |   `-- collection.js
          |-- application.js
          |-- collections.js
          |-- index.html
          |-- main.js
          |-- models.js
          |-- syncs.js
          |-- utils.js
          |-- vendor.js
          `-- views.js
      </pre></div>

      <h4>
      <a name="user-content-build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages" class="anchor" href="#build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages"><span class="octicon octicon-link"></span></a>Build profile to optimize modular dependencies with code organized in packages</h4>

      <p>The build profile can be organized to <a href="http://requirejs.org/docs/faq-optimization.html#priority" title="optimize modular dependencies in packages">divide parallel downloads for various sections of the application</a>.</p>

      <p>This strategy demonstrated builds common or site-wide groups of (core) <em>models</em>, <em>views</em>, collections which are extended from a base.js constructor which extends the appropriate backbone method, e.g. Backbone.Model. The <em>packages</em> directory organizes code by section / responsibility, e.g. cart, checkout, etc. Notice that within the example <em>header</em> package the directory structure is similar to the app root directory file structure. A <em>package</em> (of modularized code) has dependencies from the common libraries in your application and also has specific code for the packages execution alone; other packages should not require another packages dependencies. A <em>utils</em> directory has shims, helpers, and common library code to support the application. A <em>syncs</em> directory to define persistence with your RESTful api and/or localStorage. The <em>vendor</em> libraries folder will not be built, there is no need to do so, you may decide to use a CDN (then set these paths to : <em><a href="http://requirejs.org/docs/optimization.html#empty" title="empty:">empty:</a></em>). And finally a <em>test</em> directory for <a href="http://pivotal.github.com/jasmine/" title="Jasmine is a behavior-driven development framework for testing your JavaScript code">Jasmine</a> unit test specs, which may be ignored in the build as well if you choose.</p>

      <p>Also notice the there are .js files named the same as the directories, these are the files listed in the paths. these are strategic to group sets of files to build, examples follow the build profile below.</p>

      <div class="highlight highlight-javascript"><pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./app-src'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'./app-build'</span><span class="p">,</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="c1">// will not build 3rd party code, it's already built</span>
              <span class="s1">'text'</span>         <span class="o">:</span> <span class="s1">'vendor/text'</span><span class="p">,</span>
              <span class="s1">'json2'</span>        <span class="o">:</span> <span class="s1">'vendor/json2.min'</span><span class="p">,</span>
              <span class="s1">'modernizr'</span>    <span class="o">:</span> <span class="s1">'vendor/modernizr.min'</span><span class="p">,</span>
              <span class="s1">'jquery'</span>       <span class="o">:</span> <span class="s1">'vendor/jquery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span> <span class="o">:</span> <span class="s1">'vendor/jquery.mobile.min.js'</span><span class="p">,</span>
              <span class="s1">'underscore'</span>   <span class="o">:</span> <span class="s1">'vendor/underscore'</span><span class="p">,</span>
              <span class="s1">'mustache'</span>     <span class="o">:</span> <span class="s1">'vendor/mustache'</span><span class="p">,</span>
              <span class="s1">'backbone'</span>     <span class="o">:</span> <span class="s1">'vendor/backbone'</span><span class="p">,</span>
              <span class="c1">// files that define dependencies...</span>
              <span class="c1">// ignore vendor libraries, but need a group to do so</span>
              <span class="s1">'vendor'</span>       <span class="o">:</span> <span class="s1">'vendor'</span><span class="p">,</span>
              <span class="c1">// application modules/packages these files define dependencies</span>
              <span class="c1">// and may also group modules into objects if needed to require</span>
              <span class="c1">// by groups rather than individual files</span>
              <span class="s1">'utils'</span>        <span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
              <span class="s1">'models'</span>       <span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
              <span class="s1">'views'</span>        <span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
              <span class="s1">'collections'</span>  <span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
              <span class="c1">// packages to build</span>
              <span class="s1">'header'</span>       <span class="o">:</span> <span class="s1">'packages/header'</span>
              <span class="c1">//... more packages</span>
          <span class="p">},</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="c1">// Common libraries, Utilities, Syncs, Models, Views, Collections</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'syncs'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="c1">// Packages</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'header'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">,</span> <span class="s1">'collections'</span><span class="p">]</span>
              <span class="p">}</span>
              <span class="c1">// ... and so much more ...</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre></div>

      <p>The above build profile is designed for balancing scalability and performance.</p>

      <p><strong>Examples of the grouped sets of code dependencies</strong></p>

      <p>The contents of the vendor.js which is not built into a package may use some <em>no conflict</em> calls as well.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of vendor libraries, e.g. jQuery, Underscore, Backbone, etc.</span>
      <span class="c1">// this module is used with the r.js optimizer tool during build</span>
      <span class="c1">// @see &lt;http://requirejs.org/docs/faq-optimization.html&gt;</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">,</span> <span class="s1">'modernizr'</span><span class="p">,</span> <span class="s1">'mustache'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span>        <span class="nx">_</span><span class="p">,</span>            <span class="nx">Backbone</span><span class="p">,</span>   <span class="nx">Modernizr</span><span class="p">,</span>   <span class="nx">Mustache</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// call no conflicts so if needed you can use multiple versions of $</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>For your application common library code.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of utility libraries,</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'utils/ajax'</span><span class="p">,</span> <span class="s1">'utils/baselib'</span><span class="p">,</span> <span class="s1">'utils/localstorage'</span><span class="p">,</span> <span class="s1">'utils/debug'</span><span class="p">,</span> <span class="s1">'utils/shims'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">ajax</span><span class="p">,</span>         <span class="nx">baselib</span><span class="p">,</span>         <span class="nx">localstorage</span><span class="p">,</span>         <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'ajax'</span> <span class="o">:</span> <span class="nx">ajax</span><span class="p">,</span>
              <span class="s1">'baselib'</span> <span class="o">:</span> <span class="nx">baselib</span><span class="p">,</span>
              <span class="s1">'localstorage'</span> <span class="o">:</span> <span class="nx">localstorage</span><span class="p">,</span>
              <span class="s1">'debug'</span> <span class="o">:</span> <span class="nx">debug</span>
          <span class="p">};</span>
          <span class="c1">// the shim only extend JavaScript when needed, e.g. Object.create</span>
      <span class="p">});</span>
      </pre></div>

      <p>An example where you intend to use require the common models in another package file.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// List of models</span>
      <span class="c1">// models in this directory are intended for site-wide usage</span>
      <span class="c1">// grouping site-wide models in this module (object)</span>
      <span class="c1">// optimizes the performance and keeps dependencies organized</span>
      <span class="c1">// when the (build) optimizer is run.</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'models/branding'</span><span class="p">,</span> <span class="s1">'models/section'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">Branding</span><span class="p">,</span>          <span class="nx">Section</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'Branding'</span> <span class="o">:</span> <span class="nx">Branding</span><span class="p">,</span>
              <span class="s1">'Section'</span>  <span class="o">:</span> <span class="nx">Section</span>
          <span class="p">};</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-a-quick-note-on-code-standards" class="anchor" href="#a-quick-note-on-code-standards"><span class="octicon octicon-link"></span></a>A quick note on code standards</h4>

      <p>Notice that in the above examples the parameters may begin with lower or upper case characters. The variable names uses in the parameters that begin with <em>Uppercase</em> are <em>Constructors</em> and the <em>lowercase</em> variable names are not, they may be instances created by a constructor, or perhaps an object or function that is not meant to used with <em>new</em>.</p>

      <p>The convention recommended is to use Upper CamelCase for constructors and lower camelCase for others.</p>

      <h4>
      <a name="user-content-common-pitfall-when-organizing-code-in-modules" class="anchor" href="#common-pitfall-when-organizing-code-in-modules"><span class="octicon octicon-link"></span></a>Common Pitfall when organizing code in modules</h4>

      <p>Be careful not define circular dependencies. For example, in a common <em>models</em> package (models.js) dependencies are listed for the files in your models directory</p>

      <pre><code>define([ 'models/branding', 'models/section' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section }
      </code></pre>

      <p>Then when another packages requires a common model you can access the models objects returned from your common models.js file like so...</p>

      <pre><code>define([ 'models', 'utils' ], function (models, utils) {
      var branding = models.branding, debug = utils.debug;
      </code></pre>

      <p>Perhaps after using the model a few times you get into the habit of requiring "model". Later you need add another common model with extends a model you already defined. So the pitfall begins, you add a new model inside your models directory and add a reference this same model in the model.js:</p>

      <pre><code>define([ 'models/branding', 'models/section', 'models/section-b' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section, 'section-b' : section-b }
      </code></pre>

      <p>However in your <em>models/section-b.js</em> file you define a dependency using the model.js which returns the models in an object like so...</p>

      <pre><code>define([ 'models' ], function (models, utils) {
      var section = models.section;
      </code></pre>

      <p>Above is the mistake in models.js a dependency was added for models/section-b and in section-b a dependency is defined for model. The new models/section-b.js requires <em>model</em> and model.js requires <em>models/section-b.js</em> - a circular dependency. This should result in a load timeout error from RequireJS, but not tell you about the circular dependency.</p>

      <p>For other common mistakes see the <a href="http://requirejs.org/docs/errors.html" title="RequireJS common errors page">COMMON ERRORS</a> page on the RequireJS site.</p>

      <h4>
      <a name="user-content-executing-the-build-with-rjs" class="anchor" href="#executing-the-build-with-rjs"><span class="octicon octicon-link"></span></a>Executing the Build with r.js</h4>

      <p>If you intalled r.js with Node's npm (package manager) like so...</p>

      <pre><code>&gt; npm install requirejs
      </code></pre>

      <p>...you can execute the build on the command line:</p>

      <pre><code>&gt; r.js -o app.build.js
      </code></pre>

      <h2>
      <a name="user-content-practical-building-a-modular-backbone-app-with-amd--requirejs" class="anchor" href="#practical-building-a-modular-backbone-app-with-amd--requirejs"><span class="octicon octicon-link"></span></a>Practical: Building a modular Backbone app with AMD &amp; RequireJS</h2>

      <p>In this chapter, we'll look at our first practical Backbone &amp; RequireJS project - how to build a modular Todo application. The application will allow us to add new todos, edit new todos and clear todo items that have been marked as completed. For a more advanced practical, see the section on mobile Backbone development.</p>

      <p>The complete code for the application can can be found in the <code>practicals/modular-todo-app</code> folder of this repo (thanks to Thomas Davis and Jérôme Gravel-Niquet). Alternatively grab a copy of my side-project <a href="https://github.com/addyosmani/todomvc">TodoMVC</a> which contains the sources to both AMD and non-AMD versions.</p>

      <p><strong>Note:</strong> Thomas may be covering a practical on this exercise in more detail on <a href="http://backbonetutorials.com">backbonetutorials.com</a> at some point soon, but for this section I'll be covering what I consider the core concepts.</p>

      <h3>
      <a name="user-content-overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h3>

      <p>Writing a 'modular' Backbone application can be a straight-forward process. There are however, some key conceptual differences to be aware of if opting to use AMD as your module format of choice:</p>

      <ul>
      <li>As AMD isn't a standard native to JavaScript or the browser, it's necessary to use a script loader (such as RequireJS or curl.js) in order to support defining components and modules using this module format. As we've already reviewed, there are a number of advantages to using the AMD as well as RequireJS to assist here.</li>
      <li>Models, views, controllers and routers need to be encapsulated <em>using</em> the AMD-format. This allows each component of our Backbone application to cleanly manage dependencies (e.g collections required by a view) in the same way that AMD allows non-Backbone modules to.</li>
      <li>Non-Backbone components/modules (such as utilities or application helpers) can also be encapsulated using AMD. I encourage you to try developing these modules in such a way that they can both be used and tested independent of your Backbone code as this will increase their ability to be re-used elsewhere.</li>
      </ul><p>Now that we've reviewed the basics, let's take a look at developing our application. For reference, the structure of our app is as follows:</p>

      <pre><code>index.html
      ...js/
          main.js
          .../models
                  todo.js
          .../views
                  app.js
                  todos.js
          .../collections
                  todos.js
          .../templates
                  stats.html
                  todos.html
          ../libs
              .../backbone
              .../jquery
              .../underscore
              .../require
                      require.js
                      text.js
      ...css/
      </code></pre>

      <h3>
      <a name="user-content-markup" class="anchor" href="#markup"><span class="octicon octicon-link"></span></a>Markup</h3>

      <p>The markup for the application is relatively simple and consists of three primary parts: an input section for entering new todo items (<code>create-todo</code>), a list section to display existing items (which can also be edited in-place) (<code>todo-list</code>) and finally a section summarizing how many items are left to be completed (<code>todo-stats</code>).</p>

      <pre><code>&lt;div id="todoapp"&gt;

            &lt;div class="content"&gt;

              &lt;div id="create-todo"&gt;
                &lt;input id="new-todo" placeholder="What needs to be done?" type="text" /&gt;
                &lt;span class="ui-tooltip-top"&gt;Press Enter to save this task&lt;/span&gt;
              &lt;/div&gt;

              &lt;div id="todos"&gt;
                &lt;ul id="todo-list"&gt;&lt;/ul&gt;
              &lt;/div&gt;

              &lt;div id="todo-stats"&gt;&lt;/div&gt;

            &lt;/div&gt;

      &lt;/div&gt;
      </code></pre>

      <p>The rest of the tutorial will now focus on the JavaScript side of the practical.</p>

      <h3>
      <a name="user-content-configuration-options" class="anchor" href="#configuration-options"><span class="octicon octicon-link"></span></a>Configuration options</h3>

      <p>If you've read the earlier chapter on AMD, you may have noticed that explicitly needing to define each dependency a Backbone module (view, collection or other module) may require with it can get a little tedious. This can however be improved.</p>

      <p>In order to simplify referencing common paths the modules in our application may use, we use a RequireJS <a href="http://requirejs.org/docs/api.html#config">configuration object</a>, which is typically defined as a top-level script file. Configuration objects have a number of useful capabilities, the most useful being mode name-mapping. Name-maps are basically a key:value pair, where the key defines the alias you wish to use for a path and the value represents the true location of the path.</p>

      <p>In the code-sample below, you can see some typical examples of common name-maps which include: <code>backbone</code>, <code>underscore</code>, <code>jquery</code> and depending on your choice, the RequireJS <code>text</code> plugin, which assists with loading text assets like templates.</p>

      <p><strong>main.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
        <span class="nx">baseUrl</span><span class="o">:</span><span class="s1">'../'</span><span class="p">,</span>
        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'libs/jquery/jquery-min'</span><span class="p">,</span>
          <span class="nx">underscore</span><span class="o">:</span> <span class="s1">'libs/underscore/underscore-min'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'libs/backbone/backbone-optamd3-min'</span><span class="p">,</span>
          <span class="nx">text</span><span class="o">:</span> <span class="s1">'libs/require/text'</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'views/app'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AppView</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">app_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>The <code>require()</code> at the end of our main.js file is simply there so we can load and instantiate the primary view for our application (<code>views/app.js</code>). You'll commonly see both this and the configuration object included in most top-level script files for a project.</p>

      <p>In addition to offering name-mapping, the configuration object can be used to define additional properties such as <code>waitSeconds</code> - the number of seconds to wait before script loading times out and <code>locale</code>, should you wish to load up i18n bundles for custom languages. The <code>baseUrl</code> is simply the path to use for module lookups.</p>

      <p>For more information on configuration objects, please feel free to check out the excellent guide to them in the <a href="http://requirejs.org/docs/api.html#config">RequireJS docs</a>.</p>

      <h3>
      <a name="user-content-modularizing-our-models-views-and-collections" class="anchor" href="#modularizing-our-models-views-and-collections"><span class="octicon octicon-link"></span></a>Modularizing our models, views and collections</h3>

      <p>Before we dive into AMD-wrapped versions of our Backbone components, let's review a sample of a non-AMD view. The following view listens for changes to its model (a Todo item) and re-renders if a user edits the value of the item.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>Note how for templating the common practice of referencing a script by an ID (or other selector) and obtaining its value is used. This of course requires that the template being accessed is implicitly defined in our markup. The following is the 'embedded' version of our template being referenced above:</p>

      <pre><code>&lt;script type="text/template" id="item-template"&gt;
            &lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;div class="todo-content"&gt;&lt;/div&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="" /&gt;
              &lt;/div&gt;
            &lt;/div&gt;
      &lt;/script&gt;
      </code></pre>

      <p>Whilst there is nothing wrong with the template itself, once we begin to develop larger applications requiring multiple templates, including them all in our markup on page-load can quickly become both unmanageable and come with performance costs. We'll look at solving this problem in a minute.</p>

      <p>Let's now take a look at the AMD-version of our view. As discussed earlier, the 'module' is wrapped using AMD's <code>define()</code> which allows us to specify the dependencies our view requires. Using the mapped paths to 'jquery' etc. simplifies referencing common dependencies and instances of dependencies are themselves mapped to local variables that we can access (e.g 'jquery' is mapped to <code>$</code>).</p>

      <p><strong>views/todo.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'text!templates/todos.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">todosTemplate</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">todosTemplate</span><span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the contents of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setContent</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Use `jQuery.text` to set the contents of the todo item.</span>
          <span class="nx">setContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>From a maintenance perspective, there's nothing logically different in this version of our view, except for how we approach templating.</p>

      <p>Using the RequireJS text plugin (the dependency marked <code>text</code>), we can actually store all of the contents for the template we looked at earlier in an external file (todos.html).</p>

      <p><strong>templates/todos.html</strong></p>

      <div class="highlight highlight-html"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"display"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo-content"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"todo-destroy"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"edit"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"todo-input"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre></div>

      <p>There's no longer a need to be concerned with IDs for the template as we can map its contents to a local variable (in this case <code>todosTemplate</code>). We then simply pass this to the Underscore.js templating function <code>_.template()</code> the same way we normally would have the value of our template script.</p>

      <p>Next, let's look at how to define models as dependencies which can be pulled into collections. Here's an AMD-compatible model module, which has two default values: a <code>content</code> attribute for the content of a Todo item and a boolean <code>done</code> state, allowing us to trigger whether the item has been completed or not.</p>

      <p><strong>models/todo.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">TodoModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// Ensure that each todo created has `content`.</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'empty todo...'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">},</span>

          <span class="c1">// Remove this Todo from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">TodoModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>As per other types of dependencies, we can easily map our model module to a local variable (in this case <code>Todo</code>) so it can be referenced as the model to use for our <code>TodosCollection</code>. This collection also supports a simple <code>done()</code> filter for narrowing down Todo items that have been completed and a <code>remaining()</code> filter for those that are still outstanding.</p>

      <p><strong>collections/todos.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'libs/backbone/localstorage'</span><span class="p">,</span>
        <span class="s1">'models/todo'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Store</span><span class="p">,</span> <span class="nx">Todo</span><span class="p">){</span>

          <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>In addition to allowing users to add new Todo items from views (which we then insert as models in a collection), we ideally also want to be able to display how many items have been completed and how many are remaining. We've already defined filters that can provide us this information in the above collection, so let's use them in our main application view.</p>

      <p><strong>views/app.js</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/todos'</span><span class="p">,</span>
        <span class="s1">'views/todo'</span><span class="p">,</span>
        <span class="s1">'text!templates/stats.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">,</span> <span class="nx">TodoView</span><span class="p">,</span> <span class="nx">statsTemplate</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">statsTemplate</span><span class="p">),</span>

          <span class="c1">// ...events, initialize() etc. can be seen in the complete file</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>       <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">remaining</span><span class="o">:</span>  <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
            <span class="p">}));</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre></div>

      <p>Above, we map the second template for this project, <code>templates/stats.html</code> to <code>statsTemplate</code> which is used for rendering the overall <code>done</code> and <code>remaining</code> states. This works by simply passing our template the length of our overall Todos collection (<code>Todos.length</code> - the number of Todo items created so far) and similarly the length (counts) for items that have been completed (<code>Todos.done().length</code>) or are remaining (<code>Todos.remaining().length</code>).</p>

      <p>The contents of our <code>statsTemplate</code> can be seen below. It's nothing too complicated, but does use ternary conditions to evaluate whether we should state there's "1 item" or "2 item<i>s</i>" in a particular state.</p>

      <pre><code>&lt;% if (total) { %&gt;
              &lt;span class="todo-count"&gt;
                &lt;span class="number"&gt;&lt;%= remaining %&gt;&lt;/span&gt;
                &lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.
              &lt;/span&gt;
            &lt;% } %&gt;
            &lt;% if (done) { %&gt;
              &lt;span class="todo-clear"&gt;
                &lt;a href="#"&gt;
                  Clear &lt;span class="number-done"&gt;&lt;%= done %&gt;&lt;/span&gt;
                  completed &lt;span class="word-done"&gt;&lt;%= done == 1 ? 'item' : 'items' %&gt;&lt;/span&gt;
                &lt;/a&gt;
              &lt;/span&gt;
            &lt;% } %&gt;
      </code></pre>

      <p>The rest of the source for the Todo app mainly consists of code for handling user and application events, but that rounds up most of the core concepts for this practical.</p>

      <p>To see how everything ties together, feel free to grab the source by cloning this repo or browse it <a href="https://github.com/addyosmani/backbone-fundamentals/tree/master/practicals/modular-todo-app">online</a> to learn more. I hope you find it helpful!.</p>

      <p><strong>Note:</strong> While this first practical doesn't use a build profile as outlined in the chapter on using the RequireJS optimizer, we will be using one in the section on building mobile Backbone applications.</p>

      <h2>
      <a name="user-content-decoupling-backbone-with-the-mediator-and-facade-patterns" class="anchor" href="#decoupling-backbone-with-the-mediator-and-facade-patterns"><span class="octicon octicon-link"></span></a>Decoupling Backbone with the Mediator and Facade Patterns</h2>

      <p>In this section we'll discuss applying some of the concepts I cover in my article on <a href="http://addyosmani.com/largescalejavascript">Large-scale JavaScript Application development</a> to Backbone.</p>

      <p><em>After, you may be interested in taking a look At <a href="http://github.com/addyosmani/aura">Aura</a> - my popular widget-based Backbone.js extension framework based on many of the concepts we will be covering in this section.</em></p>

      <h3>
      <a name="user-content-summary-1" class="anchor" href="#summary-1"><span class="octicon octicon-link"></span></a>Summary</h3>

      <p>At a high-level, one architecture that works for such applications is something which is:</p>

      <ul>
      <li>
      <strong>Highly decoupled</strong>: encouraging modules to only publish and subscribe to events of interest rather than directly communicating with each other. This helps us to build applications who's units of code aren't highly tied (coupled) together and can thus be reused more easily.</li>
      <li>
      <strong>Supports module-level security</strong>: whereby modules are only able to execute behavior they've been permitted to. Application security is an area which is often overlooked in JavaScript applications, but can be quite easily implemented in a flexible manner.</li>
      <li>
      <strong>Supports failover</strong>: allowing an application continuing to function even if particular modules fail. The typical example I give of this is the GMail chat widget. Imagine being able to build applications in a way that if one widget on the page fails (e.g chat), the rest of your application (mail) can continue to function without being affected.</li>
      </ul><p>This is an architecture which has been implemented by a number of different companies in the past, including Yahoo! (for their modularized homepage - which Nicholas Zakas has <a href="http://www.youtube.com/watch?v=vXjVFPosQHw">spoken</a> about) and AOL for some of our upcoming projects.</p>

      <p>The three design patterns that make this architecture possible are the:</p>

      <ul>
      <li>
      <strong>Module pattern</strong>: used for encapsulating unique blocks of code, where functions and variables can be kept either public or private. ('private' in the simulation of privacy sense, as of course don't have true privacy in JavaScript)</li>
      <li>
      <strong>Mediator pattern</strong>: used when the communication between modules may be complex, but is still well defined. If it appears a system may have too many relationships between modules in your code, it may be time to have a central point of control, which is where the pattern fits in.</li>
      <li>
      <strong>Facade pattern</strong>: used for providing a convenient higher-level interface to a larger body of code, hiding its true underlying complexity</li>
      </ul><p>Their specific roles in this architecture can be found below.</p>

      <ul>
      <li>
      <strong>Modules</strong>: There are almost two concepts of what defines a module. As AMD is being used as a module wrapper, technically each model, view and collection can be considered a module. We then have the concept of modules being distinct blocks of code outside of just MVC/MV*. For the latter, these types of 'modules' are primarily concerned with broadcasting and subscribing to events of interest rather than directly communicating with each other.They are made possible through the Mediator pattern.</li>
      <li>
      <strong>Mediator</strong>: The mediator has a varying role depending on just how you wish to implement it. In my article, I mention using it as a module manager with the ability to start and stop modules at will, however when it comes to Backbone, I feel that simplifying it down to the role of a central 'controller' that provides pub/sub capabilities should suffice. One can of course go all out in terms of building a module system that supports module starting, stopping, pausing etc, however the scope of this is outside of this chapter.</li>
      <li>
      <strong>Facade</strong>: This acts as a secure middle-layer that both abstracts an application core (Mediator) and relays messages from the modules back to the Mediator so they don't touch it directly. The Facade also performs the duty of application security guard; it checks event notifications from modules against a configuration (permissions.js, which we will look at later) to ensure requests from modules are only processed if they are permitted to execute the behavior passed.</li>
      </ul><h3>
      <a name="user-content-practical-2" class="anchor" href="#practical-2"><span class="octicon octicon-link"></span></a>Practical</h3>

      <p>For the practical section of this chapter, we'll be extending the well-known Backbone Todo application using the three patterns mentioned above.</p>

      <p>The application is broken down into AMD modules that cover everything from Backbone models through to application-level modules. The views publish events of interest to the rest of the application and modules can then subscribe to these event notifications.</p>

      <p>All subscriptions from modules go through a facade (or sandbox). What this does is check against the subscriber name and the 'channel/notification' it's attempting to subscribe to. If a channel <em>doesn't</em> have permissions to be subscribed to (something established through permissions.js), the subscription isn't permitted.</p>

      <p><strong>Mediator</strong></p>

      <p>Found in <code>aura/mediator.js</code></p>

      <p>Below is a very simple AMD-wrapped implementation of the mediator pattern, based on prior work by Ryan Florence. It accepts as its input an object, to which it attaches <code>publish()</code> and <code>subscribe()</code> methods. In a larger application, the mediator can contain additional utilities, such as handlers for initializing, starting and stopping modules, but for demonstration purposes, these two methods should work fine for our needs.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">channels</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">subscription</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">subscription</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Facade</strong></p>

      <p>Found in <code>aura/facade.js</code></p>

      <p>Next, we have an implementation of the facade pattern. Now the classical facade pattern applied to JavaScript would probably look a little like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">_private</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">i</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span>
              <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'current value:'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
              <span class="p">},</span>
              <span class="nx">run</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'running'</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">jump</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jumping'</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">facade</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="nx">args</span><span class="p">.</span><span class="nx">run</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="nx">_private</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}());</span>

      <span class="nx">module</span><span class="p">.</span><span class="nx">facade</span><span class="p">({</span><span class="nx">run</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">val</span><span class="o">:</span><span class="mi">10</span><span class="p">});</span>
      <span class="c1">//outputs current value: 10, running</span>
      </pre></div>

      <p>It's effectively a variation of the module pattern, where instead of simply returning an interface of supported methods, your API can completely hide the true implementation powering it, returning something simpler. This allows the logic being performed in the background to be as complex as necessary, whilst all the end-user experiences is a simplified API they pass options to (note how in our case, a single method abstraction is exposed). This is a beautiful way of providing APIs that can be easily consumed.</p>

      <p>That said, to keep things simple, our implementation of an AMD-compatible facade will act a little more like a proxy. Modules will communicate directly through the facade to access the mediator's <code>publish()</code> and <code>subscribe()</code> methods, however, they won't as such touch the mediator directly.This enables the facade to provide application-level validation of any subscriptions and publications made.</p>

      <p>It also allows us to implement a simple, but flexible, permissions checker (as seen below) which will validate subscriptions made against a permissions configuration to see whether it's permitted or not.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span> <span class="s1">'../aura/mediator'</span> <span class="p">,</span> <span class="s1">'../aura/permissions'</span> <span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mediator</span><span class="p">,</span> <span class="nx">permissions</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">facade</span> <span class="o">=</span> <span class="nx">facade</span> <span class="o">||</span> <span class="p">{};</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>

              <span class="c1">// Note: Handling permissions/security is optional here</span>
              <span class="c1">// The permissions check can be removed</span>
              <span class="c1">// to just use the mediator directly.</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)){</span>
                  <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span> <span class="nx">channel</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">facade</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Permissions</strong></p>

      <p>Found in <code>aura/permissions.js</code></p>

      <p>In our simple permissions configuration, we support checking against subscription requests to establish whether they are allowed to clear. This enforces a flexible security layer for the application.</p>

      <p>To visually see how this works, consider changing say, permissions -&gt; renderDone -&gt; todoCounter to be false. This will completely disable the application from from rendering or displaying the counts component for Todo items left (because they aren't allowed to subscribe to that event notification). The rest of the Todo app can still however be used without issue.</p>

      <p>It's a very dumbed down example of the potential for application security, but imagine how powerful this might be in a large app with a significant number of visual widgets.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Permissions</span>

          <span class="c1">// A permissions structure can support checking</span>
          <span class="c1">// against subscriptions prior to allowing them</span>
          <span class="c1">// to clear. This enforces a flexible security</span>
          <span class="c1">// layer for your application.</span>

          <span class="kd">var</span> <span class="nx">permissions</span> <span class="o">=</span> <span class="p">{</span>

              <span class="nx">newContentAvailable</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">contentUpdater</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">endContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoSaver</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">beginContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">editFocus</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">addingNewTodo</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoTooltip</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">clearContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">garbageCollector</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">renderDone</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoCounter</span><span class="o">:</span><span class="kc">true</span> <span class="c1">//switch to false to see what happens :)</span>
              <span class="p">},</span>

              <span class="nx">destroyContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoRemover</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">createWhenEntered</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">keyboardManager</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">}</span>

          <span class="p">};</span>

          <span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">permissions</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">subscriber</span><span class="p">];</span>
              <span class="k">return</span> <span class="nx">test</span><span class="o">===</span><span class="kc">undefined</span><span class="o">?</span> <span class="kc">false</span><span class="o">:</span> <span class="nx">test</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="k">return</span> <span class="nx">permissions</span><span class="p">;</span>

      <span class="p">});</span>
      </pre></div>

      <p><strong>Subscribers</strong></p>

      <p>Found in <code>subscribers.js</code></p>

      <p>Subscriber 'modules' communicate through the facade back to the mediator and perform actions when a notification event of a particular name is published.</p>

      <p>For example, when a user enters in a new piece of text for a Todo item and hits 'enter' the application publishes a notification saying two things: a) a new Todo item is available and b) the text content of the new item is X. It's then left up to the rest of the application to do with this information whatever it wishes.</p>

      <p>In order to update your Backbone application to primarily use pub/sub, a lot of the work you may end up doing will be moving logic coupled inside of specific views to modules outside of it which are reactionary.</p>

      <p>Take the <code>todoSaver</code> for example - its responsibility is saving new Todo items to models once the a <code>notificationName</code> called 'newContentAvailable' has fired. If you take a look at the permissions structure in the last code sample, you'll notice that 'newContentAvailable' is present there. If I wanted to prevent subscribers from being able to subscribe to this notification, I simply set it to a boolean value of <code>false</code>.</p>

      <p>Again, this is a massive oversimplification of how advanced your permissions structures could get, but it's certainly one way of controlling what parts of your application can or can't be accessed by specific modules at any time.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'aura/facade'</span><span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">facade</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Subscription 'modules' for our views. These take the</span>
          <span class="c1">// the form facade.subscribe( subscriberName, notificationName , callBack )</span>

          <span class="c1">// Update view with latest todo content</span>
          <span class="c1">// Subscribes to: newContentAvailable</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'contentUpdater'</span><span class="p">,</span> <span class="s1">'newContentAvailable'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Save models when a user has finishes editing</span>
          <span class="c1">// Subscribes to: endContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoSaver'</span><span class="p">,</span><span class="s1">'endContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                      <span class="nx">content</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
                  <span class="p">});</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// Delete a todo when the user no longer needs it</span>
          <span class="c1">// Subscribes to: destroyContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoRemover'</span><span class="p">,</span><span class="s1">'destroyContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// When a user is adding a new entry, display a tooltip</span>
          <span class="c1">// Subscribes to: addingNewTodo</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoTooltip'</span><span class="p">,</span><span class="s1">'addingNewTodo'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">tooltip</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.ui-tooltip-top'</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span>
              <span class="nx">tooltip</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">();</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">)</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">||</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'placeholder'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                      <span class="nx">tooltip</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">fadeIn</span><span class="p">();</span>
                  <span class="p">};</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">show</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Update editing UI on switching mode to editing content</span>
          <span class="c1">// Subscribes to: beginContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'editFocus'</span><span class="p">,</span><span class="s1">'beginContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">});</span>


          <span class="c1">// Create a new todo entry</span>
          <span class="c1">// Subscribes to: createWhenEntered</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'keyboardManager'</span><span class="p">,</span><span class="s1">'createWhenEntered'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
              <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">());</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">});</span>



          <span class="c1">// A Todo and remaining entry counter</span>
          <span class="c1">// Subscribes to: renderDone</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoCounter'</span><span class="p">,</span><span class="s1">'renderDone'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                  <span class="nx">total</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">done</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">remaining</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
              <span class="p">}));</span>
          <span class="p">});</span>


          <span class="c1">// Clear all completed todos when clearContent is dispatched</span>
          <span class="c1">// Subscribes to: clearContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'garbageCollector'</span><span class="p">,</span><span class="s1">'clearContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">todo</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">});</span>
          <span class="p">});</span>


      <span class="p">});</span>
      </pre></div>

      <p>That's it for this section. If you've been intrigued by some of the concepts covered, I encourage you to consider taking a look at my <a href="http://addyosmani.com/blog/large-scale-javascript-application-architecture/">slides</a> on Large-scale JS from the jQuery Summit or my longer post on the topic <a href="http://addyosmani.com/largescalejavascript">here</a> for more information.</p>

      <h2>
      <a name="user-content-backbonemarionette" class="anchor" href="#backbonemarionette"><span class="octicon octicon-link"></span></a>Backbone.Marionette</h2>

      <p><em>By Derick Bailey &amp; Addy Osmani</em></p>

      <p>As we've seen, Backbone provides a great set of building blocks for our JavaScript applications. It gives us the core constructs that are needed to build small to mid-sized apps, organize jQuery DOM events, or create single page apps that support mobile devices and large scale enterprise needs. But Backbone is not a complete framework. It's a set of building blocks that leaves much of the application design, architecture and scalability to the developer, including memory management, view management and more.</p>

      <p><a href="http://marionettejs.com">Backbone.Marionette</a> (or just "Marionette") provides many of the features that the non-trivial application developer needs, above what Backbone itself provides. It is a composite application library that aims to simplify the construction of large scale applications. It does this by providing a collection of common design and implementation patterns found in the applications that the creator, <a href="http://lostechies.com/derickbailey/">Derick Bailey</a>, and many other <a href="https://github.com/marionettejs/backbone.marionette/graphs/contributors">contributors</a> have been using to build Backbone apps. </p>

      <p>Marionette's key benefits include:</p>

      <ul>
      <li>Scaling applications out with modular, event driven architecture</li>
      <li>Sensible defaults, such as using Underscore templates for view rendering</li>
      <li>Easy to modify to make it work with your application's specific needs</li>
      <li>Reducing boilerplate for views, with specialized view types</li>
      <li>Build on a modular architecture with an Application and modules that attach to it</li>
      <li>Compose your application's visuals at runtime, with Region and Layout</li>
      <li>Nested views and layouts within visual regions</li>
      <li>Built-in memory management and zombie killing in views, regions and layouts</li>
      <li>Built-in event clean up with the EventBinder</li>
      <li>Event-driven architecture with the EventAggregator</li>
      <li>Flexible, "as-needed" architecture allowing you to pick and choose what you need</li>
      <li>And much, much more</li>
      </ul><p>Marionette follows a similar philosophy to Backbone in that it provides a suite of components that can be used independently of each other, or used together to create a significant advantages for us as developers. But it steps above the structural components of Backbone and provides an application layer, with more than a dozen components and building blocks. </p>

      <p>Marionette's components range greatly in the features they provide, but they all work together to create a composite application layer that can both reduce boilerplate code and provide a much needed application structure. Its core components include:</p>

      <ul>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.md"><strong>Backbone.Marionette.Application</strong></a>: An application object that starts your app via initializers, and more</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.module.md"><strong>Backbone.Marionette.Application.module</strong></a>: Create modules and sub-modules within the application</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.approuter.md"><strong>Backbone.Marionette.AppRouter</strong></a>: Reduce your routers to nothing more than configuration</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.view.md"><strong>Backbone.Marionette.View</strong></a>: The base View type that other Marionette views extend from (not intended to be used directly)</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.itemview.md"><strong>Backbone.Marionette.ItemView</strong></a>: A view that renders a single item</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.collectionview.md"><strong>Backbone.Marionette.CollectionView</strong></a>: A view that iterates over a collection, and renders individual <code>ItemView</code> instances for each model</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.compositeview.md"><strong>Backbone.Marionette.CompositeView</strong></a>: A collection view and item view, for rendering leaf-branch/composite model hierarchies</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.region.md"><strong>Backbone.Marionette.Region</strong></a>: Manage visual regions of your application, including display and removal of content</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.layout.md"><strong>Backbone.Marionette.Layout</strong></a>: A view that renders a layout and creates region managers to manage areas within it</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventaggregator.md"><strong>Backbone.Marionette.EventAggregator</strong></a>: An extension of Backbone.Events, to be used as an event-driven or pub-sub tool</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventbinder.md"><strong>Backbone.Marionette.EventBinder</strong></a>: An event binding manager, to facilitate binding and unbinding of events</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.renderer.md"><strong>Backbone.Marionette.Renderer</strong></a>: Render templates with or without data, in a consistent and common manner</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.templatecache.md"><strong>Backbone.Marionette.TemplateCache</strong></a>: Cache templates that are stored in <code>&lt;script&gt;</code> blocks, for faster subsequent access</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.callbacks.md"><strong>Backbone.Marionette.Callbacks</strong></a>: Manage a collection of callback methods, and execute them as needed</li>
      </ul><p>But like Backbone itself, you're not required to use all of Marionette's components just because you want to use some of them. You can pick and choose which features you want to use, when. This allows you to work with other Backbone frameworks and plugins very easily. It also means that you are not required to engage in an all-or-nothing migration to begin using Marionette.</p>

      <h3>
      <a name="user-content-boilerplate-rendering-code" class="anchor" href="#boilerplate-rendering-code"><span class="octicon octicon-link"></span></a>Boilerplate Rendering Code</h3>

      <p>Consider the code that it typically requires to render a view with Backbone and Underscore template. We need a template to render, which can be placed in the DOM directly, and we need the JavaScript that defines a view to use the template, and populate that template with data from a model.</p>

      <pre><code>&lt;script type="text/html" id="my-view-template"&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;First Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= firstName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Last Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= lastName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Email:&lt;/label&gt;
          &lt;span&gt;&lt;%= email %&gt;&lt;/span&gt;
        &lt;div&gt;
      &lt;/script&gt;
      &lt;/pre&gt;
      </code></pre>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// compile the Underscore.js template</span>
          <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#my-view-template'</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">compiledTemplate</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// render the template with the model data</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">compiledTemplate</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

          <span class="c1">// populate the view with the rendered html</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Once this is in place, you need to create an instance of your view and pass your model in to it. Then you can take the view's <code>el</code> and append it to the DOM in order to display the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Derick'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Bailey'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'derickbailey@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre></div>

      <p>This is a standard set up for defining, building, rendering, and displaying a view with Backbone. This is also what we call "boilerplate code" - code that is repeated over and over and over again, across every project and every implementation of the same functionality. It gets to be very tedious and repetitious very quickly.</p>

      <p>Enter Marionette's <code>ItemView</code> - a simple way to reduce the boilerplate of defining a view.</p>

      <h3>
      <a name="user-content-reducing-boilerplate-with-marionetteitemview" class="anchor" href="#reducing-boilerplate-with-marionetteitemview"><span class="octicon octicon-link"></span></a>Reducing Boilerplate With Marionette.ItemView</h3>

      <p>All of Marionette's view types - with the exception of <code>Marionette.View</code> - include a built-in <code>render</code> method that handles the core rendering logic for you. By changing the <code>MyView</code> instance from <code>Backbone.View</code> then, we can take advantage of this. Instead of having to provide our own <code>render</code> method for the view, we can let Marionette render it for us. We'll still use the same Underscore.js template and rendering mechanism, but the implementation of this is hidden behind the scenes for us. Thus, we can reduce the amount of code needed for this view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span>
      <span class="p">});</span>
      </pre></div>

      <p>And that's it - that's all you need to get the exact same behaviour as the previous view implementation. Just replace <code>Backbone.View.extend</code> with <code>Backbone.Marionette.ItemView.extend</code>, then get rid of the <code>render</code> method. You can still create the view instance with a <code>model</code>, call the <code>render</code> method on the view instance, and display the view in the DOM the same way that we did before. But the view definition has been reduced to a single line of configuration for the template.</p>

      <h3>
      <a name="user-content-memory-management" class="anchor" href="#memory-management"><span class="octicon octicon-link"></span></a>Memory Management</h3>

      <p>In addition to the reduction of code needed to define a view, Marionette includes some advanced memory management in all of it's views, making the job of cleaning up a view instance and it's event handlers, easy.</p>

      <p>Consider the following view implementation:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>If we create two instances of this view using the same variable name for both instances, and then change a value in the model, how many times will we see the alert box? </p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre></div>

      <p>Since we're re-using the save <code>zombieView</code> variable for both instances, the first instance of the view will fall out of scope immediately after the second is created. This allows the JavaScript garbage collector to come along and clean it up, which should mean the first view instance is no longer active and no longer going to respond to the model's "change" event.</p>

      <p>But when we run this code, we end up with the alert box showing up twice!</p>

      <p>The problem is caused by the model event binding in the view's <code>initialize</code> method. Whenever we pass <code>this.render</code> as the callback method to the model's <code>on</code> event binding, the model itself is being given a direct reference to the view instance. Since the model is now holding a reference to the view instance, replacing the <code>zombieView</code> variable with a new view instance is not going to let the original view fall out of scope. The model still has a reference, therefore the view is still in scope. </p>

      <p>Since the original view is still in scope, and the second view instance is also in scope, changing data on the model will cause both view instances to respond.</p>

      <p>Fixing this is easy, though. You just need to call <code>off</code> when the view is done with it's work and ready to be closed. To do this, add a <code>close</code> method to the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Then call <code>close</code> on the first instance when it is no longer needed, and only one view instance will remain alive.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>
      <span class="nx">zombieView</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="c1">// double-tap the zombie</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre></div>

      <p>Now we only see once alert box when this code runs. </p>

      <p>Rather than having to manually remove these event handlers, though, we can let Marionette do it for us.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>Notice in this case we are using a method called <code>bindTo</code>. This method comes from Marionette's <code>EventBinder</code> object, and is added on to all of Marionette's view types. The <code>bindTo</code> method signature is similar to that of the <code>on</code> method, with the exception of passing the object that triggers the event as the first parameter. </p>

      <p>Marionette's views also provide a <code>close</code> event, in which the event bindings that are set up with the <code>bindTo</code> are automatically removed. This means we no longer need to define a <code>close</code> method directly, and when we use the <code>bindTo</code> method, we know that our events will be removed and our views will not turn in to zombies.</p>

      <p>But how do we automate the call to <code>close</code> on a view, in the real application? When and where do we call that? Enter the <code>Marionette.Region</code> - an object that manages the lifecycle of an individual view.</p>

      <h3>
      <a name="user-content-region-management" class="anchor" href="#region-management"><span class="octicon octicon-link"></span></a>Region Management</h3>

      <p>After a view is created, it typically needs to be placed in the DOM so that it becomes visible. This is usually done with a jQuery selector and setting the <code>html()</code> of the resulting object:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="c1">// show the view in the DOM</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre></div>

      <p>This, again, is boilerplate code. We shouldn't have to manually call <code>render</code> and manually select the DOM elements to show the view. Furthermore, this code doesn't lend itself to closing any previous view instance that might be attached to the DOM element we want to populate. And we've seen the danger of zombie views already.</p>

      <p>To solve these problems, Marionette provides a <code>Region</code> object - an object that manages the lifecycle of individual views, displayed in a particular DOM element.</p>

      <div class="highlight highlight-javascript"><pre><span class="c1">// create a region instance, telling it which DOM element to manage</span>
      <span class="kd">var</span> <span class="nx">myRegion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Region</span><span class="p">({</span>
        <span class="nx">el</span><span class="o">:</span> <span class="s1">'#content'</span>
      <span class="p">});</span>

      <span class="c1">// show a view in the region</span>
      <span class="kd">var</span> <span class="nx">view1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view1</span><span class="p">);</span>

      <span class="c1">// somewhere else in the code,</span>
      <span class="c1">// show a different view</span>
      <span class="kd">var</span> <span class="nx">view2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view2</span><span class="p">);</span>
      </pre></div>

      <p>There are several things to note, here. First, we're telling the region what DOM element to manage by specifying an <code>el</code> in the region instance. Second, we're no longer calling the <code>render</code> method on our views. And lastly, we're not calling <code>close</code> on our view, either, though this is getting called for us. </p>

      <p>When we use a region to manage the lifecycle of our views, and display the views in the DOM, the region itself handles these concerns. By passing a view instance in to the <code>show</code> method of the region, it will call the render method on the view for us. It will then take the resulting <code>el</code> of the view and populate the DOM element. </p>

      <p>The next time we call the <code>show</code> method of the region, the region remembers that it is currently displaying a view. The region calls the <code>close</code> method on the view, removes it from the DOM, and then proceeds to run the render &amp; display code for the new view that was passed in.</p>

      <p>Since the region handles calling <code>close</code> for us, and we're using the <code>bindTo</code> event binder in our view instance, we no longer have to worry about zombie views in our application.</p>

      <h3>
      <a name="user-content-marionette-todo-app" class="anchor" href="#marionette-todo-app"><span class="octicon octicon-link"></span></a>Marionette Todo app</h3>

      <p>Having learned about Marionette's high-level concepts, let's explore refactoring the Todo application we created in our first practical to use it. The complete code for this application can be found in Derick's TodoMVC <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">fork</a>.</p>

      <p>Our final implementation will be visually and functionally equivalent to the original app, as seen below.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo0.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo0.png" alt="" style="max-width:100%;"></a></p>

      <p>First, we define an application object representing our base TodoMVC app. This will contain initialisation code and define the default layout regions for our app. </p>

      <p><strong>TodoMVC.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoMVC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Application</span><span class="p">();</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">addRegions</span><span class="p">({</span>
        <span class="nx">header</span> <span class="o">:</span> <span class="s1">'#header'</span><span class="p">,</span>
        <span class="nx">main</span>   <span class="o">:</span> <span class="s1">'#main'</span><span class="p">,</span>
        <span class="nx">footer</span> <span class="o">:</span> <span class="s1">'#footer'</span>
      <span class="p">});</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'initialize:after'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>Regions are used to manage the content that's displayed within specific elements, and the <code>addRegions</code> method on the <code>TodoMVC</code> object is just a shortcut for creating <code>Region</code> objects. We supply a jQuery selector for each region to manage (e.g <code>#header</code>, <code>#main</code> and <code>#footer</code>) and then tell the region to show various Backbone views within that region.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo1.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo1.png" alt="" style="max-width:100%;"></a></p>

      <p>Once the application object has been initialised, we call <code>Backbone.history.start()</code> to route the initial URL.</p>

      <p>Next, we define our Layouts. A layout is a specialised type of view that extends from <code>Marionette.ItemView</code> directly. This means its intended to render a single template and may or may not have a model (or <code>item</code>) associated with the template.</p>

      <p>One of the main differences between a Layout and an <code>ItemView</code> is that the layout contains regions. When defining a Layout, we supply it with a <code>template</code> but also the regions that the template contains. After rendering the layout, we can display other views within the layout using the regions that were defined.</p>

      <p>In our TodoMVC Layout module below, we define Layouts for:</p>

      <ul>
      <li>Header: where we can create new Todos</li>
      <li>Footer: where we summarise how many Todos are remaining/have been completed</li>
      </ul><p>This captures some of the view logic that was previously in our <code>AppView</code> and <code>TodoView</code>.</p>

      <p>Note that Marionette modules (such as the below) offer a simple module system which are used to create privacy and encapsulation in Marionette apps. These certainly don't have to be used however, and later on in this section we'll provide links to alternative implementations using RequireJS + AMD instead.</p>

      <p><strong>TodoMVC.Layout.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Layout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Layout</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Layout Header View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-header'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">input</span> <span class="o">:</span> <span class="s1">'#new-todo'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>   <span class="s1">'onInputKeypress'</span>
          <span class="p">},</span>

          <span class="nx">onInputKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">title</span> <span class="o">:</span> <span class="nx">todoText</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Layout Footer View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-footer'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">count</span>   <span class="o">:</span> <span class="s1">'#todo-count strong'</span><span class="p">,</span>
            <span class="nx">filters</span> <span class="o">:</span> <span class="s1">'#filters a'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click #clear-completed'</span> <span class="o">:</span> <span class="s1">'onClearClick'</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">,</span> <span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateFilterSelection</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">updateCount</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">updateFilterSelection</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">filters</span>
              <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#'</span> <span class="o">+</span> <span class="nx">filter</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onClearClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getCompleted</span><span class="p">();</span>
            <span class="nx">completed</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">destroy</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>Next, we tackle application routing and workflow, such as controlling Layouts in the page which can be shown or hidden. </p>

      <p>Marionette uses the concept of an AppRouter to simplify routing. This reduces the boilerplate for handling route events and allows routers to be configured to call methods on an object directly. We configure our AppRouter using <code>appRoutes</code>.  </p>

      <p>This replaces the <code>'*filter': 'setFilter'</code> route defined in our original Workspace router, seen below:</p>

      <div class="highlight highlight-javascript"><pre>        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
                      <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
                              <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
                      <span class="p">},</span>

                      <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
                              <span class="c1">// Set the current filter to be used</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

                              <span class="c1">// Trigger a collection reset/addAll</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">);</span>
                      <span class="p">}</span>
              <span class="p">});</span>
      </pre></div>

      <p>The TodoList Controller, also found in this next code block, handles some of the remaining visibility logic originally found in <code>AppView</code> and <code>TodoView</code>, albeit using very readable Layouts.</p>

      <p><strong>TodoMVC.TodoList.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// TodoList Router</span>
        <span class="c1">// ---------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handle routes to show the active vs complete todo items</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">AppRouter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">appRoutes</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'filterItems'</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Controller (Mediator)</span>
        <span class="c1">// ------------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Control the workflow and logic that exists at the application</span>
        <span class="c1">// level, above the implementation detail of views and models</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="c1">// Start the app by showing the appropriate views</span>
          <span class="c1">// and fetching the list of todo items, if there are any</span>
          <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showHeader</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showFooter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showTodoList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">showHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showFooter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">footer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">footer</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">footer</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showTodoList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span><span class="p">({</span>
              <span class="nx">collection</span> <span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">}));</span>
          <span class="p">},</span>

          <span class="c1">// Set the filter to show complete or all items</span>
          <span class="nx">filterItems</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Initializer</span>
        <span class="c1">// --------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Get the TodoList up and running by initializing the mediator</span>
        <span class="c1">// when the the application is started, pulling in all of the</span>
        <span class="c1">// existing Todo items and displaying them.</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">addInitializer</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

          <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">();</span>
          <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span><span class="p">({</span>
            <span class="nx">controller</span><span class="o">:</span> <span class="nx">controller</span>
          <span class="p">});</span>

          <span class="nx">controller</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <h4>
      <a name="user-content-controllers-1" class="anchor" href="#controllers-1"><span class="octicon octicon-link"></span></a>Controllers</h4>

      <p>In this particular app, note that Controllers don't add a great deal to the overall workflow. In general however, Marionette's philosophy on routers is that they should be an after-thought in the implementation of applications. Quite often, we'll see many bad examples of developers abusing Backbone's routing system by making it the sole controller of the entire application workflow and logic. </p>

      <p>This inevitably leads to mashing every possible combination of code in to the router methods - view creation, model loading, coordinating different parts of the app, etc. Developers such as Derick views this as a violation of the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single-responsibility principle</a> (SRP) and separation of concerns. </p>

      <p>Backbone's router and history exists to deal with a specific aspect of browsers - managing the forward and back buttons. Marionette feels it should be limited to that, with the code that gets executed by the navigation being somewhere else. This allows the application to be used with or without a router. We can call a controller's "show" method from a button click, from an application event handler, or from a router, and we will end up with the same application state no matter how we called that method.</p>

      <p>Derick has written extensively about his thoughts on this topic, which you can read more about on his blog:</p>

      <ul>
      <li><a href="http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/">http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/">http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/">http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/</a></li>
      </ul><h4>
      <a name="user-content-compositeview" class="anchor" href="#compositeview"><span class="octicon octicon-link"></span></a>CompositeView</h4>

      <p>We then get to defining the actual views for individual Todo items and lists of items in our TodoMVC application. For this, we make use of Marionette's <code>CompositeView</code>s. The idea behind a CompositeView is that it represents a visualisation of a composite or hierarchical structure of leaves (or nodes) and branches. </p>

      <p>Think of these views as being a hierarchy of parent-child models, and recursive by default. For each item in a collection that the composite view is handling the same CompositeView type will be used to render the item. For non-recursive hierarchies, though, we are able to override the item view by defining an <code>itemView</code> attribute.</p>

      <p>For our Todo List Item View, we define it as an ItemView, then our Todo List View is a CompositeView where we override the <code>itemView</code> setting and tell it to use the Todo List item View for each item in the collection. </p>

      <p>TodoMVC.TodoList.Views.js</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList.Views'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Views</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo List Item View</span>
        <span class="c1">// -------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Display an individual todo item, and respond to changes</span>
        <span class="c1">// that are made to the item, including marking completed.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span> <span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
            <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoItemView'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">edit</span> <span class="o">:</span> <span class="s1">'.edit'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click .destroy'</span> <span class="o">:</span> <span class="s1">'destroy'</span><span class="p">,</span>
              <span class="s1">'dblclick label'</span> <span class="o">:</span> <span class="s1">'onEditClick'</span><span class="p">,</span>
              <span class="s1">'keypress .edit'</span> <span class="o">:</span> <span class="s1">'onEditKeypress'</span><span class="p">,</span>
              <span class="s1">'click .toggle'</span>  <span class="o">:</span> <span class="s1">'toggle'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'active completed'</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
              <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">destroy</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">().</span><span class="nx">save</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

              <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nx">todoText</span><span class="p">).</span><span class="nx">save</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Item List View</span>
        <span class="c1">// --------------</span>
        <span class="c1">//</span>
        <span class="c1">// Controls the rendering of the list of items, including the</span>
        <span class="c1">// filtering of active vs completed items for display.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoListCompositeView'</span><span class="p">,</span>
            <span class="nx">itemView</span> <span class="o">:</span> <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">,</span>
            <span class="nx">itemViewContainer</span> <span class="o">:</span> <span class="s1">'#todo-list'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">toggle</span> <span class="o">:</span> <span class="s1">'#toggle-all'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click #toggle-all'</span> <span class="o">:</span> <span class="s1">'onToggleAllClick'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">update</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">function</span> <span class="nx">reduceCompleted</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span> <span class="p">}</span>
              <span class="kd">var</span> <span class="nx">allCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">reduceCompleted</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">'checked'</span><span class="p">,</span> <span class="nx">allCompleted</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">onToggleAllClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">isChecked</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
                <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="s1">'completed'</span><span class="o">:</span> <span class="nx">isChecked</span><span class="p">});</span>
              <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Application Event Handlers</span>
        <span class="c1">// --------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handler for filtering the list of items by showing and</span>
        <span class="c1">// hiding through the use of various CSS classes</span>

        <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">filter</span> <span class="o">=</span> <span class="nx">filter</span> <span class="o">||</span> <span class="s1">'all'</span><span class="p">;</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'class'</span><span class="p">,</span> <span class="s1">'filter-'</span> <span class="o">+</span> <span class="nx">filter</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>At the end of the last code block, you will also notice an event handler using <code>vent</code>. This is an event aggregator that allows us to handle <code>filterItem</code> triggers from our TodoList controller.</p>

      <p>Finally, we define the model and collection for representing our Todo items. These are semantically not very different from the original versions we used in our first practical and have been re-written to better fit in with Derick's preferred style of coding.</p>

      <p><strong>Todos.js:</strong></p>

      <div class="highlight highlight-javascript"><pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Todos</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span>     <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">created</span>   <span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNew</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">getCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">getActive</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">_isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre></div>

      <p>We finally kick-start everything off in our application index file, by calling <code>start</code> on our main application object:</p>

      <p>Initialisation:</p>

      <div class="highlight highlight-javascript"><pre>      <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// Start the TodoMVC app (defined in js/TodoMVC.js)</span>
              <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="p">});</span>
      </pre></div>

      <p>And that's it!</p>

      <h3>
      <a name="user-content-is-the-marionette-implementation-of-the-todo-app-more-maintainable" class="anchor" href="#is-the-marionette-implementation-of-the-todo-app-more-maintainable"><span class="octicon octicon-link"></span></a>Is the Marionette implementation of the Todo app more maintainable?</h3>

      <p>Derick feels that maintainability largely comes down to modularity, separating responsibilities (SRP and SoC) and other related patterns for keeping concerns from being mixed together. It can however be difficult to simply extract things in to separate modules for the sake of extraction, abstraction, or dividing the concept down in to it's most finite parts. </p>

      <p>The Single Responsibility Principle (SRP) tells us quite the opposite - that we need to understand the context in which things change. What parts always change together, in <em>this</em> system? What parts can change independently? Without knowing this, we won't know what pieces should be broken out in to separate components and modules, vs put together in to the same module or object. </p>

      <p>The way Derick organizes his apps into modules is by creating a breakdown of concepts at each level. A higher level module is a higher level of concern - an aggregation of responsibilities. Each responsibility is broken down in to an expressive API set that is implemented by lower level modules (Dependency Inversion Principle). These are coordinated through a mediator - which he typically refers to as the Controller in a module. </p>

      <p>The way that Derick organizes his files also plays directly into maintainability and he has also written up posts about the importance of keeping a sane application folder structure that I recommend reading:</p>

      <ul>
      <li><a href="http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/">http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/</a></li>
      <li><a href="http://hilojs.codeplex.com/discussions/362875#post869640">http://hilojs.codeplex.com/discussions/362875#post869640</a></li>
      </ul><h3>
      <a name="user-content-marionette-and-flexibility" class="anchor" href="#marionette-and-flexibility"><span class="octicon octicon-link"></span></a>Marionette And Flexibility</h3>

      <p>Marionette is a flexible framework, much like Backbone itself. It offers a wide variety of tools to help create and organize an application architecture on top of Backbone, but like Backbone itself, it doesn't dictate that you have to use all of it's pieces in order to use any of them. </p>

      <p>The flexibility and versatility in Marionette is easiest to understand by examining three variations of TodoMVC that have been created for comparison purposes:</p>

      <ul>
      <li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/architecture-examples/backbone_marionette">Simple</a> - by Jarrod Oversion</li>
      <li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/dependency-examples/backbone_marionette_require">RequireJS</a> - also by Jarrod</li>
      <li>
      <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">Marionette modules</a> - by Derick Bailey</li>
      </ul><p><strong>The simple version</strong>: This version of TodoMVC shows some raw use of Marionette's various view types, an application object, and the event aggregator. The objects that are created are added directly to the global namespace and are fairly straightforward. This is a great example of how Marionette can be used to augment existing code without having to re-write everything around Marionette.</p>

      <p><strong>The RequireJS version</strong>: Using Marionette with RequireJS helps to create a modularized application architecture - a tremendously important concept in scaling JavaScript applications. RequireJS provides a powerful set of tools that can be leveraged to great advantage, making Marionette even more flexible than it already is.</p>

      <p><strong>The Marionette module version</strong>: RequireJS isn't the only way to create a modularized application architecture, though. For those that wish to build applications in modules and namespaces, Marionette provides a built-in module and namespacing structure. This example application takes the simple version of the application and re-writes it in to a namespaced application architecture, with an application controller (mediator / workflow object) that brings all of the pieces together.</p>

      <p>Marionette certainly provides its share of opinions in how a Backbone application should be architected. The combination of modules, view types, event aggregator, application objects, and more, can be used to create a very powerful and flexible architecture based on these opinions. </p>

      <p>But as you can see, Marionette isn't a completely rigid, "my way or the highway" framework. It provides many elements of an application foundation that can be mixed and matched with other architectural styles, such as AMD or namespacing, or provide simple augmentation to existing projects by reducing boilerplate code for rendering views. </p>

      <p>This flexibility creates a much greater opportunity for Marionette to provide value to you and your projects, as it allows you to scale the use of Marionette with your application's needs.</p>

      <h3>
      <a name="user-content-and-so-much-more" class="anchor" href="#and-so-much-more"><span class="octicon octicon-link"></span></a>And So Much More</h3>

      <p>This is just the tip of the proverbial ice-berg for Marionette, even for the <code>ItemView</code> and <code>Region</code> objects that we've explored. There is far more functionality, more features, and more flexibility and customizability that can be put to use in both of these objects. Then we have the other dozen or so components that Marionette provides, each with their own set of behaviors built in, customization and extension points, and more. </p>

      <p>To learn more about Marionette, it's components, the features they provide and how to use them, check out the Marionette documentation, links to the wiki, to the source code, the project core contributors, and much more at <a href="http://marionettejs.com">http://marionettejs.com</a>. </p>

      <p>&nbsp;</p>

      <p>&nbsp;</p>

      <h2>
      <a name="user-content-paginating-backbonejs-requests--collections" class="anchor" href="#paginating-backbonejs-requests--collections"><span class="octicon octicon-link"></span></a>Paginating Backbone.js Requests &amp; Collections</h2>

      <p>Pagination is a ubiquitous problem we often find ourselves needing to solve on the web. Perhaps most predominantly when working with back-end APIs and JavaScript-heavy clients which consume them.</p>

      <p>On this topic, we're going to go through a set of <strong>pagination components</strong> I wrote for Backbone.js, which should hopefully come in useful if you're working on applications which need to tackle this problem. They're part of an extension called <a href="http://github.com/addyosmani/backbone.paginator">Backbone.Paginator</a>.</p>

      <p>When working with a structural framework like Backbone.js, the three types of pagination we are most likely to run into are:</p>

      <p><strong>Requests to a service layer (API)</strong>- e.g query for results containing the term 'Brendan' - if 5,000 results are available only display 20 results per page (leaving us with 250 possible result pages that can be navigated to).</p>

      <p>This problem actually has quite a great deal more to it, such as maintaining persistence of other URL parameters (e.g sort, query, order) which can change based on a user's search configuration in a UI. One also had to think of a clean way of hooking views up to this pagination so you can easily navigate between pages (e.g First, Last, Next, Previous, 1,2,3), manage the number of results displayed per page and so on.</p>

      <p><strong>Further client-side pagination of data returned -</strong> e.g we've been returned a JSON response containing 100 results. Rather than displaying all 100 to the user, we only display 20 of these results within a navigatable UI in the browser.</p>

      <p>Similar to the request problem, client-pagination has its own challenges like navigation once again (Next, Previous, 1,2,3), sorting, order, switching the number of results to display per page and so on.</p>

      <p><strong>Infinite results</strong> - with services such as Facebook, the concept of numeric pagination is instead replaced with a 'Load More' or 'View More' button. Triggering this normally fetches the next 'page' of N results but rather than replacing the previous set of results loaded entirely, we simply append to them instead.</p>

      <p>A request pager which simply appends results in a view rather than replacing on each new fetch is effectively an 'infinite' pager.</p>

      <p><strong>Let's now take a look at exactly what we're getting out of the box:</strong></p>

      <p><em>Paginator is a set of opinionated components for paginating collections of data using Backbone.js. It aims to provide both solutions for assisting with pagination of requests to a server (e.g an API) as well as pagination of single-loads of data, where we may wish to further paginate a collection of N results into M pages within a view.</em></p>

      <h2>
      <a name="user-content-paginators-pieces" class="anchor" href="#paginators-pieces"><span class="octicon octicon-link"></span></a>Paginator's pieces</h2>

      <p>Backbone.Paginator supports two main pagination components:</p>

      <ul>
      <li>
      <strong>Backbone.Paginator.requestPager</strong>: For pagination of requests between a client and a server-side API</li>
      <li>
      <strong>Backbone.Paginator.clientPager</strong>: For pagination of data returned from a server which you would like to further paginate within the UI (e.g 60 results are returned, paginate into 3 pages of 20)</li>
      </ul><h2>
      <a name="user-content-live-examples" class="anchor" href="#live-examples"><span class="octicon octicon-link"></span></a>Live Examples</h2>

      <p>Live previews of both pagination components using the Netflix API can be found below. Fork the repository to experiment with these examples further.</p>

      <ul>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-request-paging/index.html">Backbone.Paginator.requestPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-client-paging/index.html">Backbone.Paginator.clientPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-infinite-paging/index.html">Infinite Pagination (Backbone.Paginator.requestPager())</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/google-diacritic/index.html">Diacritic Plugin</a></li>
      </ul><h2>
      <a name="user-content-paginatorrequestpager" class="anchor" href="#paginatorrequestpager"><span class="octicon octicon-link"></span></a>Paginator.requestPager</h2>

      <p>In this section we're going to walkthrough actually using the requestPager.</p>

      <h4>
      <a name="user-content-1-create-a-new-paginated-collection" class="anchor" href="#1-create-a-new-paginated-collection"><span class="octicon octicon-link"></span></a>1. Create a new Paginated collection</h4>

      <p>First, we define a new Paginated collection using <code>Backbone.Paginator.requestPager()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">requestPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      </pre></div>

      <h4>
      <a name="user-content-2-set-the-model-for-the-collection-as-normal" class="anchor" href="#2-set-the-model-for-the-collection-as-normal"><span class="octicon octicon-link"></span></a>2: Set the model for the collection as normal</h4>

      <p>Within our collection, we then (as normal) specify the model to be used with this collection followed by the URL (or base URL) for the service providing our data (e.g the Netflix API).</p>

      <div class="highlight highlight-javascript"><pre>        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre></div>

      <h4>
      <a name="user-content-3-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#3-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>3. Configure the base URL and the type of the request</h4>

      <p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/Catalog/People(49446)/TitlesActedIn?'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-4-configure-how-the-library-will-show-the-results" class="anchor" href="#4-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>4. Configure how the library will show the results</h4>

      <p>We need to tell the library how many items per page would we like to see, etc...</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-5-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#5-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>5. Configure the parameters we want to send to the server</h4>

      <p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-6-finally-configure-collectionparse-and-were-done" class="anchor" href="#6-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>6. Finally, configure Collection.parse() and we're done</h4>

      <p>The last thing we need to do is configure our collection's <code>parse()</code> method. We want to ensure we're returning the correct part of our JSON response containing the data our collection will be populated with, which below is <code>response.d.results</code> (for the Netflix API).</p>

      <p>You might also notice that we're setting <code>this.totalPages</code> to the total page count returned by the API. This allows us to define the maximum number of (result) pages available for the current/last request so that we can clearly display this in the UI. It also allows us to infuence whether clicking say, a 'next' button should proceed with a request or not.</p>

      <div class="highlight highlight-javascript"><pre>        <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// Be sure to change this based on how your results</span>
                  <span class="c1">// are structured (e.g d.results is Netflix specific)</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="c1">//Normally this.totalPages would equal response.d.__count</span>
                  <span class="c1">//but as this particular NetFlix request only returns a</span>
                  <span class="c1">//total count of items for the search, we divide.</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">totalPages</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">__count</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span><span class="p">);</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-convenience-methods" class="anchor" href="#convenience-methods"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>

      <p>For your convenience, the following methods are made available for use in your views to interact with the <code>requestPager</code>:</p>

      <ul>
      <li>
      <strong>Collection.goTo( n, options )</strong> - go to a specific page</li>
      <li>
      <strong>Collection.requestNextPage( options )</strong> - go to the next page</li>
      <li>
      <strong>Collection.requestPreviousPage( options )</strong> - go to the previous page</li>
      <li>
      <strong>Collection.howManyPer( n )</strong> - set the number of items to display per page</li>
      </ul><p><strong>requestPager</strong> collection's methods <code>.goTo()</code>, <code>.requestNextPage()</code> and <code>.requestPreviousPage()</code> are all extension of the original <a href="http://documentcloud.github.com/backbone/#Collection-fetch">Backbone Collection.fetch() method</a>. As so, they all can take the same option object as parameter.</p>

      <p>This option object can use <code>success</code> and <code>error</code> parameters to pass a function to be executed after server answer.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre></div>

      <p>To manage callback, you could also use the <a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHR</a> returned by these methods to manage callback.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span>
        <span class="p">.</span><span class="nx">requestNextPage</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// do something after server request is complete</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>If you'd like to add the incoming models to the current collection, instead of replacing the collection's contents, pass <code>{add: true}</code> as an option to these methods.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">requestPreviousPage</span><span class="p">({</span> <span class="nx">add</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-paginatorclientpager" class="anchor" href="#paginatorclientpager"><span class="octicon octicon-link"></span></a>Paginator.clientPager</h2>

      <p>The <code>clientPager</code> works similar to the <code>requestPager</code>, except that our configuration values influence the pagination of data already returned at a UI-level. Whilst not shown (yet) there is also a lot more UI logic that ties in with the <code>clientPager</code>. An example of this can be seen in 'views/clientPagination.js'.</p>

      <h4>
      <a name="user-content-1-create-a-new-paginated-collection-with-a-model-and-url" class="anchor" href="#1-create-a-new-paginated-collection-with-a-model-and-url"><span class="octicon octicon-link"></span></a>1. Create a new paginated collection with a model and URL</h4>

      <p>As with <code>requestPager</code>, let's first create a new Paginated <code>Backbone.Paginator.clientPager</code> collection, with a model:</p>

      <div class="highlight highlight-javascript"><pre>    <span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre></div>

      <h4>
      <a name="user-content-2-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#2-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>2. Configure the base URL and the type of the request</h4>

      <p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/v2/Catalog/Titles?&amp;'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-3-configure-how-the-library-will-show-the-results" class="anchor" href="#3-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>3. Configure how the library will show the results</h4>

      <p>We need to tell the library how many items per page would we like to see, etc...</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-4-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#4-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>4. Configure the parameters we want to send to the server</h4>

      <p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">'substringof(\'america\',Name)'</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre></div>

      <h4>
      <a name="user-content-5-finally-configure-collectionparse-and-were-done" class="anchor" href="#5-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>5. Finally, configure Collection.parse() and we're done</h4>

      <p>And finally we have our <code>parse()</code> method, which in this case isn't concerned with the total number of result pages available on the server as we have our own total count of pages for the paginated data in the UI.</p>

      <div class="highlight highlight-javascript"><pre>    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-convenience-methods-1" class="anchor" href="#convenience-methods-1"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>

      <p>As mentioned, your views can hook into a number of convenience methods to navigate around UI-paginated data. For <code>clientPager</code> these include:</p>

      <ul>
      <li>
      <strong>Collection.goTo(n)</strong> - go to a specific page</li>
      <li>
      <strong>Collection.previousPage()</strong> - go to the previous page</li>
      <li>
      <strong>Collection.nextPage()</strong> - go to the next page</li>
      <li>
      <strong>Collection.howManyPer(n)</strong> - set how many items to display per page</li>
      <li>
      <strong>Collection.setSort(sortBy, sortDirection)</strong> - update sort on the current view. Sorting will automatically detect if you're trying to sort numbers (even if they're strored as strings) and will do the right thing.</li>
      <li>
      <strong>Collection.setFilter(filterFields, filterWords)</strong> - filter the current view. Filtering supports multiple words without any specific order, so you'll basically get a full-text search ability. Also, you can pass it only one field from the model, or you can pass an array with fields and all of them will get filtered. Last option is to pass it an object containing a comparison method and rules. Currently, only <code>levenshtein</code> method is available.</li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">setFilter</span><span class="p">(</span>
          <span class="p">{</span><span class="s1">'Name'</span><span class="o">:</span> <span class="p">{</span><span class="nx">cmp_method</span><span class="o">:</span> <span class="s1">'levenshtein'</span><span class="p">,</span> <span class="nx">max_distance</span><span class="o">:</span> <span class="mi">7</span><span class="p">}}</span>
          <span class="p">,</span> <span class="s1">'Amreican P'</span> <span class="c1">// Note the switched 'r' and 'e', and the 'P' from 'Pie'</span>
        <span class="p">);</span>
      </pre></div>

      <p>Also note that the levenshtein plugin should be loaded and enabled using the <code>useLevenshteinPlugin</code> variable.</p>

      <p>Last but not less important: Performing Levenshtein comparison returns the <code>distance</code> between to strings. It won't let you <em>search</em> lenghty text.</p>

      <p>The distance between two strings means the number of characters that should be added, removed or moved to the left or to the right so the strings get equal.</p>

      <p>That means that comparing "Something" in "This is a test that could show something" will return 32, which is bigger than comparing "Something" and "ABCDEFG" (9).</p>

      <p>Use levenshtein only for short texts (titles, names, etc).</p>

      <ul>
      <li><p><strong>Collection.doFakeFilter(filterFields, filterWords)</strong> - returns the models count after fake-applying a call to <code>Collection.setFilter</code>.</p></li>
      <li><p><strong>Collection.setFieldFilter(rules)</strong> - filter each value of each model according to <code>rules</code> that you pass as argument. Example: You have a collection of books with 'release year' and 'author'. You can filter only the books that were released between 1999 and 2003. And then you can add another <code>rule</code> that will filter those books only to authors who's name start with 'A'. Possible rules: function, required, min, max, range, minLength, maxLength, rangeLength, oneOf, equalTo, pattern.</p></li>
      </ul><div class="highlight highlight-javascript"><pre>  <span class="nx">my_collection</span><span class="p">.</span><span class="nx">setFieldFilter</span><span class="p">([</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'release_year'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'range'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="s1">'1999'</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="s1">'2003'</span><span class="p">}},</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'author'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'pattern'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'A*'</span><span class="p">,</span> <span class="s1">'igm'</span><span class="p">)}</span>
        <span class="p">]);</span>

        <span class="c1">//Rules:</span>
        <span class="c1">//</span>
        <span class="c1">//var my_var = 'green';</span>
        <span class="c1">//</span>
        <span class="c1">//{field: 'color', type: 'equalTo', value: my_var}</span>
        <span class="c1">//{field: 'color', type: 'function', value: function(field_value){ return field_value == my_var; } }</span>
        <span class="c1">//{field: 'color', type: 'required'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'min', value: '2'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'max', value: '4'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'range', value: {min: '2', max: '4'} }</span>
        <span class="c1">//{field: 'color_name', type: 'minLength', value: '4'}</span>
        <span class="c1">//{field: 'color_name', type: 'maxLength', value: '6'}</span>
        <span class="c1">//{field: 'color_name', type: 'rangeLength', value: {min: '4', max: '6'}}</span>
        <span class="c1">//{field: 'color_name', type: 'oneOf', value: ['green', 'yellow']}</span>
        <span class="c1">//{field: 'color_name', type: 'pattern', value: new RegExp('gre*', 'ig')}</span>

      </pre></div>

      <ul>
      <li>
      <strong>Collection.doFakeFieldFilter(rules)</strong> - returns the models count after fake-applying a call to <code>Collection.setFieldFilter</code>.</li>
      </ul><h4>
      <a name="user-content-implementation-notes" class="anchor" href="#implementation-notes"><span class="octicon octicon-link"></span></a>Implementation notes:</h4>

      <p>You can use some variables in your <code>View</code> to represent the actual state of the paginator.</p>

      <p><code>totalUnfilteredRecords</code> - Contains the number of records, including all records filtered in any way. (Only available in <code>clientPager</code>)</p>

      <p><code>totalRecords</code> - Contains the number of records</p>

      <p><code>currentPage</code> - The actual page were the paginator is at.</p>

      <p><code>perPage</code> - The number of records the paginator will show per page.</p>

      <p><code>totalPages</code> - The number of total pages.</p>

      <p><code>startRecord</code> - The posicion of the first record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>

      <p><code>endRecord</code> - The posicion of the last record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>

      <h2>
      <a name="user-content-plugins" class="anchor" href="#plugins"><span class="octicon octicon-link"></span></a>Plugins</h2>

      <p><strong>Diacritic.js</strong></p>

      <p>A plugin for Backbone.Paginator that replaces diacritic characters (ă,ş,ţ etc) with characters that match them most closely. This is particularly useful for filtering.</p>

      <p>To enable the plugin, set <code>this.useDiacriticsPlugin</code> to true, as can be seen in the example below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default values used when sorting and/or filtering.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">useDiacriticsPlugin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// use diacritics plugin if available</span>
          <span class="p">...</span>
      </pre></div>

      <h1>
      <a name="user-content-mobile-applications" class="anchor" href="#mobile-applications"><span class="octicon octicon-link"></span></a>Mobile Applications</h1>

      <h2>
      <a name="user-content-backbone--jquery-mobile" class="anchor" href="#backbone--jquery-mobile"><span class="octicon octicon-link"></span></a>Backbone &amp; jQuery Mobile</h2>

      <h3>
      <a name="user-content-resolving-the-routing-conflicts" class="anchor" href="#resolving-the-routing-conflicts"><span class="octicon octicon-link"></span></a>Resolving the routing conflicts</h3>

      <p>The first major hurdle developers typically run into when building Backbone applications with jQuery Mobile is that both frameworks have their own opinions about how to handle application navigation.</p>

      <p>Backbone's routers offer an explicit way to define custom navigation routes through <code>Backbone.Router</code>, whilst jQuery Mobile encourages the use of URL hash fragments to reference separate 'pages' or views in the same document. jQuery Mobile also supports automatically pulling in external content for links through XHR calls meaning that there can be quite a lot of inter-framework confusion about what a link pointing at '#photo/id' should actually be doing.</p>

      <p>Some of the solutions that have been previously proposed to work-around this problem included manually patching Backbone or jQuery Mobile. I discourage opting for these techniques as it becomes necessary to manually patch your framework builds when new releases get made upstream.</p>

      <p>There's also <a href="https://github.com/azicchetti/jquerymobile-router">jQueryMobile router</a>, which tries to solve this problem differently, however I think my proposed solution is both simpler and allows both frameworks to cohabit quite peacefully without the need to extend either. What we're after is a way to prevent one framework from listening to hash changes so that we can fully rely on the other (e.g. <code>Backbone.Router</code>) to handle this for us exclusively.</p>

      <p>Using jQuery Mobile this can be done by setting:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">hashListeningEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre></div>

      <p>prior to initializing any of your other code.</p>

      <p>I discovered this method looking through some jQuery Mobile commits that didn't make their way into the official docs, but am happy to see that they are now covered here <a href="http://jquerymobile.com/test/docs/api/globalconfig.html">http://jquerymobile.com/test/docs/api/globalconfig.html</a> in more detail.</p>

      <p>The next question that arises is, if we're preventing jQuery Mobile from listening to URL hash changes, how can we still get the benefit of being able to navigate to other sections in a document using the built-in transitions and effects supported? Good question. This can now be solve by simply calling <code>$.mobile.changePage()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'#about'</span><span class="p">,</span>
          <span class="nx">effect</span> <span class="o">=</span> <span class="s1">'slideup'</span><span class="p">,</span>
          <span class="nx">reverse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">changeHash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">changePage</span><span class="p">(</span> <span class="nx">url</span> <span class="p">,</span> <span class="p">{</span> <span class="nx">transition</span><span class="o">:</span> <span class="nx">effect</span><span class="p">},</span> <span class="nx">reverse</span><span class="p">,</span> <span class="nx">changeHash</span> <span class="p">);</span>
      </pre></div>

      <p>In the above sample, <code>url</code> can refer to a URL or a hash identifier to navigate to, <code>effect</code> is simply the transition effect to animate the page in with and the final two parameters decide the direction for the transition (<code>reverse</code>) and whether or not the hash in the address bar should be updated (<code>changeHash</code>). With respect to the latter, I typically set this to false to avoid managing two sources for hash updates, but feel free to set this to true if you're comfortable doing so.</p>

      <p><strong>Note:</strong> For some parallel work being done to explore how well the jQuery Mobile Router plugin works with Backbone, you may be interested in checking out <a href="https://github.com/Filirom1/jquery-mobile-backbone-requirejs">https://github.com/Filirom1/jquery-mobile-backbone-requirejs</a>.</p>

      <h3>
      <a name="user-content-practical-a-backbone-requirejsamd-app-with-jquery-mobile" class="anchor" href="#practical-a-backbone-requirejsamd-app-with-jquery-mobile"><span class="octicon octicon-link"></span></a>Practical: A Backbone, Require.js/AMD app with jQuery Mobile</h3>

      <p><strong>Note:</strong> The code for this practical can be found in <code>practicals/modular-mobile-app</code>.</p>

      <h3>
      <a name="user-content-getting-started-2" class="anchor" href="#getting-started-2"><span class="octicon octicon-link"></span></a>Getting started</h3>

      <p>Once you feel comfortable with the <a href="http://msdn.microsoft.com/en-us/scriptjunkie/hh377172.aspx">Backbone fundamentals</a> and you've put together a rough wireframe of the app you may wish to build, start to think about your application architecture. Ideally, you'll want to logically separate concerns so that it's as easy as possible to maintain the app in the future.</p>

      <p><strong>Namespacing</strong></p>

      <p>For this application, I opted for the nested namespacing pattern. Implemented correctly, this enables you to clearly identify if items being referenced in your app are views, other modules and so on. This initial structure is a sane place to also include application defaults (unless you prefer maintaining those in a separate file).</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">||</span> <span class="p">{</span>
          <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">appview</span><span class="o">:</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">routers</span><span class="o">:</span><span class="p">{</span>
              <span class="nx">workspace</span><span class="o">:</span><span class="k">new</span> <span class="nx">Workspace</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">utils</span><span class="o">:</span> <span class="nx">utils</span><span class="p">,</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">resultsPerPage</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
              <span class="nx">safeSearch</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nx">maxDate</span><span class="o">:</span><span class="s1">''</span><span class="p">,</span>
              <span class="nx">minDate</span><span class="o">:</span><span class="s1">'01/01/1970'</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong>Models</strong></p>

      <p>In the Flickly application, there are at least two unique types of data that need to be modeled - search results and individual photos, both of which contain additional meta-data like photo titles. If you simplify this down, search results are actually groups of photos in their own right, so the application only requires:</p>

      <ul>
      <li>A single model (a photo or 'result' entry)</li>
      <li>A result collection (containing a group of result entries) for search results</li>
      <li>A photo collection (containing one or more result entries) for individual photos or photos with more than one image</li>
      </ul><p><strong>Views</strong></p>

      <p>The views we'll need include an application view, a search results view and a photo view. Static views or pages of the single-page application which do not require a dynamic element to them (e.g an 'about' page) can be easily coded up in your document's markup, independent of Backbone.</p>

      <p><strong>Routers</strong></p>

      <p>A number of possible routes need to be taken into consideration:</p>

      <ul>
      <li>Basic search queries <code>#search/kiwis</code>
      </li>
      <li>Search queries with additional parameters (e.g sort, pagination) <code>#search/kiwis/srelevance/p7</code>
      </li>
      <li>Queries for specific photos <code>#photo/93839</code>
      </li>
      <li>A default route (no parameters passed)</li>
      </ul><p>This tutorial will be expanded shortly to fully cover the demo application. In the mean time, please see the practicals folder for the completed application that demonstrates the router resolution discussed earlier between Backbone and jQuery Mobile.</p>

      <h3>
      <a name="user-content-jquery-mobile-going-beyond-mobile-application-development" class="anchor" href="#jquery-mobile-going-beyond-mobile-application-development"><span class="octicon octicon-link"></span></a>jQuery Mobile: Going beyond mobile application development</h3>

      <p>The majority of jQM apps I've seen in production have been developed for the purpose of providing an optimal experience to users on mobile devices. Given that the framework was developed for this purpose, there's nothing fundamentally wrong with this, but many developers forget that jQM is a UI framework not dissimilar to jQuery UI. It's using the widget factory and is capable of being used for a lot more than we give it credit for.</p>

      <p>If you open up Flickly in a desktop browser, you'll get an image search UI that's modeled on Google.com, however, review the components (buttons, text inputs, tabs) on the page for a moment. The desktop UI doesn't look anything like a mobile application yet I'm still using jQM for theming mobile components; the tabs, date-picker, sliders - everything in the desktop UI is re-using what jQM would be providing users on mobile devices. Thanks to some media queries, the desktop UI can make optimal use of whitespace, expanding component blocks out and providing alternative layouts whilst still making use of jQM as a component framework.</p>

      <p>The benefit of this is that I don't need to go pulling in jQuery UI separately to be able to take advantage of these features. Thanks to the recent ThemeRoller my components can look pretty much exactly how I would like them to and users of the app can get a jQM UI for lower-resolutions and a jQM-ish UI for everything else.</p>

      <p>The takeaway here is just to remember that if you're not (already) going through the hassle of conditional script/style loading based on screen-resolution (using matchMedia.js etc), there are simpler approaches that can be taken to cross-device component theming.</p>

      <h1>
      <a name="user-content-unit-testing" class="anchor" href="#unit-testing"><span class="octicon octicon-link"></span></a>Unit Testing</h1>

      <h2>
      <a name="user-content-unit-testing-backbone-applications-with-jasmine" class="anchor" href="#unit-testing-backbone-applications-with-jasmine"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With Jasmine</h2>

      <h2>
      <a name="user-content-introduction-3" class="anchor" href="#introduction-3"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>One definition of unit testing is the process of taking the smallest piece of testable code in an application, isolating it from the remainder of your codebase and determining if it behaves exactly as expected. In this section, we'll be taking a look at how to unit test Backbone applications using a popular JavaScript testing framework called <a href="http://pivotal.github.com/jasmine/">Jasmine</a> from Pivotal Labs.</p>

      <p>For an application to be considered 'well'-tested, distinct functionality should ideally have its own separate unit tests where it's tested against the different conditions you expect it to work under. All tests must pass before functionality is considered 'complete'. This allows developers to both modify a unit of code and its dependencies with a level of confidence about whether these changes have caused any breakage.</p>

      <p>As a basic example of unit testing is where a developer may wish to assert whether passing specific values through to a sum function results in the correct output being returned. For an example more relevant to this book, we may wish to assert whether a user adding a new Todo item to a list correctly adds a Model of a specific type to a Todos Collection.</p>

      <p>When building modern web-applications, it's typically considered best-practice to include automated unit testing as a part of your development process. Whilst we'll be focusing on Jasmine as a solution for this, there are a number of other alternatives worth considering, including QUnit.</p>

      <h2>
      <a name="user-content-jasmine" class="anchor" href="#jasmine"><span class="octicon octicon-link"></span></a>Jasmine</h2>

      <p>Jasmine describes itself as a behavior-driven development (BDD) framework for testing JavaScript code. Before we jump into how the framework works, it's useful to understand exactly what <a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">BDD</a> is.</p>

      <p>BDD is a second-generation testing approach first described by <a href="http://dannorth.net/introducing-bdd/">Dan North</a> (the authority on BDD) which attempts to test the behavior of software. It's considered second-generation as it came out of merging ideas from Domain driven design (DDD) and lean software development, helping teams to deliver high quality software by answering many of the more confusing questions early on in the agile process. Such questions commonly include those concerning documentation and testing.</p>

      <p>If you were to read a book on BDD, it's likely to also be described as being 'outside-in and pull-based'. The reason for this is that it borrows the idea of pulling features from Lean manufacturing which effectively ensures that the right software solutions are being written by a) focusing on expected outputs of the system and b) ensuring these outputs are achieved.</p>

      <p>BDD recognizes that there are usually multiple stakeholders in a project and not a single amorphous user of the system. These different groups will be affected by the software being written in differing ways and will have a varying opinion of what quality in the system means to them. It's for this reason that it's important to understand who the software will be bringing value you and exactly what in it will be valuable to them.</p>

      <p>Finally, BDD relies on automation. Once you've defined the quality expected, your team will likely want to check on the functionality of the solution being built regularly and compare it to the results they expect. In order to facilitate this efficiently, the process has to be automated. BDD relies heavily on the automation of specification-testing and Jasmine is a tool which can assist with this.</p>

      <p>BDD helps both developers and non-technical stakeholders:</p>

      <ul>
      <li>Better understand and represent the models of the problems being solved</li>
      <li>Explain supported tests cases in a language that non-developers can read</li>
      <li>Focus on minimizing translation of the technical code being written and the domain language spoken by the business</li>
      </ul><p>What this means is that developers should be able to show Jasmine unit tests to a project stakeholder and (at a high level, thanks to a common vocabulary being used) they'll ideally be able to understand what the code supports.</p>

      <p>Developers often implement BDD in unison with another testing paradigm known as <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> (test-driven development). The main idea behind TDD is:</p>

      <ul>
      <li>Write unit tests which describe the functionality you would like your code to support</li>
      <li>Watch these tests fail (as the code to support them hasn't yet been written)</li>
      <li>Write code to make the tests pass</li>
      <li>Rinse, repeat and refactor</li>
      </ul><p>In this chapter we're going to use both BDD (with TDD) to write unit tests for a Backbone application.</p>

      <p><strong><em>Note:</em></strong> I've seen a lot of developers also opt for writing tests to validate behavior of their code after having written it. While this is fine, note that it can come with pitfalls such as only testing for behavior your code currently supports, rather than behavior the problem needs to be supported.</p>

      <h2>
      <a name="user-content-suites-specs--spies" class="anchor" href="#suites-specs--spies"><span class="octicon octicon-link"></span></a>Suites, Specs &amp; Spies</h2>

      <p>When using Jasmine, you'll be writing suites and specifications (specs). Suites basically describe scenarios whilst specs describe what can be done in these scenarios.</p>

      <p>Each spec is a JavaScript function, described with a call to <code>it()</code> using a description string and a function. The description should describe the behaviour the particular unit of code should exhibit and keeping in mind BDD, it should ideally be meaningful. Here's an example of a basic spec:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="p">});</span>
      </pre></div>

      <p>On its own, a spec isn't particularly useful until expectations are set about the behavior of the code. Expectations in specs are defined using the <code>expect()</code> function and an <a href="https://github.com/pivotal/jasmine/wiki/Matchers">expectation matcher</a> (e.g <code>toEqual()</code>, <code>toBeTruthy()</code>, <code>toContain()</code>). A revised example using an expectation matcher would look like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>The above code passes our behavioral expectation as <code>counter</code> equals 1. Notice how easy this was to read the expectation on the last line (you probably grokked it without any explanation).</p>

      <p>Specs are grouped into suites which we describe using Jasmine's <code>describe()</code> function, again passing a string as a description and a function. The name/description for your suite is typically that of the component or module you're testing.</p>

      <p>Jasmine will use it as the group name when it reports the results of the specs you've asked it to run. A simple suite containing our sample spec could look like:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>Suites also share a functional scope and so it's possible to declare variables and functions inside a describe block which are accessible within specs:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 1</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 2</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p><strong><em>Note:</em></strong> Suites are executed in the order in which they are described, which can be useful to know if you would prefer to see test results for specific parts of your application reported first.</p>

      <p>Jasmine also supports <strong>spies</strong> - a way to mock, spy and fake behavior in our unit tests. Spies replace the function they're spying on, allowing us to simulate behavior we would like to mock (i.e test free of the actual implementation).</p>

      <p>In the below example, we're spying on the <code>setComplete</code> method of a dummy Todo function to test that arguments can be passed to it as expected.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="p">};</span>

      <span class="nx">Todo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">describe</span><span class="p">(</span><span class="s1">'a simple spy'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'should spy on an instance method of a Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>
              <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="kd">var</span> <span class="nx">myTodo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>

          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>What you're more likely to use spies for is testing <a href="http://en.wikipedia.org/wiki/Asynchronous_communication">asynchronous</a> behavior in your application such as AJAX requests. Jasmine supports:</p>

      <ul>
      <li>Writing tests which can mock AJAX requests using spies. This allows us to test code which runs before an AJAX request and right after. It's also possible to mock/fake responses the server can return and the benefit of this type of testing is that it's faster as no real calls are being made to a server</li>
      <li>Asynchronous tests which don't rely on spies</li>
      </ul><p>For the first kind of test, it's possible to both fake an AJAX request and verify that the request was both calling the correct URL and executed a callback where one was provided.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'the callback should be executed on success'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s1">'ajax'</span><span class="p">).</span><span class="nx">andCallFake</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
          <span class="p">});</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'url'</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'/todos/15'</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'' + id,</span>
      <span class="s1">        dataType: '</span><span class="nx">json</span><span class="err">'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you feel lost having seen matchers like <code>andCallFake()</code> and <code>toHaveBeenCalled()</code>, don't worry. All of these are Spy-specific matchers and are documented on the Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Spies">wiki</a>.</p>

      <p>For the second type of test (asynchronous tests), we can take the above further by taking advantage of three other methods Jasmine supports:</p>

      <ul>
      <li>runs(function) - a block which runs as if it was directly called</li>
      <li>waits(timeout) - a native timeout before the next block is run</li>
      <li>waitsFor(function, optional message, optional timeout) - a way to pause specs until some other work has completed. Jasmine waits until the supplied function returns true here before it moves on to the next block.</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should make an actual AJAX request to a server'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">waitsFor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="nx">runs</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
          <span class="p">});</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'todos.json'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre></div>

      <p><strong><em>Note:</em></strong> It's useful to remember that when making real requests to a web server in your unit tests, this has the potential to massively slow down the speed at which tests run (due to many factors including server latency). As this also introduces an external dependency that can (and should) be minimized in your unit testing, it is strongly recommended that you opt for spies to remove the need for a web server to be used here.</p>

      <h2>
      <a name="user-content-beforeeach-and-aftereach" class="anchor" href="#beforeeach-and-aftereach"><span class="octicon octicon-link"></span></a>beforeEach and afterEach()</h2>

      <p>Jasmine also supports specifying code that can be run before each (<code>beforeEach()</code>) and after each (<code>afterEach</code>) test. This is useful for enforcing consistent conditions (such as resetting variables that may be required by specs). In the following example, <code>beforeEach()</code> is used to create a new sample Todo model specs can use for testing attributes.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'Buy some more groceries'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
         <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">'should contain a text value if not the default value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'Buy some more groceries'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Each nested <code>describe()</code> in your tests can have their own <code>beforeEach()</code> and <code>afterEach()</code> methods which support including setup and teardown methods relevant to a particular suite. We'll be using <code>beforeEach()</code> in practice a little later.</p>

      <h2>
      <a name="user-content-shared-scope" class="anchor" href="#shared-scope"><span class="octicon octicon-link"></span></a>Shared scope</h2>

      <p>In the previous section you may have noticed that we initially declared a variable <code>this.todo</code> in our <code>beforeEach()</code> call and were then able to continue using this in <code>afterEach()</code>. This is thanks to a powerful feature of Jasmine known as shared  functional scope. Shared scope allows <code>this</code> properties to be common to all blocks (including <code>runs()</code>), but not declared variables (i.e <code>var</code>s).</p>

      <h2>
      <a name="user-content-getting-setup" class="anchor" href="#getting-setup"><span class="octicon octicon-link"></span></a>Getting setup</h2>

      <p>Now that we've reviewed some fundamentals, let's go through downloading Jasmine and getting everything setup to write tests.</p>

      <p>A standalone release of Jasmine can be <a href="http://pivotal.github.com/jasmine/download.html">downloaded</a> from the official release page.</p>

      <p>You'll need a file called SpecRunner.html in addition to the release. It can be downloaded from <a href="https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example">https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example</a> or as part of a download of the complete Jasmine <a href="https://github.com/pivotal/jasmine/zipball/master">repo</a>.Alternatively, you can <code>git clone</code> the main Jasmine repository from <a href="https://github.com/pivotal/jasmine.git">https://github.com/pivotal/jasmine.git</a>.</p>

      <p>Let's review <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/SpecRunner.html">SpecRunner.html</a>:</p>

      <p>It first includes both Jasmine and the necessary CSS required for reporting:</p>

      <pre><code>&lt;link rel="stylesheet" type="text/css" href="lib/jasmine-1.1.0.rc1/jasmine.css"/&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine-html.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>Next, some sample tests are included:</p>

      <pre><code>&lt;script type="text/javascript" src="spec/SpecHelper.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="spec/PlayerSpec.js"&gt;&lt;/script&gt;
      </code></pre>

      <p>And finally the sources being tested:</p>

      <pre><code>&lt;script type="text/javascript" src="src/Player.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="src/Song.js"&gt;&lt;/script&gt;
      </code></pre>

      <p><strong><em>Note:</em></strong> Below this section of SpecRunner is code responsible for running the actual tests. Given that we won't be covering modifying this code, I'm going to skip reviewing it. I do however encourage you to take a look through <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/PlayerSpec.js">PlayerSpec.js</a> and <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/SpecHelper.js">SpecHelper.js</a>. They're a useful basic example to go through how a minimal set of tests might work.</p>

      <h2>
      <a name="user-content-tdd-with-backbone" class="anchor" href="#tdd-with-backbone"><span class="octicon octicon-link"></span></a>TDD With Backbone</h2>

      <p>When developing applications with Backbone, it can be necessary to test both individual modules of code as well as modules, views, collections and routers. Taking a TDD approach to testing, let's review some specs for testing these Backbone components using the popular Backbone <a href="https://github.com/addyosmani/todomvc/tree/master/todo-example/backbone">Todo</a> application. For this section we will be using a modified version of Larry Myers Backbone Koans project, which can be found in the <code>practicals\jasmine-koans</code> folder.</p>

      <h2>
      <a name="user-content-models-2" class="anchor" href="#models-2"><span class="octicon octicon-link"></span></a>Models</h2>

      <p>The complexity of Backbone models can vary greatly depending on what your application is trying to achieve. In the following example, we're going to test default values, attributes, state changes and validation rules.</p>

      <p>First, we begin our suite for model testing using <code>describe()</code>:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      </pre></div>

      <p>Models should ideally have default values for attributes. This helps ensure that when creating instances without a value set for any specific attribute, a default one (e.g '') is used instead. The idea here is to allow your application to interact with models without any unexpected behavior.</p>

      <p>In the following spec, we create a new Todo without any attributes passed then check to find out what the value of the <code>text</code> attribute is. As no value has been set, we expect a default value of <code>''</code> to be returned.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>If testing this spec before your models have been written, you'll incur a failing test, as expected. What's required for the spec to pass is a default value for the attribute <code>text</code>. We can implement this default value with some other useful defaults (which we'll be using shortly) in our Todo model as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">}</span>

      </pre></div>

      <p>Next, we want to test that our model will pass attributes that are set such that retrieving the value of these attributes after initialization will be what we expect. Notice that here, in addition to testing for an expected value for <code>text</code>, we're also testing the other default values are what we expect them to be.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Will set passed attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="c1">// what are the values expected here for each of the</span>
          <span class="c1">// attributes in our Todo?</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Get oil change for car.'');</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">done</span><span class="s1">')).toBe(false);</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">order</span><span class="err">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Backbone models support a model.change() event which is triggered when the state of a model changes. In the following example, by 'state' I'm referring to the value of a Todo model's attributes. The reason changes of state are important to test are that there may be state-dependent events in your application e.g you may wish to display a confirmation view once a Todo model has been updated.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-change event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="c1">// how do we monitor changes of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span><span class="p">);</span>

          <span class="c1">// what would you need to do to force a change of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">spy</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>
      </pre></div>

      <p>It's common to include validation logic in your models to ensure both the input passed from users (and other modules) in the application are 'valid'. A Todo app may wish to validate the text input supplied in case it contains rude words. Similarly if we're storing the <code>done</code> state of a Todo item using booleans, we need to validate that truthy/falsy values are passed and not just any arbitrary string.</p>

      <p>In the following spec, we take advantage of the fact that validations which fail model.validate() trigger an "error" event. This allows us to test if validations are correctly failing when invalid input is supplied.</p>

      <p>We create an errorCallback spy using Jasmine's built in <code>createSpy()</code> method which allows us to spy on the error event as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-error event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>

          <span class="c1">// What would you need to set on the todo properties to</span>
          <span class="c1">// cause validation to fail?</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span><span class="s1">'a non-integer value'</span><span class="p">});</span>

          <span class="kd">var</span> <span class="nx">errorArgs</span> <span class="o">=</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Todo.done must be a boolean value.'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>The code to make the above failing test support validation is relatively simple. In our model, we override the validate() method (as recommended in the Backbone docs), checking to make sure a model both has a 'done' property and is a valid boolean before allowing it to pass.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>

      <p>If you would like to review the final code for our Todo model, you can find it below:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">NAUGHTY_WORDS</span> <span class="o">=</span> <span class="sr">/crap|poop|hell|frogs/gi</span><span class="p">;</span>

      <span class="kd">function</span> <span class="nx">sanitize</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">NAUGHTY_WORDS</span><span class="p">,</span> <span class="s1">'rainbows'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="nx">sanitize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">))},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-collections-2" class="anchor" href="#collections-2"><span class="octicon octicon-link"></span></a>Collections</h2>

      <p>We now need to define specs to tests a Backbone collection of Todo models (a TodoList). Collections are responsible for a number of list tasks including managing order and filtering.</p>

      <p>A few specific specs that come to mind when working with collections are:</p>

      <ul>
      <li>Making sure we can add new Todo models as both objects and arrays</li>
      <li>Attribute testing to make sure attributes such as the base URL of the collection are values we expect</li>
      <li>Purposefully adding items with a status of <code>done:true</code> and checking against how many items the collection thinks have been completed vs. those that are remaining</li>
      </ul><p>In this section we're going to cover the first two of these with the third left as an extended exercise I recommend trying out.</p>

      <p>Testing Todo models can be added to a collection as objects or arrays is relatively trivial. First, we initialize a new TodoList collection and check to make sure its length (i.e the number of Todo models it contains) is 0. Next, we add new Todos, both as objects and arrays, checking the length property of the collection at each stage to ensure the overall count is what we expect:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">});</span>

              <span class="c1">// how many todos have been added so far?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span><span class="p">}</span>
              <span class="p">]);</span>

              <span class="c1">// how many are there in total now?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">...</span>
      </pre></div>

      <p>Similar to model attributes, it's also quite straight-forward to test attributes in collections. Here we have a spec that ensures the collection.url (i.e the url reference to the collection's location on the server) is what we expect it to be:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="c1">// what has been specified as the url base in our model?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'/todos/'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>For the third spec, it's useful to remember that the implementation for our collection will have methods for filtering how many Todo items are done and how many are remaining - we can call these <code>done()</code> and <code>remaining()</code>. Consider writing a spec which creates a new collection and adds one new model that has a preset <code>done</code> state of <code>true</code> and two others that have the default <code>done</code> state of <code>false</code>. Testing the length of what's returned using <code>done()</code> and <code>remaining()</code> should allow us to know whether the state management in our application is working or needs a little tweaking.</p>

      <p>The final implementation for our TodoList collection can be found below:</p>

      <div class="highlight highlight-javascript"><pre> <span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'</span><span class="p">,</span>

              <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
              <span class="p">},</span>

              <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
              <span class="p">},</span>

              <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>

                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="p">},</span>

              <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-views-3" class="anchor" href="#views-3"><span class="octicon octicon-link"></span></a>Views</h2>

      <p>Before we take a look at testing Backbone views, let's briefly review a jQuery plugin that can assist with writing Jasmine specs for them.</p>

      <p><strong>The Jasmine jQuery Plugin</strong></p>

      <p>As we know our Todo application will be using jQuery for DOM manipulation, there's a useful jQuery plugin called <a href="https://github.com/velesin/jasmine-jquery">jasmine-jquery</a> we can use to help simplify BDD testing rendered elements that our views may produce.</p>

      <p>The plugin provides a number of additional Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Matchers">matchers</a> to help test jQuery wrapped sets such as:</p>

      <ul>
      <li>
      <code>toBe(jQuerySelector)</code> e.g <code>expect($('&lt;div id="some-id"&gt;&lt;/div&gt;')).toBe('div#some-id')</code>
      </li>
      <li>
      <code>toBeChecked()</code> e.g <code>expect($('&lt;input type="checkbox" checked="checked"/&gt;')).toBeChecked()</code>
      </li>
      <li>
      <code>toBeSelected()</code> e.g <code>expect($('&lt;option selected="selected"&gt;&lt;/option&gt;')).toBeSelected()</code>
      </li>
      </ul><p>and <a href="https://github.com/velesin/jasmine-jquery">many others</a>. The complete list of matchers supported can be found on the project homepage. It's useful to know that similar to the standard Jasmine matchers, the custom matchers above can be inverted using the .not prefix (i.e <code>expect(x).not.toBe(y)</code>):</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;div&gt;I am an example&lt;/div&gt;'</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="sr">/other/</span><span class="p">)</span>
      </pre></div>

      <p>jasmine-jquery also includes a fixtures model, allowing us to load in arbitrary HTML content we may wish to use in our tests. Fixtures can be used as follows:</p>

      <p>Include some HTML in an external fixtures file:</p>

      <p>some.fixture.html:
      <code>&lt;div id="sample-fixture"&gt;some HTML content&lt;/div&gt;</code></p>

      <p>Next, inside our actual test we would load it as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">loadFixtures</span><span class="p">(</span><span class="s1">'some.fixture.html'</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'some-fixture'</span><span class="p">).</span><span class="nx">myTestedPlugin</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#some-fixture'</span><span class="p">)).</span><span class="nx">to</span><span class="o">&lt;</span><span class="nx">the</span> <span class="nx">rest</span> <span class="nx">of</span> <span class="nx">your</span> <span class="nx">matcher</span> <span class="nx">would</span> <span class="nx">go</span> <span class="nx">here</span><span class="o">&gt;</span>
      </pre></div>

      <p>The jasmine-jquery plugin is by default setup to load fixtures from a specific directory: spec/javascripts/fixtures. If you wish to configure this path you can do so by initially setting <code>jasmine.getFixtures().fixturesPath = 'your custom path'</code>.</p>

      <p>Finally, jasmine-jquery includes support for spying on jQuery events without the need for any extra plumbing work. This can be done using the <code>spyOnEvent()</code> and <code>assert(eventName).toHaveBeenTriggered(selector)</code> functions. An example of usage may look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">spyOnEvent</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">),</span> <span class="s1">'click'</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="s1">'click'</span><span class="p">).</span><span class="nx">toHaveBeenTriggeredOn</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">));</span>
      </pre></div>

      <p><strong>View testing</strong></p>

      <p>In this section we will review three dimensions to writing specs for Backbone Views: initial setup, view rendering and finally templating. The latter two of these are the most commonly tested, however we'll review shortly why writing specs for the initialization of your views can also be of benefit.</p>

      <h2>
      <a name="user-content-initial-setup" class="anchor" href="#initial-setup"><span class="octicon octicon-link"></span></a>Initial setup</h2>

      <p>At their most basic, specs for Backbone views should validate that they are being correctly tied to specific DOM elements and are backed by valid data models. The reason to consider doing this is that failures to such specs can trip up more complex tests later on and they're fairly simple to write, given the overall value offered.</p>

      <p>To help ensure a consistent testing setup for our specs, we use <code>beforeEach()</code> to append both an empty <code>UL</code> (#todoList) to the DOM and initialize a new instance of a TodoView using an empty Todo model. <code>afterEach()</code> is used to remove the previous #todoList  <code>UL</code> as well as the previous instance of the view.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">});</span>


          <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">});</span>

      <span class="p">...</span>
      </pre></div>

      <p>The first spec useful to write is a check that the TodoView we've created is using the correct <code>tagName</code> (element or className). The purpose of this test is to make sure it's been correctly tied to a DOM element when it was created.</p>

      <p>Backbone views typically create empty DOM elements once initialized, however these elements are not attached to the visible DOM in order to allow them to be constructed without an impact on the performance of rendering.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">//what html element tag name represents this view?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'li'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>Once again, if the TodoView has not already been written, we will experience failing specs. Thankfully, solving this is as simple as creating a new Backbone.View with a specific <code>tagName</code>.</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span>
      <span class="p">});</span>
      </pre></div>

      <p>If instead of testing against the <code>tagName</code> you would prefer to use a className instead, we can take advantage of jasmine-jquery's <code>toHaveClass()</code> matcher to cater for this.</p>

      <pre><code>it('Should have a class of "todos"'), function(){
         expect(this.view.$el).toHaveClass('todos');
      });
      </code></pre>

      <p>The <code>toHaveClass()</code> matcher operates on jQuery objects and if the plugin hadn't been used, an exception would have been incurred (it is of course also possible to test for the className by accessing el.className if not opting to use jasmine-jquery).</p>

      <p>You may have noticed that in <code>beforeEach()</code>, we passed our view an initial (albeit unfilled) Todo model. Views should be backed by a model instance which provides data. As this is quite important to our view's ability to function, we can write a spec to ensure a model is both defined (using the <code>toBeDefined()</code> matcher) and then test attributes of the model to ensure defaults both exist and are the value we expect them to be.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>

          <span class="c1">// what's the value for Todo.get('done') here?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span> <span class="c1">//or toBeFalsy()</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-view-rendering" class="anchor" href="#view-rendering"><span class="octicon octicon-link"></span></a>View rendering</h2>

      <p>Next we're going to take a look at writing specs for view rendering. Specifically, we want to test that our TodoView elements are actually rendering as expected.</p>

      <p>In smaller applications, those new to BDD might argue that visual confirmation of view rendering could replace unit testing of views. The reality is that when dealing with applications that might grow to multiple-views, it often makes sense to automate this process as much as possible from the get-go. There are also aspects of rendering that require verification beyond what is visually presented on-screen (which we'll see very shortly).</p>

      <p>We're going to begin testing views by writing two specs. The first spec will check that the view's <code>render()</code> method is correctly returning the view instance, which is necessary for chaining. Our second spec will check that the HTML produced is exactly what we expect based on the properties of the model instance that's been associated with our TodoView.</p>

      <p>Unlike some of the previous specs we've covered, this section will make greater use of <code>beforeEach()</code> to both demonstrate how to use nested suites and also ensure a consistent set of conditions for our specs. In our first view spec for TodoView, we're simply going to create a sample model (based on Todo) and instantiate a TodoView which associates it with the model.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'My Todo'</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Rendering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'returns the view object'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'produces the correct HTML'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">//let's use jasmine-jquery's toContain() to avoid</span>
            <span class="c1">//testing for the complete content of a todo's markup</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>Once these specs are run, only the second one ('produces the correct HTML') fails. Our first spec ('returns the view object'), which is testing that the TodoView instance is returned from <code>render()</code>, only passed as this is Backbone's default behavior. We haven't yet overwritten the <code>render()</code> method with our own version.</p>

      <p><strong>Note:</strong> For the purposes of maintaining readability, all template examples in this section will use a minimal version of the following Todo view template. As it's relatively trivial to expand this, please feel free to refer to this sample if needed:</p>

      <pre><code>&lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="&lt;%= content %&gt;" /&gt;
              &lt;/div&gt;
      &lt;/div&gt;
      </code></pre>

      <p>The second spec fails with the following message:</p>

      <p><code>Expected '' to contain '&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'.</code></p>

      <p>The reason for this is the default behavior for render() doesn't create any markup. Let's write a replacement for render() which fixes this:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="s1">'&lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">template</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'&lt;%= text %&gt;'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
      </pre></div>

      <p>The above specifies an inline string template and replaces fields found in the template within the "&lt;% %&gt;" blocks with their corresponding values from the associated model. As we're now also returning the TodoView instance from the method, the first spec will also pass. It's worth noting that there are serious drawbacks to using HTML strings in your specs to test against like this. Even minor changes to your template (a simple tab or whitespace) would cause your spec to fail, despite the rendered output being the same. It's also more time consuming to maintain as most templates in real-world applications are significantly more complex. A better option for testing rendered output is using jQuery to both select and inspect values.</p>

      <p>With this in mind, let's re-write the specs, this time using some of the custom matchers offered by jasmine-jquery:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>It would be impossible to discuss unit testing without mentioning fixtures. Fixtures typically contain test data (e.g HTML) that is loaded in when needed (either locally or from an external file) for unit testing. So far we've been establishing jQuery expectations based on the view's el property. This works for a number of cases, however, there are instances where it may be necessary to render markup into the document. The most optimal way to handle this within specs is through using fixtures (another feature brought to us by the jasmine-jquery plugin).</p>

      <p>Re-writing the last spec to use fixtures would look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="nx">setFixtures</span><span class="p">(</span><span class="s1">'&lt;ul class="todos"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="p">...</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>What we're now doing in the above spec is appending the rendered todo item into the fixture. We then set expectations against the fixture, which may be something desirable when a view is setup against an element which already exists in the DOM. It would be necessary to provide both the fixture and test the <code>el</code> property correctly picking up the element expected when the view is instantiated.</p>

      <h2>
      <a name="user-content-rendering-with-a-templating-system" class="anchor" href="#rendering-with-a-templating-system"><span class="octicon octicon-link"></span></a>Rendering with a templating system</h2>

      <p>JavaScript templating systems (such as Handlebars, Mustache and even Underscore's own Micro-templating) support conditional logic in template strings. What this effectively means is that we can add if/else/ternery expressions inline which can then be evaluated as needed, allowing us to build even more powerful templates.</p>

      <p>In our case, when a user sets a Todo item to be complete (done), we may wish to provide them with visual feedback (such as a striked line through the text) to differentiate the item from those that are remaining. This can be done by attaching a new class to the item. Let's begin by writing a test we would ideally like to work:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'When a todo is done'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has a done class'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos .todo-content:first-child'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveClass</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre></div>

      <p>This will fail with the following message:</p>

      <p>```Expected 'My Todo'
      to have class 'done'.</p>

      <pre><code>
      which can be fixed in the existing render() method as follows:


      ```javascript
      render: function() {
        var template = '&lt;label class="todo-content"&gt;' +
          '&lt;%= text %&gt;&lt;/label&gt;';
        var output = template
          .replace('&lt;%= text %&gt;', this.model.get('text'));
        this.$el.html(output);
        if (this.model.get('done')) {
          this.$('.todo-content').addClass('done');
        }
        return this;
      }
      </code></pre>

      <p>This can however get unwieldily fairly quickly. As the logic in our templates increases, so does the complexity involved. This is where templates libraries can help. As mentioned earlier, there are a number of popular options available, but for the purposes of this chapter we're going to stick to using Underscore's built-in Microtemplating. Whilst there are more advanced options you're free to explore, the benefit of this is that no additional files are required and we can easily change the existing Jasmine specs without too much adjustment.</p>

      <p>The TodoView object modified to use Underscore templating would look as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre></div>

      <p>Above, the initialize() method compiles a supplied Underscore template (using the _.template() function) in the instantiation. A more common way of referencing templates is placing them in a script tag using a custom script type (e.g type="text/template"). As this isn't a script type any browser understands, it's simply ignored, however referencing the script by an id attribute allows the template to be kept separate to other parts of the page which wish to use it. In real world applications, it's preferable to either do this or load in templates stored in external files for testing.</p>

      <p>For testing purposes, we're going to continue using the string injection approach to keep things simple. There is however a useful trick that can be applied to automatically create or extend templates in the Jasmine scope for each test. By creating a new directory (say, 'templates') in the 'spec' folder and adding a new script file with the following contents, to jasmine.yml or SpecRunner.html, we can add a todo property which contains the Underscore template we wish to use:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content"&gt;'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>To finish this off, we simply update our existing spec to reference the template when instantiating the TodoView object:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">todo</span>
          <span class="p">});</span>
        <span class="p">});</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre></div>

      <p>The existing specs we've looked at would continue to pass using this approach, leaving us free to adjust the template with some additional conditional logic for Todos with a status of 'done':</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content &lt;%= done ? '</span><span class="nx">done</span><span class="s1">' : '' %&gt;"'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>This will now also pass without any issues. Remember that jasmine-jquery also supports loading external fixtures into your specs easily using its build in <code>loadFixtures()</code> and <code>readFixtures()</code> methods. For more information, consider reading the official jasmine-jquery <a href="https://github.com/velesin/jasmine-jquery">docs</a>.</p>

      <h2>
      <a name="user-content-conclusions-3" class="anchor" href="#conclusions-3"><span class="octicon octicon-link"></span></a>Conclusions</h2>

      <p>We have now covered how to write Jasmine tests for models, views and collections with Backbone.js. Whilst testing routing can at times be desirable, some developers feel it can be more optimal to leave this to third-party tools such as Selenium, so do keep this in mind.</p>

      <p>James Newbery was kind enough to help me with writing the Views section above and his articles on <a href="http://tinnedfruit.com/2011/04/26/testing-backbone-apps-with-jasmine-sinon-3.html">Testing Backbone Apps With SinonJS</a> were of great inspiration (you'll actually find some Handlebars examples of the view specs in part 3 of his article). If you would like to learn more about writing spies and mocks for Backbone using <a href="http://sinonjs.org">SinonJS</a> as well as how to test Backbone routers, do consider reading his series.</p>

      <h2>
      <a name="user-content-exercise" class="anchor" href="#exercise"><span class="octicon octicon-link"></span></a>Exercise</h2>

      <p>As an exercise, I recommend now trying the Jasmine Koans in <code>practicals\jasmine-joans</code> and trying to fix some of the purposefully failing tests it has to offer. This is an excellent way of not just learning how Jasmine specs and suites work, but working through the examples (without peeking back) will also put your Backbone skills to test too.</p>

      <h2>
      <a name="user-content-further-reading" class="anchor" href="#further-reading"><span class="octicon octicon-link"></span></a>Further reading</h2>

      <ul>
      <li><a href="http://japhr.blogspot.com/2011/11/jasmine-backbonejs-revisited.html">Jasmine + Backbone Revisited</a></li>
      <li><a href="http://japhr.blogspot.com/2011/12/phantomjs-and-backbonejs-and-requirejs.html">Backbone, PhantomJS and Jasmine</a></li>
      </ul><h2>
      <a name="user-content-unit-testing-backbone-applications-with-qunit-and-sinonjs" class="anchor" href="#unit-testing-backbone-applications-with-qunit-and-sinonjs"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With QUnit And SinonJS</h2>

      <h2>
      <a name="user-content-introduction-4" class="anchor" href="#introduction-4"><span class="octicon octicon-link"></span></a>Introduction</h2>

      <p>QUnit is a powerful JavaScript test suite written by jQuery team member <a href="http://bassistance.de/">Jörn Zaefferer</a> and used by many large open-source projects (such as jQuery and Backbone.js) to test their code. It's both capable of testing standard JavaScript code in the browser as well as code on the server-side (where environments supported include Rhino, V8 and SpiderMonkey). This makes it a robust solution for a large number of use-cases.</p>

      <p>Quite a few Backbone.js contributors feel that QUnit is a better introductory framework for testing if you don't wish to start off with Jasmine and BDD right away. As we'll see later on in this chapter, QUnit can also be combined with third-party solutions such as SinonJS to produce an even more powerful testing solution supporting spies and mocks, which some say is preferable over Jasmine.</p>

      <p>My personal recommendation is that it's worth comparing both frameworks and opting for the solution that you feel the most comfortable with.</p>

      <h1>
      <a name="user-content-qunit" class="anchor" href="#qunit"><span class="octicon octicon-link"></span></a>QUnit</h1>

      <h2>
      <a name="user-content-getting-setup-1" class="anchor" href="#getting-setup-1"><span class="octicon octicon-link"></span></a>Getting Setup</h2>

      <p>Luckily, getting QUnit setup is a fairly straight-forward process that will take less than 5 minutes.</p>

      <p>We first setup a testing environment composed of three files:</p>

      <ul>
      <li>A HTML <strong>structure</strong> for displaying test results,</li>
      <li>The <strong>qunit.js</strong> file composing the testing framework and,</li>
      <li>The <strong>qunit.css</strong> file for styling test results.</li>
      </ul><p>The latter two of these can be downloaded from the <a href="http://qunitjs.com">QUnit website</a>.</p>

      <p>If you would prefer, you can use a hosted version of the QUnit source files for testing purposes. The hosted URLs can be found at [<a href="http://github.com/jquery/qunit/raw/master/qunit/">http://github.com/jquery/qunit/raw/master/qunit/</a>].</p>

      <h4>
      <a name="user-content-sample-html-with-qunit-compatible-markup" class="anchor" href="#sample-html-with-qunit-compatible-markup"><span class="octicon octicon-link"></span></a>Sample HTML with QUnit-compatible markup:</h4>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test Suite<span class="nt">&lt;/title&gt;</span>

           <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your application --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your tests --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test Suite<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;</span>test markup, hidden.<span class="nt">&lt;/ol&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>Let's go through the elements above with qunit mentioned in their ID. When QUnit is running:</p>

      <ul>
      <li>
      <strong>qunit-header</strong> shows the name of the test suite</li>
      <li>
      <strong>qunit-banner</strong> shows up as red if a test fails and green if all tests pass</li>
      <li>
      <strong>qunit-testrunner-toolbar</strong> contains additional options for configuring the display of tests</li>
      <li>
      <strong>qunit-userAgent</strong> displays the navigator.userAgent property</li>
      <li>
      <strong>qunit-tests</strong> is a container for our test results</li>
      </ul><p>When running correctly, the above test runner looks as follows:</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/7d4de12.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/7d4de12.png" alt="screenshot 1" style="max-width:100%;"></a></p>

      <p>The numbers of the form (a, b, c) after each test name correspond to a) failed asserts, b) passed asserts and c) total asserts. Clicking on a test name expands it to display all of the assertions for that test case. Assertions in green have successfully passed.</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/9df4.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/9df4.png" alt="screenshot 2" style="max-width:100%;"></a></p>

      <p>If however any tests fail, the test gets highlighted (and the qunit-banner at the top switches to red):</p>

      <p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/3e5545.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/3e5545.png" alt="screenshot 3" style="max-width:100%;"></a></p>

      <h2>
      <a name="user-content-assertions" class="anchor" href="#assertions"><span class="octicon octicon-link"></span></a>Assertions</h2>

      <p>QUnit supports a number of basic <strong>assertions</strong>, which are used in testing to verify that the result being returned by our code is what we expect. If an assertion fails, we know that a bug exists.Similar to Jasmine, QUnit can be used to easily test for regressions. Specifically, when a bug is found one can write an assertion to test the existence of the bug, write a patch and then commit both. If subsequent changes to the code break the test you'll know what was responsible and be able to address it more easily.</p>

      <p>Some of the supported QUnit assertions we're going to look at first are:</p>

      <ul>
      <li>  <code>ok ( state, message )</code> - passes if the first argument is truthy</li>
      <li>  <code>equal ( actual, expected, message )</code> - a simple comparison assertion with type coercion</li>
      <li>  <code>notEqual ( actual, expected, message )</code> - the opposite of the above</li>
      <li>  <code>expect( amount )</code> - the number of assertions expected to run within each test</li>
      <li>  <code>strictEqual( actual, expected, message)</code> - offers a much stricter comparison than <code>equal()</code> and is considered the preferred method of checking equality as it avoids stumbling on subtle coercion bugs</li>
      <li>  <code>deepEqual( actual, expected, message )</code> - similar to <code>strictEqual</code>, comparing the contents (with <code>===</code>) of the given objects, arrays and primitives.</li>
      </ul><p>Creating new test cases with QUnit is relatively straight-forward and can be done using <code>test()</code>, which constructs a test where the first argument is the <code>name</code> of the test to be displayed in our results and the second is a <code>callback</code> function containing all of our assertions. This is called as soon as QUnit is running.</p>

      <h4>
      <a name="user-content-basic-test-case-using-test-name-callback-" class="anchor" href="#basic-test-case-using-test-name-callback-"><span class="octicon octicon-link"></span></a>Basic test case using test( name, callback ):</h4>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">myString</span> <span class="o">=</span> <span class="s1">'Hello Backbone.js'</span><span class="p">;</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Our first QUnit test - asserting results'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// ok( boolean, message )</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">'the test succeeds'</span><span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'the test fails'</span><span class="p">);</span>

          <span class="c1">// equal( actualValue, expectedValue, message )</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">myString</span><span class="p">,</span> <span class="s1">'Hello Backbone.js'</span><span class="p">,</span> <span class="s1">'The value expected is Hello Backbone.js!'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>What we're doing in the above is defining a variable with a specific value and then testing to ensure the value was what we expected it to be. This was done using the comparison assertion, <code>equal()</code>, which expects its first argument to be a value being tested and the second argument to be the expected value. We also used <code>ok()</code>, which allows us to easily test against functions or variables that evaluate to booleans.</p>

      <p>Note: Optionally in our test case, we could have passed an 'expected' value to <code>test()</code> defining the number of assertions we expect to run. This takes the form: <code>test( name, [expected], test );</code> or by manually settings the expectation at the top of the test function, like so: <code>expect( 1 )</code>. I recommend you to make it a habit and always define how many assertions you expect. More on this later.</p>

      <p>As testing a simple static variable is fairly trivial, we can take this further to test actual functions. In the following example we test the output of a function that reverses a string to ensure that the output is correct using <code>equal()</code> and <code>notEqual()</code>:</p>

      <h4>
      <a name="user-content-comparing-the-actual-output-of-a-function-against-the-expected-output" class="anchor" href="#comparing-the-actual-output-of-a-function-against-the-expected-output"><span class="octicon octicon-link"></span></a>Comparing the actual output of a function against the expected output:</h4>

      <div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">reverseString</span><span class="p">(</span> <span class="nx">str</span> <span class="p">){</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'reverseString()'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">),</span> <span class="s1">'olleh'</span><span class="p">,</span> <span class="s1">'The value expected was olleh'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'foobar'</span><span class="p">),</span> <span class="s1">'raboof'</span><span class="p">,</span> <span class="s1">'The value expected was raboof'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlrow'</span><span class="p">,</span> <span class="s1">'The value expected was dlrow'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlroo'</span><span class="p">,</span> <span class="s1">'The value was expected to not be dlroo'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'bubble'</span><span class="p">),</span> <span class="s1">'double'</span><span class="p">,</span> <span class="s1">'The value expected was elbbub'</span> <span class="p">);</span>
      <span class="p">})</span>
      </pre></div>

      <p>Running these tests in the QUnit test runner (which you would see when your HTML test page was loaded) we would find that four of the assertions pass whilst the last one does not. The reason the test against <code>'double'</code> fails is because it was purposefully written incorrectly. In your own projects if a test fails to pass and your assertions are correct, you've probably just found a bug!</p>

      <h2>
      <a name="user-content-adding-structure-to-assertions" class="anchor" href="#adding-structure-to-assertions"><span class="octicon octicon-link"></span></a>Adding structure to assertions</h2>

      <p>Housing all of our assertions in one test case can quickly become difficult to maintain, but luckily QUnit supports structuring blocks of assertions more cleanly. This can be done using <code>module()</code> - a method that allows us to easily group tests together. A typical approach to grouping might be keeping multiple tests testing a specific method as part of the same group (module).</p>

      <h4>
      <a name="user-content-basic-qunit-modules" class="anchor" href="#basic-qunit-modules"><span class="octicon octicon-link"></span></a>Basic QUnit Modules:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Two'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'second test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Three'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'third test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      </pre></div>

      <p>We can take this further by introducing <code>setup()</code> and <code>teardown()</code> callbacks to our modules, where <code>setup()</code> is run before each test whilst <code>teardown()</code> is run after each test.</p>

      <h4>
      <a name="user-content-using-setup-and-teardown-" class="anchor" href="#using-setup-and-teardown-"><span class="octicon octicon-link"></span></a>Using setup() and teardown() :</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run before</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run after</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// run the first test</span>
      <span class="p">});</span>
      </pre></div>

      <p>These callbacks can be used to define (or clear) any components we wish to instantiate for use in one or more of our tests. As we'll see shortly, this is ideal for defining new instances of views, collections, models or routers from a project that we can then reference across multiple tests.</p>

      <h4>
      <a name="user-content-using-setup-and-teardown-for-instantiation-and-clean-up" class="anchor" href="#using-setup-and-teardown-for-instantiation-and-clean-up"><span class="octicon octicon-link"></span></a>Using setup() and teardown() for instantiation and clean-up:</h4>

      <div class="highlight highlight-javascript"><pre><span class="c1">// Define a simple model and collection modeling a store and</span>
      <span class="c1">// list of stores</span>

      <span class="kd">var</span> <span class="nx">Store</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="kd">var</span> <span class="nx">StoreList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">store</span><span class="p">,</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">store</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Define a group for our tests</span>
      <span class="nx">module</span><span class="p">(</span> <span class="s1">'StoreList sanity check'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StoreList</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Costcutter'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Target'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Walmart'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Barnes &amp; Noble'</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nb">window</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Test the order of items added</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'test ordering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Barnes &amp; Noble'</span><span class="p">,</span> <span class="s1">'Costcutter'</span><span class="p">,</span> <span class="s1">'Target'</span><span class="p">,</span> <span class="s1">'Walmart'</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'is maintained by comparator'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <p>Here, a list of stores is created and stored on <code>setup()</code>. A <code>teardown()</code> callback is used to simply clear our a list of errors we might be storing within the window scope, but is otherwise not needed.</p>

      <h2>
      <a name="user-content-assertion-examples" class="anchor" href="#assertion-examples"><span class="octicon octicon-link"></span></a>Assertion examples</h2>

      <p>Before we continue any further, let's review some more examples of how QUnits various assertions can be correctly used when writing tests:</p>

      <h3>
      <a name="user-content-equal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#equal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>equal - a comparison assertion. It passes if actual == expected</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'equal'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 == true'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 == 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notEqual - a comparison assertion. It passes if actual != expected</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'notEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'passes as 1 != false'</span> <span class="p">);</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">'passes as 1 != 0'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-strictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#strictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>strictEqual - a comparison assertion. It passes if actual === expected.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'strictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'fails as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notstrictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notstrictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notStrictEqual - a comparison assertion. It passes if actual !== expected.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notStrictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'fails as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives" class="anchor" href="#deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives"><span class="octicon octicon-link"></span></a>deepEqual - a recursive comparison assertion. Unlike strictEqual(), it works on objects, arrays and primitives.</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'deepEqual'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>

        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are not equal using equal()'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are equal'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - jQuery objects are not the same'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - objects not equivalent'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal" class="anchor" href="#notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal"><span class="octicon octicon-link"></span></a>notDeepEqual - a comparison assertion. This returns the opposite of deepEqual</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notDeepEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are not equal'</span> <span class="p">);</span>
        <span class="nx">notDeepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are equivalent'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions" class="anchor" href="#raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions"><span class="octicon octicon-link"></span></a>raises - an assertion which tests if a callback throws any exceptions</h3>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'raises'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">raises</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">'Oh no! It`s an error!'</span> <span class="p">);</span>
        <span class="p">},</span> <span class="s1">'passes - an error was thrown inside our callback'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-fixtures" class="anchor" href="#fixtures"><span class="octicon octicon-link"></span></a>Fixtures</h2>

      <p>From time to time we may need to write tests that modify the DOM. Managing the clean-up of such operations between tests can be a genuine pain, but thankfully QUnit has a solution to this problem in the form of the <code>#qunit-fixture</code> element, seen below.</p>

      <h4>
      <a name="user-content-fixture-markup" class="anchor" href="#fixture-markup"><span class="octicon octicon-link"></span></a>Fixture markup:</h4>

      <div class="highlight highlight-html"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test<span class="nt">&lt;/title&gt;</span>
          <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;&lt;/ol&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-fixture"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre></div>

      <p>We can either opt to place static markup in the fixture or just insert/append any DOM elements we may need to it. QUnit will automatically reset the <code>innerHTML</code> of the fixture after each test to its original value. In case you're using jQuery, it's useful to know that QUnit checks for its availability and will opt to use <code>$(el).html()</code> instead, which will cleanup any jQuery event handlers too.</p>

      <h3>
      <a name="user-content-fixtures-example" class="anchor" href="#fixtures-example"><span class="octicon octicon-link"></span></a>Fixtures example:</h3>

      <p>Let us now go through a more complete example of using fixtures. One thing that most of us are used to doing in jQuery is working with lists - they're often used to define the markup for menus, grids and a number of other components. You may have used jQuery plugins before that manipulated a given list in a particular way and it can be useful to test that the final (manipulated) output of the plugin is what was expected.</p>

      <p>For the purposes of our next example, we're going to use Ben Alman's <code>$.enumerate()</code> plugin, which can prepend each item in a list by its index, optionally allowing us to set what the first number in the list is. The code snippet for the plugin can be found below, followed by an example of the output is generates:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">enumerate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">start</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">start</span> <span class="o">!==</span> <span class="s1">'undefined'</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// Since `start` value was provided, enumerate and return</span>
              <span class="c1">// the initial jQuery object to allow chaining.</span>

              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
                <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span> <span class="s1">'&lt;b&gt;'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">start</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'&lt;/b&gt; '</span> <span class="p">);</span>
              <span class="p">});</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Since no `start` value was provided, function as a</span>
              <span class="c1">// getter, returing the appropriate value from the first</span>
              <span class="c1">// selected element.</span>

              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">children</span><span class="p">(</span> <span class="s1">'b'</span> <span class="p">).</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">text</span><span class="p">();</span>
              <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">val</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">};</span>

      <span class="cm">/*</span>
      <span class="cm">    &lt;ul&gt;</span>
      <span class="cm">      &lt;li&gt;1. hello&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;2. world&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;3. i&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;4. am&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;5. foo&lt;/li&gt;</span>
      <span class="cm">    &lt;/ul&gt;</span>
      <span class="cm">*/</span>
      </pre></div>

      <p>Let's now write some specs for the plugin. First, we define the markup for a list containing some sample items inside our <code>qunit-fixture</code> element:</p>

      <div class="highlight highlight-html"><pre><span class="ni">&amp;lt;</span>div id=<span class="ni">&amp;quot;</span>qunit-fixture<span class="ni">&amp;quot;&amp;gt;</span>
          <span class="ni">&amp;lt;</span>ul<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>hello<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>world<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>i<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>am<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>foo<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
          <span class="ni">&amp;lt;</span>/ul<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
      </pre></div>

      <p>Next, we need to think about what should be tested. <code>$.enumerate()</code> supports a few different use cases, including:</p>

      <ul>
      <li>
      <strong>No arguments passed</strong> - i.e <code>$(el).enumerate()</code>
      </li>
      <li>
      <strong>0 passed as an argument</strong> - i.e <code>$(el).enumerate(0)</code>
      </li>
      <li>
      <strong>1 passed as an argument</strong> - i.e <code>$(el).enumerate(1)</code>
      </li>
      </ul><p>As the text value for each list item is of the form "n. item-text" and we only require this to test against the expected output, we can simply access the content using <code>$(el).eq(index).text()</code> (for more information on .eq() see <a href="http://api.jquery.com/eq/">here</a>).</p>

      <p>and finally, here are our test cases:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span><span class="s1">'jQuery#enumerate'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'No arguments passed'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">();</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'0 passed as an argument'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'0. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 0'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. world'</span><span class="p">,</span> <span class="s1">'second item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. i'</span><span class="p">,</span> <span class="s1">'third item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 4'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'1 passed as an argument'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre></div>

      <h2>
      <a name="user-content-asynchronous-code" class="anchor" href="#asynchronous-code"><span class="octicon octicon-link"></span></a>Asynchronous code</h2>

      <p>As with Jasmine, the effort required to run synchronous tests with QUnit is fairly straight-forward. That said, what about tests that require asynchronous callbacks (such as expensive processes, Ajax requests and so on)? When we're dealing with asynchronous code, rather than letting QUnit control when the next test runs, we can inform that we need it to stop running and wait until it's okay to continue once again.</p>

      <p>Remember: running asynchronous code without any special considerations can cause incorrect assertions to appear in other tests, so we want to make sure we get it right.</p>

      <p>Writing QUnit tests for asynchronous code is made possible using the <code>start()</code> and <code>stop()</code> methods, which programmatically set the start and stop points during such tests. Here's a simple example:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'An async test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">stop</span><span class="p">();</span>
         <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
         <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/test'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">data</span> <span class="p">){</span>
                  <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
                     <span class="nx">topic</span><span class="o">:</span> <span class="s1">'hello'</span><span class="p">,</span>
                     <span class="nx">message</span><span class="o">:</span> <span class="s1">'hi there!'</span><span class="err">'</span>
                  <span class="p">});</span>
                  <span class="nx">start</span><span class="p">();</span>
              <span class="p">}</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <p>A jQuery <code>$.ajax()</code> request is used to connect to a test resource and assert that the data returned is correct. <code>deepEqual()</code> is used here as it allows us to compare different data types (e.g objects, arrays) and ensures that what is returned is exactly what we're expecting. We know that our Ajax request is asynchronous and so we first call <code>stop()</code>, run the code making the request and finally at the very end of our callback, inform QUnit that it is okay to continue running other tests.</p>

      <p>Note: rather than including <code>stop()</code>, we can simply exclude it and substitute <code>test()</code> with <code>asyncTest()</code> if we prefer. This improves readability when dealing with a mixture of asynchronous and synchronous tests in your suite. Whilst this setup should work fine for many use-cases, there is no guarantee that the callback in our <code>$.ajax()</code> request will actually get called. To factor this into our tests, we can use <code>expect()</code> once again to define how many assertions we expect to see within our test. This is a healthy safety blanket as it ensures that if a test completes with an insufficient number of assertions, we know something went wrong and fix it.</p>

      <h1>
      <a name="user-content-sinonjs" class="anchor" href="#sinonjs"><span class="octicon octicon-link"></span></a>SinonJS</h1>

      <p>Similar to the section on testing Backbone.js apps using the Jasmine BDD framework, we're nearly ready to take what we've learned and write a number of QUnit tests for our Todo application.</p>

      <p>Before we start though, you may have noticed that QUnit doesn't support test spies. Test spies are functions which record arguments, exceptions and return values for any of their calls. They're typically used to test callbacks and how functions may be used in the application being tested. In testing frameworks, spies can usually be either anonymous functions or wrap functions which already exist.</p>

      <h2>
      <a name="user-content-what-is-sinonjs" class="anchor" href="#what-is-sinonjs"><span class="octicon octicon-link"></span></a>What is SinonJS?</h2>

      <p>In order for us to substitute support for spies in QUnit, we will be taking advantage of a mocking framework called <a href="http://sinonjs.org/">SinonJS</a> by Christian Johansen. We will also be using the <a href="http://sinonjs.org/qunit/">SinonJS-QUnit adapter</a> which provides seamless integration with QUnit (meaning setup is minimal). Sinon.JS is completely test-framework agnostic and should be easy to use with any testing framework, so it's ideal for our needs.</p>

      <p>The framework supports three features we'll be taking advantage of for unit testing our application:</p>

      <ul>
      <li><strong>Anonymous spies</strong></li>
      <li><strong>Spying on existing methods</strong></li>
      <li><strong>A rich inspection interface</strong></li>
      </ul><p>Using <code>this.spy()</code> without any arguments creates an anonymous spy. This is comparable to <code>jasmine.createSpy()</code> and we can observe basic usage of a SinonJS spy in the following example:</p>

      <h4>
      <a name="user-content-basic-spies" class="anchor" href="#basic-spies"><span class="octicon octicon-link"></span></a>Basic Spies:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers for a message exactly once'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'Hello World'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'the subscriber was called once'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>We can also use <code>this.spy()</code> to spy on existing functions (like jQuery's <code>$.ajax</code>) in the example below. When spying on a function which already exists, the function behaves normally but we get access to data about its calls which can be very useful for testing purposes.</p>

      <h4>
      <a name="user-content-spying-on-existing-functions" class="anchor" href="#spying-on-existing-functions"><span class="octicon octicon-link"></span></a>Spying On Existing Functions:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'should inspect jQuery.getJSON'</span><span class="nx">s</span> <span class="nx">usage</span> <span class="nx">of</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="s1">', function () {</span>
      <span class="s1">    this.spy( jQuery, '</span><span class="nx">ajax</span><span class="s1">' );</span>

      <span class="s1">    jQuery.getJSON( '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>

      <span class="s1">    ok( jQuery.ajax.calledOnce );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].url, '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].dataType, '</span><span class="nx">json</span><span class="err">'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>SinonJS comes with a rich spy interface which allows us to test whether a spy was called with a specific argument, if it was called a specific number of times and test against the values of arguments. A complete list of features supported in the interface can be found here (<a href="http://sinonjs.org/docs/">http://sinonjs.org/docs/</a>), but let's take a look at some examples demonstrating some of the most commonly used ones:</p>

      <h4>
      <a name="user-content-matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments" class="anchor" href="#matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments"><span class="octicon octicon-link"></span></a>Matching arguments: test a spy was called with a specific set of arguments:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with standard matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others" class="anchor" href="#stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others"><span class="octicon octicon-link"></span></a>Stricter argument matching: test a spy was called at least once with specific arguments and no others:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with strict matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="s1">'many'</span><span class="p">,</span> <span class="s1">'arguments'</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">34</span> <span class="p">);</span>

          <span class="c1">// This passes</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="s1">'many'</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// This however, fails</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWithExactly</span><span class="p">(</span> <span class="s1">'many'</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy" class="anchor" href="#testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy"><span class="octicon octicon-link"></span></a>Testing call order: testing if a spy was called before or after another spy:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and maintain call order'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">a</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="nx">b</span> <span class="p">);</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">a</span><span class="p">.</span><span class="nx">calledBefore</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">);</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">b</span><span class="p">.</span><span class="nx">calledAfter</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h4>
      <a name="user-content-match-execution-counts-test-a-spy-was-called-a-specific-number-of-times" class="anchor" href="#match-execution-counts-test-a-spy-was-called-a-specific-number-of-times"><span class="octicon octicon-link"></span></a>Match execution counts: test a spy was called a specific number of times:</h4>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and check call counts'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'some payload'</span> <span class="p">);</span>


          <span class="c1">// Passes if spy was called once and only once.</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span> <span class="c1">// calledTwice and calledThrice are also supported</span>

          <span class="c1">// The number of recorded calls.</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="c1">// Directly checking the arguments of the call</span>
          <span class="nx">equals</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">message</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-stubs-and-mocks" class="anchor" href="#stubs-and-mocks"><span class="octicon octicon-link"></span></a>Stubs and mocks</h2>

      <p>SinonJS also supports two other powerful features which are useful to be aware of: stubs and mocks. Both stubs and mocks implement all of the features of the spy API, but have some added functionality.</p>

      <h3>
      <a name="user-content-stubs" class="anchor" href="#stubs"><span class="octicon octicon-link"></span></a>Stubs</h3>

      <p>A stub allows us to replace any existing behaviour for a specific method with something else. They can be very useful for simulating exceptions and are most often used to write test cases when certain dependencies of your code-base may not yet be written.</p>

      <p>Let us briefly re-explore our Backbone Todo application, which contained a Todo model and a TodoList collection. For the purpose of this walkthrough, we want to isolate our TodoList collection and fake the Todo model to test how adding new models might behave.</p>

      <p>We can pretend that the models have yet to be written just to demonstrate how stubbing might be carried out. A shell collection just containing a reference to the model to be used might look like this:</p>

      <div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span>
      <span class="p">});</span>

      <span class="c1">// Let's assume our instance of this collection is</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">;</span>
      </pre></div>

      <p>Assuming our collection is instantiating new models itself, it's necessary for us to stub the models constructor function for the the test. This can be done by creating a simple stub as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span> <span class="p">);</span>
      </pre></div>

      <p>The above creates a stub of the Todo method on the window object. When stubbing a persistent object, it's necessary to restore it to its original state. This can be done in a <code>teardown()</code> as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
      </pre></div>

      <p>After this, we need to alter what the constructor returns, which can be efficiently done using a plain <code>Backbone.Model</code> constructor. Whilst this isn't a Todo model, it does still provide us an actual Backbone model.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <p>The expectation here might be that this snippet would ensure our TodoList collection always instantiates a stubbed Todo model, but because a reference to the model in the collection is already present, we need to reset the model property of our collection as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
      </pre></div>

      <p>The result of this is that when our TodoList collection instantiates new Todo models, it will return our plain Backbone model instance as desired. This allows us to write a spec for testing the addition of new model literals as follows:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Should function when instantiated with model literals'</span><span class="p">,</span> <span class="p">{</span>

        <span class="nx">setup</span><span class="o">:</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

          <span class="c1">// Let's reset the relationship to use a stub</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
        <span class="p">}</span>

      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should add a model'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should find a model by id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-mocks" class="anchor" href="#mocks"><span class="octicon octicon-link"></span></a>Mocks</h3>

      <p>Mocks are effectively the same as stubs, however they mock a complete API out and have some built-in expectations for how they should be used. The difference between a mock and a spy is that as the expectations for their use are pre-defined, it will fail if any of these are not met.</p>

      <p>Here's a snippet with sample usage of a mock based on PubSubJS. Here, we have a <code>clearTodo()</code> method as a callback and use mocks to verify its behavior.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers when exceptions'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">myAPI</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">clearTodo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span> <span class="p">};</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">mock</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span> <span class="nx">myAPI</span> <span class="p">);</span>
          <span class="nx">mock</span><span class="p">.</span><span class="nx">expects</span><span class="p">(</span> <span class="s1">'clearTodo'</span> <span class="p">).</span><span class="nx">once</span><span class="p">().</span><span class="kr">throws</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">myAPI</span><span class="p">.</span><span class="nx">clearTodo</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>

          <span class="nx">mock</span><span class="p">.</span><span class="nx">verify</span><span class="p">();</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-practical-3" class="anchor" href="#practical-3"><span class="octicon octicon-link"></span></a>Practical</h2>

      <p>We can now begin writing test specs for our Todo application, which are listed and separated by component (e.g Models, Collections etc.). It's useful to pay attention to the name of the test, the logic being tested and most importantly the assertions being made as this will give you some insight into how what we've learned can be applied to a complete application.</p>

      <p>To get the most out of this section, I recommend looking at the QUnit Koans included in the <code>practicals\qunit-koans</code> folder - this is a port of the Backbone.js Jasmine Koans over to QUnit that I converted for this post.</p>

      <p><em>In case you haven't had a chance to try out one of the Koans kits as yet, they are a set of unit tests using a specific testing framework that both demonstrate how a set of specs for an application may be written, but also leave some tests unfilled so that you can complete them as an exercise.</em></p>

      <h3>
      <a name="user-content-models-3" class="anchor" href="#models-3"><span class="octicon octicon-link"></span></a>Models</h3>

      <p>For our models we want to at minimum test that:</p>

      <ul>
      <li>New instances can be created with the expected default values</li>
      <li>Attributes can be set and retrieved correctly</li>
      <li>Changes to state correctly fire off custom events where needed</li>
      <li>Validation rules are correctly enforced</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Model'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">''</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will set attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Get oil change for car.'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will call a custom initialize function on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">toot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Stop monkeys from throwing their own crap!'</span> <span class="p">});</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">toot</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Stop monkeys from throwing their own rainbows!'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="c1">// How would you update a property on the todo here?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Model-set</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'new text'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'A change event callback was correctly triggered'</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>
          <span class="c1">// What would you need to set on the todo properties to cause validation to fail?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="s1">'not a boolean'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">called</span><span class="p">,</span> <span class="s1">'A failed validation correctly triggered an error'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'Todo.done must be a boolean value.'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-collections-3" class="anchor" href="#collections-3"><span class="octicon octicon-link"></span></a>Collections</h3>

      <p>For our collection we'll want to test that:</p>

      <ul>
      <li>New model instances can be added as both objects and arrays</li>
      <li>Changes to models result in any necessary custom events being fired</li>
      <li>A <code>url</code> property for defining the URL structure for models is correctly defined</li>
      </ul><div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Collection'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span> <span class="p">}</span>
          <span class="p">]);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="s1">'/todos/'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires custom named events when the models change.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">addModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">removeModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="nx">addModelCallback</span> <span class="p">);</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'remove'</span><span class="p">,</span> <span class="nx">removeModelCallback</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'add' event to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span><span class="s1">'New todo'</span><span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">addModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'remove' callback to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">last</span><span class="p">()</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">removeModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-views-4" class="anchor" href="#views-4"><span class="octicon octicon-link"></span></a>Views</h3>

      <p>For our views we want to ensure:</p>

      <ul>
      <li>They are being correctly tied to a DOM element when created</li>
      <li>They can render, after which the DOM representation of the view should be visible</li>
      <li>They support wiring up view methods to DOM elements</li>
      </ul><p>One could also take this further and test that user interactions with the view correctly result in any models that need to be changed being updated correctly.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.View'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="s1">'li'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can render, after which the DOM representation of the view will be visible.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

          <span class="c1">// Hint: render() just builds the DOM representation of the view, but doesn't insert it into the DOM.</span>
          <span class="c1">//       How would you append it to the ul#todoList?</span>
          <span class="c1">//       How do you access the view's DOM representation?</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#View-el</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'ul#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'li'</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">asyncTest</span><span class="p">(</span><span class="s1">'Can wire up view methods to DOM elements.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">viewElt</span><span class="p">;</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>

          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">viewElt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="s1">':first'</span><span class="p">);</span>

              <span class="nx">equal</span><span class="p">(</span><span class="nx">viewElt</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

              <span class="c1">// Make sure that QUnit knows we can continue</span>
              <span class="nx">start</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'Expected DOM Elt to exist'</span><span class="p">);</span>


          <span class="c1">// Hint: How would you trigger the view, via a DOM Event, to toggle the 'done' status.</span>
          <span class="c1">//       (See todos.js line 70, where the events hash is defined.)</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://api.jquery.com/click</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">true</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-event" class="anchor" href="#event"><span class="octicon octicon-link"></span></a>Event</h3>

      <p>For events, we may want to test a few different use cases:</p>

      <ul>
      <li>Extending plain objects to support custom events</li>
      <li>Binding and triggering custom events on objects</li>
      <li>Passing along arguments to callbacks when events are triggered</li>
      <li>Binding a passed context to an event callback</li>
      <li>Removing custom events</li>
      </ul><p>and a few others that will be detailed in our module below:</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Events'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">();</span> <span class="c1">// remove all custom events before each spec is run.</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can extend JavaScript objects to support custom events.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">basicObject</span> <span class="o">=</span> <span class="p">{};</span>

          <span class="c1">// How would you give basicObject these functions?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Events</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">basicObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">on</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">off</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Allows us to bind and trigger custom named events on an object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'basic event'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'basic event'</span> <span class="p">);</span>

          <span class="c1">// How would you cause the callback for this custom event to be called?</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also passes along any arguments to the callback when an event is triggered.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">passedArgs</span> <span class="o">=</span> <span class="p">[];</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'some event'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">passedArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'some event'</span><span class="p">,</span> <span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span> <span class="p">);</span>

          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">passedArgs</span><span class="p">,</span> <span class="p">[</span><span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span><span class="p">]</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can also bind the passed context to the event callback.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">'blue'</span> <span class="p">};</span>
          <span class="kd">var</span> <span class="nx">changeColor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">'red'</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="c1">// How would you get 'this.color' to refer to 'foo' in the changeColor function?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'an event'</span><span class="p">,</span> <span class="nx">changeColor</span><span class="p">,</span> <span class="nx">foo</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'an event'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">'red'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Uses `all` as a special event name to capture all events bound to the object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 2'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also can remove custom events from objects.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy2</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy3</span> <span class="p">);</span>

          <span class="c1">// How do you unbind just a single callback for the event?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks tied to the event with a single method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 2 called once'</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy3</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 3 called once'</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks and events tied to the object with a single method?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre></div>

      <h3>
      <a name="user-content-app" class="anchor" href="#app"><span class="octicon octicon-link"></span></a>App</h3>

      <p>It can also be useful to write specs for any application bootstrap you may have in place. For the following module, our setup initiates and appends a TodoApp view and we can test anything from local instances of views being correctly defined to application interactions correctly resulting in changes to instances of local collections.</p>

      <div class="highlight highlight-javascript"><pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone Applications'</span> <span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">Backbone</span><span class="p">.</span><span class="nx">localStorageDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'testTodos'</span><span class="p">);</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;div id="app"&gt;&lt;/div&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoApp</span><span class="p">({</span> <span class="nx">appendTo</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">)</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should bootstrap the application by initializing the Collection.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Should bind Collection events to View creation.'</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span> <span class="s1">'Foo'</span> <span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span> <span class="s1">'keypress'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">keyCode</span><span class="o">:</span> <span class="mi">13</span> <span class="p">}</span> <span class="p">));</span>

            <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
       <span class="p">});</span>
      </pre></div>

      <h2>
      <a name="user-content-further-reading--resources" class="anchor" href="#further-reading--resources"><span class="octicon octicon-link"></span></a>Further Reading &amp; Resources</h2>

      <p>That's it for this section on testing applications with QUnit and SinonJS. I encourage you to try out the <a href="https://github.com/addyosmani/backbone-koans-qunit">QUnit Backbone.js Koans</a> and see if you can extend some of the examples. For further reading consider looking at some of the additional resources below:</p>

      <ul>
      <li><strong><a href="http://tddjs.com/">Test-driven JavaScript Development (book)</a></strong></li>
      <li><strong><a href="http://sinonjs.org/qunit/">SinonJS/QUnit Adapter</a></strong></li>
      <li><strong><a href="http://cjohansen.no/en/javascript/using_sinon_js_with_qunit">SinonJS and QUnit</a></strong></li>
      <li><strong><a href="http://msdn.microsoft.com/en-us/scriptjunkie/gg749824">Automating JavaScript Testing With QUnit</a></strong></li>
      <li><strong><a href="http://benalman.com/talks/unit-testing-qunit.html">Ben Alman's Unit Testing With QUnit</a></strong></li>
      <li><strong><a href="https://github.com/jc00ke/qunit-backbone">Another QUnit/Backbone.js demo project</a></strong></li>
      <li><strong><a href="http://devblog.supportbee.com/2012/02/10/helpers-for-testing-backbone-js-apps-using-jasmine-and-sinon-js/">SinonJS helpers for Backbone</a></strong></li>
      </ul><h1>
      <a name="user-content-resources" class="anchor" href="#resources"><span class="octicon octicon-link"></span></a>Resources</h1>

      <p>Whilst what we get with Backbone out of the box can be terribly useful, there are some equally beneficial add-ons that can help simplify our development process. These include:</p>

      <ul>
      <li><a href="https://github.com/derickbailey/backbone.marionette">Backbone Marionette</a></li>
      <li><a href="https://github.com/tbranyen/backbone.layoutmanager">Backbone Layout Manager</a></li>
      <li><a href="https://github.com/backbone-boilerplate/backbone-boilerplate">Backbone Boilerplate</a></li>
      <li><a href="https://github.com/derickbailey/backbone.modelbinding">Backbone Model Binding</a></li>
      <li><a href="https://github.com/PaulUithol/Backbone-relational">Backbone Relational - for model relationships</a></li>
      <li><a href="https://github.com/janmonschke/backbone-couchdb">Backbone CouchDB</a></li>
      <li><a href="https://github.com/n-time/backbone.validations">Backbone Validations - HTML5 inspired validations</a></li>
      </ul><p>In time, there will be tutorials in the book covering some of these resources but until then, please feel free to check them out.</p>

      <h1>
      <a name="user-content-conclusions-4" class="anchor" href="#conclusions-4"><span class="octicon octicon-link"></span></a>Conclusions</h1>

      <p>That's it for 'Developing Backbone.js Applications'. I hope you found this book both useful, enlightening and a good start for your journey into exploring Backbone.js.</p>

      <p>If there are other topics or areas of this book you feel could be expanded further, please feel free to let me know, or better yet, send a pull request upstream. I'm always interested in making this title as comprehensive as possible.</p>

      <p>Until next time, the very best of luck with the rest of your journey!</p>

      <h2>
      <a name="user-content-notes" class="anchor" href="#notes"><span class="octicon octicon-link"></span></a>Notes</h2>

      <p>I would like to thank the Backbone.js, Stack Overflow, DailyJS (Alex Young) and JavaScript communities for their help, references and contributions to this book. This project would not be possible without you so thank you! :)</p>

      <hr><p>Where relevant, copyright Addy Osmani, 2012.</p></article>
    </div>

    <div class="diff markdown-body">

<article class="markdown-body entry-content changed" itemprop="mainContentOfPage"><div class="expandable unchanged">
<h2>
      <a name="user-content-prelude" class="anchor" href="#prelude"><span class="octicon octicon-link"></span></a>Prelude</h2>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/logo.jpg" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/logo.jpg" alt="" style="max-width:100%;"></a></p>
<p>Welcome to my (in-progress) book about the <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> framework for structuring JavaScript applications. It's released under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">license</a> meaning you can both grab a copy of the book for free or help to further <a href="https://github.com/addyosmani/backbone-fundamentals/">improve</a> it.</p>
<p>I'm very pleased to announce that this book will be out in physical form later in the year via <a href="http://oreilly.com">O'Reilly Media</a>. Readers will have the option of purchasing the latest version in either print or a number of digital formats then or can grab a recent version from this repository.</p>
<p>Corrections to existing material are always welcome and I hope that together we can provide the community with an up-to-date resource that is of help.
      My extended thanks go out to <a href="https://github.com/jashkenas">Jeremy Ashkenas</a> for creating Backbone.js and <a href="https://github.com/addyosmani/backbone-fundamentals/contributors">these</a> members of the community for their assistance tweaking this project.</p>
<p>I hope you find this book helpful!</p>
<p><strong>Notes:</strong></p>
<ul>
<li>Items added or updated in the last month are marked with a * in the outline.</li>
      <li>Once you're familiar with Backbone.js, you might be interested in checking out <a href="https://github.com/addyosmani/aura">Aura</a>.</li>
      </ul>
<h1>
      <a name="user-content-introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>
<p>When writing a Web application from scratch, it’s easy to feel like we can get by simply by relying on a DOM manipulation library (like jQuery) and a handful of utility plugins. The problem with this is that it doesn’t take long to get lost in a nested pile of jQuery callbacks and DOM elements without any real structure in place for our applications.</p>
<p>In short, we’re stuck with spaghetti code. Fortunately there are modern JavaScript frameworks that can assist with bringing structure and organization to our projects, improving how easily maintainable they are in the long-run.</p>
<h3>
      <a name="user-content-what-is-mvc-or-rather-mv" class="anchor" href="#what-is-mvc-or-rather-mv"><span class="octicon octicon-link"></span></a>What Is MVC, Or Rather MV*?</h3>
<p>These modern frameworks provide developers an easy path to organizing their code using variations of a pattern known as MVC (Model-View-Controller). MVC separates the concerns in an application down into three parts:</p>
<ul>
<li>Models represent the domain-specific knowledge and data in an application. Think of this as being a ‘type’ of data you can model — like a User, Photo or Todo note. Models should notify anyone observing them about their current state (e.g Views).</li>
      <li>Views are typically considered the User-interface in an application (e.g your markup and templates), but don’t have to be. They should know about the existence of Models in order to observe them, but don’t directly communicate with them.</li>
      <li>Controllers handle the input (e.g clicks, user actions) in an application and Views can be considered as handling the output. When a Controller updates the state of a model (such as editing Todo note content), it doesn’t directly tell the View. This is what the observing nature of the View and Model relationship is for.</li>
      </ul>
<p>JavaScript ‘MVC’ frameworks that can help us structure our code don’t always strictly follow the above pattern. Some frameworks will include the responsibility of the Controller in the View (e.g Backbone.js) whilst others add their own opinionated components into the mix as they feel this is more effective.</p>
<p>For this reason we refer to such frameworks as following the MV* pattern, that is, you’re likely to have a View and a Model, but more likely to have something else also included.</p>
<h3>
      <a name="user-content-what-exactly-is-backbonejs" class="anchor" href="#what-exactly-is-backbonejs"><span class="octicon octicon-link"></span></a>What exactly is Backbone.js?</h3>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/backbonejsorg.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/backbonejsorg.png" alt="" style="max-width:100%;"></a></p>
<p>Backbone.js is a lightweight JavaScript framework for adding structure to your client-side code. It makes it easy to manage and decouple concerns in your application, leaving you with code that is more maintainable in the long term.</p>
<p>Developers commonly use frameworks like Backbone.js to create single-page applications or SPAs. To put it simply, these apps enable the browser to react to changes in data on the client-side without the need to completely load up all your markup from the server, meaning no complete page-refreshes are necessary.</p>
<p>Backbone.js is a mature, popular framework at the time of writing and has both a large development community online as well as a wealth of plugins and extensions available to build upon it. It has been used to create non-trivial applications by companies such as
      Disqus, Walmart, SoundCloud and Foursquare.</p>
<h3>
      <a name="user-content-when-do-you-need-a-javascript-mv-framework" class="anchor" href="#when-do-you-need-a-javascript-mv-framework"><span class="octicon octicon-link"></span></a>When Do You Need A JavaScript MV* Framework?</h3>
<p>When building a single-page application using JavaScript, whether it involves a complex user interface or is simply trying to reduce the number of HTTP requests required for new Views, you will likely find yourself inventing many of the pieces that make up an MV* framework like Backbone or Ember.</p>
<p>At the outset, it isn’t terribly difficult to write an application framework that offers some opinionated way to avoid spaghetti code, however to say that it is equally as trivial to write something of the standard of Backbone would be a grossly incorrect assumption.</p>
<p>There’s a lot more that goes into structuring an application than tying together a DOM manipulation library, templating and routing. Mature MV* frameworks typically not only include many of the pieces you would find yourself writing, but also include solutions to problems you’ll find yourself running into later on down the road. This is a time-saver that you shouldn’t underestimate the value of.</p>
<p>So, where will you likely need an MV* framework and where won’t you?</p>
<p>If you’re writing an application that will likely only be communicating with an API or back-end data service, where much of the heavy lifting for viewing or manipulating that data will be occurring in the browser, you may find a JavaScript MV* framework useful.
      Good examples of applications that fall into this category are GMail and Google Docs.</p>
<p>These applications typically download a single payload containing all the scripts, stylesheets and markup users need for common tasks and then perform a lot of additional behavior in the background. It’s trivial to switch between reading an email or document to writing one and you don’t need to ask the application to render the whole page again at all.</p>
<p>If, however, you’re building an application that still relies on the server for most of the heavy-lifting of Views/pages and you’re just using a little JavaScript or jQuery to make things a little more interactive, an MV framework may be overkill. There certainly are complex Web applications where the partial rendering of views can* be coupled with a single-page application effectively, but for everything else, you may find yourself better sticking to a simpler setup.</p>
<p>Maturity in software (framework) development isn't simply about how long a framework has been around. It's about how solid the framework is and more importantly how well it's evolved to fill its role. Has it become more effective at solving common problems? Does it continue to improve as developers build larger and more complex applications with it?</p>
<h3>
      <a name="user-content-why-should-you-consider-using-backbonejs" class="anchor" href="#why-should-you-consider-using-backbonejs"><span class="octicon octicon-link"></span></a>Why should you consider using Backbone.js?</h3>
<p>Does the following describe you?:</p>
<p>"I want something flexible which offers a minimalist solution to separating concerns in my application. It should support a persistence layer and RESTful sync, models, views (with controllers), event-driven communication, templating and routing. It should be imperative, allowing one to update the View when a model changes. I’d like some decisions about the architecture left up to me. Ideally, many large companies have used the solution to build non-trivial applications.</p>
<p>As I may be building something complex, I’d like there to be an active extension community around the framework that have already tried addressing larger problems (Marionette, Chaplin, Aura, Thorax). Ideally, there are also scaffolding tools (grunt-bbb, brunch) available for the solution."</p>
<p>If so, continue reading.</p>
<p>Backbone's main benefits, regardless of your target platform or device, include helping:</p>
<ul>
<li>Organize the structure to your application</li>
      <li>Simplify server-side persistence</li>
      <li>Decouple the DOM from your page's data</li>
      <li>Model data, views and routers in a succinct manner</li>
      <li>Provide DOM, model and collection synchronization</li>
      </ul>
<h3>
      <a name="user-content-what-should-you-expect-to-see-in-this-book" class="anchor" href="#what-should-you-expect-to-see-in-this-book"><span class="octicon octicon-link"></span></a>What should you expect to see in this book?</h3>
<p>The goal of this book is to create an authoritative and centralized repository of information that can help those developing real-world apps with Backbone. If you come across a section or topic which you think could be improved or expanded on, please feel free to submit a pull-request. It won't take long and you'll be helping other developers avoid problems you've run into before.</p>
<p>Topics will include MVC theory and how to build applications using Backbone's models, views, collections and routers. I'll also be taking you through advanced topics like modular development with Backbone.js and AMD (via RequireJS), how to build applications using modern software stacks (like Node and Express), how to solve the routing problems with Backbone and jQuery Mobile, tips about scaffolding tools, and a lot more.</p>
<h1>
      <a name="user-content-fundamentals" class="anchor" href="#fundamentals"><span class="octicon octicon-link"></span></a>Fundamentals</h1>
<p>In this section, we're going to explore how frameworks like Backbone.js fit in the world of JavaScript application architecture. Classically, developers creating desktop and server-class applications have had a wealth of design patterns available for them to lean on, but it's only been in the past few years that such patterns have come to client-side development.</p>
<p>Before exploring any JavaScript frameworks that assist in structuring applications, it can be useful to gain a basic understanding of architectural design patterns.</p>
<h3>
      <a name="user-content-mvc-mvp--backbonejs" class="anchor" href="#mvc-mvp--backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP &amp; Backbone.js</h3>
<p>Design patterns are proven solutions to common development problems and can suggest structural approaches to help guide developers in adding some organization to their applications.</p>
<p>Patterns are useful because they're a set of practices that build upon the collective experience of skilled developers who have repeatedly solved similar problems. Although developers 10 or 20 years ago may not have been using the same programming languages when implementing patterns in their projects, there are many lessons we can learn from their efforts.</p>
<p>In this section, we're going to review two popular patterns - MVC and MVP. We'll be exploring in greater detail how Backbone.js implements these patterns shortly to better appreciate where it fits in.</p>
<h2>
      <a name="user-content-mvc" class="anchor" href="#mvc"><span class="octicon octicon-link"></span></a>MVC</h2>
<p>MVC (Model-View-Controller) is an architectural design pattern that encourages improved application organization through a separation of concerns. It enforces the isolation of business data (Models) from user interfaces (Views), with a third component (Controllers) traditionally present to manage logic, user-input and the coordination of models and views. The pattern was originally designed by <a href="http://en.wikipedia.org/wiki/Trygve_Reenskaug">Trygve Reenskaug</a> while working on Smalltalk-80 (1979), where it was initially called Model-View-Controller-Editor. MVC was described in depth in <a href="http://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612">“Design Patterns: Elements of Reusable Object-Oriented Software”</a> (The "GoF" or “Gang of Four” book) in 1994, which played a role in popularizing its use.</p>
<h3>
      <a name="user-content-smalltalk-80-mvc" class="anchor" href="#smalltalk-80-mvc"><span class="octicon octicon-link"></span></a>Smalltalk-80 MVC</h3>
<p>It's important to understand what the original MVC pattern was aiming to solve as it has changed quite heavily since the days of its origin. Back in the 70's, graphical user-interfaces were few and far between. An approach known as <a href="http://martinfowler.com/eaaDev/uiArchs.html">Separated Presentation</a> began to be used as a means to make a clear division between domain objects which modeled concepts in the real world (e.g a photo, a person) and the presentation objects which were rendered to the user's screen.</p>
<p>The Smalltalk-80 implementation of MVC took this concept further and had an objective of separating out the application logic from the user interface. The idea was that decoupling these parts of the application would also allow the reuse of models for other interfaces in the application. There are some interesting points worth noting about Smalltalk-80's MVC architecture:</p>
<ul>
<li>A Domain element was known as a Model and were ignorant of the user-interface (Views and Controllers)</li>
      <li>Presentation was taken care of by the View and the Controller, but there wasn't just a single view and controller. A View-Controller pair was required for each element being displayed on the screen and so there was no true separation between them</li>
      <li>The Controller's role in this pair was handling user input (such as key-presses and click events), doing something sensible with them.</li>
      <li>The Observer pattern was relied upon for updating the View whenever the Model changed</li>
      </ul>
<p>Developers are sometimes surprised when they learn that the Observer pattern (nowadays commonly implemented as a Publish/Subscribe system) was included as a part of MVC's architecture decades ago. In Smalltalk-80's MVC, the View and Controller both observe the Model: anytime the Model changes, the Views react. A simple example of this is an application backed by stock market data - for the application to show real-time information, any change to the data in its Models should result in the View being refreshed instantly.</p>
<p>Martin Fowler has done an excellent job of writing about the <a href="http://martinfowler.com/eaaDev/uiArchs.html">origins</a> of MVC over the years and if you are interested in further historical information about Smalltalk-80's MVC, I recommend reading his work.</p>
<h2>
      <a name="user-content-mvc-as-we-know-it" class="anchor" href="#mvc-as-we-know-it"><span class="octicon octicon-link"></span></a>MVC As We Know It</h2>
<p>We've reviewed the 70's, but let us now return to the here and now. The MVC pattern has been applied to a diverse range of programming languages. For example, the popular Ruby on Rails is an implementation of a web application framework based on MVC for the Ruby language. JavaScript now has a number of MVC frameworks, including Ember.js, JavaScriptMVC, and of course Backbone.js. Given the importance of avoiding "spaghetti" code, a term which describes code that is very difficult to read or maintain due to its lack of structure, let's look at what the MVC pattern enables the Javascript developer to do.</p>
<p>MVC is composed of three core components:</p>
<h3>
      <a name="user-content-models" class="anchor" href="#models"><span class="octicon octicon-link"></span></a>Models</h3>
<p>Models manage the data for an application. They are concerned with neither the user-interface nor presentation layers, but instead represent structured data that an application may require. When a model changes (e.g when it is updated), it will typically notify its observers (e.g views, a concept we will cover shortly) that a change has occurred so that they may react accordingly.</p>
<p>To understand models better, let us imagine we have a JavaScript todo application. In a todo app, a todo item would merit its own model, as it represents a unique kind of domain-specific data. The Todo model may represent attributes such as a title and completed. A specific todo would be stored in an instance of a model. Here's an example of a simple Todo model implemented with Backbone.js:</p>
<pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// todo instantiated with default attributes </span>
        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default title: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// ""</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Todo's default status: "</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

        <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Enjoy reading the book'</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title changed: '</span> <span class="o">+</span> <span class="nx">firstTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

        <span class="c1">// new todo instantiated with todo specific data</span>
        <span class="kd">var</span> <span class="nx">secondTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Try this code in chrome console'</span><span class="p">});</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo title: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Second todo status: "</span> <span class="o">+</span> <span class="nx">secondTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre>
<p>The built-in capabilities of models vary across frameworks, however it's common for them to support validation of attributes, where attributes represent the properties of the model, such as a model identifier. When using models in real-world applications we generally also need a way of persisting models. Persistence allows us to edit and update models with the knowledge that their most recent states will be saved somewhere, for example in a web browser's localStorage data-store or synchronized with a database.</p>
<p>A model may also have multiple views observing it. Imagine our Todo model contained meta-data such as the scheduled date, notes, days on which to repeat (if it's something we do on regular basis). A developer could create a single view that displayed all these attributes, or might create three separate views to display each attribute. The important detail is that the Todo model doesn't care how these views are organized, it simply announces updates to its data as necessary. We'll come back to Views in more detail later.</p>
<p>It is not uncommon for modern MVC/MV* frameworks to provide a means to group models together. In Backbone, these groups are called "Collections". Managing models in groups allows us to write application logic based on notifications from the group, should any model it contains change. This avoids the need to manually observe individual model instances.</p>
<p>Here's how we might group Todo models into a Backbone Collection:</p>
<pre>  <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="c1">// Default attributes for the todo</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Todos</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// For simplicity we'll use localStorage throughout the first part of book.</span>
          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>

          <span class="c1">// When working with REST API on back-end here would be</span>
          <span class="c1">// appropriate to use:</span>
          <span class="c1">// url: "/todos"</span>

        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">firstTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read whole book'</span><span class="p">});</span>

        <span class="c1">// pass array of models on collection instantiation</span>
        <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todos</span><span class="p">([</span><span class="nx">firstTodo</span><span class="p">]);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection's convenience method used to create </span>
        <span class="c1">// new model instance within collection itself.</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">thirdTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Make something cool'</span><span class="p">});</span>

        <span class="c1">// Adds model to collection</span>
        <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">thirdTodo</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="c1">// Collection keeps models in models </span>
        <span class="c1">// property which is an array.</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">models</span><span class="p">);</span>
      </pre>
<p>If you read older texts on MVC, you may come across a description of models as also managing application "state". In JavaScript applications state has a specific meaning, typically referring to the current state of a view or sub-view on a user's screen at a fixed time. State is a topic which is regularly discussed when looking at Single-page applications, where the concept of state needs to be simulated.</p>
<h3>
      <a name="user-content-views" class="anchor" href="#views"><span class="octicon octicon-link"></span></a>Views</h3>
<p>Views are a visual representation of models that present a filtered view of their current state. A view typically observes a model and is notified when the model changes, allowing the view to update itself accordingly. Design pattern literature commonly refers to views as 'dumb', given that their knowledge of models and controllers in an application is limited.</p>
<p>Users interact with views, which usually means reading and editing model data. For example, in our todo application example, todo model viewing might happen in a user interface in the list of all todo items. Within it each todo is rendered with their title and completed checkbox. Model editing could be done through an "edit" view where a user who has selected a specific todo could edit its title in a form.</p>
<p>In MVC, the actual task of updating the Model falls to Controllers, which we'll be covering shortly.</p>
<p>Let's explore Views a little further using a simple JavaScript example. Below we can see a function that creates a single Todo view, consuming both a model instance and a controller instance.</p>
<p>We define a <code>render()</code> utility within our view which is responsible for rendering the contents of the <code>todoModel</code> using a JavaScript templating engine (<a href="http://underscorejs.org" title="Underscore.js">Underscore</a> templating) and updating the contents of our view, referenced by <code>todoEl</code>.</p>
<p>The <code>todoModel</code> then adds our <code>render()</code> callback as one of its subscribers, so that through the Observer pattern it can trigger the view to update when the model changes.</p>
<p>You may wonder where user interaction comes into play here. When users click on any elements within the view, it's not the view's responsibility to know what to do next. A Controller makes this decision. In our sample implementation, this is achieved by adding an event listener to <code>todoEl</code> which will delegate handling the click behavior back to the controller, passing the model information along with it in case it's needed.</p>
<p>The benefit of this architecture is that each component plays its own separate role in making the application function as needed.</p>
<pre><span class="kd">var</span> <span class="nx">buildTodoView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">todoModel</span><span class="p">,</span> <span class="nx">todoController</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">base</span>       <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">),</span>
            <span class="nx">todoEl</span>     <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>

        <span class="nx">base</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">todoEl</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">render</span><span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// We use a templating library such as Underscore</span>
          <span class="c1">// templating which generates the HTML for our</span>
          <span class="c1">// todo entry</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="s1">'todoTemplate'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">src</span><span class="o">:</span> <span class="nx">todoModel</span><span class="p">.</span><span class="nx">getSrc</span><span class="p">()</span> <span class="p">});</span>
         <span class="p">}</span>

        <span class="nx">todoModel</span><span class="p">.</span><span class="nx">addSubscriber</span><span class="p">(</span> <span class="nx">render</span> <span class="p">);</span>

        <span class="nx">todoEl</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoController</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">todoModel</span> <span class="p">);</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">todoEl</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span>  <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">showView</span><span class="o">:</span> <span class="nx">show</span><span class="p">,</span>
          <span class="nx">hideView</span><span class="o">:</span> <span class="nx">hide</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre>
<p><strong>Templating</strong></p>
<p>In the context of JavaScript frameworks that support MVC/MV*, it is worth looking more closely at JavaScript templating and its relationship to Views.</p>
<p>It has long been considered bad practice (and computationally expensive) to manually create large blocks of HTML markup in-memory through string concatenation. Developers using this technique often find themselves iterating through their data, wrapping it in nested divs and using outdated techniques such as <code>document.write</code> to inject the 'template' into the DOM. This approach often means keeping scripted markup inline with standard markup, which can quickly become difficult to read and maintain, especially when building large applications.</p>
<p>JavaScript templating libraries (such as Handlebars.js or Mustache) are often used to define templates for views as HTML markup containing template variables. These template blocks can be either stored externally or within script tags with a custom type (e.g 'text/template'). Variables are delimited using a variable syntax (e.g {{title}}). Javascript template libraries typically accept data in JSON, and the grunt work of populating templates with data is taken care of by the framework itself. This has a several benefits, particularly when opting to store templates externally as this can let applications load templates dynamically on an as-needed basis.</p>
<p>Let's compare two examples of HTML templates. One is implemented using the popular Handlebars.js library, and the other uses Underscore's 'microtemplates'.</p>
<p><strong>Handlebars.js:</strong></p>
<pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">{{#</span><span class="na">if</span> <span class="na">completed</span><span class="err">}}</span> <span class="err">"</span><span class="na">checked</span><span class="err">"</span> <span class="err">{{/</span><span class="na">if</span><span class="err">}}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label&gt;</span>{{title}}<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"{{title}}"</span><span class="nt">&gt;</span>
      </pre>
<p><strong>Underscore.js Microtemplates:</strong></p>
<pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"view"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">completed</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span>&gt;
        <span class="nt">&lt;label&gt;</span><span class="err">&lt;</span>%= title %&gt;<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"destroy"</span><span class="nt">&gt;&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"edit"</span> <span class="na">value=</span><span class="s">"&lt;%= title %&gt;"</span><span class="nt">&gt;</span>
      </pre>
<p>You may also use double curly brackets (i.e <code>{{}}</code>) (or any other tag you feel comfortable with) in Microtemplates. In the case of curly brackets, this can be done by setting the Underscore <code>templateSettings</code> attribute as follows:</p>
<pre><span class="nx">_</span><span class="p">.</span><span class="nx">templateSettings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">interpolate</span> <span class="o">:</span> <span class="sr">/\{\{(.+?)\}\}/g</span> <span class="p">};</span>
      </pre>
<p><strong>A note on navigation and state</strong></p>
<p>It is also worth noting that in classical web development, navigating between independent views required the use of a page refresh. In single-page JavaScript applications, however, once data is fetched from a server via Ajax, it can be dynamically rendered in a new view within the same page. Since this doesn't automatically update the URL, the role of navigation thus falls to a "router", which assists in managing application state (e.g allowing users to bookmark a particular view they have navigated to). As routers are however neither a part of MVC nor present in every MVC-like framework, I will not be going into them in greater detail in this section.</p>
<h3>
      <a name="user-content-controllers" class="anchor" href="#controllers"><span class="octicon octicon-link"></span></a>Controllers</h3>
<p>Controllers are an intermediary between models and views which are classically responsible for two tasks: they both update the view when the model changes and update the model when the user manipulates the view.</p>
<p>In our Todo application, a controller would be responsible for handling changes the user made in the edit view for a particular todo, updating a specific todo model when a user has finished editing.</p>
<p>It's with controllers that most JavaScript MVC frameworks depart from this interpretation of the MVC pattern. The reasons for this vary, but in my opinion, Javascript framework authors likely initially looked at server-side interpretations of MVC (such as Ruby on Rails), realized that that approach didn't translate 1:1 on the client-side, and so re-interpreted the C in MVC to solve their state management problem. This was a clever approach, but it can make it hard for developers coming to MVC for the first time to understand both the classical MVC pattern and the "proper" role of controllers in other non-Javascript frameworks.</p>
<p>So does Backbone.js have Controllers? Not really. Backbone's Views typically contain "controller" logic, and Routers (discussed below) are used to help manage application state, but neither are true Controllers according to classical MVC.</p>
<p>In this respect, contrary to what might be mentioned in the official documentation or in blog posts, Backbone is neither a truly MVC/MVP nor MVVM framework. It's in fact better to see it a member of the MV* family which approaches architecture in its own way. There is of course nothing wrong with this, but it is important to distinguish between classical MVC and MV* should you be relying on discussions of MVC to help with your Backbone projects.</p>
<h3>
      <a name="user-content-controllers-in-spinejs-vs-backbonejs" class="anchor" href="#controllers-in-spinejs-vs-backbonejs"><span class="octicon octicon-link"></span></a>Controllers in Spine.js vs Backbone.js</h3>
<p><strong>Spine.js</strong></p>
<p>We now know that controllers are traditionally responsible for updating the view when the model changes (and similarly the model when the user updates the view). Since Backbone doesn't have its <strong>own</strong> explicit controllers, it's useful to review the controller from another MVC framework to appreciate the difference in implementations. Let's take a look at <a href="http://spinejs.com/">Spine.js</a>:</p>
<p>In this example, we're going to have a controller called <code>TodoController</code> which would be in charge of individual todos in the application. It will ensure that when the view updates (e.g a user edited the todo) the corresponding model does too.</p>
<p>(Note: We won't be delving heavily into Spine.js beyond this example, but it's worth looking at it to learn more about Javascript frameworks in general.)</p>
<pre><span class="c1">// Controllers in Spine are created by inheriting from Spine.Controller</span>

      <span class="kd">var</span> <span class="nx">TodoController</span> <span class="o">=</span> <span class="nx">Spine</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">sub</span><span class="p">({</span>
        <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">));</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">proxy</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">));</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// Handle templating</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-template'</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">item</span><span class="p">));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>In Spine, controllers are considered the glue for an application, adding and responding to DOM events, rendering templates and ensuring that views and models are kept in sync (which makes sense in the context of what we know to be a controller).</p>
<p>What we're doing in the above example is setting up listeners in the <code>update</code> and <code>destroy</code> events using <code>render()</code> and <code>remove()</code>. When a todo entry gets updated, we re-render the view to reflect the changes to the todo title. Similarly, if the todo gets deleted from todo list, we remove it from the view. In case you were wondering about the <code>tmpl()</code> function in the code snippet: in the <code>render()</code> function, we're using this to render a JavaScript template called #todoTemplate which simply returns an HTML string used to replace the controller's current element.</p>
<p>What this provides us with is a very lightweight, simple way to manage changes between the model and the view.</p>
<p><strong>Backbone.js</strong></p>
<p>Later on in this section we're going to revisit the differences between Backbone and traditional MVC, but for now let's focus on controllers.</p>
<p>In Backbone, controller logic is shared between Backbone.View and Backbone.Router. Earlier releases of Backbone contained something called Backbone.Controller, but it was renamed to Router to clarify its role.</p>
<p>A Router's main purpose is to translate URL requests into application states. It does that by mapping URLs to functions. When a user browses to the URL <a href="http://www.example.com/filter/completed">www.example.com/filter/completed</a>, a Router could be used to show just todos which are completed, and to define what application behavior should be run in response to that request. Routers <em>can</em> contain traditional controller responsibilities, such as binding the events between models and views, or rendering parts of the page. However, Backbone contributor Tim Branyen has pointed out that it's possible to get away without needing Backbone.Router at all for this, so a way to think about it using the Router paradigm is probably:</p>
<pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span> <span class="s2">"/filter/:name"</span><span class="o">:</span> <span class="s2">"setFilter"</span> <span class="p">},</span>
        <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"set filter: "</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-what-does-mvc-give-us" class="anchor" href="#what-does-mvc-give-us"><span class="octicon octicon-link"></span></a>What does MVC give us?</h2>
<p>To summarize, the separation of concerns in MVC facilitates modularization of an application's functionality and enables:</p>
<ul>
<li>Easier overall maintenance. When updates need to be made to the application it is clear whether the changes are data-centric, meaning changes to models and possibly controllers, or merely visual, meaning changes to views.</li>
      <li>Decoupling models and views means that it's straight-forward to write unit tests for business logic</li>
      <li>Duplication of low-level model and controller code is eliminated across the application</li>
      <li>Depending on the size of the application and separation of roles, this modularity allows developers responsible for core logic and developers working on the user-interfaces to work simultaneously</li>
      </ul>
<h3>
      <a name="user-content-delving-deeper" class="anchor" href="#delving-deeper"><span class="octicon octicon-link"></span></a>Delving deeper</h3>
<p>Right now, you likely have a basic understanding of what the MVC pattern provides, but for the curious, we'll explore it a little further.</p>
<p>The GoF (Gang of Four) do not refer to MVC as a design pattern, but rather consider it a "set of classes to build a user interface". In their view, it's actually a variation of three other classical design patterns: the Observer (Pub/Sub), Strategy and Composite patterns. Depending on how MVC has been implemented in a framework, it may also use the Factory and Decorator patterns. I've covered some of these patterns in my other free book, JavaScript Design Patterns For Beginners if you would like to read into them further.</p>
<p>As we've discussed, models represent application data, while views handle what the user is presented on screen. As such, MVC relies on Pub/Sub for some of its core communication (something that surprisingly isn't covered in many articles about the MVC pattern). When a model is changed it "publishes" to the rest of the application that it has been updated. The "subscriber"--generally a Controller--then updates the view accordingly. The observer-viewer nature of this relationship is what facilitates multiple views being attached to the same model.</p>
<p>For developers interested in knowing more about the decoupled nature of MVC (once again, depending on the implementation), one of the goals of the pattern is to help define one-to-many relationships between a topic and its observers. When a topic changes, its observers are updated. Views and controllers have a slightly different relationship. Controllers facilitate views to respond to different user input and are an example of the Strategy pattern.</p>
<h3>
      <a name="user-content-summary" class="anchor" href="#summary"><span class="octicon octicon-link"></span></a>Summary</h3>
<p>Having reviewed the classical MVC pattern, you should now understand how it allows developers to cleanly separate concerns in an application. You should also now appreciate how JavaScript MVC frameworks may differ in their interpretation of MVC, and how they share some of the fundamental concepts of the original pattern.</p>
<p>When reviewing a new JavaScript MVC/MV* framework, remember - it can be useful to step back and consider how it's opted to approach Models, Views, Controllers or other alternatives, as this can better help you grok how the framework expects to be used.</p>
<h2>
      <a name="user-content-mvp" class="anchor" href="#mvp"><span class="octicon octicon-link"></span></a>MVP</h2>
<p>Model-view-presenter (MVP) is a derivative of the MVC design pattern which focuses on improving presentation logic. It originated at a company named <a href="http://en.wikipedia.org/wiki/Taligent">Taligent</a> in the early 1990s while they were working on a model for a C++ CommonPoint environment. Whilst both MVC and MVP target the separation of concerns across multiple components, there are some fundamental differences between them.</p>
<p>For the purposes of this summary we will focus on the version of MVP most suitable for web-based architectures.</p>
<h3>
      <a name="user-content-models-views--presenters" class="anchor" href="#models-views--presenters"><span class="octicon octicon-link"></span></a>Models, Views &amp; Presenters</h3>
<p>The P in MVP stands for presenter. It's a component which contains the user-interface business logic for the view. Unlike MVC, invocations from the view are delegated to the presenter, which are decoupled from the view and instead talk to it through an interface. This allows for all kinds of useful things such as being able to mock views in unit tests.</p>
<p>The most common implementation of MVP is one which uses a Passive View (a view which is for all intents and purposes "dumb"), containing little to no logic. MVP models are almost identical to MVC models and handle application data. The presenter acts as a mediator which talks to both the view and model, however both of these are isolated from each other. They effectively bind models to views, a responsibility held by Controllers in MVC. Presenters are at the heart of the MVP pattern and as you can guess, incorporate the presentation logic behind views.</p>
<p>Solicited by a view, presenters perform any work to do with user requests and pass data back to them. In this respect, they retrieve data, manipulate it and determine how the data should be displayed in the view. In some implementations, the presenter also interacts with a service layer to persist data (models). Models may trigger events but it's the presenter's role to subscribe to them so that it can update the view. In this passive architecture, we have no concept of direct data binding. Views expose setters which presenters can use to set data.</p>
<p>The benefit of this change from MVC is that it increases the testability of your application and provides a more clean separation between the view and the model. This isn't however without its costs as the lack of data binding support in the pattern can often mean having to take care of this task separately.</p>
<p>Although a common implementation of a <a href="http://martinfowler.com/eaaDev/PassiveScreen.html">Passive View</a> is for the view to implement an interface, there are variations on it, including the use of events which can decouple the View from the Presenter a little more. As we don't have the interface construct in JavaScript, we're using it more and more a protocol than an explicit interface here. It's technically still an API and it's probably fair for us to refer to it as an interface from that perspective.</p>
<p>There is also a <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html">Supervising Controller</a> variation of MVP, which is closer to the MVC and <a href="http://en.wikipedia.org/wiki/Model_View_ViewModel">MVVM</a> patterns as it provides data-binding from the Model directly from the View. Key-value observing (KVO) plugins (such as Derick Bailey's Backbone.ModelBinding plugin) introduce this idea of a Supervising Controller to Backbone.</p>
<h2>
      <a name="user-content-mvp-or-mvc" class="anchor" href="#mvp-or-mvc"><span class="octicon octicon-link"></span></a>MVP or MVC?</h2>
<p>MVP is generally used most often in enterprise-level applications where it's necessary to reuse as much presentation logic as possible. Applications with very complex views and a great deal of user interaction may find that MVC doesn't quite fit the bill here as solving this problem may mean heavily relying on multiple controllers. In MVP, all of this complex logic can be encapsulated in a presenter, which can simplify maintenance greatly.</p>
<p>As MVP views are defined through an interface and the interface is technically the only point of contact between the system and the view (other than a presenter), this pattern also allows developers to write presentation logic without needing to wait for designers to produce layouts and graphics for the application.</p>
<p>Depending on the implementation, MVP may be more easy to automatically unit test than MVC. The reason often cited for this is that the presenter can be used as a complete mock of the user-interface and so it can be unit tested independent of other components. In my experience this really depends on the languages you are implementing MVP in (there's quite a difference between opting for MVP for a JavaScript project over one for say, ASP.NET).</p>
<p>At the end of the day, the underlying concerns you may have with MVC will likely hold true for MVP given that the differences between them are mainly semantic. As long as you are cleanly separating concerns into models, views and controllers (or presenters) you should be achieving most of the same benefits regardless of the pattern you opt for.</p>
<h2>
      <a name="user-content-mvc-mvp-and-backbonejs" class="anchor" href="#mvc-mvp-and-backbonejs"><span class="octicon octicon-link"></span></a>MVC, MVP and Backbone.js</h2>
<p>There are very few, if any architectural JavaScript frameworks that claim to implement the MVC or MVP patterns in their classical form as many JavaScript developers don't view MVC and MVP as being mutually exclusive (we are actually more likely to see MVP strictly implemented when looking at web frameworks such as ASP.NET or GWT). This is because it's possible to have additional presenter/view logic in your application and yet still consider it a flavor of MVC.</p>
<p>Backbone contributor <a href="http://ireneros.com/">Irene Ros</a> subscribes to this way of thinking as when she separates Backbone views out into their own distinct components, she needs something to actually assemble them for her. This could either be a controller route (such as a <code>Backbone.Router</code>, covered later in the book) or a callback in response to data being fetched.</p>
<p>That said, some developers do however feel that Backbone.js better fits the description of MVP than it does MVC
      . Their view is that:</p>
<ul>
<li>The presenter in MVP better describes the <code>Backbone.View</code> (the layer between View templates and the data bound to it) than a controller does</li>
      <li>The model fits <code>Backbone.Model</code> (it isn't that different from the classical MVC "Model")</li>
      <li>The views best represent templates (e.g Handlebars/Mustache markup templates)</li>
      </ul>
<p>A response to this could be that the view can also just be a View (as per MVC) because Backbone is flexible enough to let it be used for multiple purposes. The V in MVC and the P in MVP can both be accomplished by <code>Backbone.View</code> because they're able to achieve two purposes: both rendering atomic components and assembling those components rendered by other views.</p>
<p>We've also seen that in Backbone the responsibility of a controller is shared with both the Backbone.View and Backbone.Router and in the following example we can actually see that aspects of that are certainly true.</p>
<p>Here, our Backbone <code>TodoView</code> uses the Observer pattern to 'subscribe' to changes to a View's model in the line <code>this.model.on('change',...)</code>. It also handles templating in the <code>render()</code> method, but unlike some other implementations, user interaction is also handled in the View (see <code>events</code>).</p>
<pre><span class="c1">// The DOM element for a todo item...</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="c1">//... is a list tag.</span>
        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Pass the contents of the todo template through a templating</span>
        <span class="c1">// function, cache it for a single todo</span>
        <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="c1">// The DOM events specific to an item.</span>
        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span>
        <span class="p">},</span>

        <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
        <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
        <span class="c1">// app, we set a direct reference on the model for convenience.</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="c1">// Toggle the `"completed"` state of the model.</span>
        <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
        <span class="p">},</span>
      <span class="p">});</span>
      </pre>
<p>Another (quite different) opinion is that Backbone more closely resembles <a href="http://martinfowler.com/eaaDev/uiArchs.html#ModelViewController">Smalltalk-80 MVC</a>, which we went through earlier.</p>
<p>As regular Backbone user Derick Bailey has <a href="http://lostechies.com/derickbailey/2011/12/23/backbone-js-is-not-an-mvc-framework/">written</a>, it's ultimately best not to force Backbone to fit any specific design patterns. Design patterns should be considered flexible guides to how applications may be structured and in this respect, Backbone doesn't fit either MVC nor MVP perfectly. Instead, it borrows some of the best concepts from multiple architectural patterns and creates a flexible framework that just works well. Call it <strong>the Backbone way</strong>, MV* or whatever helps reference its flavor of application architecture.</p>
<p>It <em>is</em> however worth understanding where and why these concepts originated, so I hope that my explanations of MVC and MVP have been of help. Most structural JavaScript frameworks will adopt their own take on classical patterns, either intentionally or by accident, but the important thing is that they help us develop applications which are organized, clean and can be easily maintained.</p>
<h2>
      <a name="user-content-fast-facts" class="anchor" href="#fast-facts"><span class="octicon octicon-link"></span></a>Fast facts</h2>
<h3>
      <a name="user-content-backbonejs" class="anchor" href="#backbonejs"><span class="octicon octicon-link"></span></a>Backbone.js</h3>
<ul>
<li>Core components: Model, View, Collection, Router. Enforces its own flavor of MV*</li>
      <li>Good documentation, with more improvements on the way</li>
      <li>Used by large companies such as SoundCloud and Foursquare to build non-trivial applications</li>
      <li>Event-driven communication between views and models. As we'll see, it's relatively straight-forward to add event listeners to any attribute in a model, giving developers fine-grained control over what changes in the view</li>
      <li>Supports data bindings through manual events or a separate Key-value observing (KVO) library</li>
      <li>Great support for RESTful interfaces out of the box, so models can be easily tied to a backend</li>
      <li>Extensive eventing system. It's <a href="http://lostechies.com/derickbailey/2011/07/19/references-routing-and-the-event-aggregator-coordinating-views-in-backbone-js/">trivial</a> to add support for pub/sub in Backbone</li>
      <li>Prototypes are instantiated with the <code>new</code> keyword, which some developers prefer</li>
      <li>Agnostic about templating frameworks, however Underscore's micro-templating is available by default. Backbone works well with libraries like Handlebars</li>
      <li>Doesn't support deeply nested models, though there are Backbone plugins such as <a href="https://github.com/PaulUithol/Backbone-relational">this</a> which can help</li>
      <li>Clear and flexible conventions for structuring applications. Backbone doesn't force usage of all of its components and can work with only those needed.</li>
      </ul>
<h1>
      <a name="user-content-the-internals" class="anchor" href="#the-internals"><span class="octicon octicon-link"></span></a>The Internals</h1>
<p>In this section, you'll learn the essentials of Backbone's models, views, collections and routers, as well as about using namespacing to organize your code. This isn't meant as a replacement for the official documentation, but it will help you understand many of the core concepts behind Backbone before you start building applications with it.</p>
<ul>
<li>Models</li>
      <li>Collections</li>
      <li>Routers</li>
      <li>Views</li>
      <li>Namespacing</li>
      </ul>
<h2>
      <a name="user-content-models-1" class="anchor" href="#models-1"><span class="octicon octicon-link"></span></a>Models</h2>
<p>Backbone models contain interactive data for an application as well as the logic around this data. For example, we can use a model to represent the concept of a todo item including its attributes like title (todo content) and completed (current state of the todo).</p>
<p>Models can be created by extending <code>Backbone.Model</code> as follows:</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// We can then create our own concrete instance of a (Todo) model</span>
      <span class="c1">// with no values at all:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// or with some arbitrary data:</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the both model instances in the console.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>
      </pre>
<h4>
      <a name="user-content-initialization" class="anchor" href="#initialization"><span class="octicon octicon-link"></span></a>Initialization</h4>
<p>The <code>initialize()</code> method is called when a new instance of a model is created. Its use is optional, however you'll see why it's good practice to use it below.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      </pre>
<p><strong>Default values</strong></p>
<p>There are times when you want your model to have a set of default values (e.g. in a scenario where a complete set of data isn't provided by the user). This can be set using a property called <code>defaults</code> in your model.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Now we can create our concrete instance of the model </span>
      <span class="c1">// with default values as follows:</span>
      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">);</span>

      <span class="c1">// Or we could instantiate it with some of the attributes (e.g with custom title):</span>
      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Check attributes property of the logged models in the console.'</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">);</span>

      <span class="c1">// Or with all of the (default) attributes:</span>
      <span class="kd">var</span> <span class="nx">todo3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'This todo is done, so take no action on this one.'</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo3</span><span class="p">);</span>
      </pre>
<h4>
      <a name="user-content-getters--setters" class="anchor" href="#getters--setters"><span class="octicon octicon-link"></span></a>Getters &amp; Setters</h4>
<p><strong>Model.get()</strong></p>
<p><code>Model.get()</code> provides easy access to a model's attributes. All attributes, regardless if default ones or one passed through to the model on instantiation, are available for retrieval.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// empty string</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// false</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Retrieved with models get() method."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span> <span class="c1">// Retrieved with models get() method.</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span> <span class="c1">// true</span>
      </pre>
<p>If you need to read or clone all of a model's data attributes use its <code>toJSON</code> method. Despite the name it doesn't return a JSON string but a copy of the attributes as an object. ("toJSON" is part of the JSON.stringify specification. Passing an object with a toJSON method makes it stringify the return value of that method instead of the object itself.)</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">todo1Attributes</span> <span class="o">=</span> <span class="nx">todo1</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
      <span class="c1">// Following logs: {"title":"","completed":false} </span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo1Attributes</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Try these examples and check results in console."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="c1">// logs: {"title":"Try examples and check results in console.","completed":true}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
      </pre>
<p><strong>Model.set()</strong></p>
<p><code>Model.set()</code> allows us to pass attributes into an instance of our model. Attributes can either be set during initialization or at any time afterwards. Backbone uses Model.set() to know when to broadcast that a model's data has changed.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Setting the value of attributes via instantiation</span>
      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Set through instantiation."</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set single attribute value at the time through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Title attribute set through Model.set()."</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="c1">// Set map of attributes through Model.set():</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">"Both attributes set through Model.set()."</span><span class="p">,</span>
        <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo title: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre>
<p><strong>Direct access</strong></p>
<p>If you really need to access the attributes in a model's instance directly, there is <code>Model.attributes</code>. But remember it is best practice to use Model.get(), Model.set() or direct instantiation as explained above.</p>
<h4>
      <a name="user-content-listening-for-changes-to-your-model" class="anchor" href="#listening-for-changes-to-your-model"><span class="octicon octicon-link"></span></a>Listening for changes to your model</h4>
<p>Any and all of the attributes in a Backbone model can have listeners bound to them which detect when their values change. Listeners can be added to the <code>initialize()</code> function:</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'- Values for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'On each change of attribute values listener is triggered.'</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed has changed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">'Listener is triggered for each change, not for change of the each attribute.'</span><span class="p">,</span>
        <span class="s1">'complete'</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">});</span>
      </pre>
<p>In the following example, we log a message whenever a specific attribute (the title of our Todo model) is altered.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="c1">// Default todo attribute values</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:title'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Title value for this model have changed.'</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">},</span>
        <span class="nx">setTitle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newTitle</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

      <span class="c1">// Following changes trigger the listener:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'Check what\'s logged.'</span><span class="p">);</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="s1">'Go fishing on Sunday.'</span><span class="p">);</span>

      <span class="c1">// But, this change type is not observed, so no listener is triggered:</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Todo set as completed: '</span> <span class="o">+</span> <span class="nx">myTodo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">));</span>
      </pre>
<h4>
      <a name="user-content-validation" class="anchor" href="#validation"><span class="octicon octicon-link"></span></a>Validation</h4>
<p>Backbone supports model validation through <code>Model.validate()</code>, which allows checking the attribute values for a model prior to them being set.</p>
<p>Validation functions can be as simple or complex as necessary. If the attributes provided are valid, nothing should be returned from <code>.validate()</code>. If they are invalid, a custom error can be returned instead.</p>
<p>A basic example for validation can be seen below:</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attribs</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">attribs</span><span class="p">.</span><span class="nx">title</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
              <span class="k">return</span> <span class="s2">"Remember to set a title for your todo."</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This model has been initialized.'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span> <span class="c1">// logs: Remember to set a title for your todo.</span>
      </pre>
<p><strong>Note</strong>: Backbone passes the <code>attributes</code> object (attribs param in above example) by shallow copy to the <code>validate</code> function using the Underscore <code>_.extend</code> method. This means that it is not possible to change any Number, String or Boolean attribute but it <em>is</em> possible to change attributes of objects because they are passed by reference. As shallow copy doesn't copy objects by implicitly copying them, but rather, by reference, one can change the attributes on those objects.</p>
<p>An example of this (by @fivetanley) is available <a href="http://jsfiddle.net/2NdDY/7/">here</a>.</p>
<h2>
      <a name="user-content-views-1" class="anchor" href="#views-1"><span class="octicon octicon-link"></span></a>Views</h2>
<p>Views in Backbone don't contain the markup for your application, but rather they are there to support models by defining the logic for how they should be represented to the user. This is usually achieved using JavaScript templating (e.g. Mustache, jQuery-tmpl, etc.). A view's <code>render()</code> function can be bound to a model's <code>change()</code> event, allowing the view to always be up to date without requiring a full page refresh.</p>
<h4>
      <a name="user-content-creating-new-views" class="anchor" href="#creating-new-views"><span class="octicon octicon-link"></span></a>Creating new views</h4>
<p>Similar to the previous sections, creating a new view is relatively straight-forward. To create a new View, simply extend <code>Backbone.View</code>. I'll explain this code in detail below:</p>
<pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

        <span class="c1">// Cache the template function for a single item.</span>
        <span class="nx">todoTpl</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
          <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
          <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
        <span class="p">},</span>

        <span class="c1">// Re-render the titles of the todo item.</span>
        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoTpl</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo label is double clicked</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// executed when todo loses focus</span>
        <span class="p">},</span>

        <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// executed on each keypress when in todo edit mode, </span>
          <span class="c1">// but we'll wait for enter to get in action</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">();</span>

      <span class="c1">// logs reference to a DOM element that cooresponds to the view instance</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre>
<h4>
      <a name="user-content-what-is-el" class="anchor" href="#what-is-el"><span class="octicon octicon-link"></span></a>What is <code>el</code>?</h4>
<p><code>el</code> is basically a reference to a DOM element and all views must have one. It allows for all of the contents of a view to be inserted into the DOM at once, which makes for faster rendering because the browser performs the minimum required reflows and repaints.</p>
<p>There are two ways to attach a DOM element to a view: a new element is created for the view and added manually by the developer or the element already exists in the page.</p>
<p>If you want to create a new element for your view, set any combination of the following view's properties: <code>tagName</code>, <code>id</code> and <code>className</code>. A new element will be created for you by the framework and a reference to it will be available at the <code>el</code> property. If nothing is specified <code>el</code> defaults to <code>div</code>.</p>
<pre><span class="kd">var</span> <span class="nx">TodosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'ul'</span><span class="p">,</span> <span class="c1">// required, but defaults to 'div' if not set</span>
        <span class="nx">className</span><span class="o">:</span> <span class="s1">'container'</span><span class="p">,</span> <span class="c1">// optional, you can assign multiple classes to this property like so 'container homepage'</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">'todos'</span><span class="p">,</span> <span class="c1">// optional</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todosView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosView</span><span class="p">();</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todosView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
      </pre>
<p>The above code creates the <code>DOMElement</code> below but doesn't append it to the DOM.</p>
<pre><span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todos"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;&lt;/ul&gt;</span>
      </pre>
<p>If the element already exists in the page, you can set <code>el</code> as a CSS selector that matches the element.</p>
<pre><span class="nx">el</span><span class="o">:</span> <span class="s1">'#footer'</span>
      </pre>
<p><strong>Understanding <code>render()</code></strong></p>
<p><code>render()</code> is an optional function that defines the logic for rendering a template. We'll use Underscore's micro-templating in these examples, but remember you can use other templating frameworks if you prefer.</p>
<p>The <code>_.template</code> method in Underscore compiles JavaScript templates into functions which can be evaluated for rendering. In the above view, I'm passing the markup from a template with id <code>item-template</code> to <code>_.template()</code> to be compiled. Next, I set the html of the <code>el</code> DOM element to the output of processing a JSON version of the model associated with the view through the compiled template.</p>
<p>Presto! This populates the template, giving you a data-complete set of markup in just a few short lines of code.</p>
<p><strong>The <code>events</code> attribute</strong></p>
<p>The Backbone <code>events</code> attribute allows us to attach event listeners to either custom selectors, or directly to <code>el</code> if no selector is provided. An event takes the form <code>{'eventName selector': 'callbackFunction'}</code> and a number of DOM event-types are supported, including <code>click</code>, <code>submit</code>, <code>mouseover</code>, <code>dblclick</code> and more.</p>
<p>What isn't instantly obvious is that under the bonnet, Backbone uses jQuery's <code>.delegate()</code> to provide instant support for event delegation but goes a little further, extending it so that <code>this</code> always refers to the current view object. The only thing to really keep in mind is that any string callback supplied to the events attribute must have a corresponding function with the same name within the scope of your view.</p>
<h2>
      <a name="user-content-collections" class="anchor" href="#collections"><span class="octicon octicon-link"></span></a>Collections</h2>
<p>Collections are sets of Models and are created by extending <code>Backbone.Collection</code>.</p>
<p>Normally, when creating a collection you'll also want to pass through a property specifying the model that your collection will contain, as well as any instance properties required.</p>
<p>In the following example, we create a TodoCollection that will contain our Todo models:</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Read the whole book'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">});</span>

      <span class="c1">// pass array of models on collection instantiation</span>
      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">myTodo</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="c1">// Collection's convenience method used to create </span>
      <span class="c1">// new model instance within collection itself.</span>
      <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span><span class="s1">'Try out code examples'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">48</span><span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre>
<p><strong>Getters and Setters</strong></p>
<p>There are a few different ways to retrieve a model from a collection. The most straight-forward is to use <code>Collection.get()</code> which accepts a single id as follows:</p>
<pre><span class="c1">// extends on previous example</span>

      <span class="kd">var</span> <span class="nx">todo2</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

      <span class="c1">// Models, as objects, are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre>
<p>Internally <code>Backbone.Collection</code> sets an array of models enumerated by their <code>id</code> property, if model instances happen to have one. Once <code>collection.get(id)</code> is called this array is checked for existence of the model instance with the corresponding <code>id</code>.</p>
<p>Sometimes you may also want to get a model based on its client id. The client id is a property that Backbone automatically assigns models that have not yet been saved. You can get a model's client id from its <code>.cid</code> property.</p>
<pre><span class="c1">// extends on previous examples</span>

      <span class="kd">var</span> <span class="nx">todoCid</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">getByCid</span><span class="p">(</span><span class="nx">todo2</span><span class="p">.</span><span class="nx">cid</span><span class="p">);</span>

      <span class="c1">// As mentioned in previous example, </span>
      <span class="c1">// models are passed by reference</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">todo2</span> <span class="o">===</span> <span class="nx">myTodo</span><span class="p">);</span>
      </pre>
<p>Backbone Collections don't have setters as such, but do support adding new models via <code>.add()</code> and removing models via <code>.remove()</code>.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>
        <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">)</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Jamaica.'</span><span class="p">}),</span>
          <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to China.'</span><span class="p">}),</span>
          <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'Go to Disneyland.'</span><span class="p">});</span>

      <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodosCollection</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection size: "</span> <span class="o">+</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre>
<p><strong>Listening for events</strong></p>
<p>As collections represent a group of items, we're also able to listen for <code>add</code> and <code>remove</code> events for when new models are added or removed from the collection. Here's an example:</p>
<pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I should "</span> <span class="o">+</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">". Have I done it before? "</span>  <span class="o">+</span> <span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"completed"</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'Yeah!'</span><span class="o">:</span> <span class="s1">'Not.'</span> <span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>
      </pre>
<p>In addition, we're able to bind a <code>change</code> event to listen for changes to models in the collection.</p>
<pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"change:title"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Changed my mind where I should go, "</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

      <span class="nx">myTodo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'go fishing'</span><span class="p">);</span>
      </pre>
<p><strong>Fetching models from the server</strong></p>
<p><code>Collections.fetch()</code> retrieves a default set of models from the server in the form of a JSON array. When this data returns, the current collection's contents will be replaced with the contents of the array.</p>
<pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">'/todos'</span><span class="p">;</span>
      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
      </pre>
<p>During configuration, Backbone sets a variable to denote if extended HTTP methods are supported by the server. Another setting controls if the server understands the correct MIME type for JSON:</p>
<pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre>
<p>The Backbone.sync method that uses these values is actually an integral part of Backbone.js. A jQuery-like ajax method is assumed, so HTTP parameters are organised based on jQuery’s API. Searching through the code for calls to the sync method show it’s used whenever a model is saved, fetched, or deleted (destroyed).</p>
<p>Under the covers, <code>Backbone.sync</code> is the function called every time Backbone tries to read or save models to the server. It uses jQuery or Zepto's ajax implementations to make these RESTful requests, however this can be overridden as per your needs.</p>
<p>The sync function may be overriden globally as Backbone.sync, or at a finer-grained level, by adding a sync function to a Backbone collection or to an individual model.</p>
<p>There’s no fancy plugin API for adding a persistence layer – simply override Backbone.sync with the same function signature:</p>
<pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">};</span>
      </pre>
<p>The default methodMap is useful for working out what the method argument does:</p>
<pre><span class="kd">var</span> <span class="nx">methodMap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'create'</span><span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'update'</span><span class="o">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'delete'</span><span class="o">:</span> <span class="s1">'DELETE'</span><span class="p">,</span>
        <span class="s1">'read'</span><span class="o">:</span>   <span class="s1">'GET'</span>
      <span class="p">};</span>
      </pre>
<p>In the above example if we wanted to log an event when <code>.sync()</code> was called, we could do this:</p>
<pre><span class="kd">var</span> <span class="nx">id_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I've been passed "</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s2">" with "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">'create'</span><span class="p">){</span> <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">id_counter</span><span class="o">++</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">};</span>
      </pre>
<p><strong>Resetting/Refreshing Collections</strong></p>
<p>Rather than adding or removing models individually, you might occasionally wish to update an entire collection at once. <code>Collection.reset()</code> allows us to replace an entire collection with new models as follows:</p>
<pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Jamaica.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Disneyland.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">reset</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Cuba.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span>
      <span class="p">]);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Collection size: '</span> <span class="o">+</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      </pre>
<p>Note that using <code>Collection.reset()</code> doesn't fire any <code>add</code> or <code>remove</code> events. A <code>reset</code> event is fired instead as shown in example.</p>
<h3>
      <a name="user-content-underscore-utility-functions" class="anchor" href="#underscore-utility-functions"><span class="octicon octicon-link"></span></a>Underscore utility functions</h3>
<p>As Backbone requires Underscore as a hard dependency, we're able to use many of the utilities it has to offer to aid with our application development. Here's an example of how Underscore's <code>forEach</code> method that can be used for iterating over collection and <code>sortBy()</code> method that can be used to sort a collection of todos based on a particular attribute.</p>
<pre><span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"reset"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Collection reseted."</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Belgium.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to China.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">'go to Austria.'</span><span class="p">,</span> <span class="nx">completed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">sortedByAlphabet</span> <span class="o">=</span> <span class="nx">TodosCollection</span><span class="p">.</span><span class="nx">sortBy</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"title"</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"- Now sorted: "</span><span class="p">);</span>

      <span class="nx">sortedByAlphabet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'title'</span><span class="p">));</span>
      <span class="p">});</span>
      </pre>
<p>The complete list of what Underscore can do is beyond the scope of this guide, but can be found in its official <a href="http://documentcloud.github.com/underscore/">docs</a>.</p>
<h3>
      <a name="user-content-chainable-api" class="anchor" href="#chainable-api"><span class="octicon octicon-link"></span></a>Chainable API</h3>
<p>Speaking of utility methods, another bit of sugar in Backbone is the support for Underscore’s chain method. This works by calling the original method with the current array of models and returning the result. In case you haven’t seen it before, the chainable API looks like this:</p>
<pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">([</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Tim'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">5</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Ida'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">26</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Rob'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">55</span> <span class="p">}</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">filteredNames</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">chain</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">;</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">value</span><span class="p">();</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">filteredNames</span><span class="p">);</span> <span class="c1">// logs: ['Ida', 'Rob']</span>
      </pre>
<p>Some of the Backbone-specific methods will return this, which means they can be chained as well:</p>
<pre><span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

      <span class="nx">collection</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'John'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">23</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Harry'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">33</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Steve'</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">41</span> <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>

      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">names</span><span class="p">);</span> <span class="c1">// logs: ['John', 'Harry', 'Steve']</span>
      </pre>
<h2>
      <a name="user-content-events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h2>
<p>As we've covered, <code>Backbone.Events</code> is mixed into the other Backbone "classes", including:</p>
<ul>
<li>Backbone.Model</li>
      <li>Backbone.Collection</li>
      <li>Backbone.Router</li>
      <li>Backbone.History</li>
      <li>Backbone.View</li>
      </ul>
<p>Events are the standard way to deal with user interface actions, through the declarative event bindings on views, and also model and collection changes. Mastering events is one of the quickest ways to become more productive with Backbone.</p>
<p><code>Backbone.Events</code> also has the ability to give any object a way to bind and trigger custom events. We can mix this module into any object easily and there isn't a requirement for events to be declared prior to them being bound.</p>
<p>Example:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="c1">// Add a custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'We triggered '</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// Trigger the custom event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'dance'</span><span class="p">,</span> <span class="s1">'our event'</span><span class="p">);</span>
      </pre>
<p>If you're familiar with jQuery custom events or the concept of Publish/Subscribe, <code>Backbone.Events</code> provides a system that is very similar with <code>on</code> being analogous to <code>subscribe</code> and <code>trigger</code> being similar to <code>publish</code>.</p>
<p><code>on</code> basically allows us to bind a callback function to any object, as we've done with <code>dance</code> in the above example. Whenever the event is fired, our callback is invoked.</p>
<p>The official Backbone.js documentation recommends namespacing event names using colons if you end up using quite a few of these on your page. e.g:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// This one triggers nothing as no listener listens for it</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre>
<p>A special <code>all</code> event is made available in case you would like an event to be triggered when any event occurs (e.g if you would like to screen events in a single location). The <code>all</code> event can be used as follows:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We started "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"all"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"The name of the event passed was "</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="c1">// This time each event will be catched with catch 'all' event listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre>
<p><code>off</code> allows us to remove a callback function that has previously been bound from an object. Going back to our Publish/Subscribe comparison, think of it as an <code>unsubscribe</code> for custom events.</p>
<p>To remove the <code>dance</code> event we previously bound to <code>ourObject</code>, we would simply do:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We  "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add a namespaced custom events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events. Each will be catched and acted upon.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"started tap dancing. Yeah!"</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"started break dancing. Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes event bound to the object</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">);</span>

      <span class="c1">// Trigger the custom events again, but one is logged.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:tap"</span><span class="p">,</span> <span class="s2">"stopped tap dancing."</span><span class="p">);</span> <span class="c1">// won't be logged as its not listened for</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance:break"</span><span class="p">,</span> <span class="s2">"break dancing. Yeah!"</span><span class="p">);</span>
      </pre>
<p>To remove all callbacks for the event we should just pass event name (e.g <code>move</code>) to <code>off()</code> function of the object event is bound to. If we wish to remove just a callback by a specific name, we can pass callback name as second parameter:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">dancing</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are dancing. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>
      <span class="kd">function</span> <span class="nx">jumping</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are jumping. "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add two listeners to the same event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">jumping</span><span class="p">);</span>

      <span class="c1">// Trigger the events. Both listeners are called.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah!"</span><span class="p">);</span>

      <span class="c1">// Removes specified listener</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="nx">dancing</span><span class="p">);</span>

      <span class="c1">// Trigger the events again. One listener left.</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"move"</span><span class="p">,</span> <span class="s2">"Yeah, jump, jump!"</span><span class="p">);</span>
      </pre>
<p>Finally, <code>trigger</code> triggers a callback for a specified event (or a space-separated list of events). e.g:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span> <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="s1">'just dancing.'</span><span class="p">);</span>

      <span class="c1">// Multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="s1">'very tired from so much action.'</span><span class="p">);</span>
      </pre>
<p>It is also possible to pass along additional arguments to each (or all) of these events via a second argument supported by <code>trigger</code>. e.g:</p>
<pre><span class="kd">var</span> <span class="nx">ourObject</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="c1">// Mixin</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">ourObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">doAction</span> <span class="p">(</span><span class="nx">actionObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"We are "</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">action</span> <span class="o">+</span> <span class="s1">' for '</span> <span class="o">+</span> <span class="nx">actionObj</span><span class="p">.</span><span class="nx">duration</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Add event listeners</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"jump"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"skip"</span><span class="p">,</span> <span class="nx">doAction</span><span class="p">);</span>

      <span class="c1">// Passing multiple arguments to single event</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"5 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'dancing'</span><span class="p">});</span>

      <span class="c1">// Passing multiple arguments to multiple events</span>
      <span class="nx">ourObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">"dance jump skip"</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span> <span class="s2">"15 minutes"</span><span class="p">,</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">'on fire'</span><span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-routers" class="anchor" href="#routers"><span class="octicon octicon-link"></span></a>Routers</h2>
<p>In Backbone, routers are used to help manage application state and for connecting URLs to application events. This is achieved using hash-tags with URL fragments, or using the browser's pushState and History API. Some examples of routes may be seen below:</p>
<pre><span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#about</span>
      <span class="nx">http</span><span class="o">:</span><span class="c1">//example.com/#search/seasonal-horns/page2</span>
      </pre>
<p>Note: An application will usually have at least one route mapping a URL route to a function that determines what happens when a  user reaches that particular route. This relationship is defined as follows:</p>
<pre><span class="s1">'route'</span> <span class="o">:</span> <span class="s1">'mappedFunction'</span>
      </pre>
<p>Let us now define our first controller by extending <code>Backbone.Router</code>. For the purposes of this guide, we're going to continue pretending we're creating a complex todo application (something like personal organize/planner) that requires a complex TodoRouter.</p>
<p>Note the inline comments in the code example below as they continue the rest of the lesson on routers.</p>
<pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="cm">/* define the route and function maps for this router */</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
              <span class="cm">/* Sample usage: http://example.com/#about */</span>

              <span class="s2">"todo/:id"</span> <span class="o">:</span> <span class="s2">"getTodo"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a ":param" variable which allows us to match</span>
      <span class="cm">        any of the components between two URL slashes */</span>
              <span class="cm">/* Sample usage: http://example.com/#todo/5 */</span>

              <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* We can also define multiple routes that are bound to the same map function,</span>
      <span class="cm">        in this case searchTodos(). Note below how we're optionally passing in a</span>
      <span class="cm">        reference to a page number if one is supplied */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job */</span>

              <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
              <span class="cm">/* As we can see, URLs may contain as many ":param"s as we wish */</span>
              <span class="cm">/* Sample usage: http://example.com/#search/job/p1 */</span>

              <span class="s2">"todos/:id/download/*documentPath"</span> <span class="o">:</span> <span class="s2">"downloadDocument"</span><span class="p">,</span>
              <span class="cm">/* This is an example of using a *splat. splats are able to match any number of</span>
      <span class="cm">        URL components and can be combined with ":param"s*/</span>
              <span class="cm">/* Sample usage: http://example.com/#todos/5/download/files/Meeting_schedule.doc */</span>

              <span class="cm">/* If you wish to use splats for anything beyond default routing, it's probably a good</span>
      <span class="cm">        idea to leave them at the end of a URL otherwise you may need to apply regular</span>
      <span class="cm">        expression parsing on your fragment */</span>

              <span class="s2">"*other"</span>    <span class="o">:</span> <span class="s2">"defaultRoute"</span>
              <span class="cm">/* This is a default route that also uses a *splat. Consider the</span>
      <span class="cm">        default route a wildcard for URLs that are either not matched or where</span>
      <span class="cm">        the user has incorrectly typed in a route path manually */</span>
              <span class="cm">/* Sample usage: http://example.com/# &lt;anything */</span>
          <span class="p">},</span>

          <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="p">},</span>

          <span class="nx">getTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
              <span class="cm">/*</span>
      <span class="cm">        Note that the id matched in the above route will be passed to this function</span>
      <span class="cm">        */</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"You are trying to reach todo "</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">downloadDocument</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">path</span><span class="p">){</span>
          <span class="p">},</span>

          <span class="nx">defaultRoute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">other</span><span class="p">){</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Invalid. You attempted to reach:'</span> <span class="o">+</span> <span class="nx">other</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="cm">/* Now that we have a router setup, remember to instantiate it */</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>
      </pre>
<p>As of Backbone 0.5+, it's possible to opt-in for HTML5 pushState support via <code>window.history.pushState</code>. This permits you to define routes such as <a href="http://www.scriptjunkie.com/just/an/example">http://www.scriptjunkie.com/just/an/example</a>. This will be supported with automatic degradation when a user's browser doesn't support pushState. For the purposes of this tutorial, we'll use the hashtag method.</p>
<h4>
      <a name="user-content-is-there-a-limit-to-the-number-of-routers-i-should-be-using" class="anchor" href="#is-there-a-limit-to-the-number-of-routers-i-should-be-using"><span class="octicon octicon-link"></span></a>Is there a limit to the number of routers I should be using?</h4>
<p>Andrew de Andrade has pointed out that DocumentCloud themselves usually only use a single router in most of their applications. You're very likely to not require more than one or two routers in your own projects as the majority of your application routing can be kept organized in a single controller without it getting unwieldy.</p>
<h4>
      <a name="user-content-backbonehistory" class="anchor" href="#backbonehistory"><span class="octicon octicon-link"></span></a>Backbone.history</h4>
<p>Next, we need to initialize <code>Backbone.history</code> as it handles <code>hashchange</code> events in our application. This will automatically handle routes that have been defined and trigger callbacks when they've been accessed.</p>
<p>The <code>Backbone.history.start()</code> method will simply tell Backbone that it's OK to begin monitoring all <code>hashchange</code> events as follows:</p>
<pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="cm">/* define the route and function maps for this router */</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"about"</span> <span class="o">:</span> <span class="s2">"showAbout"</span><span class="p">,</span>
          <span class="s2">"search/:query"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span><span class="p">,</span>
          <span class="s2">"search/:query/p:page"</span> <span class="o">:</span> <span class="s2">"searchTodos"</span>
        <span class="p">},</span>

        <span class="nx">showAbout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){},</span>

        <span class="nx">searchTodos</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">page</span><span class="p">){</span>
          <span class="kd">var</span> <span class="nx">page_number</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Page number: "</span> <span class="o">+</span> <span class="nx">page_number</span> <span class="o">+</span> <span class="s2">" of the results for todos containing the word: "</span> <span class="o">+</span> <span class="nx">query</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to and check console:</span>
      <span class="c1">// http://localhost/#search/job/p3 logs: Page number: 3 of the results for todos containing the word: job</span>
      <span class="c1">// http://localhost/#search/job logs: Page number: 1 of the results for todos containing the word: job </span>
      <span class="c1">// etc.</span>
      </pre>
<p>Note: To test last example you should set site for testing in local development environment which is out of scope of this book.</p>
<p>As an aside, if you would like to save application state to the URL at a particular point you can use the <code>.navigate()</code> method to achieve this. It simply updates your URL fragment without the need to trigger the <code>hashchange</code> event:</p>
<pre><span class="cm">/* Lets imagine we would like a specific fragment (edit) once a user opens single todo */</span>
      <span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">);</span> <span class="c1">// updates the fragment for us, but doesn't trigger the route</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but editTodo() function is not invoked even though location we end up is mapped to it.</span>
      <span class="c1">//</span>
      <span class="c1">// logs: View todo requested.</span>
      </pre>
<p>It is also possible for <code>Router.navigate()</code> to trigger the route as well as update the URL fragment.</p>
<pre><span class="kd">var</span> <span class="nx">TodoRouter</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">"todo/:id"</span><span class="o">:</span> <span class="s2">"viewTodo"</span><span class="p">,</span>
          <span class="s2">"todo/:id/edit"</span><span class="o">:</span> <span class="s2">"editTodo"</span>
          <span class="c1">// ... other routes</span>
        <span class="p">},</span>

        <span class="nx">viewTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"View todo requested."</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s2">"todo/"</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'/edit'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// updates the fragment and triggers the route as well</span>
        <span class="p">},</span>
        <span class="nx">editTodo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Edit todo openned."</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myTodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoRouter</span><span class="p">();</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="c1">// Go to:</span>
      <span class="c1">// http://localhost/#todo/4 url is updated to: http://localhost/#todo/45/edit</span>
      <span class="c1">// but this time editTodo() function is invoked.</span>
      <span class="c1">// </span>
      <span class="c1">// logs: </span>
      <span class="c1">// View todo requested.</span>
      <span class="c1">// Edit todo openned. </span>
      </pre>
<h3>
      <a name="user-content-backbones-sync-api" class="anchor" href="#backbones-sync-api"><span class="octicon octicon-link"></span></a>Backbone’s Sync API</h3>
<p>The Backbone.sync method is intended to be overridden to support other backends. The built-in method is tailored to a certain breed of RESTful JSON APIs – Backbone was originally extracted from a Ruby on Rails application, which uses HTTP methods like PUT the same way.</p>
<p>The way this works is the model and collection classes have a sync method that calls Backbone.sync. Both will call this.sync internally when fetching, saving, or deleting items.</p>
<p>The sync method is called with three parameters:</p>
<ul>
<li>method: One of create, update, delete, read</li>
      <li>model: The Backbone model object</li>
      <li>options: May include success and error methods</li>
      </ul>
<p>Implementing a new sync method can use the following pattern:</p>
<pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">requestContent</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Handle results from MyAPI</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">'create'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'update'</span><span class="o">:</span>
            <span class="nx">requestContent</span><span class="p">[</span><span class="s1">'resource'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'delete'</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>

          <span class="k">case</span> <span class="s1">'read'</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">])</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">MyAPI</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
      </pre>
<p>This pattern delegates API calls to a new object, which could be a Backbone-style class that supports events. This can be safely tested separately, and potentially used with libraries other than Backbone.</p>
<p>There are quite a few sync implementations out there:</p>
<ul>
<li>Backbone localStorage</li>
      <li>Backbone offline</li>
      <li>Backbone Redis</li>
      <li>backbone-parse</li>
      <li>backbone-websql</li>
      <li>Backbone Caching Sync</li>
      </ul>
<h3>
      <a name="user-content-conflict-management" class="anchor" href="#conflict-management"><span class="octicon octicon-link"></span></a>Conflict Management</h3>
<p>Like most client-side projects, Backbone.js wraps everything in an immediately-invoked function expression:</p>
<pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// Backbone.js</span>
      <span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
      </pre>
<p>Several things happen during this configuration stage. A Backbone “namespace” is created, and multiple versions of Backbone on the same page are supported through the noConflict mode:</p>
<pre><span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">previousBackbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">;</span>

      <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">previousBackbone</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">};</span>
      </pre>
<p>Multiple versions of Backbone can be used on the same page by calling noConflict like this:</p>
<pre><span class="kd">var</span> <span class="nx">Backbone19</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="c1">// Backbone19 refers to the most recently loaded version,</span>
      <span class="c1">// and `window.Backbone` will be restored to the previously</span>
      <span class="c1">// loaded version</span>
      </pre>
<p>This initial configuration code also supports CommonJS modules so Backbone can be used in Node projects:</p>
<pre><span class="kd">var</span> <span class="nx">Backbone</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Backbone</span> <span class="o">=</span> <span class="nx">root</span><span class="p">.</span><span class="nx">Backbone</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      </pre>
<h2>
      <a name="user-content-inheritance--mixins" class="anchor" href="#inheritance--mixins"><span class="octicon octicon-link"></span></a>Inheritance &amp; Mixins</h2>
<p>For its inheritance, Backbone internally uses an <code>inherits</code> function inspired by <code>goog.inherits</code>, Google’s implementation from the Closure Library. It's basically a function to correctly setup the prototype chain.</p>
<pre> <span class="kd">var</span> <span class="nx">inherits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">protoProps</span><span class="p">,</span> <span class="nx">staticProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
      </pre>
<p>The only major difference here is that Backbone’s API accepts two objects containing “instance” and “static” methods.</p>
<p>Following on from this, for inheritance purposes all of Backbone's objects contain an <code>extend</code> method as follows:</p>
<pre><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">View</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">;</span>
      </pre>
<p>Most development with Backbone is based around inheriting from these objects, and they’re designed to mimic a classical object-oriented implementation.</p>
<p>If this sounds familiar, it's because <code>extend</code> is an Underscore.js utility, although Backbone itself does a lot more with this. See below for Underscore's <code>extend</code>:</p>
<pre><span class="nx">each</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
      </pre>
<p>The above isn’t quite the same as ES5’s <code>Object.create</code>, as it’s actually copying properties (methods and values) from one object to another. As this isn’t enough to support Backbone’s inheritance and class model, the following steps are performed:</p>
<ul>
<li>The instance methods are checked to see if there’s a constructor property. If so, the class’s constructor is used, otherwise the parent’s constructor is used (i.e., Backbone.Model)</li>
      <li>Underscore’s extend method is called to add the parent class’s methods to the new child class</li>
      <li>The <code>prototype</code> property of a blank constructor function is assigned with the parent’s prototype, and a new instance of this is set to the child’s <code>prototype</code> property
      Underscore’s extend method is called twice to add the static and instance methods to the child class</li>
      <li>The child’s prototype’s constructor and a <code>__super__</code> property are assigned</li>
      <li>This pattern is also used for classes in CoffeeScript, so Backbone classes are compatible with CoffeeScript classes.</li>
      </ul>
<p><code>extend</code> can be used for a great deal more and developers who are fans of mixins will like that it can be used for this too. You can define functionality on any custom object, and then quite literally copy &amp; paste all of the methods and attributes from that object to a Backbone one:</p>
<p>For example:</p>
<pre> <span class="kd">var</span> <span class="nx">MyMixin</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">foo</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">,</span>
        <span class="nx">sayFoo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);}</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
       <span class="c1">// ...</span>
      <span class="p">});</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">MyView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">MyMixin</span><span class="p">);</span>

      <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">();</span>
      <span class="nx">myView</span><span class="p">.</span><span class="nx">sayFoo</span><span class="p">();</span> <span class="c1">//=&gt; 'bar'</span>
      </pre>
<p>We can take this further and also apply it to View inheritance. The following is an example of how to extend one View using another:</p>
<pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      <span class="p">});</span>
      </pre>
<p>However, if you have an <code>initialize()</code> method in Panel, then it won't be called if you also have an <code>initialize()</code> method in PanelAdvanced, so you would have to call Panel's initialize method explicitly:</p>
<pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
         <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">])</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span> <span class="c1">// Log: bar</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="k">new</span> <span class="nx">Panel</span><span class="p">();</span>
      <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span>
      </pre>
<p>This isn't the most elegant of solutions because if you have a lot of Views that inherit from Panel, then you'll have to remember to call Panel's initialize from all of them.</p>
<p>It's worth noting that if Panel doesn't have an initialize method now but you choose to add it in the future, then you'll need to go to all of the inherited classes in the future and make sure they call Panel's initialize.</p>
<p>So here's an alternative way to define Panel so that your inherited views don't need to call Panel's initialize method:</p>
<pre><span class="kd">var</span> <span class="nx">Panel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's initialization code here</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Panel initialized'</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">foo</span> <span class="o">=</span> <span class="s1">'bar'</span><span class="p">;</span>

        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Panel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
        <span class="c1">// put all of Panel's methods here. For example:</span>
        <span class="nx">sayHi</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello from Panel'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>

      <span class="c1">// other classes then inherit from Panel like this:</span>
      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="nx">Panel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'PanelAdvanced initialized'</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">foo</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">PanelAdvanced</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PanelAdvanced</span><span class="p">();</span> <span class="c1">//Logs: Panel initialized, PanelAdvanced initialized, bar</span>
      <span class="nx">PanelAdvanced</span><span class="p">.</span><span class="nx">sayHi</span><span class="p">();</span> <span class="c1">// Logs: hello from Panel</span>
      </pre>
<p>When used appropriately, Backbone's <code>extend</code> method can save a great deal of time and effort writing redundant code.</p>
<p>(Thanks to <a href="http://dailyjs.com">Alex Young</a>, <a href="http://stackoverflow.com/users/93448/derick-bailey">Derick Bailey</a> and <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for the heads up about these tips).</p>
<h4>
      <a name="user-content-backbone-super" class="anchor" href="#backbone-super"><span class="octicon octicon-link"></span></a>Backbone-Super</h4>
<p><a href="https://github.com/lukasolson/Backbone-Super">Backbone-Super</a> by Lukas Olson adds a <em>_super</em> method to <em>Backbone.Model</em> using <a href="http://ejohn.org/blog/simple-javascript-inheritance/">John Resig’s Inheritance script</a>.
      Rather than using Backbone.Model.prototype.set.call as per the Backbone.js documentation, _super can be called instead:</p>
<pre><span class="c1">// This is how we normally do it</span>
      <span class="kd">var</span> <span class="nx">OldFashionedNote</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>After including this plugin, you can do the same thing with the following syntax:</p>
<pre><span class="c1">// This is how we can do it after using the Backbone-super plugin</span>
      <span class="kd">var</span> <span class="nx">Note</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Call parent's method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
          <span class="c1">// some custom code here</span>
          <span class="c1">// ...</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-namespacing" class="anchor" href="#namespacing"><span class="octicon octicon-link"></span></a>Namespacing</h2>
<p>When learning how to use Backbone, an important and commonly overlooked area by tutorials is namespacing. If you already have experience with namespacing in JavaScript, the following section will provide some advice on how to specifically apply concepts you know to Backbone, however I will also be covering explanations for beginners to ensure everyone is on the same page.</p>
<h4>
      <a name="user-content-what-is-namespacing" class="anchor" href="#what-is-namespacing"><span class="octicon octicon-link"></span></a>What is namespacing?</h4>
<p>The basic idea around namespacing is to avoid collisions with other objects or variables in the global namespace. They're important as it's best to safeguard your code from breaking in the event of another script on the page using the same variable names as you are. As a good 'citizen' of the global namespace, it's also imperative that you do your best to similarly not prevent other developer's scripts executing due to the same issues.</p>
<p>JavaScript doesn't really have built-in support for namespaces like other languages, however it does have closures which can be used to achieve a similar effect.</p>
<p>In this section we'll be taking a look shortly at some examples of how you can namespace your models, views, routers and other components specifically. The patterns we'll be examining are:</p>
<ul>
<li>Single global variables</li>
      <li>Object Literals</li>
      <li>Nested namespacing</li>
      </ul>
<p><strong>Single global variables</strong></p>
<p>One popular pattern for namespacing in JavaScript is opting for a single global variable as your primary object of reference. A skeleton implementation of this where we return an object with functions and properties can be found below:</p>
<pre><span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="kd">function</span><span class="p">(){</span>
            <span class="c1">// ...</span>
          <span class="p">},</span>
          <span class="k">return</span> <span class="p">{</span>
            <span class="c1">// ...</span>
          <span class="p">}</span>
      <span class="p">})();</span>
      </pre>
<p>You've probably seen this technique before. A Backbone-specific example might look like this:</p>
<pre><span class="kd">var</span> <span class="nx">myViews</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">TodoView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">TodosView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">}),</span>
              <span class="nx">AboutView</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="p">..</span> <span class="p">});</span>
              <span class="c1">//etc.</span>
          <span class="p">};</span>
      <span class="p">})();</span>
      </pre>
<p>Here we can return a set of views, but the same technique could return an entire collection of models, views and routers depending on how you decide to structure your application. Although this works for certain situations, the biggest challenge with the single global variable pattern is ensuring that no one else has used the same global variable name as you have in the page.</p>
<p>One solution to this problem, as mentioned by Peter Michaux, is to use prefix namespacing. It's a simple concept at heart, but the idea is you select a common prefix name (in this example, <code>myApplication_</code>) and then define any methods, variables or other objects after the prefix.</p>
<pre><span class="kd">var</span> <span class="nx">myApplication_todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({}),</span>
          <span class="nx">myApplication_todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre>
<p>This is effective from the perspective of trying to lower the chances of a particular variable existing in the global scope, but remember that a uniquely named object can have the same effect. This aside, the biggest issue with the pattern is that it can result in a large number of global objects once your application starts to grow.</p>
<p>For more on Peter's views about the single global variable pattern, read his <a href="http://michaux.ca/articles/javascript-namespacing">excellent post on them</a>.</p>
<p>Note: There are several other variations on the single global variable pattern out in the wild, however having reviewed quite a few, I felt the prefixing approach applied best to Backbone.</p>
<p><strong>Object Literals</strong></p>
<p>Object Literals have the advantage of not polluting the global namespace but assist in organizing code and parameters logically. They're beneficial if you wish to create easily readable structures that can be expanded to support deep nesting. Unlike simple global variables, Object Literals often also take into account tests for the existence of a variable by the same name, which helps reduce the chances of collision.</p>
<p>This example demonstrates two ways you can check to see if a namespace already exists before defining it. I commonly use Option 2.</p>
<pre><span class="cm">/* Doesn't check for existence of myApplication */</span>
      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="cm">/*</span>
      <span class="cm">Does check for existence. If already defined, we use that instance.</span>
      <span class="cm">Option 1:   if(!myApplication) myApplication = {};</span>
      <span class="cm">Option 2:   var myApplication = myApplication || {};</span>
      <span class="cm">We can then populate our object literal to support models, views and collections (or any data, really):</span>
      <span class="cm">*/</span>

      <span class="kd">var</span> <span class="nx">myApplication</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">models</span> <span class="o">:</span> <span class="p">{},</span>
          <span class="nx">views</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">pages</span> <span class="o">:</span> <span class="p">{}</span>
          <span class="p">},</span>
          <span class="nx">collections</span> <span class="o">:</span> <span class="p">{}</span>
      <span class="p">};</span>
      </pre>
<p>One can also opt for adding properties directly to the namespace (such as your views, in the following example):</p>
<pre><span class="kd">var</span> <span class="nx">myTodosViews</span> <span class="o">=</span> <span class="nx">myTodosViews</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">myTodosViews</span><span class="p">.</span><span class="nx">todosView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre>
<p>The benefit of this pattern is that you're able to easily encapsulate all of your models, views, routers etc. in a way that clearly separates them and provides a solid foundation for extending your code.</p>
<p>This pattern has a number of benefits. It's often a good idea to decouple the default configuration for your application into a single area that can be easily modified without the need to search through your entire codebase just to alter it. Here's an example of a hypothetical object literal that stores application configuration settings:</p>
<pre><span class="kd">var</span> <span class="nx">myConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">language</span><span class="o">:</span> <span class="s1">'english'</span><span class="p">,</span>
        <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">enableDelegation</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">maxTodos</span><span class="o">:</span> <span class="mi">40</span>
        <span class="p">},</span>
        <span class="nx">theme</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">skin</span><span class="o">:</span> <span class="s1">'a'</span><span class="p">,</span>
          <span class="nx">toolbars</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">index</span><span class="o">:</span> <span class="s1">'ui-navigation-toolbar'</span><span class="p">,</span>
            <span class="nx">pages</span><span class="o">:</span> <span class="s1">'ui-custom-toolbar'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre>
<p>Note that there are really only minor syntactical differences between the Object Literal pattern and a standard JSON data set. If for any reason you wish to use JSON for storing your configurations instead (e.g. for simpler storage when sending to the back-end), feel free to.</p>
<p>For more on the Object Literal pattern, I recommend reading Rebecca Murphey's <a href="http://rmurphey.com/blog/2009/10/15/using-objects-to-organize-your-code">excellent article on the topic</a>.</p>
<p><strong>Nested namespacing</strong></p>
<p>An extension of the Object Literal pattern is nested namespacing. It's another common pattern used that offers a lower risk of collision due to the fact that even if a top-level namespace already exists, it's unlikely the same nested children do. For example, Yahoo's YUI uses the nested object namespacing pattern extensively:</p>
<pre><span class="nx">YAHOO</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">Dom</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span>
      </pre>
<p>Yahoo's YUI uses the nested object namespacing pattern regularly and even DocumentCloud (the creators of Backbone) use the nested namespacing pattern in their main applications. A sample implementation of nested namespacing with Backbone may look like this:</p>
<pre><span class="kd">var</span> <span class="nx">todoApp</span> <span class="o">=</span>  <span class="nx">todoApp</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// perform similar check for nested children</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">=</span> <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="c1">// routers</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">Workspace</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">TodoSearch</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Todo</span>   <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">Notes</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="c1">// special models</span>
      <span class="nx">todoApp</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">special</span><span class="p">.</span><span class="nx">Admin</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>
      </pre>
<p>This is readable, clearly organized, and is a relatively safe way of namespacing your Backbone application. The only real caveat however is that it requires your browser's JavaScript engine to first locate the galleryApp object, then dig down until it gets to the function you're calling. However, developers such as Juriy Zaytsev (kangax) have tested and found the performance differences between single object namespacing vs the 'nested' approach to be quite negligible.</p>
<p><strong>Recommendation</strong></p>
<p>Reviewing the namespace patterns above, the option that I prefer when writing Backbone applications is nested object namespacing with the object literal pattern.</p>
<p>Single global variables may work fine for applications that are relatively trivial. However, larger codebases requiring both namespaces and deep sub-namespaces require a succinct solution that's both readable and scalable. I feel this pattern achieves both of these objectives and is a good choice for most Backbone development.</p>
<h1>
      <a name="user-content-practical-todos---your-first-backbonejs-app" class="anchor" href="#practical-todos---your-first-backbonejs-app"><span class="octicon octicon-link"></span></a>Practical: Todos - Your First Backbone.js App</h1>
<p>Now that we've journeyed through the fundamentals, let's move on to writing our first Backbone.js app - a Todo List application. Building a Todo List is a great way to learn about Backbone’s conventions. It's a simple enough app, but contains enough interesting problems to be useful, such as binding, persisting model data, routing and template rendering.</p>
<p>For this chapter, we’re going to learn how to create the Backbone.js Todo app listed on <a href="http://todomvc.com">TodoMVC.com</a>.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoapp.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoapp.png" alt="" style="max-width:100%;"></a></p>
<p>Let's think about what we need from a high level architectural standpoint.</p>
<ul>
<li>A <code>Todo</code> model to describe individual todo items</li>
      <li>A <code>TodoList</code> collection to store and persist todos</li>
      <li>A way of creating todos</li>
      <li>Listing todos</li>
      <li>Editing existing todos</li>
      <li>Completing todos</li>
      <li>Deleting todos</li>
      <li>A way to bookmark the items that have been completed or are remaining</li>
      </ul>
<p>Basically your classic <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> methods. Let's get started!</p>
<h2>
      <a name="user-content-index" class="anchor" href="#index"><span class="octicon octicon-link"></span></a>Index</h2>
<p>The first step is to setup the basic application dependencies, which in this case will be: <a href="http://jquery.com">jQuery</a>, <a href="http://underscorejs.org">Underscore</a>, Backbone.js and the <a href="https://github.com/jeromegn/Backbone.localStorage">Backbone LocalStorage adapter</a>. These will be loaded in our main (and only) HTML file, index.html:</p>
<pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>Backbone.js • TodoMVC<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"assets/base.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/underscore-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/lib/backbone-localstorage.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/models/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/collections/todos.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/todo.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/views/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/routers/router.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>

      </pre>
<p>To help demonstrate how the various parts of our application can be split up, individual concerns are cleanly organized into folders representing our models, views, collections and routers. An app.js file is used to kick everything off.</p>
<p>Note: If you want to follow along, create directory structure as shown in index.html. Also, you will need <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/base.css">base.css</a> and <a href="https://raw.github.com/addyosmani/todomvc/gh-pages/assets/bg.png">bg.png</a>, both in assets dir. As mentioned previously you can check out whole application at <a href="http://todomvc.com">TodoMVC.com</a>.</p>
<h2>
      <a name="user-content-application-html" class="anchor" href="#application-html"><span class="octicon octicon-link"></span></a>Application HTML</h2>
<p>Now let's take a look at our application's static HTML. We're going to need an <code>&lt;input&gt;</code> for creating new todos, a <code>&lt;ul id="todo-list" /&gt;</code> for listing the actual todos, and a section containing some operations, such as clearing completed todos.</p>
<pre>  <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;header</span> <span class="na">id=</span><span class="s">"header"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h1&gt;</span>todos<span class="nt">&lt;/h1&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">autofocus</span><span class="nt">&gt;</span>
          <span class="nt">&lt;/header&gt;</span>
          <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"toggle-all"</span> <span class="na">type=</span><span class="s">"checkbox"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"toggle-all"</span><span class="nt">&gt;</span>Mark all as complete<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
          <span class="nt">&lt;/section&gt;</span>
          <span class="nt">&lt;footer</span> <span class="na">id=</span><span class="s">"footer"</span><span class="nt">&gt;&lt;/footer&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"info"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;p&gt;</span>Double-click to edit a todo<span class="nt">&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Written by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://github.com/addyosmani"</span><span class="nt">&gt;</span>Addy Osmani<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
          <span class="nt">&lt;p&gt;</span>Part of <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://todomvc.com"</span><span class="nt">&gt;</span>TodoMVC<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

      </pre>
<p>We’ll be populating our todo-list and adding a statistics section with details about what items are left to be completed later on.</p>
<p>So far so good. Now in order to tie this into our Backbone Todo app, we're going to have to go back to the fundamentals - a Todo model.</p>
<h2>
      <a name="user-content-todo-model" class="anchor" href="#todo-model"><span class="octicon octicon-link"></span></a>Todo model</h2>
<p>The <code>Todo</code> model is remarkably straightforward. Firstly a todo has two attributes, a <code>title</code> and a <code>completed</code> status that indicates whether it's been completed. These attributes are passed as defaults, as you can see in the example below:</p>
<pre>  <span class="c1">// js/models/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>
        <span class="c1">// Our basic **Todo** model has `title` and `completed` attributes.</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo</span>
          <span class="c1">// and ensure that each todo created has `title` and `completed` keys.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `completed` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span>
            <span class="p">});</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre>
<p>We also have a <code>toggle()</code> function which allows to set whether a Todo item has been completed.</p>
<h2>
      <a name="user-content-todo-collection" class="anchor" href="#todo-collection"><span class="octicon octicon-link"></span></a>Todo collection</h2>
<p>Next we have our <code>TodoList</code> collection used to group our models. The collection is being extended by localStorage which automatically persists Todo records to HTML5 Local Storage via the Backbone LocalStorage adapter, so they're saved between page requests.</p>
<p>We've then got some static methods, <code>completed()</code> and <code>remaining()</code>, which return an array of unfinished and finished todos respectively.</p>
<p>Finally we have a <code>nextOrder()</code> function, that keeps our Todo items in sequential order as well as a <code>comparator()</code> used to sort items by their insertion order.</p>
<pre>  <span class="c1">// js/collections/todos.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// The collection of todos is backed by *localStorage* instead of a remote</span>
        <span class="c1">// server.</span>
        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `"todos"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">completed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">completed</span><span class="p">()</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Create our global collection of **Todos**.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

      </pre>
<h2>
      <a name="user-content-application-view" class="anchor" href="#application-view"><span class="octicon octicon-link"></span></a>Application View</h2>
<p>So let's look at the core of the application's logic, the views. Since each todo has a fair bit of logic associated with it, such as edit in place, we're going to use the element controller pattern - a pattern which consists of two views, one that controls a collection of items, and the other deals with each individual item.</p>
<p>In other words, we're going to have one view <code>AppView</code>, which will be in charge creating new todos, and rendering the initial todo list. Then we'll have another view called TodoView instances of which will be associated with an individual Todo record. Todo instances will be in charge of editing, updating and destroying their associated todo.</p>
<p>To keep thing simple, we'll keep things 'read-only' at the moment, and won't provide any functionality for creating, editing or deleting todos:</p>
<pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>

      </pre>
<p>You can see we've got a couple of things going on, an el (element), a <code>statsTemplate</code>, a constructor function and several view specific methods. To the right of the <code>el:</code> key is a DOM element selector for the element with ID <code>todoapp</code>. The value of this is just a string and Backbone will create a reference pointing to the element matching the selector #todoapp, where here it will be the <code>&lt;section id="todoapp" /&gt;</code> element, which we previously defined in our HTML.</p>
<p>In a nutshell this means we can now refer to this.el in our controller, which points to the <code>&lt;section id="todoapp" /&gt;</code> element. As you can see, we're referring to el in the <code>addOne()</code> function, appending an element to the list.</p>
<p>Now let's take a look at the constructor function. It's binding to several events on the Todo model, such as add, reset and all. Since we're delegating handling of updates and deletes to the <code>TodoView</code> view, we don't need to to worry about that here. The two pieces of logic are:</p>
<ul>
<li><p>When a new todo is created, the <code>add</code> event will be fired, calling <code>addAll()</code>. This iterates over all of the Todos currently in our collection and fires <code>addOne()</code> for each item.</p></li>
      <li><p><code>addOne()</code> instantiates the TodoView view, rendering it and appending the resultant element to our Todo list.</p></li>
      <li><p>When a <code>reset</code> event is called (i.e. we wish to update the collection in bulk such as when the Todos have been loaded from Local Storage), <code>addAll()</code> is similarly called again.</p></li>
      </ul>
<p>We can then add in the logic for creating new todos, editing them and filtering them based on whether they are complete.</p>
<ul>
<li>events: We define an events hash containing declarative callbacks for our DOM events.

      <ul>
<li>
      <code>createOnEnter()</code>: When a user hits return inside the <code>&lt;input/&gt;</code> field, this creates a  new Todo item and resets the main <code>&lt;input/&gt;</code> field value to prepare it for the next   entry.</li>
      <li>
      <code>clearCompleted()</code>: Removes the items in the todo list that have been marked as   completed</li>
      <li>
      <code>toggleAllComplete()</code>: Allows a user to set all of the items in the todo list to  completed.</li>
      <li>
      <code>initialize()</code>:
      We bind a callback for a change:completed event, letting us know a change has     been made as well to an existing todo item
      We also bind a callback for a filter event, which works a little similar to     addOne() and addAll(). It’s responsibility is to toggle what todo items are     visible based on the filter currently selected in the UI (all, completed or     remaining) through filterOne() and filterAll().</li>
      <li>
      <code>render()</code>:
      We add some conditional CSS styling based on the filter currently selected so     that the route that has been selected is highlighted</li>
      <li>
      <code>createOnEnter()</code>:
      Creates a new Todo model which persists in localStorage when a user hits    return. This creates the model via newAttributes(), which is an object    literal composed of the title, order and completed state of the new item    being added.</li>
      <li>
      <code>clearCompleted()</code>:
      Clears all the todo items that have been marked as complete</li>
      </ul>
</li>
      </ul>
<pre>  <span class="c1">// js/views/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// The Application</span>
        <span class="c1">// ---------------</span>

        <span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="s1">'#todoapp'</span><span class="p">,</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span> <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'click #clear-completed'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span><span class="p">,</span>
            <span class="s1">'click #toggle-all'</span><span class="o">:</span> <span class="s1">'toggleAllComplete'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization we bind to the relevant events on the `Todos`</span>
          <span class="c1">// collection, when items are added or changed. Kick things off by</span>
          <span class="c1">// loading any preexisting todos that might be saved in *localStorage*.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#toggle-all'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#footer'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$main</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change:completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                <span class="nx">completed</span><span class="o">:</span> <span class="nx">completed</span><span class="p">,</span>
                <span class="nx">remaining</span><span class="o">:</span> <span class="nx">remaining</span>
              <span class="p">}));</span>

              <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#filters li a'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#/'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">||</span> <span class="s1">''</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$main</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$footer</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Add a single todo item to the list by creating a view for it, and</span>
          <span class="c1">// appending its element to the `&lt;ul&gt;`.</span>
          <span class="nx">addOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">todo</span> <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Add all items in the **Todos** collection at once.</span>
          <span class="nx">addAll</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-list'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterOne</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">todo</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'visible'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">filterAll</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">filterOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Generate the attributes for a new Todo item.</span>
          <span class="nx">newAttributes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">(),</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">(),</span>
              <span class="nx">completed</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// If you hit return in the main input field, create new **Todo** model,</span>
          <span class="c1">// persisting it to *localStorage*.</span>
          <span class="nx">createOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">!==</span> <span class="nx">ENTER_KEY</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">()</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Clear all completed todo items, destroying their models.</span>
          <span class="nx">clearCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">completed</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleAllComplete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">allCheckbox</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                <span class="s1">'completed'</span><span class="o">:</span> <span class="nx">completed</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre>
<h2>
      <a name="user-content-individual-todo-view" class="anchor" href="#individual-todo-view"><span class="octicon octicon-link"></span></a>Individual Todo View</h2>
<p>Let’s look at the <code>TodoView</code> view, now. This will be in charge of individual Todo records, making sure the view updates when the todo does. To enable enable this interactive behavior we should add some event listeners to the view, that will listen to the events on individual todo represented in html.</p>
<pre>  <span class="c1">// js/views/todo.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-renders the todo item to the current state of the model and</span>
          <span class="c1">// updates the reference to the todo's edit input within the view.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre>
<p>In the <code>initialize()</code> constructor, we're setting up a listener to the todo model’s change event. In other words, when the todo updates, we want to re-render the view to reflect its changes.</p>
<p>In the <code>render()</code> method, we're rendering an Underscore.js JavaScript template, called <code>#item-template</code>, which we’ve previously compiled into this.template using Underscore’s <code>_.template()</code> method.  This returns a piece of HTML that we're using to replace the view’s current element. In other words, the rendered template is now present under <code>this.el</code>, and can be appended to the todo list.</p>
<p>Our events hash includes three callbacks:</p>
<ul>
<li>
      <code>edit()</code>: Changes the current view into editing mode when a user double-clicks on an existing item in the todo list. This allows them to change the existing value of the item’s title attribute</li>
      <li>
      <code>updateOnEnter()</code>: checks that the user has hit the return/enter key and executes the close() function.</li>
      <li>
      <code>close()</code>: This trims the value of the current text in our <code>&lt;input/&gt;</code> field, ensuring that we don’t process it further if it contains no text (e.g ‘’). If a valid value has been provided, we save the changes to the current todo model and close editing mode, by removing the corresponding CSS class.</li>
      </ul>
<h2>
      <a name="user-content-setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h2>
<p>So now we have two views: <code>AppView</code> and <code>TodoView</code>. The former needs to get instantiated when the page loads, so some code actually gets run. You can do this simply enough, by using jQuery's <code>ready()</code> utility, which will execute a function when the DOM's loaded.</p>
<pre>  <span class="c1">// js/app.js</span>

        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Kick things off by creating the **App**.</span>
          <span class="k">new</span> <span class="nx">app</span><span class="p">.</span><span class="nx">AppView</span><span class="p">();</span>

        <span class="p">});</span>

      </pre>
<h2>
      <a name="user-content-in-action" class="anchor" href="#in-action"><span class="octicon octicon-link"></span></a>In action</h2>
<p>Now we've gone far enough without checking that things work as they should. </p>
<p>If you are following along open up index.html and, if everything's going to plan, you shouldn't see any errors in the console. The todo list will be blank (we haven't created any todos yet), and the todo-list won't work through our slick interface, as we haven't yet hooked it up fully. However, we can create a Todo from the console.</p>
<p>Type in: <code>window.app.Todos.create({ title: 'My first Todo item'});</code> and hit return.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole.png" alt="" style="max-width:100%;"></a></p>
<p>Once you've run the above in the console, we should be looking at a brand new todo (logged in console) we've just added in the todos collection. Created todo is saved into Local Storage as well and will be available on page refresh.</p>
<p><code>window.app.Todos.create()</code> used above is collection method (<code>collection.create(attributes, [options])</code>) which instantiate new model item of the type passed into the collection definition, in our case <code>app.Todo</code>:</p>
<pre>  <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="nx">model</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Todo</span> <span class="c1">// the model type used by collection.create() to instantiate new model in the collection</span>
            <span class="p">...</span>
        <span class="p">)};</span>

      </pre>
<p>Run this into console to check it out:</p>
<p><code>var secondTodo = window.app.Todos.create({ title: 'My second Todo item'});</code></p>
<p><code>secondTodo instanceof app.Todo</code></p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole2.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todoconsole2.png" alt="" style="max-width:100%;"></a></p>
<h2>
      <a name="user-content-templates" class="anchor" href="#templates"><span class="octicon octicon-link"></span></a>Templates</h2>
<p>The <code>#item-template</code> used in the <code>TodoView</code> view needs defining, so let's do that. One way of including templates in the page is by using custom script tags. These don't get evaluated by the browser, which just interprets them as plain text. Underscore micro-templating can then access the templates, rendering pieces of HTML.</p>
<pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"item-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"view"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"toggle"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">?</span> <span class="s1">'checked'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;&gt;</span>
            <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;&lt;%=</span> <span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/label&gt;</span>
            <span class="o">&lt;</span><span class="nx">button</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"destroy"</span><span class="o">&gt;&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;</span><span class="err">/div&gt;</span>
          <span class="o">&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"edit"</span> <span class="nx">value</span><span class="o">=</span><span class="s2">"&lt;%= title %&gt;"</span><span class="o">&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre>
<p>The template tags demonstrated above, such as <code>&lt;%=</code> , are specific to Underscore.js, and documented on the Underscore site. In your own applications, you have a choice of template libraries, such as Mustache or Handlebars. Use whichever you prefer, Backbone doesn't mind.</p>
<p>Now when <code>_.template( $('#item-template').html() )</code> is called in the <code>TodoView</code> view our template will render correctly.</p>
<p>We also need to define #stats-template template we use to display how many items have been completed, as well as allowing the user to clear these items.</p>
<pre>  <span class="c">&lt;!-- index.html --&gt;</span>

        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/template"</span> <span class="na">id=</span><span class="s">"stats-template"</span><span class="nt">&gt;</span>
          <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">strong</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;&lt;</span><span class="err">/strong&gt; &lt;%= remaining === 1 ? 'item' : 'items' %&gt; left&lt;/span&gt;</span>
          <span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"filters"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"selected"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/"</span><span class="o">&gt;</span><span class="nx">All</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/active"</span><span class="o">&gt;</span><span class="nx">Active</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
            <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#/completed"</span><span class="o">&gt;</span><span class="nx">Completed</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
            <span class="o">&lt;</span><span class="err">/li&gt;</span>
          <span class="o">&lt;</span><span class="err">/ul&gt;</span>
          <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">completed</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
          <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">"clear-completed"</span><span class="o">&gt;</span><span class="nx">Clear</span> <span class="nx">completed</span> <span class="p">(</span><span class="o">&lt;%=</span> <span class="nx">completed</span> <span class="o">%&gt;</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
          <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
        <span class="nt">&lt;/script&gt;</span>
      </pre>
<h2>
      <a name="user-content-in-action-1" class="anchor" href="#in-action-1"><span class="octicon octicon-link"></span></a>In action</h2>
<p>Now refresh index.html and we should be able to see the fruits of our labour. </p>
<p>The todos added through console earlier should appear in the list populated from the Local Storage. Also, we should be able to type a todo name, and press return to submit the form, creating a new todo.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todocompleted.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todocompleted.png" alt="" style="max-width:100%;"></a></p>
<p>Excellent, we're making great progress, but how about completing and deleting todos?</p>
<h2>
      <a name="user-content-completing--deleting-todos" class="anchor" href="#completing--deleting-todos"><span class="octicon octicon-link"></span></a>Completing &amp; deleting todos</h2>
<p>So the next part of our tutorial is going to cover completing and deleting todos. These two actions are specific to each Todo item, so we need to add this functionality to the TodoView view.</p>
<p>The key part of this is the two event handlers we've added, a togglecompleted event on the todo's checkbox, and a click event on the todo's <code>&lt;button class="destroy" /&gt;</code> button.</p>
<p>The checkbox's togglecompleted event invokes the toggle() function, which toggles the todos's completed status, then resaving the todo - very straightforward!
      The button's click event invokes <code>clear()</code>, which will simply destroy the todo.</p>
<p>That's all there is to it. Since we're binding to the change event, whenever the todo changes the view will automatically be re-rendered, checking or un-checking the checkbox as appropriate. Similarly, when the todo is destroyed, the model's <code>destroy()</code> function will be called, removing the todo from the view as we’re binding to the destroy event too.</p>
<p>One more piece to mention is that we’ve also binded to a visible event to handle the visibility state of the todo item. This is used in conjunction with the filtering in our routes and collections so that we only display an item if its completed state falls in line with the current filter.</p>
<p>This tutorial is long enough as is, so we won't go into in-place editing or updating. If you want an example of that, see the <a href="https://github.com/addyosmani/todomvc/tree/master/architecture-examples/backbone/">complete source</a>.</p>
<pre>  <span class="c1">// js/view/todos.js</span>

        <span class="c1">// Todo Item View</span>
        <span class="c1">// --------------</span>

        <span class="c1">// The DOM element for a todo item...</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .toggle'</span><span class="o">:</span>  <span class="s1">'togglecompleted'</span><span class="p">,</span>
            <span class="s1">'dblclick label'</span><span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click .destroy'</span><span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .edit'</span><span class="o">:</span> <span class="s1">'updateOnEnter'</span><span class="p">,</span>
            <span class="s1">'blur .edit'</span><span class="o">:</span>   <span class="s1">'close'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'destroy'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'visible'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the titles of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="p">)</span> <span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'completed'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">)</span> <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">toggleVisible</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.edit'</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="nx">toggleVisible</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span> <span class="s1">'hidden'</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="nx">isHidden</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isHidden</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">isCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
            <span class="k">return</span> <span class="p">(</span> <span class="c1">// hidden cases only</span>
              <span class="p">(</span><span class="o">!</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'completed'</span><span class="p">)</span>
              <span class="o">||</span> <span class="p">(</span><span class="nx">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">===</span> <span class="s1">'active'</span><span class="p">)</span>
            <span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `"completed"` state of the model.</span>
          <span class="nx">togglecompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Switch this view into `"editing"` mode, displaying the input field.</span>
          <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Close the `"editing"` mode, saving changes to the todo.</span>
          <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">value</span> <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// If you hit `enter`, we're through editing the item.</span>
          <span class="nx">updateOnEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="c1">// Remove the item, destroy the model from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      </pre>
<h2>
      <a name="user-content-todo-routing" class="anchor" href="#todo-routing"><span class="octicon octicon-link"></span></a>Todo routing</h2>
<p>Finally, we move on to routing, which will allow us to easily bookmark the list of items that are active as well as those which have been completed. We’ll be supporting the following routes:</p>
<pre><span class="err">#</span><span class="o">/</span> <span class="p">(</span><span class="nx">all</span> <span class="o">-</span> <span class="k">default</span><span class="p">)</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">active</span>
      <span class="err">#</span><span class="o">/</span><span class="nx">completed</span>
      </pre>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todorouting.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/todorouting.png" alt="" style="max-width:100%;"></a></p>
<p>When the route changes the todo list will be filtered on a model level and the selected class on the filter links will be toggled. When an item is updated while in a filtered state, it will be updated accordingly.
      E.g. if the filter is active and the item is checked, it will be hidden. The active filter is persisted on reload.</p>
<pre>  <span class="c1">// js/routers/router.js</span>

        <span class="c1">// Todo Router</span>
        <span class="c1">// ----------</span>

        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
          <span class="p">},</span>

          <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Set the current filter to be used</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

            <span class="c1">// Trigger a collection filter event, causing hiding/unhiding</span>
            <span class="c1">// of Todo view items</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'filter'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">TodoRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Workspace</span><span class="p">();</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      </pre>
<p>As we can see in the line <code>window.app.Todos.trigger('filter')</code>, once a string filter has been set, we simply trigger our filter at a collection level to toggle which items are displayed and which of those are hidden.</p>
<p>Finally, we call <code>Backbone.history.start()</code> to route the initial URL during page load.</p>
<h2>
      <a name="user-content-conclusions" class="anchor" href="#conclusions"><span class="octicon octicon-link"></span></a>Conclusions</h2>
<p>We’ve now learned how to build our first complete Backbone.js application. The full app can be viewed online at any time and the sources are readily available via <a href="http://www.todomvc.com">TodoMVC</a>.</p>
<p>Later on in the book, we’ll learn how to further modularize this application using RequireJS, swap out our persistence layer to a database back-end and finally unit test the application with a few different testing frameworks.</p>
<h1>
      <a name="user-content-backbone-boilerplate-and-grunt-bbb" class="anchor" href="#backbone-boilerplate-and-grunt-bbb"><span class="octicon octicon-link"></span></a>Backbone Boilerplate And Grunt-BBB</h1>
<p><a href="https://github.com/tbranyen/backbone-boilerplate/">Backbone Boilerplate</a> is an excellent set of best practices and utilities for building Backbone.js applications, created by Backbone contributor <a href="https://github.com/tbranyen">Tim Branyen</a>. He organized this boilerplate out of the gotchas, pitfalls and common tasks he ran into over a year of heavily using Backbone to build apps at Bocoup. This includes apps such <a href="http://startupdatatrends.com">StartupDataTrends.com</a>.</p>
<p>With scaffolding and built in build tasks that take care of minification, concatentation, server, template compilation and more, Backbone Boilerplate (and sister project <a href="https://github.com/backbone-boilerplate/grunt-bbb">Grunt-BBB</a>) are an excellent choice for developers of all levels. I heavily recommend using them as they will give you an enormous start when it comes to getting setup for development. They also have some great inline documentation which is also another excellent time-saver.</p>
<p>By default, Backbone Boilerplate provides you with:</p>
<ul>
<li>Backbone, <a href="https://github.com/bestiejs/lodash">Lodash</a> (an <a href="http://underscorejs.org/">Underscore.js</a> alternative) and <a href="http://jquery.com">jQuery</a> with an <a href="http://html5boilerplate.com">HTML5 Boilerplate</a> foundation</li>
      <li>Boilerplate module code</li>
      <li>A Windows/Mac/Linux build tool for template precompilation and, concatenation &amp; minification of all your libraries, application code and CSS</li>
      <li>Scaffolding support (via grunt-bbb - [B]ackbone [B]oilerplate [B]uild) so you have to spend minimal time writing boilerplate for modules, collections and so on.</li>
      <li>A Lightweight node.js webserver</li>
      <li>Numerous other Backbone.js snippets for making your life easier</li>
      </ul>
<h2>
      <a name="user-content-getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2>
<h3>
      <a name="user-content-backbone-boilerplate" class="anchor" href="#backbone-boilerplate"><span class="octicon octicon-link"></span></a>Backbone Boilerplate</h3>
<p>We can use Boilerplate to easily begin creating an application, but first, we'll need to install it. This can be done by grabbing the latest version of it by cloning the Boilerplate repo directly:</p>
<pre lang="shell"><code>$ git clone git://github.com/tbranyen/backbone-boilerplate.git
      </code></pre>
<p>or alternatively, just fetching the latest tarball as follows:</p>
<pre lang="shell"><code>$ curl -C - -O https://github.com/tbranyen/backbone-boilerplate/zipball/master
      </code></pre>
<h3>
      <a name="user-content-grunt-bbb" class="anchor" href="#grunt-bbb"><span class="octicon octicon-link"></span></a>Grunt-BBB</h3>
<p>As Tim covers in the Boilerplate docs, we have to install <a href="http://gruntjs.com">Grunt</a> if we want to use the build tools and grunt-bbb helpers he recommends.</p>
<p>Grunt is an excellent Node-based JavaScript build tool by another <a href="http://bocoup.com">Bocoup</a> developer (<a href="http://benalman.com">Ben Alman</a>). Think of it as similar to <a href="http://ant.apache.org/">Ant</a> or <a href="https://github.com/jimweirich/rake">Rake</a>. The grunt-bbb helper is also useful to have as it provides several Backbone-specific utilities for scaffolding out your project, without the need to write boilerplate yourself.</p>
<p>To install grunt and grunt-bbb via NPM:</p>
<pre lang="shell"><code># first run
      $ npm install -g grunt

      # followed by
      $ npm install -g bbb

      # finally create a new project
      $ bbb init
      </code></pre>
<p>That's it. We should now be good to go.</p>
<p>A typical workflow for using grunt-bbb, which we can use later on is:</p>
<ul>
<li>Initialize a new project (<code>bbb init</code>)</li>
      <li>Add new modules and templates (<code>bbb init:module</code>)</li>
      <li>Develop using the built in server (<code>bbb server</code>)</li>
      <li>Run the build tool (<code>bbb build</code>)</li>
      <li>Deploy and map to production assets (using <code>bbb release</code>)</li>
      </ul>
<h2>
      <a name="user-content-creating-a-new-project" class="anchor" href="#creating-a-new-project"><span class="octicon octicon-link"></span></a>Creating a new project</h2>
<p>Let's create a new folder for our project and run <code>bbb init</code> to kick things off. If everything has been correctly installed, this will sub out some project directories and files for us. Let's review what is generated.</p>
<h3>
      <a name="user-content-indexhtml" class="anchor" href="#indexhtml"><span class="octicon octicon-link"></span></a>index.html</h3>
<p>This is a fairly standard stripped-down HTML5 Boilerplate foundation with the notable exception of including <a href="http://requirejs.org">RequireJS</a> at the bottom of the page.</p>
<pre><span class="cp">&lt;!doctype html&gt;</span>
      <span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge,chrome=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;title&gt;</span>Backbone Boilerplate<span class="nt">&lt;/title&gt;</span>

        <span class="c">&lt;!-- Application styles. --&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/assets/css/index.css"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/head&gt;</span>

      <span class="nt">&lt;body&gt;</span>
        <span class="c">&lt;!-- Main container. --&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span> <span class="na">id=</span><span class="s">"main"</span><span class="nt">&gt;&lt;/div&gt;</span>

        <span class="c">&lt;!-- Application source. --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">data-main=</span><span class="s">"/app/config"</span> <span class="na">src=</span><span class="s">"/assets/js/libs/require.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre>
<p>RequireJS is an <a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD</a> (Asynchronous Module Definition) module and script loader, which will assist us with managing the modules in our application. We'll be covering it in a lot more detail later on in the book, but for now, let's cover at a high-level what this particular block does:</p>
<pre><code>&lt;script data-main="app/config" src="/assets/js/libs/require.js"&gt;&lt;/script&gt;
      </code></pre>
<p>The <code>data-main</code> attribute is used to inform RequireJS to load <code>app/config.js</code> (a configuration object) after it has finished loading itself. You'll notice that we've omitted the <code>.js</code> extension here as RequireJS can automatically add this for us, however it will respect your paths if we do choose to include it regardless. Let's now look at the config file being referenced.</p>
<h3>
      <a name="user-content-configjs" class="anchor" href="#configjs"><span class="octicon octicon-link"></span></a>config.js</h3>
<p>A RequireJS configuration object allows us to specify aliases and paths for dependencies we're likely to reference often (e.g jQuery), bootstrap properties like our base application URL and <code>shim</code> libraries that don't support AMD natively.</p>
<p>This is what the config file in Backbone Boilerplate looks like:</p>
<pre><span class="c1">// Set the RequireJS configuration for your application.</span>
      <span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>

        <span class="c1">// Initialize the application with the main application file.</span>
        <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'main'</span><span class="p">],</span>

        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>

        <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>

      <span class="p">});</span>
      </pre>
<p>The first option defined in the above config is <code>deps: ['main']</code>. This informs RequireJS to load up our main.js file, which is considered the entry point for our application. You may notice that we haven't specified any other path information for <code>main</code>.</p>
<p>This is because as we haven't overridden the path to our scripts using the <code>baseUrl</code> option, Require will infer this using the path from our <code>data-main</code> attribute in index.html. In other words, our <code>baseUrl</code> is <code>app/</code> and any scripts we require will be loaded relative to this location.</p>
<p>The next block is <code>paths</code>, which we can use to specify paths relative to the <code>baseUrl</code> as well as the paths/aliases to dependencies we're likely to regularly reference.</p>
<pre>  <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// JavaScript folders.</span>
          <span class="nx">libs</span><span class="o">:</span> <span class="s1">'../assets/js/libs'</span><span class="p">,</span>
          <span class="nx">plugins</span><span class="o">:</span> <span class="s1">'../assets/js/plugins'</span><span class="p">,</span>

          <span class="c1">// Libraries.</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'../assets/js/libs/jquery'</span><span class="p">,</span>
          <span class="nx">lodash</span><span class="o">:</span> <span class="s1">'../assets/js/libs/lodash'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'../assets/js/libs/backbone'</span>
        <span class="p">},</span>
      </pre>
<p>Next we have the <code>shim</code> config:</p>
<pre>  <span class="nx">shim</span><span class="o">:</span> <span class="p">{</span>
          <span class="c1">// Backbone library depends on lodash and jQuery.</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">},</span>

          <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
        <span class="p">}</span>
      </pre>
<p><code>shim</code> is an important part of our RequireJS configuration which allows us to load libraries which are not AMD compliant. The basic idea here is that rather than requiring all libraries to implement support for AMD, the <code>shim</code> takes care of the hard work for us.</p>
<p>For example, in the block below, we state that Backbone.js is dependent on Lodash (a fork of Underscore.js) and jQuery being loaded before it. Once they've been loaded, we then use the global export <code>Backbone</code> as the module value.</p>
<pre>    <span class="nx">backbone</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">deps</span><span class="o">:</span> <span class="p">[</span><span class="s1">'lodash'</span><span class="p">,</span> <span class="s1">'jquery'</span><span class="p">],</span>
            <span class="nx">exports</span><span class="o">:</span> <span class="s1">'Backbone'</span>
          <span class="p">}</span>
      </pre>
<p>Finally, we inform RequireJS that the Backbone <a href="https://github.com/tbranyen/backbone.layoutmanager">LayoutManager</a> plugin (a template and layout manager, also included) requires that Backbone be loaded before it should be.</p>
<pre>    <span class="c1">// Backbone.LayoutManager depends on Backbone.</span>
          <span class="s1">'plugins/backbone.layoutmanager'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'backbone'</span><span class="p">]</span>
      </pre>
<p>This entire setup ensures that our scripts correctly get loaded in the order in which we expect.</p>
<h3>
      <a name="user-content-mainjs" class="anchor" href="#mainjs"><span class="octicon octicon-link"></span></a>main.js</h3>
<p>Next, we have <code>main.js</code>, which defines the entry point for our application. We use a global <code>require()</code> method to load an array any other scripts needed, such as our application <code>app.js</code> and our main router <code>router.js</code>. Note that most of the time, we will only use <code>require()</code> for bootstrapping an application and a similar method called <code>define()</code> for all other purposes.</p>
<p>The function defined after our array of dependencies is a callback which doesn't fire until these scripts have loaded. Notice how we're able to locally alias references to "app" and "router" as <code>app</code> and <code>Router</code> for convenience.</p>
<pre><span class="nx">require</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Main Router.</span>
        <span class="s1">'router'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Define your master router on the application namespace and trigger all</span>
        <span class="c1">// navigation from this instance.</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">();</span>

        <span class="c1">// Trigger the initial route and enable HTML5 History API support, set the</span>
        <span class="c1">// root folder to '/' by default.  Change in app.js.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span> <span class="nx">pushState</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">root</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="p">});</span>

        <span class="c1">// All navigation that is relative should be passed through the navigate</span>
        <span class="c1">// method, to be processed by the router. If the link has a `data-bypass`</span>
        <span class="c1">// attribute, bypass the delegation completely.</span>
        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="s1">'a:not([data-bypass])'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Get the absolute anchor href.</span>
          <span class="kd">var</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">);</span>

          <span class="c1">// If the href exists and is a hash route, run it through Backbone.</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">href</span> <span class="o">&amp;&amp;</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'#'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Stop the default event to ensure the link will not cause a page</span>
            <span class="c1">// refresh.</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

            <span class="c1">// `Backbone.history.navigate` is sufficient for all Routers and will</span>
            <span class="c1">// trigger the correct events. The Router's internal `navigate` method</span>
            <span class="c1">// calls this anyways.  The fragment is sliced from the root.</span>
            <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<p>Inline, Backbone Boilerplate includes boilerplate code for initializing our router with HTML5 History API support and handling other navigation scenarios, so we don't have to.</p>
<h3>
      <a name="user-content-appjs" class="anchor" href="#appjs"><span class="octicon octicon-link"></span></a>app.js</h3>
<p>Let us now look at our <code>app.js</code> module. Typically, in non-Backbone Boilerplate applications, an <code>app.js</code> file may contain the core logic or module references needed to kick start an app.</p>
<p>In this case however, this file is used to define templating and layout configuration options as well as utilities for consuming layouts. To a beginner, this might look like a lot of code to comprehend, but the good news is that for basic apps, you're unlikely to need to heavily modify this. Instead, you'll be more concerned with modules for your app, which we'll look at next.</p>
<pre><span class="nx">define</span><span class="p">([</span>

        <span class="c1">// Libraries.</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'lodash'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins.</span>
        <span class="s1">'plugins/backbone.layoutmanager'</span>

      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Provide a global location to place configuration settings and module</span>
        <span class="c1">// creation.</span>
        <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">{</span>
          <span class="c1">// The root path to run the application.</span>
          <span class="nx">root</span><span class="o">:</span> <span class="s1">'/'</span>
        <span class="p">};</span>

        <span class="c1">// Localize or create a new JavaScript Template object.</span>
        <span class="kd">var</span> <span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="c1">// Configure LayoutManager with Backbone Boilerplate defaults.</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutManager</span><span class="p">.</span><span class="nx">configure</span><span class="p">({</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">layout</span><span class="o">:</span> <span class="s1">'app/templates/layouts/'</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="s1">'app/templates/'</span>
          <span class="p">},</span>

          <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span> <span class="o">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s1">'.html'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Mix Backbone.Events, modules, and layout management into the app object.</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="p">{</span>
          <span class="c1">// Create a custom object with a nested Views object.</span>
          <span class="nx">module</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">additionalProps</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="nx">Views</span><span class="o">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="nx">additionalProps</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="c1">// Helper for using layouts.</span>
          <span class="nx">useLayout</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If already using this Layout, then don't re-inject into the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">===</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// If a layout already exists, remove it from the DOM.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="c1">// Create a new Layout.</span>
            <span class="kd">var</span> <span class="nx">layout</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Layout</span><span class="p">({</span>
              <span class="nx">template</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">className</span><span class="o">:</span> <span class="s1">'layout '</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span>
              <span class="nx">id</span><span class="o">:</span> <span class="s1">'layout'</span>
            <span class="p">});</span>

            <span class="c1">// Insert into the DOM.</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#main'</span><span class="p">).</span><span class="nx">empty</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">layout</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>

            <span class="c1">// Render the layout.</span>
            <span class="nx">layout</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">// Cache the reference.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="nx">layout</span><span class="p">;</span>

            <span class="c1">// Return the reference, for chainability.</span>
            <span class="k">return</span> <span class="nx">layout</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>

      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-creating-backbone-boilerplate-modules" class="anchor" href="#creating-backbone-boilerplate-modules"><span class="octicon octicon-link"></span></a>Creating Backbone Boilerplate Modules</h3>
<p>Not to be confused with simply being just an AMD module, a Backbone Boilerplate <code>module</code> is a script composed of a:</p>
<ul>
<li>Model</li>
      <li>Collection</li>
      <li>Views (optional)</li>
      </ul>
<p>We can easily create a new Boilerplate module using <code>grunt-bbb</code> once again using <code>init</code>:</p>
<pre lang="shell"><code># Create a new module
      $ bbb init:module

      # Grunt prompt
      Please answer the following:
      [?] Module Name foo
      [?] Do you need to make any changes to the above before continuing? (y/N) n

      Writing app/modules/foo.js...OK

      Initialized from template "module".
      </code></pre>
<p>This will generate a module <code>foo.js</code> as follows:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>

      </pre>
<p>Notice how boilerplate code for our model and collection has already been written for us, as well as code for consuming the layout utilities defined in <code>app.js</code>.</p>
<p>Now, you may be wondering where or how Views fit into this setup. Although Backbone Boilerplate doesn't include Views in its generated modules by default, we can easily add them ourselves as needed.</p>
<p>e.g:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Views</span>
        <span class="s1">'modules/foo/views'</span>
      <span class="p">],</span>

      <span class="c1">// Map dependencies from above array.</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p>Optionally, we may also wish to include references to plugins such as the Backbone LocalStorage or Offline adapters. One clean way of including a plugin in the above boilerplate could be:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span><span class="p">,</span>

        <span class="c1">// Plugins</span>
        <span class="s1">'plugins/backbone-localstorage'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Views</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create a new module.</span>
        <span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">module</span><span class="p">();</span>

        <span class="c1">// Default model.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="p">});</span>

        <span class="c1">// Default collection.</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span>

          <span class="c1">// Save all of the items under the `"foo"` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'foo-backbone'</span><span class="p">),</span>
        <span class="p">});</span>

        <span class="c1">// Default views</span>
        <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span> <span class="o">=</span> <span class="nx">Views</span><span class="p">;</span>

        <span class="c1">// Return the module for AMD compliance.</span>
        <span class="k">return</span> <span class="nx">Foo</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>You may have spotted that in our module sample we're using the plural, "Views", rather than just View. This is because a View module can contain references to as many Views as needed. In the above, our <code>/modules/foo/views.js</code> file may look as follows:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Libs</span>
        <span class="s1">'backbone'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">Views</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/bar'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">Baz</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span><span class="o">:</span> <span class="s1">'foo/baz'</span><span class="p">,</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="p">...</span>
         <span class="p">});</span>

         <span class="k">return</span> <span class="nx">Views</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p>Where the <code>template</code> references in our Views, correspond to files in the <code>app/templates</code> directory. e.g <code>foo/bar</code> is located at <code>app/templates/foo/bar.html</code> and is a HTML template that can contain Lodash/Underscore.js Micro-templating logic.</p>
<h3>
      <a name="user-content-routerjs" class="anchor" href="#routerjs"><span class="octicon octicon-link"></span></a>router.js</h3>
<p>Finally, let's look at our application router, used for handling navigation. The default router Backbone Boilerplate generates for us inclues sane defaults for no routes being specified.</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="p">}</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p>If however we would like to execute some module-specific logic, when the page loads (i.e when a user hits the default route), we can pull in a module as a dependency and optionally use the Backbone LayoutManager to attach Views to our layout as follows:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="c1">// Application.</span>
        <span class="s1">'app'</span><span class="p">,</span>

        <span class="c1">// Modules</span>
        <span class="s1">'modules/foo'</span>
      <span class="p">],</span>

      <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">Foo</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Defining the application router, you can attach sub routers here.</span>
        <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">''</span><span class="o">:</span> <span class="s1">'index'</span>
          <span class="p">},</span>

          <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="c1">// Create a new Collection</span>
                  <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">();</span>

                  <span class="c1">// Use and configure a 'main' layout</span>
                  <span class="nx">app</span><span class="p">.</span><span class="nx">useLayout</span><span class="p">(</span><span class="s1">'main'</span><span class="p">).</span><span class="nx">setViews</span><span class="p">({</span>
                          <span class="c1">// Attach the bar View into the content View</span>
                          <span class="s1">'.bar'</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Foo</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Bar</span><span class="p">({</span>
                                  <span class="nx">collection</span><span class="o">:</span> <span class="nx">collection</span>
                          <span class="p">})</span>
                   <span class="p">}).</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Fetch data (e.g from localStorage)</span>
        <span class="nx">collection</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Router</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-conclusions-1" class="anchor" href="#conclusions-1"><span class="octicon octicon-link"></span></a>Conclusions</h2>
<p>In this section we reviewed Backbone Boilerplate and learned how to use the BBB tool to help us scaffold out our application.</p>
<p>If you would like to learn more about how this project helps structure your app, BBB includes some built-in boilerplate sample apps that can be easily generated for review.</p>
<p>These include a boilerplate tutorial project (<code>bbb init:tutorial</code>) and an implementation of my <a href="http://todomvc">TodoMVC</a> project (<code>bbb init:todomvc</code>). I recommend checking these out as they'll provide you with a more complete picture of how Backbone Boilerplate, its templates and so on fit into the overall setup for a web app.</p>
<p>For more about Grunt-BBB, remember to take a look at the official project <a href="https://github.com/backbone-boilerplate/grunt-bbb">repository</a>. There is also a related <a href="https://dl.dropbox.com/u/79007/talks/Modern_Web_Applications/slides/index.html">slide-deck</a> available for those interested in reading more.</p>
<h2>
      <a name="user-content-related-tools--projects" class="anchor" href="#related-tools--projects"><span class="octicon octicon-link"></span></a>Related Tools &amp; Projects</h2>
<p>As we've seen, scaffolding tools can assist in expediting how quickly you can begin a new application by creating the basic files required for a project automatically. If you appreciate such tools, I'm happy to also recommend checking out <a href="http://yeoman.io">Yeoman</a> (one of my upcoming projects) and <a href="https://github.com/brunch/brunch">Brunch</a>.</p>
<p>Brunch works very well with Backbone, Underscore, jQuery and CoffeeScript and is even used by companies such as Red Bull and Jim Beam. You may have to update any third party dependencies (e.g. latest jQuery or Zepto) when using it, but other than that it should be fairly stable to use right out of the box.</p>
<p>Brunch can be installed via the nodejs package manager and is easy to get started with. If you happen to use Vim or Textmate as your editor of choice, you'll be happy to know that there are Brunch bundles available for both.</p>
<h1>
      <a name="user-content-common-problems--solutions" class="anchor" href="#common-problems--solutions"><span class="octicon octicon-link"></span></a>Common Problems &amp; Solutions</h1>
<p>In this section, we will review a number of common problems developers often experience once they've started to work on relatively non-trivial projects using Backbone.js, as well as present potential solutions.</p>
<p>Perhaps the most frequent of these questions surround how to do more with Views. If you are interested in discovering how to work with nested Views, learn about view disposal and inheritance, this section will hopefully have you covered.</p>
<h4>
      <a name="user-content-nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs" class="anchor" href="#nesting-what-is-the-best-approach-for-rendering-and-appending-sub-views-in-backbonejs"><span class="octicon octicon-link"></span></a>Nesting: What is the best approach for rendering and appending Sub-Views in Backbone.js?</h4>
<p>Nesting is generally considered a good way to maintain hierarchal views for writing maintainable code. As a beginner, one might try writing a very simple setup with sub-views (e.g inner views) as follows:</p>
<pre><span class="c1">// Where we have previously defined a View, SubView</span>
      <span class="c1">// in a parent View we could do:</span>

      <span class="p">...</span>
      <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">());</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre>
<p>This works in that one doesn't need to worry about maintaining the order of your DOM elements when appending. Views are initialized early and the render() method doesn't need to take on too many responsibilities at once. Unfortunately, a downside is that you don't have the ability to set the <code>tagName</code> of elements and events need to be re-delegated.</p>
<p>An alternative approach which doesn't suffer from the re-delegation problem could be written as follows:</p>
<pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">({</span><span class="nx">options</span><span class="p">});</span>


          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
      <span class="p">}</span>

      </pre>
<p>In this version, we also don't require a template containing empty placeholders and the issue with <code>tagName</code>s is solved as they are defined by the view once again.</p>
<p>Yet another variation which moves logic into an <code>onRender</code> event, could be written with only a few subtle changes:</p>
<pre><span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'render'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRender</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">render</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// more logic</span>

          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'render'</span><span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subview</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView1</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">innerView2</span><span class="p">.</span><span class="nx">setElement</span><span class="p">(</span><span class="s1">'.some-element'</span><span class="p">).</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">}</span>
      </pre>
<p>If you find yourself nesting views in your application, there are more optimal approaches possible for initializing, rendering and appending your sub-views. One such solution could be written:</p>
<pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">delegateEvents</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      </pre>
<p>This tackles a few specific design decisions:</p>
<ul>
<li>The order in which you append the sub-elements matters</li>
      <li>The OuterView doesn't contain the HTML elements to be set in the InnerView(s), meaning that we can still specify tagName in the InnerView</li>
      <li>render() is called after the InnerView element has been placed into the DOM. This is useful if your InnerView's render() method is sizing itself on the page based on the dimensions of another element. This is a common use case.</li>
      </ul>
<p>A second potential solution is this, which may appear cleaner but in reality has a tendency to affect performance:</p>
<pre><span class="kd">var</span> <span class="nx">OuterView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span> <span class="c1">// or this.$el.empty() if you have no template</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">inner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InnerView</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">inner</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">InnerView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>Generally speaking, more developers opt for the first solution as:</p>
<ul>
<li>The majority of their views may already rely on being in the DOM in their render() method</li>
      <li>When the OuterView is re-rendered, views don't have to be re-initialized where re-initialization has the potential to cause memory leaks and issues with existing bindings</li>
      </ul>
<p>(Thanks to <a href="http://stackoverflow.com/users/299189/lukas">Lukas</a>  and <a href="http://stackoverflow.com/users/154765/ian-storm-taylor">Ian Taylor</a> for these tips).</p>
<h4>
      <a name="user-content-what-is-the-best-way-to-manage-models-in-nested-views" class="anchor" href="#what-is-the-best-way-to-manage-models-in-nested-views"><span class="octicon octicon-link"></span></a>What is the best way to manage models in nested Views?</h4>
<p>In order to reach attributes on related models in a nested setup, the models involved need to have some prior knowledge about which models this refers to. Backbone.js doesn't implicitly handle relations or nesting, meaning it's up to us to ensure models have a knowledge of each other.</p>
<p>One approach is to make sure each child model has a 'parent' attribute. This way you can traverse the nesting first up to the parent and then down to any siblings that you know of. So, assuming we have models modelA, modelB and modelC:</p>
<pre><span class="c1">// When initializing modelA, I would suggest setting a link to the parent</span>
      <span class="c1">// model when doing this, like this:</span>

      <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelB</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelB</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">modelC</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre>
<p>This allows you to reach the parent model in any child model function by calling this.parent.</p>
<p>When you have a need to nest Backbone.js views, you might find it easier to let each view represent a single HTML tag using the tagName option of the View. This may be written as:</p>
<pre><span class="nx">ViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'div'</span><span class="p">,</span>
          <span class="nx">id</span><span class="o">:</span> <span class="s1">'new'</span><span class="p">,</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ViewB</span><span class="p">();</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">parentView</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
             <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">viewB</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">ViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'h1'</span><span class="p">,</span>

          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">'Header text'</span><span class="p">);</span> <span class="c1">// or use this.options.headerText or equivalent</span>
          <span class="p">},</span>

          <span class="nx">funcB1</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">doSomethingOnParent</span><span class="p">();</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">modelC</span><span class="p">.</span><span class="nx">doSomethingOnSibling</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parentView</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">shakeViolently</span><span class="p">();</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre>
<p>Then in your application initialization code , you would initiate ViewA and place its element inside the body element.</p>
<p>An alternative approach is to use an extension called <a href="https://github.com/powmedia/backbone-forms">Backbone-Forms</a>. Using a similar schema to what we wrote earlier, nesting could be achieved as follows:</p>
<pre><span class="kd">var</span> <span class="nx">ModelB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeB1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeB2</span><span class="o">:</span> <span class="s1">'Text'</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelC</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeC</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ModelA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">schema</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">attributeA1</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">attributeA2</span><span class="o">:</span> <span class="s1">'Text'</span><span class="p">,</span>
              <span class="nx">refToModelB</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelB</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateB'</span> <span class="p">},</span>
              <span class="nx">refToModelC</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'NestedModel'</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">ModelC</span><span class="p">,</span> <span class="nx">template</span><span class="o">:</span> <span class="s1">'templateC'</span> <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>There is more information about this technique available on <a href="https://github.com/powmedia/backbone-forms#customising-templates">GitHub</a>.</p>
<p>(Thanks to <a href="http://stackoverflow.com/users/100952/jens-alm">Jens Alm</a> and <a href="http://stackoverflow.com/users/801466/artem-oboturov">Artem Oboturov</a> for these tips)</p>
<h4>
      <a name="user-content-is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views" class="anchor" href="#is-it-possible-to-have-one-backbonejs-view-trigger-updates-in-other-views"><span class="octicon octicon-link"></span></a>Is it possible to have one Backbone.js View trigger updates in other Views?</h4>
<p>The Mediator pattern is an excellent option for implementing a solution to this problem.</p>
<p>Without going into too much detail about the pattern, it can effectively be used an event manager that lets you to subscribe to and publish events. So an ApplicationViewA could subscribe to an event, i.e. 'selected' and then the ApplicationViewB would publish the 'selected' event.</p>
<p>The reason I like this is it allows you to send events between views, without the views being directly bound together.</p>
<p>For Example:</p>
<pre><span class="c1">// See http://addyosmani.com/largescalejavascript/#mediatorpattern</span>
      <span class="c1">// for an implementation or alternatively for a more thorough one</span>
      <span class="c1">// http://thejacklawson.com/Mediator.js/</span>

      <span class="kd">var</span> <span class="nx">mediator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mediator</span><span class="p">();</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewB</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">toggle_select</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="p">...</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">);</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">ApplicationViewA</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">delete_selected</span><span class="p">)</span>
          <span class="p">},</span>

          <span class="nx">delete_selected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">any</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">you</span><span class="p">,</span> <span class="nx">want</span><span class="p">)</span> <span class="p">{</span>
              <span class="p">...</span> <span class="k">do</span> <span class="nx">something</span> <span class="p">...</span>
          <span class="p">},</span>
      <span class="p">});</span>
      </pre>
<p>This way your ApplicationViewA doesn't care if it is an ApplicationViewB or FooView that publishes the 'selected' event, only that the event occurred. As a result, you may find it a maintainable way to manage events between parts of your application, not just views.</p>
<p>(Thanks to <a href="http://stackoverflow.com/users/937577/john-mckim">John McKim</a> for this tip and for referencing my Large Scale JavaScript Patterns article).</p>
<h4>
      <a name="user-content-how-would-one-render-a-parent-view-from-one-of-its-children" class="anchor" href="#how-would-one-render-a-parent-view-from-one-of-its-children"><span class="octicon octicon-link"></span></a>How would one render a Parent View from one of its Children?</h4>
<p>If you say, have a view which contains another view (e.g a main view containing a modal view) and  would like to render or re-render the parent view from the child, this is extremely straight-forward.</p>
<p>In such a scenario, you would most likely want to execute the rendering when a particular event has occurred. For the sake of example, let us call this event 'somethingHappened'. The parent view can bind notifications on the child view to know when the event has occurred. It can then render itself.</p>
<p>On the parent view:</p>
<pre><span class="c1">// Parent initialize</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

      <span class="c1">// Parent removal</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">childView</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      </pre>
<p>On the child view:</p>
<pre><span class="c1">// After the event has occurred</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'somethingHappened'</span><span class="p">);</span>

      </pre>
<p>The child will trigger a "somethingHappened" event and the parent's render function will be called.</p>
<p>(Thanks to Tal <a href="http://stackoverflow.com/users/269666/tal-bereznitskey">Bereznitskey</a> for this tip)</p>
<h4>
      <a name="user-content-how-do-you-cleanly-dispose-views-to-avoid-memory-leaks" class="anchor" href="#how-do-you-cleanly-dispose-views-to-avoid-memory-leaks"><span class="octicon octicon-link"></span></a>How do you cleanly dispose Views to avoid memory leaks?</h4>
<p>As your application grows, keeping live views around which aren't being used can quickly become difficult to maintain. Instead, you may find it more optimal to destroy views that are no longer required and simply create new ones as the necessity arises.</p>
<p>A solution to help with this is to create a BaseView from which the rest of your views inherit from. The idea here is that your view will maintain a reference to all of the events to which its subscribed to so that when it is time to dispose of a view, all of those bindings will be automatically unbound.</p>
<p>Here is a sample implementation of this:</p>
<pre><span class="kd">var</span> <span class="nx">BaseView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
      <span class="p">};</span>

      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">BaseView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="nx">bindTo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

              <span class="nx">model</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">ev</span><span class="o">:</span> <span class="nx">ev</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">unbindFromAll</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bindings</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">binding</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">binding</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ev</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindings</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>

          <span class="nx">dispose</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbindFromAll</span><span class="p">();</span> <span class="c1">// this will unbind all events that this view has bound to</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span> <span class="c1">// this will unbind all listeners to events from this view. This is probably not necessary because this view will be garbage collected.</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// uses the default Backbone.View.remove() method which removes this.el from the DOM and removes DOM events.</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre>
<pre><span class="nx">BaseView</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>
      </pre>
<p>Then, whenever a view has the need to bind to an event on a model or a collection, you would use the bindTo method. e.g:</p>
<pre><code>var SampleView = BaseView.extend({

          initialize: function(){
              this.bindTo(this.model, 'change', this.render);
              this.bindTo(this.collection, 'reset', this.doSomething);
          }
      });
      </code></pre>
<p>When you remove a view, simply call the dispose() method which will clean everything up for you automatically:</p>
<pre><span class="kd">var</span> <span class="nx">sampleView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SampleView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span> <span class="nx">some_model</span><span class="p">,</span> <span class="nx">collection</span><span class="o">:</span> <span class="nx">some_collection</span><span class="p">});</span>
      <span class="nx">sampleView</span><span class="p">.</span><span class="nx">dispose</span><span class="p">();</span>
      </pre>
<p>(Thanks to <a href="http://stackoverflow.com/users/188740/johnnyo">JohnnyO</a> for this tip).</p>
<h4>
      <a name="user-content-how-does-one-handle-view-disposal-on-a-parent-or-child-view" class="anchor" href="#how-does-one-handle-view-disposal-on-a-parent-or-child-view"><span class="octicon octicon-link"></span></a>How does one handle View disposal on a Parent or Child View?</h4>
<p>In the last question, we looked at how to effectively dispose views to decreases memory usage (analogous to a type of garbage collection).</p>
<p>Where your application is setup with multiple Parent and Child Views, it is also common to desire removing any DOM elements associated with such views as well as unbinding any event handlers tied to child elements when you no longer require them.</p>
<p>The solution in the last question should be enough to handle this use-case, but if you require a more-explicit example that handles children, we can see one below:</p>
<pre><span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="nx">NewView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">},</span>
          <span class="nx">renderChildren</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">itemView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NewChildView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">item</span> <span class="p">});</span>
              <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">itemView</span><span class="p">.</span><span class="nx">render</span><span class="p">());</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">itemView</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">onClose</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">_</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">childViews</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">view</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">NewChildView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>Here, a close() method for views is implemented which disposes of a view when it is no longer needed or needs to be reset. In most cases the view removal should be done at a view layer so that it won't affect any of our models.</p>
<p>For example, if you are working on a blogging application and you remove a view with comments, perhaps another view in your app shows a selection of comments and resetting the collection would affect those views too.</p>
<p>(Thanks to <a href="http://stackoverflow.com/users/906136/dira">dira</a> for this tip)</p>
<h4>
      <a name="user-content-whats-the-best-way-to-combine-or-append-views-to-each-other" class="anchor" href="#whats-the-best-way-to-combine-or-append-views-to-each-other"><span class="octicon octicon-link"></span></a>What's the best way to combine or append Views to each other?</h4>
<p>Let us say you have a Collection, where each item in the Collection could itself be a Collection. You can render each item in the Collection, and indeed can render any items which themselves are Collections. The problem you might have is how to render this structure where the HTML reflects the hierarchical nature of the data structure.</p>
<p>The most straight-forward way to approach this problem is to use a framework like Derick Baileys <a href="https://github.com/marionettejs/backbone.marionette">Backbone.Marionette</a>. In this framework is a type of view called a CompositeView.</p>
<p>The basic idea of a CompositeView is that it can render a model and a collection within the same view.</p>
<p>It can render a single model with a template. It can also take a collection from that model and for each model in that collection, render a view. By default it uses the same composite view type that you've defined, to render each of the models in the collection. All you have to do is tell the view instance where the collection is, via the initialize method, and you'll get a recursive hierarchy rendered.</p>
<p>There is a working demo of this in action available <a href="http://jsfiddle.net/derickbailey/AdWjU/">online</a>.</p>
<p>And you can get the source code and documentation for <a href="https://github.com/marionettejs/backbone.marionette">Marionette</a> too.</p>
<h4>
      <a name="user-content-better-model-property-validation" class="anchor" href="#better-model-property-validation"><span class="octicon octicon-link"></span></a>Better Model Property Validation</h4>
<p>As we learned earlier in the book, the <code>validate</code> method on a Model is called before <code>set</code> and <code>save</code>, and is passed the model attributes updated with the values from these methods.</p>
<p>By default, where we define a custom <code>validate</code> method, Backbone passes all of a Model's attributes through this validation each time, regardless of which model attributes are being set.</p>
<p>This means that it can be a challenge to determine which specific fields are being set or validated without being concerned about the others that aren't being set at the same time.</p>
<p>To illustrate this problem better, let us look at a typical registration form use case that:</p>
<ul>
<li>Validates form fields using the blur event</li>
      <li>Validates each field regardless of whether other model attributes (aka other form data) are valid or not.</li>
      </ul>
<p>Here is one example of a desired use case:</p>
<p>We have a form where a user focuses and blurs first name, last name, and email HTML input boxes without entering any data. A "this field is required" message should be presented next to each form field.</p>
<p>HTML:</p>
<pre><code>&lt;!doctype html&gt;
      &lt;html&gt;
      &lt;head&gt;
        &lt;meta charset=utf-8&gt;
        &lt;title&gt;Form Validation - Model#validate&lt;/title&gt;
        &lt;script src='http://code.jquery.com/jquery.js'&gt;&lt;/script&gt;
        &lt;script src='http://underscorejs.org/underscore.js'&gt;&lt;/script&gt;
        &lt;script src='http://backbonejs.org/backbone.js'&gt;&lt;/script&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;form&gt;
          &lt;label&gt;First Name&lt;/label&gt;
          &lt;input name='firstname'&gt;
          &lt;span data-msg='firstname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Last Name&lt;/label&gt;
          &lt;input name='lastname'&gt;
          &lt;span data-msg='lastname'&gt;&lt;/span&gt;
          &lt;br&gt;
          &lt;label&gt;Email&lt;/label&gt;
          &lt;input name='email'&gt;
          &lt;span data-msg='email'&gt;&lt;/span&gt;
        &lt;/form&gt;
      &lt;/body&gt;
      &lt;/html&gt;
      </code></pre>
<p>Some simple validation that could be written using the current Backbone <code>validate</code> method to work with this form could be implemented using something like:</p>
<pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="k">return</span> <span class="s1">'email is empty'</span><span class="p">;</span>

      <span class="p">}</span>
      </pre>
<p>Unfortunately, this method would trigger a first name error each time any of the fields were blurred and only an error message next to the first name field would be presented.</p>
<p>One potential solution to the problem could be to validate all fields and return all of the errors:</p>
<pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'first name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'last name is empty'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is empty'</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
      <span class="p">}</span>
      </pre>
<p>This can be adapted into a complete solution that defines a Field model for each input in our form and works within the parameters of our use-case as follows:</p>
<pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">email</span> <span class="o">=</span> <span class="s1">'email is required'</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">errors</span><span class="p">))</span> <span class="k">return</span> <span class="nx">errors</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">Field</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span><span class="nx">blur</span><span class="o">:</span> <span class="s1">'validate'</span><span class="p">},</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'[data-msg='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">val</span><span class="p">());</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$msg</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">errors</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">'input'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">new</span> <span class="nx">Field</span><span class="p">({</span><span class="nx">el</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">user</span><span class="p">});</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre>
<p>This works great as the solution checks the validation for each attribute individually and sets the message for the correct blurred field. A <a href="http://jsbin.com/afetez/2/edit">demo</a> of the above by <a href="http://github.com/braddunbar">@braddunbar</a> is also available.</p>
<p>It unfortunately however forces us to validate all of your form fields every time.
      If we have multiple client-side validation methods with our particular use case, we may not want to have to call each validation method on every attribute every time, so this solution might not be ideal for everyone.</p>
<p>A potentially better alternative to the above is to use <a href="http://github.com/@franko">@gfranko</a>'s <a href="https://github.com/gfranko/Backbone.validateAll">Backbone.validateAll</a> plugin, specifically created to validate specific Model properties (or form fields) without worrying about the validation of any other Model properties (or form fields).</p>
<p>Here is how we would setup a partial User Model and validate method using this plugin, that caters to our use-case:</p>
<pre><span class="c1">// Create a new User Model</span>
      <span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

            <span class="c1">// RegEx Patterns</span>
            <span class="nx">patterns</span><span class="o">:</span> <span class="p">{</span>

                <span class="nx">specialCharacters</span><span class="o">:</span> <span class="s1">'[^a-zA-Z 0-9]+'</span><span class="p">,</span>

                <span class="nx">digits</span><span class="o">:</span> <span class="s1">'[0-9]'</span><span class="p">,</span>

                <span class="nx">email</span><span class="o">:</span> <span class="s1">'^[a-zA-Z0-9._-]+@[a-zA-Z0-9][a-zA-Z0-9.-]*[.]{1}[a-zA-Z]{2,6}$'</span>
            <span class="p">},</span>

          <span class="c1">// Validators</span>
            <span class="nx">validators</span><span class="o">:</span> <span class="p">{</span>

            <span class="nx">minLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">minLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">minLength</span><span class="p">;</span>

                <span class="p">},</span>

                <span class="nx">maxLength</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">maxLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">maxLength</span><span class="p">;</span>

                <span class="p">},</span>

                 <span class="nx">isEmail</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>

                <span class="p">},</span>

                <span class="nx">hasSpecialCharacter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">pattern</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">patterns</span><span class="p">.</span><span class="nx">specialCharacters</span><span class="p">);</span>

                <span class="p">},</span>
               <span class="p">...</span>

          <span class="c1">// We can determine which properties are getting validated by</span>
          <span class="c1">// checking to see if properties are equal to null</span>

              <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>

                <span class="kd">var</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">{};</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'first name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">firstname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">firstname</span> <span class="o">=</span> <span class="s1">'firstname cannot contain special characters'</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is required'</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'last name isEmpty validation called'</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">minLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too short'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">maxLength</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
                      <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname is too large'</span><span class="p">;</span>
                    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validators</span><span class="p">.</span><span class="nx">hasSpecialCharacter</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">lastname</span><span class="p">))</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">lastname</span> <span class="o">=</span> <span class="s1">'lastname cannot contain special characters'</span><span class="p">;</span>

                <span class="p">}</span>
      </pre>
<p>This allows the logic inside of our validate methods to determine which form fields are currently being set/validated, and does not care about the other model properties that are not trying to be set.</p>
<p>It's fairly straight-forward to use as well. We can simply define a new Model instance and then set the data on our model using the <code>validateAll</code> option to use the behavior defined by the plugin:</p>
<pre><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="s1">'firstname'</span><span class="o">:</span> <span class="s1">'Greg'</span> <span class="p">},</span> <span class="p">{</span><span class="nx">validateAll</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>

      </pre>
<p>That's it!.</p>
<p>The Backbone.validateAll logic doesn't override the default Backbone logic by default and so it's perfectly capable of being used for scenarios where you might care more about field-validation <a href="http://jsperf.com/backbone-validateall">performance</a> as well as those where you don't. Both solutions presented in this section should work fine however.</p>
<h1>
      <a name="user-content-restful-applications" class="anchor" href="#restful-applications"><span class="octicon octicon-link"></span></a>RESTful Applications</h1>
<h2>
      <a name="user-content-building-restful-applications-with-backbone" class="anchor" href="#building-restful-applications-with-backbone"><span class="octicon octicon-link"></span></a>Building RESTful applications with Backbone</h2>
<p>In this section of the book, we're going to take a look at developing RESTful applications using Backbone.js and modern technology stacks. When the data for your back-end is exposed through a purely RESTful API, tasks such as retrieving (GET), creating (POST), updating (PUT) and deleting (DELETE) models are made easy through Backbone's Model API. This API is so intuitive in fact that switching from storing records in a local data-store (e.g localStorage) to a database/noSQL data-store is a lot simpler than you may think.</p>
<h2>
      <a name="user-content-stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb" class="anchor" href="#stack-1-building-a-backbone-app-with-nodejs-express-mongoose-and-mongodb"><span class="octicon octicon-link"></span></a>Stack 1: Building A Backbone App With Node.js, Express, Mongoose and MongoDB</h2>
<p>The first stack we'll be looking at is:</p>
<ul>
<li><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/nodejs.org">Node.js</a></li>
      <li><a href="http://expressjs.com/">Express</a></li>
      <li><a href="http://mongoosejs.com/">Mongoose</a></li>
      <li>and <a href="http://www.mongodb.org/">MongoDB</a>
      </li>
      </ul>
<p>with <a href="http://jade-lang.com/">Jade</a> used optionally as a view/templating engine.</p>
<h3>
      <a name="user-content-reviewing-the-stack" class="anchor" href="#reviewing-the-stack"><span class="octicon octicon-link"></span></a>Reviewing the stack</h3>
<p>As you may know, node.js is an event-driven platform (built on the <a href="http://code.google.com/apis/v8/design.html">V8</a> runtime), designed for writing fast, scalable network applications. It's reasonably lightweight, efficient and great for real-time applications that are data-intensive.</p>
<p>Express is a small web-development framework written with node.js, based on <a href="http://www.sinatrarb.com/">Sinatra</a>. It supports a number of useful features such as intuitive views, robust routing and a focus on high performance.</p>
<p>Next on the list are MongoDB and Mongoose. MongoDB is an open-source, document-oriented database store designed with scalability and agility in mind. As a <a href="http://en.wikipedia.org/wiki/NoSQL">noSQL</a> database, rather than storing data in tables and rows (something we're very used to doing with relational databases), with MongoDB we instead store JSON-like documents using dynamic schemas. One of the goals of Mongo is to try bridging the gap between key-value stores (speed, scalability) and <a href="http://en.wikipedia.org/wiki/Relational_database">relational</a> databases (rich functionality).</p>
<p>Mongoose is a JavaScript library that simplifies how we interact with Mongo. Like Express, it's designed to work within the node.js environment and tries to solve some of the complexities with asynchronous data storage by offering a more user-friendly API. It also adds chaining features into the mix, allowing for a slightly more expressive way of dealing with our data.</p>
<p>Jade is a template engine influenced by Haml (which we'll be looking at later). It's implemented with JavaScript (and also runs under node). In addition to supporting Express out of the box, it boasts a number of useful features including support for mixins, includes, caching, template inheritance and much more. Whilst abstractions like Jade certainly aren't for everyone, our practical will cover working both with and without it.</p>
<h3>
      <a name="user-content-practical" class="anchor" href="#practical"><span class="octicon octicon-link"></span></a>Practical</h3>
<p>For this practical, we're going to once again look at extending the popular Backbone Todo application. Rather than relying on localStorage for data persistence, we're going to switch to storing Todos in a MongoDB document-store instead. The code for this practical can be found in <code>practicals\stacks\option2</code></p>
<p><strong>app.js</strong></p>
<p>(See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/app.js">here</a> for the source)</p>
<p>We must first include the node dependencies required by our application. These are Express, Mongoose and Path (a module containing utilities for dealing with file paths).</p>
<pre><span class="kd">var</span> <span class="nx">application_root</span> <span class="o">=</span> <span class="nx">__dirname</span><span class="p">,</span>
        <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">),</span>
        <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">),</span>
        <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
      </pre>
<p>Next, create a new Express server. <code>express()</code> is a simple way of creating an instance of express.HTTPServer, which we'll be using to pass in our routes.</p>
<pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
      </pre>
<p>After this, connect Mongoose up to a database (in our case, localhost should suffice). Should you require the ability to pass in authentication information, here's a sample containing all of the supported URL parameters: <code>mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</code></p>
<pre><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'mongodb://localhost/my_database'</span><span class="p">);</span>
      </pre>
<p>A Mongoose model for any Todo item can now be easily defined by passing a schema instance to <code>mongoose.model</code>. In our case the schema covers a Todo item's <code>text</code> content, its <code>done</code> state and <code>order</code> position in the overall Todo list.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Todo'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
        <span class="nx">text</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="nx">done</span><span class="o">:</span> <span class="nb">Boolean</span><span class="p">,</span>
        <span class="nx">order</span><span class="o">:</span> <span class="nb">Number</span>
      <span class="p">}));</span>
      </pre>
<p>The <code>configure()</code> methods allows us to setup what we need for the current environment with our Express server. Note that lower down in the configuration are two view/view related lines. The last one explicitly sets the viewing/templating engine to be used as Jade <code>app.set('view engine', 'jade')</code>. We can avoid these if we wish to use plain HTML/JS for our templates instead.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// the bodyParser middleware parses JSON request bodies</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">({</span> <span class="nx">dumpExceptions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">showStack</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">application_root</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">)</span>
      <span class="p">});</span>

      </pre>
<p>Should you prefer to switch out Jade for an alternative view engine, this can be done fairly trivially. See the section under 'Templating' here:
      <a href="https://github.com/joyent/node/wiki/modules">https://github.com/joyent/node/wiki/modules</a>. For example, to switch to EJS, you would simply write <code>app.set('view engine', 'ejs')</code></p>
<p>Express makes use of common HTTP verbs (get, put, post etc.) to provide easy to use, expressive routing API based on CRUD (Create, Read, Update and Delete). Below for example, we can define what happens when the browser requests the root '/'. As a trivial route in this application, it doesn't do anything particularly exciting, however getters typically read or retrieve data.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>Onto something a little more useful and in our next route, navigating to '/todo' will actually render our Jade view 'todo.jade', as seen in the callback. Additional configuration values can be passed as the second parameter, such as the custom title specified below.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'todo'</span><span class="p">,</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">'Our sample application'</span><span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>Next, we can see the first of our '/api/' routes.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todos</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>The callback to our next route supports querying for todos based on a specific ID. The route string itself (once compiled) will be converted from '/api/todos/:id' to a regular expression. As you might have guessed, this is a hint that routes can also be regular expression literals if we wished to do something more complex.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>Similarly, we want to support updating todos based on a specific ID as well. The following allows us to query a todo by ID and then update the values of its three attributes (text, done, order) easily.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">done</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'updated'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>We've so far covered requesting todos and updating them, but a core part of the application requires us to insert (or add) new todos to our data-store. Below we can create new <code>Todo</code> models and simply save them.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/api/todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">todo</span><span class="p">;</span>
        <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span>
          <span class="nx">text</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
          <span class="nx">done</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span>
          <span class="nx">order</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">order</span>
        <span class="p">});</span>
        <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>We of course also want to support deleting todos (e.g if a todo has been 'cleared', it should be deleted). This also works based on a specific todo ID.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/api/todos/:id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">Todo</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">);</span>
              <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>Finally, this last line is to ensure we're only listening on the port app.js is running.</p>
<pre><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
      </pre>
<p><strong>script.js - updating our Backbone.js app</strong></p>
<p>In the <code>/public/js</code> folder of options 1 (HTML templates) and 2 (Jade) for the practical, you'll find a version of the Backbone Todo app originally by Jerome Gravel-Niquet. Let's pay attention to <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option2/public/js/script.js">script.js</a>. In order to change the application to work with our new back-end, we'll need to make some very minor changes to this.</p>
<p>Reviewing <code>window.TodoList</code> (a Backbone Collection), you'll notice that it has a property called <code>localStorage</code>, which uses the Backbone <a href="https://github.com/jeromegn/Backbone.localStorage">localStorage</a> adapter in order to facilitate storing data using the browser's localStorage features.</p>
<pre><span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// Typically, this should be a unique name within your application</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>
      </pre>
<p>In order to switch it over to our RESTful backend, we're going to make use of the <code>url</code> property or function on a collection to reference its location on the server. Models inside of a collection then use <code>url</code> to construct URLs of their own. As all of the CRUD for our RESTful API works on the base route '/api/todos', this is the value we set <code>url</code> to.</p>
<pre>    <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>
      </pre>
<p>This is the only change necessary to our existing Backbone application in order to get things working. Pretty easy, right?</p>
<p><strong>todo.jade</strong></p>
<p>The Jade templates for our application cover declarative markup for both the index (layout.jade) of the application and the main Todo container (todo.jade). It also covers the script-tag templates used for rendering each new Todo item that's added.</p>
<pre>// Todo App Interface

      #todoapp
        .title
          h1 Todos
        .content
          #create-todo
            input#new-todo(placeholder="What needs to be done?", type="text")
            span.ui-tooltip-top(style="display:none;") Press Enter to save this task
          #todos
            ul#todo-list
          #todo-stats


      // Templates
      script#item-template(type="text/template")
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        .display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          .todo-text
          span#todo-destroy
        .edit
          input.todo-input(type="text", "value"="")
        <span class="nt">&lt;/div&gt;</span>

      script#stats-template(type="text/template")
        <span class="err">&lt;</span>% if (total) { %&gt;
        span.todo-count
          span.number <span class="err">&lt;</span>%= remaining %&gt;
          span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          |  left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        span.todo-clear
          a(href="#")
            |  Clear
            span.number-done <span class="err">&lt;</span>%= done %&gt;
            |  completed
            span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre>
<p><strong>layout.jade</strong></p>
<pre>head
        meta(charset="utf-8")
        meta(http-equiv="X-UA-Compatible", content="IE=edge,chrome=1")

        title=title
        meta(name="description", content="")
        meta(name="author", content="")
        meta(name="viewport", content="width=device-width,initial-scale=1")

        // CSS concatenated and minified via ant build script
        link(rel="stylesheet", href="css/style.css")
        // end CSS

        script(src="js/libs/modernizr-2.0.6.min.js")
      body

        #container
          header
          #main(role="main")!=body
          footer
        //! end of #container

        script(src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js")
        script
          window.jQuery || document.write('<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"js/libs/jquery-1.6.2.min.js"</span><span class="nt">&gt;</span><span class="err">&lt;\\/script&gt;')</span>

        // scripts concatenated and minified via ant build script
        script(src="js/mylibs/underscore.js")
        script(src="js/mylibs/backbone.js")
        script(defer, src="js/plugins.js")
        script(defer, src="js/script.js")
        // end scripts

        // Change UA-XXXXX-X to be your site's ID
        script
          window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
          Modernizr.load({load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'});

        //if lt IE 7
          script(src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js")
          script
            window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})
      <span class="nt">&lt;/html&gt;</span>

      </pre>
<p><strong>static.html</strong></p>
<p>Alternatively, a static version of our index which doesn't rely on Jade can be put together as follows. See <a href="https://github.com/addyosmani/backbone-boilerplates/blob/master/option1/public/static.html">here</a> for the complete file or below for a sample.</p>
<pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"container"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"main"</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>

            <span class="c">&lt;!-- Todo App Interface--&gt;</span>

            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todoapp"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h1&gt;</span>Todos<span class="nt">&lt;/h1&gt;</span>
              <span class="nt">&lt;/div&gt;</span>

              <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"create-todo"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"new-todo"</span> <span class="na">placeholder=</span><span class="s">"What needs to be done?"</span> <span class="na">type=</span>
                  "text" /&gt;<span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"display:none;"</span> <span class="na">class=</span><span class="s">"ui-tooltip-top"</span><span class="nt">&gt;</span>Press Enter to
                  save this task<span class="nt">&lt;/span&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todos"</span><span class="nt">&gt;</span>
                  <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"todo-list"</span><span class="nt">&gt;&lt;/ul&gt;</span>
                <span class="nt">&lt;/div&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"todo-stats"</span><span class="nt">&gt;&lt;/div&gt;</span>
              <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>


          <span class="c">&lt;!-- Templates--&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"item-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"display"</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"check"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"checkbox"</span> <span class="o">&lt;%=</span> <span class="nx">done</span> <span class="o">?</span> <span class="s1">'checked="checked"'</span> <span class="o">:</span> <span class="s1">''</span> <span class="o">%&gt;</span> <span class="err">/&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-text"</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;&lt;span id="todo-destroy"&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class="edit"&gt;&lt;input type="text" value="" class="todo-input"/&gt;&lt;/div&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

            <span class="nt">&lt;script </span><span class="na">id=</span><span class="s">"stats-template"</span> <span class="na">type=</span><span class="s">"text/template"</span><span class="nt">&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">total</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-count"</span><span class="o">&gt;&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number"</span><span class="o">&gt;&lt;%=</span> <span class="nx">remaining</span> <span class="o">%&gt;</span> <span class="o">&lt;</span><span class="err">/span&gt;&lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.</span>
            <span class="o">&lt;</span><span class="err">/span&gt;&lt;% } %&gt;</span>
            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"todo-clear"</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"#"</span><span class="o">&gt;</span> <span class="nx">Clear</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"number-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt; completed</span>
            <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">"word-done"</span><span class="o">&gt;&lt;%=</span> <span class="nx">done</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s1">'item'</span> <span class="o">:</span> <span class="s1">'items'</span> <span class="o">%&gt;&lt;</span><span class="err">/span&gt;&lt;/a&gt;&lt;/span&gt;&lt;% } %&gt;</span>
            <span class="nt">&lt;/script&gt;</span>

          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

        <span class="c">&lt;!--! end of #container--&gt;</span>
      </pre>
<h3>
      <a name="user-content-practical-setup" class="anchor" href="#practical-setup"><span class="octicon octicon-link"></span></a>Practical Setup</h3>
<p>We've now gone through the major points of developing a RESTful backend using Node.js, Express and Mongoose. Next, let's make sure you can get your environment setup to run the updated Todo app.</p>
<h4>
      <a name="user-content-mongodb" class="anchor" href="#mongodb"><span class="octicon octicon-link"></span></a>MongoDB</h4>
<p>Once you've downloaded <a href="http://www.mongodb.org/downloads">MongoDB</a>, you'll need to complete two steps to get it up and running.</p>
<p><strong>Data directories</strong></p>
<p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted MongoDB and run the following from terminal:</p>
<pre>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </pre>
<p><strong>Running and connecting to your server</strong></p>
<p>Once this is done, open up two terminal windows.</p>
<p>In the first, <code>cd</code> to your MongoDB bin directory or type in the complete path to it. You'll need to start <code>mongod</code>.</p>
<pre>$ ./bin/mongod
      </pre>
<p>Next, in the second terminal, start the <code>mongo</code> shell which will connect up to localhost by default.</p>
<pre>$ ./bin/mongo
      </pre>
<p>That's it!.</p>
<h4>
      <a name="user-content-express-and-mongoose" class="anchor" href="#express-and-mongoose"><span class="octicon octicon-link"></span></a>Express and Mongoose</h4>
<p>Option 1 (HTML) and Option 2 (Jade) of the practical download both come with an install.sh bash script. This allows you to easily install Express, Mongoose, Jade (and optionally MongoDB if you prefer to) through npm (the node package manager).</p>
<ul>
<li>Make sure you have Node.js installed. If not, you can grab it <a href="http://nodejs.org/#download">here</a>
      </li>
      <li>Next run <code>$ ./install.sh</code> at the terminal to install the rest of our dependencies. To see the exact contents of the install.sh file, see below:</li>
      </ul>
<p><strong>install.sh</strong></p>
<pre>#!/bin/bash
      npm install express
      npm install mongodb --mongodb:native
      npm install mongoose
      npm install jade
      </pre>
<ul>
<li>After you've installed all of the dependencies for the stack, we can get to cloning the repo containing our practicals and running them. Start by running the below lines:</li>
      </ul>
<pre>git clone git://github.com/addyosmani/backbone-boilerplates.git
      cd option2
      node app.js
      </pre>
<p>For option1 (without Jade), simply cd into option1 and run <code>node app.js</code> from there.</p>
<p>Finally, either of the example apps can now be accessed by navigating to:</p>
<ul>
<li>Option 1: <code>http://localhost:3000/static.html</code>
      </li>
      <li>Option 2: <code>http://localhost:3000/todo</code>
      </li>
      </ul>
<p>That's it! Whilst there's a lot more than can be done to expand on the concepts covered so far, the base we're reviewed should be enough to get you up and running with this stack if you wish to use it with Backbone.</p>
<h1>
      <a name="user-content-building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml" class="anchor" href="#building-backbonejs-apps-with-ruby-sinatra-mongodb-and-haml"><span class="octicon octicon-link"></span></a>Building Backbone.js Apps With Ruby, Sinatra, MongoDB and Haml</h1>
<h2>
      <a name="user-content-introduction-1" class="anchor" href="#introduction-1"><span class="octicon octicon-link"></span></a>Introduction</h2>
<p>In this chapter we're going to explore writing Backbone.js applications with a Ruby back-end. To assist with this, we're going to use <a href="http://www.sinatrarb.com/">Sinatra</a> - a DSL (domain specific language) for rapidly creating web applications in Ruby. Similar to the <a href="https://github.com/addyosmani/backbone-fundamentals/#stack1">section</a> on writing an application with Node.js, our server-side language (Ruby) will be used to power an API whilst Backbone.js will be the client consuming it.</p>
<h2>
      <a name="user-content-what-is-sinatra" class="anchor" href="#what-is-sinatra"><span class="octicon octicon-link"></span></a>What Is Sinatra?</h2>
<p>In the past, you've likely come across or used <a href="http://rubyonrails.org">Ruby on Rails</a> (RoR) - a popular web application framework for the Ruby programming language that helps organize applications using the MVC pattern. Sinatra is a much smaller, more light-weight alternative to it.</p>
<p>Whilst a very basic Rails application may require a more strict project structure (such as requiring the use of controllers, views and routing etc.), Sinatra doesn't require as many of these dependencies, sacrificing the helpers needed to connect to databases, tools to create forms or any of the other utilities Rails comes with out of the box.</p>
<p>What Sinatra does have is a <strong>minimal</strong> set of features most useful for tying specific URLs and RESTful HTTP actions to blocks of Ruby code and returning this code's output as a response. Sinatra is particularly useful for getting projects up and running quickly where we don't have a need for the extra pieces RoR provides.</p>
<p>For those who are familiar with more Rails, you probably know that it requires a separate routes file to define how an application should be responding to requests. These are then piped into the relevant models and controllers as needed.</p>
<p>Sinatra takes a more straight-forward approach, providing us with the most simple path to handling routing. By declaring <code>get</code>,<code>post</code>, <code>put</code> or <code>delete</code> actions, we can inform Sinatra to add a new route, which we can then have respond to requests.</p>
<p>The framework is particularly useful for writing APIs, widgets and small-scale applications that can power the backend of a client-heavy application. As mentioned, we will be using it to power our API.</p>
<h2>
      <a name="user-content-getting-started-with-sinatra" class="anchor" href="#getting-started-with-sinatra"><span class="octicon octicon-link"></span></a>Getting Started With Sinatra</h2>
<p>Let's review how to write and run a very basic Sinatra application. As most programming languages and frameworks typically start with some variation of "Hello World", we'll start with a similar example.</p>
<p>Note: Before beginning this section, I recommend installing Sinatra on your system. A guide to doing this can be found in the <a href="#preq">prerequisites</a> section lower down in the article.</p>
<h3>
      <a name="user-content-routes" class="anchor" href="#routes"><span class="octicon octicon-link"></span></a>Routes</h3>
<p>As mentioned, Sinatra allows us to define new routes using HTTP actions. Semantically, a route follows quite a simple structure:</p>
<pre><span class="o">&lt;</span><span class="n">a</span> <span class="no">HTTP</span> <span class="n">action</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">desired</span> <span class="n">route</span><span class="o">&gt;</span> <span class="k">do</span>
         <span class="c1"># some behaviour</span>
      <span class="k">end</span>
      </pre>
<p>A tiny route that outputs a "Hello World"-like message when we attempt to "get" the root could thus be written as follows:</p>
<pre><span class="nb">require</span> <span class="s1">'sinatra'</span>

      <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
         <span class="s2">"Hello World! Is it me you're looking for?"</span>
      <span class="k">end</span>
      </pre>
<p>To run this snippet, we can can simply save it to a local '.rb' file and execute it as follows:</p>
<pre><span class="n">ruby</span> <span class="o">-</span><span class="n">rubygems</span> <span class="n">example</span><span class="o">.</span><span class="n">rb</span>
      </pre>
<p>If we now navigated to http://localhost:4567 in our browser we could now see the application running successfully.</p>
<p>The HTTP verbs we commonly work with when writing RESTful web services are: <code>get</code>, <code>post</code>, <code>delete</code> and <code>put</code>. As we now know, all Sinatra routes are basically HTTP actions (<code>get</code> etc.) that are paired with a URL-matching pattern. We associate a pair of an action and route with code we would like sent back to the browser (executed)if the route is reached. Sinatra doesn't enforce much in the way of architectural structure, instead relying on simplicity to supporting writing powerful APIs.</p>
<p>Here's an example of a skeleton service we could put together supporting four common HTTP actions:</p>
<pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="c1"># list all items available</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># get a single item</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/item'</span> <span class="k">do</span>
        <span class="c1"># create a new item</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># update an existing item</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># delete an item</span>
      <span class="k">end</span>
      </pre>
<p>Sinatra's routing is both easy for beginners to get started with but is also flexible enough for those wishing to define more complex routes. As you probably noticed in the above example, routes can include named parameters (e.g <code>/item/:id</code>). We can actually access the content of these routes using the <code>params</code> hash as follows:</p>
<pre><span class="n">get</span> <span class="s1">'/item/:id'</span> <span class="k">do</span>
        <span class="c1"># this matches "GET /item/10" and "GET /item/11"</span>
        <span class="c1"># params[:id] is "10" or "11"</span>
        <span class="s2">"You reached </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
      </pre>
<p>Sinatra also supports route matching via splats, wildcards and regular expressions. For more information on this I recommend reading the official <a href="http://www.sinatrarb.com/documentation">docs</a>. Let's now take a look at handlers.</p>
<p>Sinatra includes convenient handler methods for tasks such as redirection, halting and passing.</p>
<h4>
      <a name="user-content-redirection" class="anchor" href="#redirection"><span class="octicon octicon-link"></span></a>Redirection</h4>
<p>A simple route supporting redirection which returns a 302 response can be written as follows:</p>
<pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
            <span class="n">redirect</span> <span class="s1">'/items/welcome'</span>
      <span class="k">end</span>
      </pre>
<p>And if we wish to pass additional parameters such as arguments we can do so like this:
      redirect '<a href="http://site.com/">http://site.com/</a>', 'Oops! I think we have a problem!'</p>
<h4>
      <a name="user-content-halting" class="anchor" href="#halting"><span class="octicon octicon-link"></span></a>Halting</h4>
<p>To immediately stop a request (halting) we can use 'halt'. Heres an example of halting a request where we specify the message body:</p>
<p><code>halt "who goes there!?"</code></p>
<h4>
      <a name="user-content-passing" class="anchor" href="#passing"><span class="octicon octicon-link"></span></a>Passing</h4>
<p>'Passing' is the concept of deferring processing of a block to the next matching route. We do this using <code>pass</code>. In the following example if a parameter isnt the username we expect (rick-astley) we simply pass it on:</p>
<pre><span class="n">get</span> <span class="s1">'/members/:username'</span> <span class="k">do</span>
       <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="o">[</span><span class="ss">:username</span><span class="o">]</span> <span class="o">==</span> <span class="s1">'rick-astley'</span>
       <span class="s1">'Never gonna give you up, never gonna let you down'</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/members/*'</span> <span class="k">do</span>
       <span class="s1">'Welcome!'</span>
      <span class="k">end</span>
      </pre>
<p>There are also handler methods that can assist with sessions (specifically, cookie-based session handling). To use Sinatra's session handling, first enable it in your application with:</p>
<pre><span class="n">enable</span> <span class="ss">:sessions</span>
      </pre>
<p>You can then use the session handling capabilities as follows:</p>
<pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">||=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="s2">"This page has been accessed </span><span class="si">#{</span><span class="n">session</span><span class="o">[</span><span class="s1">'visitCounter'</span><span class="o">]</span><span class="si">}</span><span class="s2"> times"</span>
      <span class="k">end</span>
      </pre>
<p>Note: By default enable:sessions will store all data in cookies. If this is not desired, you can not call this and instead use some Rack middleware instead. For more on this see <a href="http://www.sinatrarb.com/intro#Using%20Sessions">here</a>.</p>
<p>This only touches the surface of what can be done using routes and handlers, but is sufficient for us to write the Sinatra-powered API service we require in the practical section of this chapter.</p>
<h2>
      <a name="user-content-templating-and-haml" class="anchor" href="#templating-and-haml"><span class="octicon octicon-link"></span></a>Templating And HAML</h2>
<p>Let's now discuss templating.Out of the box, we can begin using templates in our Sinatra applications with ERB. ERB is included with Ruby and allows Ruby code to be added to any plain text document for the purpose of generating information or flow control. In the following example using an ERB template, note that views are by default located in the <code>views</code> directory of our application.</p>
<pre><span class="n">get</span> <span class="s1">'/items'</span> <span class="k">do</span>
        <span class="n">erb</span> <span class="ss">:default</span>
        <span class="c1"># renders views/default.erb</span>
      <span class="k">end</span>
      </pre>
<p>A useful Sinatra convention worth noting is how layouts are handled. Layouts automatically search for a views/layout template which is rendered before any other views are loaded. With ERB, our views/layout.erb file could look as follows:</p>
<pre><span class="nt">&lt;html&gt;</span>
        <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
        <span class="nt">&lt;body&gt;</span>
          <span class="err">&lt;</span>%= data %&gt;
        <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre>
<p>Haml is a popular alternative to ERB which offers an abstract syntax for writing application templates. It has been said to be:</p>
<ul>
<li>Straight-forward to learn</li>
      <li>Very easy to read and use for visually expressing a hierarchy of DOM elements</li>
      <li>Popular with web designers as it builds on top of CSS syntax</li>
      <li>Well documented with a large community backing it</li>
      <li>Almost as fast as ERB</li>
      </ul>
<p>For the purpose of comparison, below we can see an ERB template compared to its Haml equivalent.</p>
<h4>
      <a name="user-content-erb" class="anchor" href="#erb"><span class="octicon octicon-link"></span></a>ERB</h4>
<pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo"</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">"entry_title"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= h @todo.title %&gt;<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"entry_link"</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= link_to('link', @todo.link) %&gt;<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre>
<h4>
      <a name="user-content-haml" class="anchor" href="#haml"><span class="octicon octicon-link"></span></a>Haml</h4>
<pre>.todo#content
        %h2.entry_title= @todo.title
        .entry_link= link_to('link', @todo.link)
      </pre>
<p>One of the first things we notice is that the Haml snippet looks significantly more like CSS than it does traditional markup. It's much easier to read and we no longer need to be concerned with divs, spans, closing tags or other semantic rules that usually mean more keystrokes. The approach taken to making whitespace a part of the syntax also means it can be much easier to compare changes between multiple documents (especially if you're doing a diff).</p>
<p>In the list of Haml features, we briefly mentioned web designers. As developers, we regularly need to communicate and work with designers, but we always have to remember that at the end of the day, they are not programmers. They're usually more concerned with the look and the feel of an application, but if we want them to write mark-up as a part of the templates or skins they create, Haml is a simpler option that has worked well for teams at a number of companies.</p>
<pre><span class="o">%</span><span class="n">h1</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h1</span> <span class="n">text</span>
      <span class="o">%</span><span class="n">h2</span> <span class="no">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">h2</span> <span class="n">text</span><span class="o">.</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="n">line</span> <span class="n">containing</span> <span class="n">a</span> <span class="n">single</span> <span class="n">instance</span> <span class="ss">variable</span><span class="p">:</span> <span class="vi">@content</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="vi">@content</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Embedding</span> <span class="no">Ruby</span> <span class="n">code</span> <span class="k">in</span> <span class="n">the</span> <span class="n">middle</span> <span class="n">of</span> <span class="n">a</span> <span class="n">line</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">using</span> <span class="o">==.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">==</span> <span class="no">Here</span> <span class="n">is</span> <span class="n">an</span> <span class="ss">example</span><span class="p">:</span> <span class="c1">#{@foobar}</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">We</span> <span class="n">can</span> <span class="n">also</span> <span class="n">add</span> <span class="n">attributes</span> <span class="n">using</span> <span class="p">{}</span>
      <span class="o">%</span><span class="nb">p</span><span class="p">{</span><span class="ss">:style</span> <span class="o">=&gt;</span> <span class="s2">"color:green"</span><span class="p">}</span> <span class="no">We</span> <span class="n">just</span> <span class="n">made</span> <span class="n">this</span> <span class="n">paragraph</span> <span class="n">green!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">You</span><span class="err">'</span><span class="n">ll</span> <span class="n">want</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">ids</span> <span class="n">to</span> <span class="n">your</span> <span class="no">DOM</span><span class="p">,</span> <span class="n">too</span><span class="o">.</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">foo</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">bar</span> <span class="no">This</span> <span class="n">has</span> <span class="n">the</span> <span class="n">bar</span> <span class="k">class</span>
      <span class="o">%</span><span class="nb">p</span><span class="c1">#foobar This has the foobar id</span>
      <span class="o">%</span><span class="nb">p</span><span class="o">.</span><span class="n">foo</span><span class="c1">#foobar Or you can combine them!</span>

      <span class="o">%</span><span class="nb">p</span> <span class="no">Nesting</span> <span class="n">can</span> <span class="n">be</span> <span class="n">done</span> <span class="n">like</span> <span class="n">this</span>
      <span class="o">%</span><span class="nb">p</span>
        <span class="no">Or</span> <span class="n">even</span> <span class="n">like</span> <span class="n">this</span>

      </pre>
<p>Note: Haml is whitespace sensitive and will not correctly work if it isn't indented by an even number of spaces. This is due to whitespace being used for nesting in place of the classic HTML markup approach of closing tags.</p>
<h1>
      <a name="user-content-mongodb-ruby-driver" class="anchor" href="#mongodb-ruby-driver"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h1>
<h2>
      <a name="user-content-getting-started-1" class="anchor" href="#getting-started-1"><span class="octicon octicon-link"></span></a>Getting started</h2>
<p>Once the MongoDB Ruby driver is installed, we can begin to use it to connect to a Mongo database. To create a  connection using localhost, we simply specify the driver as a dependency. Assuming we're using the default port we can then connect as follows:</p>
<pre><span class="nb">require</span> <span class="s1">'mongo'</span>

      <span class="c1"># where 'learning-mongo' is the name of our database:</span>
      <span class="n">db</span> <span class="o">=</span> <span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'learning-mongo'</span><span class="p">);</span>
      </pre>
<p>We probably also want to place some data into 'learning-mongo'. It could be as simple as a note, so why don't we go ahead and begin a notes collection?:</p>
<pre><span class="n">notes</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s1">'notes'</span><span class="p">)</span>
      </pre>
<p>Something interesting worth noting is that at this point, we haven't actually created the database nor the collection we're referencing above.</p>
<p>Neither of these items exist in Mongo (just yet) but as we're working with a new database but they will once we insert some real data.</p>
<p>A new note could be defined using key/value pairs as follows and then inserted into 'learning-mongo' using <code>collection.insert()</code>:</p>
<pre><span class="n">our_note</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">'Remember the milk'</span><span class="p">,</span> <span class="ss">:remindInterval</span> <span class="o">=&gt;</span> <span class="s1">'weekly'</span><span class="p">}</span>
      <span class="n">note_id</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">our_note</span><span class="p">)</span>
      </pre>
<p>What is returned from inserting a note into the notes collection is an <code>ObjectId</code> reference for the note from Mongo. This is useful as we can re-use it to locate the same document in our database.</p>
<pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      </pre>
<p>This can also be used in conjunction with Mongo's <code>collection.update()</code> method and <a href="http://www.mongodb.org/display/DOCS/Updating">query</a> operators (i.e <code>$set</code>) to replace fields in an existing document.</p>
<p>We might update an entire document as follows:</p>
<pre><span class="n">note</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
      <span class="n">note</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'Remember the bread'</span>
      <span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="n">note</span><span class="p">)</span>
      </pre>
<p>or using <code>$set</code>, update an existing document without overwriting the entire object as like this:</p>
<pre><span class="n">notes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span> <span class="ss">:_id</span> <span class="o">=&gt;</span> <span class="n">note_id</span> <span class="p">},</span> <span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=</span> <span class="o">&gt;</span> <span class="s1">'Remember the bread'</span> <span class="p">})</span>
      </pre>
<p>Useful to know: Almost each MongoDB document has an _id field as its first attribute. This can normally
      be of any type, however a special BSON datatype is provided for object ids. It's a
      12-byte binary value that has a high probability of being unique when allocated.</p>
<p>Note: Whilst we opted for the MongoDB Ruby Driver for this stack, you may also be interested in <strong>DataMapper</strong> - a solution which allows us to use the same API to talk to a number of different datastores. This works well for both relational and non-relational databases and more information is available on the official <a href="http://datamapper.org/why.html">project page</a>. <a href="http://sinatra-book.gittr.com/#datamapper">Sinatra: The Book</a> also contains a brief tutorial on DataMapper for anyone interested in exploring it further.</p>
<h1>
      <a name="user-content-practical-1" class="anchor" href="#practical-1"><span class="octicon octicon-link"></span></a>Practical</h1>
<p>We're going to use Sinatra in a similar manner to how we used Express in the last chapter. It will power a RESTful API supporting CRUD operations. Together with a MongoDB data store, this will allow us to easily persist data (todo items) whilst ensuring they are stored in a database. If you've read the previous chapter or have gone through any of the Todo examples covered so far, you will find this surprisingly straight-forward.</p>
<p>Remember that the default Todo example included with Backbone.js already persists data, although it does this via a localStorage adapter. Luckily there aren't a great deal of changes needed to switch over to using our Sinatra-based API.  Let's briefly review the code that will be powering the CRUD operations for this sections practical, as we won't be starting off with a near-complete base for most of our real world applications.</p>
<h3>
      <a name="user-content-installing-the-prerequisites" class="anchor" href="#installing-the-prerequisites"><span class="octicon octicon-link"></span></a>Installing The Prerequisites</h3>
<h4>
      <a name="user-content-ruby" class="anchor" href="#ruby"><span class="octicon octicon-link"></span></a>Ruby</h4>
<p>If using OSX or Linux, Ruby may be one of a number of open-source packages that come pre-installed and you can skip over to the next paragraph. In case you would like to check if check if you have Ruby installed, open up the terminal prompt and type:</p>
<p><code>$ ruby -v</code></p>
<p>The output of this will either be the version of Ruby installed or an error complaining that Ruby wasn't found.</p>
<p>Should you need to install Ruby manually (e.g for an operating system such as Windows), you can do so by downloading the latest version from <a href="http://www.ruby-lang.org/en/downloads/">http://www.ruby-lang.org/en/downloads/</a>. Alternatively, <a href="http://beginrescueend.com/rvm/install/">RVM</a> (Ruby Version Manager) is a command-line tool that allows you to easily install and manage multiple ruby environments with ease.</p>
<h4>
      <a name="user-content-ruby-gems" class="anchor" href="#ruby-gems"><span class="octicon octicon-link"></span></a>Ruby Gems</h4>
<p>Next, we will need to install Ruby Gems. Gems are a standard way to package programs or libraries written in Ruby and with Ruby Gems it's possible to install additional dependencies for Ruby applications very easily.</p>
<p>On OSX, Linux or Windows go to <a href="http://rubyforge.org/projects/rubygems">http://rubyforge.org/projects/rubygems</a> and download the latest version of Ruby Gems. Once downloaded, open up a terminal, navigate to the folder where this resides and enter:</p>
<pre><code>$&gt; tar xzvf rubygems.tgz
      $&gt; cd rubygems
      $&gt; sudo ruby setup.rb
      </code></pre>
<p>There will likely be a version number included in your download and you should make sure to include this when tying the above. Finally, a symlink (symbolic link) to tie everything togther should be run as follows:</p>
<p><code>$ sudo ln -s /usr/bin/gem1.8.17 /usr/bin/gem</code></p>
<p>To check that Ruby Gems has been correctly installed, type the following into your terminal:</p>
<pre><code>$ gem -v
      </code></pre>
<h4>
      <a name="user-content-sinatra" class="anchor" href="#sinatra"><span class="octicon octicon-link"></span></a>Sinatra</h4>
<p>With Ruby Gems setup, we can now easily install Sinatra. For Linux or OSX type this in your terminal:</p>
<p><code>$ sudo gem install sinatra</code></p>
<p>and if you're on Windows, enter the following at a command prompt:</p>
<p><code>c:\&gt; gem install sinatra</code></p>
<h4>
      <a name="user-content-haml-1" class="anchor" href="#haml-1"><span class="octicon octicon-link"></span></a>Haml</h4>
<p>As with other DSLs and frameworks, Sinatra supports a wide range of different templating engines. <a href="http://www.ruby-doc.org/stdlib/libdoc/erb/rdoc/classes/ERB.html">ERB</a> is the one most often recommended by the Sinatra camp, however
      as a part of this chapter, we're going to explore the use of <a href="http://haml.hamptoncatlin.com/">Haml</a> to define our application templates.</p>
<p>Haml stands for HTML Abstractional Markup Language and is a lightweight markup language abstraction that can be used to describe HTML without the need to use traditional markup language semantics (such as opening and closing tags).</p>
<p>Installing Haml can be done in just a line using Ruby Gems as follows:</p>
<p><code>$ gem install haml</code></p>
<h4>
      <a name="user-content-mongodb-1" class="anchor" href="#mongodb-1"><span class="octicon octicon-link"></span></a>MongoDB</h4>
<p>If you haven't already downloaded and installed MongoDB from an earlier chapter, please <a href="http://www.mongodb.org/downloads">do so</a> now. With Ruby Gems, Mongo can be installed in just one line:</p>
<p><code>$ gem install mongodb</code></p>
<p>We now require two further steps to get everything up and running.</p>
<h5>
      <a name="user-content-1data-directories" class="anchor" href="#1data-directories"><span class="octicon octicon-link"></span></a>1.Data directories</h5>
<p>MongoDB stores data in the bin/data/db folder but won't actually create this directory for you. Navigate to where you've downloaded and extracted Mongo and run the following from terminal:</p>
<pre><code>sudo mkdir -p /data/db/
      sudo chown `id -u` /data/db
      </code></pre>
<h5>
      <a name="user-content-2running-and-connecting-to-your-server" class="anchor" href="#2running-and-connecting-to-your-server"><span class="octicon octicon-link"></span></a>2.Running and connecting to your server</h5>
<p>Once this is done, open up two terminal windows.</p>
<p>In the first, cd to your MongoDB bin directory or type in the complete path to it. You'll need to start mongod.</p>
<pre><code>$ ./bin/mongod
      </code></pre>
<p>Finally, in the second terminal, start the mongo shell which will connect up to localhost by default.</p>
<pre><code>$ ./bin/mongo
      </code></pre>
<h4>
      <a name="user-content-mongodb-ruby-driver-1" class="anchor" href="#mongodb-ruby-driver-1"><span class="octicon octicon-link"></span></a>MongoDB Ruby Driver</h4>
<p>As we'll be using the <a href="https://github.com/mongodb/mongo-ruby-driver">MongoDB Ruby Driver</a>, we'll also require the following gems:</p>
<p>The gem for the driver itself:</p>
<pre><code>$ gem install mongo
      </code></pre>
<p>and the driver's other prerequisite, bson:</p>
<pre><code>$ gem install bson_ext
      </code></pre>
<p>This is basically a collection of extensions used to increase serialization speed.</p>
<p>That's it for our prerequisites!.</p>
<h2>
      <a name="user-content-tutorial" class="anchor" href="#tutorial"><span class="octicon octicon-link"></span></a>Tutorial</h2>
<p>To get started, let's get a local copy of the practical application working on our system.</p>
<h3>
      <a name="user-content-application-files" class="anchor" href="#application-files"><span class="octicon octicon-link"></span></a>Application Files</h3>
<p>Clone <a href="http://github.com/addyosmani/backbone-fundamentals">this</a> repository and navigate to <code>/practicals/stacks/option3</code>. Now run the following lines at the terminal:</p>
<pre><code>ruby app.rb
      </code></pre>
<p>Finally, navigate to <code>http://localhost:4567/todo</code> to see the application running successfully.</p>
<p><strong>Note:</strong> The Haml layout files for Option 3 can be found in the /views folder.</p>
<p>The directory structure for our practical application is as follows:</p>
<pre><code>--public
      ----css
      ----img
      ----js
      -----script.js
      ----test
      --views
      app.rb

      </code></pre>
<p>The <code>public</code> directory contains the scripts and stylesheets for our application and uses HTML5 Boilerplate as a base. You can find the Models, Views and Collections for this section within <code>public/js/scripts.js</code> (however, this can of course be expanded into sub-directories for each component if desired).</p>
<p><code>scripts.js</code> contains the following Backbone component definitions:</p>
<pre><code>--Models
      ----Todo

      --Collections
      ----TodoList

      --Views
      ---TodoView
      ---AppView
      </code></pre>
<p><code>app.rb</code> is the small Sinatra application that powers our backend API.</p>
<p>Lastly, the <code>views</code> directory hosts the Haml source files for our application's index and templates, both of which are compiled to standard HTML markup at runtime.</p>
<p>These can be viewed along with other note-worthy snippets of code from the application below.</p>
<h3>
      <a name="user-content-backbone" class="anchor" href="#backbone"><span class="octicon octicon-link"></span></a>Backbone</h3>
<h4>
      <a name="user-content-views-2" class="anchor" href="#views-2"><span class="octicon octicon-link"></span></a>Views</h4>
<p>In our main application view (AppView), we want to load any previously stored Todo items in our Mongo database when the view initializes. This is done below with the line <code>Todos.fetch()</code> in the <code>initialize()</code> method where we also bind to the relevant events on the <code>Todos</code> collection for when items are added or changed.</p>
<pre><span class="c1">// Our overall **AppView** is the top-level piece of UI.</span>
      <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#stats-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// Delegated events for creating new items, and clearing completed ones.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>  <span class="s1">'createOnEnter'</span><span class="p">,</span>
            <span class="s1">'keyup #new-todo'</span><span class="o">:</span>     <span class="s1">'showTooltip'</span><span class="p">,</span>
            <span class="s1">'click .todo-clear a'</span><span class="o">:</span> <span class="s1">'clearCompleted'</span>
          <span class="p">},</span>

          <span class="c1">// At initialization</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">addOne</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addAll</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="nx">Todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'all'</span><span class="p">,</span>   <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

            <span class="nx">Todos</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>
       <span class="err">…</span><span class="p">.</span>
      </pre>
<h3>
      <a name="user-content-collections-1" class="anchor" href="#collections-1"><span class="octicon octicon-link"></span></a>Collections</h3>
<p>In the TodoList collection below, we've set the <code>url</code> property to point to <code>/api/todos</code> to reference the collection's location on the server. When we attempt to access this from our Sinatra-backed API, it should return a list of all the Todo items that have been previously stored in Mongo.</p>
<p>For the sake of thoroughness, our API will also support returning the data for a specific Todo item via <code>/api/todos/itemID</code>. We'll take a look at this again when writing the Ruby code powering our backend.</p>
<pre> <span class="c1">// Todo Collection</span>

        <span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="c1">// localStorage: new Store('todos'),</span>
          <span class="nx">url</span><span class="o">:</span> <span class="s1">'/api/todos'</span><span class="p">,</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="c1">// We keep the Todos in sequential order, despite being saved by unordered</span>
          <span class="c1">// GUID in the database. This generates the next order number for new items.</span>
          <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Todos are sorted by their original insertion order.</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-model" class="anchor" href="#model"><span class="octicon octicon-link"></span></a>Model</h3>
<p>The model for our Todo application remains largely unchanged from the versions previously covered in this book. It is however worth noting that calling the function <code>model.url()</code> within the below would return the relative URL where a specific Todo item could be located on the server.</p>
<pre>  <span class="c1">// Our basic **Todo** model has `text`, `order`, and `done` attributes.</span>
        <span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">idAttribute</span><span class="o">:</span> <span class="s1">'_id'</span><span class="p">,</span>

          <span class="c1">// Default attributes for a todo item.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
              <span class="nx">order</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">nextOrder</span><span class="p">()</span>
            <span class="p">};</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>
        <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-rubysinatra" class="anchor" href="#rubysinatra"><span class="octicon octicon-link"></span></a>Ruby/Sinatra</h3>
<p>Now that we've defined our main models, views and collections let's get the CRUD operations required by our Backbone application supported in our Sinatra API.</p>
<p>We want to make sure that for any operations changing underlying data (create, update, delete) that our Mongo data store correctly reflects these.</p>
<h3>
      <a name="user-content-apprb" class="anchor" href="#apprb"><span class="octicon octicon-link"></span></a>app.rb</h3>
<p>For <code>app.rb</code>, we first define the dependencies required by our application. These include Sinatra, Ruby Gems, the MongoDB Ruby driver and the JSON gem.</p>
<pre><span class="nb">require</span> <span class="s1">'rubygems'</span>
      <span class="nb">require</span> <span class="s1">'sinatra'</span>
      <span class="nb">require</span> <span class="s1">'mongo'</span>
      <span class="nb">require</span> <span class="s1">'json'</span>
      </pre>
<p>Next, we create a new connection to Mongo, specifying any custom configuration desired. If running a multi-threaded application, setting the 'pool_size' allows us to specify a maximum pool size and 'timeout' a maximum timeout for waiting for old connections to be released to the pool.</p>
<pre><span class="no">DB</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s1">'mydb'</span><span class="p">,</span> <span class="ss">:pool_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span>
      </pre>
<p>Finally we define the routes to be supported by our API. Note that in the first two blocks - one for our
      application root (<code>/</code>) and the other for our todo items route <code>/todo</code> - we're using Haml for template rendering.</p>
<pre><span class="k">class</span> <span class="nc">TodoApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>

          <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'hello'</span><span class="p">}</span>
          <span class="k">end</span>

          <span class="n">get</span> <span class="s1">'/todo'</span> <span class="k">do</span>
            <span class="n">haml</span> <span class="ss">:todo</span><span class="p">,</span> <span class="ss">:attr_wrapper</span> <span class="o">=&gt;</span> <span class="s1">'"'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">'Our Sinatra Todo app'</span><span class="p">}</span>
          <span class="k">end</span>
      </pre>
<p><code>haml :index</code> instructs Sinatra to use the <code>views/index.haml</code> for the application index, whilst <code>attr_wrapper</code> is simply defining the values to be used for any local variables defined inside the template.
      This similarly applies Todo items with the template `views/todo.haml'.</p>
<p>The rest of our routes make use of the <code>params</code> hash and a number of useful helper methods included with the MongoDB Ruby driver. For more details on these, please
      read the comments I've made inline below:</p>
<pre><span class="n">get</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># query a collection :thing, convert the output to an array, map the _id</span>
        <span class="c1"># to a string representation of the object's _id and finally output to JSON</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">from_bson_id</span><span class="p">(</span><span class="n">t</span><span class="p">)}</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">get</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># get the first document with the id :id in the collection :thing as a single document (rather</span>
        <span class="c1"># than a Cursor, the standard output) using find_one(). Our bson utilities assist with</span>
        <span class="c1"># ID conversion and the final output returned is also JSON</span>
        <span class="n">from_bson_id</span><span class="p">(</span><span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)))</span><span class="o">.</span><span class="n">to_json</span>
      <span class="k">end</span>

      <span class="n">post</span> <span class="s1">'/api/:thing'</span> <span class="k">do</span>
        <span class="c1"># parse the post body of the content being posted, convert to a string, insert into</span>
        <span class="c1"># the collection #thing and return the ObjectId as a string for reference</span>
        <span class="n">oid</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">))</span>
        <span class="s2">"{</span><span class="se">\"</span><span class="s2">_id</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="si">#{</span><span class="n">oid</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="se">\"</span><span class="s2">}"</span>
      <span class="k">end</span>

      <span class="n">delete</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># remove the item with id :id from the collection :thing, based on the bson</span>
        <span class="c1"># representation of the object id</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">put</span> <span class="s1">'/api/:thing/:id'</span> <span class="k">do</span>
        <span class="c1"># collection.update() when used with $set (as covered earlier) allows us to set single values</span>
        <span class="c1"># in this case, the put request body is converted to a string, rejecting keys with the name '_id' for security purposes</span>
        <span class="no">DB</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:thing</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">to_bson_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)},</span> <span class="p">{</span><span class="s1">'$set'</span> <span class="o">=&gt;</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">reject</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">'_id'</span><span class="p">}})</span>
      <span class="k">end</span>

      <span class="c1"># utilities for generating/converting MongoDB ObjectIds</span>
      <span class="k">def</span> <span class="nf">to_bson_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="no">BSON</span><span class="o">::</span><span class="no">ObjectId</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">end</span>
      <span class="k">def</span> <span class="nf">from_bson_id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="n">obj</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="n">obj</span><span class="o">[</span><span class="s1">'_id'</span><span class="o">].</span><span class="n">to_s</span><span class="p">})</span> <span class="k">end</span>

      <span class="k">end</span>
      </pre>
<p>That's it. The above is extremely lean for an entire API, but does allow us to read and write data to support the functionality required by our client-side application.</p>
<p>For more on what MongoDB and the MongoDB Ruby driver are capable of, please do feel free to read their documentation for more information.</p>
<p>If you're a developer wishing to take this example further, why not try to add some additional capabilities to the service:</p>
<ul>
<li>Validation: improved validation of data in the API. What more could be done to ensure data sanitization?</li>
      <li>Search: search or filter down Todo items based on a set of keywords or within a certain date range</li>
      <li>Pagination: only return the Nth number of Todo items or items from a start and end-point</li>
      </ul>
<h3>
      <a name="user-content-hamltemplates" class="anchor" href="#hamltemplates"><span class="octicon octicon-link"></span></a>Haml/Templates</h3>
<p>Finally, we move on to the Haml files that define our application index (layout.haml) and the template for a specific Todo item (todo.haml). Both of these are largely self-explanatory, but it's useful to see the differences between the Jade approach we reviewed in the last chapter vs. using Haml for this implementation.</p>
<p>Note: In our Haml snippets below, the forward slash character is used to indicate a comment. When this character is placed at the beginning of a line, it wraps all of the text after it into a HTML comment. e.g</p>
<p><code>/ These are templates</code></p>
<p>compiles to:</p>
<p><code>&lt;!-- These are templates --&gt;</code></p>
<h3>
      <a name="user-content-indexhaml" class="anchor" href="#indexhaml"><span class="octicon octicon-link"></span></a>index.haml</h3>
<pre>%head
        %meta{'charset' =&gt; 'utf-8'}/
        %title=title
        %meta{'name' =&gt; 'description', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'author', 'content' =&gt; ''}/
        %meta{'name' =&gt; 'viewport', 'content' =&gt; 'width=device-width,initial-scale=1'}/

        / CSS concatenated and minified via ant build script
        %link{'rel' =&gt; 'stylesheet', 'href' =&gt; 'css/style.css'}/
        / end CSS

        %script{'src' =&gt; 'js/libs/modernizr.min.js'}
      %body
        %div#container
          %header
          %div#main
            = yield
          %footer
        /! end of #container

        %script{'src' =&gt; 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'}

        / scripts concatenated and minified via ant build script
        %script{'src' =&gt; 'js/mylibs/underscore.js'}
        %script{'src' =&gt; 'js/mylibs/backbone.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/plugins.js'}
        %script{'defer' =&gt; true, 'src' =&gt; 'js/script.js'}
        / end scripts
      </pre>
<h3>
      <a name="user-content-todohaml" class="anchor" href="#todohaml"><span class="octicon octicon-link"></span></a>todo.haml</h3>
<pre>%div#todoapp
        %div.title
          %h1
            Todos
            %div.content
              %div#create-todo
                %input#new-todo{"placeholder" =&gt; "What needs to be done?", "type" =&gt; "text"}/
                %span.ui-tooltip-top{"style" =&gt; "display:none;"} Press Enter to save this task
              %div#todos
                %ul#todo-list
              %div#todo-stats

      / Templates

      %script#item-template{"type" =&gt; "text/template"}
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
        %div.display
          <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
          %div.todo-text
          %span#todo-destroy
        %div.edit
          %input.todo-input{"type" =&gt; "text", "value" =&gt;""}/
        <span class="nt">&lt;/div&gt;</span>

      %script#stats-template{"type" =&gt; "text/template"}
        <span class="err">&lt;</span>% if (total) { %&gt;
        %span.todo-count
          %span.number <span class="err">&lt;</span>%= remaining %&gt;
          %span.word <span class="err">&lt;</span>%= remaining == 1 ? 'item' : 'items' %&gt;
          left.
        <span class="err">&lt;</span>% } %&gt;
        <span class="err">&lt;</span>% if (done) { %&gt;
        %span.todo-clear
          %a{"href" =&gt; "#"}
            Clear
            %span.number-done <span class="err">&lt;</span>%= done %&gt;
            completed
            %span.word-done <span class="err">&lt;</span>%= done == 1 ? 'item' : 'items' %&gt;
        <span class="err">&lt;</span>% } %&gt;
      </pre>
<h2>
      <a name="user-content-conclusions-2" class="anchor" href="#conclusions-2"><span class="octicon octicon-link"></span></a>Conclusions</h2>
<p>In this chapter, we looked at creating a Backbone application backed by an API powered by Ruby, Sinatra, Haml, MongoDB and the MongoDB driver. I personally found developing APIs with Sinatra a relatively painless experience and one which I felt was
      on-par with the effort required for the Node/Express implementation of the same application.</p>
<p>This section is by no means the most comprehensive guide on building complex apps using all of the items in this particular stack. I do however hope it was an introduction sufficient enough to help you decide on what stack to try out for your next project.</p>
<h1>
      <a name="user-content-modular-development" class="anchor" href="#modular-development"><span class="octicon octicon-link"></span></a>Modular Development</h1>
<h2>
      <a name="user-content-introduction-2" class="anchor" href="#introduction-2"><span class="octicon octicon-link"></span></a>Introduction</h2>
<p>When we say an application is modular, we generally mean it's composed of a set of highly decoupled, distinct pieces of functionality stored in modules. As you probably know, loose coupling facilitates easier maintainability of apps by removing dependencies where possible. When this is implemented efficiently, its quite easy to see how changes to one part of a system may affect another.</p>
<p>Unlike some more traditional programming languages however, the current iteration of JavaScript (ECMA-262) doesn't provide developers with the means to import such modules of code in a clean, organized manner. It's one of the concerns with specifications that haven't required great thought until more recent years where the need for more organized JavaScript applications became apparent.</p>
<p>Instead, developers at present are left to fall back on variations of the module or object literal patterns. With many of these, module scripts are strung together in the DOM with namespaces being described by a single global object where it's still possible to incur naming collisions in your architecture. There's also no clean way to handle dependency management without some manual effort or third party tools.</p>
<p>Whilst native solutions to these problems will be arriving in ES Harmony, the good news is that writing modular JavaScript has never been easier and you can start doing it today.</p>
<p>In this next part of the book, we're going to look at how to use AMD modules and RequireJS for cleanly wrapping units of code in your application into manageable modules.</p>
<h2>
      <a name="user-content-organizing-modules-with-requirejs-and-amd" class="anchor" href="#organizing-modules-with-requirejs-and-amd"><span class="octicon octicon-link"></span></a>Organizing modules with RequireJS and AMD</h2>
<p>In case you haven't used it before, <a href="http://requirejs.org">RequireJS</a> is a popular script loader written by James Burke - a developer who has been quite instrumental in helping shape the AMD module format, which we'll discuss more shortly. Some of RequireJS's capabilities include helping to load multiple script files, helping define modules with or without dependencies and loading in non-script dependencies such as text files.</p>
<p>So, why use RequireJS with Backbone? Although Backbone is excellent when it comes to providing a sanitary structure to your applications, there are a few key areas where some additional help could be used:</p>
<p>1) Backbone doesn't endorse a particular approach to modular-development. Although this means it's quite open-ended for developers to opt for classical patterns like the module-pattern or Object Literals for structuring their apps (which both work fine), it also means developers aren't sure of what works best when other concerns come into play, such as dependency management.</p>
<p>RequireJS is compatible with the AMD (Asynchronous Module Definition) format, a format which was born from a desire to write something better than the 'write lots of script tags with implicit dependencies and manage them manually' approach to development. In addition to allowing you to clearly declare dependencies, AMD works well in the browser, supports string IDs for dependencies, declaring multiple modules in the same file and gives you easy-to-use tools to avoid polluting the global namespace.</p>
<p>2) Let's discuss dependency management a little more as it can actually be quite challenging to get right if you're doing it by hand. When we write modules in JavaScript, we ideally want to be able to handle the reuse of code units intelligently and sometimes this will mean pulling in other modules at run-time whilst at other times you may want to do this dynamically to avoid a large pay-load when the user first hits your application.</p>
<p>Think about the GMail web-client for a moment. When users initially load up the page on their first visit, Google can simply hide widgets such as the chat module until a user has indicated (by clicking 'expand') that they wish to use it. Through dynamic dependency loading, Google could load up the chat module only then, rather than forcing all users to load it when the page first initializes. This can improve performance and load times and can definitely prove useful when building larger applications.</p>
<p>I've previously written <a href="http://addyosmani.com/writing-modular-js">a detailed article</a> covering both AMD and other module formats and script loaders in case you'd like to explore this topic further. The takeaway is that although it's perfectly fine to develop applications without a script loader or clean module format in place, it can be of significant benefit to consider using these tools in your application development.</p>
<h3>
      <a name="user-content-writing-amd-modules-with-requirejs" class="anchor" href="#writing-amd-modules-with-requirejs"><span class="octicon octicon-link"></span></a>Writing AMD modules with RequireJS</h3>
<p>As discussed above, the overall goal for the AMD format is to provide a solution for modular JavaScript that developers can use today. The two key concepts you need to be aware of when using it with a script-loader are a <code>define()</code> method for facilitating module definition and a <code>require()</code> method for handling dependency loading. <code>define()</code> is used to define named or unnamed modules based on the proposal using the following signature:</p>
<pre><span class="nx">define</span><span class="p">(</span>
          <span class="nx">module_id</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="p">[</span><span class="nx">dependencies</span><span class="p">]</span> <span class="cm">/*optional*/</span><span class="p">,</span>
          <span class="nx">definition</span> <span class="kd">function</span> <span class="cm">/*function for instantiating the module or object*/</span>
      <span class="p">);</span>
      </pre>
<p>As you can tell by the inline comments, the <code>module_id</code> is an optional argument which is typically only required when non-AMD concatenation tools are being used (there may be some other edge cases where it's useful too). When this argument is left out, we call the module 'anonymous'. When working with anonymous modules, the idea of a module's identity is DRY, making it trivial to avoid duplication of filenames and code.</p>
<p>Back to the define signature, the dependencies argument represents an array of dependencies which are required by the module you are defining and the third argument ('definition function') is a function that's executed to instantiate your module. A barebone module (compatible with RequireJS) could be defined using <code>define()</code> as follows:</p>
<pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span>
          <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are mapped to function parameters</span>
          <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-alternate-syntax" class="anchor" href="#alternate-syntax"><span class="octicon octicon-link"></span></a>Alternate syntax</h4>
<p>There is also a <a href="http://requirejs.org/docs/whyamd.html#sugar">sugared version</a> of <code>define()</code> available that allows you to declare your dependencies as local variables using <code>require()</code>. This will feel familiar to anyone who's used node, and can be easier to add or remove dependencies.
      Here is the previous snippet using the alternate syntax:</p>
<pre><span class="c1">// A module ID has been omitted here to make the module anonymous</span>

      <span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">){</span>
              <span class="c1">// module definition function</span>
          <span class="c1">// dependencies (foo and bar) are defined as local vars</span>
          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">),</span>
              <span class="nx">bar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">);</span>

              <span class="c1">// return a value that defines the module export</span>
              <span class="c1">// (i.e the functionality we want to expose for consumption)</span>

              <span class="c1">// create your module here</span>
              <span class="kd">var</span> <span class="nx">myModule</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="nx">doStuff</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
                      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Yay! Stuff'</span><span class="p">);</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">return</span> <span class="nx">myModule</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>The <code>require()</code> method is typically used to load code in a top-level JavaScript file or within a module should you wish to dynamically fetch dependencies. An example of its usage is:</p>
<pre><span class="c1">// Consider 'foo' and 'bar' are two external modules</span>
      <span class="c1">// In this example, the 'exports' from the two modules loaded are passed as</span>
      <span class="c1">// function arguments to the callback (foo and bar)</span>
      <span class="c1">// so that they can similarly be accessed</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// rest of your code here</span>
              <span class="nx">foo</span><span class="p">.</span><span class="nx">doSomething</span><span class="p">();</span>
      <span class="p">});</span>
      </pre>
<p><strong>Wrapping modules, views and other components with AMD</strong></p>
<p>Now that we've taken a look at how to define AMD modules, let's review how to go about wrapping components like views and collections so that they can also be easily loaded as dependencies for any parts of your application that require them. At it's simplest, a Backbone model may just require Backbone and Underscore.js. These are considered its dependencies and so, to write an AMD model module, we would simply do this:</p>
<pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'hello world'</span><span class="p">,</span>
          <span class="p">},</span>

          <span class="c1">// A dummy initialization method</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">myModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>Note how we alias Underscore.js's instance to <code>_</code> and Backbone to just <code>Backbone</code>, making it very trivial to convert non-AMD code over to using this module format. For a view which might require other dependencies such as jQuery, this can similarly be done as follows:</p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/mycollection'</span><span class="p">,</span>
        <span class="s1">'views/myview'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">myCollection</span><span class="p">,</span> <span class="nx">myView</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="p">...</span>
      </pre>
<p>Aliasing to the dollar-sign (<code>$</code>), once again makes it very easy to encapsulate any part of an application you wish using AMD.</p>
<h2>
      <a name="user-content-keeping-your-templates-external-using-requirejs-and-the-text-plugin" class="anchor" href="#keeping-your-templates-external-using-requirejs-and-the-text-plugin"><span class="octicon octicon-link"></span></a>Keeping Your Templates External Using RequireJS And The Text Plugin</h2>
<p>Moving your [Underscore/Mustache/Handlebars] templates to external files is actually quite straight-forward. As this application makes use of RequireJS, I'll discuss how to implement external templates using this specific script loader.</p>
<p>RequireJS has a special plugin called text.js which is used to load in text file dependencies. To use the text plugin, simply follow these simple steps:</p>
<ol>
<li><p>Download the plugin from <a href="http://requirejs.org/docs/download.html#text">http://requirejs.org/docs/download.html#text</a> and place it in either the same directory as your application's main JS file or a suitable sub-directory.</p></li>
      <li><p>Next, include the text.js plugin in your initial RequireJS configuration options. In the code snippet below, we assume that RequireJS is being included in our page prior to this code snippet being executed. Any of the other scripts being loaded are just there for the sake of example.</p></li>
      </ol>
<pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span> <span class="p">{</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="s1">'backbone'</span><span class="o">:</span>         <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'text'</span><span class="o">:</span>             <span class="s1">'libs/require/text'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'app'</span>
      <span class="p">}</span> <span class="p">);</span>
      </pre>
<ol>
<li>When the <code>text!</code> prefix is used for a dependency, RequireJS will automatically load the text plugin and treat the dependency as a text resource. A typical example of this in action may look like..</li>
      </ol>
<pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>
              <span class="c1">// the contents of the mainView file will be</span>
              <span class="c1">// loaded into mainView for usage.</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre>
<ol>
<li>Finally we can use the text resource that's been loaded for templating purposes. You're probably used to storing your HTML templates inline using a script with a specific identifier.</li>
      </ol>
<p>With Underscore.js's micro-templating (and jQuery) this would typically be:</p>
<p>HTML:</p>
<pre><code>&lt;script type="text/template" id="mainViewTemplate"&gt;
          &lt;% _.each( person, function( person_item ){ %&gt;
              &lt;li&gt;&lt;%= person_item.get('name') %&gt;&lt;/li&gt;
          &lt;% }); %&gt;
      &lt;/script&gt;
      </code></pre>
<p>JS:</p>
<pre><span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#mainViewTemplate'</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span> <span class="p">);</span>
      </pre>
<p>With RequireJS and the text plugin however, it's as simple as saving your template into an external text file (say, <code>mainView.html</code>) and doing the following:</p>
<pre><span class="nx">require</span><span class="p">([</span><span class="s1">'js/app'</span><span class="p">,</span> <span class="s1">'text!templates/mainView.html'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mainView</span><span class="p">){</span>

              <span class="kd">var</span> <span class="nx">compiled_template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span> <span class="nx">mainView</span> <span class="p">);</span>
          <span class="p">}</span>
      <span class="p">);</span>
      </pre>
<p>That's it! Now you can apply your template to a view in Backbone with something like:</p>
<pre><span class="nx">collection</span><span class="p">.</span><span class="nx">someview</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="nx">compiled_template</span><span class="p">(</span> <span class="p">{</span> <span class="nx">results</span><span class="o">:</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">models</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      </pre>
<p>All templating solutions will have their own custom methods for handling template compilation, but if you understand the above, substituting Underscore's micro-templating for any other solution should be fairly trivial.</p>
<p><strong>Note:</strong> You may also be interested in looking at <a href="https://github.com/ZeeAgency/requirejs-tpl">RequireJS tpl</a>. It's an AMD-compatible version of the Underscore templating system that also includes support for optimization (pre-compiled templates) which can lead to better performance and no evals. I have yet to use it myself, but it comes as a recommended resource.</p>
<h2>
      <a name="user-content-optimizing-backbone-apps-for-production-with-the-requirejs-optimizer" class="anchor" href="#optimizing-backbone-apps-for-production-with-the-requirejs-optimizer"><span class="octicon octicon-link"></span></a>Optimizing Backbone apps for production with the RequireJS Optimizer</h2>
<p>As experienced developers may know, an essential final step when writing both small and large JavaScript web applications is the build process.  The majority of non-trivial apps are likely to consist of more than one or two scripts and so optimizing, minimizing and concatenating your scripts prior to pushing them to production will require your users to download a reduced number (if not just one) script file.</p>
<p>Note: If you haven't looked at build processes before and this is your first time hearing about them, you might find <a href="http://addyosmani.com/blog/client-side-build-process/">my post and screencast on this topic</a> useful.</p>
<p>With some other structural JavaScript frameworks, my recommendation would normally be to implicitly use YUI Compressor or Google's closure compiler tools, but we have a slightly more elegant method available, when it comes to Backbone if you're using RequireJS. RequireJS has a command line optimization tool called r.js which has a number of capabilities, including:</p>
<ul>
<li>Concatenating specific scripts and minifying them using external tools such as UglifyJS (which is used by default) or Google's Closure Compiler for optimal browser delivery, whilst preserving the ability to dynamically load modules</li>
      <li>Optimizing CSS and stylesheets by inlining CSS files imported using @import, stripping out comments etc.</li>
      <li>The ability to run AMD projects in both Node and Rhino (more on this later)</li>
      </ul>
<p>You'll notice that I mentioned the word 'specific' in the first bullet point. The RequireJS optimizer only concatenates module scripts that have been specified in arrays of string literals passed to top-level (i.e non-local) require and define calls. As clarified by the <a href="http://requirejs.org/docs/optimization.html">optimizer docs</a> this means that Backbone modules defined like this:</p>
<pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span><span class="s1">'backbone'</span><span class="p">,</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'collections/sample'</span><span class="p">,</span><span class="s1">'views/test'</span><span class="p">],</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span><span class="nx">Backbone</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Sample</span><span class="p">,</span> <span class="nx">Test</span><span class="p">){</span>
              <span class="c1">//...</span>
          <span class="p">});</span>
      </pre>
<p>will combine fine, however inline dependencies such as:</p>
<pre><span class="kd">var</span> <span class="nx">models</span> <span class="o">=</span> <span class="nx">someCondition</span> <span class="o">?</span> <span class="p">[</span><span class="s1">'models/ab'</span><span class="p">,</span><span class="s1">'models/ac'</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="s1">'models/ba'</span><span class="p">,</span><span class="s1">'models/bc'</span><span class="p">];</span>
      </pre>
<p>will be ignored. This is by design as it ensures that dynamic dependency/module loading can still take place even after optimization.</p>
<p>Although the RequireJS optimizer works fine in both Node and Java environments, it's strongly recommended to run it under Node as it executes significantly faster there. In my experience, it's a piece of cake to get setup with either environment, so go for whichever you feel most comfortable with.</p>
<p>To get started with r.js, grab it from the <a href="http://requirejs.org/docs/download.html#rjs">RequireJS download page</a> or <a href="http://requirejs.org/docs/optimization.html#download">through NPM</a>. Now, the RequireJS optimizer works absolutely fine for single script and CSS files, but for most cases you'll want to actually optimize an entire Backbone project. You <em>could</em> do this completely from the command-line, but a cleaner option is using build profiles.</p>
<p>Below is an example of a build file taken from the modular jQuery Mobile app referenced later in this book. A <strong>build profile</strong> (commonly named <code>app.build.js</code>) informs RequireJS to copy all of the content of <code>appDir</code> to a directory defined by <code>dir</code> (in this case <code>../release</code>). This will apply all of the necessary optimizations inside the release folder. The <code>baseUrl</code> is used to resolve the paths for your modules. It should ideally be relative to <code>appDir</code>.</p>
<p>Near the bottom of this sample file, you'll see an array called <code>modules</code>. This is where you specify the module names you wish to have optimized. In this case we're optimizing the main application called 'app', which maps to <code>appDir/app.js</code>. If we had set the <code>baseUrl</code> to 'scripts', it would be mapped to <code>appDir/scripts/app.js</code>.</p>
<pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'../release'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
             <span class="s1">'backbone'</span><span class="o">:</span>          <span class="s1">'libs/AMDbackbone-0.5.3'</span><span class="p">,</span>
              <span class="s1">'underscore'</span><span class="o">:</span>       <span class="s1">'libs/underscore-1.2.2'</span><span class="p">,</span>
              <span class="s1">'jquery'</span><span class="o">:</span>           <span class="s1">'libs/jQuery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'json2'</span><span class="o">:</span>            <span class="s1">'libs/json2'</span><span class="p">,</span>
              <span class="s1">'datepicker'</span><span class="o">:</span>       <span class="s1">'libs/jQuery.ui.datepicker'</span><span class="p">,</span>
              <span class="s1">'datepickermobile'</span><span class="o">:</span> <span class="s1">'libs/jquery.ui.datepicker.mobile'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span><span class="o">:</span>     <span class="s1">'libs/jquery.mobile-1.0'</span>
          <span class="p">},</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'app'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span>
                      <span class="c1">// If you prefer not to include certain libs exclude them here</span>
                  <span class="p">]</span>
              <span class="p">}</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre>
<p>The way the build system in r.js works is that it traverses app.js (whatever modules you've passed) and resolved dependencies, concatenating them into the final <code>release</code>(dir) folder. CSS is treated the same way.</p>
<p>The build profile is usually placed inside the 'scripts' or 'js' directory of your project. As per the docs, this file can however exist anywhere you wish, but you'll need to edit the contents of your build profile accordingly.</p>
<p>Finally, to run the build, execute the following command once inside your <code>appDir</code> or <code>appDir/scripts</code> directory:</p>
<pre><span class="nx">node</span> <span class="p">..</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">r</span><span class="p">.</span><span class="nx">js</span> <span class="o">-</span><span class="nx">o</span> <span class="nx">app</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">js</span>
      </pre>
<p>That's it. As long as you have UglifyJS/Closure tools setup correctly, r.js should be able to easily optimize your entire Backbone project in just a few key-strokes. If you would like to learn more about build profiles, James Burke has a <a href="https://github.com/jrburke/r.js/blob/master/build/example.build.js">heavily commented sample file</a> with all the possible options available.</p>
<h2>
      <a name="user-content-optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages" class="anchor" href="#optimize-and-build-a-backbonejs-javascript-application-with-requirejs-using-packages"><span class="octicon octicon-link"></span></a>Optimize and Build a Backbone.js JavaScript application with RequireJS using Packages</h2>
<p><em>Contributed by <a href="https://github.com/pixelhandler">Bill Heaton</a></em></p>
<p>When a JavaScript application is too complex or large to build in a single file, grouping the application’s components into packages allows for script dependencies to download in parallel, and facilitates only loading <strong>packaged</strong> and other modular code as the site experience requires the specific set of dependencies.</p>
<p>RequireJS, the (JavaScript) module loading library, has an <a href="http://requirejs.org/docs/optimization.html" title="RequireJS optimizer">optimizer</a> to build a JavaScript-based application and provides various options. A build profile is the recipe for your build, much like a build.xml file is used to build a project with ANT. The benefit of building with <strong>r.js</strong> not only results in speedy script loading with minified code, but also provides a way to package components of your application.</p>
<ul>
<li><a href="http://requirejs.org/docs/optimization.html#onejs" title="Optimizing one JavaScript file">Optimizing one JavaScript file</a></li>
      <li><a href="http://requirejs.org/docs/optimization.html#wholeproject" title="Optimizing a whole project">Optimizing a whole project</a></li>
      <li><a href="http://requirejs.org/docs/faq-optimization.html#priority" title="Optimizing a project in layers or packages">Optimizing a project in layers or packages</a></li>
      </ul>
<p>In a complex application, organizing code into <em>packages</em> is an attractive build strategy. The build profile in this article is based on an test application currently under development (files list below). The application framework is built with open source libraries. The main objective in this build profile is to optimize an application developed with <a href="http://documentcloud.github.com/backbone/" title="Backbone.js">Backbone.js</a> using modular code, following the <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" title="Asynchronous Module Definition (AMD) wiki page">Asynchronous Module Definition (AMD)</a> format. AMD and RequireJS provide the structure for writing modular code with dependencies. Backbone.js provides the code organization for developing models, views and collections and also interactions with a RESTful API.</p>
<p>Below is an outline of the applications file organization, followed by the build profile to build modular (or packaged) layers a JavaScript driven application.</p>
<h4>
      <a name="user-content-file-organization" class="anchor" href="#file-organization"><span class="octicon octicon-link"></span></a>File organization</h4>
<p>Assume the following directories and file organization, with app.build.js as the build profile (a sibling to both source and release directories). Note that the files in the list below named <em>section</em> can be any component of the application, e.g. <em>header</em>, <em>login</em>)</p>
<pre>.-- app.build.js
      |-- app-release
      `-- app-src
          |-- collections
          |   |-- base.js
          |   |-- sections-segments.js
          |   `-- sections.js
          |-- docs
          |   `--docco.css
          |-- models
          |   |-- base.js
          |   |-- branding.js
          |   `-- section.js
          |-- packages
          |   |-- header
          |   |   |-- models
          |   |   |   |-- nav.js
          |   |   |   `-- link.js
          |   |   |-- templates
          |   |   |   |-- branding.js
          |   |   |   |-- nav.js
          |   |   |   `-- links.js
          |   |   `-- views
          |   |       |-- nav.js
          |   |       |-- branding.js
          |   |       `-- link.js
          |   |-- header.js
          |   `-- ... more packages here e.g. cart, checkout ...
          |-- syncs
          |   |-- rest
          |   |   `-- sections.js
          |   |-- factory.js
          |   `-- localstorage.js
          |-- test
          |   |-- fixtures
          |   |   `-- sections.json
          |   |-- header
          |   |   |-- index.html
          |   |   `-- spec.js
          |   |-- lib
          |   |   `-- Jasmine
          |   |-- models
          |   |-- utils
          |   |-- global-spec.js
          |-- utils
          |   |-- ajax.js
          |   |-- baselib.js
          |   |-- debug.js
          |   |-- localstorage.js
          |   `-- shims.js
          |-- vendor
          |-- |-- backbone-min.js
          |   |-- jquery.min.js
          |   |-- jquery.mobile-1.0.min.js
          |   |-- json2.js
          |   |-- modernizr.min.js
          |   |-- mustache.js
          |   |-- require.js
          |   |-- text.js
          |   `-- underscore.js
          |-- views
          |   |-- base.js
          |   `-- collection.js
          |-- application.js
          |-- collections.js
          |-- index.html
          |-- main.js
          |-- models.js
          |-- syncs.js
          |-- utils.js
          |-- vendor.js
          `-- views.js
      </pre>
<h4>
      <a name="user-content-build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages" class="anchor" href="#build-profile-to-optimize-modular-dependencies-with-code-organized-in-packages"><span class="octicon octicon-link"></span></a>Build profile to optimize modular dependencies with code organized in packages</h4>
<p>The build profile can be organized to <a href="http://requirejs.org/docs/faq-optimization.html#priority" title="optimize modular dependencies in packages">divide parallel downloads for various sections of the application</a>.</p>
<p>This strategy demonstrated builds common or site-wide groups of (core) <em>models</em>, <em>views</em>, collections which are extended from a base.js constructor which extends the appropriate backbone method, e.g. Backbone.Model. The <em>packages</em> directory organizes code by section / responsibility, e.g. cart, checkout, etc. Notice that within the example <em>header</em> package the directory structure is similar to the app root directory file structure. A <em>package</em> (of modularized code) has dependencies from the common libraries in your application and also has specific code for the packages execution alone; other packages should not require another packages dependencies. A <em>utils</em> directory has shims, helpers, and common library code to support the application. A <em>syncs</em> directory to define persistence with your RESTful api and/or localStorage. The <em>vendor</em> libraries folder will not be built, there is no need to do so, you may decide to use a CDN (then set these paths to : <em><a href="http://requirejs.org/docs/optimization.html#empty" title="empty:">empty:</a></em>). And finally a <em>test</em> directory for <a href="http://pivotal.github.com/jasmine/" title="Jasmine is a behavior-driven development framework for testing your JavaScript code">Jasmine</a> unit test specs, which may be ignored in the build as well if you choose.</p>
<p>Also notice the there are .js files named the same as the directories, these are the files listed in the paths. these are strategic to group sets of files to build, examples follow the build profile below.</p>
<pre><span class="p">({</span>
          <span class="nx">appDir</span><span class="o">:</span> <span class="s1">'./app-src'</span><span class="p">,</span>
          <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">'./'</span><span class="p">,</span>
          <span class="nx">dir</span><span class="o">:</span> <span class="s1">'./app-build'</span><span class="p">,</span>
          <span class="nx">optimize</span><span class="o">:</span> <span class="s1">'uglify'</span><span class="p">,</span>
          <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
              <span class="c1">// will not build 3rd party code, it's already built</span>
              <span class="s1">'text'</span>         <span class="o">:</span> <span class="s1">'vendor/text'</span><span class="p">,</span>
              <span class="s1">'json2'</span>        <span class="o">:</span> <span class="s1">'vendor/json2.min'</span><span class="p">,</span>
              <span class="s1">'modernizr'</span>    <span class="o">:</span> <span class="s1">'vendor/modernizr.min'</span><span class="p">,</span>
              <span class="s1">'jquery'</span>       <span class="o">:</span> <span class="s1">'vendor/jquery-1.7.1'</span><span class="p">,</span>
              <span class="s1">'jquerymobile'</span> <span class="o">:</span> <span class="s1">'vendor/jquery.mobile.min.js'</span><span class="p">,</span>
              <span class="s1">'underscore'</span>   <span class="o">:</span> <span class="s1">'vendor/underscore'</span><span class="p">,</span>
              <span class="s1">'mustache'</span>     <span class="o">:</span> <span class="s1">'vendor/mustache'</span><span class="p">,</span>
              <span class="s1">'backbone'</span>     <span class="o">:</span> <span class="s1">'vendor/backbone'</span><span class="p">,</span>
              <span class="c1">// files that define dependencies...</span>
              <span class="c1">// ignore vendor libraries, but need a group to do so</span>
              <span class="s1">'vendor'</span>       <span class="o">:</span> <span class="s1">'vendor'</span><span class="p">,</span>
              <span class="c1">// application modules/packages these files define dependencies</span>
              <span class="c1">// and may also group modules into objects if needed to require</span>
              <span class="c1">// by groups rather than individual files</span>
              <span class="s1">'utils'</span>        <span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
              <span class="s1">'models'</span>       <span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
              <span class="s1">'views'</span>        <span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
              <span class="s1">'collections'</span>  <span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
              <span class="c1">// packages to build</span>
              <span class="s1">'header'</span>       <span class="o">:</span> <span class="s1">'packages/header'</span>
              <span class="c1">//... more packages</span>
          <span class="p">},</span>
          <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span>
              <span class="c1">// Common libraries, Utilities, Syncs, Models, Views, Collections</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'utils'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'syncs'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'models'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'views'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'collections'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">]</span>
              <span class="p">},</span>
              <span class="c1">// Packages</span>
              <span class="p">{</span>
                  <span class="nx">name</span><span class="o">:</span> <span class="s1">'header'</span><span class="p">,</span>
                  <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vendor'</span><span class="p">,</span> <span class="s1">'utils'</span><span class="p">,</span> <span class="s1">'syncs'</span><span class="p">,</span> <span class="s1">'models'</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">,</span> <span class="s1">'collections'</span><span class="p">]</span>
              <span class="p">}</span>
              <span class="c1">// ... and so much more ...</span>
          <span class="p">]</span>
      <span class="p">})</span>
      </pre>
<p>The above build profile is designed for balancing scalability and performance.</p>
<p><strong>Examples of the grouped sets of code dependencies</strong></p>
<p>The contents of the vendor.js which is not built into a package may use some <em>no conflict</em> calls as well.</p>
<pre><span class="c1">// List of vendor libraries, e.g. jQuery, Underscore, Backbone, etc.</span>
      <span class="c1">// this module is used with the r.js optimizer tool during build</span>
      <span class="c1">// @see &lt;http://requirejs.org/docs/faq-optimization.html&gt;</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">,</span> <span class="s1">'modernizr'</span><span class="p">,</span> <span class="s1">'mustache'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span>        <span class="nx">_</span><span class="p">,</span>            <span class="nx">Backbone</span><span class="p">,</span>   <span class="nx">Modernizr</span><span class="p">,</span>   <span class="nx">Mustache</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// call no conflicts so if needed you can use multiple versions of $</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
          <span class="nx">Backbone</span><span class="p">.</span><span class="nx">noConflict</span><span class="p">();</span>
      <span class="p">});</span>
      </pre>
<p>For your application common library code.</p>
<pre><span class="c1">// List of utility libraries,</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'utils/ajax'</span><span class="p">,</span> <span class="s1">'utils/baselib'</span><span class="p">,</span> <span class="s1">'utils/localstorage'</span><span class="p">,</span> <span class="s1">'utils/debug'</span><span class="p">,</span> <span class="s1">'utils/shims'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">ajax</span><span class="p">,</span>         <span class="nx">baselib</span><span class="p">,</span>         <span class="nx">localstorage</span><span class="p">,</span>         <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'ajax'</span> <span class="o">:</span> <span class="nx">ajax</span><span class="p">,</span>
              <span class="s1">'baselib'</span> <span class="o">:</span> <span class="nx">baselib</span><span class="p">,</span>
              <span class="s1">'localstorage'</span> <span class="o">:</span> <span class="nx">localstorage</span><span class="p">,</span>
              <span class="s1">'debug'</span> <span class="o">:</span> <span class="nx">debug</span>
          <span class="p">};</span>
          <span class="c1">// the shim only extend JavaScript when needed, e.g. Object.create</span>
      <span class="p">});</span>
      </pre>
<p>An example where you intend to use require the common models in another package file.</p>
<pre><span class="c1">// List of models</span>
      <span class="c1">// models in this directory are intended for site-wide usage</span>
      <span class="c1">// grouping site-wide models in this module (object)</span>
      <span class="c1">// optimizes the performance and keeps dependencies organized</span>
      <span class="c1">// when the (build) optimizer is run.</span>
      <span class="nx">define</span><span class="p">([</span> <span class="s1">'models/branding'</span><span class="p">,</span> <span class="s1">'models/section'</span> <span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">Branding</span><span class="p">,</span>          <span class="nx">Section</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="s1">'Branding'</span> <span class="o">:</span> <span class="nx">Branding</span><span class="p">,</span>
              <span class="s1">'Section'</span>  <span class="o">:</span> <span class="nx">Section</span>
          <span class="p">};</span>
      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-a-quick-note-on-code-standards" class="anchor" href="#a-quick-note-on-code-standards"><span class="octicon octicon-link"></span></a>A quick note on code standards</h4>
<p>Notice that in the above examples the parameters may begin with lower or upper case characters. The variable names uses in the parameters that begin with <em>Uppercase</em> are <em>Constructors</em> and the <em>lowercase</em> variable names are not, they may be instances created by a constructor, or perhaps an object or function that is not meant to used with <em>new</em>.</p>
<p>The convention recommended is to use Upper CamelCase for constructors and lower camelCase for others.</p>
<h4>
      <a name="user-content-common-pitfall-when-organizing-code-in-modules" class="anchor" href="#common-pitfall-when-organizing-code-in-modules"><span class="octicon octicon-link"></span></a>Common Pitfall when organizing code in modules</h4>
<p>Be careful not define circular dependencies. For example, in a common <em>models</em> package (models.js) dependencies are listed for the files in your models directory</p>
<pre><code>define([ 'models/branding', 'models/section' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section }
      </code></pre>
<p>Then when another packages requires a common model you can access the models objects returned from your common models.js file like so...</p>
<pre><code>define([ 'models', 'utils' ], function (models, utils) {
      var branding = models.branding, debug = utils.debug;
      </code></pre>
<p>Perhaps after using the model a few times you get into the habit of requiring "model". Later you need add another common model with extends a model you already defined. So the pitfall begins, you add a new model inside your models directory and add a reference this same model in the model.js:</p>
<pre><code>define([ 'models/branding', 'models/section', 'models/section-b' ], function (branding, section)
      // ...
      return { 'branding' : branding, 'section', section, 'section-b' : section-b }
      </code></pre>
<p>However in your <em>models/section-b.js</em> file you define a dependency using the model.js which returns the models in an object like so...</p>
<pre><code>define([ 'models' ], function (models, utils) {
      var section = models.section;
      </code></pre>
<p>Above is the mistake in models.js a dependency was added for models/section-b and in section-b a dependency is defined for model. The new models/section-b.js requires <em>model</em> and model.js requires <em>models/section-b.js</em> - a circular dependency. This should result in a load timeout error from RequireJS, but not tell you about the circular dependency.</p>
<p>For other common mistakes see the <a href="http://requirejs.org/docs/errors.html" title="RequireJS common errors page">COMMON ERRORS</a> page on the RequireJS site.</p>
<h4>
      <a name="user-content-executing-the-build-with-rjs" class="anchor" href="#executing-the-build-with-rjs"><span class="octicon octicon-link"></span></a>Executing the Build with r.js</h4>
<p>If you intalled r.js with Node's npm (package manager) like so...</p>
<pre><code>&gt; npm install requirejs
      </code></pre>
<p>...you can execute the build on the command line:</p>
<pre><code>&gt; r.js -o app.build.js
      </code></pre>
<h2>
      <a name="user-content-practical-building-a-modular-backbone-app-with-amd--requirejs" class="anchor" href="#practical-building-a-modular-backbone-app-with-amd--requirejs"><span class="octicon octicon-link"></span></a>Practical: Building a modular Backbone app with AMD &amp; RequireJS</h2>
<p>In this chapter, we'll look at our first practical Backbone &amp; RequireJS project - how to build a modular Todo application. The application will allow us to add new todos, edit new todos and clear todo items that have been marked as completed. For a more advanced practical, see the section on mobile Backbone development.</p>
<p>The complete code for the application can can be found in the <code>practicals/modular-todo-app</code> folder of this repo (thanks to Thomas Davis and Jérôme Gravel-Niquet). Alternatively grab a copy of my side-project <a href="https://github.com/addyosmani/todomvc">TodoMVC</a> which contains the sources to both AMD and non-AMD versions.</p>
<p><strong>Note:</strong> Thomas may be covering a practical on this exercise in more detail on <a href="http://backbonetutorials.com">backbonetutorials.com</a> at some point soon, but for this section I'll be covering what I consider the core concepts.</p>
<h3>
      <a name="user-content-overview" class="anchor" href="#overview"><span class="octicon octicon-link"></span></a>Overview</h3>
<p>Writing a 'modular' Backbone application can be a straight-forward process. There are however, some key conceptual differences to be aware of if opting to use AMD as your module format of choice:</p>
<ul>
<li>As AMD isn't a standard native to JavaScript or the browser, it's necessary to use a script loader (such as RequireJS or curl.js) in order to support defining components and modules using this module format. As we've already reviewed, there are a number of advantages to using the AMD as well as RequireJS to assist here.</li>
      <li>Models, views, controllers and routers need to be encapsulated <em>using</em> the AMD-format. This allows each component of our Backbone application to cleanly manage dependencies (e.g collections required by a view) in the same way that AMD allows non-Backbone modules to.</li>
      <li>Non-Backbone components/modules (such as utilities or application helpers) can also be encapsulated using AMD. I encourage you to try developing these modules in such a way that they can both be used and tested independent of your Backbone code as this will increase their ability to be re-used elsewhere.</li>
      </ul>
<p>Now that we've reviewed the basics, let's take a look at developing our application. For reference, the structure of our app is as follows:</p>
<pre><code>index.html
      ...js/
          main.js
          .../models
                  todo.js
          .../views
                  app.js
                  todos.js
          .../collections
                  todos.js
          .../templates
                  stats.html
                  todos.html
          ../libs
              .../backbone
              .../jquery
              .../underscore
              .../require
                      require.js
                      text.js
      ...css/
      </code></pre>
<h3>
      <a name="user-content-markup" class="anchor" href="#markup"><span class="octicon octicon-link"></span></a>Markup</h3>
<p>The markup for the application is relatively simple and consists of three primary parts: an input section for entering new todo items (<code>create-todo</code>), a list section to display existing items (which can also be edited in-place) (<code>todo-list</code>) and finally a section summarizing how many items are left to be completed (<code>todo-stats</code>).</p>
<pre><code>&lt;div id="todoapp"&gt;

            &lt;div class="content"&gt;

              &lt;div id="create-todo"&gt;
                &lt;input id="new-todo" placeholder="What needs to be done?" type="text" /&gt;
                &lt;span class="ui-tooltip-top"&gt;Press Enter to save this task&lt;/span&gt;
              &lt;/div&gt;

              &lt;div id="todos"&gt;
                &lt;ul id="todo-list"&gt;&lt;/ul&gt;
              &lt;/div&gt;

              &lt;div id="todo-stats"&gt;&lt;/div&gt;

            &lt;/div&gt;

      &lt;/div&gt;
      </code></pre>
<p>The rest of the tutorial will now focus on the JavaScript side of the practical.</p>
<h3>
      <a name="user-content-configuration-options" class="anchor" href="#configuration-options"><span class="octicon octicon-link"></span></a>Configuration options</h3>
<p>If you've read the earlier chapter on AMD, you may have noticed that explicitly needing to define each dependency a Backbone module (view, collection or other module) may require with it can get a little tedious. This can however be improved.</p>
<p>In order to simplify referencing common paths the modules in our application may use, we use a RequireJS <a href="http://requirejs.org/docs/api.html#config">configuration object</a>, which is typically defined as a top-level script file. Configuration objects have a number of useful capabilities, the most useful being mode name-mapping. Name-maps are basically a key:value pair, where the key defines the alias you wish to use for a path and the value represents the true location of the path.</p>
<p>In the code-sample below, you can see some typical examples of common name-maps which include: <code>backbone</code>, <code>underscore</code>, <code>jquery</code> and depending on your choice, the RequireJS <code>text</code> plugin, which assists with loading text assets like templates.</p>
<p><strong>main.js</strong></p>
<pre><span class="nx">require</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
        <span class="nx">baseUrl</span><span class="o">:</span><span class="s1">'../'</span><span class="p">,</span>
        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">jquery</span><span class="o">:</span> <span class="s1">'libs/jquery/jquery-min'</span><span class="p">,</span>
          <span class="nx">underscore</span><span class="o">:</span> <span class="s1">'libs/underscore/underscore-min'</span><span class="p">,</span>
          <span class="nx">backbone</span><span class="o">:</span> <span class="s1">'libs/backbone/backbone-optamd3-min'</span><span class="p">,</span>
          <span class="nx">text</span><span class="o">:</span> <span class="s1">'libs/require/text'</span>
        <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">require</span><span class="p">([</span><span class="s1">'views/app'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">AppView</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">app_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>The <code>require()</code> at the end of our main.js file is simply there so we can load and instantiate the primary view for our application (<code>views/app.js</code>). You'll commonly see both this and the configuration object included in most top-level script files for a project.</p>
<p>In addition to offering name-mapping, the configuration object can be used to define additional properties such as <code>waitSeconds</code> - the number of seconds to wait before script loading times out and <code>locale</code>, should you wish to load up i18n bundles for custom languages. The <code>baseUrl</code> is simply the path to use for module lookups.</p>
<p>For more information on configuration objects, please feel free to check out the excellent guide to them in the <a href="http://requirejs.org/docs/api.html#config">RequireJS docs</a>.</p>
<h3>
      <a name="user-content-modularizing-our-models-views-and-collections" class="anchor" href="#modularizing-our-models-views-and-collections"><span class="octicon octicon-link"></span></a>Modularizing our models, views and collections</h3>
<p>Before we dive into AMD-wrapped versions of our Backbone components, let's review a sample of a non-AMD view. The following view listens for changes to its model (a Todo item) and re-renders if a user edits the value of the item.</p>
<pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#item-template'</span><span class="p">).</span><span class="nx">html</span><span class="p">()),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre>
<p>Note how for templating the common practice of referencing a script by an ID (or other selector) and obtaining its value is used. This of course requires that the template being accessed is implicitly defined in our markup. The following is the 'embedded' version of our template being referenced above:</p>
<pre><code>&lt;script type="text/template" id="item-template"&gt;
            &lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;div class="todo-content"&gt;&lt;/div&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="" /&gt;
              &lt;/div&gt;
            &lt;/div&gt;
      &lt;/script&gt;
      </code></pre>
<p>Whilst there is nothing wrong with the template itself, once we begin to develop larger applications requiring multiple templates, including them all in our markup on page-load can quickly become both unmanageable and come with performance costs. We'll look at solving this problem in a minute.</p>
<p>Let's now take a look at the AMD-version of our view. As discussed earlier, the 'module' is wrapped using AMD's <code>define()</code> which allows us to specify the dependencies our view requires. Using the mapped paths to 'jquery' etc. simplifies referencing common dependencies and instances of dependencies are themselves mapped to local variables that we can access (e.g 'jquery' is mapped to <code>$</code>).</p>
<p><strong>views/todo.js</strong></p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'text!templates/todos.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">todosTemplate</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">//... is a list tag.</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span><span class="p">,</span>

          <span class="c1">// Cache the template function for a single item.</span>
          <span class="nx">template</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">todosTemplate</span><span class="p">),</span>

          <span class="c1">// The DOM events specific to an item.</span>
          <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click .check'</span>              <span class="o">:</span> <span class="s1">'toggleDone'</span><span class="p">,</span>
            <span class="s1">'dblclick div.todo-content'</span> <span class="o">:</span> <span class="s1">'edit'</span><span class="p">,</span>
            <span class="s1">'click span.todo-destroy'</span>   <span class="o">:</span> <span class="s1">'clear'</span><span class="p">,</span>
            <span class="s1">'keypress .todo-input'</span>      <span class="o">:</span> <span class="s1">'updateOnEnter'</span>
          <span class="p">},</span>

          <span class="c1">// The TodoView listens for changes to its model, re-rendering. Since there's</span>
          <span class="c1">// a one-to-one correspondence between a **Todo** and a **TodoView** in this</span>
          <span class="c1">// app, we set a direct reference on the model for convenience.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Re-render the contents of the todo item.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setContent</span><span class="p">();</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
          <span class="p">},</span>

          <span class="c1">// Use `jQuery.text` to set the contents of the todo item.</span>
          <span class="nx">setContent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre>
<p>From a maintenance perspective, there's nothing logically different in this version of our view, except for how we approach templating.</p>
<p>Using the RequireJS text plugin (the dependency marked <code>text</code>), we can actually store all of the contents for the template we looked at earlier in an external file (todos.html).</p>
<p><strong>templates/todos.html</strong></p>
<pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo &lt;%= done ? 'done' : '' %&gt;"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"display"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"check"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="err">&lt;%=</span> <span class="na">done</span> <span class="err">?</span> <span class="err">'</span><span class="na">checked=</span><span class="s">"checked"</span><span class="err">'</span> <span class="na">:</span> <span class="err">''</span> <span class="err">%</span><span class="nt">&gt;</span> /&gt;
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"todo-content"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"todo-destroy"</span><span class="nt">&gt;&lt;/span&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"edit"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">"todo-input"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      </pre>
<p>There's no longer a need to be concerned with IDs for the template as we can map its contents to a local variable (in this case <code>todosTemplate</code>). We then simply pass this to the Underscore.js templating function <code>_.template()</code> the same way we normally would have the value of our template script.</p>
<p>Next, let's look at how to define models as dependencies which can be pulled into collections. Here's an AMD-compatible model module, which has two default values: a <code>content</code> attribute for the content of a Todo item and a boolean <code>done</code> state, allowing us to trigger whether the item has been completed or not.</p>
<p><strong>models/todo.js</strong></p>
<pre><span class="nx">define</span><span class="p">([</span><span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'backbone'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">TodoModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default attributes for the todo.</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// Ensure that each todo created has `content`.</span>
            <span class="nx">content</span><span class="o">:</span> <span class="s1">'empty todo...'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">},</span>

          <span class="c1">// Toggle the `done` state of this todo item.</span>
          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">},</span>

          <span class="c1">// Remove this Todo from *localStorage* and delete its view.</span>
          <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">TodoModel</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>As per other types of dependencies, we can easily map our model module to a local variable (in this case <code>Todo</code>) so it can be referenced as the model to use for our <code>TodosCollection</code>. This collection also supports a simple <code>done()</code> filter for narrowing down Todo items that have been completed and a <code>remaining()</code> filter for those that are still outstanding.</p>
<p><strong>collections/todos.js</strong></p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'libs/backbone/localstorage'</span><span class="p">,</span>
        <span class="s1">'models/todo'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Store</span><span class="p">,</span> <span class="nx">Todo</span><span class="p">){</span>

          <span class="kd">var</span> <span class="nx">TodosCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Reference to this collection's model.</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

          <span class="c1">// Save all of the todo items under the `todos` namespace.</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'todos'</span><span class="p">),</span>

          <span class="c1">// Filter down the list of all todo items that are finished.</span>
          <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="c1">// Filter down the list to only todo items that are still not finished.</span>
          <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre>
<p>In addition to allowing users to add new Todo items from views (which we then insert as models in a collection), we ideally also want to be able to display how many items have been completed and how many are remaining. We've already defined filters that can provide us this information in the above collection, so let's use them in our main application view.</p>
<p><strong>views/app.js</strong></p>
<pre><span class="nx">define</span><span class="p">([</span>
        <span class="s1">'jquery'</span><span class="p">,</span>
        <span class="s1">'underscore'</span><span class="p">,</span>
        <span class="s1">'backbone'</span><span class="p">,</span>
        <span class="s1">'collections/todos'</span><span class="p">,</span>
        <span class="s1">'views/todo'</span><span class="p">,</span>
        <span class="s1">'text!templates/stats.html'</span>
        <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">,</span> <span class="nx">TodoView</span><span class="p">,</span> <span class="nx">statsTemplate</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Instead of generating a new element, bind to the existing skeleton of</span>
          <span class="c1">// the App already present in the HTML.</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">),</span>

          <span class="c1">// Our template for the line of statistics at the bottom of the app.</span>
          <span class="nx">statsTemplate</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">statsTemplate</span><span class="p">),</span>

          <span class="c1">// ...events, initialize() etc. can be seen in the complete file</span>

          <span class="c1">// Re-rendering the App just means refreshing the statistics -- the rest</span>
          <span class="c1">// of the app doesn't change.</span>
          <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
              <span class="nx">total</span><span class="o">:</span>      <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">done</span><span class="o">:</span>       <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
              <span class="nx">remaining</span><span class="o">:</span>  <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
            <span class="p">}));</span>
          <span class="p">},</span>
          <span class="p">...</span>
      </pre>
<p>Above, we map the second template for this project, <code>templates/stats.html</code> to <code>statsTemplate</code> which is used for rendering the overall <code>done</code> and <code>remaining</code> states. This works by simply passing our template the length of our overall Todos collection (<code>Todos.length</code> - the number of Todo items created so far) and similarly the length (counts) for items that have been completed (<code>Todos.done().length</code>) or are remaining (<code>Todos.remaining().length</code>).</p>
<p>The contents of our <code>statsTemplate</code> can be seen below. It's nothing too complicated, but does use ternary conditions to evaluate whether we should state there's "1 item" or "2 item<i>s</i>" in a particular state.</p>
<pre><code>&lt;% if (total) { %&gt;
              &lt;span class="todo-count"&gt;
                &lt;span class="number"&gt;&lt;%= remaining %&gt;&lt;/span&gt;
                &lt;span class="word"&gt;&lt;%= remaining == 1 ? 'item' : 'items' %&gt;&lt;/span&gt; left.
              &lt;/span&gt;
            &lt;% } %&gt;
            &lt;% if (done) { %&gt;
              &lt;span class="todo-clear"&gt;
                &lt;a href="#"&gt;
                  Clear &lt;span class="number-done"&gt;&lt;%= done %&gt;&lt;/span&gt;
                  completed &lt;span class="word-done"&gt;&lt;%= done == 1 ? 'item' : 'items' %&gt;&lt;/span&gt;
                &lt;/a&gt;
              &lt;/span&gt;
            &lt;% } %&gt;
      </code></pre>
<p>The rest of the source for the Todo app mainly consists of code for handling user and application events, but that rounds up most of the core concepts for this practical.</p>
<p>To see how everything ties together, feel free to grab the source by cloning this repo or browse it <a href="https://github.com/addyosmani/backbone-fundamentals/tree/master/practicals/modular-todo-app">online</a> to learn more. I hope you find it helpful!.</p>
<p><strong>Note:</strong> While this first practical doesn't use a build profile as outlined in the chapter on using the RequireJS optimizer, we will be using one in the section on building mobile Backbone applications.</p>
<h2>
      <a name="user-content-decoupling-backbone-with-the-mediator-and-facade-patterns" class="anchor" href="#decoupling-backbone-with-the-mediator-and-facade-patterns"><span class="octicon octicon-link"></span></a>Decoupling Backbone with the Mediator and Facade Patterns</h2>
<p>In this section we'll discuss applying some of the concepts I cover in my article on <a href="http://addyosmani.com/largescalejavascript">Large-scale JavaScript Application development</a> to Backbone.</p>
<p><em>After, you may be interested in taking a look At <a href="http://github.com/addyosmani/aura">Aura</a> - my popular widget-based Backbone.js extension framework based on many of the concepts we will be covering in this section.</em></p>
<h3>
      <a name="user-content-summary-1" class="anchor" href="#summary-1"><span class="octicon octicon-link"></span></a>Summary</h3>
<p>At a high-level, one architecture that works for such applications is something which is:</p>
<ul>
<li>
      <strong>Highly decoupled</strong>: encouraging modules to only publish and subscribe to events of interest rather than directly communicating with each other. This helps us to build applications who's units of code aren't highly tied (coupled) together and can thus be reused more easily.</li>
      <li>
      <strong>Supports module-level security</strong>: whereby modules are only able to execute behavior they've been permitted to. Application security is an area which is often overlooked in JavaScript applications, but can be quite easily implemented in a flexible manner.</li>
      <li>
      <strong>Supports failover</strong>: allowing an application continuing to function even if particular modules fail. The typical example I give of this is the GMail chat widget. Imagine being able to build applications in a way that if one widget on the page fails (e.g chat), the rest of your application (mail) can continue to function without being affected.</li>
      </ul>
<p>This is an architecture which has been implemented by a number of different companies in the past, including Yahoo! (for their modularized homepage - which Nicholas Zakas has <a href="http://www.youtube.com/watch?v=vXjVFPosQHw">spoken</a> about) and AOL for some of our upcoming projects.</p>
<p>The three design patterns that make this architecture possible are the:</p>
<ul>
<li>
      <strong>Module pattern</strong>: used for encapsulating unique blocks of code, where functions and variables can be kept either public or private. ('private' in the simulation of privacy sense, as of course don't have true privacy in JavaScript)</li>
      <li>
      <strong>Mediator pattern</strong>: used when the communication between modules may be complex, but is still well defined. If it appears a system may have too many relationships between modules in your code, it may be time to have a central point of control, which is where the pattern fits in.</li>
      <li>
      <strong>Facade pattern</strong>: used for providing a convenient higher-level interface to a larger body of code, hiding its true underlying complexity</li>
      </ul>
<p>Their specific roles in this architecture can be found below.</p>
<ul>
<li>
      <strong>Modules</strong>: There are almost two concepts of what defines a module. As AMD is being used as a module wrapper, technically each model, view and collection can be considered a module. We then have the concept of modules being distinct blocks of code outside of just MVC/MV*. For the latter, these types of 'modules' are primarily concerned with broadcasting and subscribing to events of interest rather than directly communicating with each other.They are made possible through the Mediator pattern.</li>
      <li>
      <strong>Mediator</strong>: The mediator has a varying role depending on just how you wish to implement it. In my article, I mention using it as a module manager with the ability to start and stop modules at will, however when it comes to Backbone, I feel that simplifying it down to the role of a central 'controller' that provides pub/sub capabilities should suffice. One can of course go all out in terms of building a module system that supports module starting, stopping, pausing etc, however the scope of this is outside of this chapter.</li>
      <li>
      <strong>Facade</strong>: This acts as a secure middle-layer that both abstracts an application core (Mediator) and relays messages from the modules back to the Mediator so they don't touch it directly. The Facade also performs the duty of application security guard; it checks event notifications from modules against a configuration (permissions.js, which we will look at later) to ensure requests from modules are only processed if they are permitted to execute the behavior passed.</li>
      </ul>
<h3>
      <a name="user-content-practical-2" class="anchor" href="#practical-2"><span class="octicon octicon-link"></span></a>Practical</h3>
<p>For the practical section of this chapter, we'll be extending the well-known Backbone Todo application using the three patterns mentioned above.</p>
<p>The application is broken down into AMD modules that cover everything from Backbone models through to application-level modules. The views publish events of interest to the rest of the application and modules can then subscribe to these event notifications.</p>
<p>All subscriptions from modules go through a facade (or sandbox). What this does is check against the subscriber name and the 'channel/notification' it's attempting to subscribe to. If a channel <em>doesn't</em> have permissions to be subscribed to (something established through permissions.js), the subscription isn't permitted.</p>
<p><strong>Mediator</strong></p>
<p>Found in <code>aura/mediator.js</code></p>
<p>Below is a very simple AMD-wrapped implementation of the mediator pattern, based on prior work by Ryan Florence. It accepts as its input an object, to which it attaches <code>publish()</code> and <code>subscribe()</code> methods. In a larger application, the mediator can contain additional utilities, such as handlers for initializing, starting and stopping modules, but for demonstration purposes, these two methods should work fine for our needs.</p>
<pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>

        <span class="kd">var</span> <span class="nx">channels</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">subscription</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">subscription</span><span class="p">);</span>
        <span class="p">};</span>

        <span class="nx">obj</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="k">return</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p><strong>Facade</strong></p>
<p>Found in <code>aura/facade.js</code></p>
<p>Next, we have an implementation of the facade pattern. Now the classical facade pattern applied to JavaScript would probably look a little like this:</p>
<pre><span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">_private</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">i</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span>
              <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'current value:'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">i</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
              <span class="p">},</span>
              <span class="nx">run</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'running'</span><span class="p">);</span>
              <span class="p">},</span>
              <span class="nx">jump</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jumping'</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">facade</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">val</span><span class="p">);</span>
                  <span class="nx">_private</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="nx">args</span><span class="p">.</span><span class="nx">run</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="nx">_private</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
                  <span class="p">}</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}());</span>

      <span class="nx">module</span><span class="p">.</span><span class="nx">facade</span><span class="p">({</span><span class="nx">run</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">val</span><span class="o">:</span><span class="mi">10</span><span class="p">});</span>
      <span class="c1">//outputs current value: 10, running</span>
      </pre>
<p>It's effectively a variation of the module pattern, where instead of simply returning an interface of supported methods, your API can completely hide the true implementation powering it, returning something simpler. This allows the logic being performed in the background to be as complex as necessary, whilst all the end-user experiences is a simplified API they pass options to (note how in our case, a single method abstraction is exposed). This is a beautiful way of providing APIs that can be easily consumed.</p>
<p>That said, to keep things simple, our implementation of an AMD-compatible facade will act a little more like a proxy. Modules will communicate directly through the facade to access the mediator's <code>publish()</code> and <code>subscribe()</code> methods, however, they won't as such touch the mediator directly.This enables the facade to provide application-level validation of any subscriptions and publications made.</p>
<p>It also allows us to implement a simple, but flexible, permissions checker (as seen below) which will validate subscriptions made against a permissions configuration to see whether it's permitted or not.</p>
<pre><span class="nx">define</span><span class="p">([</span> <span class="s1">'../aura/mediator'</span> <span class="p">,</span> <span class="s1">'../aura/permissions'</span> <span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">mediator</span><span class="p">,</span> <span class="nx">permissions</span><span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">facade</span> <span class="o">=</span> <span class="nx">facade</span> <span class="o">||</span> <span class="p">{};</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>

              <span class="c1">// Note: Handling permissions/security is optional here</span>
              <span class="c1">// The permissions check can be removed</span>
              <span class="c1">// to just use the mediator directly.</span>

              <span class="k">if</span><span class="p">(</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)){</span>
                  <span class="nx">mediator</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">){</span>
              <span class="nx">mediator</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span> <span class="nx">channel</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">facade</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p><strong>Permissions</strong></p>
<p>Found in <code>aura/permissions.js</code></p>
<p>In our simple permissions configuration, we support checking against subscription requests to establish whether they are allowed to clear. This enforces a flexible security layer for the application.</p>
<p>To visually see how this works, consider changing say, permissions -&gt; renderDone -&gt; todoCounter to be false. This will completely disable the application from from rendering or displaying the counts component for Todo items left (because they aren't allowed to subscribe to that event notification). The rest of the Todo app can still however be used without issue.</p>
<p>It's a very dumbed down example of the potential for application security, but imagine how powerful this might be in a large app with a significant number of visual widgets.</p>
<pre><span class="nx">define</span><span class="p">([],</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="c1">// Permissions</span>

          <span class="c1">// A permissions structure can support checking</span>
          <span class="c1">// against subscriptions prior to allowing them</span>
          <span class="c1">// to clear. This enforces a flexible security</span>
          <span class="c1">// layer for your application.</span>

          <span class="kd">var</span> <span class="nx">permissions</span> <span class="o">=</span> <span class="p">{</span>

              <span class="nx">newContentAvailable</span><span class="o">:</span> <span class="p">{</span>
                  <span class="nx">contentUpdater</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">endContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoSaver</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">beginContentEditing</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">editFocus</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">addingNewTodo</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoTooltip</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">clearContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">garbageCollector</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">renderDone</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoCounter</span><span class="o">:</span><span class="kc">true</span> <span class="c1">//switch to false to see what happens :)</span>
              <span class="p">},</span>

              <span class="nx">destroyContent</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">todoRemover</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">},</span>

              <span class="nx">createWhenEntered</span><span class="o">:</span><span class="p">{</span>
                  <span class="nx">keyboardManager</span><span class="o">:</span><span class="kc">true</span>
              <span class="p">}</span>

          <span class="p">};</span>

          <span class="nx">permissions</span><span class="p">.</span><span class="nx">validate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subscriber</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
              <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">permissions</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">subscriber</span><span class="p">];</span>
              <span class="k">return</span> <span class="nx">test</span><span class="o">===</span><span class="kc">undefined</span><span class="o">?</span> <span class="kc">false</span><span class="o">:</span> <span class="nx">test</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="k">return</span> <span class="nx">permissions</span><span class="p">;</span>

      <span class="p">});</span>
      </pre>
<p><strong>Subscribers</strong></p>
<p>Found in <code>subscribers.js</code></p>
<p>Subscriber 'modules' communicate through the facade back to the mediator and perform actions when a notification event of a particular name is published.</p>
<p>For example, when a user enters in a new piece of text for a Todo item and hits 'enter' the application publishes a notification saying two things: a) a new Todo item is available and b) the text content of the new item is X. It's then left up to the rest of the application to do with this information whatever it wishes.</p>
<p>In order to update your Backbone application to primarily use pub/sub, a lot of the work you may end up doing will be moving logic coupled inside of specific views to modules outside of it which are reactionary.</p>
<p>Take the <code>todoSaver</code> for example - its responsibility is saving new Todo items to models once the a <code>notificationName</code> called 'newContentAvailable' has fired. If you take a look at the permissions structure in the last code sample, you'll notice that 'newContentAvailable' is present there. If I wanted to prevent subscribers from being able to subscribe to this notification, I simply set it to a boolean value of <code>false</code>.</p>
<p>Again, this is a massive oversimplification of how advanced your permissions structures could get, but it's certainly one way of controlling what parts of your application can or can't be accessed by specific modules at any time.</p>
<pre><span class="nx">define</span><span class="p">([</span><span class="s1">'jquery'</span><span class="p">,</span> <span class="s1">'underscore'</span><span class="p">,</span> <span class="s1">'aura/facade'</span><span class="p">],</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">facade</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Subscription 'modules' for our views. These take the</span>
          <span class="c1">// the form facade.subscribe( subscriberName, notificationName , callBack )</span>

          <span class="c1">// Update view with latest todo content</span>
          <span class="c1">// Subscribes to: newContentAvailable</span>

          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'contentUpdater'</span><span class="p">,</span> <span class="s1">'newContentAvailable'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'content'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-input'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'blur'</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">close</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Save models when a user has finishes editing</span>
          <span class="c1">// Subscribes to: endContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoSaver'</span><span class="p">,</span><span class="s1">'endContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span>
                      <span class="nx">content</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
                  <span class="p">});</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// Delete a todo when the user no longer needs it</span>
          <span class="c1">// Subscribes to: destroyContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoRemover'</span><span class="p">,</span><span class="s1">'destroyContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                  <span class="nx">context</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">//console.log(e);</span>
              <span class="p">}</span>
          <span class="p">});</span>


          <span class="c1">// When a user is adding a new entry, display a tooltip</span>
          <span class="c1">// Subscribes to: addingNewTodo</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoTooltip'</span><span class="p">,</span><span class="s1">'addingNewTodo'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">tooltip</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.ui-tooltip-top'</span><span class="p">);</span>
              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span>
              <span class="nx">tooltip</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">();</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">)</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s1">''</span> <span class="o">||</span> <span class="nx">val</span> <span class="o">==</span> <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'placeholder'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                      <span class="nx">tooltip</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">fadeIn</span><span class="p">();</span>
                  <span class="p">};</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">tooltipTimeout</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="nx">show</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="p">});</span>


          <span class="c1">// Update editing UI on switching mode to editing content</span>
          <span class="c1">// Subscribes to: beginContentEditing</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'editFocus'</span><span class="p">,</span><span class="s1">'beginContentEditing'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
          <span class="p">});</span>


          <span class="c1">// Create a new todo entry</span>
          <span class="c1">// Subscribes to: createWhenEntered</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'keyboardManager'</span><span class="p">,</span><span class="s1">'createWhenEntered'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
              <span class="nx">todos</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">newAttributes</span><span class="p">());</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
          <span class="p">});</span>



          <span class="c1">// A Todo and remaining entry counter</span>
          <span class="c1">// Subscribes to: renderDone</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'todoCounter'</span><span class="p">,</span><span class="s1">'renderDone'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">done</span> <span class="o">=</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
              <span class="nx">context</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todo-stats'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">statsTemplate</span><span class="p">({</span>
                  <span class="nx">total</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">done</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
                  <span class="nx">remaining</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">remaining</span><span class="p">().</span><span class="nx">length</span>
              <span class="p">}));</span>
          <span class="p">});</span>


          <span class="c1">// Clear all completed todos when clearContent is dispatched</span>
          <span class="c1">// Subscribes to: clearContent</span>
          <span class="nx">facade</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'garbageCollector'</span><span class="p">,</span><span class="s1">'clearContent'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Todos</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">done</span><span class="p">(),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">todo</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
              <span class="p">});</span>
          <span class="p">});</span>


      <span class="p">});</span>
      </pre>
<p>That's it for this section. If you've been intrigued by some of the concepts covered, I encourage you to consider taking a look at my <a href="http://addyosmani.com/blog/large-scale-javascript-application-architecture/">slides</a> on Large-scale JS from the jQuery Summit or my longer post on the topic <a href="http://addyosmani.com/largescalejavascript">here</a> for more information.</p>
<h2>
      <a name="user-content-backbonemarionette" class="anchor" href="#backbonemarionette"><span class="octicon octicon-link"></span></a>Backbone.Marionette</h2>
<p><em>By Derick Bailey &amp; Addy Osmani</em></p>
<p>As we've seen, Backbone provides a great set of building blocks for our JavaScript applications. It gives us the core constructs that are needed to build small to mid-sized apps, organize jQuery DOM events, or create single page apps that support mobile devices and large scale enterprise needs. But Backbone is not a complete framework. It's a set of building blocks that leaves much of the application design, architecture and scalability to the developer, including memory management, view management and more.</p>
<p><a href="http://marionettejs.com">Backbone.Marionette</a> (or just "Marionette") provides many of the features that the non-trivial application developer needs, above what Backbone itself provides. It is a composite application library that aims to simplify the construction of large scale applications. It does this by providing a collection of common design and implementation patterns found in the applications that the creator, <a href="http://lostechies.com/derickbailey/">Derick Bailey</a>, and many other <a href="https://github.com/marionettejs/backbone.marionette/graphs/contributors">contributors</a> have been using to build Backbone apps. </p>
<p>Marionette's key benefits include:</p>
<ul>
<li>Scaling applications out with modular, event driven architecture</li>
      <li>Sensible defaults, such as using Underscore templates for view rendering</li>
      <li>Easy to modify to make it work with your application's specific needs</li>
      <li>Reducing boilerplate for views, with specialized view types</li>
      <li>Build on a modular architecture with an Application and modules that attach to it</li>
      <li>Compose your application's visuals at runtime, with Region and Layout</li>
      <li>Nested views and layouts within visual regions</li>
      <li>Built-in memory management and zombie killing in views, regions and layouts</li>
      <li>Built-in event clean up with the EventBinder</li>
      <li>Event-driven architecture with the EventAggregator</li>
      <li>Flexible, "as-needed" architecture allowing you to pick and choose what you need</li>
      <li>And much, much more</li>
      </ul>
<p>Marionette follows a similar philosophy to Backbone in that it provides a suite of components that can be used independently of each other, or used together to create a significant advantages for us as developers. But it steps above the structural components of Backbone and provides an application layer, with more than a dozen components and building blocks. </p>
<p>Marionette's components range greatly in the features they provide, but they all work together to create a composite application layer that can both reduce boilerplate code and provide a much needed application structure. Its core components include:</p>
<ul>
<li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.md"><strong>Backbone.Marionette.Application</strong></a>: An application object that starts your app via initializers, and more</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.application.module.md"><strong>Backbone.Marionette.Application.module</strong></a>: Create modules and sub-modules within the application</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.approuter.md"><strong>Backbone.Marionette.AppRouter</strong></a>: Reduce your routers to nothing more than configuration</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.view.md"><strong>Backbone.Marionette.View</strong></a>: The base View type that other Marionette views extend from (not intended to be used directly)</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.itemview.md"><strong>Backbone.Marionette.ItemView</strong></a>: A view that renders a single item</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.collectionview.md"><strong>Backbone.Marionette.CollectionView</strong></a>: A view that iterates over a collection, and renders individual <code>ItemView</code> instances for each model</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.compositeview.md"><strong>Backbone.Marionette.CompositeView</strong></a>: A collection view and item view, for rendering leaf-branch/composite model hierarchies</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.region.md"><strong>Backbone.Marionette.Region</strong></a>: Manage visual regions of your application, including display and removal of content</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.layout.md"><strong>Backbone.Marionette.Layout</strong></a>: A view that renders a layout and creates region managers to manage areas within it</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventaggregator.md"><strong>Backbone.Marionette.EventAggregator</strong></a>: An extension of Backbone.Events, to be used as an event-driven or pub-sub tool</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.eventbinder.md"><strong>Backbone.Marionette.EventBinder</strong></a>: An event binding manager, to facilitate binding and unbinding of events</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.renderer.md"><strong>Backbone.Marionette.Renderer</strong></a>: Render templates with or without data, in a consistent and common manner</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.templatecache.md"><strong>Backbone.Marionette.TemplateCache</strong></a>: Cache templates that are stored in <code>&lt;script&gt;</code> blocks, for faster subsequent access</li>
      <li>
      <a href="https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.callbacks.md"><strong>Backbone.Marionette.Callbacks</strong></a>: Manage a collection of callback methods, and execute them as needed</li>
      </ul>
<p>But like Backbone itself, you're not required to use all of Marionette's components just because you want to use some of them. You can pick and choose which features you want to use, when. This allows you to work with other Backbone frameworks and plugins very easily. It also means that you are not required to engage in an all-or-nothing migration to begin using Marionette.</p>
<h3>
      <a name="user-content-boilerplate-rendering-code" class="anchor" href="#boilerplate-rendering-code"><span class="octicon octicon-link"></span></a>Boilerplate Rendering Code</h3>
<p>Consider the code that it typically requires to render a view with Backbone and Underscore template. We need a template to render, which can be placed in the DOM directly, and we need the JavaScript that defines a view to use the template, and populate that template with data from a model.</p>
<pre><code>&lt;script type="text/html" id="my-view-template"&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;First Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= firstName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Last Name:&lt;/label&gt;
          &lt;span&gt;&lt;%= lastName %&gt;&lt;/span&gt;
        &lt;div&gt;
        &lt;div class="row"&gt;
          &lt;label&gt;Email:&lt;/label&gt;
          &lt;span&gt;&lt;%= email %&gt;&lt;/span&gt;
        &lt;div&gt;
      &lt;/script&gt;
      &lt;/pre&gt;
      </code></pre>
<pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// compile the Underscore.js template</span>
          <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#my-view-template'</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">compiledTemplate</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>

          <span class="c1">// render the template with the model data</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">compiledTemplate</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

          <span class="c1">// populate the view with the rendered html</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>Once this is in place, you need to create an instance of your view and pass your model in to it. Then you can take the view's <code>el</code> and append it to the DOM in order to display the view.</p>
<pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Derick'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Bailey'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'derickbailey@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre>
<p>This is a standard set up for defining, building, rendering, and displaying a view with Backbone. This is also what we call "boilerplate code" - code that is repeated over and over and over again, across every project and every implementation of the same functionality. It gets to be very tedious and repetitious very quickly.</p>
<p>Enter Marionette's <code>ItemView</code> - a simple way to reduce the boilerplate of defining a view.</p>
<h3>
      <a name="user-content-reducing-boilerplate-with-marionetteitemview" class="anchor" href="#reducing-boilerplate-with-marionetteitemview"><span class="octicon octicon-link"></span></a>Reducing Boilerplate With Marionette.ItemView</h3>
<p>All of Marionette's view types - with the exception of <code>Marionette.View</code> - include a built-in <code>render</code> method that handles the core rendering logic for you. By changing the <code>MyView</code> instance from <code>Backbone.View</code> then, we can take advantage of this. Instead of having to provide our own <code>render</code> method for the view, we can let Marionette render it for us. We'll still use the same Underscore.js template and rendering mechanism, but the implementation of this is hidden behind the scenes for us. Thus, we can reduce the amount of code needed for this view.</p>
<pre><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span>
      <span class="p">});</span>
      </pre>
<p>And that's it - that's all you need to get the exact same behaviour as the previous view implementation. Just replace <code>Backbone.View.extend</code> with <code>Backbone.Marionette.ItemView.extend</code>, then get rid of the <code>render</code> method. You can still create the view instance with a <code>model</code>, call the <code>render</code> method on the view instance, and display the view in the DOM the same way that we did before. But the view definition has been reduced to a single line of configuration for the template.</p>
<h3>
      <a name="user-content-memory-management" class="anchor" href="#memory-management"><span class="octicon octicon-link"></span></a>Memory Management</h3>
<p>In addition to the reduction of code needed to define a view, Marionette includes some advanced memory management in all of it's views, making the job of cleaning up a view instance and it's event handlers, easy.</p>
<p>Consider the following view implementation:</p>
<pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>If we create two instances of this view using the same variable name for both instances, and then change a value in the model, how many times will we see the alert box? </p>
<pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre>
<p>Since we're re-using the save <code>zombieView</code> variable for both instances, the first instance of the view will fall out of scope immediately after the second is created. This allows the JavaScript garbage collector to come along and clean it up, which should mean the first view instance is no longer active and no longer going to respond to the model's "change" event.</p>
<p>But when we run this code, we end up with the alert box showing up twice!</p>
<p>The problem is caused by the model event binding in the view's <code>initialize</code> method. Whenever we pass <code>this.render</code> as the callback method to the model's <code>on</code> event binding, the model itself is being given a direct reference to the view instance. Since the model is now holding a reference to the view instance, replacing the <code>zombieView</code> variable with a new view instance is not going to let the original view fall out of scope. The model still has a reference, therefore the view is still in scope. </p>
<p>Since the original view is still in scope, and the second view instance is also in scope, changing data on the model will cause both view instances to respond.</p>
<p>Fixing this is easy, though. You just need to call <code>off</code> when the view is done with it's work and ready to be closed. To do this, add a <code>close</code> method to the view.</p>
<pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>Then call <code>close</code> on the first instance when it is no longer needed, and only one view instance will remain alive.</p>
<pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@example.com'</span>
      <span class="p">});</span>

      <span class="c1">// create the first view instance</span>
      <span class="kd">var</span> <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>
      <span class="nx">zombieView</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="c1">// double-tap the zombie</span>

      <span class="c1">// create a second view instance, re-using</span>
      <span class="c1">// the same variable name to store it</span>
      <span class="nx">zombieView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZombieView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'jeremy@gmail.com'</span><span class="p">);</span>
      </pre>
<p>Now we only see once alert box when this code runs. </p>
<p>Rather than having to manually remove these event handlers, though, we can let Marionette do it for us.</p>
<pre><span class="kd">var</span> <span class="nx">ZombieView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">'#my-view-template'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// bind the model change to re-render this view</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// This alert is going to demonstrate a problem</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'We`re rendering the view'</span><span class="p">);</span>

        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>Notice in this case we are using a method called <code>bindTo</code>. This method comes from Marionette's <code>EventBinder</code> object, and is added on to all of Marionette's view types. The <code>bindTo</code> method signature is similar to that of the <code>on</code> method, with the exception of passing the object that triggers the event as the first parameter. </p>
<p>Marionette's views also provide a <code>close</code> event, in which the event bindings that are set up with the <code>bindTo</code> are automatically removed. This means we no longer need to define a <code>close</code> method directly, and when we use the <code>bindTo</code> method, we know that our events will be removed and our views will not turn in to zombies.</p>
<p>But how do we automate the call to <code>close</code> on a view, in the real application? When and where do we call that? Enter the <code>Marionette.Region</code> - an object that manages the lifecycle of an individual view.</p>
<h3>
      <a name="user-content-region-management" class="anchor" href="#region-management"><span class="octicon octicon-link"></span></a>Region Management</h3>
<p>After a view is created, it typically needs to be placed in the DOM so that it becomes visible. This is usually done with a jQuery selector and setting the <code>html()</code> of the resulting object:</p>
<pre><span class="kd">var</span> <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyModel</span><span class="p">({</span>
        <span class="nx">firstName</span><span class="o">:</span> <span class="s1">'Jeremy'</span><span class="p">,</span>
        <span class="nx">lastName</span><span class="o">:</span> <span class="s1">'Ashkenas'</span><span class="p">,</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">'jeremy@gmail.com'</span>
      <span class="p">});</span>

      <span class="kd">var</span> <span class="nx">myView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">myModel</span>
      <span class="p">})</span>

      <span class="nx">myView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

      <span class="c1">// show the view in the DOM</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#content'</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">myView</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>
      </pre>
<p>This, again, is boilerplate code. We shouldn't have to manually call <code>render</code> and manually select the DOM elements to show the view. Furthermore, this code doesn't lend itself to closing any previous view instance that might be attached to the DOM element we want to populate. And we've seen the danger of zombie views already.</p>
<p>To solve these problems, Marionette provides a <code>Region</code> object - an object that manages the lifecycle of individual views, displayed in a particular DOM element.</p>
<pre><span class="c1">// create a region instance, telling it which DOM element to manage</span>
      <span class="kd">var</span> <span class="nx">myRegion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Region</span><span class="p">({</span>
        <span class="nx">el</span><span class="o">:</span> <span class="s1">'#content'</span>
      <span class="p">});</span>

      <span class="c1">// show a view in the region</span>
      <span class="kd">var</span> <span class="nx">view1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view1</span><span class="p">);</span>

      <span class="c1">// somewhere else in the code,</span>
      <span class="c1">// show a different view</span>
      <span class="kd">var</span> <span class="nx">view2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyView</span><span class="p">({</span> <span class="cm">/* ... */</span> <span class="p">});</span>
      <span class="nx">myRegion</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">view2</span><span class="p">);</span>
      </pre>
<p>There are several things to note, here. First, we're telling the region what DOM element to manage by specifying an <code>el</code> in the region instance. Second, we're no longer calling the <code>render</code> method on our views. And lastly, we're not calling <code>close</code> on our view, either, though this is getting called for us. </p>
<p>When we use a region to manage the lifecycle of our views, and display the views in the DOM, the region itself handles these concerns. By passing a view instance in to the <code>show</code> method of the region, it will call the render method on the view for us. It will then take the resulting <code>el</code> of the view and populate the DOM element. </p>
<p>The next time we call the <code>show</code> method of the region, the region remembers that it is currently displaying a view. The region calls the <code>close</code> method on the view, removes it from the DOM, and then proceeds to run the render &amp; display code for the new view that was passed in.</p>
<p>Since the region handles calling <code>close</code> for us, and we're using the <code>bindTo</code> event binder in our view instance, we no longer have to worry about zombie views in our application.</p>
<h3>
      <a name="user-content-marionette-todo-app" class="anchor" href="#marionette-todo-app"><span class="octicon octicon-link"></span></a>Marionette Todo app</h3>
<p>Having learned about Marionette's high-level concepts, let's explore refactoring the Todo application we created in our first practical to use it. The complete code for this application can be found in Derick's TodoMVC <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">fork</a>.</p>
<p>Our final implementation will be visually and functionally equivalent to the original app, as seen below.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo0.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo0.png" alt="" style="max-width:100%;"></a></p>
<p>First, we define an application object representing our base TodoMVC app. This will contain initialisation code and define the default layout regions for our app. </p>
<p><strong>TodoMVC.js:</strong></p>
<pre><span class="kd">var</span> <span class="nx">TodoMVC</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Application</span><span class="p">();</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">addRegions</span><span class="p">({</span>
        <span class="nx">header</span> <span class="o">:</span> <span class="s1">'#header'</span><span class="p">,</span>
        <span class="nx">main</span>   <span class="o">:</span> <span class="s1">'#main'</span><span class="p">,</span>
        <span class="nx">footer</span> <span class="o">:</span> <span class="s1">'#footer'</span>
      <span class="p">});</span>

      <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'initialize:after'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="p">});</span>
      </pre>
<p>Regions are used to manage the content that's displayed within specific elements, and the <code>addRegions</code> method on the <code>TodoMVC</code> object is just a shortcut for creating <code>Region</code> objects. We supply a jQuery selector for each region to manage (e.g <code>#header</code>, <code>#main</code> and <code>#footer</code>) and then tell the region to show various Backbone views within that region.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo1.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/marionette_todo1.png" alt="" style="max-width:100%;"></a></p>
<p>Once the application object has been initialised, we call <code>Backbone.history.start()</code> to route the initial URL.</p>
<p>Next, we define our Layouts. A layout is a specialised type of view that extends from <code>Marionette.ItemView</code> directly. This means its intended to render a single template and may or may not have a model (or <code>item</code>) associated with the template.</p>
<p>One of the main differences between a Layout and an <code>ItemView</code> is that the layout contains regions. When defining a Layout, we supply it with a <code>template</code> but also the regions that the template contains. After rendering the layout, we can display other views within the layout using the regions that were defined.</p>
<p>In our TodoMVC Layout module below, we define Layouts for:</p>
<ul>
<li>Header: where we can create new Todos</li>
      <li>Footer: where we summarise how many Todos are remaining/have been completed</li>
      </ul>
<p>This captures some of the view logic that was previously in our <code>AppView</code> and <code>TodoView</code>.</p>
<p>Note that Marionette modules (such as the below) offer a simple module system which are used to create privacy and encapsulation in Marionette apps. These certainly don't have to be used however, and later on in this section we'll provide links to alternative implementations using RequireJS + AMD instead.</p>
<p><strong>TodoMVC.Layout.js:</strong></p>
<pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Layout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Layout</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Layout Header View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-header'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">input</span> <span class="o">:</span> <span class="s1">'#new-todo'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'keypress #new-todo'</span><span class="o">:</span>   <span class="s1">'onInputKeypress'</span>
          <span class="p">},</span>

          <span class="nx">onInputKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">title</span> <span class="o">:</span> <span class="nx">todoText</span>
              <span class="p">});</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Layout Footer View</span>
        <span class="c1">// ------------------</span>

        <span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-footer'</span><span class="p">,</span>

          <span class="c1">// UI bindings create cached attributes that</span>
          <span class="c1">// point to jQuery selected objects</span>
          <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">count</span>   <span class="o">:</span> <span class="s1">'#todo-count strong'</span><span class="p">,</span>
            <span class="nx">filters</span> <span class="o">:</span> <span class="s1">'#filters a'</span>
          <span class="p">},</span>

          <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'click #clear-completed'</span> <span class="o">:</span> <span class="s1">'onClearClick'</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">,</span> <span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateFilterSelection</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateCount</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">updateCount</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getActive</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">count</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">count</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">updateFilterSelection</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">filters</span>
              <span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">'[href="#'</span> <span class="o">+</span> <span class="nx">filter</span> <span class="o">+</span> <span class="s1">'"]'</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'selected'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">onClearClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">completed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getCompleted</span><span class="p">();</span>
            <span class="nx">completed</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">destroy</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">todo</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">});</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre>
<p>Next, we tackle application routing and workflow, such as controlling Layouts in the page which can be shown or hidden. </p>
<p>Marionette uses the concept of an AppRouter to simplify routing. This reduces the boilerplate for handling route events and allows routers to be configured to call methods on an object directly. We configure our AppRouter using <code>appRoutes</code>.  </p>
<p>This replaces the <code>'*filter': 'setFilter'</code> route defined in our original Workspace router, seen below:</p>
<pre>        <span class="kd">var</span> <span class="nx">Workspace</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
                      <span class="nx">routes</span><span class="o">:</span><span class="p">{</span>
                              <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'setFilter'</span>
                      <span class="p">},</span>

                      <span class="nx">setFilter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">param</span> <span class="p">)</span> <span class="p">{</span>
                              <span class="c1">// Set the current filter to be used</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">TodoFilter</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>

                              <span class="c1">// Trigger a collection reset/addAll</span>
                              <span class="nb">window</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">);</span>
                      <span class="p">}</span>
              <span class="p">});</span>
      </pre>
<p>The TodoList Controller, also found in this next code block, handles some of the remaining visibility logic originally found in <code>AppView</code> and <code>TodoView</code>, albeit using very readable Layouts.</p>
<p><strong>TodoMVC.TodoList.js:</strong></p>
<pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// TodoList Router</span>
        <span class="c1">// ---------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handle routes to show the active vs complete todo items</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">AppRouter</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">appRoutes</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s1">'*filter'</span><span class="o">:</span> <span class="s1">'filterItems'</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Controller (Mediator)</span>
        <span class="c1">// ------------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Control the workflow and logic that exists at the application</span>
        <span class="c1">// level, above the implementation detail of views and models</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>

          <span class="c1">// Start the app by showing the appropriate views</span>
          <span class="c1">// and fetching the list of todo items, if there are any</span>
          <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showHeader</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showFooter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">showTodoList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>
          <span class="p">},</span>

          <span class="nx">showHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Header</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">header</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showFooter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">footer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Layout</span><span class="p">.</span><span class="nx">Footer</span><span class="p">({</span>
              <span class="nx">collection</span><span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">});</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">footer</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="nx">footer</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">showTodoList</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todoList</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span><span class="p">({</span>
              <span class="nx">collection</span> <span class="o">:</span> <span class="nx">todoList</span>
            <span class="p">}));</span>
          <span class="p">},</span>

          <span class="c1">// Set the filter to show complete or all items</span>
          <span class="nx">filterItems</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">){</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// TodoList Initializer</span>
        <span class="c1">// --------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Get the TodoList up and running by initializing the mediator</span>
        <span class="c1">// when the the application is started, pulling in all of the</span>
        <span class="c1">// existing Todo items and displaying them.</span>

        <span class="nx">TodoList</span><span class="p">.</span><span class="nx">addInitializer</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

          <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Controller</span><span class="p">();</span>
          <span class="k">new</span> <span class="nx">TodoList</span><span class="p">.</span><span class="nx">Router</span><span class="p">({</span>
            <span class="nx">controller</span><span class="o">:</span> <span class="nx">controller</span>
          <span class="p">});</span>

          <span class="nx">controller</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

        <span class="p">});</span>

      <span class="p">});</span>

      </pre>
<h4>
      <a name="user-content-controllers-1" class="anchor" href="#controllers-1"><span class="octicon octicon-link"></span></a>Controllers</h4>
<p>In this particular app, note that Controllers don't add a great deal to the overall workflow. In general however, Marionette's philosophy on routers is that they should be an after-thought in the implementation of applications. Quite often, we'll see many bad examples of developers abusing Backbone's routing system by making it the sole controller of the entire application workflow and logic. </p>
<p>This inevitably leads to mashing every possible combination of code in to the router methods - view creation, model loading, coordinating different parts of the app, etc. Developers such as Derick views this as a violation of the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">single-responsibility principle</a> (SRP) and separation of concerns. </p>
<p>Backbone's router and history exists to deal with a specific aspect of browsers - managing the forward and back buttons. Marionette feels it should be limited to that, with the code that gets executed by the navigation being somewhere else. This allows the application to be used with or without a router. We can call a controller's "show" method from a button click, from an application event handler, or from a router, and we will end up with the same application state no matter how we called that method.</p>
<p>Derick has written extensively about his thoughts on this topic, which you can read more about on his blog:</p>
<ul>
<li><a href="http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/">http://lostechies.com/derickbailey/2011/12/27/the-responsibilities-of-the-various-pieces-of-backbone-js/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/">http://lostechies.com/derickbailey/2012/01/02/reducing-backbone-routers-to-nothing-more-than-configuration/</a></li>
      <li><a href="http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/">http://lostechies.com/derickbailey/2012/02/06/3-stages-of-a-backbone-applications-startup/</a></li>
      </ul>
<h4>
      <a name="user-content-compositeview" class="anchor" href="#compositeview"><span class="octicon octicon-link"></span></a>CompositeView</h4>
<p>We then get to defining the actual views for individual Todo items and lists of items in our TodoMVC application. For this, we make use of Marionette's <code>CompositeView</code>s. The idea behind a CompositeView is that it represents a visualisation of a composite or hierarchical structure of leaves (or nodes) and branches. </p>
<p>Think of these views as being a hierarchy of parent-child models, and recursive by default. For each item in a collection that the composite view is handling the same CompositeView type will be used to render the item. For non-recursive hierarchies, though, we are able to override the item view by defining an <code>itemView</code> attribute.</p>
<p>For our Todo List Item View, we define it as an ItemView, then our Todo List View is a CompositeView where we override the <code>itemView</code> setting and tell it to use the Todo List item View for each item in the collection. </p>
<p>TodoMVC.TodoList.Views.js</p>
<pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'TodoList.Views'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Views</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo List Item View</span>
        <span class="c1">// -------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Display an individual todo item, and respond to changes</span>
        <span class="c1">// that are made to the item, including marking completed.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span> <span class="o">=</span> <span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span> <span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>
            <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoItemView'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">edit</span> <span class="o">:</span> <span class="s1">'.edit'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click .destroy'</span> <span class="o">:</span> <span class="s1">'destroy'</span><span class="p">,</span>
              <span class="s1">'dblclick label'</span> <span class="o">:</span> <span class="s1">'onEditClick'</span><span class="p">,</span>
              <span class="s1">'keypress .edit'</span> <span class="o">:</span> <span class="s1">'onEditKeypress'</span><span class="p">,</span>
              <span class="s1">'click .toggle'</span>  <span class="o">:</span> <span class="s1">'toggle'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="s1">'change'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'active completed'</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
              <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'active'</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">destroy</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toggle</span><span class="p">().</span><span class="nx">save</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">onEditKeypress</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">ENTER_KEY</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">todoText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">edit</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

              <span class="k">if</span> <span class="p">(</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">which</span> <span class="o">===</span> <span class="nx">ENTER_KEY</span> <span class="o">&amp;&amp;</span> <span class="nx">todoText</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'title'</span><span class="p">,</span> <span class="nx">todoText</span><span class="p">).</span><span class="nx">save</span><span class="p">();</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'editing'</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Item List View</span>
        <span class="c1">// --------------</span>
        <span class="c1">//</span>
        <span class="c1">// Controls the rendering of the list of items, including the</span>
        <span class="c1">// filtering of active vs completed items for display.</span>

        <span class="nx">Views</span><span class="p">.</span><span class="nx">ListView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">template</span> <span class="o">:</span> <span class="s1">'#template-todoListCompositeView'</span><span class="p">,</span>
            <span class="nx">itemView</span> <span class="o">:</span> <span class="nx">Views</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">,</span>
            <span class="nx">itemViewContainer</span> <span class="o">:</span> <span class="s1">'#todo-list'</span><span class="p">,</span>

            <span class="nx">ui</span> <span class="o">:</span> <span class="p">{</span>
              <span class="nx">toggle</span> <span class="o">:</span> <span class="s1">'#toggle-all'</span>
            <span class="p">},</span>

            <span class="nx">events</span> <span class="o">:</span> <span class="p">{</span>
              <span class="s1">'click #toggle-all'</span> <span class="o">:</span> <span class="s1">'onToggleAllClick'</span>
            <span class="p">},</span>

            <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">bindTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="s1">'all'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span>

            <span class="nx">onRender</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
            <span class="p">},</span>

            <span class="nx">update</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">function</span> <span class="nx">reduceCompleted</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="nx">right</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span> <span class="p">}</span>
              <span class="kd">var</span> <span class="nx">allCompleted</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">reduceCompleted</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">ui</span><span class="p">.</span><span class="nx">toggle</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">'checked'</span><span class="p">,</span> <span class="nx">allCompleted</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">hide</span><span class="p">();</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">show</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">},</span>

            <span class="nx">onToggleAllClick</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">isChecked</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
                <span class="nx">todo</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="s1">'completed'</span><span class="o">:</span> <span class="nx">isChecked</span><span class="p">});</span>
              <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Application Event Handlers</span>
        <span class="c1">// --------------------------</span>
        <span class="c1">//</span>
        <span class="c1">// Handler for filtering the list of items by showing and</span>
        <span class="c1">// hiding through the use of various CSS classes</span>

        <span class="nx">App</span><span class="p">.</span><span class="nx">vent</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'todoList:filter'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">filter</span> <span class="o">=</span> <span class="nx">filter</span> <span class="o">||</span> <span class="s1">'all'</span><span class="p">;</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoapp'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'class'</span><span class="p">,</span> <span class="s1">'filter-'</span> <span class="o">+</span> <span class="nx">filter</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre>
<p>At the end of the last code block, you will also notice an event handler using <code>vent</code>. This is an event aggregator that allows us to handle <code>filterItem</code> triggers from our TodoList controller.</p>
<p>Finally, we define the model and collection for representing our Todo items. These are semantically not very different from the original versions we used in our first practical and have been re-written to better fit in with Derick's preferred style of coding.</p>
<p><strong>Todos.js:</strong></p>
<pre><span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'Todos'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Todos</span><span class="p">,</span> <span class="nx">App</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">,</span> <span class="nx">Marionette</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">_</span><span class="p">){</span>

        <span class="c1">// Todo Model</span>
        <span class="c1">// ----------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">title</span>     <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">completed</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">created</span>   <span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isNew</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'created'</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">toggle</span>  <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">,</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">());</span>
          <span class="p">},</span>

          <span class="nx">isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'completed'</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="c1">// Todo Collection</span>
        <span class="c1">// ---------------</span>

        <span class="nx">Todos</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todos</span><span class="p">.</span><span class="nx">Todo</span><span class="p">,</span>

          <span class="nx">localStorage</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LocalStorage</span><span class="p">(</span><span class="s1">'todos-backbone'</span><span class="p">),</span>

          <span class="nx">getCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">getActive</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_isCompleted</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">todo</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'created'</span><span class="p">);</span>
          <span class="p">},</span>

          <span class="nx">_isCompleted</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">isCompleted</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">});</span>

      <span class="p">});</span>

      </pre>
<p>We finally kick-start everything off in our application index file, by calling <code>start</code> on our main application object:</p>
<p>Initialisation:</p>
<pre>      <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// Start the TodoMVC app (defined in js/TodoMVC.js)</span>
              <span class="nx">TodoMVC</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="p">});</span>
      </pre>
<p>And that's it!</p>
<h3>
      <a name="user-content-is-the-marionette-implementation-of-the-todo-app-more-maintainable" class="anchor" href="#is-the-marionette-implementation-of-the-todo-app-more-maintainable"><span class="octicon octicon-link"></span></a>Is the Marionette implementation of the Todo app more maintainable?</h3>
<p>Derick feels that maintainability largely comes down to modularity, separating responsibilities (SRP and SoC) and other related patterns for keeping concerns from being mixed together. It can however be difficult to simply extract things in to separate modules for the sake of extraction, abstraction, or dividing the concept down in to it's most finite parts. </p>
<p>The Single Responsibility Principle (SRP) tells us quite the opposite - that we need to understand the context in which things change. What parts always change together, in <em>this</em> system? What parts can change independently? Without knowing this, we won't know what pieces should be broken out in to separate components and modules, vs put together in to the same module or object. </p>
<p>The way Derick organizes his apps into modules is by creating a breakdown of concepts at each level. A higher level module is a higher level of concern - an aggregation of responsibilities. Each responsibility is broken down in to an expressive API set that is implemented by lower level modules (Dependency Inversion Principle). These are coordinated through a mediator - which he typically refers to as the Controller in a module. </p>
<p>The way that Derick organizes his files also plays directly into maintainability and he has also written up posts about the importance of keeping a sane application folder structure that I recommend reading:</p>
<ul>
<li><a href="http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/">http://lostechies.com/derickbailey/2012/02/02/javascript-file-folder-structures-just-pick-one/</a></li>
      <li><a href="http://hilojs.codeplex.com/discussions/362875#post869640">http://hilojs.codeplex.com/discussions/362875#post869640</a></li>
      </ul>
<h3>
      <a name="user-content-marionette-and-flexibility" class="anchor" href="#marionette-and-flexibility"><span class="octicon octicon-link"></span></a>Marionette And Flexibility</h3>
<p>Marionette is a flexible framework, much like Backbone itself. It offers a wide variety of tools to help create and organize an application architecture on top of Backbone, but like Backbone itself, it doesn't dictate that you have to use all of it's pieces in order to use any of them. </p>
<p>The flexibility and versatility in Marionette is easiest to understand by examining three variations of TodoMVC that have been created for comparison purposes:</p>
<ul>
<li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/architecture-examples/backbone_marionette">Simple</a> - by Jarrod Oversion</li>
      <li>
      <a href="https://github.com/jsoverson/todomvc/tree/master/labs/dependency-examples/backbone_marionette_require">RequireJS</a> - also by Jarrod</li>
      <li>
      <a href="https://github.com/derickbailey/todomvc/tree/master/labs/architecture-examples/backbone_marionette_modules/js">Marionette modules</a> - by Derick Bailey</li>
      </ul>
<p><strong>The simple version</strong>: This version of TodoMVC shows some raw use of Marionette's various view types, an application object, and the event aggregator. The objects that are created are added directly to the global namespace and are fairly straightforward. This is a great example of how Marionette can be used to augment existing code without having to re-write everything around Marionette.</p>
<p><strong>The RequireJS version</strong>: Using Marionette with RequireJS helps to create a modularized application architecture - a tremendously important concept in scaling JavaScript applications. RequireJS provides a powerful set of tools that can be leveraged to great advantage, making Marionette even more flexible than it already is.</p>
<p><strong>The Marionette module version</strong>: RequireJS isn't the only way to create a modularized application architecture, though. For those that wish to build applications in modules and namespaces, Marionette provides a built-in module and namespacing structure. This example application takes the simple version of the application and re-writes it in to a namespaced application architecture, with an application controller (mediator / workflow object) that brings all of the pieces together.</p>
<p>Marionette certainly provides its share of opinions in how a Backbone application should be architected. The combination of modules, view types, event aggregator, application objects, and more, can be used to create a very powerful and flexible architecture based on these opinions. </p>
<p>But as you can see, Marionette isn't a completely rigid, "my way or the highway" framework. It provides many elements of an application foundation that can be mixed and matched with other architectural styles, such as AMD or namespacing, or provide simple augmentation to existing projects by reducing boilerplate code for rendering views. </p>
<p>This flexibility creates a much greater opportunity for Marionette to provide value to you and your projects, as it allows you to scale the use of Marionette with your application's needs.</p>
<h3>
      <a name="user-content-and-so-much-more" class="anchor" href="#and-so-much-more"><span class="octicon octicon-link"></span></a>And So Much More</h3>
<p>This is just the tip of the proverbial ice-berg for Marionette, even for the <code>ItemView</code> and <code>Region</code> objects that we've explored. There is far more functionality, more features, and more flexibility and customizability that can be put to use in both of these objects. Then we have the other dozen or so components that Marionette provides, each with their own set of behaviors built in, customization and extension points, and more. </p>
<p>To learn more about Marionette, it's components, the features they provide and how to use them, check out the Marionette documentation, links to the wiki, to the source code, the project core contributors, and much more at <a href="http://marionettejs.com">http://marionettejs.com</a>. </p>
<p> </p>
<p> </p>
<h2>
      <a name="user-content-paginating-backbonejs-requests--collections" class="anchor" href="#paginating-backbonejs-requests--collections"><span class="octicon octicon-link"></span></a>Paginating Backbone.js Requests &amp; Collections</h2>
</div>
<p class="vicinity">Pagination is a ubiquitous problem we often find ourselves needing to solve on the web. Perhaps most predominantly when working with back-end APIs and JavaScript-heavy clients which consume them.</p>
<div class="changed"><p>On this topic, we're going to go through a set of <strong>pagination components</strong> I wrote for Backbone.js, which should hopefully come in useful if you're working on applications which need to tackle this problem. They're part of an extension called <a href="http://github.com/addyosmani/backbone.paginator" class="changed_href changed">Backbone.Paginator</a>.</p></div>
<p class="vicinity">When working with a structural framework like Backbone.js, the three types of pagination we are most likely to run into are:</p>
<div class="expandable unchanged">
<p><strong>Requests to a service layer (API)</strong>- e.g query for results containing the term 'Brendan' - if 5,000 results are available only display 20 results per page (leaving us with 250 possible result pages that can be navigated to).</p>
<p>This problem actually has quite a great deal more to it, such as maintaining persistence of other URL parameters (e.g sort, query, order) which can change based on a user's search configuration in a UI. One also had to think of a clean way of hooking views up to this pagination so you can easily navigate between pages (e.g First, Last, Next, Previous, 1,2,3), manage the number of results displayed per page and so on.</p>
<p><strong>Further client-side pagination of data returned -</strong> e.g we've been returned a JSON response containing 100 results. Rather than displaying all 100 to the user, we only display 20 of these results within a navigatable UI in the browser.</p>
<p>Similar to the request problem, client-pagination has its own challenges like navigation once again (Next, Previous, 1,2,3), sorting, order, switching the number of results to display per page and so on.</p>
<p><strong>Infinite results</strong> - with services such as Facebook, the concept of numeric pagination is instead replaced with a 'Load More' or 'View More' button. Triggering this normally fetches the next 'page' of N results but rather than replacing the previous set of results loaded entirely, we simply append to them instead.</p>
<p>A request pager which simply appends results in a view rather than replacing on each new fetch is effectively an 'infinite' pager.</p>
<p><strong>Let's now take a look at exactly what we're getting out of the box:</strong></p>
<p><em>Paginator is a set of opinionated components for paginating collections of data using Backbone.js. It aims to provide both solutions for assisting with pagination of requests to a server (e.g an API) as well as pagination of single-loads of data, where we may wish to further paginate a collection of N results into M pages within a view.</em></p>
<h2>
      <a name="user-content-paginators-pieces" class="anchor" href="#paginators-pieces"><span class="octicon octicon-link"></span></a>Paginator's pieces</h2>
<p>Backbone.Paginator supports two main pagination components:</p>
<ul>
<li>
      <strong>Backbone.Paginator.requestPager</strong>: For pagination of requests between a client and a server-side API</li>
      <li>
      <strong>Backbone.Paginator.clientPager</strong>: For pagination of data returned from a server which you would like to further paginate within the UI (e.g 60 results are returned, paginate into 3 pages of 20)</li>
      </ul>
<h2>
      <a name="user-content-live-examples" class="anchor" href="#live-examples"><span class="octicon octicon-link"></span></a>Live Examples</h2>
<p>Live previews of both pagination components using the Netflix API can be found below. Fork the repository to experiment with these examples further.</p>
<ul>
<li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-request-paging/index.html">Backbone.Paginator.requestPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-client-paging/index.html">Backbone.Paginator.clientPager()</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/netflix-infinite-paging/index.html">Infinite Pagination (Backbone.Paginator.requestPager())</a></li>
      <li><a href="http://addyosmani.github.com/backbone.paginator/examples/google-diacritic/index.html">Diacritic Plugin</a></li>
      </ul>
<h2>
      <a name="user-content-paginatorrequestpager" class="anchor" href="#paginatorrequestpager"><span class="octicon octicon-link"></span></a>Paginator.requestPager</h2>
<p>In this section we're going to walkthrough actually using the requestPager.</p>
<h4>
      <a name="user-content-1-create-a-new-paginated-collection" class="anchor" href="#1-create-a-new-paginated-collection"><span class="octicon octicon-link"></span></a>1. Create a new Paginated collection</h4>
<p>First, we define a new Paginated collection using <code>Backbone.Paginator.requestPager()</code> as follows:</p>
<pre><span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">requestPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
      </pre>
<h4>
      <a name="user-content-2-set-the-model-for-the-collection-as-normal" class="anchor" href="#2-set-the-model-for-the-collection-as-normal"><span class="octicon octicon-link"></span></a>2: Set the model for the collection as normal</h4>
<p>Within our collection, we then (as normal) specify the model to be used with this collection followed by the URL (or base URL) for the service providing our data (e.g the Netflix API).</p>
<pre>        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre>
<h4>
      <a name="user-content-3-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#3-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>3. Configure the base URL and the type of the request</h4>
<p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>
<pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/Catalog/People(49446)/TitlesActedIn?'</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-4-configure-how-the-library-will-show-the-results" class="anchor" href="#4-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>4. Configure how the library will show the results</h4>
<p>We need to tell the library how many items per page would we like to see, etc...</p>
<pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-5-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#5-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>5. Configure the parameters we want to send to the server</h4>
<p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>
<pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-6-finally-configure-collectionparse-and-were-done" class="anchor" href="#6-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>6. Finally, configure Collection.parse() and we're done</h4>
<p>The last thing we need to do is configure our collection's <code>parse()</code> method. We want to ensure we're returning the correct part of our JSON response containing the data our collection will be populated with, which below is <code>response.d.results</code> (for the Netflix API).</p>
<p>You might also notice that we're setting <code>this.totalPages</code> to the total page count returned by the API. This allows us to define the maximum number of (result) pages available for the current/last request so that we can clearly display this in the UI. It also allows us to infuence whether clicking say, a 'next' button should proceed with a request or not.</p>
<pre>        <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// Be sure to change this based on how your results</span>
                  <span class="c1">// are structured (e.g d.results is Netflix specific)</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="c1">//Normally this.totalPages would equal response.d.__count</span>
                  <span class="c1">//but as this particular NetFlix request only returns a</span>
                  <span class="c1">//total count of items for the search, we divide.</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">totalPages</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">__count</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span><span class="p">);</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-convenience-methods" class="anchor" href="#convenience-methods"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>
<p>For your convenience, the following methods are made available for use in your views to interact with the <code>requestPager</code>:</p>
<ul>
<li>
      <strong>Collection.goTo( n, options )</strong> - go to a specific page</li>
      <li>
      <strong>Collection.requestNextPage( options )</strong> - go to the next page</li>
      <li>
      <strong>Collection.requestPreviousPage( options )</strong> - go to the previous page</li>
      <li>
      <strong>Collection.howManyPer( n )</strong> - set the number of items to display per page</li>
      </ul>
<p><strong>requestPager</strong> collection's methods <code>.goTo()</code>, <code>.requestNextPage()</code> and <code>.requestPreviousPage()</code> are all extension of the original <a href="http://documentcloud.github.com/backbone/#Collection-fetch">Backbone Collection.fetch() method</a>. As so, they all can take the same option object as parameter.</p>
<p>This option object can use <code>success</code> and <code>error</code> parameters to pass a function to be executed after server answer.</p>
<pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">goTo</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">}</span>
      <span class="p">});</span>
      </pre>
<p>To manage callback, you could also use the <a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHR</a> returned by these methods to manage callback.</p>
<pre><span class="nx">Collection</span>
        <span class="p">.</span><span class="nx">requestNextPage</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called is server request success</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// called if server request fail</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// do something after server request is complete</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>If you'd like to add the incoming models to the current collection, instead of replacing the collection's contents, pass <code>{add: true}</code> as an option to these methods.</p>
<pre><span class="nx">Collection</span><span class="p">.</span><span class="nx">requestPreviousPage</span><span class="p">({</span> <span class="nx">add</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-paginatorclientpager" class="anchor" href="#paginatorclientpager"><span class="octicon octicon-link"></span></a>Paginator.clientPager</h2>
<p>The <code>clientPager</code> works similar to the <code>requestPager</code>, except that our configuration values influence the pagination of data already returned at a UI-level. Whilst not shown (yet) there is also a lot more UI logic that ties in with the <code>clientPager</code>. An example of this can be seen in 'views/clientPagination.js'.</p>
<h4>
      <a name="user-content-1-create-a-new-paginated-collection-with-a-model-and-url" class="anchor" href="#1-create-a-new-paginated-collection-with-a-model-and-url"><span class="octicon octicon-link"></span></a>1. Create a new paginated collection with a model and URL</h4>
<p>As with <code>requestPager</code>, let's first create a new Paginated <code>Backbone.Paginator.clientPager</code> collection, with a model:</p>
<pre>    <span class="kd">var</span> <span class="nx">PaginatedCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
      </pre>
<h4>
      <a name="user-content-2-configure-the-base-url-and-the-type-of-the-request" class="anchor" href="#2-configure-the-base-url-and-the-type-of-the-request"><span class="octicon octicon-link"></span></a>2. Configure the base URL and the type of the request</h4>
<p>We need to set a base URL. The <code>type</code> of the request is <code>GET</code> by default, and the <code>dataType</code> is <code>jsonp</code> in order to enable cross-domain requests.</p>
<pre>    <span class="nx">paginator_core</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the type of the request (GET by default)</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>

            <span class="c1">// the type of reply (jsonp by default)</span>
            <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>

            <span class="c1">// the URL (or base URL) for the service</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://odata.netflix.com/v2/Catalog/Titles?&amp;'</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-3-configure-how-the-library-will-show-the-results" class="anchor" href="#3-configure-how-the-library-will-show-the-results"><span class="octicon octicon-link"></span></a>3. Configure how the library will show the results</h4>
<p>We need to tell the library how many items per page would we like to see, etc...</p>
<pre>    <span class="nx">paginator_ui</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the lowest page index your API allows to be accessed</span>
            <span class="nx">firstPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// which page should the paginator start from</span>
            <span class="c1">// (also, the actual page the paginator is on)</span>
            <span class="nx">currentPage</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1">// how many items per page should be shown</span>
            <span class="nx">perPage</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>

            <span class="c1">// a default number of total pages to query in case the API or</span>
            <span class="c1">// service you are using does not support providing the total</span>
            <span class="c1">// number of pages for us.</span>
            <span class="c1">// 10 as a default in case your service doesn't return the total</span>
            <span class="nx">totalPages</span><span class="o">:</span> <span class="mi">10</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-4-configure-the-parameters-we-want-to-send-to-the-server" class="anchor" href="#4-configure-the-parameters-we-want-to-send-to-the-server"><span class="octicon octicon-link"></span></a>4. Configure the parameters we want to send to the server</h4>
<p>Only the base URL won't be enough for most cases, so you can pass more parameters to the server.
      Note how you can use functions insead of hardcoded values, and you can also reffer to the values you specified in <code>paginator_ui</code>.</p>
<pre>    <span class="nx">server_api</span><span class="o">:</span> <span class="p">{</span>
            <span class="c1">// the query field in the request</span>
            <span class="s1">'$filter'</span><span class="o">:</span> <span class="s1">'substringof(\'america\',Name)'</span><span class="p">,</span>

            <span class="c1">// number of items to return per request/page</span>
            <span class="s1">'$top'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// how many results the request should skip ahead to</span>
            <span class="c1">// customize as needed. For the Netflix API, skipping ahead based on</span>
            <span class="c1">// page * number of results per page was necessary.</span>
            <span class="s1">'$skip'</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">perPage</span> <span class="p">},</span>

            <span class="c1">// field to sort by</span>
            <span class="s1">'$orderby'</span><span class="o">:</span> <span class="s1">'ReleaseYear'</span><span class="p">,</span>

            <span class="c1">// what format would you like to request results in?</span>
            <span class="s1">'$format'</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>

            <span class="c1">// custom parameters</span>
            <span class="s1">'$inlinecount'</span><span class="o">:</span> <span class="s1">'allpages'</span><span class="p">,</span>
            <span class="s1">'$callback'</span><span class="o">:</span> <span class="s1">'callback'</span>
          <span class="p">},</span>
      </pre>
<h4>
      <a name="user-content-5-finally-configure-collectionparse-and-were-done" class="anchor" href="#5-finally-configure-collectionparse-and-were-done"><span class="octicon octicon-link"></span></a>5. Finally, configure Collection.parse() and we're done</h4>
<p>And finally we have our <code>parse()</code> method, which in this case isn't concerned with the total number of result pages available on the server as we have our own total count of pages for the paginated data in the UI.</p>
<pre>    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">d</span><span class="p">.</span><span class="nx">results</span><span class="p">;</span>
                  <span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-convenience-methods-1" class="anchor" href="#convenience-methods-1"><span class="octicon octicon-link"></span></a>Convenience methods:</h4>
<p>As mentioned, your views can hook into a number of convenience methods to navigate around UI-paginated data. For <code>clientPager</code> these include:</p>
<ul>
<li>
      <strong>Collection.goTo(n)</strong> - go to a specific page</li>
      <li>
      <strong>Collection.previousPage()</strong> - go to the previous page</li>
      <li>
      <strong>Collection.nextPage()</strong> - go to the next page</li>
      <li>
      <strong>Collection.howManyPer(n)</strong> - set how many items to display per page</li>
      <li>
      <strong>Collection.setSort(sortBy, sortDirection)</strong> - update sort on the current view. Sorting will automatically detect if you're trying to sort numbers (even if they're strored as strings) and will do the right thing.</li>
      <li>
      <strong>Collection.setFilter(filterFields, filterWords)</strong> - filter the current view. Filtering supports multiple words without any specific order, so you'll basically get a full-text search ability. Also, you can pass it only one field from the model, or you can pass an array with fields and all of them will get filtered. Last option is to pass it an object containing a comparison method and rules. Currently, only <code>levenshtein</code> method is available.</li>
      </ul>
<pre>  <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">setFilter</span><span class="p">(</span>
          <span class="p">{</span><span class="s1">'Name'</span><span class="o">:</span> <span class="p">{</span><span class="nx">cmp_method</span><span class="o">:</span> <span class="s1">'levenshtein'</span><span class="p">,</span> <span class="nx">max_distance</span><span class="o">:</span> <span class="mi">7</span><span class="p">}}</span>
          <span class="p">,</span> <span class="s1">'Amreican P'</span> <span class="c1">// Note the switched 'r' and 'e', and the 'P' from 'Pie'</span>
        <span class="p">);</span>
      </pre>
<p>Also note that the levenshtein plugin should be loaded and enabled using the <code>useLevenshteinPlugin</code> variable.</p>
<p>Last but not less important: Performing Levenshtein comparison returns the <code>distance</code> between to strings. It won't let you <em>search</em> lenghty text.</p>
<p>The distance between two strings means the number of characters that should be added, removed or moved to the left or to the right so the strings get equal.</p>
<p>That means that comparing "Something" in "This is a test that could show something" will return 32, which is bigger than comparing "Something" and "ABCDEFG" (9).</p>
<p>Use levenshtein only for short texts (titles, names, etc).</p>
<ul>
<li><p><strong>Collection.doFakeFilter(filterFields, filterWords)</strong> - returns the models count after fake-applying a call to <code>Collection.setFilter</code>.</p></li>
      <li><p><strong>Collection.setFieldFilter(rules)</strong> - filter each value of each model according to <code>rules</code> that you pass as argument. Example: You have a collection of books with 'release year' and 'author'. You can filter only the books that were released between 1999 and 2003. And then you can add another <code>rule</code> that will filter those books only to authors who's name start with 'A'. Possible rules: function, required, min, max, range, minLength, maxLength, rangeLength, oneOf, equalTo, pattern.</p></li>
      </ul>
<pre>  <span class="nx">my_collection</span><span class="p">.</span><span class="nx">setFieldFilter</span><span class="p">([</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'release_year'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'range'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span><span class="nx">min</span><span class="o">:</span> <span class="s1">'1999'</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span> <span class="s1">'2003'</span><span class="p">}},</span>
          <span class="p">{</span><span class="nx">field</span><span class="o">:</span> <span class="s1">'author'</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'pattern'</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'A*'</span><span class="p">,</span> <span class="s1">'igm'</span><span class="p">)}</span>
        <span class="p">]);</span>

        <span class="c1">//Rules:</span>
        <span class="c1">//</span>
        <span class="c1">//var my_var = 'green';</span>
        <span class="c1">//</span>
        <span class="c1">//{field: 'color', type: 'equalTo', value: my_var}</span>
        <span class="c1">//{field: 'color', type: 'function', value: function(field_value){ return field_value == my_var; } }</span>
        <span class="c1">//{field: 'color', type: 'required'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'min', value: '2'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'max', value: '4'}</span>
        <span class="c1">//{field: 'number_of_colors', type: 'range', value: {min: '2', max: '4'} }</span>
        <span class="c1">//{field: 'color_name', type: 'minLength', value: '4'}</span>
        <span class="c1">//{field: 'color_name', type: 'maxLength', value: '6'}</span>
        <span class="c1">//{field: 'color_name', type: 'rangeLength', value: {min: '4', max: '6'}}</span>
        <span class="c1">//{field: 'color_name', type: 'oneOf', value: ['green', 'yellow']}</span>
        <span class="c1">//{field: 'color_name', type: 'pattern', value: new RegExp('gre*', 'ig')}</span>

      </pre>
<ul>
<li>
      <strong>Collection.doFakeFieldFilter(rules)</strong> - returns the models count after fake-applying a call to <code>Collection.setFieldFilter</code>.</li>
      </ul>
<h4>
      <a name="user-content-implementation-notes" class="anchor" href="#implementation-notes"><span class="octicon octicon-link"></span></a>Implementation notes:</h4>
<p>You can use some variables in your <code>View</code> to represent the actual state of the paginator.</p>
<p><code>totalUnfilteredRecords</code> - Contains the number of records, including all records filtered in any way. (Only available in <code>clientPager</code>)</p>
<p><code>totalRecords</code> - Contains the number of records</p>
<p><code>currentPage</code> - The actual page were the paginator is at.</p>
<p><code>perPage</code> - The number of records the paginator will show per page.</p>
<p><code>totalPages</code> - The number of total pages.</p>
<p><code>startRecord</code> - The posicion of the first record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>
<p><code>endRecord</code> - The posicion of the last record shown in the current page (eg 41 to 50 from 2000 records) (Only available in <code>clientPager</code>)</p>
<h2>
      <a name="user-content-plugins" class="anchor" href="#plugins"><span class="octicon octicon-link"></span></a>Plugins</h2>
<p><strong>Diacritic.js</strong></p>
<p>A plugin for Backbone.Paginator that replaces diacritic characters (ă,ş,ţ etc) with characters that match them most closely. This is particularly useful for filtering.</p>
<p>To enable the plugin, set <code>this.useDiacriticsPlugin</code> to true, as can be seen in the example below:</p>
<pre><span class="nx">Paginator</span><span class="p">.</span><span class="nx">clientPager</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="c1">// Default values used when sorting and/or filtering.</span>
          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">useDiacriticsPlugin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// use diacritics plugin if available</span>
          <span class="p">...</span>
      </pre>
<h1>
      <a name="user-content-mobile-applications" class="anchor" href="#mobile-applications"><span class="octicon octicon-link"></span></a>Mobile Applications</h1>
<h2>
      <a name="user-content-backbone--jquery-mobile" class="anchor" href="#backbone--jquery-mobile"><span class="octicon octicon-link"></span></a>Backbone &amp; jQuery Mobile</h2>
<h3>
      <a name="user-content-resolving-the-routing-conflicts" class="anchor" href="#resolving-the-routing-conflicts"><span class="octicon octicon-link"></span></a>Resolving the routing conflicts</h3>
<p>The first major hurdle developers typically run into when building Backbone applications with jQuery Mobile is that both frameworks have their own opinions about how to handle application navigation.</p>
<p>Backbone's routers offer an explicit way to define custom navigation routes through <code>Backbone.Router</code>, whilst jQuery Mobile encourages the use of URL hash fragments to reference separate 'pages' or views in the same document. jQuery Mobile also supports automatically pulling in external content for links through XHR calls meaning that there can be quite a lot of inter-framework confusion about what a link pointing at '#photo/id' should actually be doing.</p>
<p>Some of the solutions that have been previously proposed to work-around this problem included manually patching Backbone or jQuery Mobile. I discourage opting for these techniques as it becomes necessary to manually patch your framework builds when new releases get made upstream.</p>
<p>There's also <a href="https://github.com/azicchetti/jquerymobile-router">jQueryMobile router</a>, which tries to solve this problem differently, however I think my proposed solution is both simpler and allows both frameworks to cohabit quite peacefully without the need to extend either. What we're after is a way to prevent one framework from listening to hash changes so that we can fully rely on the other (e.g. <code>Backbone.Router</code>) to handle this for us exclusively.</p>
<p>Using jQuery Mobile this can be done by setting:</p>
<pre><span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">hashListeningEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      </pre>
<p>prior to initializing any of your other code.</p>
<p>I discovered this method looking through some jQuery Mobile commits that didn't make their way into the official docs, but am happy to see that they are now covered here <a href="http://jquerymobile.com/test/docs/api/globalconfig.html">http://jquerymobile.com/test/docs/api/globalconfig.html</a> in more detail.</p>
<p>The next question that arises is, if we're preventing jQuery Mobile from listening to URL hash changes, how can we still get the benefit of being able to navigate to other sections in a document using the built-in transitions and effects supported? Good question. This can now be solve by simply calling <code>$.mobile.changePage()</code> as follows:</p>
<pre><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">'#about'</span><span class="p">,</span>
          <span class="nx">effect</span> <span class="o">=</span> <span class="s1">'slideup'</span><span class="p">,</span>
          <span class="nx">reverse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nx">changeHash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="nx">$</span><span class="p">.</span><span class="nx">mobile</span><span class="p">.</span><span class="nx">changePage</span><span class="p">(</span> <span class="nx">url</span> <span class="p">,</span> <span class="p">{</span> <span class="nx">transition</span><span class="o">:</span> <span class="nx">effect</span><span class="p">},</span> <span class="nx">reverse</span><span class="p">,</span> <span class="nx">changeHash</span> <span class="p">);</span>
      </pre>
<p>In the above sample, <code>url</code> can refer to a URL or a hash identifier to navigate to, <code>effect</code> is simply the transition effect to animate the page in with and the final two parameters decide the direction for the transition (<code>reverse</code>) and whether or not the hash in the address bar should be updated (<code>changeHash</code>). With respect to the latter, I typically set this to false to avoid managing two sources for hash updates, but feel free to set this to true if you're comfortable doing so.</p>
<p><strong>Note:</strong> For some parallel work being done to explore how well the jQuery Mobile Router plugin works with Backbone, you may be interested in checking out <a href="https://github.com/Filirom1/jquery-mobile-backbone-requirejs">https://github.com/Filirom1/jquery-mobile-backbone-requirejs</a>.</p>
<h3>
      <a name="user-content-practical-a-backbone-requirejsamd-app-with-jquery-mobile" class="anchor" href="#practical-a-backbone-requirejsamd-app-with-jquery-mobile"><span class="octicon octicon-link"></span></a>Practical: A Backbone, Require.js/AMD app with jQuery Mobile</h3>
<p><strong>Note:</strong> The code for this practical can be found in <code>practicals/modular-mobile-app</code>.</p>
<h3>
      <a name="user-content-getting-started-2" class="anchor" href="#getting-started-2"><span class="octicon octicon-link"></span></a>Getting started</h3>
<p>Once you feel comfortable with the <a href="http://msdn.microsoft.com/en-us/scriptjunkie/hh377172.aspx">Backbone fundamentals</a> and you've put together a rough wireframe of the app you may wish to build, start to think about your application architecture. Ideally, you'll want to logically separate concerns so that it's as easy as possible to maintain the app in the future.</p>
<p><strong>Namespacing</strong></p>
<p>For this application, I opted for the nested namespacing pattern. Implemented correctly, this enables you to clearly identify if items being referenced in your app are views, other modules and so on. This initial structure is a sane place to also include application defaults (unless you prefer maintaining those in a separate file).</p>
<pre><span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mobileSearch</span> <span class="o">||</span> <span class="p">{</span>
          <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">appview</span><span class="o">:</span> <span class="k">new</span> <span class="nx">AppView</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">routers</span><span class="o">:</span><span class="p">{</span>
              <span class="nx">workspace</span><span class="o">:</span><span class="k">new</span> <span class="nx">Workspace</span><span class="p">()</span>
          <span class="p">},</span>
          <span class="nx">utils</span><span class="o">:</span> <span class="nx">utils</span><span class="p">,</span>
          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">resultsPerPage</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
              <span class="nx">safeSearch</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
              <span class="nx">maxDate</span><span class="o">:</span><span class="s1">''</span><span class="p">,</span>
              <span class="nx">minDate</span><span class="o">:</span><span class="s1">'01/01/1970'</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre>
<p><strong>Models</strong></p>
<p>In the Flickly application, there are at least two unique types of data that need to be modeled - search results and individual photos, both of which contain additional meta-data like photo titles. If you simplify this down, search results are actually groups of photos in their own right, so the application only requires:</p>
<ul>
<li>A single model (a photo or 'result' entry)</li>
      <li>A result collection (containing a group of result entries) for search results</li>
      <li>A photo collection (containing one or more result entries) for individual photos or photos with more than one image</li>
      </ul>
<p><strong>Views</strong></p>
<p>The views we'll need include an application view, a search results view and a photo view. Static views or pages of the single-page application which do not require a dynamic element to them (e.g an 'about' page) can be easily coded up in your document's markup, independent of Backbone.</p>
<p><strong>Routers</strong></p>
<p>A number of possible routes need to be taken into consideration:</p>
<ul>
<li>Basic search queries <code>#search/kiwis</code>
      </li>
      <li>Search queries with additional parameters (e.g sort, pagination) <code>#search/kiwis/srelevance/p7</code>
      </li>
      <li>Queries for specific photos <code>#photo/93839</code>
      </li>
      <li>A default route (no parameters passed)</li>
      </ul>
<p>This tutorial will be expanded shortly to fully cover the demo application. In the mean time, please see the practicals folder for the completed application that demonstrates the router resolution discussed earlier between Backbone and jQuery Mobile.</p>
<h3>
      <a name="user-content-jquery-mobile-going-beyond-mobile-application-development" class="anchor" href="#jquery-mobile-going-beyond-mobile-application-development"><span class="octicon octicon-link"></span></a>jQuery Mobile: Going beyond mobile application development</h3>
<p>The majority of jQM apps I've seen in production have been developed for the purpose of providing an optimal experience to users on mobile devices. Given that the framework was developed for this purpose, there's nothing fundamentally wrong with this, but many developers forget that jQM is a UI framework not dissimilar to jQuery UI. It's using the widget factory and is capable of being used for a lot more than we give it credit for.</p>
<p>If you open up Flickly in a desktop browser, you'll get an image search UI that's modeled on Google.com, however, review the components (buttons, text inputs, tabs) on the page for a moment. The desktop UI doesn't look anything like a mobile application yet I'm still using jQM for theming mobile components; the tabs, date-picker, sliders - everything in the desktop UI is re-using what jQM would be providing users on mobile devices. Thanks to some media queries, the desktop UI can make optimal use of whitespace, expanding component blocks out and providing alternative layouts whilst still making use of jQM as a component framework.</p>
<p>The benefit of this is that I don't need to go pulling in jQuery UI separately to be able to take advantage of these features. Thanks to the recent ThemeRoller my components can look pretty much exactly how I would like them to and users of the app can get a jQM UI for lower-resolutions and a jQM-ish UI for everything else.</p>
<p>The takeaway here is just to remember that if you're not (already) going through the hassle of conditional script/style loading based on screen-resolution (using matchMedia.js etc), there are simpler approaches that can be taken to cross-device component theming.</p>
<h1>
      <a name="user-content-unit-testing" class="anchor" href="#unit-testing"><span class="octicon octicon-link"></span></a>Unit Testing</h1>
<h2>
      <a name="user-content-unit-testing-backbone-applications-with-jasmine" class="anchor" href="#unit-testing-backbone-applications-with-jasmine"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With Jasmine</h2>
<h2>
      <a name="user-content-introduction-3" class="anchor" href="#introduction-3"><span class="octicon octicon-link"></span></a>Introduction</h2>
<p>One definition of unit testing is the process of taking the smallest piece of testable code in an application, isolating it from the remainder of your codebase and determining if it behaves exactly as expected. In this section, we'll be taking a look at how to unit test Backbone applications using a popular JavaScript testing framework called <a href="http://pivotal.github.com/jasmine/">Jasmine</a> from Pivotal Labs.</p>
<p>For an application to be considered 'well'-tested, distinct functionality should ideally have its own separate unit tests where it's tested against the different conditions you expect it to work under. All tests must pass before functionality is considered 'complete'. This allows developers to both modify a unit of code and its dependencies with a level of confidence about whether these changes have caused any breakage.</p>
<p>As a basic example of unit testing is where a developer may wish to assert whether passing specific values through to a sum function results in the correct output being returned. For an example more relevant to this book, we may wish to assert whether a user adding a new Todo item to a list correctly adds a Model of a specific type to a Todos Collection.</p>
<p>When building modern web-applications, it's typically considered best-practice to include automated unit testing as a part of your development process. Whilst we'll be focusing on Jasmine as a solution for this, there are a number of other alternatives worth considering, including QUnit.</p>
<h2>
      <a name="user-content-jasmine" class="anchor" href="#jasmine"><span class="octicon octicon-link"></span></a>Jasmine</h2>
<p>Jasmine describes itself as a behavior-driven development (BDD) framework for testing JavaScript code. Before we jump into how the framework works, it's useful to understand exactly what <a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">BDD</a> is.</p>
<p>BDD is a second-generation testing approach first described by <a href="http://dannorth.net/introducing-bdd/">Dan North</a> (the authority on BDD) which attempts to test the behavior of software. It's considered second-generation as it came out of merging ideas from Domain driven design (DDD) and lean software development, helping teams to deliver high quality software by answering many of the more confusing questions early on in the agile process. Such questions commonly include those concerning documentation and testing.</p>
<p>If you were to read a book on BDD, it's likely to also be described as being 'outside-in and pull-based'. The reason for this is that it borrows the idea of pulling features from Lean manufacturing which effectively ensures that the right software solutions are being written by a) focusing on expected outputs of the system and b) ensuring these outputs are achieved.</p>
<p>BDD recognizes that there are usually multiple stakeholders in a project and not a single amorphous user of the system. These different groups will be affected by the software being written in differing ways and will have a varying opinion of what quality in the system means to them. It's for this reason that it's important to understand who the software will be bringing value you and exactly what in it will be valuable to them.</p>
<p>Finally, BDD relies on automation. Once you've defined the quality expected, your team will likely want to check on the functionality of the solution being built regularly and compare it to the results they expect. In order to facilitate this efficiently, the process has to be automated. BDD relies heavily on the automation of specification-testing and Jasmine is a tool which can assist with this.</p>
<p>BDD helps both developers and non-technical stakeholders:</p>
<ul>
<li>Better understand and represent the models of the problems being solved</li>
      <li>Explain supported tests cases in a language that non-developers can read</li>
      <li>Focus on minimizing translation of the technical code being written and the domain language spoken by the business</li>
      </ul>
<p>What this means is that developers should be able to show Jasmine unit tests to a project stakeholder and (at a high level, thanks to a common vocabulary being used) they'll ideally be able to understand what the code supports.</p>
<p>Developers often implement BDD in unison with another testing paradigm known as <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a> (test-driven development). The main idea behind TDD is:</p>
<ul>
<li>Write unit tests which describe the functionality you would like your code to support</li>
      <li>Watch these tests fail (as the code to support them hasn't yet been written)</li>
      <li>Write code to make the tests pass</li>
      <li>Rinse, repeat and refactor</li>
      </ul>
<p>In this chapter we're going to use both BDD (with TDD) to write unit tests for a Backbone application.</p>
<p><strong><em>Note:</em></strong> I've seen a lot of developers also opt for writing tests to validate behavior of their code after having written it. While this is fine, note that it can come with pitfalls such as only testing for behavior your code currently supports, rather than behavior the problem needs to be supported.</p>
<h2>
      <a name="user-content-suites-specs--spies" class="anchor" href="#suites-specs--spies"><span class="octicon octicon-link"></span></a>Suites, Specs &amp; Spies</h2>
<p>When using Jasmine, you'll be writing suites and specifications (specs). Suites basically describe scenarios whilst specs describe what can be done in these scenarios.</p>
<p>Each spec is a JavaScript function, described with a call to <code>it()</code> using a description string and a function. The description should describe the behaviour the particular unit of code should exhibit and keeping in mind BDD, it should ideally be meaningful. Here's an example of a basic spec:</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="p">});</span>
      </pre>
<p>On its own, a spec isn't particularly useful until expectations are set about the behavior of the code. Expectations in specs are defined using the <code>expect()</code> function and an <a href="https://github.com/pivotal/jasmine/wiki/Matchers">expectation matcher</a> (e.g <code>toEqual()</code>, <code>toBeTruthy()</code>, <code>toContain()</code>). A revised example using an expectation matcher would look like:</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should be incrementing in value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>The above code passes our behavioral expectation as <code>counter</code> equals 1. Notice how easy this was to read the expectation on the last line (you probably grokked it without any explanation).</p>
<p>Specs are grouped into suites which we describe using Jasmine's <code>describe()</code> function, again passing a string as a description and a function. The name/description for your suite is typically that of the component or module you're testing.</p>
<p>Jasmine will use it as the group name when it reports the results of the specs you've asked it to run. A simple suite containing our sample spec could look like:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="p">...</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>Suites also share a functional scope and so it's possible to declare variables and functions inside a describe block which are accessible within specs:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Stats'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can increment a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 1</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'can subtract a number'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="c1">// the counter was = 2</span>
              <span class="nx">counter</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">counter</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p><strong><em>Note:</em></strong> Suites are executed in the order in which they are described, which can be useful to know if you would prefer to see test results for specific parts of your application reported first.</p>
<p>Jasmine also supports <strong>spies</strong> - a way to mock, spy and fake behavior in our unit tests. Spies replace the function they're spying on, allowing us to simulate behavior we would like to mock (i.e test free of the actual implementation).</p>
<p>In the below example, we're spying on the <code>setComplete</code> method of a dummy Todo function to test that arguments can be passed to it as expected.</p>
<pre><span class="kd">var</span> <span class="nx">Todo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="p">};</span>

      <span class="nx">Todo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
          <span class="k">return</span> <span class="nx">arg</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">describe</span><span class="p">(</span><span class="s1">'a simple spy'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">it</span><span class="p">(</span><span class="s1">'should spy on an instance method of a Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
              <span class="kd">var</span> <span class="nx">myTodo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>
              <span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">'foo bar'</span><span class="p">);</span>

              <span class="kd">var</span> <span class="nx">myTodo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
              <span class="nx">spyOn</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">,</span> <span class="s1">'setComplete'</span><span class="p">);</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">myTodo2</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>

          <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>What you're more likely to use spies for is testing <a href="http://en.wikipedia.org/wiki/Asynchronous_communication">asynchronous</a> behavior in your application such as AJAX requests. Jasmine supports:</p>
<ul>
<li>Writing tests which can mock AJAX requests using spies. This allows us to test code which runs before an AJAX request and right after. It's also possible to mock/fake responses the server can return and the benefit of this type of testing is that it's faster as no real calls are being made to a server</li>
      <li>Asynchronous tests which don't rely on spies</li>
      </ul>
<p>For the first kind of test, it's possible to both fake an AJAX request and verify that the request was both calling the correct URL and executed a callback where one was provided.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'the callback should be executed on success'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">spyOn</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s1">'ajax'</span><span class="p">).</span><span class="nx">andCallFake</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">();</span>
          <span class="p">});</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'url'</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'/todos/15'</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'' + id,</span>
      <span class="s1">        dataType: '</span><span class="nx">json</span><span class="err">'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre>
<p>If you feel lost having seen matchers like <code>andCallFake()</code> and <code>toHaveBeenCalled()</code>, don't worry. All of these are Spy-specific matchers and are documented on the Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Spies">wiki</a>.</p>
<p>For the second type of test (asynchronous tests), we can take the above further by taking advantage of three other methods Jasmine supports:</p>
<ul>
<li>runs(function) - a block which runs as if it was directly called</li>
      <li>waits(timeout) - a native timeout before the next block is run</li>
      <li>waitsFor(function, optional message, optional timeout) - a way to pause specs until some other work has completed. Jasmine waits until the supplied function returns true here before it moves on to the next block.</li>
      </ul>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'should make an actual AJAX request to a server'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">();</span>
          <span class="nx">getTodo</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

          <span class="nx">waitsFor</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">});</span>

          <span class="nx">runs</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">callback</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
          <span class="p">});</span>
      <span class="p">});</span>

      <span class="kd">function</span> <span class="nx">getTodo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">'GET'</span><span class="p">,</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'todos.json'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
          <span class="p">});</span>
      <span class="p">}</span>
      </pre>
<p><strong><em>Note:</em></strong> It's useful to remember that when making real requests to a web server in your unit tests, this has the potential to massively slow down the speed at which tests run (due to many factors including server latency). As this also introduces an external dependency that can (and should) be minimized in your unit testing, it is strongly recommended that you opt for spies to remove the need for a web server to be used here.</p>
<h2>
      <a name="user-content-beforeeach-and-aftereach" class="anchor" href="#beforeeach-and-aftereach"><span class="octicon octicon-link"></span></a>beforeEach and afterEach()</h2>
<p>Jasmine also supports specifying code that can be run before each (<code>beforeEach()</code>) and after each (<code>afterEach</code>) test. This is useful for enforcing consistent conditions (such as resetting variables that may be required by specs). In the following example, <code>beforeEach()</code> is used to create a new sample Todo model specs can use for testing attributes.</p>
<pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'Buy some more groceries'</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
         <span class="p">});</span>
      <span class="p">});</span>

      <span class="nx">it</span><span class="p">(</span><span class="s1">'should contain a text value if not the default value'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'Buy some more groceries'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>Each nested <code>describe()</code> in your tests can have their own <code>beforeEach()</code> and <code>afterEach()</code> methods which support including setup and teardown methods relevant to a particular suite. We'll be using <code>beforeEach()</code> in practice a little later.</p>
<h2>
      <a name="user-content-shared-scope" class="anchor" href="#shared-scope"><span class="octicon octicon-link"></span></a>Shared scope</h2>
<p>In the previous section you may have noticed that we initially declared a variable <code>this.todo</code> in our <code>beforeEach()</code> call and were then able to continue using this in <code>afterEach()</code>. This is thanks to a powerful feature of Jasmine known as shared  functional scope. Shared scope allows <code>this</code> properties to be common to all blocks (including <code>runs()</code>), but not declared variables (i.e <code>var</code>s).</p>
<h2>
      <a name="user-content-getting-setup" class="anchor" href="#getting-setup"><span class="octicon octicon-link"></span></a>Getting setup</h2>
<p>Now that we've reviewed some fundamentals, let's go through downloading Jasmine and getting everything setup to write tests.</p>
<p>A standalone release of Jasmine can be <a href="http://pivotal.github.com/jasmine/download.html">downloaded</a> from the official release page.</p>
<p>You'll need a file called SpecRunner.html in addition to the release. It can be downloaded from <a href="https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example">https://github.com/pivotal/jasmine/tree/master/lib/jasmine-core/example</a> or as part of a download of the complete Jasmine <a href="https://github.com/pivotal/jasmine/zipball/master">repo</a>.Alternatively, you can <code>git clone</code> the main Jasmine repository from <a href="https://github.com/pivotal/jasmine.git">https://github.com/pivotal/jasmine.git</a>.</p>
<p>Let's review <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/SpecRunner.html">SpecRunner.html</a>:</p>
<p>It first includes both Jasmine and the necessary CSS required for reporting:</p>
<pre><code>&lt;link rel="stylesheet" type="text/css" href="lib/jasmine-1.1.0.rc1/jasmine.css"/&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="lib/jasmine-1.1.0.rc1/jasmine-html.js"&gt;&lt;/script&gt;
      </code></pre>
<p>Next, some sample tests are included:</p>
<pre><code>&lt;script type="text/javascript" src="spec/SpecHelper.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="spec/PlayerSpec.js"&gt;&lt;/script&gt;
      </code></pre>
<p>And finally the sources being tested:</p>
<pre><code>&lt;script type="text/javascript" src="src/Player.js"&gt;&lt;/script&gt;
      &lt;script type="text/javascript" src="src/Song.js"&gt;&lt;/script&gt;
      </code></pre>
<p><strong><em>Note:</em></strong> Below this section of SpecRunner is code responsible for running the actual tests. Given that we won't be covering modifying this code, I'm going to skip reviewing it. I do however encourage you to take a look through <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/PlayerSpec.js">PlayerSpec.js</a> and <a href="https://github.com/pivotal/jasmine/blob/master/lib/jasmine-core/example/spec/SpecHelper.js">SpecHelper.js</a>. They're a useful basic example to go through how a minimal set of tests might work.</p>
<h2>
      <a name="user-content-tdd-with-backbone" class="anchor" href="#tdd-with-backbone"><span class="octicon octicon-link"></span></a>TDD With Backbone</h2>
<p>When developing applications with Backbone, it can be necessary to test both individual modules of code as well as modules, views, collections and routers. Taking a TDD approach to testing, let's review some specs for testing these Backbone components using the popular Backbone <a href="https://github.com/addyosmani/todomvc/tree/master/todo-example/backbone">Todo</a> application. For this section we will be using a modified version of Larry Myers Backbone Koans project, which can be found in the <code>practicals\jasmine-koans</code> folder.</p>
<h2>
      <a name="user-content-models-2" class="anchor" href="#models-2"><span class="octicon octicon-link"></span></a>Models</h2>
<p>The complexity of Backbone models can vary greatly depending on what your application is trying to achieve. In the following example, we're going to test default values, attributes, state changes and validation rules.</p>
<p>First, we begin our suite for model testing using <code>describe()</code>:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for Todo'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      </pre>
<p>Models should ideally have default values for attributes. This helps ensure that when creating instances without a value set for any specific attribute, a default one (e.g '') is used instead. The idea here is to allow your application to interact with models without any unexpected behavior.</p>
<p>In the following spec, we create a new Todo without any attributes passed then check to find out what the value of the <code>text</code> attribute is. As no value has been set, we expect a default value of <code>''</code> to be returned.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>If testing this spec before your models have been written, you'll incur a failing test, as expected. What's required for the spec to pass is a default value for the attribute <code>text</code>. We can implement this default value with some other useful defaults (which we'll be using shortly) in our Todo model as follows:</p>
<pre><span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">}</span>

      </pre>
<p>Next, we want to test that our model will pass attributes that are set such that retrieving the value of these attributes after initialization will be what we expect. Notice that here, in addition to testing for an expected value for <code>text</code>, we're also testing the other default values are what we expect them to be.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Will set passed attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="c1">// what are the values expected here for each of the</span>
          <span class="c1">// attributes in our Todo?</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Get oil change for car.'');</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">done</span><span class="s1">')).toBe(false);</span>
      <span class="s1">    expect(todo.get('</span><span class="nx">order</span><span class="err">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>Backbone models support a model.change() event which is triggered when the state of a model changes. In the following example, by 'state' I'm referring to the value of a Todo model's attributes. The reason changes of state are important to test are that there may be state-dependent events in your application e.g you may wish to display a confirmation view once a Todo model has been updated.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-change event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="c1">// how do we monitor changes of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span><span class="p">);</span>

          <span class="c1">// what would you need to do to force a change of state?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">});</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">spy</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
      <span class="p">});</span>
      </pre>
<p>It's common to include validation logic in your models to ensure both the input passed from users (and other modules) in the application are 'valid'. A Todo app may wish to validate the text input supplied in case it contains rude words. Similarly if we're storing the <code>done</code> state of a Todo item using booleans, we need to validate that truthy/falsy values are passed and not just any arbitrary string.</p>
<p>In the following spec, we take advantage of the fact that validations which fail model.validate() trigger an "error" event. This allows us to test if validations are correctly failing when invalid input is supplied.</p>
<p>We create an errorCallback spy using Jasmine's built in <code>createSpy()</code> method which allows us to spy on the error event as follows:</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">createSpy</span><span class="p">(</span><span class="s1">'-error event callback-'</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>

          <span class="c1">// What would you need to set on the todo properties to</span>
          <span class="c1">// cause validation to fail?</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span><span class="s1">'a non-integer value'</span><span class="p">});</span>

          <span class="kd">var</span> <span class="nx">errorArgs</span> <span class="o">=</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">mostRecentCall</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">todo</span><span class="p">);</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">errorArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'Todo.done must be a boolean value.'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre>
<p>The code to make the above failing test support validation is relatively simple. In our model, we override the validate() method (as recommended in the Backbone docs), checking to make sure a model both has a 'done' property and is a valid boolean before allowing it to pass.</p>
<pre><span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
      </pre>
<p>If you would like to review the final code for our Todo model, you can find it below:</p>
<pre><span class="kd">var</span> <span class="nx">NAUGHTY_WORDS</span> <span class="o">=</span> <span class="sr">/crap|poop|hell|frogs/gi</span><span class="p">;</span>

      <span class="kd">function</span> <span class="nx">sanitize</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">NAUGHTY_WORDS</span><span class="p">,</span> <span class="s1">'rainbows'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">Todo</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

          <span class="nx">defaults</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span>  <span class="kc">false</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">0</span>
          <span class="p">},</span>

          <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="nx">sanitize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">))},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">validate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isBoolean</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">done</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="s1">'Todo.done must be a boolean value.'</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">},</span>

          <span class="nx">toggle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)});</span>
          <span class="p">}</span>

      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-collections-2" class="anchor" href="#collections-2"><span class="octicon octicon-link"></span></a>Collections</h2>
<p>We now need to define specs to tests a Backbone collection of Todo models (a TodoList). Collections are responsible for a number of list tasks including managing order and filtering.</p>
<p>A few specific specs that come to mind when working with collections are:</p>
<ul>
<li>Making sure we can add new Todo models as both objects and arrays</li>
      <li>Attribute testing to make sure attributes such as the base URL of the collection are values we expect</li>
      <li>Purposefully adding items with a status of <code>done:true</code> and checking against how many items the collection thinks have been completed vs. those that are remaining</li>
      </ul>
<p>In this section we're going to cover the first two of these with the third left as an extended exercise I recommend trying out.</p>
<p>Testing Todo models can be added to a collection as objects or arrays is relatively trivial. First, we initialize a new TodoList collection and check to make sure its length (i.e the number of Todo models it contains) is 0. Next, we add new Todos, both as objects and arrays, checking the length property of the collection at each stage to ensure the overall count is what we expect:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoList'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">});</span>

              <span class="c1">// how many todos have been added so far?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

              <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
                  <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span><span class="p">}</span>
              <span class="p">]);</span>

              <span class="c1">// how many are there in total now?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
          <span class="p">});</span>
      <span class="p">...</span>
      </pre>
<p>Similar to model attributes, it's also quite straight-forward to test attributes in collections. Here we have a spec that ensures the collection.url (i.e the url reference to the collection's location on the server) is what we expect it to be:</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

              <span class="c1">// what has been specified as the url base in our model?</span>
              <span class="nx">expect</span><span class="p">(</span><span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'/todos/'</span><span class="p">);</span>
      <span class="p">});</span>

      </pre>
<p>For the third spec, it's useful to remember that the implementation for our collection will have methods for filtering how many Todo items are done and how many are remaining - we can call these <code>done()</code> and <code>remaining()</code>. Consider writing a spec which creates a new collection and adds one new model that has a preset <code>done</code> state of <code>true</code> and two others that have the default <code>done</code> state of <code>false</code>. Testing the length of what's returned using <code>done()</code> and <code>remaining()</code> should allow us to know whether the state management in our application is working or needs a little tweaking.</p>
<p>The final implementation for our TodoList collection can be found below:</p>
<pre> <span class="nb">window</span><span class="p">.</span><span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

              <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span><span class="p">,</span>

              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/todos/'</span><span class="p">,</span>

              <span class="nx">done</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span> <span class="p">});</span>
              <span class="p">},</span>

              <span class="nx">remaining</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">without</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">done</span><span class="p">());</span>
              <span class="p">},</span>

              <span class="nx">nextOrder</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>

                  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">last</span><span class="p">().</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
              <span class="p">},</span>

              <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">todo</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">);</span>
              <span class="p">}</span>

          <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-views-3" class="anchor" href="#views-3"><span class="octicon octicon-link"></span></a>Views</h2>
<p>Before we take a look at testing Backbone views, let's briefly review a jQuery plugin that can assist with writing Jasmine specs for them.</p>
<p><strong>The Jasmine jQuery Plugin</strong></p>
<p>As we know our Todo application will be using jQuery for DOM manipulation, there's a useful jQuery plugin called <a href="https://github.com/velesin/jasmine-jquery">jasmine-jquery</a> we can use to help simplify BDD testing rendered elements that our views may produce.</p>
<p>The plugin provides a number of additional Jasmine <a href="https://github.com/pivotal/jasmine/wiki/Matchers">matchers</a> to help test jQuery wrapped sets such as:</p>
<ul>
<li>
      <code>toBe(jQuerySelector)</code> e.g <code>expect($('&lt;div id="some-id"&gt;&lt;/div&gt;')).toBe('div#some-id')</code>
      </li>
      <li>
      <code>toBeChecked()</code> e.g <code>expect($('&lt;input type="checkbox" checked="checked"/&gt;')).toBeChecked()</code>
      </li>
      <li>
      <code>toBeSelected()</code> e.g <code>expect($('&lt;option selected="selected"&gt;&lt;/option&gt;')).toBeSelected()</code>
      </li>
      </ul>
<p>and <a href="https://github.com/velesin/jasmine-jquery">many others</a>. The complete list of matchers supported can be found on the project homepage. It's useful to know that similar to the standard Jasmine matchers, the custom matchers above can be inverted using the .not prefix (i.e <code>expect(x).not.toBe(y)</code>):</p>
<pre><span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;div&gt;I am an example&lt;/div&gt;'</span><span class="p">)).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="sr">/other/</span><span class="p">)</span>
      </pre>
<p>jasmine-jquery also includes a fixtures model, allowing us to load in arbitrary HTML content we may wish to use in our tests. Fixtures can be used as follows:</p>
<p>Include some HTML in an external fixtures file:</p>
<p>some.fixture.html:
      <code>&lt;div id="sample-fixture"&gt;some HTML content&lt;/div&gt;</code></p>
<p>Next, inside our actual test we would load it as follows:</p>
<pre><span class="nx">loadFixtures</span><span class="p">(</span><span class="s1">'some.fixture.html'</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'some-fixture'</span><span class="p">).</span><span class="nx">myTestedPlugin</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#some-fixture'</span><span class="p">)).</span><span class="nx">to</span><span class="o">&lt;</span><span class="nx">the</span> <span class="nx">rest</span> <span class="nx">of</span> <span class="nx">your</span> <span class="nx">matcher</span> <span class="nx">would</span> <span class="nx">go</span> <span class="nx">here</span><span class="o">&gt;</span>
      </pre>
<p>The jasmine-jquery plugin is by default setup to load fixtures from a specific directory: spec/javascripts/fixtures. If you wish to configure this path you can do so by initially setting <code>jasmine.getFixtures().fixturesPath = 'your custom path'</code>.</p>
<p>Finally, jasmine-jquery includes support for spying on jQuery events without the need for any extra plumbing work. This can be done using the <code>spyOnEvent()</code> and <code>assert(eventName).toHaveBeenTriggered(selector)</code> functions. An example of usage may look as follows:</p>
<pre><span class="nx">spyOnEvent</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">),</span> <span class="s1">'click'</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
      <span class="nx">expect</span><span class="p">(</span><span class="s1">'click'</span><span class="p">).</span><span class="nx">toHaveBeenTriggeredOn</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#el'</span><span class="p">));</span>
      </pre>
<p><strong>View testing</strong></p>
<p>In this section we will review three dimensions to writing specs for Backbone Views: initial setup, view rendering and finally templating. The latter two of these are the most commonly tested, however we'll review shortly why writing specs for the initialization of your views can also be of benefit.</p>
<h2>
      <a name="user-content-initial-setup" class="anchor" href="#initial-setup"><span class="octicon octicon-link"></span></a>Initial setup</h2>
<p>At their most basic, specs for Backbone views should validate that they are being correctly tied to specific DOM elements and are backed by valid data models. The reason to consider doing this is that failures to such specs can trip up more complex tests later on and they're fairly simple to write, given the overall value offered.</p>
<p>To help ensure a consistent testing setup for our specs, we use <code>beforeEach()</code> to append both an empty <code>UL</code> (#todoList) to the DOM and initialize a new instance of a TodoView using an empty Todo model. <code>afterEach()</code> is used to remove the previous #todoList  <code>UL</code> as well as the previous instance of the view.</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Tests for TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">});</span>


          <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">});</span>

      <span class="p">...</span>
      </pre>
<p>The first spec useful to write is a check that the TodoView we've created is using the correct <code>tagName</code> (element or className). The purpose of this test is to make sure it's been correctly tied to a DOM element when it was created.</p>
<p>Backbone views typically create empty DOM elements once initialized, however these elements are not attached to the visible DOM in order to allow them to be constructed without an impact on the performance of rendering.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">//what html element tag name represents this view?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'li'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>Once again, if the TodoView has not already been written, we will experience failing specs. Thankfully, solving this is as simple as creating a new Backbone.View with a specific <code>tagName</code>.</p>
<pre><span class="kd">var</span> <span class="nx">todoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">tagName</span><span class="o">:</span>  <span class="s1">'li'</span>
      <span class="p">});</span>
      </pre>
<p>If instead of testing against the <code>tagName</code> you would prefer to use a className instead, we can take advantage of jasmine-jquery's <code>toHaveClass()</code> matcher to cater for this.</p>
<pre><code>it('Should have a class of "todos"'), function(){
         expect(this.view.$el).toHaveClass('todos');
      });
      </code></pre>
<p>The <code>toHaveClass()</code> matcher operates on jQuery objects and if the plugin hadn't been used, an exception would have been incurred (it is of course also possible to test for the className by accessing el.className if not opting to use jasmine-jquery).</p>
<p>You may have noticed that in <code>beforeEach()</code>, we passed our view an initial (albeit unfilled) Todo model. Views should be backed by a model instance which provides data. As this is quite important to our view's ability to function, we can write a spec to ensure a model is both defined (using the <code>toBeDefined()</code> matcher) and then test attributes of the model to ensure defaults both exist and are the value we expect them to be.</p>
<pre><span class="nx">it</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">).</span><span class="nx">toBeDefined</span><span class="p">();</span>

          <span class="c1">// what's the value for Todo.get('done') here?</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span> <span class="c1">//or toBeFalsy()</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-view-rendering" class="anchor" href="#view-rendering"><span class="octicon octicon-link"></span></a>View rendering</h2>
<p>Next we're going to take a look at writing specs for view rendering. Specifically, we want to test that our TodoView elements are actually rendering as expected.</p>
<p>In smaller applications, those new to BDD might argue that visual confirmation of view rendering could replace unit testing of views. The reality is that when dealing with applications that might grow to multiple-views, it often makes sense to automate this process as much as possible from the get-go. There are also aspects of rendering that require verification beyond what is visually presented on-screen (which we'll see very shortly).</p>
<p>We're going to begin testing views by writing two specs. The first spec will check that the view's <code>render()</code> method is correctly returning the view instance, which is necessary for chaining. Our second spec will check that the HTML produced is exactly what we expect based on the properties of the model instance that's been associated with our TodoView.</p>
<p>Unlike some of the previous specs we've covered, this section will make greater use of <code>beforeEach()</code> to both demonstrate how to use nested suites and also ensure a consistent set of conditions for our specs. In our first view spec for TodoView, we're simply going to create a sample model (based on Todo) and instantiate a TodoView which associates it with the model.</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">'My Todo'</span><span class="p">,</span>
            <span class="nx">order</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">done</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span><span class="nx">model</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Rendering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'returns the view object'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'produces the correct HTML'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

            <span class="c1">//let's use jasmine-jquery's toContain() to avoid</span>
            <span class="c1">//testing for the complete content of a todo's markup</span>
            <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">toContain</span><span class="p">(</span><span class="s1">'&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<p>Once these specs are run, only the second one ('produces the correct HTML') fails. Our first spec ('returns the view object'), which is testing that the TodoView instance is returned from <code>render()</code>, only passed as this is Backbone's default behavior. We haven't yet overwritten the <code>render()</code> method with our own version.</p>
<p><strong>Note:</strong> For the purposes of maintaining readability, all template examples in this section will use a minimal version of the following Todo view template. As it's relatively trivial to expand this, please feel free to refer to this sample if needed:</p>
<pre><code>&lt;div class="todo &lt;%= done ? 'done' : '' %&gt;"&gt;
              &lt;div class="display"&gt;
                &lt;input class="check" type="checkbox" &lt;%= done ? 'checked="checked"' : '' %&gt; /&gt;
                &lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;
                &lt;span class="todo-destroy"&gt;&lt;/span&gt;
              &lt;/div&gt;
              &lt;div class="edit"&gt;
                &lt;input class="todo-input" type="text" value="&lt;%= content %&gt;" /&gt;
              &lt;/div&gt;
      &lt;/div&gt;
      </code></pre>
<p>The second spec fails with the following message:</p>
<p><code>Expected '' to contain '&lt;label class="todo-content"&gt;My Todo&lt;/label&gt;'.</code></p>
<p>The reason for this is the default behavior for render() doesn't create any markup. Let's write a replacement for render() which fixes this:</p>
<pre><span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="s1">'&lt;label class="todo-content"&gt;&lt;%= text %&gt;&lt;/label&gt;'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">template</span>
          <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'&lt;%= text %&gt;'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">));</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
      </pre>
<p>The above specifies an inline string template and replaces fields found in the template within the "&lt;% %&gt;" blocks with their corresponding values from the associated model. As we're now also returning the TodoView instance from the method, the first spec will also pass. It's worth noting that there are serious drawbacks to using HTML strings in your specs to test against like this. Even minor changes to your template (a simple tab or whitespace) would cause your spec to fail, despite the rendered output being the same. It's also more time consuming to maintain as most templates in real-world applications are significantly more complex. A better option for testing rendered output is using jQuery to both select and inspect values.</p>
<p>With this in mind, let's re-write the specs, this time using some of the custom matchers offered by jasmine-jquery:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<p>It would be impossible to discuss unit testing without mentioning fixtures. Fixtures typically contain test data (e.g HTML) that is loaded in when needed (either locally or from an external file) for unit testing. So far we've been establishing jQuery expectations based on the view's el property. This works for a number of cases, however, there are instances where it may be necessary to render markup into the document. The most optimal way to handle this within specs is through using fixtures (another feature brought to us by the jasmine-jquery plugin).</p>
<p>Re-writing the last spec to use fixtures would look as follows:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="nx">setFixtures</span><span class="p">(</span><span class="s1">'&lt;ul class="todos"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="p">...</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">'Template'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">});</span>

          <span class="nx">it</span><span class="p">(</span><span class="s1">'has the correct text content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.todo-content'</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">toHaveText</span><span class="p">(</span><span class="s1">'My Todo'</span><span class="p">);</span>
          <span class="p">});</span>

        <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<p>What we're now doing in the above spec is appending the rendered todo item into the fixture. We then set expectations against the fixture, which may be something desirable when a view is setup against an element which already exists in the DOM. It would be necessary to provide both the fixture and test the <code>el</code> property correctly picking up the element expected when the view is instantiated.</p>
<h2>
      <a name="user-content-rendering-with-a-templating-system" class="anchor" href="#rendering-with-a-templating-system"><span class="octicon octicon-link"></span></a>Rendering with a templating system</h2>
<p>JavaScript templating systems (such as Handlebars, Mustache and even Underscore's own Micro-templating) support conditional logic in template strings. What this effectively means is that we can add if/else/ternery expressions inline which can then be evaluated as needed, allowing us to build even more powerful templates.</p>
<p>In our case, when a user sets a Todo item to be complete (done), we may wish to provide them with visual feedback (such as a striked line through the text) to differentiate the item from those that are remaining. This can be done by attaching a new class to the item. Let's begin by writing a test we would ideally like to work:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'When a todo is done'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="nx">done</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">'.todos'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">'has a done class'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'.todos .todo-content:first-child'</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">toHaveClass</span><span class="p">(</span><span class="s1">'done'</span><span class="p">);</span>
        <span class="p">});</span>

      <span class="p">});</span>
      </pre>
<p>This will fail with the following message:</p>
<p>```Expected 'My Todo'
      to have class 'done'.</p>
<pre><code>
      which can be fixed in the existing render() method as follows:


      ```javascript
      render: function() {
        var template = '&lt;label class="todo-content"&gt;' +
          '&lt;%= text %&gt;&lt;/label&gt;';
        var output = template
          .replace('&lt;%= text %&gt;', this.model.get('text'));
        this.$el.html(output);
        if (this.model.get('done')) {
          this.$('.todo-content').addClass('done');
        }
        return this;
      }
      </code></pre>
<p>This can however get unwieldily fairly quickly. As the logic in our templates increases, so does the complexity involved. This is where templates libraries can help. As mentioned earlier, there are a number of popular options available, but for the purposes of this chapter we're going to stick to using Underscore's built-in Microtemplating. Whilst there are more advanced options you're free to explore, the benefit of this is that no additional files are required and we can easily change the existing Jasmine specs without too much adjustment.</p>
<p>The TodoView object modified to use Underscore templating would look as follows:</p>
<pre><span class="kd">var</span> <span class="nx">TodoView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

        <span class="nx">tagName</span><span class="o">:</span> <span class="s1">'li'</span><span class="p">,</span>

        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span> <span class="o">||</span> <span class="s1">''</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()));</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre>
<p>Above, the initialize() method compiles a supplied Underscore template (using the _.template() function) in the instantiation. A more common way of referencing templates is placing them in a script tag using a custom script type (e.g type="text/template"). As this isn't a script type any browser understands, it's simply ignored, however referencing the script by an id attribute allows the template to be kept separate to other parts of the page which wish to use it. In real world applications, it's preferable to either do this or load in templates stored in external files for testing.</p>
<p>For testing purposes, we're going to continue using the string injection approach to keep things simple. There is however a useful trick that can be applied to automatically create or extend templates in the Jasmine scope for each test. By creating a new directory (say, 'templates') in the 'spec' folder and adding a new script file with the following contents, to jasmine.yml or SpecRunner.html, we can add a todo property which contains the Underscore template we wish to use:</p>
<pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content"&gt;'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>To finish this off, we simply update our existing spec to reference the template when instantiating the TodoView object:</p>
<pre><span class="nx">describe</span><span class="p">(</span><span class="s1">'TodoView'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="p">...</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
            <span class="nx">template</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">todo</span>
          <span class="p">});</span>
        <span class="p">});</span>

        <span class="p">...</span>

      <span class="p">});</span>
      </pre>
<p>The existing specs we've looked at would continue to pass using this approach, leaving us free to adjust the template with some additional conditional logic for Todos with a status of 'done':</p>
<pre><span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">templates</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
          <span class="nx">todo</span><span class="o">:</span> <span class="s1">'&lt;label class="todo-content &lt;%= done ? '</span><span class="nx">done</span><span class="s1">' : '' %&gt;"'</span> <span class="o">+</span>
                  <span class="s1">'&lt;%= text %&gt;'</span> <span class="o">+</span>
                <span class="s1">'&lt;/label&gt;'</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>This will now also pass without any issues. Remember that jasmine-jquery also supports loading external fixtures into your specs easily using its build in <code>loadFixtures()</code> and <code>readFixtures()</code> methods. For more information, consider reading the official jasmine-jquery <a href="https://github.com/velesin/jasmine-jquery">docs</a>.</p>
<h2>
      <a name="user-content-conclusions-3" class="anchor" href="#conclusions-3"><span class="octicon octicon-link"></span></a>Conclusions</h2>
<p>We have now covered how to write Jasmine tests for models, views and collections with Backbone.js. Whilst testing routing can at times be desirable, some developers feel it can be more optimal to leave this to third-party tools such as Selenium, so do keep this in mind.</p>
<p>James Newbery was kind enough to help me with writing the Views section above and his articles on <a href="http://tinnedfruit.com/2011/04/26/testing-backbone-apps-with-jasmine-sinon-3.html">Testing Backbone Apps With SinonJS</a> were of great inspiration (you'll actually find some Handlebars examples of the view specs in part 3 of his article). If you would like to learn more about writing spies and mocks for Backbone using <a href="http://sinonjs.org">SinonJS</a> as well as how to test Backbone routers, do consider reading his series.</p>
<h2>
      <a name="user-content-exercise" class="anchor" href="#exercise"><span class="octicon octicon-link"></span></a>Exercise</h2>
<p>As an exercise, I recommend now trying the Jasmine Koans in <code>practicals\jasmine-joans</code> and trying to fix some of the purposefully failing tests it has to offer. This is an excellent way of not just learning how Jasmine specs and suites work, but working through the examples (without peeking back) will also put your Backbone skills to test too.</p>
<h2>
      <a name="user-content-further-reading" class="anchor" href="#further-reading"><span class="octicon octicon-link"></span></a>Further reading</h2>
<ul>
<li><a href="http://japhr.blogspot.com/2011/11/jasmine-backbonejs-revisited.html">Jasmine + Backbone Revisited</a></li>
      <li><a href="http://japhr.blogspot.com/2011/12/phantomjs-and-backbonejs-and-requirejs.html">Backbone, PhantomJS and Jasmine</a></li>
      </ul>
<h2>
      <a name="user-content-unit-testing-backbone-applications-with-qunit-and-sinonjs" class="anchor" href="#unit-testing-backbone-applications-with-qunit-and-sinonjs"><span class="octicon octicon-link"></span></a>Unit Testing Backbone Applications With QUnit And SinonJS</h2>
<h2>
      <a name="user-content-introduction-4" class="anchor" href="#introduction-4"><span class="octicon octicon-link"></span></a>Introduction</h2>
<p>QUnit is a powerful JavaScript test suite written by jQuery team member <a href="http://bassistance.de/">Jörn Zaefferer</a> and used by many large open-source projects (such as jQuery and Backbone.js) to test their code. It's both capable of testing standard JavaScript code in the browser as well as code on the server-side (where environments supported include Rhino, V8 and SpiderMonkey). This makes it a robust solution for a large number of use-cases.</p>
<p>Quite a few Backbone.js contributors feel that QUnit is a better introductory framework for testing if you don't wish to start off with Jasmine and BDD right away. As we'll see later on in this chapter, QUnit can also be combined with third-party solutions such as SinonJS to produce an even more powerful testing solution supporting spies and mocks, which some say is preferable over Jasmine.</p>
<p>My personal recommendation is that it's worth comparing both frameworks and opting for the solution that you feel the most comfortable with.</p>
<h1>
      <a name="user-content-qunit" class="anchor" href="#qunit"><span class="octicon octicon-link"></span></a>QUnit</h1>
<h2>
      <a name="user-content-getting-setup-1" class="anchor" href="#getting-setup-1"><span class="octicon octicon-link"></span></a>Getting Setup</h2>
<p>Luckily, getting QUnit setup is a fairly straight-forward process that will take less than 5 minutes.</p>
<p>We first setup a testing environment composed of three files:</p>
<ul>
<li>A HTML <strong>structure</strong> for displaying test results,</li>
      <li>The <strong>qunit.js</strong> file composing the testing framework and,</li>
      <li>The <strong>qunit.css</strong> file for styling test results.</li>
      </ul>
<p>The latter two of these can be downloaded from the <a href="http://qunitjs.com">QUnit website</a>.</p>
<p>If you would prefer, you can use a hosted version of the QUnit source files for testing purposes. The hosted URLs can be found at [<a href="http://github.com/jquery/qunit/raw/master/qunit/">http://github.com/jquery/qunit/raw/master/qunit/</a>].</p>
<h4>
      <a name="user-content-sample-html-with-qunit-compatible-markup" class="anchor" href="#sample-html-with-qunit-compatible-markup"><span class="octicon octicon-link"></span></a>Sample HTML with QUnit-compatible markup:</h4>
<pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test Suite<span class="nt">&lt;/title&gt;</span>

           <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your application --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

           <span class="c">&lt;!-- Your tests --&gt;</span>
           <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test Suite<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;</span>test markup, hidden.<span class="nt">&lt;/ol&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre>
<p>Let's go through the elements above with qunit mentioned in their ID. When QUnit is running:</p>
<ul>
<li>
      <strong>qunit-header</strong> shows the name of the test suite</li>
      <li>
      <strong>qunit-banner</strong> shows up as red if a test fails and green if all tests pass</li>
      <li>
      <strong>qunit-testrunner-toolbar</strong> contains additional options for configuring the display of tests</li>
      <li>
      <strong>qunit-userAgent</strong> displays the navigator.userAgent property</li>
      <li>
      <strong>qunit-tests</strong> is a container for our test results</li>
      </ul>
<p>When running correctly, the above test runner looks as follows:</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/7d4de12.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/7d4de12.png" alt="screenshot 1" style="max-width:100%;"></a></p>
<p>The numbers of the form (a, b, c) after each test name correspond to a) failed asserts, b) passed asserts and c) total asserts. Clicking on a test name expands it to display all of the assertions for that test case. Assertions in green have successfully passed.</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/9df4.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/9df4.png" alt="screenshot 2" style="max-width:100%;"></a></p>
<p>If however any tests fail, the test gets highlighted (and the qunit-banner at the top switches to red):</p>
<p><a href="/madflo/backbone-fundamentals/blob/e268c4beea0da94f9997a6b8a57e64b42982e493/img/3e5545.png" target="_blank"><img src="/madflo/backbone-fundamentals/raw/e268c4beea0da94f9997a6b8a57e64b42982e493/img/3e5545.png" alt="screenshot 3" style="max-width:100%;"></a></p>
<h2>
      <a name="user-content-assertions" class="anchor" href="#assertions"><span class="octicon octicon-link"></span></a>Assertions</h2>
<p>QUnit supports a number of basic <strong>assertions</strong>, which are used in testing to verify that the result being returned by our code is what we expect. If an assertion fails, we know that a bug exists.Similar to Jasmine, QUnit can be used to easily test for regressions. Specifically, when a bug is found one can write an assertion to test the existence of the bug, write a patch and then commit both. If subsequent changes to the code break the test you'll know what was responsible and be able to address it more easily.</p>
<p>Some of the supported QUnit assertions we're going to look at first are:</p>
<ul>
<li>  <code>ok ( state, message )</code> - passes if the first argument is truthy</li>
      <li>  <code>equal ( actual, expected, message )</code> - a simple comparison assertion with type coercion</li>
      <li>  <code>notEqual ( actual, expected, message )</code> - the opposite of the above</li>
      <li>  <code>expect( amount )</code> - the number of assertions expected to run within each test</li>
      <li>  <code>strictEqual( actual, expected, message)</code> - offers a much stricter comparison than <code>equal()</code> and is considered the preferred method of checking equality as it avoids stumbling on subtle coercion bugs</li>
      <li>  <code>deepEqual( actual, expected, message )</code> - similar to <code>strictEqual</code>, comparing the contents (with <code>===</code>) of the given objects, arrays and primitives.</li>
      </ul>
<p>Creating new test cases with QUnit is relatively straight-forward and can be done using <code>test()</code>, which constructs a test where the first argument is the <code>name</code> of the test to be displayed in our results and the second is a <code>callback</code> function containing all of our assertions. This is called as soon as QUnit is running.</p>
<h4>
      <a name="user-content-basic-test-case-using-test-name-callback-" class="anchor" href="#basic-test-case-using-test-name-callback-"><span class="octicon octicon-link"></span></a>Basic test case using test( name, callback ):</h4>
<pre><span class="kd">var</span> <span class="nx">myString</span> <span class="o">=</span> <span class="s1">'Hello Backbone.js'</span><span class="p">;</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Our first QUnit test - asserting results'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

          <span class="c1">// ok( boolean, message )</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">'the test succeeds'</span><span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'the test fails'</span><span class="p">);</span>

          <span class="c1">// equal( actualValue, expectedValue, message )</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">myString</span><span class="p">,</span> <span class="s1">'Hello Backbone.js'</span><span class="p">,</span> <span class="s1">'The value expected is Hello Backbone.js!'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>What we're doing in the above is defining a variable with a specific value and then testing to ensure the value was what we expected it to be. This was done using the comparison assertion, <code>equal()</code>, which expects its first argument to be a value being tested and the second argument to be the expected value. We also used <code>ok()</code>, which allows us to easily test against functions or variables that evaluate to booleans.</p>
<p>Note: Optionally in our test case, we could have passed an 'expected' value to <code>test()</code> defining the number of assertions we expect to run. This takes the form: <code>test( name, [expected], test );</code> or by manually settings the expectation at the top of the test function, like so: <code>expect( 1 )</code>. I recommend you to make it a habit and always define how many assertions you expect. More on this later.</p>
<p>As testing a simple static variable is fairly trivial, we can take this further to test actual functions. In the following example we test the output of a function that reverses a string to ensure that the output is correct using <code>equal()</code> and <code>notEqual()</code>:</p>
<h4>
      <a name="user-content-comparing-the-actual-output-of-a-function-against-the-expected-output" class="anchor" href="#comparing-the-actual-output-of-a-function-against-the-expected-output"><span class="octicon octicon-link"></span></a>Comparing the actual output of a function against the expected output:</h4>
<pre><span class="kd">function</span> <span class="nx">reverseString</span><span class="p">(</span> <span class="nx">str</span> <span class="p">){</span>
          <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">''</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'reverseString()'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">),</span> <span class="s1">'olleh'</span><span class="p">,</span> <span class="s1">'The value expected was olleh'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'foobar'</span><span class="p">),</span> <span class="s1">'raboof'</span><span class="p">,</span> <span class="s1">'The value expected was raboof'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlrow'</span><span class="p">,</span> <span class="s1">'The value expected was dlrow'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'world'</span><span class="p">),</span> <span class="s1">'dlroo'</span><span class="p">,</span> <span class="s1">'The value was expected to not be dlroo'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">reverseString</span><span class="p">(</span><span class="s1">'bubble'</span><span class="p">),</span> <span class="s1">'double'</span><span class="p">,</span> <span class="s1">'The value expected was elbbub'</span> <span class="p">);</span>
      <span class="p">})</span>
      </pre>
<p>Running these tests in the QUnit test runner (which you would see when your HTML test page was loaded) we would find that four of the assertions pass whilst the last one does not. The reason the test against <code>'double'</code> fails is because it was purposefully written incorrectly. In your own projects if a test fails to pass and your assertions are correct, you've probably just found a bug!</p>
<h2>
      <a name="user-content-adding-structure-to-assertions" class="anchor" href="#adding-structure-to-assertions"><span class="octicon octicon-link"></span></a>Adding structure to assertions</h2>
<p>Housing all of our assertions in one test case can quickly become difficult to maintain, but luckily QUnit supports structuring blocks of assertions more cleanly. This can be done using <code>module()</code> - a method that allows us to easily group tests together. A typical approach to grouping might be keeping multiple tests testing a specific method as part of the same group (module).</p>
<h4>
      <a name="user-content-basic-qunit-modules" class="anchor" href="#basic-qunit-modules"><span class="octicon octicon-link"></span></a>Basic QUnit Modules:</h4>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Two'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'second test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>

      <span class="nx">module</span><span class="p">(</span> <span class="s1">'Module Three'</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'third test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'another test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span> <span class="p">);</span>
      </pre>
<p>We can take this further by introducing <code>setup()</code> and <code>teardown()</code> callbacks to our modules, where <code>setup()</code> is run before each test whilst <code>teardown()</code> is run after each test.</p>
<h4>
      <a name="user-content-using-setup-and-teardown-" class="anchor" href="#using-setup-and-teardown-"><span class="octicon octicon-link"></span></a>Using setup() and teardown() :</h4>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Module One'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run before</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="c1">// run after</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'first test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="c1">// run the first test</span>
      <span class="p">});</span>
      </pre>
<p>These callbacks can be used to define (or clear) any components we wish to instantiate for use in one or more of our tests. As we'll see shortly, this is ideal for defining new instances of views, collections, models or routers from a project that we can then reference across multiple tests.</p>
<h4>
      <a name="user-content-using-setup-and-teardown-for-instantiation-and-clean-up" class="anchor" href="#using-setup-and-teardown-for-instantiation-and-clean-up"><span class="octicon octicon-link"></span></a>Using setup() and teardown() for instantiation and clean-up:</h4>
<pre><span class="c1">// Define a simple model and collection modeling a store and</span>
      <span class="c1">// list of stores</span>

      <span class="kd">var</span> <span class="nx">Store</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({});</span>

      <span class="kd">var</span> <span class="nx">StoreList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">store</span><span class="p">,</span>
          <span class="nx">comparator</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">store</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Define a group for our tests</span>
      <span class="nx">module</span><span class="p">(</span> <span class="s1">'StoreList sanity check'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StoreList</span><span class="p">;</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Costcutter'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Target'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Walmart'</span> <span class="p">}));</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Store</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">'Barnes &amp; Noble'</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nb">window</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="c1">// Test the order of items added</span>
      <span class="nx">test</span><span class="p">(</span> <span class="s1">'test ordering'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Barnes &amp; Noble'</span><span class="p">,</span> <span class="s1">'Costcutter'</span><span class="p">,</span> <span class="s1">'Target'</span><span class="p">,</span> <span class="s1">'Walmart'</span><span class="p">];</span>
          <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s1">'is maintained by comparator'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre>
<p>Here, a list of stores is created and stored on <code>setup()</code>. A <code>teardown()</code> callback is used to simply clear our a list of errors we might be storing within the window scope, but is otherwise not needed.</p>
<h2>
      <a name="user-content-assertion-examples" class="anchor" href="#assertion-examples"><span class="octicon octicon-link"></span></a>Assertion examples</h2>
<p>Before we continue any further, let's review some more examples of how QUnits various assertions can be correctly used when writing tests:</p>
<h3>
      <a name="user-content-equal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#equal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>equal - a comparison assertion. It passes if actual == expected</h3>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'equal'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 == true'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 == 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-notequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notEqual - a comparison assertion. It passes if actual != expected</h3>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'notEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s1">'passes as 1 != false'</span> <span class="p">);</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="s1">'passes as 1 != 0'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-strictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#strictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>strictEqual - a comparison assertion. It passes if actual === expected.</h3>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'strictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'fails as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">strictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'passes as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-notstrictequal---a-comparison-assertion-it-passes-if-actual--expected" class="anchor" href="#notstrictequal---a-comparison-assertion-it-passes-if-actual--expected"><span class="octicon octicon-link"></span></a>notStrictEqual - a comparison assertion. It passes if actual !== expected.</h3>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notStrictEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span>  <span class="s1">'passes as 1 !== true'</span> <span class="p">);</span>
        <span class="nx">notStrictEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="s1">'fails as 1 === 1'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives" class="anchor" href="#deepequal---a-recursive-comparison-assertion-unlike-strictequal-it-works-on-objects-arrays-and-primitives"><span class="octicon octicon-link"></span></a>deepEqual - a recursive comparison assertion. Unlike strictEqual(), it works on objects, arrays and primitives.</h3>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'deepEqual'</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'div'</span><span class="p">).</span><span class="nx">children</span><span class="p">();</span>

        <span class="nx">equal</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are not equal using equal()'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are equal'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - jQuery objects are not the same'</span> <span class="p">);</span>
        <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="s1">'fails - objects not equivalent'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal" class="anchor" href="#notdeepequal---a-comparison-assertion-this-returns-the-opposite-of-deepequal"><span class="octicon octicon-link"></span></a>notDeepEqual - a comparison assertion. This returns the opposite of deepEqual</h3>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'notDeepEqual'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">actual</span> <span class="o">=</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">};</span>
        <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'passes - objects are not equal'</span> <span class="p">);</span>
        <span class="nx">notDeepEqual</span><span class="p">(</span> <span class="nx">actual</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">t</span><span class="o">:</span> <span class="s1">'bar'</span><span class="p">},</span>   <span class="s1">'fails - objects are equivalent'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions" class="anchor" href="#raises---an-assertion-which-tests-if-a-callback-throws-any-exceptions"><span class="octicon octicon-link"></span></a>raises - an assertion which tests if a callback throws any exceptions</h3>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'raises'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">raises</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="s1">'Oh no! It`s an error!'</span> <span class="p">);</span>
        <span class="p">},</span> <span class="s1">'passes - an error was thrown inside our callback'</span><span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-fixtures" class="anchor" href="#fixtures"><span class="octicon octicon-link"></span></a>Fixtures</h2>
<p>From time to time we may need to write tests that modify the DOM. Managing the clean-up of such operations between tests can be a genuine pain, but thankfully QUnit has a solution to this problem in the form of the <code>#qunit-fixture</code> element, seen below.</p>
<h4>
      <a name="user-content-fixture-markup" class="anchor" href="#fixture-markup"><span class="octicon octicon-link"></span></a>Fixture markup:</h4>
<pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
      <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;head&gt;</span>
          <span class="nt">&lt;title&gt;</span>QUnit Test<span class="nt">&lt;/title&gt;</span>
          <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"qunit.css"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"qunit.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"app.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
          <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"tests.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
      <span class="nt">&lt;/head&gt;</span>
      <span class="nt">&lt;body&gt;</span>
          <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">"qunit-header"</span><span class="nt">&gt;</span>QUnit Test<span class="nt">&lt;/h1&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-banner"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-testrunner-toolbar"</span><span class="nt">&gt;&lt;/div&gt;</span>
          <span class="nt">&lt;h2</span> <span class="na">id=</span><span class="s">"qunit-userAgent"</span><span class="nt">&gt;&lt;/h2&gt;</span>
          <span class="nt">&lt;ol</span> <span class="na">id=</span><span class="s">"qunit-tests"</span><span class="nt">&gt;&lt;/ol&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"qunit-fixture"</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
      <span class="nt">&lt;/html&gt;</span>
      </pre>
<p>We can either opt to place static markup in the fixture or just insert/append any DOM elements we may need to it. QUnit will automatically reset the <code>innerHTML</code> of the fixture after each test to its original value. In case you're using jQuery, it's useful to know that QUnit checks for its availability and will opt to use <code>$(el).html()</code> instead, which will cleanup any jQuery event handlers too.</p>
<h3>
      <a name="user-content-fixtures-example" class="anchor" href="#fixtures-example"><span class="octicon octicon-link"></span></a>Fixtures example:</h3>
<p>Let us now go through a more complete example of using fixtures. One thing that most of us are used to doing in jQuery is working with lists - they're often used to define the markup for menus, grids and a number of other components. You may have used jQuery plugins before that manipulated a given list in a particular way and it can be useful to test that the final (manipulated) output of the plugin is what was expected.</p>
<p>For the purposes of our next example, we're going to use Ben Alman's <code>$.enumerate()</code> plugin, which can prepend each item in a list by its index, optionally allowing us to set what the first number in the list is. The code snippet for the plugin can be found below, followed by an example of the output is generates:</p>
<pre><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">enumerate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">start</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">start</span> <span class="o">!==</span> <span class="s1">'undefined'</span> <span class="p">)</span> <span class="p">{</span>
              <span class="c1">// Since `start` value was provided, enumerate and return</span>
              <span class="c1">// the initial jQuery object to allow chaining.</span>

              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span>
                <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span> <span class="s1">'&lt;b&gt;'</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">start</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">'&lt;/b&gt; '</span> <span class="p">);</span>
              <span class="p">});</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Since no `start` value was provided, function as a</span>
              <span class="c1">// getter, returing the appropriate value from the first</span>
              <span class="c1">// selected element.</span>

              <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">children</span><span class="p">(</span> <span class="s1">'b'</span> <span class="p">).</span><span class="nx">eq</span><span class="p">(</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">text</span><span class="p">();</span>
              <span class="k">return</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">val</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">};</span>

      <span class="cm">/*</span>
      <span class="cm">    &lt;ul&gt;</span>
      <span class="cm">      &lt;li&gt;1. hello&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;2. world&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;3. i&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;4. am&lt;/li&gt;</span>
      <span class="cm">      &lt;li&gt;5. foo&lt;/li&gt;</span>
      <span class="cm">    &lt;/ul&gt;</span>
      <span class="cm">*/</span>
      </pre>
<p>Let's now write some specs for the plugin. First, we define the markup for a list containing some sample items inside our <code>qunit-fixture</code> element:</p>
<pre><span class="ni">&amp;lt;</span>div id=<span class="ni">&amp;quot;</span>qunit-fixture<span class="ni">&amp;quot;&amp;gt;</span>
          <span class="ni">&amp;lt;</span>ul<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>hello<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>world<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>i<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>am<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
            <span class="ni">&amp;lt;</span>li<span class="ni">&amp;gt;</span>foo<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
          <span class="ni">&amp;lt;</span>/ul<span class="ni">&amp;gt;</span>
        <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
      </pre>
<p>Next, we need to think about what should be tested. <code>$.enumerate()</code> supports a few different use cases, including:</p>
<ul>
<li>
      <strong>No arguments passed</strong> - i.e <code>$(el).enumerate()</code>
      </li>
      <li>
      <strong>0 passed as an argument</strong> - i.e <code>$(el).enumerate(0)</code>
      </li>
      <li>
      <strong>1 passed as an argument</strong> - i.e <code>$(el).enumerate(1)</code>
      </li>
      </ul>
<p>As the text value for each list item is of the form "n. item-text" and we only require this to test against the expected output, we can simply access the content using <code>$(el).eq(index).text()</code> (for more information on .eq() see <a href="http://api.jquery.com/eq/">here</a>).</p>
<p>and finally, here are our test cases:</p>
<pre><span class="nx">module</span><span class="p">(</span><span class="s1">'jQuery#enumerate'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'No arguments passed'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">();</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'0 passed as an argument'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'0. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 0'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. world'</span><span class="p">,</span> <span class="s1">'second item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. i'</span><span class="p">,</span> <span class="s1">'third item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 4'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'1 passed as an argument'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">items</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture li'</span><span class="p">).</span><span class="nx">enumerate</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'1. hello'</span><span class="p">,</span> <span class="s1">'first item should have index 1'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'2. world'</span><span class="p">,</span> <span class="s1">'second item should have index 2'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'3. i'</span><span class="p">,</span> <span class="s1">'third item should have index 3'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'4. am'</span><span class="p">,</span> <span class="s1">'fourth item should have index 4'</span> <span class="p">);</span>
        <span class="nx">equal</span><span class="p">(</span> <span class="nx">items</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="s1">'5. foo'</span><span class="p">,</span> <span class="s1">'fifth item should have index 5'</span> <span class="p">);</span>
      <span class="p">});</span>

      </pre>
<h2>
      <a name="user-content-asynchronous-code" class="anchor" href="#asynchronous-code"><span class="octicon octicon-link"></span></a>Asynchronous code</h2>
<p>As with Jasmine, the effort required to run synchronous tests with QUnit is fairly straight-forward. That said, what about tests that require asynchronous callbacks (such as expensive processes, Ajax requests and so on)? When we're dealing with asynchronous code, rather than letting QUnit control when the next test runs, we can inform that we need it to stop running and wait until it's okay to continue once again.</p>
<p>Remember: running asynchronous code without any special considerations can cause incorrect assertions to appear in other tests, so we want to make sure we get it right.</p>
<p>Writing QUnit tests for asynchronous code is made possible using the <code>start()</code> and <code>stop()</code> methods, which programmatically set the start and stop points during such tests. Here's a simple example:</p>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'An async test'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
         <span class="nx">stop</span><span class="p">();</span>
         <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
         <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'/test'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'json'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">data</span> <span class="p">){</span>
                  <span class="nx">deepEqual</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
                     <span class="nx">topic</span><span class="o">:</span> <span class="s1">'hello'</span><span class="p">,</span>
                     <span class="nx">message</span><span class="o">:</span> <span class="s1">'hi there!'</span><span class="err">'</span>
                  <span class="p">});</span>
                  <span class="nx">start</span><span class="p">();</span>
              <span class="p">}</span>
          <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<p>A jQuery <code>$.ajax()</code> request is used to connect to a test resource and assert that the data returned is correct. <code>deepEqual()</code> is used here as it allows us to compare different data types (e.g objects, arrays) and ensures that what is returned is exactly what we're expecting. We know that our Ajax request is asynchronous and so we first call <code>stop()</code>, run the code making the request and finally at the very end of our callback, inform QUnit that it is okay to continue running other tests.</p>
<p>Note: rather than including <code>stop()</code>, we can simply exclude it and substitute <code>test()</code> with <code>asyncTest()</code> if we prefer. This improves readability when dealing with a mixture of asynchronous and synchronous tests in your suite. Whilst this setup should work fine for many use-cases, there is no guarantee that the callback in our <code>$.ajax()</code> request will actually get called. To factor this into our tests, we can use <code>expect()</code> once again to define how many assertions we expect to see within our test. This is a healthy safety blanket as it ensures that if a test completes with an insufficient number of assertions, we know something went wrong and fix it.</p>
<h1>
      <a name="user-content-sinonjs" class="anchor" href="#sinonjs"><span class="octicon octicon-link"></span></a>SinonJS</h1>
<p>Similar to the section on testing Backbone.js apps using the Jasmine BDD framework, we're nearly ready to take what we've learned and write a number of QUnit tests for our Todo application.</p>
<p>Before we start though, you may have noticed that QUnit doesn't support test spies. Test spies are functions which record arguments, exceptions and return values for any of their calls. They're typically used to test callbacks and how functions may be used in the application being tested. In testing frameworks, spies can usually be either anonymous functions or wrap functions which already exist.</p>
<h2>
      <a name="user-content-what-is-sinonjs" class="anchor" href="#what-is-sinonjs"><span class="octicon octicon-link"></span></a>What is SinonJS?</h2>
<p>In order for us to substitute support for spies in QUnit, we will be taking advantage of a mocking framework called <a href="http://sinonjs.org/">SinonJS</a> by Christian Johansen. We will also be using the <a href="http://sinonjs.org/qunit/">SinonJS-QUnit adapter</a> which provides seamless integration with QUnit (meaning setup is minimal). Sinon.JS is completely test-framework agnostic and should be easy to use with any testing framework, so it's ideal for our needs.</p>
<p>The framework supports three features we'll be taking advantage of for unit testing our application:</p>
<ul>
<li><strong>Anonymous spies</strong></li>
      <li><strong>Spying on existing methods</strong></li>
      <li><strong>A rich inspection interface</strong></li>
      </ul>
<p>Using <code>this.spy()</code> without any arguments creates an anonymous spy. This is comparable to <code>jasmine.createSpy()</code> and we can observe basic usage of a SinonJS spy in the following example:</p>
<h4>
      <a name="user-content-basic-spies" class="anchor" href="#basic-spies"><span class="octicon octicon-link"></span></a>Basic Spies:</h4>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers for a message exactly once'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'Hello World'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'the subscriber was called once'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>We can also use <code>this.spy()</code> to spy on existing functions (like jQuery's <code>$.ajax</code>) in the example below. When spying on a function which already exists, the function behaves normally but we get access to data about its calls which can be very useful for testing purposes.</p>
<h4>
      <a name="user-content-spying-on-existing-functions" class="anchor" href="#spying-on-existing-functions"><span class="octicon octicon-link"></span></a>Spying On Existing Functions:</h4>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'should inspect jQuery.getJSON'</span><span class="nx">s</span> <span class="nx">usage</span> <span class="nx">of</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="s1">', function () {</span>
      <span class="s1">    this.spy( jQuery, '</span><span class="nx">ajax</span><span class="s1">' );</span>

      <span class="s1">    jQuery.getJSON( '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>

      <span class="s1">    ok( jQuery.ajax.calledOnce );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].url, '</span><span class="o">/</span><span class="nx">todos</span><span class="o">/</span><span class="nx">completed</span><span class="s1">' );</span>
      <span class="s1">    equals( jQuery.ajax.getCall(0).args[0].dataType, '</span><span class="nx">json</span><span class="err">'</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>SinonJS comes with a rich spy interface which allows us to test whether a spy was called with a specific argument, if it was called a specific number of times and test against the values of arguments. A complete list of features supported in the interface can be found here (<a href="http://sinonjs.org/docs/">http://sinonjs.org/docs/</a>), but let's take a look at some examples demonstrating some of the most commonly used ones:</p>
<h4>
      <a name="user-content-matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments" class="anchor" href="#matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments"><span class="octicon octicon-link"></span></a>Matching arguments: test a spy was called with a specific set of arguments:</h4>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with standard matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others" class="anchor" href="#stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others"><span class="octicon octicon-link"></span></a>Stricter argument matching: test a spy was called at least once with specific arguments and no others:</h4>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber with strict matching'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="s1">'many'</span><span class="p">,</span> <span class="s1">'arguments'</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">34</span> <span class="p">);</span>

          <span class="c1">// This passes</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWith</span><span class="p">(</span><span class="s1">'many'</span><span class="p">)</span> <span class="p">);</span>

          <span class="c1">// This however, fails</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledWithExactly</span><span class="p">(</span> <span class="s1">'many'</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy" class="anchor" href="#testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy"><span class="octicon octicon-link"></span></a>Testing call order: testing if a spy was called before or after another spy:</h4>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and maintain call order'</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">a</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="nx">b</span> <span class="p">);</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">45</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'event'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">);</span>

          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">a</span><span class="p">.</span><span class="nx">calledBefore</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">);</span>
          <span class="nx">assertTrue</span><span class="p">(</span> <span class="nx">b</span><span class="p">.</span><span class="nx">calledAfter</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h4>
      <a name="user-content-match-execution-counts-test-a-spy-was-called-a-specific-number-of-times" class="anchor" href="#match-execution-counts-test-a-spy-was-called-a-specific-number-of-times"><span class="octicon octicon-link"></span></a>Match execution counts: test a spy was called a specific number of times:</h4>
<pre><span class="nx">test</span><span class="p">(</span> <span class="s1">'Should call a subscriber and check call counts'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">getUniqueString</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="s1">'some payload'</span> <span class="p">);</span>


          <span class="c1">// Passes if spy was called once and only once.</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span> <span class="c1">// calledTwice and calledThrice are also supported</span>

          <span class="c1">// The number of recorded calls.</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="c1">// Directly checking the arguments of the call</span>
          <span class="nx">equals</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">message</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-stubs-and-mocks" class="anchor" href="#stubs-and-mocks"><span class="octicon octicon-link"></span></a>Stubs and mocks</h2>
<p>SinonJS also supports two other powerful features which are useful to be aware of: stubs and mocks. Both stubs and mocks implement all of the features of the spy API, but have some added functionality.</p>
<h3>
      <a name="user-content-stubs" class="anchor" href="#stubs"><span class="octicon octicon-link"></span></a>Stubs</h3>
<p>A stub allows us to replace any existing behaviour for a specific method with something else. They can be very useful for simulating exceptions and are most often used to write test cases when certain dependencies of your code-base may not yet be written.</p>
<p>Let us briefly re-explore our Backbone Todo application, which contained a Todo model and a TodoList collection. For the purpose of this walkthrough, we want to isolate our TodoList collection and fake the Todo model to test how adding new models might behave.</p>
<p>We can pretend that the models have yet to be written just to demonstrate how stubbing might be carried out. A shell collection just containing a reference to the model to be used might look like this:</p>
<pre><span class="kd">var</span> <span class="nx">TodoList</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
          <span class="nx">model</span><span class="o">:</span> <span class="nx">Todo</span>
      <span class="p">});</span>

      <span class="c1">// Let's assume our instance of this collection is</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">;</span>
      </pre>
<p>Assuming our collection is instantiating new models itself, it's necessary for us to stub the models constructor function for the the test. This can be done by creating a simple stub as follows:</p>
<pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span> <span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span> <span class="p">);</span>
      </pre>
<p>The above creates a stub of the Todo method on the window object. When stubbing a persistent object, it's necessary to restore it to its original state. This can be done in a <code>teardown()</code> as follows:</p>
<pre><span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
      </pre>
<p>After this, we need to alter what the constructor returns, which can be efficiently done using a plain <code>Backbone.Model</code> constructor. Whilst this isn't a Todo model, it does still provide us an actual Backbone model.</p>
<pre><span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<p>The expectation here might be that this snippet would ensure our TodoList collection always instantiates a stubbed Todo model, but because a reference to the model in the collection is already present, we need to reset the model property of our collection as follows:</p>
<pre><span class="k">this</span><span class="p">.</span><span class="nx">todoList</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
      </pre>
<p>The result of this is that when our TodoList collection instantiates new Todo models, it will return our plain Backbone model instance as desired. This allows us to write a spec for testing the addition of new model literals as follows:</p>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'Should function when instantiated with model literals'</span><span class="p">,</span> <span class="p">{</span>

        <span class="nx">setup</span><span class="o">:</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">'Todo'</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">returns</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>

          <span class="c1">// Let's reset the relationship to use a stub</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">Todo</span><span class="p">;</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
            <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nx">title</span><span class="o">:</span> <span class="s1">'Hello world'</span>
          <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">todoStub</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
        <span class="p">}</span>

      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should add a model'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'should find a model by id'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">),</span> <span class="mi">5</span> <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-mocks" class="anchor" href="#mocks"><span class="octicon octicon-link"></span></a>Mocks</h3>
<p>Mocks are effectively the same as stubs, however they mock a complete API out and have some built-in expectations for how they should be used. The difference between a mock and a spy is that as the expectations for their use are pre-defined, it will fail if any of these are not met.</p>
<p>Here's a snippet with sample usage of a mock based on PubSubJS. Here, we have a <code>clearTodo()</code> method as a callback and use mocks to verify its behavior.</p>
<pre><span class="nx">test</span><span class="p">(</span><span class="s1">'should call all subscribers when exceptions'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">myAPI</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">clearTodo</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span> <span class="p">};</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">mock</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span> <span class="nx">myAPI</span> <span class="p">);</span>
          <span class="nx">mock</span><span class="p">.</span><span class="nx">expects</span><span class="p">(</span> <span class="s1">'clearTodo'</span> <span class="p">).</span><span class="nx">once</span><span class="p">().</span><span class="kr">throws</span><span class="p">();</span>

          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">myAPI</span><span class="p">.</span><span class="nx">clearTodo</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="nx">PubSub</span><span class="p">.</span><span class="nx">publishSync</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>

          <span class="nx">mock</span><span class="p">.</span><span class="nx">verify</span><span class="p">();</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-practical-3" class="anchor" href="#practical-3"><span class="octicon octicon-link"></span></a>Practical</h2>
<p>We can now begin writing test specs for our Todo application, which are listed and separated by component (e.g Models, Collections etc.). It's useful to pay attention to the name of the test, the logic being tested and most importantly the assertions being made as this will give you some insight into how what we've learned can be applied to a complete application.</p>
<p>To get the most out of this section, I recommend looking at the QUnit Koans included in the <code>practicals\qunit-koans</code> folder - this is a port of the Backbone.js Jasmine Koans over to QUnit that I converted for this post.</p>
<p><em>In case you haven't had a chance to try out one of the Koans kits as yet, they are a set of unit tests using a specific testing framework that both demonstrate how a set of specs for an application may be written, but also leave some tests unfilled so that you can complete them as an exercise.</em></p>
<h3>
      <a name="user-content-models-3" class="anchor" href="#models-3"><span class="octicon octicon-link"></span></a>Models</h3>
<p>For our models we want to at minimum test that:</p>
<ul>
<li>New instances can be created with the expected default values</li>
      <li>Attributes can be set and retrieved correctly</li>
      <li>Changes to state correctly fire off custom events where needed</li>
      <li>Validation rules are correctly enforced</li>
      </ul>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Model'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can be created with default values for its attributes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">''</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will set attributes on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Get oil change for car.'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Get oil change for car.'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'order'</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Will call a custom initialize function on the model instance when created.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">toot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">({</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Stop monkeys from throwing their own crap!'</span> <span class="p">});</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">toot</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'text'</span><span class="p">),</span> <span class="s1">'Stop monkeys from throwing their own rainbows!'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires a custom event when the state changes.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'change'</span><span class="p">,</span> <span class="nx">spy</span> <span class="p">);</span>
          <span class="c1">// How would you update a property on the todo here?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Model-set</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'new text'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'A change event callback was correctly triggered'</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can contain custom validation rules, and will trigger an error event on failed validation.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">errorCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">todo</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">();</span>

          <span class="nx">todo</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">errorCallback</span><span class="p">);</span>
          <span class="c1">// What would you need to set on the todo properties to cause validation to fail?</span>
          <span class="nx">todo</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">{</span> <span class="nx">done</span><span class="o">:</span> <span class="s1">'not a boolean'</span> <span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">called</span><span class="p">,</span> <span class="s1">'A failed validation correctly triggered an error'</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">errorCallback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'Todo.done must be a boolean value.'</span> <span class="p">);</span>

      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-collections-3" class="anchor" href="#collections-3"><span class="octicon octicon-link"></span></a>Collections</h3>
<p>For our collection we'll want to test that:</p>
<ul>
<li>New model instances can be added as both objects and arrays</li>
      <li>Changes to models result in any necessary custom events being fired</li>
      <li>A <code>url</code> property for defining the URL structure for models is correctly defined</li>
      </ul>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Collection'</span><span class="p">);</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can add Model instances as objects and arrays.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">3</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Clean the kitchen'</span> <span class="p">}</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">([</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Do the laundry'</span><span class="p">,</span> <span class="nx">done</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
              <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s1">'Go to the gym'</span> <span class="p">}</span>
          <span class="p">]);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Can have a url property to define the basic url structure for all contained models.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="s1">'/todos/'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Fires custom named events when the models change.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">todos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoList</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">addModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">removeModelCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'add'</span><span class="p">,</span> <span class="nx">addModelCallback</span> <span class="p">);</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'remove'</span><span class="p">,</span> <span class="nx">removeModelCallback</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'add' event to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span><span class="s1">'New todo'</span><span class="p">}</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">addModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How would you get the 'remove' callback to trigger?</span>
          <span class="nx">todos</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">last</span><span class="p">()</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">removeModelCallback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-views-4" class="anchor" href="#views-4"><span class="octicon octicon-link"></span></a>Views</h3>
<p>For our views we want to ensure:</p>
<ul>
<li>They are being correctly tied to a DOM element when created</li>
      <li>They can render, after which the DOM representation of the view should be visible</li>
      <li>They support wiring up view methods to DOM elements</li>
      </ul>
<p>One could also take this further and test that user interactions with the view correctly result in any models that need to be changed being updated correctly.</p>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.View'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'body'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;ul id="todoList"&gt;&lt;/ul&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoView</span><span class="p">({</span> <span class="nx">model</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Todo</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">},</span>
          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should be tied to a DOM element when created, based off the property provided.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="s1">'li'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Is backed by a model instance, which provides the data.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can render, after which the DOM representation of the view will be visible.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

          <span class="c1">// Hint: render() just builds the DOM representation of the view, but doesn't insert it into the DOM.</span>
          <span class="c1">//       How would you append it to the ul#todoList?</span>
          <span class="c1">//       How do you access the view's DOM representation?</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#View-el</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'ul#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'li'</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">asyncTest</span><span class="p">(</span><span class="s1">'Can wire up view methods to DOM elements.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="kd">var</span> <span class="nx">viewElt</span><span class="p">;</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span> <span class="p">);</span>

          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">viewElt</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="s1">':first'</span><span class="p">);</span>

              <span class="nx">equal</span><span class="p">(</span><span class="nx">viewElt</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

              <span class="c1">// Make sure that QUnit knows we can continue</span>
              <span class="nx">start</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'Expected DOM Elt to exist'</span><span class="p">);</span>


          <span class="c1">// Hint: How would you trigger the view, via a DOM Event, to toggle the 'done' status.</span>
          <span class="c1">//       (See todos.js line 70, where the events hash is defined.)</span>
          <span class="c1">//</span>
          <span class="c1">// Hint: http://api.jquery.com/click</span>

          <span class="nx">$</span><span class="p">(</span><span class="s1">'#todoList li input.check'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoView</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'done'</span><span class="p">),</span> <span class="kc">true</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-event" class="anchor" href="#event"><span class="octicon octicon-link"></span></a>Event</h3>
<p>For events, we may want to test a few different use cases:</p>
<ul>
<li>Extending plain objects to support custom events</li>
      <li>Binding and triggering custom events on objects</li>
      <li>Passing along arguments to callbacks when events are triggered</li>
      <li>Binding a passed context to an event callback</li>
      <li>Removing custom events</li>
      </ul>
<p>and a few others that will be detailed in our module below:</p>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone.Events'</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">();</span> <span class="c1">// remove all custom events before each spec is run.</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can extend JavaScript objects to support custom events.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">basicObject</span> <span class="o">=</span> <span class="p">{};</span>

          <span class="c1">// How would you give basicObject these functions?</span>
          <span class="c1">// Hint: http://documentcloud.github.com/backbone/#Events</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">basicObject</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">on</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">off</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">basicObject</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="s1">'function'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Allows us to bind and trigger custom named events on an object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'basic event'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'basic event'</span> <span class="p">);</span>

          <span class="c1">// How would you cause the callback for this custom event to be called?</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also passes along any arguments to the callback when an event is triggered.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">passedArgs</span> <span class="o">=</span> <span class="p">[];</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'some event'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">passedArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">);</span>
              <span class="p">}</span>
          <span class="p">});</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'some event'</span><span class="p">,</span> <span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span> <span class="p">);</span>

          <span class="nx">deepEqual</span><span class="p">(</span> <span class="nx">passedArgs</span><span class="p">,</span> <span class="p">[</span><span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'arg2'</span><span class="p">]</span> <span class="p">);</span>
      <span class="p">});</span>


      <span class="nx">test</span><span class="p">(</span><span class="s1">'Can also bind the passed context to the event callback.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">'blue'</span> <span class="p">};</span>
          <span class="kd">var</span> <span class="nx">changeColor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="s1">'red'</span><span class="p">;</span>
          <span class="p">};</span>

          <span class="c1">// How would you get 'this.color' to refer to 'foo' in the changeColor function?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'an event'</span><span class="p">,</span> <span class="nx">changeColor</span><span class="p">,</span> <span class="nx">foo</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'an event'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">'red'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Uses `all` as a special event name to capture all events bound to the object.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'all'</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'custom event 2'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">getCall</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'custom event 1'</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Also can remove custom events from objects.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>

          <span class="kd">var</span> <span class="nx">spy1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">spy3</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>

          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'bar'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy2</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy3</span> <span class="p">);</span>

          <span class="c1">// How do you unbind just a single callback for the event?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="nx">spy1</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">called</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks tied to the event with a single method</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'foo'</span> <span class="p">);</span>

          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy2</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 2 called once'</span> <span class="p">);</span>
          <span class="nx">ok</span><span class="p">(</span> <span class="nx">spy3</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">,</span> <span class="s1">'Spy 3 called once'</span> <span class="p">);</span>

          <span class="c1">// How do you unbind all callbacks and events tied to the object with a single method?</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s1">'bar'</span> <span class="p">);</span>

          <span class="nx">equal</span><span class="p">(</span> <span class="nx">spy1</span><span class="p">.</span><span class="nx">callCount</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>
      </pre>
<h3>
      <a name="user-content-app" class="anchor" href="#app"><span class="octicon octicon-link"></span></a>App</h3>
<p>It can also be useful to write specs for any application bootstrap you may have in place. For the following module, our setup initiates and appends a TodoApp view and we can test anything from local instances of views being correctly defined to application interactions correctly resulting in changes to instances of local collections.</p>
<pre><span class="nx">module</span><span class="p">(</span> <span class="s1">'About Backbone Applications'</span> <span class="p">,</span> <span class="p">{</span>
          <span class="nx">setup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">Backbone</span><span class="p">.</span><span class="nx">localStorageDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">'testTodos'</span><span class="p">);</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'#qunit-fixture'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;div id="app"&gt;&lt;/div&gt;'</span><span class="p">);</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TodoApp</span><span class="p">({</span> <span class="nx">appendTo</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">)</span> <span class="p">});</span>
          <span class="p">},</span>

          <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">'# &lt;app'</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
          <span class="p">}</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span><span class="s1">'Should bootstrap the application by initializing the Collection.'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span> <span class="mi">2</span> <span class="p">);</span>

          <span class="nx">notEqual</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">,</span> <span class="kc">undefined</span> <span class="p">);</span>
          <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">test</span><span class="p">(</span> <span class="s1">'Should bind Collection events to View creation.'</span> <span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span> <span class="s1">'Foo'</span> <span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">'#new-todo'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="k">new</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span> <span class="s1">'keypress'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">keyCode</span><span class="o">:</span> <span class="mi">13</span> <span class="p">}</span> <span class="p">));</span>

            <span class="nx">equal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">App</span><span class="p">.</span><span class="nx">todos</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
       <span class="p">});</span>
      </pre>
<h2>
      <a name="user-content-further-reading--resources" class="anchor" href="#further-reading--resources"><span class="octicon octicon-link"></span></a>Further Reading &amp; Resources</h2>
<p>That's it for this section on testing applications with QUnit and SinonJS. I encourage you to try out the <a href="https://github.com/addyosmani/backbone-koans-qunit">QUnit Backbone.js Koans</a> and see if you can extend some of the examples. For further reading consider looking at some of the additional resources below:</p>
<ul>
<li><strong><a href="http://tddjs.com/">Test-driven JavaScript Development (book)</a></strong></li>
      <li><strong><a href="http://sinonjs.org/qunit/">SinonJS/QUnit Adapter</a></strong></li>
      <li><strong><a href="http://cjohansen.no/en/javascript/using_sinon_js_with_qunit">SinonJS and QUnit</a></strong></li>
      <li><strong><a href="http://msdn.microsoft.com/en-us/scriptjunkie/gg749824">Automating JavaScript Testing With QUnit</a></strong></li>
      <li><strong><a href="http://benalman.com/talks/unit-testing-qunit.html">Ben Alman's Unit Testing With QUnit</a></strong></li>
      <li><strong><a href="https://github.com/jc00ke/qunit-backbone">Another QUnit/Backbone.js demo project</a></strong></li>
      <li><strong><a href="http://devblog.supportbee.com/2012/02/10/helpers-for-testing-backbone-js-apps-using-jasmine-and-sinon-js/">SinonJS helpers for Backbone</a></strong></li>
      </ul>
<h1>
      <a name="user-content-resources" class="anchor" href="#resources"><span class="octicon octicon-link"></span></a>Resources</h1>
<p>Whilst what we get with Backbone out of the box can be terribly useful, there are some equally beneficial add-ons that can help simplify our development process. These include:</p>
<ul>
<li><a href="https://github.com/derickbailey/backbone.marionette">Backbone Marionette</a></li>
      <li><a href="https://github.com/tbranyen/backbone.layoutmanager">Backbone Layout Manager</a></li>
      <li><a href="https://github.com/backbone-boilerplate/backbone-boilerplate">Backbone Boilerplate</a></li>
      <li><a href="https://github.com/derickbailey/backbone.modelbinding">Backbone Model Binding</a></li>
      <li><a href="https://github.com/PaulUithol/Backbone-relational">Backbone Relational - for model relationships</a></li>
      <li><a href="https://github.com/janmonschke/backbone-couchdb">Backbone CouchDB</a></li>
      <li><a href="https://github.com/n-time/backbone.validations">Backbone Validations - HTML5 inspired validations</a></li>
      </ul>
<p>In time, there will be tutorials in the book covering some of these resources but until then, please feel free to check them out.</p>
<h1>
      <a name="user-content-conclusions-4" class="anchor" href="#conclusions-4"><span class="octicon octicon-link"></span></a>Conclusions</h1>
<p>That's it for 'Developing Backbone.js Applications'. I hope you found this book both useful, enlightening and a good start for your journey into exploring Backbone.js.</p>
<p>If there are other topics or areas of this book you feel could be expanded further, please feel free to let me know, or better yet, send a pull request upstream. I'm always interested in making this title as comprehensive as possible.</p>
<p>Until next time, the very best of luck with the rest of your journey!</p>
<h2>
      <a name="user-content-notes" class="anchor" href="#notes"><span class="octicon octicon-link"></span></a>Notes</h2>
<p>I would like to thank the Backbone.js, Stack Overflow, DailyJS (Alex Young) and JavaScript communities for their help, references and contributions to this book. This project would not be possible without you so thank you! :)</p>
<hr>
<p>Where relevant, copyright Addy Osmani, 2012.</p>
</div></article>

    </div>
  </div>

</body>
</html>
