apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../base/production/unicorn/
  - poddisruptionbudgets/unicorn.yaml


patchesJson6902:
  - target:
      kind: Deployment
      name: unicorn
    patch: |-
        - op: add
          path: /metadata/annotations/moda.github.net~1allow-missing-ready-pods
          value: 4
        # If you're decreasing this value, make sure to also update the
        # corresponding `acl site_dead` configuration in the kube-dotcom-ingress
        # repo
        # (https://github.com/github/kube-dotcom-ingress/blob/main/config/helm/production/haproxytech-ingress-dotcom-unicorn.yaml)
        # and deploy that change first. Reach out to #service-mesh for guidance.
        - op: replace
          path: /spec/replicas
          value: 100
        - op: replace
          path: /spec/template/spec/containers/2/resources/requests/cpu
          value: 11.5
        - op: replace
          path: /spec/template/spec/containers/2/resources/requests/memory
          value: 26Gi
        - op: replace
          path: /spec/template/spec/containers/2/resources/limits/memory
          value: 26Gi
        - op: add
          path: /metadata/annotations/moda.github.net~1canary-v2
          value: "true"
        - op: add
          path: /metadata/annotations/moda.github.net~1canary-label
          value: "role"
        # If you're decreasing this value, make sure to also update the
        # corresponding `acl site_dead` configuration in the kube-dotcom-ingress
        # repo
        # (https://github.com/github/kube-dotcom-ingress/blob/main/config/helm/production/haproxytech-ingress-dotcom-unicorn-canary.yaml)
        # and deploy that change first. Reach out to #service-mesh for guidance.
        - op: add
          path: /metadata/annotations/moda.github.net~1canary-replicas
          value: "6"
        - op: add
          path: /metadata/annotations/moda.github.net~1canary-maxunavailable
          value: "1"
  - target:
      kind: Service
      name: unicorn
    patch: |-
        - op: add
          path: /metadata/annotations/moda.github.net~1canary-v2
          value: "true"
