#!/bin/bash
#/ Usage: ghe-actions-cache-enable [-hf]
#/
#/ Enable Actions Cache service in GHES and start nomad jobs.
#/ When provided with --force parameter, check for the current state of the service is ignored
#/
#/ OPTIONS:
#/   -h  | --help            Show this message
#/   -y  | --yes             Do not show the warning prompt.
#/   -f  | --force           When set, check for the current state of the service is ignored
#/

force=false
prompt_less=
usage() {
    grep '^#/' < "$0" | cut -c 4-
    exit 2
}

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            usage
            ;;
        -y|--yes)
            prompt_less=1
            shift
            ;;
        -f|--force)
            force=true
            shift
            ;;
        *)
            >&2 echo "Unrecognized argument: $1"
            usage
            ;;
    esac
done

proceed() {
    if [ -z "$prompt_less" ]; then
        read -p "Enabling Actions Cache service will take a few minutes. Continue? [y/N] " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

REPL_STATE=$(cat /etc/github/repl-state 2>/dev/null)
if [ "$REPL_STATE" = "replica" ]; then
    echo "Running on Replica.  Skipping."
    exit 0
fi

if ! $force; then
    ghe-actions-check -a 1 -s "artifactcache" >/dev/null 2>&1
    retval=$?
    if [ "$retval" = 0 ]; then
        echo "Exiting because Actions Cache is already running."
        exit 1
    fi
fi

proceed

ghe-config app.actions.artifactcache.enabled true
ghe-config-apply