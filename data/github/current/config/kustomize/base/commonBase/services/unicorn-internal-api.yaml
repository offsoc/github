# https://github.com/github/kube/blob/master/docs/kubernetes/resources/service.md
apiVersion: v1
kind: Service
metadata:
  name: unicorn-internal-api
  labels:
    service: unicorn-internal-api
  annotations:
    # These annotations tell Moda to export metadata about this service to
    # consul (via github/kube-service-exporter) so GLB knows how to include it.
    moda.github.net/domain-name: "internal-api.service.%site%.github.net,internal-api.service.%region%.github.net"
    moda.github.net/dns-registration-enabled: "false"
    moda.github.net/load-balancer-type: "internal-http"
    haproxy.org/check-interval: "5s"
    opaque.github.net/checks: |
        - http:
            url: "https://{{.Instance.Name}}/rate_limit"
            header:
                authorization: "Bearer {{ .Env.GITHUB_API_TOKEN }}"
          tags:
              - "api-type:unicorn-internal-api"
              - "dotcom-api:true"
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
    # Used to connect this service to GLB.
    nodePort: 32019
  selector:
    service: unicorn-internal-api
  type: LoadBalancer
