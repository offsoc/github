#!/bin/bash
#/ Usage: ghe-repo REPO
#/        ghe-repo REPO -c COMMAND-STRING
#/        ghe-repo REPO [--] COMMAND
#/
#/ Run a command or open a shell in a local github repository as the
#/ `git` user.
#/
#/ Options:
#/
#/ -c COMMAND-STRING
#/   COMMAND-STRING is a shell snippet as a single string, to be
#/   interpreted within the repository using bash; e.g.,
#/
#/       ghe-repo torvalds/linux -c 'git fsck | grep -v dangling'
#/
#/ COMMAND
#/   COMMAND is a command and its arguments, as separate words (not
#/   subject to further shell interpretation); e.g.,
#/
#/       ghe-repo rails/rails -- git nw-info -a
#/
#/ The REPO argument may take any of the following forms to
#/ distinguish between normal repositories, wikis, and gists:
#/
#/   user/repo        A normal repository.
#/   user/repo.wiki   A wiki repository.
#/   gist/id          A gist repository.

set -euo pipefail

# only run on cluster nodes with git-daemon service enabled (or standalone VMs)
if ! /usr/local/share/enterprise/ghe-service-enabled git-daemon; then
    echo 1>&2 "error: cannot use this command on a cluster node with no git-server role"
    exit 1
fi

github-env -i /usr/local/share/enterprise/ghe-repo-backend "$@"
