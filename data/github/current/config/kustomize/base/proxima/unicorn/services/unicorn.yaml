apiVersion: v1
kind: Service
metadata:
  name: unicorn
  labels:
    service: unicorn
  annotations:
    # These annotations tell Moda to export metadata about this service to
    # consul (via github/kube-service-exporter) so GLB knows how to include it.
    # The domain-name value here is not used anywhere, but necessary to enable
    # this feature.
    moda.github.net/domain-name: "github.com"
    moda.github.net/dns-registration-enabled: "false"
    moda.github.net/load-balancer-type: glb-http:dotcom
    # include endpoints from this service in the haproxytech ingress controller
    kubernetes.io/ingress.class: haproxytech-unicorn
    # add backend-specific configuration to the haproxytech ingress controller
    haproxy.org/load-balance: leastconn
    haproxy.org/check-interval: "5s"
    # use http health checks for upstream. Set host header to github.com so we
    # can use the `/site/sha` endpoint, which is much lighter than `/status`
    haproxy.org/backend-config-snippet: |-
      option redispatch 1
      option httpchk
      http-check connect
      http-check send meth GET uri /site/sha ver HTTP/1.1 hdr host github.com
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    service: unicorn
    deployGroup: production
  type: LoadBalancer
