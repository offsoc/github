#!/bin/bash

set -e

[ -f /etc/inside-container ] || exec script/app-env "$0" "$@"

if ! [ -d /aqueduct ]; then
  echo "/aqueduct not mounted, there should be an aqueduct checkout in the same parent folder as this project."
  exit 1
fi

export PATH=/root/go/bin:"${PATH}"

branch=$(cd ../aqueduct && git rev-parse --abbrev-ref HEAD)
sha=$(cd ../aqueduct && git rev-parse --short HEAD)

echo "generating protobuf and twirp API from aqueduct $branch ($sha)"

set -x
protoc --proto_path=/aqueduct/api/src/main/proto --ruby_out=lib --twirp_ruby_out=lib /aqueduct/api/src/main/proto/aqueduct/api/v1/api.proto
