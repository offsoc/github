#!/bin/bash

# This script is a standardized hook used to update the pinned version of
# a subcomponent that is used by this repo. All repositories with a pinned
# subcomponent use a script conforming to this interface so they can be updated
# from an action like this:
# https://github.com/github/git/blob/github/.github/workflows/gitversions.yaml
#
# input: The version of the subcomponent in sha1 and .deb format [1] that
#        should be used by this repo, the deb version will be generated by
#        https://github.com/github/<subcomponent>/blob/github/script/pkgvars
#        (eg. 3:1~znull-foo-2.30.0-3172-g2ff1cad44179). The corresponding
#        subcomponent sha is extracted from the Actions Workflow mentioned above
#        in github/<subcomponent>.
#
#        [1] If you do not want to set one or the other, then pass an empty
#        string.
#
# output: The corresponding files in this repository are updated, and if
#         changed, a commit is made on the current branch. The script returns
#         zero if a new commit was successfully created, nonzero otherwise.

repo=$1
git_sha=$2
deb_version=$3
deb_version_file=config/versions/github/$repo.deb
version_file=config/$repo-version
commit_msg="bump pinned $repo version to"

if [ "$#" -ne 3 ]; then
    echo "usage: $(basename $0) <repo> <git hash> <deb version>"
    exit 1
fi

set -e

cd "$(dirname "$0")/.."
cd "$(pwd -P)"

if [[ -f "$deb_version_file" && ( $deb_version =~ [0-9].*-g[0-9a-f]+$ || $deb_version =~ [0-9].*-g[0-9a-f]+\+github[0-9] ) ]]; then
    commit_msg="$commit_msg $deb_version"
    cat > $deb_version_file <<EOF
# This is the package that gets installed in GHES, as well as
# used in development environments and CI.
# https://github.com/github/git-systems/blob/main/docs/package-pinning.md
$deb_version
EOF
fi

if [[ -f "$version_file" && $git_sha =~ [0-9a-f]+$ ]]; then
    commit_msg="$commit_msg $git_sha"
    cat > $version_file <<EOF
# This is the package that gets installed in GHES, as well as
# used in development environments and CI.
# https://github.com/github/git-systems/blob/main/docs/package-pinning.md
$git_sha
EOF
fi

git add $deb_version_file $version_file

if ! git diff --cached --name-status --exit-code $deb_version_file $version_file; then
    git commit -m "$commit_msg" $deb_version_file $version_file
else
    exit 1
fi
