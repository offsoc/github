"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["flamegraph"],{48383:(e,t,i)=>{let s=class EventSource{on(e,t){let i=this.eventListeners[e];i||(i=this.eventListeners[e]=[]),i.push(t)}dispatch(e,t){for(let i of this.eventListeners[e]||[])requestAnimationFrame(()=>i(t))}constructor(){this.eventListeners={}}},a=class CanvasView extends s{setDimensions(e,t){null!=this.resizeRequestID&&cancelAnimationFrame(this.resizeRequestID),this.resizeRequestID=requestAnimationFrame(()=>{this.setDimensionsNow(e,t)})}setDimensionsNow(e,t){if(e===this.width&&t===this.height)return;this.width=e,this.height=t,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`;let i=window.devicePixelRatio||1;this.canvas.width=e*i,this.canvas.height=t*i;let s=this.canvas.getContext("2d");s.setTransform(1,0,0,1,0,0),s.scale(i,i),this.repaintNow()}paint(){}scheduleRepaint(){null==this.repaintRequestID&&(this.repaintRequestID=requestAnimationFrame(()=>{this.repaintRequestID=null,this.repaintNow()}))}repaintNow(){this.canvas.getContext("2d").clearRect(0,0,this.width,this.height),this.paint(),null!=this.repaintRequestID&&(cancelAnimationFrame(this.repaintRequestID),this.repaintRequestID=null)}constructor(e){super(),this.canvas=e,this.width=0,this.height=0}},n=class Flamechart extends a{xScale(e){return this.widthScale(e-this.viewport.x)}yScale(e){return this.heightScale(e-this.viewport.y)}widthScale(e){return e*this.width/this.viewport.width}heightScale(e){return e*this.height/this.viewport.height}frameRect(e){return{x:e.x,y:e.y,width:e.width,height:1}}dataToCanvas(e){return{x:this.xScale(e.x),y:this.yScale(e.y),width:this.widthScale(e.width),height:this.heightScale(e.height)}}setViewport(e){(this.viewport.x!==e.x||this.viewport.y!==e.y||this.viewport.width!==e.width||this.viewport.height!==e.height)&&(this.viewport=e,this.scheduleRepaint(),this.dispatch("viewportchanged",{current:e}))}paint(e,t,i){let s=this.canvas.getContext("2d");s.strokeStyle="rgba(0, 0, 0, 0.2)";let a=0;this.showLabels&&(s.textBaseline="middle",s.font=`11px ${getComputedStyle(this.canvas).fontFamily}`,a=s.measureText("WWWW").width/4),null==e&&(e=1);let n={};for(let s of(t=t||this.data)||[]){if(i&&s.gemName!==i)continue;let t=this.dataToCanvas(this.frameRect(s));if(t.x>=this.width||t.y>=this.height||t.x+t.width<=0||t.y+t.height<=0)continue;let a=u(this.info[s.frame_id].color,e),h=n[a];h||(h=n[a]=[]),h.push({rect:t,text:s.frame})}let h=[];for(let t of Object.keys(n))for(let i of(s.fillStyle=t,n[t]))e<1&&s.clearRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height),s.fillRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height),i.rect.width>4&&i.rect.height>4&&s.strokeRect(i.rect.x,i.rect.y,i.rect.width,i.rect.height),this.showLabels&&!(i.rect.width/a<4)&&h.push(i);for(let e of(s.fillStyle="#000",h)){let t=e.text,i=Object.assign({},e.rect);i.x+=1,i.width-=2,i.width<t.length*a*.75&&(t=function(e,t){let i=t-1;if(i<=0)return"";if(e.length<=i)return e;let s=Math.ceil(i/2),a=i-s;return[e.substr(0,s),"\u2026",a>0?e.substr(-a):""].join("")}(e.text,Math.floor(i.width/a))),s.fillText(t,i.x,i.y+i.height/2,i.width)}}frameAtPoint(e,t){return this.data.find(i=>{let s=this.dataToCanvas(this.frameRect(i));return s.x<=e&&s.x+s.width>=e&&s.y<=t&&s.y+s.height>=t})}constructor(e,t,i,s){super(e),this.data=t,this.dataRange=i,this.info=s,this.viewport={x:i.minX,y:i.minY,width:i.maxX-i.minX,height:i.maxY-i.minY}}},h=class MainFlamechart extends n{setDimensionsNow(e,t){let i=Object.assign({},this.viewport);i.height=t/16,this.setViewport(i),super.setDimensionsNow(e,t)}onMouseDown(e){if(0!==e.button)return;d({mouseup:this.onMouseUp.bind(this),mousemove:this.onMouseMove.bind(this)});let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;this.dragging=!0,this.dragInfo={mouse:{x:i,y:s},viewport:{x:this.viewport.x,y:this.viewport.y}},e.preventDefault()}onMouseUp(e){this.dragging&&(m(),this.dragging=!1,e.preventDefault())}onMouseMove(e){let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;if(this.dragging){let e=Object.assign({},this.viewport);e.x=this.dragInfo.viewport.x-(i-this.dragInfo.mouse.x)*e.width/this.width,e.y=this.dragInfo.viewport.y-(s-this.dragInfo.mouse.y)*e.height/this.height,e.x=Math.min(this.dataRange.maxX-e.width,Math.max(this.dataRange.minX,e.x)),e.y=Math.min(this.dataRange.maxY-e.height,Math.max(this.dataRange.minY,e.y)),this.setViewport(e);return}let a=this.frameAtPoint(i,s);this.setHoveredFrame(a)}onMouseOut(){this.dragging||this.setHoveredFrame(null)}onWheel(e){let t=e.deltaX,i=e.deltaY;if(e.shiftKey){/Macintosh/.test(navigator.userAgent)&&(i*=-1),this.handleZoomGesture(Math.pow(1.2,-(1/120*(i||t))),e.offsetX),e.preventDefault();return}let s=Object.assign({},this.viewport);s.x+=t*s.width/(this.dataRange.maxX-this.dataRange.minX),s.x=Math.min(this.dataRange.maxX-s.width,Math.max(this.dataRange.minX,s.x)),s.y+=i/8*s.height/(this.dataRange.maxY-this.dataRange.minY),s.y=Math.min(this.dataRange.maxY-s.height,Math.max(this.dataRange.minY,s.y)),this.setViewport(s),e.preventDefault()}handleZoomGesture(e,t){let i=Object.assign({},this.viewport),s=t/this.width,a=Math.min(i.width/e,this.dataRange.maxX-this.dataRange.minX);i.x=Math.max(this.dataRange.minX,i.x+(i.width-a)*s),i.width=Math.min(a,this.dataRange.maxX-i.x),this.setViewport(i)}setHoveredFrame(e){if(e===this.hoveredFrame)return;let t=this.hoveredFrame;this.hoveredFrame=e,this.dispatch("hoveredframechanged",{previous:t,current:this.hoveredFrame})}constructor(e,t,i,s){super(e,t,i,s),this.showLabels=!0,e.addEventListener("mousedown",e=>this.onMouseDown(e)),e.addEventListener("mousemove",e=>this.onMouseMove(e)),e.addEventListener("mouseout",()=>this.onMouseOut()),e.addEventListener("wheel",e=>this.onWheel(e),{passive:!1})}},r=class OverviewFlamechart extends n{setViewportOverlayRect(e){this.viewportOverlayRect=e,(e=this.dataToCanvas(e)).width=Math.max(2,e.width),e.height=Math.max(2,e.height),"transform"in this.viewportOverlay.style?this.viewportOverlay.style.transform=`translate(${e.x}px, ${e.y}px) scale(${e.width}, ${e.height})`:(this.viewportOverlay.style.left=`${e.x}px`,this.viewportOverlay.style.top=`${e.y}px`,this.viewportOverlay.style.width=`${e.width}px`,this.viewportOverlay.style.height=`${e.height}px`)}onMouseDown(e){d({mouseup:this.onMouseUp.bind(this),mousemove:this.onMouseMove.bind(this)}),this.dragging=!0,this.dragStartX=e.clientX-this.canvas.getBoundingClientRect().left,this.handleDragGesture(e),e.preventDefault()}onMouseUp(e){this.dragging&&(m(),this.dragging=!1,this.handleDragGesture(e),e.preventDefault())}onMouseMove(e){this.dragging&&(this.handleDragGesture(e),e.preventDefault())}handleDragGesture(e){let t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;if(this.dragCurrentX===i)return;this.dragCurrentX=i;let a=Math.min(this.dragStartX,this.dragCurrentX),n=Math.max(this.dragStartX,this.dragCurrentX),h=Object.assign({},this.viewportOverlayRect);h.x=a/this.width*this.viewport.width+this.viewport.x,h.width=Math.max(this.viewport.width/1e3,(n-a)/this.width*this.viewport.width),h.y=Math.max(this.viewport.y,Math.min(this.viewport.height-this.viewport.y,s/this.height*this.viewport.height+this.viewport.y-h.height/2)),this.setViewportOverlayRect(h),this.dispatch("overlaychanged",{current:this.viewportOverlayRect})}onOverlayMouseDown(e){d({mouseup:this.onOverlayMouseUp.bind(this),mousemove:this.onOverlayMouseMove.bind(this)}),this.overlayDragging=!0,this.overlayDragInfo={mouse:{x:e.clientX,y:e.clientY},rect:Object.assign({},this.viewportOverlayRect)},this.viewportOverlay.classList.add("moving"),this.handleOverlayDragGesture(e),e.preventDefault()}onOverlayMouseUp(e){this.overlayDragging&&(m(),this.overlayDragging=!1,this.viewportOverlay.classList.remove("moving"),this.handleOverlayDragGesture(e),e.preventDefault())}onOverlayMouseMove(e){this.overlayDragging&&(this.handleOverlayDragGesture(e),e.preventDefault())}handleOverlayDragGesture(e){let t=(e.clientX-this.overlayDragInfo.mouse.x)/this.width*this.viewport.width,i=(e.clientY-this.overlayDragInfo.mouse.y)/this.height*this.viewport.height,s=Object.assign({},this.overlayDragInfo.rect);s.x+=t,s.y+=i,s.x=Math.max(this.viewport.x,Math.min(this.viewport.x+this.viewport.width-s.width,s.x)),s.y=Math.max(this.viewport.y,Math.min(this.viewport.y+this.viewport.height-s.height,s.y)),this.setViewportOverlayRect(s),this.dispatch("overlaychanged",{current:this.viewportOverlayRect})}constructor(e,t,i,s,a){let n=e.querySelector("canvas.overview");super(n,i,s,a),this.container=e,this.showLabels=!1,this.viewportOverlay=t,n.addEventListener("mousedown",e=>this.onMouseDown(e)),this.viewportOverlay.addEventListener("mousedown",e=>this.onOverlayMouseDown(e))}},o=class FlamegraphView{updateDimensions(){let e=window.innerWidth-200-10-10,t=Math.ceil(.8*window.innerHeight)-10-10,i=Math.floor(.2*window.innerHeight)-60-10-10;this.mainChart.setDimensions(e+10+10,t+10+10),this.overview.setDimensions(e+10+10,i+10+10),this.overview.setViewportOverlayRect(this.mainChart.viewport)}computeDataRange(){let e={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};for(let t of this.data)e.minX=Math.min(e.minX,t.x),e.minY=Math.min(e.minY,t.y),e.maxX=Math.max(e.maxX,t.x+t.width),e.maxY=Math.max(e.maxY,t.y+1);return e}onHoveredFrameChanged(e){this.updateInfo(e.current),e.previous&&this.repaintFrames(1,this.info[e.previous.frame_id].frames),e.current&&this.repaintFrames(.5,this.info[e.current.frame_id].frames)}repaintFrames(e,t){this.mainChart.paint(e,t),this.overview.paint(e,t)}updateInfo(e){if(!e){this.infoElement.style.backgroundColor="",this.infoElement.querySelector(".frame").textContent="",this.infoElement.querySelector(".file").textContent="",this.infoElement.querySelector(".samples").textContent="",this.infoElement.querySelector(".exclusive").textContent="";return}let t=this.info[e.frame_id],i=e.file.replace(/^.+\/(gems|app|lib|config|jobs)/,"$1"),s=this.samplePercentRaw(t.samples.length,e.topFrame?e.topFrame.exclusiveCount:0);this.infoElement.style.backgroundColor=u(t.color,1),this.infoElement.querySelector(".frame").textContent=e.frame,this.infoElement.querySelector(".file").textContent=i,this.infoElement.querySelector(".samples").textContent=`${s[0].toString()} samples (${s[1].toString()}%)`,s[3]?this.infoElement.querySelector(".exclusive").textContent=`${s[2].toString()} exclusive (${s[3].toString()}%)`:this.infoElement.querySelector(".exclusive").textContent=""}samplePercentRaw(e,t){let i=[e,(e/this.dataRange.maxX*100).toFixed(2)];return null!=t&&(i=i.concat([t,(t/this.dataRange.maxX*100).toFixed(2)])),i}onViewportChanged(e){this.overview.setViewportOverlayRect(e.current)}onOverlayChanged(e){this.mainChart.setViewport(e.current)}renderLegend(e,t){let i=document.createDocumentFragment();for(let e of t){let t=this.samplePercentRaw(e.samples.length),s=document.createElement("div");s.className="legend-gem",s.setAttribute("data-gem-name",e.name),s.style.backgroundColor=u(e.color,1);let a=document.createElement("span");a.style.float="right",a.textContent=`${t[0].toString()}x`,a.appendChild(document.createElement("br")),a.appendChild(document.createTextNode(`${t[1].toString()}%`)),s.appendChild(a);let n=document.createElement("div");n.className="name",n.textContent=e.name,n.appendChild(document.createElement("br")),n.appendChild(document.createTextNode("\xa0")),s.appendChild(n),i.appendChild(s)}e.appendChild(i)}onLegendMouseMove(e){let t=e.target.closest(".legend-gem").getAttribute("data-gem-name");this.hoveredGemName!==t&&(this.hoveredGemName&&(this.mainChart.paint(1,null,this.hoveredGemName),this.overview.paint(1,null,this.hoveredGemName)),this.hoveredGemName=t,this.mainChart.paint(.5,null,this.hoveredGemName),this.overview.paint(.5,null,this.hoveredGemName))}onLegendMouseOut(){this.hoveredGemName&&(this.mainChart.paint(1,null,this.hoveredGemName),this.overview.paint(1,null,this.hoveredGemName),this.hoveredGemName=null)}constructor(e,t,i){this.data=e,this.info=t,this.dataRange=this.computeDataRange();let s=document.querySelector("canvas.flamegraph");this.mainChart=new h(s,e,this.dataRange,t),this.overview=new r(document.querySelector(".overview-container"),document.querySelector(".overview-viewport-overlay"),e,this.dataRange,t),this.infoElement=document.querySelector(".info"),this.mainChart.on("hoveredframechanged",this.onHoveredFrameChanged.bind(this)),this.mainChart.on("viewportchanged",this.onViewportChanged.bind(this)),this.overview.on("overlaychanged",this.onOverlayChanged.bind(this));let a=document.querySelector(".legend");this.renderLegend(a,i),a.addEventListener("mousemove",e=>this.onLegendMouseMove(e)),a.addEventListener("mouseout",()=>this.onLegendMouseOut()),window.addEventListener("resize",()=>this.updateDimensions()),this.updateDimensions()}},l=null;function d(e){for(let t in l&&m(),e)document.addEventListener(t,e[t],!0);l=e}function m(){if(l){for(let e in l)document.removeEventListener(e,l[e],!0);l=null}}function u(e,t){return null==t&&(t=1),`rgba(${e.join(",")},${t})`}function c(e){let t={};for(let i=0;i<e.length;i++)t[e[i]]=1;return Object.keys(t)}async function v(e){let t=e.getAttribute("data-url"),i=await fetch(t.replace(/&amp;/g,"&"),{headers:{"X-Requested-With":"XMLHttpRequest"}});i.ok&&function(e){let t={};for(let i of e){let e=t[i.frame_id];e||(t[i.frame_id]=e={frames:[],samples:[],color:[parseInt(205+50*Math.random()),parseInt(230*Math.random()),parseInt(55*Math.random())]}),e.frames.push(i);for(let t=0;t<i.width;t++)e.samples.push(i.x+t)}for(let e in t)t[e].samples&&(t[e].samples=c(t[e].samples));let i={},s={},a={frame:"d52e04d-df28-41ed-a215-b6ec840a8ea5",x:-1,frame_id:-1,topFrame:{}};for(let t of e){let e=function(e){let t=e.split("/gems/");return 1!==t.length?t[t.length-1].split("/")[0].split("-",2)[0]:1!==(t=e.split("/app/")).length?t[t.length-1].split("/")[0]:(t=(t=e.split("/lib/"))[Math.max(t.length-2,0)].split("/"))[t.length-1].split(":")[0]}(t.file),n=i[e];t.gemName=e,n||(i[e]=n={name:e,samples:[],frames:[]}),n.frames.push(t.frame_id);for(let e=0;e<t.width;e++)n.samples.push(t.x+e);if(a.x!==t.x){let e=s[a.frame_id];e||(s[a.frame_id]=e={exclusiveCount:0}),e.exclusiveCount+=1,a.topFrame=e}a=t}let n=s[a.frame_id];n||(s[a.frame_id]=n={exclusiveCount:0}),n.exclusiveCount+=1,a.topFrame=n;let h=0;for(let e in i)h++,i[e].samples=c(i[e].samples);let r=Object.keys(i).map(e=>i[e]);r.sort((e,t)=>t.samples.length-e.samples.length);let l=0;for(let e of r){e.color=function(e,t){let i=0,s=0,a=0,n=t/e,h=~~(6*n),r=6*n-h,o=1-r;switch(h%6){case 0:i=1,s=r,a=0;break;case 1:i=o,s=1,a=0;break;case 2:i=0,s=1,a=r;break;case 3:i=0,s=o,a=1;break;case 4:i=r,s=0,a=1;break;case 5:i=1,s=0,a=o}return[Math.floor(255*i),Math.floor(255*s),Math.floor(255*a)]}(h,l),l+=1;for(let i=0;i<e.frames.length;i++)t[e.frames[i]].color=e.color}document.querySelector(".spinner-container").remove(),new o(e,t,r)}(await i.json())}(0,i(21403).lB)(".flamegraph",e=>{v(e)})}},e=>{var t=t=>e(e.s=t);e.O(0,["vendors-node_modules_github_selector-observer_dist_index_esm_js"],()=>t(48383)),e.O()}]);
//# sourceMappingURL=flamegraph-785d01e8277a.js.map